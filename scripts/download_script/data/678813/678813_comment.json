{"bugs": {"678813": {"comments": [{"author": "Ms2ger@gmail.com", "creator": "Ms2ger@gmail.com", "time": "2011-08-14T12:40:20Z", "creation_time": "2011-08-14T12:40:20Z", "is_private": false, "id": 5652561, "count": 0, "text": "We've got a chain of nsresult-returning functions\n\nnsLayoutUtils::GetFontMetricsForFrame\nnsLayoutUtils::GetFontMetricsForStyleContext\nnsDeviceContext::GetMetricsFor\nnsFontCache::GetMetricsFor\nnsFontMetrics::Init\n\nthat only fails if gfxPlatform::CreateFontGroup returns a gfxFontGroup whose FontListLength() returns zero. However, gfxPlatform::CreateFontGroup calls the gfxFontGroup constructor, which, on Windows, OSX, and Android, calls gfxFontGroup::BuildFontList, which triggers an NS_RUNTIMEABORT in that case.\n\ngfxPangoFontGroup calls mFonts.AppendElements(1) (which is infallible); gfxFT2FontGroup goes looking for a default font, and asserts it finds one; and gfxOS2FontGroup picks \"Helv\".\n\nFurthermore, barely any callers of these functions actually check the return value.\n\nHence, I think it would be useful to have all these functions return already_AddRefed<nsFontMetrics> (like nsPresContext::GetMetricsFor does), and document that they won't return null.\n\nDbaron, is there anything here that doesn't sound right to you?", "bug_id": 678813, "tags": [], "raw_text": "We've got a chain of nsresult-returning functions\n\nnsLayoutUtils::GetFontMetricsForFrame\nnsLayoutUtils::GetFontMetricsForStyleContext\nnsDeviceContext::GetMetricsFor\nnsFontCache::GetMetricsFor\nnsFontMetrics::Init\n\nthat only fails if gfxPlatform::CreateFontGroup returns a gfxFontGroup whose FontListLength() returns zero. However, gfxPlatform::CreateFontGroup calls the gfxFontGroup constructor, which, on Windows, OSX, and Android, calls gfxFontGroup::BuildFontList, which triggers an NS_RUNTIMEABORT in that case.\n\ngfxPangoFontGroup calls mFonts.AppendElements(1) (which is infallible); gfxFT2FontGroup goes looking for a default font, and asserts it finds one; and gfxOS2FontGroup picks \"Helv\".\n\nFurthermore, barely any callers of these functions actually check the return value.\n\nHence, I think it would be useful to have all these functions return already_AddRefed<nsFontMetrics> (like nsPresContext::GetMetricsFor does), and document that they won't return null.\n\nDbaron, is there anything here that doesn't sound right to you?", "attachment_id": null}, {"raw_text": "Sounds fine to me; at least wait until after bug 678671 lands.  Though, actually, part of the reason I just did bug 678671 is that I'm about to make a bunch of other changes to GetFontMetricsFor(Frame|StyleContext).  But if this is done with an automated tool it should be either (a) quick or (b) easy to rerun on top of that.", "attachment_id": null, "tags": [], "text": "Sounds fine to me; at least wait until after bug 678671 lands.  Though, actually, part of the reason I just did bug 678671 is that I'm about to make a bunch of other changes to GetFontMetricsFor(Frame|StyleContext).  But if this is done with an automated tool it should be either (a) quick or (b) easy to rerun on top of that.", "bug_id": 678813, "is_private": false, "id": 5652791, "count": 1, "author": "dbaron@dbaron.org", "creator": "dbaron@dbaron.org", "creation_time": "2011-08-14T16:45:44Z", "time": "2011-08-14T16:45:44Z"}]}}, "comments": {}}