{"comments": {}, "bugs": {"681392": {"comments": [{"bug_id": 681392, "text": "Hi, when a mochitest opens a window with window.open, newly opened window does not have SpecialPowers object.\nSo, many tests in docshell/test/chrome prints an exception about that (but for some reason, do not appear to fail; or at least, fail silently). Here are some extracts from a random log on try server:\n\n2954 INFO TEST-INFO | chrome://mochitests/content/chrome/docshell/test/chrome/test_bug293235.xul | [SimpleTest/SimpleTest.js, window.onerror] An error occurred: SpecialPowers is not defined at chrome://mochikit/content/tests/SimpleTest/WindowSnapshot.js:12\n2966 INFO TEST-INFO | chrome://mochitests/content/chrome/docshell/test/chrome/test_bug298622.xul | [SimpleTest/SimpleTest.js, window.onerror] An error occurred: SpecialPowers is not defined at chrome://mochitests/content/chrome/docshell/test/chrome/docshell_helpers.js:403\n2969 INFO TEST-INFO | chrome://mochitests/content/chrome/docshell/test/chrome/test_bug301397.xul | [SimpleTest/SimpleTest.js, window.onerror] An error occurred: SpecialPowers is not defined at chrome://mochitests/content/chrome/docshell/test/chrome/docshell_helpers.js:403\n2993 INFO TEST-INFO | chrome://mochitests/content/chrome/docshell/test/chrome/test_bug321671.xul | [SimpleTest/SimpleTest.js, window.onerror] An error occurred: SpecialPowers is not defined at chrome://mochitests/content/chrome/docshell/test/chrome/docshell_helpers.js:403\n3574 INFO TEST-INFO | chrome://mochitests/content/chrome/docshell/test/chrome/test_bug396649.xul | [SimpleTest/SimpleTest.js, window.onerror] An error occurred: SpecialPowers is not defined at chrome://mochitests/content/chrome/docshell/test/chrome/docshell_helpers.js:403\n3614 INFO TEST-INFO | chrome://mochitests/content/chrome/docshell/test/chrome/test_bug582176.xul | [SimpleTest/SimpleTest.js, window.onerror] An error occurred: SpecialPowers is not defined at chrome://mochitests/content/chrome/docshell/test/chrome/docshell_helpers.js:403\n3667 INFO TEST-INFO | chrome://mochitests/content/chrome/docshell/test/chrome/test_bug89419.xul | [SimpleTest/SimpleTest.js, window.onerror] An error occurred: SpecialPowers is not defined at chrome://mochikit/content/tests/SimpleTest/WindowSnapshot.js:12\n10838 INFO TEST-INFO | chrome://mochitests/content/chrome/layout/generic/test/test_bug514732-2.xul | [SimpleTest/SimpleTest.js, window.onerror] An error occurred: SpecialPowers is not defined at chrome://mochikit/content/tests/SimpleTest/docshell_helpers.js:403", "tags": [], "raw_text": "Hi, when a mochitest opens a window with window.open, newly opened window does not have SpecialPowers object.\nSo, many tests in docshell/test/chrome prints an exception about that (but for some reason, do not appear to fail; or at least, fail silently). Here are some extracts from a random log on try server:\n\n2954 INFO TEST-INFO | chrome://mochitests/content/chrome/docshell/test/chrome/test_bug293235.xul | [SimpleTest/SimpleTest.js, window.onerror] An error occurred: SpecialPowers is not defined at chrome://mochikit/content/tests/SimpleTest/WindowSnapshot.js:12\n2966 INFO TEST-INFO | chrome://mochitests/content/chrome/docshell/test/chrome/test_bug298622.xul | [SimpleTest/SimpleTest.js, window.onerror] An error occurred: SpecialPowers is not defined at chrome://mochitests/content/chrome/docshell/test/chrome/docshell_helpers.js:403\n2969 INFO TEST-INFO | chrome://mochitests/content/chrome/docshell/test/chrome/test_bug301397.xul | [SimpleTest/SimpleTest.js, window.onerror] An error occurred: SpecialPowers is not defined at chrome://mochitests/content/chrome/docshell/test/chrome/docshell_helpers.js:403\n2993 INFO TEST-INFO | chrome://mochitests/content/chrome/docshell/test/chrome/test_bug321671.xul | [SimpleTest/SimpleTest.js, window.onerror] An error occurred: SpecialPowers is not defined at chrome://mochitests/content/chrome/docshell/test/chrome/docshell_helpers.js:403\n3574 INFO TEST-INFO | chrome://mochitests/content/chrome/docshell/test/chrome/test_bug396649.xul | [SimpleTest/SimpleTest.js, window.onerror] An error occurred: SpecialPowers is not defined at chrome://mochitests/content/chrome/docshell/test/chrome/docshell_helpers.js:403\n3614 INFO TEST-INFO | chrome://mochitests/content/chrome/docshell/test/chrome/test_bug582176.xul | [SimpleTest/SimpleTest.js, window.onerror] An error occurred: SpecialPowers is not defined at chrome://mochitests/content/chrome/docshell/test/chrome/docshell_helpers.js:403\n3667 INFO TEST-INFO | chrome://mochitests/content/chrome/docshell/test/chrome/test_bug89419.xul | [SimpleTest/SimpleTest.js, window.onerror] An error occurred: SpecialPowers is not defined at chrome://mochikit/content/tests/SimpleTest/WindowSnapshot.js:12\n10838 INFO TEST-INFO | chrome://mochitests/content/chrome/layout/generic/test/test_bug514732-2.xul | [SimpleTest/SimpleTest.js, window.onerror] An error occurred: SpecialPowers is not defined at chrome://mochikit/content/tests/SimpleTest/docshell_helpers.js:403", "attachment_id": null, "author": "arno@renevier.net", "creator": "arno@renevier.net", "time": "2011-08-23T17:48:31Z", "creation_time": "2011-08-23T17:48:31Z", "is_private": false, "count": 0, "id": 5672426}, {"id": 5672440, "count": 1, "is_private": false, "time": "2011-08-23T17:55:34Z", "creation_time": "2011-08-23T17:55:34Z", "creator": "ted@mielczarek.org", "author": "ted@mielczarek.org", "attachment_id": null, "raw_text": "I'm quite sure Joel hit this, but I don't know that we ever figured out why.", "tags": [], "text": "I'm quite sure Joel hit this, but I don't know that we ever figured out why.", "bug_id": 681392}, {"time": "2011-08-23T18:13:13Z", "creation_time": "2011-08-23T18:13:13Z", "creator": "josh@joshmatthews.net", "author": "josh@joshmatthews.net", "count": 2, "id": 5672500, "is_private": false, "bug_id": 681392, "text": "I'm looking in to this.", "tags": [], "attachment_id": null, "raw_text": "I'm looking in to this."}, {"time": "2011-08-23T20:14:37Z", "creation_time": "2011-08-23T20:14:37Z", "creator": "josh@joshmatthews.net", "author": "josh@joshmatthews.net", "id": 5672838, "count": 3, "is_private": false, "tags": [], "text": "Created attachment 555175\nWatch future location changes in rejected windows in case SpecialPowers should attach at a later time.", "bug_id": 681392, "attachment_id": 555175, "raw_text": ""}, {"creation_time": "2011-08-26T12:14:34Z", "time": "2011-08-26T12:14:34Z", "creator": "arno@renevier.net", "author": "arno@renevier.net", "id": 5680319, "count": 4, "is_private": false, "tags": [], "text": "I tested your patch, and it fails on my machine\nTEST_PATH=docshell/test/chrome/ make -C $OBJDIR mochitest-chrome\nopens http://mochi.test:8888/redirect.html and fails with following error:\nError: docshell is not defined\nSource File: chrome://specialpowers/content/specialpowers.js\nLine: 445\n\nBy the way, would this solution ever work ?\nIn those docshell tests, top level window is used for testing. Ie: they have no browser or iframe. So, will this._messageManager.loadFrameScript reach them ?", "bug_id": 681392, "attachment_id": null, "raw_text": "I tested your patch, and it fails on my machine\nTEST_PATH=docshell/test/chrome/ make -C $OBJDIR mochitest-chrome\nopens http://mochi.test:8888/redirect.html and fails with following error:\nError: docshell is not defined\nSource File: chrome://specialpowers/content/specialpowers.js\nLine: 445\n\nBy the way, would this solution ever work ?\nIn those docshell tests, top level window is used for testing. Ie: they have no browser or iframe. So, will this._messageManager.loadFrameScript reach them ?"}, {"is_private": false, "id": 5680422, "count": 5, "creator": "josh@joshmatthews.net", "time": "2011-08-26T13:20:44Z", "creation_time": "2011-08-26T13:20:44Z", "author": "josh@joshmatthews.net", "attachment_id": 556010, "raw_text": "You're right that this patch doesn't appear to help with your situation. I'm going to need to talk with Joel about what you're seeing, because all of the existing SpecialPowers-in-mochitest-chrome goop doesn't appear to help there. And you are absolutely right about this patch being broken - it just happened to work because the error thrown caused the early return to be skipped.", "bug_id": 681392, "text": "Created attachment 556010\nWatch future location changes in rejected windows in case SpecialPowers should attach at a later time.\n\nYou're right that this patch doesn't appear to help with your situation. I'm going to need to talk with Joel about what you're seeing, because all of the existing SpecialPowers-in-mochitest-chrome goop doesn't appear to help there. And you are absolutely right about this patch being broken - it just happened to work because the error thrown caused the early return to be skipped.", "tags": []}, {"author": "josh@joshmatthews.net", "time": "2011-08-26T13:24:59Z", "creation_time": "2011-08-26T13:24:59Z", "creator": "josh@joshmatthews.net", "count": 6, "id": 5680428, "is_private": false, "text": "Created attachment 556011\nWatch future location changes in rejected windows in case SpecialPowers should attach at a later time.\n\nJust an extra change to ensure we don't leak docshells.", "bug_id": 681392, "tags": [], "raw_text": "Just an extra change to ensure we don't leak docshells.", "attachment_id": 556011}, {"text": "While this patch is almost correct (I inversed the shouldAttach condition D:), I think we might be able to get away with just removing the shouldAttach logic entirely. I did a try run of a patch that did just that and it came back super green. http://tbpl.allizom.org/?tree=Try&usebuildbot=1&rev=84710cbbd23a", "bug_id": 681392, "tags": [], "raw_text": "While this patch is almost correct (I inversed the shouldAttach condition D:), I think we might be able to get away with just removing the shouldAttach logic entirely. I did a try run of a patch that did just that and it came back super green. http://tbpl.allizom.org/?tree=Try&usebuildbot=1&rev=84710cbbd23a", "attachment_id": null, "author": "josh@joshmatthews.net", "creator": "josh@joshmatthews.net", "time": "2011-08-26T22:44:10Z", "creation_time": "2011-08-26T22:44:10Z", "is_private": false, "id": 5681819, "count": 7}, {"attachment_id": null, "raw_text": "", "text": "*** Bug 684690 has been marked as a duplicate of this bug. ***", "bug_id": 681392, "tags": [], "is_private": false, "count": 8, "id": 5700457, "creator": "josh@joshmatthews.net", "creation_time": "2011-09-05T12:51:39Z", "time": "2011-09-05T12:51:39Z", "author": "josh@joshmatthews.net"}, {"is_private": false, "id": 5701711, "count": 9, "author": "ted@mielczarek.org", "creator": "ted@mielczarek.org", "time": "2011-09-06T11:37:52Z", "creation_time": "2011-09-06T11:37:52Z", "raw_text": "If that works let's just do that. I don't really know why that logic is there in the first place.", "attachment_id": null, "bug_id": 681392, "text": "If that works let's just do that. I don't really know why that logic is there in the first place.", "tags": []}, {"attachment_id": 558470, "raw_text": "", "tags": [], "text": "Created attachment 558470\nRemove about: exclusion from SpecialPowers creation.", "bug_id": 681392, "is_private": false, "count": 10, "id": 5701983, "creator": "josh@joshmatthews.net", "creation_time": "2011-09-06T14:32:39Z", "time": "2011-09-06T14:32:39Z", "author": "josh@joshmatthews.net"}, {"author": "ted@mielczarek.org", "creation_time": "2011-09-07T16:10:30Z", "time": "2011-09-07T16:10:30Z", "creator": "ted@mielczarek.org", "count": 11, "id": 5705057, "is_private": false, "bug_id": 681392, "text": "Comment on attachment 558470\nRemove about: exclusion from SpecialPowers creation.\n\nReview of attachment 558470:\n-----------------------------------------------------------------\n\nI don't really know why this was here in the first place. I think it got copy/pasted from something else.", "tags": [], "raw_text": "Review of attachment 558470:\n-----------------------------------------------------------------\n\nI don't really know why this was here in the first place. I think it got copy/pasted from something else.", "attachment_id": 558470}, {"attachment_id": null, "raw_text": "http://hg.mozilla.org/integration/mozilla-inbound/rev/e7525561c309", "text": "http://hg.mozilla.org/integration/mozilla-inbound/rev/e7525561c309", "bug_id": 681392, "tags": [], "is_private": false, "count": 12, "id": 5705507, "creator": "josh@joshmatthews.net", "time": "2011-09-07T18:35:49Z", "creation_time": "2011-09-07T18:35:49Z", "author": "josh@joshmatthews.net"}, {"is_private": false, "id": 5708252, "count": 13, "author": "ehsan.akhgari@gmail.com", "creator": "ehsan.akhgari@gmail.com", "creation_time": "2011-09-08T17:27:25Z", "time": "2011-09-08T17:27:25Z", "raw_text": "http://hg.mozilla.org/mozilla-central/rev/e7525561c309", "attachment_id": null, "tags": [], "text": "http://hg.mozilla.org/mozilla-central/rev/e7525561c309", "bug_id": 681392}, {"count": 14, "id": 5711443, "is_private": false, "creation_time": "2011-09-09T20:17:54Z", "time": "2011-09-09T20:17:54Z", "creator": "arno@renevier.net", "author": "arno@renevier.net", "attachment_id": null, "raw_text": "It looks the patch didn't fix the issue: window opened in docshell tests throw an exception when trying to access SpecialPowers.\n\nFor example, this log is the one associated with inbound commit for this patch. Errors reported in comment 1 are still present.\n\nhttp://tinderbox.mozilla.org/showlog.cgi?log=Mozilla-Inbound/1315423077.1315424363.14717.gz", "tags": [], "text": "It looks the patch didn't fix the issue: window opened in docshell tests throw an exception when trying to access SpecialPowers.\n\nFor example, this log is the one associated with inbound commit for this patch. Errors reported in comment 1 are still present.\n\nhttp://tinderbox.mozilla.org/showlog.cgi?log=Mozilla-Inbound/1315423077.1315424363.14717.gz", "bug_id": 681392}, {"count": 15, "id": 5729605, "is_private": false, "time": "2011-09-21T23:13:18Z", "creation_time": "2011-09-21T23:13:18Z", "creator": "josh@joshmatthews.net", "author": "josh@joshmatthews.net", "attachment_id": null, "raw_text": "When running |TEST_PATH=docshell/test/chrome/test_bug293235.xul make -C objdir mochitest-chrome|, I have discovered strange things. Printing out the location.href of the window to which SpecialPowers is being attached shows the same URL as the failing window in WindowSnapshot.js. However, logging the actual objects shows this:\n\n[object Window @ 0x1268be280 (native @ 0x1268bfae8)], when SpecialPowers is attaching to the window\n[object ChromeWindow @ 0x1268df430 (native @ 0x1268de558)], when snapshotWindow is being called.\n\nI have no idea what's going on!", "tags": [], "bug_id": 681392, "text": "When running |TEST_PATH=docshell/test/chrome/test_bug293235.xul make -C objdir mochitest-chrome|, I have discovered strange things. Printing out the location.href of the window to which SpecialPowers is being attached shows the same URL as the failing window in WindowSnapshot.js. However, logging the actual objects shows this:\n\n[object Window @ 0x1268be280 (native @ 0x1268bfae8)], when SpecialPowers is attaching to the window\n[object ChromeWindow @ 0x1268df430 (native @ 0x1268de558)], when snapshotWindow is being called.\n\nI have no idea what's going on!"}, {"attachment_id": null, "raw_text": "(In reply to Josh Matthews [:jdm] from comment #15)\n> When running |TEST_PATH=docshell/test/chrome/test_bug293235.xul make -C\n> objdir mochitest-chrome|, I have discovered strange things. Printing out the\n> location.href of the window to which SpecialPowers is being attached shows\n> the same URL as the failing window in WindowSnapshot.js. \n\nI don't get the same result.\nSpecialPowers is attached to:\nhttp://mochi.test:8888/chrome/docshell/test/chrome/bug293235.html\nand window.location is, in snapshotWindow execution:\nchrome://mochitests/content/chrome/docshell/test/chrome/bug293235_window.xul\n\nIf I understand correctly, the underlying problem is:\ncall to \nthis._messageManager.loadFrameScript(CHILD_SCRIPT);\n(in SpecialPowersObserver.js), will execute CHILD_SCRIPT in the context of any document loaded inside a <browser/>. But bug293235_window.xul is not within a browser. It's a top level window. I think that's the reason why SpecialPowers is not attached to bug293235_window.xul.", "bug_id": 681392, "text": "(In reply to Josh Matthews [:jdm] from comment #15)\n> When running |TEST_PATH=docshell/test/chrome/test_bug293235.xul make -C\n> objdir mochitest-chrome|, I have discovered strange things. Printing out the\n> location.href of the window to which SpecialPowers is being attached shows\n> the same URL as the failing window in WindowSnapshot.js. \n\nI don't get the same result.\nSpecialPowers is attached to:\nhttp://mochi.test:8888/chrome/docshell/test/chrome/bug293235.html\nand window.location is, in snapshotWindow execution:\nchrome://mochitests/content/chrome/docshell/test/chrome/bug293235_window.xul\n\nIf I understand correctly, the underlying problem is:\ncall to \nthis._messageManager.loadFrameScript(CHILD_SCRIPT);\n(in SpecialPowersObserver.js), will execute CHILD_SCRIPT in the context of any document loaded inside a <browser/>. But bug293235_window.xul is not within a browser. It's a top level window. I think that's the reason why SpecialPowers is not attached to bug293235_window.xul.", "tags": [], "is_private": false, "count": 16, "id": 5730158, "creator": "arno@renevier.net", "creation_time": "2011-09-22T06:55:08Z", "time": "2011-09-22T06:55:08Z", "author": "arno@renevier.net"}, {"creator": "martijn.martijn@gmail.com", "creation_time": "2013-09-20T15:04:05Z", "time": "2013-09-20T15:04:05Z", "author": "martijn.martijn@gmail.com", "is_private": false, "id": 7883877, "count": 17, "text": "This is only the case with mochitest-chrome, right? I don't see this problem with mochitest-plain, except on b2g, I just filed bug 918842 for that.", "bug_id": 681392, "tags": [], "attachment_id": null, "raw_text": "This is only the case with mochitest-chrome, right? I don't see this problem with mochitest-plain, except on b2g, I just filed bug 918842 for that."}, {"id": 8562890, "count": 18, "is_private": false, "author": "josh@joshmatthews.net", "time": "2014-03-21T14:14:06Z", "creation_time": "2014-03-21T14:14:06Z", "creator": "josh@joshmatthews.net", "raw_text": "Not actively looking into this.", "attachment_id": null, "text": "Not actively looking into this.", "bug_id": 681392, "tags": []}, {"is_private": false, "count": 19, "id": 9212404, "creator": "martijn.martijn@gmail.com", "creation_time": "2014-08-21T13:34:52Z", "time": "2014-08-21T13:34:52Z", "author": "martijn.martijn@gmail.com", "attachment_id": null, "raw_text": "Arno, are you still seeing this?", "bug_id": 681392, "text": "Arno, are you still seeing this?", "tags": []}]}}}