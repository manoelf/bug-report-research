{"comments": {}, "bugs": {"700514": {"comments": [{"creator": "hughnougher@gmail.com", "author": "hughnougher@gmail.com", "tags": [], "count": 0, "is_private": false, "id": 5832779, "bug_id": 700514, "creation_time": "2011-11-08T00:54:31Z", "raw_text": "When viewing an image directly in a tab, and it is small enough to create a favicon for the tab, an entire copy of the uncompressed image seems to be stored in heap-unclassified. It also happens when the image is set as the icon for an html page.\n\nI have added a url to an image which creates a favicon which i quickly found through google which can be used for testing.\n\nThe following is steps to reproduce in\nMozilla/5.0 (Windows NT 6.1; WOW64; rv:10.0a1) Gecko/20111107 Firefox/10.0a1\n\nJust about:memory open in new profile:\n25.10 MB (100.0%) -- explicit\n\u251c\u2500\u2500\u25008.61 MB (34.31%) -- heap-unclassified\n\u251c\u2500\u2500\u25000.18 MB (00.72%) -- images\n\nOpen image directly in new tab (ie: paste uri of image into address bar)\n33.21 MB (100.0%) -- explicit\n\u251c\u2500\u250011.53 MB (34.52%) -- heap-unclassified\n\u251c\u2500\u2500\u25003.78 MB (11.32%) -- images\n\nFor further visibility since a single tab is a little insignificant, Duplicate image tab (middle click on reload button) until there is 10 copies open.\n69.82 MB (100.0%) -- explicit\n\u251c\u2500\u250043.44 MB (62.21%) -- heap-unclassified\n\u251c\u2500\u2500\u25003.78 MB (05.41%) -- images\n\nFor a proof when not viewing an image in a tab but just having a favicon for the page I have attached a simple html page using the same image as its icon. With 10 tabs of this page open i get the same measurements as the 10 tabs with the image in it.", "text": "Created attachment 572677\nhtml page with large favicon\n\nWhen viewing an image directly in a tab, and it is small enough to create a favicon for the tab, an entire copy of the uncompressed image seems to be stored in heap-unclassified. It also happens when the image is set as the icon for an html page.\n\nI have added a url to an image which creates a favicon which i quickly found through google which can be used for testing.\n\nThe following is steps to reproduce in\nMozilla/5.0 (Windows NT 6.1; WOW64; rv:10.0a1) Gecko/20111107 Firefox/10.0a1\n\nJust about:memory open in new profile:\n25.10 MB (100.0%) -- explicit\n\u251c\u2500\u2500\u25008.61 MB (34.31%) -- heap-unclassified\n\u251c\u2500\u2500\u25000.18 MB (00.72%) -- images\n\nOpen image directly in new tab (ie: paste uri of image into address bar)\n33.21 MB (100.0%) -- explicit\n\u251c\u2500\u250011.53 MB (34.52%) -- heap-unclassified\n\u251c\u2500\u2500\u25003.78 MB (11.32%) -- images\n\nFor further visibility since a single tab is a little insignificant, Duplicate image tab (middle click on reload button) until there is 10 copies open.\n69.82 MB (100.0%) -- explicit\n\u251c\u2500\u250043.44 MB (62.21%) -- heap-unclassified\n\u251c\u2500\u2500\u25003.78 MB (05.41%) -- images\n\nFor a proof when not viewing an image in a tab but just having a favicon for the page I have attached a simple html page using the same image as its icon. With 10 tabs of this page open i get the same measurements as the 10 tabs with the image in it.", "attachment_id": 572677, "time": "2011-11-08T00:54:31Z"}, {"raw_text": "If I disable hardware acceleration, heap-unclassified does not rise as much (only a few MB) but gfx-surface-win32 seems to take up most of the slack causing a similar amount of memory usage.\n\nWith HW Acceleration:\n  3.11 MB -- gfx-d2d-surfacecache\n 11.72 MB -- gfx-d2d-surfacevram\n 33.19 MB -- gfx-surface-image\n  0.00 MB -- gfx-surface-win32\n(Interesting note: although some of this is in gpu, the 33MB is not and its about the same size as the extra usage in the heap-unclassified)\n\nWithout HW Acceleration:\n  0.00 MB -- gfx-d2d-surfacecache\n  0.00 MB -- gfx-d2d-surfacevram\n  0.00 MB -- gfx-surface-image\n 25.13 MB -- gfx-surface-win32", "creation_time": "2011-11-08T01:18:06Z", "attachment_id": null, "time": "2011-11-08T01:18:06Z", "author": "hughnougher@gmail.com", "creator": "hughnougher@gmail.com", "text": "If I disable hardware acceleration, heap-unclassified does not rise as much (only a few MB) but gfx-surface-win32 seems to take up most of the slack causing a similar amount of memory usage.\n\nWith HW Acceleration:\n  3.11 MB -- gfx-d2d-surfacecache\n 11.72 MB -- gfx-d2d-surfacevram\n 33.19 MB -- gfx-surface-image\n  0.00 MB -- gfx-surface-win32\n(Interesting note: although some of this is in gpu, the 33MB is not and its about the same size as the extra usage in the heap-unclassified)\n\nWithout HW Acceleration:\n  0.00 MB -- gfx-d2d-surfacecache\n  0.00 MB -- gfx-d2d-surfacevram\n  0.00 MB -- gfx-surface-image\n 25.13 MB -- gfx-surface-win32", "id": 5832835, "count": 1, "is_private": false, "tags": [], "bug_id": 700514}, {"bug_id": 700514, "id": 5832938, "tags": [], "is_private": false, "count": 2, "time": "2011-11-08T01:57:39Z", "attachment_id": null, "text": "It seems that this is exactly the same as the problem I found in bug 699150 comment 31 except in that case it was a 240MB APNG. The difference is that the rise happens shortly after the entire animation has been played once. To test, simply use attachment 572433 in place of my suggested jpeg.\n\nAs another note from observation, I think icon images are most of the explicit/images/content which is left over when all other images would have been discarded, which in my case is ~3MB. However that is the non-duplicated value so I may have upto 8MB of heap-unclassified used by these icons.", "raw_text": "It seems that this is exactly the same as the problem I found in bug 699150 comment 31 except in that case it was a 240MB APNG. The difference is that the rise happens shortly after the entire animation has been played once. To test, simply use attachment 572433 in place of my suggested jpeg.\n\nAs another note from observation, I think icon images are most of the explicit/images/content which is left over when all other images would have been discarded, which in my case is ~3MB. However that is the non-duplicated value so I may have upto 8MB of heap-unclassified used by these icons.", "creation_time": "2011-11-08T01:57:39Z", "author": "hughnougher@gmail.com", "creator": "hughnougher@gmail.com"}, {"creator": "n.nethercote@gmail.com", "author": "n.nethercote@gmail.com", "tags": [], "count": 3, "is_private": false, "id": 5832948, "bug_id": 700514, "creation_time": "2011-11-08T02:03:20Z", "raw_text": "FWIW, I don't seem to be able to replicate these results on Linux -- the heap-unclassified isn't going up in any notable way.", "text": "FWIW, I don't seem to be able to replicate these results on Linux -- the heap-unclassified isn't going up in any notable way.", "attachment_id": null, "time": "2011-11-08T02:03:20Z"}, {"creator": "dbcooper.nz@gmail.com", "author": "dbcooper.nz@gmail.com", "bug_id": 700514, "is_private": false, "count": 4, "tags": [], "id": 5833072, "text": "Opening the attachment URL 10x increased \"images\" in about:memory by ~ 4MB for me.\n\n(Win7 64bit, 32bit nightly (latest) build, D2D/D3D10 on)", "attachment_id": null, "time": "2011-11-08T03:17:39Z", "raw_text": "Opening the attachment URL 10x increased \"images\" in about:memory by ~ 4MB for me.\n\n(Win7 64bit, 32bit nightly (latest) build, D2D/D3D10 on)", "creation_time": "2011-11-08T03:17:39Z"}, {"creator": "jmuizelaar@mozilla.com", "author": "jmuizelaar@mozilla.com", "bug_id": 700514, "is_private": false, "count": 5, "tags": [], "id": 5835459, "text": "This will be easier when we switch to Azure.", "time": "2011-11-08T22:36:17Z", "attachment_id": null, "raw_text": "This will be easier when we switch to Azure.", "creation_time": "2011-11-08T22:36:17Z"}, {"bug_id": 700514, "count": 6, "is_private": false, "tags": [], "id": 5836125, "text": "It sounds like there are 2 bugs here:\n\n1) heap-unclassified memory use goes up, gfx/images should be handling the accounting\n\n2) giant favicons use more memory than their 16x16 size would suggest.\n\nCan we split one of these off to a separate bug (#1, might I suggest?).\n\nAlso, as a shorter (?) term solution than Azure, we could explicitly scale favicons down to 16x16 and use the resulting image as the favicon. Hmm, actually I thought that's what I did a long time ago back in bug 389273.\n\nAlso^2, is this an issue for ImageDocuments (loading giantimage.jpg in a tab)? Ah, that's exactly what comment 0 says. We've talked about possibly just not using a tiny scaled icon for those. I'd suspect that's _far_ more commonly encountered by users than sites with giant favicons. This would be a quick and easy fix, I think.", "time": "2011-11-09T04:02:16Z", "attachment_id": null, "creation_time": "2011-11-09T04:02:16Z", "raw_text": "It sounds like there are 2 bugs here:\n\n1) heap-unclassified memory use goes up, gfx/images should be handling the accounting\n\n2) giant favicons use more memory than their 16x16 size would suggest.\n\nCan we split one of these off to a separate bug (#1, might I suggest?).\n\nAlso, as a shorter (?) term solution than Azure, we could explicitly scale favicons down to 16x16 and use the resulting image as the favicon. Hmm, actually I thought that's what I did a long time ago back in bug 389273.\n\nAlso^2, is this an issue for ImageDocuments (loading giantimage.jpg in a tab)? Ah, that's exactly what comment 0 says. We've talked about possibly just not using a tiny scaled icon for those. I'd suspect that's _far_ more commonly encountered by users than sites with giant favicons. This would be a quick and easy fix, I think.", "creator": "jdinbox@gmail.com", "author": "jdinbox@gmail.com"}, {"creator": "mak@mozilla.com", "author": "mak@mozilla.com", "text": "(In reply to Justin Dolske [:Dolske] from comment #6)\n> Also, as a shorter (?) term solution than Azure, we could explicitly scale\n> favicons down to 16x16 and use the resulting image as the favicon. Hmm,\n> actually I thought that's what I did a long time ago back in bug 389273.\n\nActually, iirc mobile uses 32px favicons, and there is requirement to have larger favicons for new tab page and such UI features... Still I suspect scaling down to something between 64-256px may cover most needs.", "time": "2011-11-09T12:42:03Z", "attachment_id": null, "raw_text": "(In reply to Justin Dolske [:Dolske] from comment #6)\n> Also, as a shorter (?) term solution than Azure, we could explicitly scale\n> favicons down to 16x16 and use the resulting image as the favicon. Hmm,\n> actually I thought that's what I did a long time ago back in bug 389273.\n\nActually, iirc mobile uses 32px favicons, and there is requirement to have larger favicons for new tab page and such UI features... Still I suspect scaling down to something between 64-256px may cover most needs.", "creation_time": "2011-11-09T12:42:03Z", "bug_id": 700514, "count": 7, "is_private": false, "tags": [], "id": 5836709}, {"count": 8, "is_private": false, "tags": [], "id": 5861023, "bug_id": 700514, "creation_time": "2011-11-20T06:38:20Z", "raw_text": "This is particularly problematic for animated gifs, because they have small dimensions (therefore, almost always have a favicon) but otherwise unbounded decoded size.", "text": "This is particularly problematic for animated gifs, because they have small dimensions (therefore, almost always have a favicon) but otherwise unbounded decoded size.", "time": "2011-11-20T06:38:20Z", "attachment_id": null, "creator": "syskin2@gmail.com", "author": "syskin2@gmail.com"}]}}}