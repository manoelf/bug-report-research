{"comments": {}, "bugs": {"1630763": {"comments": [{"creation_time": "2020-04-16T21:11:44Z", "creator": "se@senglehardt.com", "tags": [], "count": 0, "time": "2020-04-16T21:11:44Z", "is_private": false, "raw_text": "STR: In a fresh nightly profile with network.cookie.cookieBehavior = 5, manually open 3 tabs and visit https://senglehardt.com/test/dfpi/first_and_third.html in each tab.\n\nER: englehardt-tracker.com's localStorage is the same across tabs.\n\nAR: englehardt-tracker.com's localStorage is different in each tab. It's behaving similar to sessionStorage.\n\nThis does not reproduce with the default cookie policy, nor with `privacy.firstparty.isolate=true`.", "text": "STR: In a fresh nightly profile with network.cookie.cookieBehavior = 5, manually open 3 tabs and visit https://senglehardt.com/test/dfpi/first_and_third.html in each tab.\n\nER: englehardt-tracker.com's localStorage is the same across tabs.\n\nAR: englehardt-tracker.com's localStorage is different in each tab. It's behaving similar to sessionStorage.\n\nThis does not reproduce with the default cookie policy, nor with `privacy.firstparty.isolate=true`.", "author": "se@senglehardt.com", "id": 14759984, "bug_id": 1630763, "attachment_id": null}, {"time": "2020-04-17T13:48:09Z", "tags": [], "count": 1, "creation_time": "2020-04-17T13:48:09Z", "creator": "xeonchen@gmail.com", "attachment_id": null, "bug_id": 1630763, "id": 14761463, "author": "xeonchen@gmail.com", "is_private": false, "raw_text": "It is designed to share the cache:\nhttps://searchfox.org/mozilla-central/rev/567b68b8ff4b6d607ba34a6f1926873d21a7b4d7/dom/base/nsGlobalWindowInner.cpp#4617\n\nBut\n1. the storage (`PartitionedLocalStorage`) being used here is in-memory-only\n1. the tabs here are in different process,  `SessionStorageCache` is newly created in each process.\n\nSo the caches are not shared correctly.", "text": "It is designed to share the cache:\nhttps://searchfox.org/mozilla-central/rev/567b68b8ff4b6d607ba34a6f1926873d21a7b4d7/dom/base/nsGlobalWindowInner.cpp#4617\n\nBut\n1. the storage (`PartitionedLocalStorage`) being used here is in-memory-only\n1. the tabs here are in different process,  `SessionStorageCache` is newly created in each process.\n\nSo the caches are not shared correctly."}, {"attachment_id": null, "bug_id": 1630763, "id": 14761831, "author": "xeonchen@gmail.com", "text": "(In reply to Gary Chen [:xeonchen] from comment #1)\n> 1. the tabs here are in different process,  `SessionStorageCache` is newly created in each process.\n\nEnabling Fission will fix his issue, and I can't find proper synchronization mechanism on `SessionStorageManager` without Fission.\nTo make it synchronized might not be easy, I think we need more discussion on this bug.", "raw_text": "(In reply to Gary Chen [:xeonchen] from comment #1)\n> 1. the tabs here are in different process,  `SessionStorageCache` is newly created in each process.\n\nEnabling Fission will fix his issue, and I can't find proper synchronization mechanism on `SessionStorageManager` without Fission.\nTo make it synchronized might not be easy, I think we need more discussion on this bug.", "is_private": false, "time": "2020-04-17T16:23:45Z", "count": 2, "tags": [], "creator": "xeonchen@gmail.com", "creation_time": "2020-04-17T16:23:45Z"}, {"count": 3, "tags": [], "time": "2020-04-18T00:23:57Z", "creator": "se@senglehardt.com", "creation_time": "2020-04-18T00:23:57Z", "bug_id": 1630763, "attachment_id": null, "text": "Thanks Gary! From what I can tell this is a bug introduced by Bug 1558420. The comments in https://searchfox.org/mozilla-central/rev/567b68b8ff4b6d607ba34a6f1926873d21a7b4d7/dom/base/nsGlobalWindowInner.cpp#4489-4492 seem to imply that we only intended to expose the in-memory localStorage object to origins in pref: `privacy.restrict3rdpartystorage.partitionedHosts`. This seems to align with Ehsan's comments in Bug 1558420 Comment 17.\n\nThe StoragePrincipal should just take care of things for us, and indeed we check for a mismatch [here](https://searchfox.org/mozilla-central/rev/567b68b8ff4b6d607ba34a6f1926873d21a7b4d7/dom/base/nsGlobalWindowInner.cpp#4541-4542). I'll attach a quick and dirty patch that seems to fix things: cross-tab localStorage is the same before isolation, and switches after a storage access permission is granted. I haven't thought through all of the logic for our various cookie policies nor have I run any tests, but I'd like baku to verify that this is indeed a bug.", "raw_text": "Thanks Gary! From what I can tell this is a bug introduced by Bug 1558420. The comments in https://searchfox.org/mozilla-central/rev/567b68b8ff4b6d607ba34a6f1926873d21a7b4d7/dom/base/nsGlobalWindowInner.cpp#4489-4492 seem to imply that we only intended to expose the in-memory localStorage object to origins in pref: `privacy.restrict3rdpartystorage.partitionedHosts`. This seems to align with Ehsan's comments in Bug 1558420 Comment 17.\n\nThe StoragePrincipal should just take care of things for us, and indeed we check for a mismatch [here](https://searchfox.org/mozilla-central/rev/567b68b8ff4b6d607ba34a6f1926873d21a7b4d7/dom/base/nsGlobalWindowInner.cpp#4541-4542). I'll attach a quick and dirty patch that seems to fix things: cross-tab localStorage is the same before isolation, and switches after a storage access permission is granted. I haven't thought through all of the logic for our various cookie policies nor have I run any tests, but I'd like baku to verify that this is indeed a bug.", "is_private": false, "id": 14763026, "author": "se@senglehardt.com"}, {"text": "Created attachment 9141443\nbug1630763.patch", "raw_text": "", "is_private": false, "creator": "se@senglehardt.com", "id": 14763027, "creation_time": "2020-04-18T00:24:25Z", "author": "se@senglehardt.com", "count": 4, "bug_id": 1630763, "tags": [], "attachment_id": 9141443, "time": "2020-04-18T00:24:25Z"}, {"time": "2020-04-18T11:12:39Z", "count": 5, "tags": [], "creator": "xeonchen@gmail.com", "creation_time": "2020-04-18T11:12:39Z", "attachment_id": 9141480, "bug_id": 1630763, "author": "xeonchen@gmail.com", "id": 14763324, "raw_text": "After reading Steven's comment, I made some further changes to ensure `PartitionedLocalStorage` is used only when `isolated` is true. Please take a look and see if the test case works for this bug.", "text": "Created attachment 9141480\n0001-Bug-1630763-ensure-dFPI-uses-correct-storage-type.patch\n\nAfter reading Steven's comment, I made some further changes to ensure `PartitionedLocalStorage` is used only when `isolated` is true. Please take a look and see if the test case works for this bug.", "is_private": false}, {"time": "2020-04-20T06:45:27Z", "tags": [], "count": 6, "creation_time": "2020-04-20T06:45:27Z", "creator": "amarchesini@mozilla.com", "attachment_id": null, "bug_id": 1630763, "author": "amarchesini@mozilla.com", "id": 14765308, "is_private": false, "text": "Yes, this is reasonable. I haven't checked the patch, because I see Gary is working on it.\nPartitionLocalStorage was introduced because, before StoragePrincipal and dFPI,  some websites did not work as expected with a blocked localStorage. We had to expose a \"in-memory-only\" localStorage object. But this is not needed for dFPI.", "raw_text": "Yes, this is reasonable. I haven't checked the patch, because I see Gary is working on it.\nPartitionLocalStorage was introduced because, before StoragePrincipal and dFPI,  some websites did not work as expected with a blocked localStorage. We had to expose a \"in-memory-only\" localStorage object. But this is not needed for dFPI."}, {"attachment_id": 9141480, "bug_id": 1630763, "author": "se@senglehardt.com", "id": 14767843, "text": "Comment on attachment 9141480\n0001-Bug-1630763-ensure-dFPI-uses-correct-storage-type.patch\n\nReview of attachment 9141480:\n-----------------------------------------------------------------\n\nThis change makes the logic much clearer, thanks for restructuring. I've tested the patch locally and it works as expected on the test page in Comment 0.", "raw_text": "Review of attachment 9141480:\n-----------------------------------------------------------------\n\nThis change makes the logic much clearer, thanks for restructuring. I've tested the patch locally and it works as expected on the test page in Comment 0.", "is_private": false, "time": "2020-04-20T22:12:33Z", "count": 7, "tags": [], "creator": "se@senglehardt.com", "creation_time": "2020-04-20T22:12:33Z"}, {"author": "se@senglehardt.com", "id": 14767860, "text": "I think we should also add to this comment to make it clear that this is different than the partitioning we want in dFPI or other OA-based partioning: https://searchfox.org/mozilla-central/rev/d2cec90777d573585f8477d5170892e5dcdfb0ab/dom/base/nsGlobalWindowInner.cpp#4471-4474.\n\nPerhaps:\n\n> // For Partitioned Trackers, we expose a partitioned LocalStorage, which\n> // doesn't share data with other contexts, and it's just in memory.\n> // Partitioned localStorage is available only for trackers listed in the\n> // privacy.restrict3rdpartystorage.partitionedHosts pref.  See\n> // nsContentUtils::IsURIInPrefList to know the syntax for the pref value.\n> // This is a temporary web-compatibility hack, and is unrelated to the \n> // partitioning provided by origin attributes (e.g., FPI, dFPI, or containers).\n\nGary: I've assigned you to the bug since you already have a patch ready. Thanks for updating the test as well!", "raw_text": "I think we should also add to this comment to make it clear that this is different than the partitioning we want in dFPI or other OA-based partioning: https://searchfox.org/mozilla-central/rev/d2cec90777d573585f8477d5170892e5dcdfb0ab/dom/base/nsGlobalWindowInner.cpp#4471-4474.\n\nPerhaps:\n\n> // For Partitioned Trackers, we expose a partitioned LocalStorage, which\n> // doesn't share data with other contexts, and it's just in memory.\n> // Partitioned localStorage is available only for trackers listed in the\n> // privacy.restrict3rdpartystorage.partitionedHosts pref.  See\n> // nsContentUtils::IsURIInPrefList to know the syntax for the pref value.\n> // This is a temporary web-compatibility hack, and is unrelated to the \n> // partitioning provided by origin attributes (e.g., FPI, dFPI, or containers).\n\nGary: I've assigned you to the bug since you already have a patch ready. Thanks for updating the test as well!", "is_private": false, "attachment_id": null, "bug_id": 1630763, "creator": "se@senglehardt.com", "creation_time": "2020-04-20T22:20:05Z", "time": "2020-04-20T22:20:05Z", "count": 8, "tags": []}, {"time": "2020-04-21T19:23:01Z", "count": 9, "tags": [], "creator": "xeonchen@gmail.com", "creation_time": "2020-04-21T19:23:01Z", "attachment_id": 9142151, "bug_id": 1630763, "author": "xeonchen@gmail.com", "id": 14770045, "text": "Created attachment 9142151\nBug 1630763 - ensure PartitionedLocalStorage is only used in correct mode; r=baku", "raw_text": "", "is_private": false}, {"attachment_id": null, "bug_id": 1630763, "id": 14771232, "author": "pulsebot@bots.tld", "text": "Pushed by xeonchen@gmail.com:\nhttps://hg.mozilla.org/integration/autoland/rev/b94981d467ea\nensure PartitionedLocalStorage is only used in correct mode; r=baku", "raw_text": "Pushed by xeonchen@gmail.com:\nhttps://hg.mozilla.org/integration/autoland/rev/b94981d467ea\nensure PartitionedLocalStorage is only used in correct mode; r=baku", "is_private": false, "time": "2020-04-22T09:28:44Z", "count": 10, "tags": [], "creator": "pulsebot@bots.tld", "creation_time": "2020-04-22T09:28:44Z"}, {"bug_id": 1630763, "attachment_id": null, "text": "https://hg.mozilla.org/mozilla-central/rev/b94981d467ea", "raw_text": "https://hg.mozilla.org/mozilla-central/rev/b94981d467ea", "is_private": false, "author": "ccoroiu@mozilla.com", "id": 14772112, "count": 11, "tags": ["bugherder"], "time": "2020-04-22T16:38:07Z", "creator": "ccoroiu@mozilla.com", "creation_time": "2020-04-22T16:38:07Z"}]}}}