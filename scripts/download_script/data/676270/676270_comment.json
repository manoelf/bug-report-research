{"bugs": {"676270": {"comments": [{"is_private": false, "count": 0, "id": 5630578, "author": "bugzilla@johnath.com", "creator": "bugzilla@johnath.com", "time": "2011-08-03T15:58:21Z", "creation_time": "2011-08-03T15:58:21Z", "raw_text": "In the last little while (a few weeks maybe?) I've been noticing quite a visible lag between switching to a tab and having the images on that tab painted. After some discussion with Joe and Jeff, it seems that this was a result of recent changes from jlebar which attempt to make some pathological image cases more responsive on tab swap.\n\nMy concern is that we have made a common case worse in order to ameliorate a pathological case, if my experience is reflective of the general user (I am strange as a human being, but I don't think swapping to a tab with a flickr image is strange behaviour, and the lag is visible there).\n\nMy understanding is that we have some dials to control here, that we adjusted timings well down in pursuit of greater responsiveness, but that there might be merit in pulling back from our current position. Cc'ng the parties to the discussion for comment, since we are much deeper into your depths than my own.", "attachment_id": null, "tags": [], "bug_id": 676270, "text": "In the last little while (a few weeks maybe?) I've been noticing quite a visible lag between switching to a tab and having the images on that tab painted. After some discussion with Joe and Jeff, it seems that this was a result of recent changes from jlebar which attempt to make some pathological image cases more responsive on tab swap.\n\nMy concern is that we have made a common case worse in order to ameliorate a pathological case, if my experience is reflective of the general user (I am strange as a human being, but I don't think swapping to a tab with a flickr image is strange behaviour, and the lag is visible there).\n\nMy understanding is that we have some dials to control here, that we adjusted timings well down in pursuit of greater responsiveness, but that there might be merit in pulling back from our current position. Cc'ng the parties to the discussion for comment, since we are much deeper into your depths than my own."}, {"attachment_id": null, "raw_text": "Did Joe and Jeff already rule out that this was caused by changing the discard timer from 120s down to 10s (bug 664290)?  That seems like a more straightforward cause.\n\nJoanth, you could test by changing image.mem.min_discard_timeout_ms back to 120000.", "tags": [], "bug_id": 676270, "text": "Did Joe and Jeff already rule out that this was caused by changing the discard timer from 120s down to 10s (bug 664290)?  That seems like a more straightforward cause.\n\nJoanth, you could test by changing image.mem.min_discard_timeout_ms back to 120000.", "is_private": false, "id": 5630655, "count": 1, "creator": "justin.lebar+bug@gmail.com", "creation_time": "2011-08-03T16:26:58Z", "time": "2011-08-03T16:26:58Z", "author": "justin.lebar+bug@gmail.com"}, {"author": "joe@drew.ca", "creation_time": "2011-08-03T18:54:08Z", "time": "2011-08-03T18:54:08Z", "creator": "joe@drew.ca", "count": 2, "id": 5631083, "is_private": false, "bug_id": 676270, "text": "I suspect it has more to do with bug 590260 - we're only decoding 4096 bytes at a time, and for a maximum of 5 ms.", "tags": [], "raw_text": "I suspect it has more to do with bug 590260 - we're only decoding 4096 bytes at a time, and for a maximum of 5 ms.", "attachment_id": null}, {"is_private": false, "count": 3, "id": 5631123, "author": "justin.lebar+bug@gmail.com", "creator": "justin.lebar+bug@gmail.com", "creation_time": "2011-08-03T19:03:39Z", "time": "2011-08-03T19:03:39Z", "raw_text": "I guess what you're suggesting is that the issue here is that images take longer to decode, now that we're decoding in smaller block sizes and yielding every 5ms as opposed to every 400ms?\n\nWhat I'm suggesting is that we're simply discarding images more often than we were before, and that with or without the yield time change, decoding large images takes time.  What Jonath is seeing here seems very similar to bug 664290 comment 19.\n\nIn my tests, the only circumstance where yielding every 5ms as opposed to every 400ms made a perceptible difference in the time to decode was when decoding large images out of the browser's cache.  I didn't see a difference in speed when decoding discarded images.  But my tests could have been wrong!\n\nJonath, if you make the following pref changes:\n\n  image.mem.decode_bytes_at_a_time --> 200000\n  image.mem.max_ms_before_yield --> 400\n\ndo you notice a difference in behavior?", "attachment_id": null, "bug_id": 676270, "text": "I guess what you're suggesting is that the issue here is that images take longer to decode, now that we're decoding in smaller block sizes and yielding every 5ms as opposed to every 400ms?\n\nWhat I'm suggesting is that we're simply discarding images more often than we were before, and that with or without the yield time change, decoding large images takes time.  What Jonath is seeing here seems very similar to bug 664290 comment 19.\n\nIn my tests, the only circumstance where yielding every 5ms as opposed to every 400ms made a perceptible difference in the time to decode was when decoding large images out of the browser's cache.  I didn't see a difference in speed when decoding discarded images.  But my tests could have been wrong!\n\nJonath, if you make the following pref changes:\n\n  image.mem.decode_bytes_at_a_time --> 200000\n  image.mem.max_ms_before_yield --> 400\n\ndo you notice a difference in behavior?", "tags": []}, {"bug_id": 676270, "text": "...or Joe, if you can find a site site whose images decode-after-discard faster with those prefs switched, that would confirm your theory.  I haven't been able to find such a site myself.", "tags": [], "raw_text": "...or Joe, if you can find a site site whose images decode-after-discard faster with those prefs switched, that would confirm your theory.  I haven't been able to find such a site myself.", "attachment_id": null, "author": "justin.lebar+bug@gmail.com", "creation_time": "2011-08-03T20:10:58Z", "time": "2011-08-03T20:10:58Z", "creator": "justin.lebar+bug@gmail.com", "id": 5631344, "count": 4, "is_private": false}, {"tags": [], "bug_id": 676270, "text": "Jeff, we did a bunch of experiments on my machine - do you remember what we learned?", "raw_text": "Jeff, we did a bunch of experiments on my machine - do you remember what we learned?", "attachment_id": null, "author": "bugzilla@johnath.com", "creator": "bugzilla@johnath.com", "creation_time": "2011-08-09T16:31:28Z", "time": "2011-08-09T16:31:28Z", "is_private": false, "id": 5642483, "count": 5}, {"author": "VanillaMozilla@hotmail.com", "creator": "VanillaMozilla@hotmail.com", "creation_time": "2011-11-21T19:38:57Z", "time": "2011-11-21T19:38:57Z", "is_private": false, "count": 6, "id": 5863169, "tags": [], "text": "For what it's worth, two users have reported that the yield time may be causing some serious side effects, including hanging while loading a new page.\n\nhttp://forums.mozillazine.org/viewtopic.php?p=11480225#p11480225 and the following message\nhttp://forums.mozillazine.org/viewtopic.php?p=11334203#p11334203\nhttp://forums.mozillazine.org/viewtopic.php?p=11380973#p11380973\nhttp://forums.mozillazine.org/viewtopic.php?p=11384969#p11384969\nhttp://forums.mozillazine.org/viewtopic.php?p=11438927#p11438927", "bug_id": 676270, "raw_text": "For what it's worth, two users have reported that the yield time may be causing some serious side effects, including hanging while loading a new page.\n\nhttp://forums.mozillazine.org/viewtopic.php?p=11480225#p11480225 and the following message\nhttp://forums.mozillazine.org/viewtopic.php?p=11334203#p11334203\nhttp://forums.mozillazine.org/viewtopic.php?p=11380973#p11380973\nhttp://forums.mozillazine.org/viewtopic.php?p=11384969#p11384969\nhttp://forums.mozillazine.org/viewtopic.php?p=11438927#p11438927", "attachment_id": null}, {"is_private": false, "id": 5934437, "count": 7, "creator": "davidtryse+bz@gmail.com", "creation_time": "2011-12-22T03:00:50Z", "time": "2011-12-22T03:00:50Z", "author": "davidtryse+bz@gmail.com", "attachment_id": null, "raw_text": "Hi Justin,\n\nI've found a site where the config change in comment 3 above makes a big improvement, the boston.com \"The Big Picture\" blog:\nhttp://www.boston.com/bigpicture/2011/12/the_year_in_pictures_part_ii.html\n\nThe page has 45 fairly large (990x660) jpegs, and uses about 115 MB uncompressed-heap in about:memory when active.\n\nOn this machine (4x3.4GHz, 6GB RAM) the page takes 7-8 seconds to decode images in Firefox 9.01 with default image.mem settings, if the tab has been inactive for 10+ seconds.\n\nWith these about:config settings it takes only about 1 second:\nimage.mem.decode_bytes_at_a_time --> 200000\nimage.mem.max_ms_before_yield --> 400\n\nI was going to set min_discard_timeout_ms to something fairly high to avoid the annoyance, but these settings seem nearly as good while still allowing decoded images to drop from memory.", "bug_id": 676270, "text": "Hi Justin,\n\nI've found a site where the config change in comment 3 above makes a big improvement, the boston.com \"The Big Picture\" blog:\nhttp://www.boston.com/bigpicture/2011/12/the_year_in_pictures_part_ii.html\n\nThe page has 45 fairly large (990x660) jpegs, and uses about 115 MB uncompressed-heap in about:memory when active.\n\nOn this machine (4x3.4GHz, 6GB RAM) the page takes 7-8 seconds to decode images in Firefox 9.01 with default image.mem settings, if the tab has been inactive for 10+ seconds.\n\nWith these about:config settings it takes only about 1 second:\nimage.mem.decode_bytes_at_a_time --> 200000\nimage.mem.max_ms_before_yield --> 400\n\nI was going to set min_discard_timeout_ms to something fairly high to avoid the annoyance, but these settings seem nearly as good while still allowing decoded images to drop from memory.", "tags": []}, {"creation_time": "2011-12-22T03:08:14Z", "time": "2011-12-22T03:08:14Z", "creator": "justin.lebar+bug@gmail.com", "author": "justin.lebar+bug@gmail.com", "id": 5934454, "count": 8, "is_private": false, "bug_id": 676270, "text": "That's very interesting!\n\nFWIW, the current configuration parameters are there to minimize the amount of time the browser is unresponsive while it decodes images.  With your new settings, I'd expect Firefox to be basically frozen while it decodes the images.\n\nBut I'm surprised that those settings affected the total time to decode.  I'll try to investigate tomorrow.", "tags": [], "attachment_id": null, "raw_text": "That's very interesting!\n\nFWIW, the current configuration parameters are there to minimize the amount of time the browser is unresponsive while it decodes images.  With your new settings, I'd expect Firefox to be basically frozen while it decodes the images.\n\nBut I'm surprised that those settings affected the total time to decode.  I'll try to investigate tomorrow."}, {"attachment_id": null, "raw_text": "david, what operating system and version of Firefox are you running?  On my Linux machine, changing those prefs doesn't have a big effect on how long the images take to re-decode.", "bug_id": 676270, "text": "david, what operating system and version of Firefox are you running?  On my Linux machine, changing those prefs doesn't have a big effect on how long the images take to re-decode.", "tags": [], "count": 9, "id": 5935213, "is_private": false, "time": "2011-12-22T15:38:23Z", "creation_time": "2011-12-22T15:38:23Z", "creator": "justin.lebar+bug@gmail.com", "author": "justin.lebar+bug@gmail.com"}, {"attachment_id": null, "raw_text": "Oh, so one problem is that you have to restart the browser in order for it to re-read these prefs.  That's a bug.", "text": "Oh, so one problem is that you have to restart the browser in order for it to re-read these prefs.  That's a bug.", "bug_id": 676270, "tags": [], "is_private": false, "count": 10, "id": 5935245, "creator": "justin.lebar+bug@gmail.com", "creation_time": "2011-12-22T15:51:34Z", "time": "2011-12-22T15:51:34Z", "author": "justin.lebar+bug@gmail.com"}, {"tags": [], "bug_id": 676270, "text": "Hi Justin,\n\nThanks for investigating. I'm on win7x64, Firefox 9.0.1 (release channel on this machine). Yes, decode_bytes_at_a_time and max_ms_before_yield seem to need a restart, but min_discard_timeout_ms doesn't.\nI did a quick test to see if CPU throttling might have something to do with it (in case firefox only working for 5ms at the time made the cpu jump more between the high/low speed or something), but had the same result after pinning the frequency.\n\nFirefox isn't entirely frozen with the 400/200000 setting - I can switch tabs but not scroll in this tab until the images are loaded. With default settings I can scroll, but it's very laggy. I'd rather have the tab fully frozen for 1-2 seconds than almost frozen for 7-8.\n\nSomething else that's weird, with default settings - the very first time the images are loaded (if I have just restarted the browser, and the tab is open in the background but not yet activated) then the images load much faster when I switch to the tab than if they had been loaded once then discarded! On this load I also see the progressive \"boxy\" jpeg loading (instead of fully black until the image is all done).\n\nLet me know if you'd like me to run any other test?", "attachment_id": null, "raw_text": "Hi Justin,\n\nThanks for investigating. I'm on win7x64, Firefox 9.0.1 (release channel on this machine). Yes, decode_bytes_at_a_time and max_ms_before_yield seem to need a restart, but min_discard_timeout_ms doesn't.\nI did a quick test to see if CPU throttling might have something to do with it (in case firefox only working for 5ms at the time made the cpu jump more between the high/low speed or something), but had the same result after pinning the frequency.\n\nFirefox isn't entirely frozen with the 400/200000 setting - I can switch tabs but not scroll in this tab until the images are loaded. With default settings I can scroll, but it's very laggy. I'd rather have the tab fully frozen for 1-2 seconds than almost frozen for 7-8.\n\nSomething else that's weird, with default settings - the very first time the images are loaded (if I have just restarted the browser, and the tab is open in the background but not yet activated) then the images load much faster when I switch to the tab than if they had been loaded once then discarded! On this load I also see the progressive \"boxy\" jpeg loading (instead of fully black until the image is all done).\n\nLet me know if you'd like me to run any other test?", "creation_time": "2011-12-22T21:28:38Z", "time": "2011-12-22T21:28:38Z", "creator": "davidtryse+bz@gmail.com", "author": "davidtryse+bz@gmail.com", "id": 5936353, "count": 11, "is_private": false}, {"count": 12, "id": 5962196, "is_private": false, "time": "2012-01-07T00:14:50Z", "creation_time": "2012-01-07T00:14:50Z", "creator": "justin.lebar+bug@gmail.com", "author": "justin.lebar+bug@gmail.com", "attachment_id": null, "raw_text": "Per bug 715919 comment 4, the Big Picture is a particularly bad offender because it uses progressive jpegs, which libjpeg-turbo doesn't make fast, and are anyway slow to decode.  Not that we shouldn't fix it...", "text": "Per bug 715919 comment 4, the Big Picture is a particularly bad offender because it uses progressive jpegs, which libjpeg-turbo doesn't make fast, and are anyway slow to decode.  Not that we shouldn't fix it...", "bug_id": 676270, "tags": []}, {"raw_text": "I dont know if this ever got fixed but I am seeing this issue on win7 64 bit firefox 36.0.1\n\nI have a powerful PC and it makes me feel like I am running on a 386 with how slow images appear on tab switching, and its not just big images but things like smilies on forums as well.", "attachment_id": null, "bug_id": 676270, "text": "I dont know if this ever got fixed but I am seeing this issue on win7 64 bit firefox 36.0.1\n\nI have a powerful PC and it makes me feel like I am running on a 386 with how slow images appear on tab switching, and its not just big images but things like smilies on forums as well.", "tags": [], "is_private": false, "count": 13, "id": 10041561, "author": "chrcoluk@msn.com", "creator": "chrcoluk@msn.com", "creation_time": "2015-03-17T19:06:30Z", "time": "2015-03-17T19:06:30Z"}, {"creator": "milaninbugzilla@gmail.com", "time": "2015-03-26T22:04:16Z", "creation_time": "2015-03-26T22:04:16Z", "author": "milaninbugzilla@gmail.com", "tags": [], "bug_id": 676270, "text": "Resurrecting this after 3 years, wonder if the information in here is too stale to act on - Chris, perhaps some example pages and an explicit steps to reproduce just so that we're talking about the same thing?", "is_private": false, "attachment_id": null, "id": 10084154, "count": 14, "raw_text": "Resurrecting this after 3 years, wonder if the information in here is too stale to act on - Chris, perhaps some example pages and an explicit steps to reproduce just so that we're talking about the same thing?"}]}}, "comments": {}}