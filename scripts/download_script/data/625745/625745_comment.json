{"comments": {}, "bugs": {"625745": {"comments": [{"creation_time": "2011-01-14T15:25:24Z", "tags": [], "time": "2011-01-14T15:25:24Z", "attachment_id": null, "author": "beatofthedrum@gmail.com", "creator": "beatofthedrum@gmail.com", "text": "User-Agent:       Mozilla/5.0 (X11; Linux i686; rv:2.0b8) Gecko/20100101 Firefox/4.0b8\nBuild Identifier: Firefox 4.0b8\n\nWith the above sample web page, I have tried using firefox 4 beta 8 on Windows and it works fine. I have also tried on a Ubuntu linux machine with firefox 3 and it works well, but when I try firefox 4 beta on Ubuntu it does not work - when I drag an image to display it does not display the image.\n\nReproducible: Always\n\nSteps to Reproduce:\n1.Access the URL http://html5demos.com/file-api\n2. Drag a JPG image from your desktop onto the dashed box on the web page\n3. If working you should see your image inside the dashed box\nActual Results:  \nImage does not appear inside in the dashed box.\n\nExpected Results:  \nImage should appear inside dashed box after being dragged into it.", "bug_id": 625745, "is_private": false, "id": 5199754, "count": 0, "raw_text": "User-Agent:       Mozilla/5.0 (X11; Linux i686; rv:2.0b8) Gecko/20100101 Firefox/4.0b8\nBuild Identifier: Firefox 4.0b8\n\nWith the above sample web page, I have tried using firefox 4 beta 8 on Windows and it works fine. I have also tried on a Ubuntu linux machine with firefox 3 and it works well, but when I try firefox 4 beta on Ubuntu it does not work - when I drag an image to display it does not display the image.\n\nReproducible: Always\n\nSteps to Reproduce:\n1.Access the URL http://html5demos.com/file-api\n2. Drag a JPG image from your desktop onto the dashed box on the web page\n3. If working you should see your image inside the dashed box\nActual Results:  \nImage does not appear inside in the dashed box.\n\nExpected Results:  \nImage should appear inside dashed box after being dragged into it."}, {"tags": [], "creation_time": "2011-01-14T15:27:40Z", "attachment_id": null, "creator": "bzbarsky@mit.edu", "author": "bzbarsky@mit.edu", "time": "2011-01-14T15:27:40Z", "count": 1, "raw_text": "Thanks for the bug report!\n\nCould you possibly narrow down a regression range (e.g. which beta the problem first appeared in, for a start)?  If you don't have time to do that, I understand, but if you do it would be much appreciated.", "id": 5199762, "is_private": false, "text": "Thanks for the bug report!\n\nCould you possibly narrow down a regression range (e.g. which beta the problem first appeared in, for a start)?  If you don't have time to do that, I understand, but if you do it would be much appreciated.", "bug_id": 625745}, {"attachment_id": null, "creator": "khuey@kylehuey.com", "author": "khuey@kylehuey.com", "time": "2011-01-14T15:34:18Z", "raw_text": "I can reproduce this on fedora on tip.  This needs to be a hardblocker imo.", "bug_id": 625745, "creation_time": "2011-01-14T15:34:18Z", "tags": [], "count": 2, "id": 5199779, "text": "I can reproduce this on fedora on tip.  This needs to be a hardblocker imo.", "is_private": false}, {"attachment_id": null, "creator": "bugs@pettay.fi", "author": "bugs@pettay.fi", "time": "2011-01-14T15:37:22Z", "raw_text": "That demo works here on 32 bit Fedora 13 using trunk build (Gecko/20110112)", "bug_id": 625745, "creation_time": "2011-01-14T15:37:22Z", "tags": [], "id": 5199796, "count": 3, "is_private": false, "text": "That demo works here on 32 bit Fedora 13 using trunk build (Gecko/20110112)"}, {"time": "2011-01-14T15:38:12Z", "attachment_id": null, "author": "khuey@kylehuey.com", "creator": "khuey@kylehuey.com", "bug_id": 625745, "raw_text": "Interesting.  I'm on 64 bit Fedora 13.", "creation_time": "2011-01-14T15:38:12Z", "tags": [], "is_private": false, "text": "Interesting.  I'm on 64 bit Fedora 13.", "count": 4, "id": 5199802}, {"count": 5, "id": 5199804, "raw_text": "I'm using Gnome, if that matters.", "is_private": false, "bug_id": 625745, "text": "I'm using Gnome, if that matters.", "creation_time": "2011-01-14T15:39:19Z", "tags": [], "attachment_id": null, "author": "bugs@pettay.fi", "creator": "bugs@pettay.fi", "time": "2011-01-14T15:39:19Z"}, {"count": 6, "id": 5199835, "text": "This looks very recent. rev 60000 works for me.", "is_private": false, "tags": [], "creation_time": "2011-01-14T15:49:56Z", "raw_text": "This looks very recent. rev 60000 works for me.", "bug_id": 625745, "creator": "khuey@kylehuey.com", "author": "khuey@kylehuey.com", "attachment_id": null, "time": "2011-01-14T15:49:56Z"}, {"creator": "bugs@pettay.fi", "author": "bugs@pettay.fi", "attachment_id": null, "time": "2011-01-14T16:16:26Z", "raw_text": "I wonder if the problem is in filereader or drag-and-drop.", "bug_id": 625745, "creation_time": "2011-01-14T16:16:26Z", "tags": [], "count": 7, "id": 5199904, "text": "I wonder if the problem is in filereader or drag-and-drop.", "is_private": false}, {"text": "I bisected this to http://hg.mozilla.org/mozilla-central/rev/37e106e25d9c.  I didn't believe it at first, but I tried rev 60111 and 60112 three times each and this is the cause.", "is_private": false, "count": 8, "id": 5199944, "tags": [], "creation_time": "2011-01-14T16:30:50Z", "bug_id": 625745, "raw_text": "I bisected this to http://hg.mozilla.org/mozilla-central/rev/37e106e25d9c.  I didn't believe it at first, but I tried rev 60111 and 60112 three times each and this is the cause.", "time": "2011-01-14T16:30:50Z", "creator": "khuey@kylehuey.com", "attachment_id": null, "author": "khuey@kylehuey.com"}, {"tags": [], "creation_time": "2011-01-14T16:34:18Z", "author": "khuey@kylehuey.com", "attachment_id": null, "creator": "khuey@kylehuey.com", "time": "2011-01-14T16:34:18Z", "id": 5199952, "count": 9, "raw_text": "WARNING: NS_ENSURE_TRUE(aFile) failed: file /home/khuey/dev/mozilla-central3/con\ntent/base/src/nsDOMFileReader.cpp, line 492\nJavaScript error: , line 0: uncaught exception: [Exception... \"Component returne\nd failure code: 0x80004003 (NS_ERROR_INVALID_POINTER) [nsIDOMFileReader.readAsDa\ntaURL]\"  nsresult: \"0x80004003 (NS_ERROR_INVALID_POINTER)\"  location: \"JS frame\n:: http://html5demos.com/file-api :: <TOP_LEVEL> :: line 45\"  data: no]", "is_private": false, "text": "WARNING: NS_ENSURE_TRUE(aFile) failed: file /home/khuey/dev/mozilla-central3/con\ntent/base/src/nsDOMFileReader.cpp, line 492\nJavaScript error: , line 0: uncaught exception: [Exception... \"Component returne\nd failure code: 0x80004003 (NS_ERROR_INVALID_POINTER) [nsIDOMFileReader.readAsDa\ntaURL]\"  nsresult: \"0x80004003 (NS_ERROR_INVALID_POINTER)\"  location: \"JS frame\n:: http://html5demos.com/file-api :: <TOP_LEVEL> :: line 45\"  data: no]", "bug_id": 625745}, {"creation_time": "2011-01-14T16:36:36Z", "tags": [], "attachment_id": null, "creator": "bugs@pettay.fi", "author": "bugs@pettay.fi", "time": "2011-01-14T16:36:36Z", "raw_text": "Hmm, does the bug depend on when cycle collection or garbage collection happens?", "count": 10, "id": 5199960, "is_private": false, "text": "Hmm, does the bug depend on when cycle collection or garbage collection happens?", "bug_id": 625745}, {"raw_text": "Possibly.  It seems to work intermittently even when \"broken\".  I imagine the changeset I gave in comment 8 just happened to be unlucky.", "bug_id": 625745, "creator": "khuey@kylehuey.com", "author": "khuey@kylehuey.com", "attachment_id": null, "time": "2011-01-14T19:36:35Z", "count": 11, "id": 5200620, "text": "Possibly.  It seems to work intermittently even when \"broken\".  I imagine the changeset I gave in comment 8 just happened to be unlucky.", "is_private": false, "tags": [], "creation_time": "2011-01-14T19:36:35Z"}, {"bug_id": 625745, "is_private": false, "text": "I think this is a widget issue, we don't appear to be getting anything from the drag session.", "id": 5201980, "raw_text": "I think this is a widget issue, we don't appear to be getting anything from the drag session.", "count": 12, "creation_time": "2011-01-15T03:56:55Z", "tags": [], "time": "2011-01-15T03:56:55Z", "author": "khuey@kylehuey.com", "attachment_id": null, "creator": "khuey@kylehuey.com"}, {"text": "Kyle, can you take this, since you can reproduce it?", "bug_id": 625745, "is_private": false, "count": 13, "id": 5204297, "raw_text": "Kyle, can you take this, since you can reproduce it?", "time": "2011-01-17T03:29:38Z", "creator": "roc@ocallahan.org", "author": "roc@ocallahan.org", "attachment_id": null, "creation_time": "2011-01-17T03:29:38Z", "tags": []}, {"bug_id": 625745, "raw_text": "I'll see if I can find time.", "time": "2011-01-18T16:53:45Z", "attachment_id": null, "creator": "khuey@kylehuey.com", "author": "khuey@kylehuey.com", "text": "I'll see if I can find time.", "is_private": false, "count": 14, "id": 5207521, "creation_time": "2011-01-18T16:53:45Z", "tags": []}, {"raw_text": "I can reproduce this if I do it just after Firefox is started. The difference is that when it fails, the call to GetTargetDragData from within nsDragService::GetNumDropItems processes a second dragover event which gets all the data, and the original dragover event gets none.\n\nIt works if I disable processing drag events (or at least return early from TargetSetLastContext) while GetTargetDragData is being called.\n\nI don't know if this is the same case for others.", "bug_id": 625745, "attachment_id": null, "author": "enndeakin@gmail.com", "creator": "enndeakin@gmail.com", "time": "2011-01-18T19:13:43Z", "count": 15, "id": 5207993, "is_private": false, "text": "I can reproduce this if I do it just after Firefox is started. The difference is that when it fails, the call to GetTargetDragData from within nsDragService::GetNumDropItems processes a second dragover event which gets all the data, and the original dragover event gets none.\n\nIt works if I disable processing drag events (or at least return early from TargetSetLastContext) while GetTargetDragData is being called.\n\nI don't know if this is the same case for others.", "creation_time": "2011-01-18T19:13:43Z", "tags": []}, {"creation_time": "2011-01-18T19:19:01Z", "tags": [], "text": "Interesting.  It looks like the gtk drag impl is async and we spin the event loop while we wait?\n\nI'll poke at Neil's suggestion tomorrow.", "is_private": false, "id": 5208017, "count": 16, "time": "2011-01-18T19:19:01Z", "creator": "khuey@kylehuey.com", "attachment_id": null, "author": "khuey@kylehuey.com", "bug_id": 625745, "raw_text": "Interesting.  It looks like the gtk drag impl is async and we spin the event loop while we wait?\n\nI'll poke at Neil's suggestion tomorrow."}, {"time": "2011-01-18T19:23:52Z", "attachment_id": null, "creator": "enndeakin@gmail.com", "author": "enndeakin@gmail.com", "bug_id": 625745, "raw_text": "(In reply to comment #16)\n> Interesting.  It looks like the gtk drag impl is async and we spin the event\n> loop while we wait?\n\nYes, the retrieval of the data is asynchronous as it needs to wait for the data to be available from the application that was the source of the drag.", "creation_time": "2011-01-18T19:23:52Z", "tags": [], "is_private": false, "text": "(In reply to comment #16)\n> Interesting.  It looks like the gtk drag impl is async and we spin the event\n> loop while we wait?\n\nYes, the retrieval of the data is asynchronous as it needs to wait for the data to be available from the application that was the source of the drag.", "count": 17, "id": 5208039}, {"author": "khuey@kylehuey.com", "creator": "khuey@kylehuey.com", "attachment_id": 505226, "time": "2011-01-19T23:08:07Z", "creation_time": "2011-01-19T23:08:07Z", "tags": [], "count": 18, "raw_text": "", "id": 5212023, "text": "Created attachment 505226\nNSPR Log of nsDragSession", "bug_id": 625745, "is_private": false}, {"attachment_id": 505267, "creator": "khuey@kylehuey.com", "author": "khuey@kylehuey.com", "time": "2011-01-20T00:12:35Z", "raw_text": "", "bug_id": 625745, "tags": [], "creation_time": "2011-01-20T00:12:35Z", "id": 5212253, "count": 19, "text": "Created attachment 505267\nPrevent getting into a situation where we're firing a dragOver when there's a dragOver on the stack.", "is_private": false}, {"count": 20, "id": 5212264, "is_private": false, "text": "Comment on attachment 505267\nPrevent getting into a situation where we're firing a dragOver when there's a dragOver on the stack.\n\nNeil's analysis of the problem is correct.  What happens is that we fire a dragOver and something inspects the contents of the dataTransfer which we don't have yet.  We spin up a nested event loop and continue doing stuff.  If we decide to fire another dragOver and we still haven't received the contents of the drag, we'll spin up another nested event loop.  If there's more than one dragOver on the stack, when we unwind things get screwy and break.\n\nThis patch causes us to bail early from nsWindow::OnDragMotionEvent if we're already dispatching a dragOver.", "tags": [], "creation_time": "2011-01-20T00:17:38Z", "raw_text": "Neil's analysis of the problem is correct.  What happens is that we fire a dragOver and something inspects the contents of the dataTransfer which we don't have yet.  We spin up a nested event loop and continue doing stuff.  If we decide to fire another dragOver and we still haven't received the contents of the drag, we'll spin up another nested event loop.  If there's more than one dragOver on the stack, when we unwind things get screwy and break.\n\nThis patch causes us to bail early from nsWindow::OnDragMotionEvent if we're already dispatching a dragOver.", "bug_id": 625745, "attachment_id": 505267, "author": "khuey@kylehuey.com", "creator": "khuey@kylehuey.com", "time": "2011-01-20T00:17:38Z"}, {"raw_text": "I wasn't intending that to be the actual fix. Doesn't it mean we just ignore a dragover event that we might want to receive?", "bug_id": 625745, "author": "enndeakin@gmail.com", "creator": "enndeakin@gmail.com", "attachment_id": null, "time": "2011-01-20T01:33:11Z", "count": 21, "id": 5212439, "is_private": false, "text": "I wasn't intending that to be the actual fix. Doesn't it mean we just ignore a dragover event that we might want to receive?", "creation_time": "2011-01-20T01:33:11Z", "tags": []}, {"creation_time": "2011-01-20T01:42:13Z", "tags": [], "is_private": false, "text": "(In reply to comment #21)\n> I wasn't intending that to be the actual fix. Doesn't it mean we just ignore a\n> dragover event that we might want to receive?\n\n\"Perhaps\".  Per http://www.whatwg.org/specs/web-apps/current-work/multipage/dnd.html#drag-and-drop-processing-model:\n\n\"User agents must, as soon as the drag operation is initiated and every 350ms (\u00b1200ms) thereafter for as long as the drag operation is ongoing, queue a task to perform the following steps in sequence:\n\n1.  If the user agent is still performing the previous iteration of the sequence (if any) when the next iteration becomes due, abort these steps for this iteration (effectively \"skipping missed frames\" of the drag-and-drop operation).\"\n\nThat's basically what this patch does.\n\nI suppose the alternative is to figure out why the drag impl is throwing away the data and prevent that, but firing multiple events on top of each other seems undesirable regardless.", "id": 5212466, "count": 22, "time": "2011-01-20T01:42:13Z", "author": "khuey@kylehuey.com", "attachment_id": null, "creator": "khuey@kylehuey.com", "bug_id": 625745, "raw_text": "(In reply to comment #21)\n> I wasn't intending that to be the actual fix. Doesn't it mean we just ignore a\n> dragover event that we might want to receive?\n\n\"Perhaps\".  Per http://www.whatwg.org/specs/web-apps/current-work/multipage/dnd.html#drag-and-drop-processing-model:\n\n\"User agents must, as soon as the drag operation is initiated and every 350ms (\u00b1200ms) thereafter for as long as the drag operation is ongoing, queue a task to perform the following steps in sequence:\n\n1.  If the user agent is still performing the previous iteration of the sequence (if any) when the next iteration becomes due, abort these steps for this iteration (effectively \"skipping missed frames\" of the drag-and-drop operation).\"\n\nThat's basically what this patch does.\n\nI suppose the alternative is to figure out why the drag impl is throwing away the data and prevent that, but firing multiple events on top of each other seems undesirable regardless."}, {"bug_id": 625745, "raw_text": "I suppose if we do this though we should do the same to dragenter/leave.", "time": "2011-01-20T01:45:07Z", "creator": "khuey@kylehuey.com", "attachment_id": null, "author": "khuey@kylehuey.com", "text": "I suppose if we do this though we should do the same to dragenter/leave.", "is_private": false, "id": 5212472, "count": 23, "creation_time": "2011-01-20T01:45:07Z", "tags": []}, {"is_private": false, "text": "(In reply to comment #22)\n> \"Perhaps\".  Per\n> http://www.whatwg.org/specs/web-apps/current-work/multipage/dnd.html#drag-and-drop-processing-model:\n> \n> \"User agents must, as soon as the drag operation is initiated and every 350ms\n> (\u00b1200ms) thereafter for as long as the drag operation is ongoing, queue a task\n> to perform the following steps in sequence:\n> \n> 1.  If the user agent is still performing the previous iteration of the\n> sequence (if any) when the next iteration becomes due, abort these steps for\n> this iteration (effectively \"skipping missed frames\" of the drag-and-drop\n> operation).\"\n\nI'm not really clear why any of that is relevant here. We're talking about lower level gtk drag and drop. We don't want to ignore a system dragover event do we?", "id": 5219013, "count": 24, "creation_time": "2011-01-22T04:34:35Z", "tags": [], "bug_id": 625745, "raw_text": "(In reply to comment #22)\n> \"Perhaps\".  Per\n> http://www.whatwg.org/specs/web-apps/current-work/multipage/dnd.html#drag-and-drop-processing-model:\n> \n> \"User agents must, as soon as the drag operation is initiated and every 350ms\n> (\u00b1200ms) thereafter for as long as the drag operation is ongoing, queue a task\n> to perform the following steps in sequence:\n> \n> 1.  If the user agent is still performing the previous iteration of the\n> sequence (if any) when the next iteration becomes due, abort these steps for\n> this iteration (effectively \"skipping missed frames\" of the drag-and-drop\n> operation).\"\n\nI'm not really clear why any of that is relevant here. We're talking about lower level gtk drag and drop. We don't want to ignore a system dragover event do we?", "time": "2011-01-22T04:34:35Z", "creator": "enndeakin@gmail.com", "author": "enndeakin@gmail.com", "attachment_id": null}, {"count": 25, "id": 5219965, "raw_text": "I think I've found a better solution.", "text": "Comment on attachment 505267\nPrevent getting into a situation where we're firing a dragOver when there's a dragOver on the stack.\n\nI think I've found a better solution.", "bug_id": 625745, "is_private": false, "creation_time": "2011-01-23T01:23:30Z", "tags": [], "author": "khuey@kylehuey.com", "creator": "khuey@kylehuey.com", "attachment_id": 505267, "time": "2011-01-23T01:23:30Z"}, {"tags": [], "creation_time": "2011-01-24T02:39:07Z", "time": "2011-01-24T02:39:07Z", "creator": "karlt@mozbugz.karlt.net", "author": "karlt@mozbugz.karlt.net", "attachment_id": null, "bug_id": 625745, "text": "I think attachment 501602 and attachment 501603 would resolve this.\nThey don't deal with generic nested events, which I was planning to deal with in bug 497498, but they do resolve the problem with period dragover events.", "is_private": false, "raw_text": "I think attachment 501602 and attachment 501603 would resolve this.\nThey don't deal with generic nested events, which I was planning to deal with in bug 497498, but they do resolve the problem with period dragover events.", "count": 26, "id": 5221034}, {"time": "2011-01-26T04:05:05Z", "creator": "karlt@mozbugz.karlt.net", "attachment_id": null, "author": "karlt@mozbugz.karlt.net", "creation_time": "2011-01-26T04:05:05Z", "tags": [], "text": "> holder.ondragend = function () { this.className = ''; return false; };\n\nI assume this is meant to be ondragleave.\nondragend is sent to the source and there typically is no source in this case.\n\nBased on\nhttp://www.whatwg.org/specs/web-apps/current-work/multipage/dnd.html#drag-and-drop-processing-model\nI assume dragleave is preferred over dragexit, even though ondragleave is not mentioned at https://developer.mozilla.org/en/Drag_and_Drop.", "is_private": false, "bug_id": 625745, "raw_text": "> holder.ondragend = function () { this.className = ''; return false; };\n\nI assume this is meant to be ondragleave.\nondragend is sent to the source and there typically is no source in this case.\n\nBased on\nhttp://www.whatwg.org/specs/web-apps/current-work/multipage/dnd.html#drag-and-drop-processing-model\nI assume dragleave is preferred over dragexit, even though ondragleave is not mentioned at https://developer.mozilla.org/en/Drag_and_Drop.", "count": 27, "id": 5227676}, {"text": "So is this fixed now?", "is_private": false, "id": 5231153, "count": 28, "tags": [], "creation_time": "2011-01-27T05:10:26Z", "bug_id": 625745, "raw_text": "So is this fixed now?", "time": "2011-01-27T05:10:26Z", "attachment_id": null, "creator": "roc@ocallahan.org", "author": "roc@ocallahan.org"}, {"text": "The fix in bug 495343 fixed this for me.\n\nhttp://hg.mozilla.org/mozilla-central/rev/df375746f0cd\nhttp://hg.mozilla.org/mozilla-central/rev/58d3e2cfdbd0", "is_private": false, "id": 5231175, "count": 29, "tags": [], "creation_time": "2011-01-27T05:23:30Z", "bug_id": 625745, "raw_text": "The fix in bug 495343 fixed this for me.\n\nhttp://hg.mozilla.org/mozilla-central/rev/df375746f0cd\nhttp://hg.mozilla.org/mozilla-central/rev/58d3e2cfdbd0", "time": "2011-01-27T05:23:30Z", "author": "karlt@mozbugz.karlt.net", "creator": "karlt@mozbugz.karlt.net", "attachment_id": null}, {"raw_text": "Reported by [:chaos]; confirmed by myself with Mozilla/5.0 (X11; Linux i686; rv:2.0b12pre) Gecko/20110204 Firefox/4.0b12pre  (build ID 20110204030345)\n\nThe image does not appear, this error message appears in the console:\n\nError: uncaught exception: [Exception... \"Component returned failure code: 0x80004003 (NS_ERROR_INVALID_POINTER) [nsIDOMFileReader.readAsDataURL]\"  nsresult: \"0x80004003 (NS_ERROR_INVALID_POINTER)\"  location: \"JS frame :: http://html5demos.com/file-api :: <TOP_LEVEL> :: line 45\"  data: no]", "bug_id": 625745, "attachment_id": null, "creator": "deletesoftware+moz@yandex.ru", "author": "deletesoftware+moz@yandex.ru", "time": "2011-02-04T12:58:56Z", "id": 5254911, "count": 30, "is_private": false, "text": "Reported by [:chaos]; confirmed by myself with Mozilla/5.0 (X11; Linux i686; rv:2.0b12pre) Gecko/20110204 Firefox/4.0b12pre  (build ID 20110204030345)\n\nThe image does not appear, this error message appears in the console:\n\nError: uncaught exception: [Exception... \"Component returned failure code: 0x80004003 (NS_ERROR_INVALID_POINTER) [nsIDOMFileReader.readAsDataURL]\"  nsresult: \"0x80004003 (NS_ERROR_INVALID_POINTER)\"  location: \"JS frame :: http://html5demos.com/file-api :: <TOP_LEVEL> :: line 45\"  data: no]", "creation_time": "2011-02-04T12:58:56Z", "tags": []}, {"tags": [], "creation_time": "2011-02-04T15:40:52Z", "text": "(In reply to comment #30)\n> Reported by [:chaos]; confirmed by myself with Mozilla/5.0 (X11; Linux i686;\n> rv:2.0b12pre) Gecko/20110204 Firefox/4.0b12pre  (build ID 20110204030345)\n> \n> The image does not appear, this error message appears in the console:\n> \n> Error: uncaught exception: [Exception... \"Component returned failure code:\n> 0x80004003 (NS_ERROR_INVALID_POINTER) [nsIDOMFileReader.readAsDataURL]\" \n> nsresult: \"0x80004003 (NS_ERROR_INVALID_POINTER)\"  location: \"JS frame ::\n> http://html5demos.com/file-api :: <TOP_LEVEL> :: line 45\"  data: no]\n\nI'm sorry, are you claiming this is still broken?", "is_private": false, "count": 31, "id": 5255174, "time": "2011-02-04T15:40:52Z", "attachment_id": null, "author": "khuey@kylehuey.com", "creator": "khuey@kylehuey.com", "bug_id": 625745, "raw_text": "(In reply to comment #30)\n> Reported by [:chaos]; confirmed by myself with Mozilla/5.0 (X11; Linux i686;\n> rv:2.0b12pre) Gecko/20110204 Firefox/4.0b12pre  (build ID 20110204030345)\n> \n> The image does not appear, this error message appears in the console:\n> \n> Error: uncaught exception: [Exception... \"Component returned failure code:\n> 0x80004003 (NS_ERROR_INVALID_POINTER) [nsIDOMFileReader.readAsDataURL]\" \n> nsresult: \"0x80004003 (NS_ERROR_INVALID_POINTER)\"  location: \"JS frame ::\n> http://html5demos.com/file-api :: <TOP_LEVEL> :: line 45\"  data: no]\n\nI'm sorry, are you claiming this is still broken?"}, {"count": 32, "id": 5255215, "raw_text": "I can still reproduce this on tip.  (Anecdotally) it seems to happen less often but it still happens pretty frequently.", "is_private": false, "bug_id": 625745, "text": "I can still reproduce this on tip.  (Anecdotally) it seems to happen less often but it still happens pretty frequently.", "attachment_id": null, "creator": "khuey@kylehuey.com", "author": "khuey@kylehuey.com", "time": "2011-02-04T16:00:58Z", "creation_time": "2011-02-04T16:00:58Z", "tags": []}, {"creation_time": "2011-02-05T02:45:48Z", "tags": [], "is_private": false, "text": "I haven't reproduced here, but GTK drag sources can (incorrectly) send a drop message before they have received a status reply from the position message.\n\nIf that happens we could end up with two selection requests in flight at the same time (one during dragover, and another during a nested drop event), which nsDragService manages badly.\n\nAs part of bug 497498, I'm working on queuing drag events that occur during processing of other drag events, which should prevent such a situation arising in this testcase.", "count": 33, "id": 5257182, "time": "2011-02-05T02:45:48Z", "author": "karlt@mozbugz.karlt.net", "creator": "karlt@mozbugz.karlt.net", "attachment_id": null, "bug_id": 625745, "raw_text": "I haven't reproduced here, but GTK drag sources can (incorrectly) send a drop message before they have received a status reply from the position message.\n\nIf that happens we could end up with two selection requests in flight at the same time (one during dragover, and another during a nested drop event), which nsDragService manages badly.\n\nAs part of bug 497498, I'm working on queuing drag events that occur during processing of other drag events, which should prevent such a situation arising in this testcase."}, {"creation_time": "2011-02-14T07:16:53Z", "tags": [], "author": "karlt@mozbugz.karlt.net", "attachment_id": null, "creator": "karlt@mozbugz.karlt.net", "time": "2011-02-14T07:16:53Z", "count": 34, "raw_text": "Aleksej and/or Kyle, could you try one of the these builds please to see whether it resolves the issues you are seeing?\nhttp://stage.mozilla.org/pub/mozilla.org/firefox/tryserver-builds/ktomlinson@mozilla.com-3c09a259a595/tryserver-linux64/firefox-4.0b11pre.en-US.linux-x86_64.tar.bz2\nhttp://stage.mozilla.org/pub/mozilla.org/firefox/tryserver-builds/ktomlinson@mozilla.com-3c09a259a595/tryserver-linux/firefox-4.0b11pre.en-US.linux-i686.tar.bz2\n\nIf still not working properly, can you attach output from a run with NSPR_LOG_MODULES=WidgetDrag:5,nsDragService:5 in the environment, please?", "id": 5276443, "is_private": false, "text": "Aleksej and/or Kyle, could you try one of the these builds please to see whether it resolves the issues you are seeing?\nhttp://stage.mozilla.org/pub/mozilla.org/firefox/tryserver-builds/ktomlinson@mozilla.com-3c09a259a595/tryserver-linux64/firefox-4.0b11pre.en-US.linux-x86_64.tar.bz2\nhttp://stage.mozilla.org/pub/mozilla.org/firefox/tryserver-builds/ktomlinson@mozilla.com-3c09a259a595/tryserver-linux/firefox-4.0b11pre.en-US.linux-i686.tar.bz2\n\nIf still not working properly, can you attach output from a run with NSPR_LOG_MODULES=WidgetDrag:5,nsDragService:5 in the environment, please?", "bug_id": 625745}, {"raw_text": "(In reply to comment #34)\n> http://stage.mozilla.org/pub/mozilla.org/firefox/tryserver-builds/ktomlinson@mozilla.com-3c09a259a595/tryserver-linux/firefox-4.0b11pre.en-US.linux-i686.tar.bz2\n> If still not working properly, can you attach output from a run with\n> NSPR_LOG_MODULES=WidgetDrag:5,nsDragService:5 in the environment, please?\n\nIt is not working, and there is no new output.", "bug_id": 625745, "creator": "deletesoftware+moz@yandex.ru", "author": "deletesoftware+moz@yandex.ru", "attachment_id": null, "time": "2011-02-14T09:48:27Z", "id": 5276566, "count": 35, "is_private": false, "text": "(In reply to comment #34)\n> http://stage.mozilla.org/pub/mozilla.org/firefox/tryserver-builds/ktomlinson@mozilla.com-3c09a259a595/tryserver-linux/firefox-4.0b11pre.en-US.linux-i686.tar.bz2\n> If still not working properly, can you attach output from a run with\n> NSPR_LOG_MODULES=WidgetDrag:5,nsDragService:5 in the environment, please?\n\nIt is not working, and there is no new output.", "creation_time": "2011-02-14T09:48:27Z", "tags": []}, {"text": "Thanks Aleksej.  Do you still see (NS_ERROR_INVALID_POINTER) [nsIDOMFileReader.readAsDataURL]?\nIs the failure intermittent for you or does it always fail?\n\nSorry about the lack of logging in that build.  (FORCE_PR_LOG was in the wrong place.)\nThis build has the additional logging:\nhttp://stage.mozilla.org/pub/mozilla.org/\nfirefox/tryserver-builds/ktomlinson@mozilla.com-8a1e416fa877/tryserver-linux/\nfirefox-4.0b12pre.en-US.linux-i686.tar.bz2", "is_private": false, "id": 5278026, "count": 36, "creation_time": "2011-02-14T21:33:20Z", "tags": [], "bug_id": 625745, "raw_text": "Thanks Aleksej.  Do you still see (NS_ERROR_INVALID_POINTER) [nsIDOMFileReader.readAsDataURL]?\nIs the failure intermittent for you or does it always fail?\n\nSorry about the lack of logging in that build.  (FORCE_PR_LOG was in the wrong place.)\nThis build has the additional logging:\nhttp://stage.mozilla.org/pub/mozilla.org/\nfirefox/tryserver-builds/ktomlinson@mozilla.com-8a1e416fa877/tryserver-linux/\nfirefox-4.0b12pre.en-US.linux-i686.tar.bz2", "time": "2011-02-14T21:33:20Z", "creator": "karlt@mozbugz.karlt.net", "attachment_id": null, "author": "karlt@mozbugz.karlt.net"}, {"tags": [], "creation_time": "2011-02-15T10:48:36Z", "text": "Created attachment 512434\nlog with http://stage.mozilla.org/pub/mozilla.org/ firefox/tryserver-builds/ktomlinson@mozilla.com-8a1e416fa877/tryserver-linux/ firefox-4.0b12pre.en-US.linux-i686.tar.bz2\n\n(In reply to comment #36)\n> Thanks Aleksej.  Do you still see (NS_ERROR_INVALID_POINTER)\n> [nsIDOMFileReader.readAsDataURL]?\n\nYes, same.\n\n> Is the failure intermittent for you or does it always fail?\n\nAlways.", "is_private": false, "id": 5279390, "count": 37, "time": "2011-02-15T10:48:36Z", "author": "deletesoftware+moz@yandex.ru", "attachment_id": 512434, "creator": "deletesoftware+moz@yandex.ru", "bug_id": 625745, "raw_text": "(In reply to comment #36)\n> Thanks Aleksej.  Do you still see (NS_ERROR_INVALID_POINTER)\n> [nsIDOMFileReader.readAsDataURL]?\n\nYes, same.\n\n> Is the failure intermittent for you or does it always fail?\n\nAlways."}, {"time": "2011-02-16T02:45:17Z", "creator": "karlt@mozbugz.karlt.net", "attachment_id": null, "author": "karlt@mozbugz.karlt.net", "bug_id": 625745, "raw_text": "(In reply to comment #37)\n> Created attachment 512434 [details]\n> log with ...\n\nThanks again.\n\nIt seems your desktop is providing a mime type of text/uri-list, which seems reasonable, but our code does not think that matches application/x-moz-file.\n\nWhat window manager (or desktop program) do you have?\n\nI seem to be getting lucky with my desktop providing the data in text/plain format:\n\n> nsDragService::IsDataFlavorSupported application/x-moz-file\n> checking text/uri-list against application/x-moz-file\n> checking text/x-moz-url against application/x-moz-file\n> checking text/plain against application/x-moz-file\n> good! ( it's text plain and we're checking                    against text/unicode or application/x-moz-file)", "creation_time": "2011-02-16T02:45:17Z", "tags": [], "is_private": false, "text": "(In reply to comment #37)\n> Created attachment 512434 [details]\n> log with ...\n\nThanks again.\n\nIt seems your desktop is providing a mime type of text/uri-list, which seems reasonable, but our code does not think that matches application/x-moz-file.\n\nWhat window manager (or desktop program) do you have?\n\nI seem to be getting lucky with my desktop providing the data in text/plain format:\n\n> nsDragService::IsDataFlavorSupported application/x-moz-file\n> checking text/uri-list against application/x-moz-file\n> checking text/x-moz-url against application/x-moz-file\n> checking text/plain against application/x-moz-file\n> good! ( it's text plain and we're checking                    against text/unicode or application/x-moz-file)", "count": 38, "id": 5282030}, {"attachment_id": null, "creator": "karlt@mozbugz.karlt.net", "author": "karlt@mozbugz.karlt.net", "time": "2011-02-16T03:03:53Z", "creation_time": "2011-02-16T03:03:53Z", "tags": [], "count": 39, "raw_text": "The code that assumes the text/plain data is a uri-list seems incorrect and that comes from bug 229327.  Bug 229327 comment 17 seems to suggest that, at one stage, before that bug, text/uri-list was sufficient to allow file drags.\n\nKyle's intermittent issue must be something different to this text/plain mime type issue.", "id": 5282082, "is_private": false, "bug_id": 625745, "text": "The code that assumes the text/plain data is a uri-list seems incorrect and that comes from bug 229327.  Bug 229327 comment 17 seems to suggest that, at one stage, before that bug, text/uri-list was sufficient to allow file drags.\n\nKyle's intermittent issue must be something different to this text/plain mime type issue."}, {"is_private": false, "text": "Providing only one text/uri-list mime type is appropriate for X11 file drags.\n http://www.newplanetsoftware.com/xdnd/dragging_files.html\n \"in general, the source should not provide any types other than text/uri-list\n  and text/x-xdnd-username. This is because anything on the file system can be\n  dragged: plain text, HTML, images, binary executables, or even\n  directories. The only type that encompasses all these is text/uri-list. All\n  of these can even be dragged at the same time. It is the target's\n  responsibility to sort out what was dropped and do something reasonable.\"\n\nHowever, I think we need to be careful about converting uri-list to file\nbecause uri-list is currently also what is used at the system level for dragging URLs from anchors, and the user may think they are only dragging a link.  For example a user may drag a URL in a web page while being unaware that the URL points to a local file.\nDropping that link on a web page should not (necessarily) provide the page with the local file.\n\nThe basic question is: how can we distinguish file drags from URL drags?\n\nA similar issue was discussed in bug 564738, but for external drags like this\nwe can't check the principal of the document in the other application.\n\nTreating uri-list as file for all external drags is not right if another app (e.g. mail user agent) presents URL drags as uri-lists.\n\nI wondered about using the list of allowed actions.\n\nThe xdnd spec suggests a special default drag action:\n \"When dragging files from other programs (e.g. a list of files to search or\n  compile), XdndActionPrivate should be the default because it isn't clear\n  what the user intends to do.\"\nHowever, even if file managers are correctly doing that, GDK removes the\ndistinction by converting XdndActionPrivate to GDK_ACTION_COPY.\n\nIt seems that when dragging a URL the link action should be allowed but the\ncopy action should not.  Currently we allow copy for link drags, perhaps\nbecause we also provide the link in text/plain, text/html (I wonder why?),\netc.  I guess we want to continue to provide text/plain and the text/plain\ndata needs to be copied, not linked.  Unfortunately, we can't provide different\nallowed actions for each mime type. \n\nGiven uri-list is the means of indicating file drags on X11, maybe we should\nnot add uri-list to the list of mime types for drags that we initiate when\nkURLMime is specified but kFileMime is not and the list includes \"file:\" uris.", "count": 40, "id": 5282302, "creation_time": "2011-02-16T05:53:44Z", "tags": [], "bug_id": 625745, "raw_text": "Providing only one text/uri-list mime type is appropriate for X11 file drags.\n http://www.newplanetsoftware.com/xdnd/dragging_files.html\n \"in general, the source should not provide any types other than text/uri-list\n  and text/x-xdnd-username. This is because anything on the file system can be\n  dragged: plain text, HTML, images, binary executables, or even\n  directories. The only type that encompasses all these is text/uri-list. All\n  of these can even be dragged at the same time. It is the target's\n  responsibility to sort out what was dropped and do something reasonable.\"\n\nHowever, I think we need to be careful about converting uri-list to file\nbecause uri-list is currently also what is used at the system level for dragging URLs from anchors, and the user may think they are only dragging a link.  For example a user may drag a URL in a web page while being unaware that the URL points to a local file.\nDropping that link on a web page should not (necessarily) provide the page with the local file.\n\nThe basic question is: how can we distinguish file drags from URL drags?\n\nA similar issue was discussed in bug 564738, but for external drags like this\nwe can't check the principal of the document in the other application.\n\nTreating uri-list as file for all external drags is not right if another app (e.g. mail user agent) presents URL drags as uri-lists.\n\nI wondered about using the list of allowed actions.\n\nThe xdnd spec suggests a special default drag action:\n \"When dragging files from other programs (e.g. a list of files to search or\n  compile), XdndActionPrivate should be the default because it isn't clear\n  what the user intends to do.\"\nHowever, even if file managers are correctly doing that, GDK removes the\ndistinction by converting XdndActionPrivate to GDK_ACTION_COPY.\n\nIt seems that when dragging a URL the link action should be allowed but the\ncopy action should not.  Currently we allow copy for link drags, perhaps\nbecause we also provide the link in text/plain, text/html (I wonder why?),\netc.  I guess we want to continue to provide text/plain and the text/plain\ndata needs to be copied, not linked.  Unfortunately, we can't provide different\nallowed actions for each mime type. \n\nGiven uri-list is the means of indicating file drags on X11, maybe we should\nnot add uri-list to the list of mime types for drags that we initiate when\nkURLMime is specified but kFileMime is not and the list includes \"file:\" uris.", "time": "2011-02-16T05:53:44Z", "attachment_id": null, "creator": "karlt@mozbugz.karlt.net", "author": "karlt@mozbugz.karlt.net"}, {"creation_time": "2011-10-19T12:15:31Z", "tags": [], "id": 5791568, "count": 41, "is_private": false, "text": "*** Bug 695284 has been marked as a duplicate of this bug. ***", "creator": "khuey@kylehuey.com", "attachment_id": null, "author": "khuey@kylehuey.com", "time": "2011-10-19T12:15:31Z", "raw_text": "", "bug_id": 625745}]}}}