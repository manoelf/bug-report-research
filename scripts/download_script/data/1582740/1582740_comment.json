{"bugs": {"1582740": {"comments": [{"author": "daniel.kolsis@softvision.ro", "time": "2019-09-20T13:47:37Z", "text": "Created attachment 9094189\nDefaultBrowser.gif\n\n#### Affected versions\n\n* Firefox 68.1.0esr\n* Firefox 69.0.8\n* Firefox 70.b8\n* Firefox 71.0a1 \n#### Affected platforms\n* Windows 10 64bit.\n* Windows 7 64bit.\n* macOS 10.13.\n* Ubuntu 16.04 64bit.\n#### Steps to reproduce\n\n1. Launch Firefox.\n2. Access the about:preferences page.\n3. Click the \"Make Default\" button. (in order to lock the \"Always check if Firefox is your  default browser checkbox).\n4. Refresh the about:preferences page.\n5. Quickly uncheck the \"Always check if Firefox is your default browser\" checkbox.\n#### Expected result\n\n* Unchecking the \"Always check if Firefox is your default browser\" checkbox is not possible as long as it is locked.\n* The browser.shell.checkDefaultBrowser pref remains set to true and refreshing the about:preferences page doesn't save the actions performed in step 5.\n#### Actual result\n\n* The user is able to check the \"Always check if Firefox is your default browser\" checkbox if the about:preferences page is refreshed even though it is displayed as locked.\n* The browser.shell.CheckDefaultBrowser pref changes to false and the actions performed in step 5 are saved.\n#### Regression range\n\nLast good revision: e4b9b1084292686d3eb50ba0cadd85950824c955 (2019-01-25)\nFirst bad revision: bb2895bfd1bc3d83c309e904dbe74e0c60c3fac9 (2019-01-26)\nPushlog:\nhttps://hg.mozilla.org/mozilla-central/pushloghtml?fromchange=e4b9b1084292686d3eb50ba0cadd85950824c955&tochange=bb2895bfd1bc3d83c309e904dbe74e0c60c3fac9\n\n#### Additional notes\n\n* For further information regarding this issue, please observe the attached screencast.\n* Note: Bug 1532701 was not fixed, so we created another one.", "creation_time": "2019-09-20T13:47:37Z", "is_private": false, "bug_id": 1582740, "count": 0, "raw_text": "#### Affected versions\n\n* Firefox 68.1.0esr\n* Firefox 69.0.8\n* Firefox 70.b8\n* Firefox 71.0a1 \n#### Affected platforms\n* Windows 10 64bit.\n* Windows 7 64bit.\n* macOS 10.13.\n* Ubuntu 16.04 64bit.\n#### Steps to reproduce\n\n1. Launch Firefox.\n2. Access the about:preferences page.\n3. Click the \"Make Default\" button. (in order to lock the \"Always check if Firefox is your  default browser checkbox).\n4. Refresh the about:preferences page.\n5. Quickly uncheck the \"Always check if Firefox is your default browser\" checkbox.\n#### Expected result\n\n* Unchecking the \"Always check if Firefox is your default browser\" checkbox is not possible as long as it is locked.\n* The browser.shell.checkDefaultBrowser pref remains set to true and refreshing the about:preferences page doesn't save the actions performed in step 5.\n#### Actual result\n\n* The user is able to check the \"Always check if Firefox is your default browser\" checkbox if the about:preferences page is refreshed even though it is displayed as locked.\n* The browser.shell.CheckDefaultBrowser pref changes to false and the actions performed in step 5 are saved.\n#### Regression range\n\nLast good revision: e4b9b1084292686d3eb50ba0cadd85950824c955 (2019-01-25)\nFirst bad revision: bb2895bfd1bc3d83c309e904dbe74e0c60c3fac9 (2019-01-26)\nPushlog:\nhttps://hg.mozilla.org/mozilla-central/pushloghtml?fromchange=e4b9b1084292686d3eb50ba0cadd85950824c955&tochange=bb2895bfd1bc3d83c309e904dbe74e0c60c3fac9\n\n#### Additional notes\n\n* For further information regarding this issue, please observe the attached screencast.\n* Note: Bug 1532701 was not fixed, so we created another one.", "creator": "daniel.kolsis@softvision.ro", "tags": [], "attachment_id": 9094189, "id": 14373765}, {"creation_time": "2019-09-23T14:32:27Z", "text": "Changing the confusing summary - this has nothing to do with preference locking in the `lockPref` enterprise sense.\n\nOut of the bugs in the regression window, bug 1522694 looks the most plausible, but even then I don't understand how that bug would have changed something here. Dave, can you have a look?", "author": "gijskruitbosch+bugs@gmail.com", "time": "2019-09-23T14:32:27Z", "id": 14378541, "attachment_id": null, "tags": [], "creator": "gijskruitbosch+bugs@gmail.com", "raw_text": "Changing the confusing summary - this has nothing to do with preference locking in the `lockPref` enterprise sense.\n\nOut of the bugs in the regression window, bug 1522694 looks the most plausible, but even then I don't understand how that bug would have changed something here. Dave, can you have a look?", "count": 1, "bug_id": 1582740, "is_private": false}, {"attachment_id": null, "id": 14378879, "tags": [], "raw_text": "It's not in the regression range (though it's pretty close), but my money is on bug 1520350.\n\nWhen loading a preferences pane we create the content from a template and then call the preferences API to update the UI from prefs: https://searchfox.org/mozilla-central/rev/153feabebc2d13bb4c29ef8adf104ec1ebd246ae/browser/components/preferences/in-content/preferences.js#68\nThe preferences API does this asynchronously: https://searchfox.org/mozilla-central/rev/153feabebc2d13bb4c29ef8adf104ec1ebd246ae/toolkit/content/preferencesBindings.js#140\nAnd so we end up calling a pane's `init` function before the UI elements have the correct state: https://searchfox.org/mozilla-central/rev/153feabebc2d13bb4c29ef8adf104ec1ebd246ae/browser/components/preferences/in-content/preferences.js#70\nSo when we first decide whether to disable the checkbox or not its checked state is not correct: https://searchfox.org/mozilla-central/rev/153feabebc2d13bb4c29ef8adf104ec1ebd246ae/browser/components/preferences/in-content/main.js#1193-1194\n\nWe then start polling for the default browser check. The first poll happens one second after `init` at which point the chekbox is correctly checked and so we disable the checkbox: https://searchfox.org/mozilla-central/rev/153feabebc2d13bb4c29ef8adf104ec1ebd246ae/browser/components/preferences/in-content/main.js#316-334\n\nI'm not really sure what is going on with the locked state, haven't looked into that too much.\n\nWe really shouldn't be calling a category's init function until after the preferences have been applied. Preferences.updateAllElements should return the promise it creates and we should await on it before calling init().", "creator": "dtownsend@mozilla.com", "is_private": false, "bug_id": 1582740, "count": 2, "creation_time": "2019-09-23T16:53:51Z", "text": "It's not in the regression range (though it's pretty close), but my money is on bug 1520350.\n\nWhen loading a preferences pane we create the content from a template and then call the preferences API to update the UI from prefs: https://searchfox.org/mozilla-central/rev/153feabebc2d13bb4c29ef8adf104ec1ebd246ae/browser/components/preferences/in-content/preferences.js#68\nThe preferences API does this asynchronously: https://searchfox.org/mozilla-central/rev/153feabebc2d13bb4c29ef8adf104ec1ebd246ae/toolkit/content/preferencesBindings.js#140\nAnd so we end up calling a pane's `init` function before the UI elements have the correct state: https://searchfox.org/mozilla-central/rev/153feabebc2d13bb4c29ef8adf104ec1ebd246ae/browser/components/preferences/in-content/preferences.js#70\nSo when we first decide whether to disable the checkbox or not its checked state is not correct: https://searchfox.org/mozilla-central/rev/153feabebc2d13bb4c29ef8adf104ec1ebd246ae/browser/components/preferences/in-content/main.js#1193-1194\n\nWe then start polling for the default browser check. The first poll happens one second after `init` at which point the chekbox is correctly checked and so we disable the checkbox: https://searchfox.org/mozilla-central/rev/153feabebc2d13bb4c29ef8adf104ec1ebd246ae/browser/components/preferences/in-content/main.js#316-334\n\nI'm not really sure what is going on with the locked state, haven't looked into that too much.\n\nWe really shouldn't be calling a category's init function until after the preferences have been applied. Preferences.updateAllElements should return the promise it creates and we should await on it before calling init().", "author": "dtownsend@mozilla.com", "time": "2019-09-23T16:53:51Z"}, {"tags": [], "id": 14383045, "attachment_id": null, "count": 3, "bug_id": 1582740, "is_private": false, "creator": "gijskruitbosch+bugs@gmail.com", "raw_text": "(In reply to Dave Townsend [:mossop] (he/him) from comment #2)\n> We really shouldn't be calling a category's init function until after the preferences have been applied. Preferences.updateAllElements should return the promise it creates and we should await on it before calling init().\n\nYeah, not doing this seems bad. :-(\n\nJared, are you still busy with skyline things or would you have time to look into this?", "creation_time": "2019-09-25T13:16:30Z", "time": "2019-09-25T13:16:30Z", "author": "gijskruitbosch+bugs@gmail.com", "text": "(In reply to Dave Townsend [:mossop] (he/him) from comment #2)\n> We really shouldn't be calling a category's init function until after the preferences have been applied. Preferences.updateAllElements should return the promise it creates and we should await on it before calling init().\n\nYeah, not doing this seems bad. :-(\n\nJared, are you still busy with skyline things or would you have time to look into this?"}, {"author": "jaws@mozilla.com", "time": "2019-09-30T17:25:07Z", "text": "Created attachment 9097425\nBug 1582740 - Wait for the preference state to get updated before initializing preference elements. r?Gijs", "creation_time": "2019-09-30T17:25:07Z", "bug_id": 1582740, "count": 4, "is_private": false, "creator": "jaws@mozilla.com", "raw_text": "", "tags": [], "id": 14395123, "attachment_id": 9097425}, {"time": "2019-10-23T21:05:03Z", "author": "jaws@mozilla.com", "text": "Gijs, are you able to take this over or find someone who can?", "creation_time": "2019-10-23T21:05:03Z", "is_private": false, "count": 5, "bug_id": 1582740, "raw_text": "Gijs, are you able to take this over or find someone who can?", "creator": "jaws@mozilla.com", "tags": [], "attachment_id": null, "id": 14442659}, {"text": "Gijs, do you have an update on this one? Thanks", "author": "pascalc@gmail.com", "time": "2019-11-06T16:50:55Z", "creation_time": "2019-11-06T16:50:55Z", "raw_text": "Gijs, do you have an update on this one? Thanks", "creator": "pascalc@gmail.com", "is_private": false, "count": 6, "bug_id": 1582740, "attachment_id": null, "id": 14471775, "tags": []}, {"creation_time": "2019-11-06T17:25:15Z", "text": "Sorry, I don't yet - I took this over from Jared when he went on leave. I think the current state is sloppy but not critical to fix, so it's taken a backseat to my other priorities.\n\nPer discussion on the bug and on phabricator for the revision Jared had up, I think fixing this is prone to causing other regressions because some of the code surrounding how we initialize things in the prefs is fragile, so I think at this point it's unlikely that we'll have something for 71. Let me know if you think the priority here should be higher...", "time": "2019-11-06T17:25:15Z", "author": "gijskruitbosch+bugs@gmail.com", "attachment_id": null, "id": 14471844, "tags": [], "raw_text": "Sorry, I don't yet - I took this over from Jared when he went on leave. I think the current state is sloppy but not critical to fix, so it's taken a backseat to my other priorities.\n\nPer discussion on the bug and on phabricator for the revision Jared had up, I think fixing this is prone to causing other regressions because some of the code surrounding how we initialize things in the prefs is fragile, so I think at this point it's unlikely that we'll have something for 71. Let me know if you think the priority here should be higher...", "creator": "gijskruitbosch+bugs@gmail.com", "is_private": false, "bug_id": 1582740, "count": 7}, {"creation_time": "2019-12-24T23:59:01Z", "text": "Too late for 72, but we can still take a fix for 73 or 74. \nI'm marking this fix-optional in order to remove it from weekly regression triage.", "author": "lizhenry@gmail.com", "time": "2019-12-24T23:59:01Z", "id": 14564037, "attachment_id": null, "tags": [], "creator": "lizhenry@gmail.com", "raw_text": "Too late for 72, but we can still take a fix for 73 or 74. \nI'm marking this fix-optional in order to remove it from weekly regression triage.", "bug_id": 1582740, "count": 8, "is_private": false}, {"author": "gijskruitbosch+bugs@gmail.com", "time": "2020-02-11T17:22:55Z", "count": 9, "bug_id": 1582740, "is_private": false, "creator": "gijskruitbosch+bugs@gmail.com", "text": "Jared, do you have cycles to take this back? :-)", "raw_text": "Jared, do you have cycles to take this back? :-)", "creation_time": "2020-02-11T17:22:55Z", "tags": [], "id": 14634956, "attachment_id": null}, {"id": 14635291, "attachment_id": 9125911, "creation_time": "2020-02-11T19:43:59Z", "tags": [], "creator": "jaws@mozilla.com", "text": "Created attachment 9125911\nBug 1582740 - Default the 'Always check' checkbox to disabled until we load the default browser state to prevent accidental user changes. r?gijs", "raw_text": "", "bug_id": 1582740, "time": "2020-02-11T19:43:59Z", "count": 10, "author": "jaws@mozilla.com", "is_private": false}, {"id": 14639577, "attachment_id": null, "creation_time": "2020-02-13T16:43:56Z", "tags": [], "creator": "jaws@mozilla.com", "text": "I've filed bug 1615348 to get a full fix in here related to comment #2.", "raw_text": "I've filed bug 1615348 to get a full fix in here related to comment #2.", "bug_id": 1582740, "time": "2020-02-13T16:43:56Z", "count": 11, "author": "jaws@mozilla.com", "is_private": false}, {"id": 14639584, "attachment_id": null, "creation_time": "2020-02-13T16:45:31Z", "tags": [], "creator": "pulsebot@bots.tld", "text": "Pushed by jwein@mozilla.com:\nhttps://hg.mozilla.org/integration/autoland/rev/edcb067bb8ea\nDefault the 'Always check' checkbox to disabled until we load the default browser state to prevent accidental user changes. r=Gijs", "raw_text": "Pushed by jwein@mozilla.com:\nhttps://hg.mozilla.org/integration/autoland/rev/edcb067bb8ea\nDefault the 'Always check' checkbox to disabled until we load the default browser state to prevent accidental user changes. r=Gijs", "author": "pulsebot@bots.tld", "count": 12, "time": "2020-02-13T16:45:31Z", "bug_id": 1582740, "is_private": false}, {"is_private": false, "bug_id": 1582740, "count": 13, "raw_text": "Backed out for failures on browser_defaultbrowser_alwayscheck.js\n\n*backout:* https://hg.mozilla.org/integration/autoland/rev/0520df0edda86a58efec5b14520a8bdc6b29d2d3\n\n*push:* https://treeherder.mozilla.org/#/jobs?repo=autoland&revision=edcb067bb8ea668f4e63dff10f577b758a00dd3b&selectedJob=288764718\n\n*failure log:* https://treeherder.mozilla.org/logviewer.html#/jobs?job_id=288764718&repo=autoland&lineNumber=7335\n\n>[task 2020-02-13T17:19:32.535Z] 17:19:32     INFO - TEST-PASS | browser/components/preferences/in-content/tests/browser_defaultbrowser_alwayscheck.js | 'Always Check is disabled because it's locked - true == true - \n[task 2020-02-13T17:19:32.536Z] 17:19:32     INFO - TEST-PASS | browser/components/preferences/in-content/tests/browser_defaultbrowser_alwayscheck.js | The pref is locked and so doesn't get changed - true == true - \n[task 2020-02-13T17:19:32.537Z] 17:19:32     INFO - Leaving test bound clicking_make_default_checks_alwaysCheck_checkbox\n[task 2020-02-13T17:19:32.538Z] 17:19:32     INFO - Entering test bound make_default_disabled_until_prefs_are_loaded\n[task 2020-02-13T17:19:32.538Z] 17:19:32     INFO - Buffered messages finished\n[task 2020-02-13T17:19:32.539Z] 17:19:32     INFO - TEST-UNEXPECTED-FAIL | browser/components/preferences/in-content/tests/browser_defaultbrowser_alwayscheck.js | 'Always Check' is disabled on page load - false == true - \n[task 2020-02-13T17:19:32.539Z] 17:19:32     INFO - Stack trace:\n[task 2020-02-13T17:19:32.539Z] 17:19:32     INFO - resource://testing-common/content-task.js line 110 > eval:null:5\n[task 2020-02-13T17:19:32.539Z] 17:19:32     INFO - resource://testing-common/content-task.js:null:111\n[task 2020-02-13T17:19:32.540Z] 17:19:32     INFO - GECKO(1950) | [Child 2105: Main Thread]: I/DocShellAndDOMWindowLeak --DOCSHELL 0x7ffba4899000 == 0 [pid = 2105] [id = {f18084a7-f101-463a-a763-1aa7da068cba}] [url = about:blank]\n[task 2020-02-13T17:19:32.541Z] 17:19:32     INFO - GECKO(1950) | [Child 2105: Main Thread]: I/DocShellAndDOMWindowLeak --DOMWINDOW == 1 (0x7ffba534c100) [pid = 2105] [serial = 57] [outer = (nil)] [url = about:blank]\n[task 2020-02-13T17:19:32.542Z] 17:19:32     INFO - TEST-PASS | browser/components/preferences/in-content/tests/browser_defaultbrowser_alwayscheck.js | 'Always Check' is enabled after default browser updated - true == true -", "creator": "ncsoregi@mozilla.com", "tags": [], "attachment_id": null, "id": 14639707, "author": "ncsoregi@mozilla.com", "time": "2020-02-13T17:37:04Z", "text": "Backed out for failures on browser_defaultbrowser_alwayscheck.js\n\n*backout:* https://hg.mozilla.org/integration/autoland/rev/0520df0edda86a58efec5b14520a8bdc6b29d2d3\n\n*push:* https://treeherder.mozilla.org/#/jobs?repo=autoland&revision=edcb067bb8ea668f4e63dff10f577b758a00dd3b&selectedJob=288764718\n\n*failure log:* https://treeherder.mozilla.org/logviewer.html#/jobs?job_id=288764718&repo=autoland&lineNumber=7335\n\n>[task 2020-02-13T17:19:32.535Z] 17:19:32     INFO - TEST-PASS | browser/components/preferences/in-content/tests/browser_defaultbrowser_alwayscheck.js | 'Always Check is disabled because it's locked - true == true - \n[task 2020-02-13T17:19:32.536Z] 17:19:32     INFO - TEST-PASS | browser/components/preferences/in-content/tests/browser_defaultbrowser_alwayscheck.js | The pref is locked and so doesn't get changed - true == true - \n[task 2020-02-13T17:19:32.537Z] 17:19:32     INFO - Leaving test bound clicking_make_default_checks_alwaysCheck_checkbox\n[task 2020-02-13T17:19:32.538Z] 17:19:32     INFO - Entering test bound make_default_disabled_until_prefs_are_loaded\n[task 2020-02-13T17:19:32.538Z] 17:19:32     INFO - Buffered messages finished\n[task 2020-02-13T17:19:32.539Z] 17:19:32     INFO - TEST-UNEXPECTED-FAIL | browser/components/preferences/in-content/tests/browser_defaultbrowser_alwayscheck.js | 'Always Check' is disabled on page load - false == true - \n[task 2020-02-13T17:19:32.539Z] 17:19:32     INFO - Stack trace:\n[task 2020-02-13T17:19:32.539Z] 17:19:32     INFO - resource://testing-common/content-task.js line 110 > eval:null:5\n[task 2020-02-13T17:19:32.539Z] 17:19:32     INFO - resource://testing-common/content-task.js:null:111\n[task 2020-02-13T17:19:32.540Z] 17:19:32     INFO - GECKO(1950) | [Child 2105: Main Thread]: I/DocShellAndDOMWindowLeak --DOCSHELL 0x7ffba4899000 == 0 [pid = 2105] [id = {f18084a7-f101-463a-a763-1aa7da068cba}] [url = about:blank]\n[task 2020-02-13T17:19:32.541Z] 17:19:32     INFO - GECKO(1950) | [Child 2105: Main Thread]: I/DocShellAndDOMWindowLeak --DOMWINDOW == 1 (0x7ffba534c100) [pid = 2105] [serial = 57] [outer = (nil)] [url = about:blank]\n[task 2020-02-13T17:19:32.542Z] 17:19:32     INFO - TEST-PASS | browser/components/preferences/in-content/tests/browser_defaultbrowser_alwayscheck.js | 'Always Check' is enabled after default browser updated - true == true -", "creation_time": "2020-02-13T17:37:04Z"}, {"creation_time": "2020-03-09T12:09:05Z", "tags": [], "id": 14684260, "attachment_id": null, "author": "release-mgmt-account-bot@mozilla.tld", "count": 14, "time": "2020-03-09T12:09:05Z", "bug_id": 1582740, "is_private": false, "creator": "release-mgmt-account-bot@mozilla.tld", "raw_text": "There's a r+ patch which didn't land and no activity in this bug for 2 weeks.\n:jaws, could you have a look please?\nFor more information, please visit [auto_nag documentation](https://wiki.mozilla.org/Release_Management/autonag#not_landed.py).", "text": "There's a r+ patch which didn't land and no activity in this bug for 2 weeks.\n:jaws, could you have a look please?\nFor more information, please visit [auto_nag documentation](https://wiki.mozilla.org/Release_Management/autonag#not_landed.py)."}, {"id": 14986574, "attachment_id": null, "tags": [], "creator": "pulsebot@bots.tld", "raw_text": "Pushed by jwein@mozilla.com:\nhttps://hg.mozilla.org/integration/autoland/rev/fa7fc31eff7a\nDefault the 'Always check' checkbox to disabled until we load the default browser state to prevent accidental user changes. r=Gijs,preferences-reviewers", "bug_id": 1582740, "count": 15, "is_private": false, "creation_time": "2020-08-12T16:52:28Z", "text": "Pushed by jwein@mozilla.com:\nhttps://hg.mozilla.org/integration/autoland/rev/fa7fc31eff7a\nDefault the 'Always check' checkbox to disabled until we load the default browser state to prevent accidental user changes. r=Gijs,preferences-reviewers", "time": "2020-08-12T16:52:28Z", "author": "pulsebot@bots.tld"}, {"creator": "dluca@mozilla.com", "raw_text": "https://hg.mozilla.org/mozilla-central/rev/fa7fc31eff7a", "bug_id": 1582740, "count": 16, "is_private": false, "id": 14986936, "attachment_id": null, "tags": ["bugherder"], "text": "https://hg.mozilla.org/mozilla-central/rev/fa7fc31eff7a", "time": "2020-08-12T21:51:19Z", "author": "dluca@mozilla.com", "creation_time": "2020-08-12T21:51:19Z"}]}}, "comments": {}}