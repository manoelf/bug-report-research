{"comments": {}, "bugs": {"704304": {"comments": [{"time": "2011-11-21T22:28:16Z", "attachment_id": null, "raw_text": "In bug 685767, I was bitten by a miscompilation of nsAutoPtr's destructor inside gfxAlphaBoxBlur's destructor. As near as we (Bas Schouten and I) could tell, this was related to the fact that the contained class, mozilla::gfx::AlphaBoxBlur, is contained in namespaces.\n\nThis bug only shows up when compiling Mozilla on Windows with optimization on. Bas was working on a reduced testcase, but I don't know how much luck he had. We think it had to do with function deduplication, since the bug didn't occur in debug builds.\n\nIf you look for nsAutoPtrs with T=anything in a namespace, and then go to the disassembly of the containing class's destructor, you should not see anything containing a delete[] call; you should see something containing a regular delete call. The easiest way to verify this is to break in that class's destructor and step through the assembly for all of the calls to contained destructors.\n\nHere's a list of things to do. You'll need a Windows optimized build. I was able to reproduce this bug with both MSVC 2005 (what we use on our build machines) and 2010.\n\n1. Come up with a list of classes that contain nsAutoPtrs for namespaced classes.\n2. For each of those classes, set a breakpoint in the destructor. Find a way to trigger that destructor; this might result require you to quit Firefox, depending on the class.\n3. Go to the disassembly for the code you're debugging, and step instruction by instruction.\n4. Match up the destructors being called with the members of the class. Destructors are called in the reverse order of their declaration in the class.\n5. If you find any leaks, point them out!", "tags": [], "creator": "joe@drew.ca", "author": "joe@drew.ca", "count": 0, "text": "In bug 685767, I was bitten by a miscompilation of nsAutoPtr's destructor inside gfxAlphaBoxBlur's destructor. As near as we (Bas Schouten and I) could tell, this was related to the fact that the contained class, mozilla::gfx::AlphaBoxBlur, is contained in namespaces.\n\nThis bug only shows up when compiling Mozilla on Windows with optimization on. Bas was working on a reduced testcase, but I don't know how much luck he had. We think it had to do with function deduplication, since the bug didn't occur in debug builds.\n\nIf you look for nsAutoPtrs with T=anything in a namespace, and then go to the disassembly of the containing class's destructor, you should not see anything containing a delete[] call; you should see something containing a regular delete call. The easiest way to verify this is to break in that class's destructor and step through the assembly for all of the calls to contained destructors.\n\nHere's a list of things to do. You'll need a Windows optimized build. I was able to reproduce this bug with both MSVC 2005 (what we use on our build machines) and 2010.\n\n1. Come up with a list of classes that contain nsAutoPtrs for namespaced classes.\n2. For each of those classes, set a breakpoint in the destructor. Find a way to trigger that destructor; this might result require you to quit Firefox, depending on the class.\n3. Go to the disassembly for the code you're debugging, and step instruction by instruction.\n4. Match up the destructors being called with the members of the class. Destructors are called in the reverse order of their declaration in the class.\n5. If you find any leaks, point them out!", "id": 5863715, "bug_id": 704304, "creation_time": "2011-11-21T22:28:16Z", "is_private": false}, {"raw_text": "Yikes.  Did you report the bug to Microsoft?", "attachment_id": null, "time": "2013-01-08T00:26:52Z", "tags": [], "count": 1, "text": "Yikes.  Did you report the bug to Microsoft?", "author": "jruderman@gmail.com", "creator": "jruderman@gmail.com", "creation_time": "2013-01-08T00:26:52Z", "is_private": false, "id": 6972425, "bug_id": 704304}, {"time": "2013-01-08T19:41:49Z", "attachment_id": null, "raw_text": "I don't remember if Bas ended up being able to create a reduced testcase or not, but if he did he sent it on to Microsoft.", "tags": [], "creator": "joe@drew.ca", "author": "joe@drew.ca", "text": "I don't remember if Bas ended up being able to create a reduced testcase or not, but if he did he sent it on to Microsoft.", "count": 2, "bug_id": 704304, "id": 6976122, "is_private": false, "creation_time": "2013-01-08T19:41:49Z"}]}}}