{"bugs": {"639835": {"comments": [{"author": "fherrera@onirica.com", "time": "2011-03-08T16:05:03Z", "id": 5330212, "count": 0, "text": "As reported on this thread:\n\nhttps://mail.gnome.org/archives/orca-list/2011-March/msg00033.html\n\nSometimes orca cannot navigate for the google webpage when firefox has been just launched with google.com as its homepage. Next pages or reloads work fine.\n\nThat may happen because orca is not getting the document:load-complete event (our EVENT_DOCUMENT_LOAD_COMPLETE). \n\nI cannot reproduce it here, but I'm investagating it", "is_private": false, "attachment_id": null, "raw_text": "As reported on this thread:\n\nhttps://mail.gnome.org/archives/orca-list/2011-March/msg00033.html\n\nSometimes orca cannot navigate for the google webpage when firefox has been just launched with google.com as its homepage. Next pages or reloads work fine.\n\nThat may happen because orca is not getting the document:load-complete event (our EVENT_DOCUMENT_LOAD_COMPLETE). \n\nI cannot reproduce it here, but I'm investagating it", "bug_id": 639835, "creation_time": "2011-03-08T16:05:03Z", "creator": "fherrera@onirica.com", "tags": []}, {"is_private": false, "raw_text": "I finally found a way to reproduce it.\n\nIt happens when firefox window is not focused when launched. I can do this under GNOME for example having a terminal window with the \"always on top\" activated and launching firefox from a panel launcher or Alt+F2 dialog. In that case firefox opens, requests the focus to the window manager (metacity won't give it because of the focus stealing prevention) and no document:load-complete is fired.\n\nDoing the same with firefox 3.6 and it fires the document:load-complete", "creation_time": "2011-03-08T23:00:15Z", "bug_id": 639835, "tags": [], "time": "2011-03-08T23:00:15Z", "id": 5331653, "attachment_id": null, "creator": "fherrera@onirica.com", "author": "fherrera@onirica.com", "count": 1, "text": "I finally found a way to reproduce it.\n\nIt happens when firefox window is not focused when launched. I can do this under GNOME for example having a terminal window with the \"always on top\" activated and launching firefox from a panel launcher or Alt+F2 dialog. In that case firefox opens, requests the focus to the window manager (metacity won't give it because of the focus stealing prevention) and no document:load-complete is fired.\n\nDoing the same with firefox 3.6 and it fires the document:load-complete"}, {"is_private": false, "attachment_id": null, "tags": [], "creator": "fherrera@onirica.com", "creation_time": "2011-03-08T23:03:30Z", "bug_id": 639835, "raw_text": "However this happens to me with any home page.", "id": 5331662, "time": "2011-03-08T23:03:30Z", "author": "fherrera@onirica.com", "text": "However this happens to me with any home page.", "count": 2}, {"text": "Actually we are not firing _any_ event until the window is focused.", "count": 3, "author": "fherrera@onirica.com", "creator": "fherrera@onirica.com", "attachment_id": null, "id": 5331706, "time": "2011-03-08T23:18:52Z", "tags": [], "bug_id": 639835, "creation_time": "2011-03-08T23:18:52Z", "raw_text": "Actually we are not firing _any_ event until the window is focused.", "is_private": false}, {"creator": "surkov.alexander@gmail.com", "attachment_id": null, "count": 4, "text": "(In reply to comment #3)\n> Actually we are not firing _any_ event until the window is focused.\n\non atk I guess? We should change that, correct?", "author": "surkov.alexander@gmail.com", "tags": [], "creation_time": "2011-03-09T08:27:43Z", "bug_id": 639835, "raw_text": "(In reply to comment #3)\n> Actually we are not firing _any_ event until the window is focused.\n\non atk I guess? We should change that, correct?", "is_private": false, "id": 5332552, "time": "2011-03-09T08:27:43Z"}, {"text": "Humm, not sure. What happens is that we do not create the accessible tree until the window gets activated. In gtk that happens after:\n\nnsWindow::OnContainerFocusInEvent --> DispatchActivateEventAccessible --> DispatchEventToRootAccessible(nsIAccessibleEvent::EVENT_WINDOW_ACTIVATE)", "count": 5, "author": "fherrera@onirica.com", "creator": "fherrera@onirica.com", "attachment_id": null, "id": 5332625, "time": "2011-03-09T09:43:02Z", "tags": [], "raw_text": "Humm, not sure. What happens is that we do not create the accessible tree until the window gets activated. In gtk that happens after:\n\nnsWindow::OnContainerFocusInEvent --> DispatchActivateEventAccessible --> DispatchEventToRootAccessible(nsIAccessibleEvent::EVENT_WINDOW_ACTIVATE)", "bug_id": 639835, "creation_time": "2011-03-09T09:43:02Z", "is_private": false}, {"is_private": false, "attachment_id": null, "creation_time": "2011-03-09T12:20:41Z", "bug_id": 639835, "raw_text": "On the another hand if we handle notification then document accessible should be created and we shouldn't miss any event. Do we or atk ignores events until window active event isn't handled?", "tags": [], "creator": "surkov.alexander@gmail.com", "time": "2011-03-09T12:20:41Z", "author": "surkov.alexander@gmail.com", "id": 5332786, "count": 6, "text": "On the another hand if we handle notification then document accessible should be created and we shouldn't miss any event. Do we or atk ignores events until window active event isn't handled?"}, {"tags": [], "creator": "fherrera@onirica.com", "creation_time": "2011-03-09T12:52:24Z", "bug_id": 639835, "raw_text": "We are not even creating nsApplicationAccessibleWrap.", "is_private": false, "attachment_id": null, "count": 7, "text": "We are not even creating nsApplicationAccessibleWrap.", "id": 5332826, "time": "2011-03-09T12:52:24Z", "author": "fherrera@onirica.com"}, {"time": "2011-03-09T12:56:04Z", "id": 5332834, "raw_text": "(In reply to comment #7)\n> We are not even creating nsApplicationAccessibleWrap.\n\nnsAccplicationAccessible is created on demand (for example, when root accessible is created), but why do you say \"even\"?", "creation_time": "2011-03-09T12:56:04Z", "bug_id": 639835, "tags": [], "is_private": false, "count": 8, "text": "(In reply to comment #7)\n> We are not even creating nsApplicationAccessibleWrap.\n\nnsAccplicationAccessible is created on demand (for example, when root accessible is created), but why do you say \"even\"?", "author": "surkov.alexander@gmail.com", "creator": "surkov.alexander@gmail.com", "attachment_id": null}, {"creator": "fherrera@onirica.com", "attachment_id": null, "count": 9, "text": "Because in gtk/atk we are not creating _any_ accessible element until we get the first DispatchEventToRootAccessible(nsIAccessibleEvent::EVENT_WINDOW_ACTIVATE)\nthat triggers:\n\naccService->GetRootDocumentAccessible\n  nsAccessNode::GetApplicationAccessible\n    nsApplicationAccessibleWrap\n      nsApplicationAccessible\n        ...", "author": "fherrera@onirica.com", "tags": [], "raw_text": "Because in gtk/atk we are not creating _any_ accessible element until we get the first DispatchEventToRootAccessible(nsIAccessibleEvent::EVENT_WINDOW_ACTIVATE)\nthat triggers:\n\naccService->GetRootDocumentAccessible\n  nsAccessNode::GetApplicationAccessible\n    nsApplicationAccessibleWrap\n      nsApplicationAccessible\n        ...", "bug_id": 639835, "creation_time": "2011-03-09T13:15:14Z", "is_private": false, "id": 5332860, "time": "2011-03-09T13:15:14Z"}, {"count": 10, "text": "(In reply to comment #9)\n> Because in gtk/atk we are not creating _any_ accessible element until we get\n> the first\n> DispatchEventToRootAccessible(nsIAccessibleEvent::EVENT_WINDOW_ACTIVATE)\n> that triggers:\n\ndo you mean nobody request for accessibility service before this, correct?", "author": "surkov.alexander@gmail.com", "creator": "surkov.alexander@gmail.com", "attachment_id": null, "id": 5332878, "time": "2011-03-09T13:21:50Z", "tags": [], "creation_time": "2011-03-09T13:21:50Z", "bug_id": 639835, "raw_text": "(In reply to comment #9)\n> Because in gtk/atk we are not creating _any_ accessible element until we get\n> the first\n> DispatchEventToRootAccessible(nsIAccessibleEvent::EVENT_WINDOW_ACTIVATE)\n> that triggers:\n\ndo you mean nobody request for accessibility service before this, correct?", "is_private": false}, {"count": 11, "text": "(In reply to comment #10)\n> do you mean nobody request for accessibility service before this, correct?\n\nYes", "author": "fherrera@onirica.com", "creator": "fherrera@onirica.com", "attachment_id": null, "time": "2011-03-09T13:22:47Z", "id": 5332880, "bug_id": 639835, "creation_time": "2011-03-09T13:22:47Z", "raw_text": "(In reply to comment #10)\n> do you mean nobody request for accessibility service before this, correct?\n\nYes", "tags": [], "is_private": false}, {"text": "Can we detect that accessibility is enabled or presence of AT?", "count": 12, "author": "surkov.alexander@gmail.com", "creator": "surkov.alexander@gmail.com", "attachment_id": null, "time": "2011-03-09T13:36:25Z", "id": 5332917, "creation_time": "2011-03-09T13:36:25Z", "bug_id": 639835, "raw_text": "Can we detect that accessibility is enabled or presence of AT?", "tags": [], "is_private": false}, {"time": "2011-03-09T13:43:25Z", "author": "fherrera@onirica.com", "id": 5332936, "text": "Yes, actually we are checking it at atk nsApplicationAccessibleWrap::Init and gtk nsWindow::Create to call CreateRootAccessible. That last call looks like the guilty here.", "count": 13, "attachment_id": null, "is_private": false, "bug_id": 639835, "creation_time": "2011-03-09T13:43:25Z", "raw_text": "Yes, actually we are checking it at atk nsApplicationAccessibleWrap::Init and gtk nsWindow::Create to call CreateRootAccessible. That last call looks like the guilty here.", "tags": [], "creator": "fherrera@onirica.com"}, {"is_private": false, "tags": [], "raw_text": "nsWindow::Create is called too late?", "bug_id": 639835, "creation_time": "2011-03-09T15:12:06Z", "id": 5333042, "time": "2011-03-09T15:12:06Z", "attachment_id": null, "creator": "surkov.alexander@gmail.com", "author": "surkov.alexander@gmail.com", "text": "nsWindow::Create is called too late?", "count": 14}, {"count": 15, "text": "no, when nsWindow::Create is called, nsWindow::CreateRootAccessible tries to get the accesible with nsWindow::DispatchAccessibleEvent, but at nsWebShellWindow::HandleEvent docShell is null, so it never calls to presShell->HandleEventWithTarget for getting the accessible.", "author": "fherrera@onirica.com", "creator": "fherrera@onirica.com", "attachment_id": null, "time": "2011-03-09T20:08:09Z", "id": 5333907, "raw_text": "no, when nsWindow::Create is called, nsWindow::CreateRootAccessible tries to get the accesible with nsWindow::DispatchAccessibleEvent, but at nsWebShellWindow::HandleEvent docShell is null, so it never calls to presShell->HandleEventWithTarget for getting the accessible.", "bug_id": 639835, "creation_time": "2011-03-09T20:08:09Z", "tags": [], "is_private": false}, {"time": "2011-03-10T03:07:55Z", "id": 5335064, "raw_text": "Robert, we try to create document accessible when window is created (http://mxr.mozilla.org/mozilla-central/source/widget/src/gtk2/nsWindow.cpp#4205) by sending accessible event (nsIWidget::DispatchEvent) but nsWebShellWindow is not ready to handle events yet (per comment #15). Can we send an accessible event later when we can be sure it can processed correctly?", "creation_time": "2011-03-10T03:07:55Z", "bug_id": 639835, "tags": [], "is_private": false, "text": "Robert, we try to create document accessible when window is created (http://mxr.mozilla.org/mozilla-central/source/widget/src/gtk2/nsWindow.cpp#4205) by sending accessible event (nsIWidget::DispatchEvent) but nsWebShellWindow is not ready to handle events yet (per comment #15). Can we send an accessible event later when we can be sure it can processed correctly?", "count": 16, "author": "surkov.alexander@gmail.com", "creator": "surkov.alexander@gmail.com", "attachment_id": null}, {"bug_id": 639835, "creation_time": "2011-03-10T03:10:45Z", "raw_text": "Fernando, sounds like regression, could you please check?", "tags": [], "is_private": false, "time": "2011-03-10T03:10:45Z", "id": 5335065, "creator": "surkov.alexander@gmail.com", "attachment_id": null, "count": 17, "text": "Fernando, sounds like regression, could you please check?", "author": "surkov.alexander@gmail.com"}, {"attachment_id": null, "is_private": false, "creation_time": "2011-03-10T03:50:30Z", "bug_id": 639835, "raw_text": "Can you make nsWebShellWindow::HandleEvent handle the event itself?", "tags": [], "creator": "roc@ocallahan.org", "time": "2011-03-10T03:50:30Z", "author": "roc@ocallahan.org", "id": 5335116, "text": "Can you make nsWebShellWindow::HandleEvent handle the event itself?", "count": 18}, {"attachment_id": null, "creator": "surkov.alexander@gmail.com", "author": "surkov.alexander@gmail.com", "count": 19, "text": "(In reply to comment #18)\n> Can you make nsWebShellWindow::HandleEvent handle the event itself?\n\nYes, but it's neccessary to get nsIDocument associated with the window (also it should pass conditions in http://mxr.mozilla.org/mozilla-central/source/accessible/src/base/nsAccDocManager.cpp#414, in case of timing issues). Is there a way since docshell is not initialized yet?", "is_private": false, "tags": [], "raw_text": "(In reply to comment #18)\n> Can you make nsWebShellWindow::HandleEvent handle the event itself?\n\nYes, but it's neccessary to get nsIDocument associated with the window (also it should pass conditions in http://mxr.mozilla.org/mozilla-central/source/accessible/src/base/nsAccDocManager.cpp#414, in case of timing issues). Is there a way since docshell is not initialized yet?", "creation_time": "2011-03-10T07:04:13Z", "bug_id": 639835, "id": 5335300, "time": "2011-03-10T07:04:13Z"}, {"count": 20, "text": "No. Maybe you should send the event when the nsPresShell for the root document is created?", "id": 5335379, "author": "roc@ocallahan.org", "time": "2011-03-10T08:23:08Z", "creator": "roc@ocallahan.org", "tags": [], "raw_text": "No. Maybe you should send the event when the nsPresShell for the root document is created?", "bug_id": 639835, "creation_time": "2011-03-10T08:23:08Z", "is_private": false, "attachment_id": null}, {"is_private": false, "bug_id": 639835, "creation_time": "2011-03-10T08:25:34Z", "raw_text": "(In reply to comment #20)\n> No. Maybe you should send the event when the nsPresShell for the root document\n> is created?\n\ndoes it guarantee the widget (native window) is created at this point?", "tags": [], "time": "2011-03-10T08:25:34Z", "id": 5335383, "attachment_id": null, "creator": "surkov.alexander@gmail.com", "author": "surkov.alexander@gmail.com", "count": 21, "text": "(In reply to comment #20)\n> No. Maybe you should send the event when the nsPresShell for the root document\n> is created?\n\ndoes it guarantee the widget (native window) is created at this point?"}, {"author": "roc@ocallahan.org", "count": 22, "text": "Yes I think so.", "attachment_id": null, "creator": "roc@ocallahan.org", "id": 5335397, "time": "2011-03-10T08:34:33Z", "is_private": false, "tags": [], "bug_id": 639835, "creation_time": "2011-03-10T08:34:33Z", "raw_text": "Yes I think so."}, {"raw_text": "Another option, maybe an easier one, is to send the event when we first show a toplevel window in nsIWidget::Show.", "bug_id": 639835, "creation_time": "2011-03-10T08:35:01Z", "creator": "roc@ocallahan.org", "tags": [], "is_private": false, "attachment_id": null, "text": "Another option, maybe an easier one, is to send the event when we first show a toplevel window in nsIWidget::Show.", "count": 23, "author": "roc@ocallahan.org", "time": "2011-03-10T08:35:01Z", "id": 5335399}, {"attachment_id": null, "is_private": false, "tags": [], "creator": "fherrera@onirica.com", "creation_time": "2011-03-10T10:18:10Z", "bug_id": 639835, "raw_text": "With this one, a11y tree is not created without focus:\nhttp://ftp.mozilla.org/pub/mozilla.org/firefox/nightly/2009/09/2009-09-16-03-mozilla-central/\n\nHowever, this one:\nhttp://ftp.mozilla.org/pub/mozilla.org/firefox/nightly/2009/09/2009-09-15-03-mozilla-central/\n\ncreates it because it forces the window to get the focus and a11y tree is created. This forcing focus thing is hiding want we want to know without debugging every build. As 3.6 is not forcing the focus, I'll try going back to check is the change is not hidden.", "id": 5335576, "time": "2011-03-10T10:18:10Z", "author": "fherrera@onirica.com", "text": "With this one, a11y tree is not created without focus:\nhttp://ftp.mozilla.org/pub/mozilla.org/firefox/nightly/2009/09/2009-09-16-03-mozilla-central/\n\nHowever, this one:\nhttp://ftp.mozilla.org/pub/mozilla.org/firefox/nightly/2009/09/2009-09-15-03-mozilla-central/\n\ncreates it because it forces the window to get the focus and a11y tree is created. This forcing focus thing is hiding want we want to know without debugging every build. As 3.6 is not forcing the focus, I'll try going back to check is the change is not hidden.", "count": 24}, {"is_private": false, "raw_text": "This is the related change stopping the window activation:\n\nhttp://hg.mozilla.org/mozilla-central/rev/329ff0fcd420", "creation_time": "2011-03-10T10:20:53Z", "bug_id": 639835, "tags": [], "time": "2011-03-10T10:20:53Z", "id": 5335578, "attachment_id": null, "creator": "fherrera@onirica.com", "author": "fherrera@onirica.com", "text": "This is the related change stopping the window activation:\n\nhttp://hg.mozilla.org/mozilla-central/rev/329ff0fcd420", "count": 25}, {"creator": "fherrera@onirica.com", "attachment_id": null, "count": 26, "text": "So before this change: \n\nhttp://hg.mozilla.org/mozilla-central/rev/cabb8925dcd3\n\n(that forced window activation) we were not creating the a11y tree, that makes me wonder why 3.6.14 is not forcing window activation but creating the tree on time.", "author": "fherrera@onirica.com", "creation_time": "2011-03-10T10:28:36Z", "bug_id": 639835, "raw_text": "So before this change: \n\nhttp://hg.mozilla.org/mozilla-central/rev/cabb8925dcd3\n\n(that forced window activation) we were not creating the a11y tree, that makes me wonder why 3.6.14 is not forcing window activation but creating the tree on time.", "tags": [], "is_private": false, "time": "2011-03-10T10:28:36Z", "id": 5335588}, {"creator": "surkov.alexander@gmail.com", "attachment_id": null, "count": 27, "text": "If there's no any problem with absent window activation on focus, then I suggest to follow Robert suggestion from comment #23.", "author": "surkov.alexander@gmail.com", "tags": [], "raw_text": "If there's no any problem with absent window activation on focus, then I suggest to follow Robert suggestion from comment #23.", "bug_id": 639835, "creation_time": "2011-03-10T10:31:12Z", "is_private": false, "id": 5335592, "time": "2011-03-10T10:31:12Z"}, {"author": "fherrera@onirica.com", "text": "Created attachment 518335\nCreate Root accesible onShow\n\nSomething like this should work.", "count": 28, "attachment_id": 518335, "creator": "fherrera@onirica.com", "id": 5335775, "time": "2011-03-10T12:39:24Z", "is_private": false, "tags": [], "creation_time": "2011-03-10T12:39:24Z", "bug_id": 639835, "raw_text": "Something like this should work."}, {"raw_text": "BTW can we have an automated test for this?", "creation_time": "2011-03-23T04:22:02Z", "bug_id": 639835, "creator": "roc@ocallahan.org", "tags": [], "attachment_id": null, "is_private": false, "text": "BTW can we have an automated test for this?", "count": 29, "author": "roc@ocallahan.org", "time": "2011-03-23T04:22:02Z", "id": 5361822}, {"creator": "surkov.alexander@gmail.com", "tags": [], "raw_text": "(In reply to comment #29)\n> BTW can we have an automated test for this?\n\nperhaps tests on Orca side would work, especially if we want to get tinderbox for that.", "creation_time": "2011-03-23T04:27:58Z", "bug_id": 639835, "attachment_id": null, "is_private": false, "text": "(In reply to comment #29)\n> BTW can we have an automated test for this?\n\nperhaps tests on Orca side would work, especially if we want to get tinderbox for that.", "count": 30, "id": 5361826, "author": "surkov.alexander@gmail.com", "time": "2011-03-23T04:27:58Z"}, {"time": "2011-03-24T14:24:26Z", "id": 5365769, "bug_id": 639835, "creation_time": "2011-03-24T14:24:26Z", "raw_text": "I think testing on the orca side would work better, as we cannot really prevent window having focus on mochitest (but running with orca/other app window on top can do it)", "tags": [], "is_private": false, "text": "I think testing on the orca side would work better, as we cannot really prevent window having focus on mochitest (but running with orca/other app window on top can do it)", "count": 31, "author": "fherrera@onirica.com", "creator": "fherrera@onirica.com", "attachment_id": null}, {"author": "surkov.alexander@gmail.com", "time": "2011-05-28T11:35:28Z", "id": 5499700, "count": 32, "text": "landed - http://hg.mozilla.org/mozilla-central/rev/9260bd59d5ce", "is_private": false, "attachment_id": null, "raw_text": "landed - http://hg.mozilla.org/mozilla-central/rev/9260bd59d5ce", "creation_time": "2011-05-28T11:35:28Z", "bug_id": 639835, "creator": "surkov.alexander@gmail.com", "tags": []}, {"raw_text": "According to this user feedback:\n\nhttp://mail.gnome.org/archives/orca-list/2011-May/msg00431.html\n\nit fixes the main problem, but introduces some other problem. So it would need further investigation/testing.", "creation_time": "2011-05-30T11:44:18Z", "bug_id": 639835, "tags": [], "is_private": false, "time": "2011-05-30T11:44:18Z", "id": 5501283, "creator": "fherrera@onirica.com", "attachment_id": null, "count": 33, "text": "According to this user feedback:\n\nhttp://mail.gnome.org/archives/orca-list/2011-May/msg00431.html\n\nit fixes the main problem, but introduces some other problem. So it would need further investigation/testing.", "author": "fherrera@onirica.com"}, {"id": 5502842, "time": "2011-05-31T08:59:33Z", "is_private": false, "tags": [], "creation_time": "2011-05-31T08:59:33Z", "bug_id": 639835, "raw_text": "Fernando, are you sure these problems are related? If I read the user feedback right then he tells about broken accessible name. I think it's worth to file follow up for this.\n\nMarco, doesn't the issue sound familiar to you?", "author": "surkov.alexander@gmail.com", "count": 34, "text": "Fernando, are you sure these problems are related? If I read the user feedback right then he tells about broken accessible name. I think it's worth to file follow up for this.\n\nMarco, doesn't the issue sound familiar to you?", "attachment_id": null, "creator": "surkov.alexander@gmail.com"}, {"id": 5569141, "author": "surkov.alexander@gmail.com", "time": "2011-07-01T09:16:31Z", "text": "Trevor, could you look at comment #33 please? Is it related with this bug?", "count": 35, "is_private": false, "attachment_id": null, "creator": "surkov.alexander@gmail.com", "tags": [], "raw_text": "Trevor, could you look at comment #33 please? Is it related with this bug?", "creation_time": "2011-07-01T09:16:31Z", "bug_id": 639835}]}}, "comments": {}}