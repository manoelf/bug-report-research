{"comments": {}, "bugs": {"701717": {"comments": [{"tags": [], "time": "2011-11-11T15:58:05Z", "raw_text": "The code comment linked in the URL field says that there are functions copied from NSPR into nsLocalFileWin.cpp because NSPR doesn't have UTF-16 support for pre-NT4 platforms. Since we no longer support those platforms, we should clean up this code and just make it use NSPR or the Win32 Unicode APIs directly.", "attachment_id": null, "bug_id": 701717, "id": 5842749, "is_private": false, "creation_time": "2011-11-11T15:58:05Z", "creator": "ted@mielczarek.org", "text": "The code comment linked in the URL field says that there are functions copied from NSPR into nsLocalFileWin.cpp because NSPR doesn't have UTF-16 support for pre-NT4 platforms. Since we no longer support those platforms, we should clean up this code and just make it use NSPR or the Win32 Unicode APIs directly.", "count": 0, "author": "ted@mielczarek.org"}, {"author": "rain@sunshowers.io", "text": "Hm, the problem with NSPR is that it calls the ANSI versions of Win32 APIs (which do *not* support UTF-8, only the system code page [1]), not the Unicode versions. For instance, https://mxr.mozilla.org/mozilla-central/source/nsprpub/pr/src/md/windows/ntio.c#3137 calls MoveFile with char* arguments, which obviously means it's calling MoveFileA, not MoveFileW. What it effectively means is that NSPR's file handling is buggy and unreliable, and should not be used in any shipping code.\n\nAs far as I can tell, the only ways to fix this are to either move NSPR wholesale to UTF-16 (probably not what we want to do), or to rewrite all the Windows NT code to convert to UTF-16 each time we need to call a Win32 API.\n\n[1] http://blogs.msdn.com/b/michkap/archive/2006/10/11/816996.aspx", "count": 1, "creator": "rain@sunshowers.io", "creation_time": "2012-01-03T14:47:19Z", "is_private": false, "bug_id": 701717, "id": 5950782, "attachment_id": null, "raw_text": "Hm, the problem with NSPR is that it calls the ANSI versions of Win32 APIs (which do *not* support UTF-8, only the system code page [1]), not the Unicode versions. For instance, https://mxr.mozilla.org/mozilla-central/source/nsprpub/pr/src/md/windows/ntio.c#3137 calls MoveFile with char* arguments, which obviously means it's calling MoveFileA, not MoveFileW. What it effectively means is that NSPR's file handling is buggy and unreliable, and should not be used in any shipping code.\n\nAs far as I can tell, the only ways to fix this are to either move NSPR wholesale to UTF-16 (probably not what we want to do), or to rewrite all the Windows NT code to convert to UTF-16 each time we need to call a Win32 API.\n\n[1] http://blogs.msdn.com/b/michkap/archive/2006/10/11/816996.aspx", "time": "2012-01-03T14:47:19Z", "tags": []}, {"is_private": false, "creation_time": "2013-05-10T10:57:37Z", "bug_id": 701717, "id": 7408877, "author": "alfredkayser@gmail.com", "count": 2, "text": "See bug 622085 where there is a patch to do this for opendir/readdir/closedir.", "creator": "alfredkayser@gmail.com", "tags": [], "attachment_id": null, "raw_text": "See bug 622085 where there is a patch to do this for opendir/readdir/closedir.", "time": "2013-05-10T10:57:37Z"}]}}}