{"bugs": {"622469": {"comments": [{"tags": [], "author": "thomas.jones@utoronto.ca", "attachment_id": null, "bug_id": 622469, "raw_text": "User-Agent:       Mozilla/5.0 (X11; Linux x86_64; rv:2.0b9pre) Gecko/20101228 Firefox/4.0b9pre\nBuild Identifier: \n\n\nthis seems to generate a temporary copy of the source:\n\n// buffer is a canvas, but not the same one that cr is drawing to. \n// ie buffer != cr.canvas, they are the same width/height though\ncr.save();\ncr.fillStyle = cr.createPattern(buffer, \"repeat-x\");\ncr.translate(-vpx, 0);\ncr.fillRect(0, 0, w*2, h);\ncr.restore();\n\n\nThe goal is to create a scrolling effect, so that I update a column of pixels in buffer, then later on draw with cr into a visible canvas such that the contents of buffer appear to scroll sideways.\n\nIf I try to do it with the above snippet it works for a second or so, then slows down.\n\nWorkaround is to do it this way:\ncr.drawImage(buffer, -vpx-1, 0);\ncr.drawImage(buffer, w-vpx-1, 0);\n\nbut I like the first way since it only involves one draw operation.\n\nReproducible: Always", "count": 0, "creator": "thomas.jones@utoronto.ca", "creation_time": "2011-01-03T01:43:53Z", "id": 5170566, "text": "User-Agent:       Mozilla/5.0 (X11; Linux x86_64; rv:2.0b9pre) Gecko/20101228 Firefox/4.0b9pre\nBuild Identifier: \n\n\nthis seems to generate a temporary copy of the source:\n\n// buffer is a canvas, but not the same one that cr is drawing to. \n// ie buffer != cr.canvas, they are the same width/height though\ncr.save();\ncr.fillStyle = cr.createPattern(buffer, \"repeat-x\");\ncr.translate(-vpx, 0);\ncr.fillRect(0, 0, w*2, h);\ncr.restore();\n\n\nThe goal is to create a scrolling effect, so that I update a column of pixels in buffer, then later on draw with cr into a visible canvas such that the contents of buffer appear to scroll sideways.\n\nIf I try to do it with the above snippet it works for a second or so, then slows down.\n\nWorkaround is to do it this way:\ncr.drawImage(buffer, -vpx-1, 0);\ncr.drawImage(buffer, w-vpx-1, 0);\n\nbut I like the first way since it only involves one draw operation.\n\nReproducible: Always", "time": "2011-01-03T01:43:53Z", "is_private": false}, {"count": 1, "is_private": false, "raw_text": "Can you attach as a html testcase please.\n\nAlso, related to bug 468358 at all?", "text": "Can you attach as a html testcase please.\n\nAlso, related to bug 468358 at all?", "id": 5170613, "time": "2011-01-03T02:59:22Z", "creation_time": "2011-01-03T02:59:22Z", "attachment_id": null, "bug_id": 622469, "creator": "emorley@mozilla.com", "tags": [], "author": "emorley@mozilla.com"}, {"count": 2, "is_private": false, "id": 5170626, "raw_text": "I'm not sure if it's related to bug 468358 or not... could be, if the code doesn't look like it does in Comment 2 of that bug anymore... what happens in the y direction shouldn't matter (I could actually just use \"repeat\" and the final rendering shouldn't change)\n\nI have a page I'm playing with, but it has a bunch of other stuff and it's spread out over a bunch of files, I'll make a test case soon though.\n\nI only really notice a serious slowdown if firefox is otherwise using lots of memory (I have 100s of tabs open most of the time...) in a fresh profile it just causes a gc pause every few seconds.", "text": "I'm not sure if it's related to bug 468358 or not... could be, if the code doesn't look like it does in Comment 2 of that bug anymore... what happens in the y direction shouldn't matter (I could actually just use \"repeat\" and the final rendering shouldn't change)\n\nI have a page I'm playing with, but it has a bunch of other stuff and it's spread out over a bunch of files, I'll make a test case soon though.\n\nI only really notice a serious slowdown if firefox is otherwise using lots of memory (I have 100s of tabs open most of the time...) in a fresh profile it just causes a gc pause every few seconds.", "time": "2011-01-03T03:18:59Z", "creation_time": "2011-01-03T03:18:59Z", "attachment_id": null, "bug_id": 622469, "tags": [], "creator": "thomas.jones@utoronto.ca", "author": "thomas.jones@utoronto.ca"}, {"creation_time": "2011-01-03T03:43:23Z", "creator": "thomas.jones@utoronto.ca", "is_private": false, "time": "2011-01-03T03:43:23Z", "id": 5170643, "text": "Created attachment 500736\ntestcase\n\nAdding test case, there's a checkbox, check it to make it switch to using the non-workaround version of the code. (it starts off using the version with the workaround)", "bug_id": 622469, "attachment_id": 500736, "author": "thomas.jones@utoronto.ca", "tags": [], "count": 3, "raw_text": "Adding test case, there's a checkbox, check it to make it switch to using the non-workaround version of the code. (it starts off using the version with the workaround)"}, {"creation_time": "2011-01-03T04:04:51Z", "creator": "emorley@mozilla.com", "is_private": false, "time": "2011-01-03T04:04:51Z", "id": 5170660, "text": "Thanks for the testcase.\n\nTestcase WFM (no difference between ticked and not) with ~80 tabs open, 1.5GB working set using Mozilla/5.0 (Windows NT 6.1; WOW64; rv:2.0b9pre) Gecko/20110102 Firefox/4.0b9pre ID:20110102030355\n\nDoes enabling/disabling hardware acceleration make any difference for you?\n\nDoes this still occur if you create a clean profile (with no addons), open a load of tabs to simulate a large session, then run the testcase htm?\n\nDoes this occur in 3.6.13?", "bug_id": 622469, "attachment_id": null, "author": "emorley@mozilla.com", "tags": [], "count": 4, "raw_text": "Thanks for the testcase.\n\nTestcase WFM (no difference between ticked and not) with ~80 tabs open, 1.5GB working set using Mozilla/5.0 (Windows NT 6.1; WOW64; rv:2.0b9pre) Gecko/20110102 Firefox/4.0b9pre ID:20110102030355\n\nDoes enabling/disabling hardware acceleration make any difference for you?\n\nDoes this still occur if you create a clean profile (with no addons), open a load of tabs to simulate a large session, then run the testcase htm?\n\nDoes this occur in 3.6.13?"}, {"is_private": false, "id": 5170677, "text": "Don't know about 3.6.13 (I don't have it installed, just betas and nightlies), try watching FF memory usage, it will go up and down...\n\nI'm on Linux. x86_64, with an Intel GPU (GMA 4500M IIRC)\n\nI'm not sure how much difference hw accel would make since it's firefox that ends up using memory, so it's probably doing this step in software. (and in fact does seem to happen if I set lays.accelerate-none to true)\n\nI don't think you'd actually notice anything in the page I uploaded unless your system is actually hitting swap and waiting on that (which happens to me if I wait a minute or two).\n\nI can still see it if I start a clean profile and run ff with -no-remote (the memory pressure then mostly comes from ff still running my main session).\n\nIf you monitor FF memory use/graphics surfaces allocated you should be able to see it create surfaces for several frames, hit gc free them all, then repeat. However that's sort of a side issue, the reason I filed a bug is that it could do it without making a copy since the surface is never written to while the pattern is in use, I think cairo can sometimes detect this sort of thing and avoid copies. \n\nPossibly this won't be easy to make go away, if the copy can be avoided all together inside cairo it's probably worth figuring out how to make that happen, otherwise not so much.\n\nIt might make it slightly more obvious if the canvas was larger (say 1024x1024).", "time": "2011-01-03T04:26:35Z", "creator": "thomas.jones@utoronto.ca", "creation_time": "2011-01-03T04:26:35Z", "raw_text": "Don't know about 3.6.13 (I don't have it installed, just betas and nightlies), try watching FF memory usage, it will go up and down...\n\nI'm on Linux. x86_64, with an Intel GPU (GMA 4500M IIRC)\n\nI'm not sure how much difference hw accel would make since it's firefox that ends up using memory, so it's probably doing this step in software. (and in fact does seem to happen if I set lays.accelerate-none to true)\n\nI don't think you'd actually notice anything in the page I uploaded unless your system is actually hitting swap and waiting on that (which happens to me if I wait a minute or two).\n\nI can still see it if I start a clean profile and run ff with -no-remote (the memory pressure then mostly comes from ff still running my main session).\n\nIf you monitor FF memory use/graphics surfaces allocated you should be able to see it create surfaces for several frames, hit gc free them all, then repeat. However that's sort of a side issue, the reason I filed a bug is that it could do it without making a copy since the surface is never written to while the pattern is in use, I think cairo can sometimes detect this sort of thing and avoid copies. \n\nPossibly this won't be easy to make go away, if the copy can be avoided all together inside cairo it's probably worth figuring out how to make that happen, otherwise not so much.\n\nIt might make it slightly more obvious if the canvas was larger (say 1024x1024).", "count": 5, "tags": [], "author": "thomas.jones@utoronto.ca", "attachment_id": null, "bug_id": 622469}, {"creator": "thomas.jones@utoronto.ca", "creation_time": "2011-08-18T18:43:25Z", "is_private": false, "time": "2011-08-18T18:43:25Z", "id": 5663257, "text": "This is still happening in Firefox nightlies, only now it's easier to say what's going on.\n\nIf you start up in a fresh profile, then load the testcase in one window and about:memory in the other, then check the 'Enable Suck' checkbox and refresh about:memory rapidly while watching the value for 'gfx-surface-xlib' it goes up and up and up for a while (it gets to about 250MB for me) then it drops (down to ~2MB for me), and starts going up again. (Obviously there might not be a problem on windows...)\n\nI'm pretty sure I'm not getting layers acceleration (Running Mesa 7.10 with r600 gallium, I'm pretty sure that combo is black listed for GL stuff)", "author": "thomas.jones@utoronto.ca", "tags": [], "bug_id": 622469, "attachment_id": null, "raw_text": "This is still happening in Firefox nightlies, only now it's easier to say what's going on.\n\nIf you start up in a fresh profile, then load the testcase in one window and about:memory in the other, then check the 'Enable Suck' checkbox and refresh about:memory rapidly while watching the value for 'gfx-surface-xlib' it goes up and up and up for a while (it gets to about 250MB for me) then it drops (down to ~2MB for me), and starts going up again. (Obviously there might not be a problem on windows...)\n\nI'm pretty sure I'm not getting layers acceleration (Running Mesa 7.10 with r600 gallium, I'm pretty sure that combo is black listed for GL stuff)", "count": 6}, {"text": "Just a ping to say, \"Still happens\" and given that it can use up to 500MB at times might it be good to make it a MemShrink bug?", "id": 5704979, "time": "2011-09-07T15:46:16Z", "is_private": false, "creation_time": "2011-09-07T15:46:16Z", "creator": "thomas.jones@utoronto.ca", "count": 7, "raw_text": "Just a ping to say, \"Still happens\" and given that it can use up to 500MB at times might it be good to make it a MemShrink bug?", "attachment_id": null, "bug_id": 622469, "tags": [], "author": "thomas.jones@utoronto.ca"}, {"creation_time": "2011-09-07T15:49:22Z", "bug_id": 622469, "attachment_id": null, "author": "emorley@mozilla.com", "tags": [], "creator": "emorley@mozilla.com", "count": 8, "is_private": false, "time": "2011-09-07T15:49:22Z", "raw_text": "Thanks for the update - sorry comment 6 got missed. I've marking this as a memshrink bug so it can be assessed/prioritised at the next triage meeting.\n\nCheers! :-)", "text": "Thanks for the update - sorry comment 6 got missed. I've marking this as a memshrink bug so it can be assessed/prioritised at the next triage meeting.\n\nCheers! :-)", "id": 5704993}, {"text": "I can reproduce something like this on OS X. At least one of the things that will help with this is bug 681479", "id": 5726710, "time": "2011-09-20T21:06:04Z", "is_private": false, "creation_time": "2011-09-20T21:06:04Z", "creator": "jmuizelaar@mozilla.com", "count": 9, "raw_text": "I can reproduce something like this on OS X. At least one of the things that will help with this is bug 681479", "attachment_id": null, "bug_id": 622469, "tags": [], "author": "jmuizelaar@mozilla.com"}, {"tags": [], "author": "thomas.jones@utoronto.ca", "attachment_id": null, "bug_id": 622469, "raw_text": "Additional little bit of information, 'gfx-surface-xlib' stays stable if the tab that has my testcase in it is not the active tab in it's window so when testing make certain that it is in a foreground tab.", "count": 10, "creator": "thomas.jones@utoronto.ca", "creation_time": "2011-11-07T18:20:19Z", "text": "Additional little bit of information, 'gfx-surface-xlib' stays stable if the tab that has my testcase in it is not the active tab in it's window so when testing make certain that it is in a foreground tab.", "id": 5831403, "time": "2011-11-07T18:20:19Z", "is_private": false}]}}, "comments": {}}