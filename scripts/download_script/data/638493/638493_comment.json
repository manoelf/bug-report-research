{"bugs": {"638493": {"comments": [{"is_private": false, "tags": [], "raw_text": "Running window.close() from inside a chromeTab doesn't close the tab anymore. I just tested with a contentTab and it doesn't work anymore as well.\n\nThe code is here http://mxr.mozilla.org/comm-central/source/mail/base/content/specialTabs.js#965\n\nsid, while I was writing the tests for the spellchecker context menu in content tabs, there was at the bottom of test-content-tabs.js a comment saying:\n\n// TODO\n// - window.close() from contentTab\n\nwhich is why I wrote the extra test, but your told me in https://bugzilla.mozilla.org/show_bug.cgi?id=626076#c4 that you thought we had \"plenty of tests for this\". Actually, I don't think we have any tests or that would've been spotted before. I'd like to be proved wrong, though :-).\n\nThe test I initially wrote fired window.close through \"the outside\", by accessing the content tab's inner window object through the tabmail. I could not get it to work by inserting a fake <a onclick=\"window.close();\"> inside the content tab and then clicking on it through mozmill. There's probably something going wrong with the event.isTrusted check we make before actually closing the tab.\n\nI'm taking this, but any comments/thoughts would be highly appreciated :-), especially on the rationale for isTrusted.\n\nCCing relevant people who seem to have been working on this.", "attachment_id": null, "id": 5319198, "text": "Running window.close() from inside a chromeTab doesn't close the tab anymore. I just tested with a contentTab and it doesn't work anymore as well.\n\nThe code is here http://mxr.mozilla.org/comm-central/source/mail/base/content/specialTabs.js#965\n\nsid, while I was writing the tests for the spellchecker context menu in content tabs, there was at the bottom of test-content-tabs.js a comment saying:\n\n// TODO\n// - window.close() from contentTab\n\nwhich is why I wrote the extra test, but your told me in https://bugzilla.mozilla.org/show_bug.cgi?id=626076#c4 that you thought we had \"plenty of tests for this\". Actually, I don't think we have any tests or that would've been spotted before. I'd like to be proved wrong, though :-).\n\nThe test I initially wrote fired window.close through \"the outside\", by accessing the content tab's inner window object through the tabmail. I could not get it to work by inserting a fake <a onclick=\"window.close();\"> inside the content tab and then clicking on it through mozmill. There's probably something going wrong with the event.isTrusted check we make before actually closing the tab.\n\nI'm taking this, but any comments/thoughts would be highly appreciated :-), especially on the rationale for isTrusted.\n\nCCing relevant people who seem to have been working on this.", "creation_time": "2011-03-03T18:36:18Z", "time": "2011-03-03T18:36:18Z", "count": 0, "bug_id": 638493, "author": "jonathan.protzenko@gmail.com", "creator": "jonathan.protzenko@gmail.com"}, {"is_private": false, "tags": [], "raw_text": "(In reply to comment #0)\n> \n> which is why I wrote the extra test, but your told me in\n> https://bugzilla.mozilla.org/show_bug.cgi?id=626076#c4 that you thought we had\n> \"plenty of tests for this\". Actually, I don't think we have any tests or that\n> would've been spotted before.\n\nHahaha, ouch, you're right -- I was probably thinking of window.close tests in general.", "id": 5319206, "attachment_id": null, "text": "(In reply to comment #0)\n> \n> which is why I wrote the extra test, but your told me in\n> https://bugzilla.mozilla.org/show_bug.cgi?id=626076#c4 that you thought we had\n> \"plenty of tests for this\". Actually, I don't think we have any tests or that\n> would've been spotted before.\n\nHahaha, ouch, you're right -- I was probably thinking of window.close tests in general.", "creation_time": "2011-03-03T18:38:12Z", "time": "2011-03-03T18:38:12Z", "count": 1, "bug_id": 638493, "author": "rain@sunshowers.io", "creator": "rain@sunshowers.io"}, {"count": 2, "bug_id": 638493, "raw_text": "Heh no problem. It's just clear now I'll have to write tests for that :-). Right now I'm kind of confused as to why the DOMWindowClose event does not fire...", "tags": [], "is_private": false, "time": "2011-03-03T19:04:49Z", "creation_time": "2011-03-03T19:04:49Z", "author": "jonathan.protzenko@gmail.com", "text": "Heh no problem. It's just clear now I'll have to write tests for that :-). Right now I'm kind of confused as to why the DOMWindowClose event does not fire...", "creator": "jonathan.protzenko@gmail.com", "attachment_id": null, "id": 5319316}, {"creation_time": "2011-03-04T17:54:19Z", "attachment_id": null, "id": 5322053, "text": "So the thing is, Firefox has a policy for *content* that says: \u00ab if page A is calling window.close(), unless page A has been opened by a call to window.open(\"pageA\"), calling window.close() will do nothing \u00bb. That seems alright.\n\nHowever, *chrome* code should be able to close itself, i.e. running window.close() from chrome://myext/content/myChromePage.html should actually close the tab. It does not, and the DOMWindowClose event is not even fired.\n\nYou can try this out in your Thunderbird by running the line below:\n\nComponents.classes['@mozilla.org/appshell/window-mediator;1'].getService(Components.interfaces.nsIWindowMediator).getMostRecentWindow(\"mail:3pane\").document.getElementById(\"tabmail\").openTab(\"chromeTab\", {chromePage: 'data:text/html,<a href=\"http://\" onclick=\"dump(\\'xxxxx\\\\n\\'); window.close(); return false\">hello</a>'});\n\nThis opens a new chrome tab with a link inside. The link, when clicked, will dump (to check that it actually does something) then run window.close(). Nothing will happen.\n\n:asuth, any ideas about that?", "raw_text": "So the thing is, Firefox has a policy for *content* that says: \u00ab if page A is calling window.close(), unless page A has been opened by a call to window.open(\"pageA\"), calling window.close() will do nothing \u00bb. That seems alright.\n\nHowever, *chrome* code should be able to close itself, i.e. running window.close() from chrome://myext/content/myChromePage.html should actually close the tab. It does not, and the DOMWindowClose event is not even fired.\n\nYou can try this out in your Thunderbird by running the line below:\n\nComponents.classes['@mozilla.org/appshell/window-mediator;1'].getService(Components.interfaces.nsIWindowMediator).getMostRecentWindow(\"mail:3pane\").document.getElementById(\"tabmail\").openTab(\"chromeTab\", {chromePage: 'data:text/html,<a href=\"http://\" onclick=\"dump(\\'xxxxx\\\\n\\'); window.close(); return false\">hello</a>'});\n\nThis opens a new chrome tab with a link inside. The link, when clicked, will dump (to check that it actually does something) then run window.close(). Nothing will happen.\n\n:asuth, any ideas about that?", "is_private": false, "tags": [], "creator": "jonathan.protzenko@gmail.com", "author": "jonathan.protzenko@gmail.com", "bug_id": 638493, "count": 3, "time": "2011-03-04T17:54:19Z"}, {"creation_time": "2011-03-09T11:25:31Z", "author": "nth10sd@gmail.com", "attachment_id": null, "id": 5332742, "text": "Using the test command in comment 3,\n\nMozilla/5.0 (Windows; U; Windows NT 6.1; en-US; rv:1.9.3a1pre) Gecko/20090928 Shredder/3.1a1pre\n\nNothing happens when \"Evaluate\" is pressed\n\nMiramar 3.3 Alpha 2 as well as:\nMozilla/5.0 (Windows; U; Windows NT 6.1; en-US; rv:1.9.3a1pre) Gecko/20090929 Shredder/3.1a1pre\n\nDumped: (Tab is not closed when link is clicked)\n[object Object]\n\nMay be related to bug 519041?\n\nhttp://hg.mozilla.org/comm-central/pushloghtml?startdate=2009-09-28+03%3A00&enddate=2009-09-29+03%3A00\nhttp://hg.mozilla.org/mozilla-central/pushloghtml?startdate=2009-09-28+03%3A00&enddate=2009-09-29+03%3A00", "creator": "nth10sd@gmail.com", "count": 4, "raw_text": "Using the test command in comment 3,\n\nMozilla/5.0 (Windows; U; Windows NT 6.1; en-US; rv:1.9.3a1pre) Gecko/20090928 Shredder/3.1a1pre\n\nNothing happens when \"Evaluate\" is pressed\n\nMiramar 3.3 Alpha 2 as well as:\nMozilla/5.0 (Windows; U; Windows NT 6.1; en-US; rv:1.9.3a1pre) Gecko/20090929 Shredder/3.1a1pre\n\nDumped: (Tab is not closed when link is clicked)\n[object Object]\n\nMay be related to bug 519041?\n\nhttp://hg.mozilla.org/comm-central/pushloghtml?startdate=2009-09-28+03%3A00&enddate=2009-09-29+03%3A00\nhttp://hg.mozilla.org/mozilla-central/pushloghtml?startdate=2009-09-28+03%3A00&enddate=2009-09-29+03%3A00", "bug_id": 638493, "is_private": false, "tags": [], "time": "2011-03-09T11:25:31Z"}, {"text": "Gary, I think 20090928 is around the time the tabbrowser first started to work properly in Thunderbird. So it looks like this never actually worked in the first place, this being \"a chrome tab should be able to close itself by calling window.close()\".", "creator": "jonathan.protzenko@gmail.com", "attachment_id": null, "id": 5333035, "author": "jonathan.protzenko@gmail.com", "creation_time": "2011-03-09T14:58:07Z", "time": "2011-03-09T14:58:07Z", "tags": [], "is_private": false, "bug_id": 638493, "raw_text": "Gary, I think 20090928 is around the time the tabbrowser first started to work properly in Thunderbird. So it looks like this never actually worked in the first place, this being \"a chrome tab should be able to close itself by calling window.close()\".", "count": 5}, {"creation_time": "2011-03-27T17:32:05Z", "attachment_id": null, "id": 5372919, "text": "function closeTab() {\n  let browser = window.frameElement;\n  let tabmail = window.top.document.getElementById(\"tabmail\");\n  let tabs = tabmail.tabInfo;\n  let candidates = tabs.filter(function (x) x.browser == browser);\n  if (candidates.length == 1) {\n    tabmail.closeTab(candidates[0]);\n  } else {\n    Log.error(\"Couldn't find a tab to close...\");\n  }\n}\n\nNow I'm using the function above to efficiently close myself from inside a chrome tab. Maybe we could just add a line into specialTabs.js that injects this function into the freshly loaded chrome tab, in lieu of the default close action? That seems like a huge hack, but I'm afraid I have no better solution to offer, and I'm not skilled enough to determine why the DOMWindowClose event should fail to propagate.", "raw_text": "function closeTab() {\n  let browser = window.frameElement;\n  let tabmail = window.top.document.getElementById(\"tabmail\");\n  let tabs = tabmail.tabInfo;\n  let candidates = tabs.filter(function (x) x.browser == browser);\n  if (candidates.length == 1) {\n    tabmail.closeTab(candidates[0]);\n  } else {\n    Log.error(\"Couldn't find a tab to close...\");\n  }\n}\n\nNow I'm using the function above to efficiently close myself from inside a chrome tab. Maybe we could just add a line into specialTabs.js that injects this function into the freshly loaded chrome tab, in lieu of the default close action? That seems like a huge hack, but I'm afraid I have no better solution to offer, and I'm not skilled enough to determine why the DOMWindowClose event should fail to propagate.", "is_private": false, "tags": [], "creator": "jonathan.protzenko@gmail.com", "author": "jonathan.protzenko@gmail.com", "bug_id": 638493, "count": 6, "time": "2011-03-27T17:32:05Z"}, {"creation_time": "2011-06-20T17:14:40Z", "text": "Boris, do you have any hint as to why this might be failing? It sounds to me like this is related to the docshell, but I'm not very familiar with that area of the code. Thanks!", "attachment_id": null, "id": 5542945, "raw_text": "Boris, do you have any hint as to why this might be failing? It sounds to me like this is related to the docshell, but I'm not very familiar with that area of the code. Thanks!", "tags": [], "is_private": false, "author": "jonathan.protzenko@gmail.com", "creator": "jonathan.protzenko@gmail.com", "count": 7, "bug_id": 638493, "time": "2011-06-20T17:14:40Z"}, {"is_private": false, "tags": [], "raw_text": "> Boris, do you have any hint as to why this might be failing?\n\nI'm missing a lot of context here, but window.close() on an nsGlobalWindow can be a no-op for the following reasons:\n\n1)  The window is already closed or is in the middle of being closed.\n2)  The window has a modal dialog parented to it\n3)  The window is a subframe (this includes any <iframe> or <browser> in chrome\n    that does not have a type equal to \"content\" or starting with \"content-\").\n4)  The window did not have an opener and the caller is not trusted for write.\n5)  An onbeforeunload event handler prevents the close.\n\nMy best guess based on the bug summary is that you're hitting item 3 above.  Is that the case?  If not, the next most likely one is probably item 5 if the caller is chrome....", "attachment_id": null, "id": 5547383, "text": "> Boris, do you have any hint as to why this might be failing?\n\nI'm missing a lot of context here, but window.close() on an nsGlobalWindow can be a no-op for the following reasons:\n\n1)  The window is already closed or is in the middle of being closed.\n2)  The window has a modal dialog parented to it\n3)  The window is a subframe (this includes any <iframe> or <browser> in chrome\n    that does not have a type equal to \"content\" or starting with \"content-\").\n4)  The window did not have an opener and the caller is not trusted for write.\n5)  An onbeforeunload event handler prevents the close.\n\nMy best guess based on the bug summary is that you're hitting item 3 above.  Is that the case?  If not, the next most likely one is probably item 5 if the caller is chrome....", "creation_time": "2011-06-22T04:09:06Z", "time": "2011-06-22T04:09:06Z", "bug_id": 638493, "count": 8, "creator": "bzbarsky@mit.edu", "author": "bzbarsky@mit.edu"}, {"creator": "jonathan.protzenko@gmail.com", "author": "jonathan.protzenko@gmail.com", "time": "2011-06-22T04:10:45Z", "bug_id": 638493, "count": 9, "text": "Thanks for your input. This is indeed a chrome <browser> inside the main (chrome) Thunderbird window. Any ideas how to properly solve the issue, or should we stick with the workaround I described in comment #6?", "id": 5547385, "attachment_id": null, "creation_time": "2011-06-22T04:10:45Z", "tags": [], "is_private": false, "raw_text": "Thanks for your input. This is indeed a chrome <browser> inside the main (chrome) Thunderbird window. Any ideas how to properly solve the issue, or should we stick with the workaround I described in comment #6?"}, {"creation_time": "2011-06-22T20:02:17Z", "text": "> Any ideas how to properly solve the issue\n\nThe cleanest way is probably to have a way in chrome to flag chrome sub-docshells as \"not actually a subframe\".", "creator": "bzbarsky@mit.edu", "id": 5549103, "attachment_id": null, "author": "bzbarsky@mit.edu", "bug_id": 638493, "raw_text": "> Any ideas how to properly solve the issue\n\nThe cleanest way is probably to have a way in chrome to flag chrome sub-docshells as \"not actually a subframe\".", "count": 10, "time": "2011-06-22T20:02:17Z", "tags": [], "is_private": false}, {"raw_text": "This seems to be out of my expertise area, so I'll stick with the workaround. I may look into it one day, though... thanks for the guidance Boris.", "tags": [], "is_private": false, "creation_time": "2011-06-23T18:45:35Z", "text": "This seems to be out of my expertise area, so I'll stick with the workaround. I may look into it one day, though... thanks for the guidance Boris.", "id": 5551770, "attachment_id": null, "bug_id": 638493, "count": 11, "time": "2011-06-23T18:45:35Z", "creator": "jonathan.protzenko@gmail.com", "author": "jonathan.protzenko@gmail.com"}, {"is_private": false, "tags": [], "time": "2011-06-23T18:48:02Z", "count": 12, "raw_text": "At least file a bug on making that happen?  Seems like it would matter to others too (esp. as we move to having real chrome tabs in tabbrowser).", "bug_id": 638493, "author": "bzbarsky@mit.edu", "id": 5551781, "attachment_id": null, "text": "At least file a bug on making that happen?  Seems like it would matter to others too (esp. as we move to having real chrome tabs in tabbrowser).", "creator": "bzbarsky@mit.edu", "creation_time": "2011-06-23T18:48:02Z"}, {"raw_text": "in fact, type=\"chrome-tab\" might be one way to expose the XUL interface to it....", "bug_id": 638493, "count": 13, "time": "2011-06-23T18:48:29Z", "is_private": false, "tags": [], "creation_time": "2011-06-23T18:48:29Z", "id": 5551784, "attachment_id": null, "creator": "bzbarsky@mit.edu", "text": "in fact, type=\"chrome-tab\" might be one way to expose the XUL interface to it....", "author": "bzbarsky@mit.edu"}, {"bug_id": 638493, "raw_text": "Was such a bug filed?\nIs this something other add-ons would be keen to utilize?\n\n(In reply to Jonathan Protzenko [:protz] from comment #11)\n> This seems to be out of my expertise area, so I'll stick with the\n> workaround. I may look into it one day, though... thanks for the guidance\n> Boris.\n\n(In reply to Boris Zbarsky [:bzbarsky, bz on IRC] from comment #12)\n> At least file a bug on making that happen?  Seems like it would matter to\n> others too (esp. as we move to having real chrome tabs in tabbrowser).", "count": 14, "time": "2019-08-11T09:37:26Z", "tags": [], "is_private": false, "creation_time": "2019-08-11T09:37:26Z", "text": "Was such a bug filed?\nIs this something other add-ons would be keen to utilize?\n\n(In reply to Jonathan Protzenko [:protz] from comment #11)\n> This seems to be out of my expertise area, so I'll stick with the\n> workaround. I may look into it one day, though... thanks for the guidance\n> Boris.\n\n(In reply to Boris Zbarsky [:bzbarsky, bz on IRC] from comment #12)\n> At least file a bug on making that happen?  Seems like it would matter to\n> others too (esp. as we move to having real chrome tabs in tabbrowser).", "creator": "vseerror@lehigh.edu", "id": 14292086, "attachment_id": null, "author": "vseerror@lehigh.edu"}, {"time": "2019-09-22T21:31:52Z", "tags": [], "is_private": false, "bug_id": 638493, "raw_text": "I have absolutely no recollection of this, sorry, but I don't think I filed a fresh bug.", "count": 15, "text": "I have absolutely no recollection of this, sorry, but I don't think I filed a fresh bug.", "creator": "jonathan.protzenko@gmail.com", "id": 14375885, "attachment_id": null, "author": "jonathan.protzenko@gmail.com", "creation_time": "2019-09-22T21:31:52Z"}]}}, "comments": {}}