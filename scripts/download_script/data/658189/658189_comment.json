{"bugs": {"658189": {"comments": [{"author": "dholbert@mozilla.com", "id": 5479332, "raw_text": "STEPS TO REPRODUCE:\n 1. Load attached testcase.\n\n 2. Click document to trigger 'squish' animation\n\n 3. Immediately (within a second), switch tabs or open new tab (Ctrl+PageUp/T)\n\n 4. Wait 2 seconds to be sure 'squish' animation duration is complete, and then switch back to the tab with the testcase.\n\n 4. If you don't get ACTUAL RESULTS yet, return to step 2.\n\nACTUAL RESULTS: When you return to the tab, some dominos are at intermediate states of the 'squish' animation.\n\nEXPECTED RESULTS: Dominos should all be returned to their normal size.\n\nMozilla/5.0 (X11; Linux i686; rv:6.0a1) Gecko/20110518 Firefox/6.0a1", "creation_time": "2011-05-19T06:49:32Z", "text": "Created attachment 533546\ntestcase 1\n\nSTEPS TO REPRODUCE:\n 1. Load attached testcase.\n\n 2. Click document to trigger 'squish' animation\n\n 3. Immediately (within a second), switch tabs or open new tab (Ctrl+PageUp/T)\n\n 4. Wait 2 seconds to be sure 'squish' animation duration is complete, and then switch back to the tab with the testcase.\n\n 4. If you don't get ACTUAL RESULTS yet, return to step 2.\n\nACTUAL RESULTS: When you return to the tab, some dominos are at intermediate states of the 'squish' animation.\n\nEXPECTED RESULTS: Dominos should all be returned to their normal size.\n\nMozilla/5.0 (X11; Linux i686; rv:6.0a1) Gecko/20110518 Firefox/6.0a1", "creator": "dholbert@mozilla.com", "count": 0, "tags": [], "bug_id": 658189, "attachment_id": 533546, "is_private": false, "time": "2011-05-19T06:49:32Z"}, {"text": "Hmm.  Do they then snap into position?  Or stay there?\n\nIf you disable the exponential backoff in background refresh drivers, does the problem go away?", "creation_time": "2011-05-19T06:51:02Z", "is_private": false, "raw_text": "Hmm.  Do they then snap into position?  Or stay there?\n\nIf you disable the exponential backoff in background refresh drivers, does the problem go away?", "id": 5479335, "bug_id": 658189, "time": "2011-05-19T06:51:02Z", "count": 1, "tags": [], "creator": "bzbarsky@mit.edu", "author": "bzbarsky@mit.edu", "attachment_id": null}, {"attachment_id": null, "time": "2011-05-19T06:51:28Z", "is_private": false, "author": "dholbert@mozilla.com", "tags": [], "creator": "dholbert@mozilla.com", "count": 2, "bug_id": 658189, "creation_time": "2011-05-19T06:51:28Z", "text": "Note: this testcase resists attempts at reducing. :) While it's not minimal, the current testcase is much simpler than the original demo, after some work by Marek & myself.", "id": 5479336, "raw_text": "Note: this testcase resists attempts at reducing. :) While it's not minimal, the current testcase is much simpler than the original demo, after some work by Marek & myself."}, {"author": "dholbert@mozilla.com", "attachment_id": null, "bug_id": 658189, "time": "2011-05-19T06:54:03Z", "count": 3, "creator": "dholbert@mozilla.com", "tags": [], "raw_text": "(In reply to comment #1)\n> Hmm.  Do they then snap into position?  Or stay there?\n\nThey stay there.\n\n> If you disable the exponential backoff in background refresh drivers, does the\n> problem go away?\n\nI'll give that a try, but maybe this answers that question:\n\nUsing a much less reduced testcase, I got the following regression range earlier today:\nhttp://hg.mozilla.org/mozilla-central/pushloghtml?fromchange=75cc425bbaf0&tochange=e1d55bbd1d1d\n.. in which bug 586201 (\"Throttle refresh drivers in background tabs\") looks like the most likely candidate.", "id": 5479343, "text": "(In reply to comment #1)\n> Hmm.  Do they then snap into position?  Or stay there?\n\nThey stay there.\n\n> If you disable the exponential backoff in background refresh drivers, does the\n> problem go away?\n\nI'll give that a try, but maybe this answers that question:\n\nUsing a much less reduced testcase, I got the following regression range earlier today:\nhttp://hg.mozilla.org/mozilla-central/pushloghtml?fromchange=75cc425bbaf0&tochange=e1d55bbd1d1d\n.. in which bug 586201 (\"Throttle refresh drivers in background tabs\") looks like the most likely candidate.", "is_private": false, "creation_time": "2011-05-19T06:54:03Z"}, {"bug_id": 658189, "tags": [], "count": 4, "creator": "dholbert@mozilla.com", "raw_text": "", "id": 5479345, "text": "Created attachment 533548\nscreenshot of bug", "creation_time": "2011-05-19T06:55:58Z", "author": "dholbert@mozilla.com", "time": "2011-05-19T06:55:58Z", "is_private": false, "attachment_id": 533548}, {"author": "bzbarsky@mit.edu", "text": "Hmm.  That was the fixed-duration throttling, before we switched to exponential backoff.\n\nIn that case, you should see the problem in Firefox 4.  If so, what values of \"layout.throttled_frame_rate\" show the problem?  I assume 60 does not but 1 does?\n\nWould SMIL have problems with the refresh timer firing \"too late\" for some reason?", "creation_time": "2011-05-19T06:59:05Z", "raw_text": "Hmm.  That was the fixed-duration throttling, before we switched to exponential backoff.\n\nIn that case, you should see the problem in Firefox 4.  If so, what values of \"layout.throttled_frame_rate\" show the problem?  I assume 60 does not but 1 does?\n\nWould SMIL have problems with the refresh timer firing \"too late\" for some reason?", "id": 5479352, "bug_id": 658189, "creator": "bzbarsky@mit.edu", "count": 5, "tags": [], "attachment_id": null, "is_private": false, "time": "2011-05-19T06:59:05Z"}, {"author": "bzbarsky@mit.edu", "attachment_id": null, "bug_id": 658189, "count": 6, "creator": "bzbarsky@mit.edu", "time": "2011-05-19T06:59:28Z", "tags": [], "text": "To be clear, that's a pref.  And it's live, so should be easy to test.", "creation_time": "2011-05-19T06:59:28Z", "is_private": false, "raw_text": "To be clear, that's a pref.  And it's live, so should be easy to test.", "id": 5479354}, {"author": "bzbarsky@mit.edu", "text": "fwiw, I would assume we're hitting the SMIL sleep detection here, right?  Does that matter?", "creation_time": "2011-05-19T07:02:53Z", "raw_text": "fwiw, I would assume we're hitting the SMIL sleep detection here, right?  Does that matter?", "id": 5479360, "bug_id": 658189, "count": 7, "tags": [], "creator": "bzbarsky@mit.edu", "attachment_id": null, "is_private": false, "time": "2011-05-19T07:02:53Z"}, {"time": "2011-05-19T07:40:42Z", "is_private": false, "attachment_id": null, "creator": "dholbert@mozilla.com", "tags": [], "count": 8, "bug_id": 658189, "creation_time": "2011-05-19T07:40:42Z", "text": "(In reply to comment #5)\n> In that case, you should see the problem in Firefox 4.  If so, what values\n> of \"layout.throttled_frame_rate\" show the problem?  I assume 60 does not but\n> 1 does?\n\nCorrect. (in Firefox 4 -- not in nightlies, because as bz tells me on IRC, the pref means something completely different in nighlties.)\n\n> Would SMIL have problems with the refresh timer firing \"too late\" for some\n> reason?\n\nBy |firing \"too late\"|, do you mean \"longer-than-normal time between samples\", or \"refresh driver lied about how much time had elapsed\"?\n\nIt seems feasible that these could cause problems, but I'm not sure how, at the moment.\n\n(In reply to comment #7)\n> fwiw, I would assume we're hitting the SMIL sleep detection here, right?\n\nI don't think we are, actually.  I don't see any instances of this warning being spammed, at least:\n>  // Unexpectedly long delay between samples:\n>  } else if (elapsedTime > SAMPLE_DEV_THRESHOLD * mAvgTimeBetweenSamples) {\n>    NS_WARNING(\"Detected really long delay between samples, continuing from \"\n>               \"previous sample\");\n>    mParentOffset += elapsedTime - mAvgTimeBetweenSamples;\n\n...and I tried raising SAMPLE_DEV_THRESHOLD by 100x, too, and it didn't affect anything.\n\nNote also that this sleep detection code was added in Nov 2010 (with Bug 606932), 3 months after the regression pushlog from comment 3.", "id": 5479423, "raw_text": "(In reply to comment #5)\n> In that case, you should see the problem in Firefox 4.  If so, what values\n> of \"layout.throttled_frame_rate\" show the problem?  I assume 60 does not but\n> 1 does?\n\nCorrect. (in Firefox 4 -- not in nightlies, because as bz tells me on IRC, the pref means something completely different in nighlties.)\n\n> Would SMIL have problems with the refresh timer firing \"too late\" for some\n> reason?\n\nBy |firing \"too late\"|, do you mean \"longer-than-normal time between samples\", or \"refresh driver lied about how much time had elapsed\"?\n\nIt seems feasible that these could cause problems, but I'm not sure how, at the moment.\n\n(In reply to comment #7)\n> fwiw, I would assume we're hitting the SMIL sleep detection here, right?\n\nI don't think we are, actually.  I don't see any instances of this warning being spammed, at least:\n>  // Unexpectedly long delay between samples:\n>  } else if (elapsedTime > SAMPLE_DEV_THRESHOLD * mAvgTimeBetweenSamples) {\n>    NS_WARNING(\"Detected really long delay between samples, continuing from \"\n>               \"previous sample\");\n>    mParentOffset += elapsedTime - mAvgTimeBetweenSamples;\n\n...and I tried raising SAMPLE_DEV_THRESHOLD by 100x, too, and it didn't affect anything.\n\nNote also that this sleep detection code was added in Nov 2010 (with Bug 606932), 3 months after the regression pushlog from comment 3.", "author": "dholbert@mozilla.com"}, {"attachment_id": null, "is_private": false, "time": "2011-05-19T08:13:25Z", "author": "dholbert@mozilla.com", "creation_time": "2011-05-19T08:13:25Z", "text": "Alternate STEPS TO REPRODUCE:\n 1. Set about:config pref layout.frame_rate = 1 (or 2 or 3, if you like)\n 2. Load testcase.\n 3. Click document.  Watch to see if dominos return to their original state.\n\nACTUAL RESULTS: Most of the time, the dominos don't make it all the way back to their original state.", "id": 5479465, "raw_text": "Alternate STEPS TO REPRODUCE:\n 1. Set about:config pref layout.frame_rate = 1 (or 2 or 3, if you like)\n 2. Load testcase.\n 3. Click document.  Watch to see if dominos return to their original state.\n\nACTUAL RESULTS: Most of the time, the dominos don't make it all the way back to their original state.", "creator": "dholbert@mozilla.com", "count": 9, "tags": [], "bug_id": 658189}, {"bug_id": 658189, "count": 10, "tags": [], "creator": "bzbarsky@mit.edu", "time": "2011-05-19T13:00:17Z", "raw_text": "> By |firing \"too late\"|, do you mean \"longer-than-normal time between samples\", > or \"refresh driver lied about how much time had elapsed\"?\n\nThe former.\n\n> Note also that this sleep detection code was added in Nov 2010 \n\nOK, then.  It's not the problem.\n\nCertainly given comment 9 it's not the problem.  Comment 9 just sounds like SMIL can't deal with very rare refresh driver notifications for some reason...", "id": 5479780, "text": "> By |firing \"too late\"|, do you mean \"longer-than-normal time between samples\", > or \"refresh driver lied about how much time had elapsed\"?\n\nThe former.\n\n> Note also that this sleep detection code was added in Nov 2010 \n\nOK, then.  It's not the problem.\n\nCertainly given comment 9 it's not the problem.  Comment 9 just sounds like SMIL can't deal with very rare refresh driver notifications for some reason...", "creation_time": "2011-05-19T13:00:17Z", "is_private": false, "author": "bzbarsky@mit.edu", "attachment_id": null}, {"author": "dholbert@mozilla.com", "text": "Yeah, agreed -- I think Comment 9 is the real bug here, and the regression range in Comment 3 just introduced a new way to hit it.", "creation_time": "2011-05-19T15:42:23Z", "raw_text": "Yeah, agreed -- I think Comment 9 is the real bug here, and the regression range in Comment 3 just introduced a new way to hit it.", "id": 5480164, "bug_id": 658189, "tags": [], "creator": "dholbert@mozilla.com", "count": 11, "attachment_id": null, "is_private": false, "time": "2011-05-19T15:42:23Z"}, {"is_private": false, "time": "2011-05-19T17:22:46Z", "attachment_id": null, "creation_time": "2011-05-19T17:22:46Z", "text": "Confirmed against Mozilla/5.0 (Windows NT 5.1; rv:6.0a1) Gecko/20110519 Firefox/6.0a1 ID:20110519030627", "id": 5480502, "raw_text": "Confirmed against Mozilla/5.0 (Windows NT 5.1; rv:6.0a1) Gecko/20110519 Firefox/6.0a1 ID:20110519030627", "tags": [], "count": 12, "creator": "xtc4uall@gmail.com", "bug_id": 658189, "author": "xtc4uall@gmail.com"}, {"creator": "dholbert@mozilla.com", "count": 13, "tags": [], "bug_id": 658189, "id": 5480810, "raw_text": "So from doing a targeted old build with a low-framerate code tweak...\n> content/smil/nsSMILAnimationController.cpp\n> -const PRUint32 nsSMILAnimationController::kTimerInterval = 22;\n> +const PRUint32 nsSMILAnimationController::kTimerInterval = 1000;\n...I hit this bug after bug 533291's csets landed (revision 9cdfc9ee6754) but not before (revision 5dd3f323fa37).", "creation_time": "2011-05-19T18:59:35Z", "text": "So from doing a targeted old build with a low-framerate code tweak...\n> content/smil/nsSMILAnimationController.cpp\n> -const PRUint32 nsSMILAnimationController::kTimerInterval = 22;\n> +const PRUint32 nsSMILAnimationController::kTimerInterval = 1000;\n...I hit this bug after bug 533291's csets landed (revision 9cdfc9ee6754) but not before (revision 5dd3f323fa37).", "author": "dholbert@mozilla.com", "time": "2011-05-19T18:59:35Z", "is_private": false, "attachment_id": null}, {"is_private": false, "creation_time": "2012-03-02T07:43:28Z", "text": "(In reply to Boris Zbarsky (:bz) from comment #10)\n> Certainly given comment 9 it's not the problem.  Comment 9 just sounds like\n> SMIL can't deal with very rare refresh driver notifications for some\n> reason...\n\nSMIL (and our implementation of it) should be totally independent of sample rate. If it's not, it's a bug.\n\nMy suspicion is we're ignoring the sample or filtering it out for some reason.", "id": 6108642, "raw_text": "(In reply to Boris Zbarsky (:bz) from comment #10)\n> Certainly given comment 9 it's not the problem.  Comment 9 just sounds like\n> SMIL can't deal with very rare refresh driver notifications for some\n> reason...\n\nSMIL (and our implementation of it) should be totally independent of sample rate. If it's not, it's a bug.\n\nMy suspicion is we're ignoring the sample or filtering it out for some reason.", "tags": [], "creator": "brian@birchill.co.jp", "count": 14, "time": "2012-03-02T07:43:28Z", "bug_id": 658189, "attachment_id": null, "author": "brian@birchill.co.jp"}, {"creation_time": "2012-03-02T08:30:52Z", "text": "> My suspicion is we're ignoring the sample or filtering it out for some reason.\n\nPer comment 13, bug 533291 appears to have regressed this -- so it looks like we're incorrectly thinking that our animations haven't changed when actually they have.", "id": 6108693, "raw_text": "> My suspicion is we're ignoring the sample or filtering it out for some reason.\n\nPer comment 13, bug 533291 appears to have regressed this -- so it looks like we're incorrectly thinking that our animations haven't changed when actually they have.", "count": 15, "tags": [], "creator": "dholbert@mozilla.com", "bug_id": 658189, "author": "dholbert@mozilla.com", "is_private": false, "time": "2012-03-02T08:30:52Z", "attachment_id": null}, {"author": "dholbert@mozilla.com", "raw_text": "To clarify: I think the issue is something to do with the switch from active to inactive -- we (incorrectly) think that nothing's changed on that first inactive sample, & we don't bother recompositing.\n\nThe low frame rate only matters insomuch as it makes that mistake more obvious, because it means that our final composited frame is from somewhere in the middle of the simple duration rather than somewhere very close to the end.", "id": 6108748, "text": "To clarify: I think the issue is something to do with the switch from active to inactive -- we (incorrectly) think that nothing's changed on that first inactive sample, & we don't bother recompositing.\n\nThe low frame rate only matters insomuch as it makes that mistake more obvious, because it means that our final composited frame is from somewhere in the middle of the simple duration rather than somewhere very close to the end.", "creation_time": "2012-03-02T09:10:00Z", "bug_id": 658189, "count": 16, "tags": [], "creator": "dholbert@mozilla.com", "attachment_id": null, "is_private": false, "time": "2012-03-02T09:10:00Z"}, {"attachment_id": null, "time": "2012-03-11T10:46:53Z", "is_private": false, "author": "longsonr@gmail.com", "bug_id": 658189, "count": 17, "creator": "longsonr@gmail.com", "tags": [], "raw_text": "", "id": 6130849, "text": "*** Bug 733744 has been marked as a duplicate of this bug. ***", "creation_time": "2012-03-11T10:46:53Z"}]}}, "comments": {}}