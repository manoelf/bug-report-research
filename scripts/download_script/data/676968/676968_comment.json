{"bugs": {"676968": {"comments": [{"time": "2011-08-05T22:21:26Z", "raw_text": "With patches for bug 668349 and 668351, xpcshell tests can be run on an Android device, and the majority of tests pass. \n\nHowever, modules/libpr0n/test/unit/test_imgtools.js fails consistently when run on Android.", "attachment_id": null, "tags": [], "creator": "gbrown@mozilla.com", "text": "With patches for bug 668349 and 668351, xpcshell tests can be run on an Android device, and the majority of tests pass. \n\nHowever, modules/libpr0n/test/unit/test_imgtools.js fails consistently when run on Android.", "count": 0, "author": "gbrown@mozilla.com", "bug_id": 676968, "id": 5636909, "creation_time": "2011-08-05T22:21:26Z", "is_private": false}, {"creator": "josh@joshmatthews.net", "is_private": false, "creation_time": "2011-08-06T04:52:23Z", "attachment_id": null, "tags": [], "author": "josh@joshmatthews.net", "count": 1, "text": "A log of the failures would be helpful in all of the xpcshell bugs.", "id": 5637343, "bug_id": 676968, "raw_text": "A log of the failures would be helpful in all of the xpcshell bugs.", "time": "2011-08-06T04:52:23Z"}, {"time": "2011-08-09T20:46:11Z", "raw_text": "geoff@geoff-MacBookPro:~/src/mozilla-central/objdir-droid$ make SOLO_FILE=test_imgtools.js -C modules/libpr0n/test check-one-remote\nmake: Entering directory `/home/geoff/src/mozilla-central/objdir-droid/modules/libpr0n/test'\n/usr/bin/python2.6 -u ../../../../config/pythonpath.py \\\n\t  -I../../../../build \\\n\t  -I../../../../build/mobile \\\n\t  ../../../../testing/xpcshell/remotexpcshelltests.py \\\n\t  --symbols-path=../../../dist/crashreporter-symbols \\\n\t  --build-info-json=../../../mozinfo.json \\\n\t  --test-path=test_imgtools.js \\\n\t  --profile-name=fennec \\\n\t  --verbose \\\n\t   \\\n\t  --dm_trans=adb \\\n\t  --deviceIP= \\\n\t  --objdir=../../.. \\\n\t  --apk=../../../dist/fennec-8.0a1.en-US.eabi-arm.apk \\\n          --noSetup \\\n\t  ../../../_tests/xpcshell/modules/libpr0n/test/unit\npackage set: org.mozilla.fennec_unofficial\nchmod /data/local/tests/xpcshell/p\nTEST-INFO | profile dir is /data/local/tests/xpcshell/p\nTEST-INFO | /home/geoff/src/mozilla-central/objdir-droid/_tests/xpcshell/modules/libpr0n/test/unit/test_imgtools.js | running test ...\ncd /data/local/tests/xpcshell/modules/libpr0n/test/unit; LD_LIBRARY_PATH=/data/local/tests/xpcshell/b; export CACHE_PATH=/data/local/tests/xpcshell/b; export GRE_HOME=/data/data/org.mozilla.fennec_unofficial; export XPCSHELL_TEST_PROFILE_DIR=/data/local/tests/xpcshell/p; /data/local/tests/xpcshell/b/xpcshell -r /data/local/tests/xpcshell/c/httpd.manifest --greomni /data/local/tests/xpcshell/b/fennec-8.0a1.en-US.eabi-arm.apk -j -s -e 'const _HTTPD_JS_PATH = \"/data/local/tests/xpcshell/c/httpd.js\";' -e 'const _HEAD_JS_PATH = \"/data/local/tests/xpcshell/head.js\";' -f /data/local/tests/xpcshell/head.js -e 'const _SERVER_ADDR = \"localhost\"' -e 'const _HEAD_FILES = [];' -e 'const _TAIL_FILES = [];' -e 'const _TEST_FILE = [\"test_imgtools.js\"];' -e '_execute_test(); quit(0);'\nTEST-KNOWN-FAIL | /home/geoff/src/mozilla-central/objdir-droid/_tests/xpcshell/modules/libpr0n/test/unit/test_imgtools.js | test passed\n>>>>>>>\nWARNING: XPCOM objects created/destroyed from static ctor/dtor: file /home/geoff/src/mozilla-central/xpcom/base/nsTraceRefcntImpl.cpp, line 172\nWARNING: No default pref files found.: file /home/geoff/src/mozilla-central/modules/libpref/src/Preferences.cpp, line 923\nWARNING: GetIsLinkUp is not supported without a bridge connection: file /home/geoff/src/mozilla-central/netwerk/system/android/nsAndroidNetworkLinkService.cpp, line 61\n\nTEST-INFO | (xpcshell/head.js) | test 1 pending\n\nTEST-PASS | test_imgtools.js | [run_test : 150] 10698 == 10698\n\nTEST-PASS | test_imgtools.js | [run_test : 158] 64 == 64\n\nTEST-PASS | test_imgtools.js | [run_test : 159] 64 == 64\n\nTEST-PASS | test_imgtools.js | [run_test : 174] 1081 == 1081\n\nTEST-UNEXPECTED-FAIL | test_imgtools.js | 1079 == 1081 - See following stack:\nJS frame :: /data/local/tests/xpcshell/head.js :: do_throw :: line 445\nJS frame :: /data/local/tests/xpcshell/head.js :: _do_check_eq :: line 539\nJS frame :: /data/local/tests/xpcshell/head.js :: do_check_eq :: line 560\nJS frame :: test_imgtools.js :: compareArrays :: line 86\nJS frame :: test_imgtools.js :: run_test :: line 178\nJS frame :: /data/local/tests/xpcshell/head.js :: _execute_test :: line 326\nJS frame :: -e :: <TOP_LEVEL> :: line 1\n\nTEST-INFO | (xpcshell/head.js) | exiting test\n\nTEST-UNEXPECTED-FAIL | (xpcshell/head.js) | FAILED in test #2 -- test encoding a scaled JPEG: 2147500036\nWARNING: nsExceptionService ignoring thread destruction after shutdown: file /home/geoff/src/mozilla-central/xpcom/base/nsExceptionService.cpp, line 197\nAssertion failed at /home/geoff/src/mozilla-central/gfx/cairo/cairo/src/cairo-ft-font.c:443: unscaled->face == NULL\nAssertion failed at /home/geoff/src/mozilla-central/gfx/cairo/cairo/src/cairo-ft-font.c:443: unscaled->face == NULL\nAssertion failed at /home/geoff/src/mozilla-central/gfx/cairo/cairo/src/cairo-ft-font.c:443: unscaled->face == NULL\nAssertion failed at /home/geoff/src/mozilla-central/gfx/cairo/cairo/src/cairo-ft-font.c:443: unscaled->face == NULL\nAssertion failed at /home/geoff/src/mozilla-central/gfx/cairo/cairo/src/cairo-ft-font.c:443: unscaled->face == NULL\nAssertion failed at /home/geoff/src/mozilla-central/gfx/cairo/cairo/src/cairo-ft-font.c:443: unscaled->face == NULL\nAssertion failed at /home/geoff/src/mozilla-central/gfx/cairo/cairo/src/cairo-ft-font.c:443: unscaled->face == NULL\nAssertion failed at /home/geoff/src/mozilla-central/gfx/cairo/cairo/src/cairo-ft-font.c:443: unscaled->face == NULL\nAssertion failed at /home/geoff/src/mozilla-central/gfx/cairo/cairo/src/cairo-ft-font.c:443: unscaled->face == NULL\nAssertion failed at /home/geoff/src/mozilla-central/gfx/cairo/cairo/src/cairo-ft-font.c:443: unscaled->face == NULL\nAssertion failed at /home/geoff/src/mozilla-central/gfx/cairo/cairo/src/cairo-ft-font.c:443: unscaled->face == NULL\nAssertion failed at /home/geoff/src/mozilla-central/gfx/cairo/cairo/src/cairo-ft-font.c:443: unscaled->face == NULL\nAssertion failed at /home/geoff/src/mozilla-central/gfx/cairo/cairo/src/cairo-ft-font.c:443: unscaled->face == NULL\nWARNING: OOPDeinit() without successful OOPInit(): file /home/geoff/src/mozilla-central/toolkit/crashreporter/nsExceptionHandler.cpp, line 1830\nnsStringStats\n => mAllocCount:           1668\n => mReallocCount:           94\n => mFreeCount:            1578  --  LEAKED 90 !!!\n => mShareCount:           7294\n => mAdoptCount:             57\n => mAdoptFreeCount:         57\nWARNING: XPCOM objects created/destroyed from static ctor/dtor: file /home/geoff/src/mozilla-central/xpcom/base/nsTraceRefcntImpl.cpp, line 172\n<<<<<<<\nINFO | Result summary:\nINFO | Passed: 0\nINFO | Failed: 0\nINFO | Todo: 1\nmake: Leaving directory `/home/geoff/src/mozilla-central/objdir-droid/modules/libpr0n/test'\ngeoff@geoff-MacBookPro:~/src/mozilla-central/objdir-droid$", "count": 2, "text": "geoff@geoff-MacBookPro:~/src/mozilla-central/objdir-droid$ make SOLO_FILE=test_imgtools.js -C modules/libpr0n/test check-one-remote\nmake: Entering directory `/home/geoff/src/mozilla-central/objdir-droid/modules/libpr0n/test'\n/usr/bin/python2.6 -u ../../../../config/pythonpath.py \\\n\t  -I../../../../build \\\n\t  -I../../../../build/mobile \\\n\t  ../../../../testing/xpcshell/remotexpcshelltests.py \\\n\t  --symbols-path=../../../dist/crashreporter-symbols \\\n\t  --build-info-json=../../../mozinfo.json \\\n\t  --test-path=test_imgtools.js \\\n\t  --profile-name=fennec \\\n\t  --verbose \\\n\t   \\\n\t  --dm_trans=adb \\\n\t  --deviceIP= \\\n\t  --objdir=../../.. \\\n\t  --apk=../../../dist/fennec-8.0a1.en-US.eabi-arm.apk \\\n          --noSetup \\\n\t  ../../../_tests/xpcshell/modules/libpr0n/test/unit\npackage set: org.mozilla.fennec_unofficial\nchmod /data/local/tests/xpcshell/p\nTEST-INFO | profile dir is /data/local/tests/xpcshell/p\nTEST-INFO | /home/geoff/src/mozilla-central/objdir-droid/_tests/xpcshell/modules/libpr0n/test/unit/test_imgtools.js | running test ...\ncd /data/local/tests/xpcshell/modules/libpr0n/test/unit; LD_LIBRARY_PATH=/data/local/tests/xpcshell/b; export CACHE_PATH=/data/local/tests/xpcshell/b; export GRE_HOME=/data/data/org.mozilla.fennec_unofficial; export XPCSHELL_TEST_PROFILE_DIR=/data/local/tests/xpcshell/p; /data/local/tests/xpcshell/b/xpcshell -r /data/local/tests/xpcshell/c/httpd.manifest --greomni /data/local/tests/xpcshell/b/fennec-8.0a1.en-US.eabi-arm.apk -j -s -e 'const _HTTPD_JS_PATH = \"/data/local/tests/xpcshell/c/httpd.js\";' -e 'const _HEAD_JS_PATH = \"/data/local/tests/xpcshell/head.js\";' -f /data/local/tests/xpcshell/head.js -e 'const _SERVER_ADDR = \"localhost\"' -e 'const _HEAD_FILES = [];' -e 'const _TAIL_FILES = [];' -e 'const _TEST_FILE = [\"test_imgtools.js\"];' -e '_execute_test(); quit(0);'\nTEST-KNOWN-FAIL | /home/geoff/src/mozilla-central/objdir-droid/_tests/xpcshell/modules/libpr0n/test/unit/test_imgtools.js | test passed\n>>>>>>>\nWARNING: XPCOM objects created/destroyed from static ctor/dtor: file /home/geoff/src/mozilla-central/xpcom/base/nsTraceRefcntImpl.cpp, line 172\nWARNING: No default pref files found.: file /home/geoff/src/mozilla-central/modules/libpref/src/Preferences.cpp, line 923\nWARNING: GetIsLinkUp is not supported without a bridge connection: file /home/geoff/src/mozilla-central/netwerk/system/android/nsAndroidNetworkLinkService.cpp, line 61\n\nTEST-INFO | (xpcshell/head.js) | test 1 pending\n\nTEST-PASS | test_imgtools.js | [run_test : 150] 10698 == 10698\n\nTEST-PASS | test_imgtools.js | [run_test : 158] 64 == 64\n\nTEST-PASS | test_imgtools.js | [run_test : 159] 64 == 64\n\nTEST-PASS | test_imgtools.js | [run_test : 174] 1081 == 1081\n\nTEST-UNEXPECTED-FAIL | test_imgtools.js | 1079 == 1081 - See following stack:\nJS frame :: /data/local/tests/xpcshell/head.js :: do_throw :: line 445\nJS frame :: /data/local/tests/xpcshell/head.js :: _do_check_eq :: line 539\nJS frame :: /data/local/tests/xpcshell/head.js :: do_check_eq :: line 560\nJS frame :: test_imgtools.js :: compareArrays :: line 86\nJS frame :: test_imgtools.js :: run_test :: line 178\nJS frame :: /data/local/tests/xpcshell/head.js :: _execute_test :: line 326\nJS frame :: -e :: <TOP_LEVEL> :: line 1\n\nTEST-INFO | (xpcshell/head.js) | exiting test\n\nTEST-UNEXPECTED-FAIL | (xpcshell/head.js) | FAILED in test #2 -- test encoding a scaled JPEG: 2147500036\nWARNING: nsExceptionService ignoring thread destruction after shutdown: file /home/geoff/src/mozilla-central/xpcom/base/nsExceptionService.cpp, line 197\nAssertion failed at /home/geoff/src/mozilla-central/gfx/cairo/cairo/src/cairo-ft-font.c:443: unscaled->face == NULL\nAssertion failed at /home/geoff/src/mozilla-central/gfx/cairo/cairo/src/cairo-ft-font.c:443: unscaled->face == NULL\nAssertion failed at /home/geoff/src/mozilla-central/gfx/cairo/cairo/src/cairo-ft-font.c:443: unscaled->face == NULL\nAssertion failed at /home/geoff/src/mozilla-central/gfx/cairo/cairo/src/cairo-ft-font.c:443: unscaled->face == NULL\nAssertion failed at /home/geoff/src/mozilla-central/gfx/cairo/cairo/src/cairo-ft-font.c:443: unscaled->face == NULL\nAssertion failed at /home/geoff/src/mozilla-central/gfx/cairo/cairo/src/cairo-ft-font.c:443: unscaled->face == NULL\nAssertion failed at /home/geoff/src/mozilla-central/gfx/cairo/cairo/src/cairo-ft-font.c:443: unscaled->face == NULL\nAssertion failed at /home/geoff/src/mozilla-central/gfx/cairo/cairo/src/cairo-ft-font.c:443: unscaled->face == NULL\nAssertion failed at /home/geoff/src/mozilla-central/gfx/cairo/cairo/src/cairo-ft-font.c:443: unscaled->face == NULL\nAssertion failed at /home/geoff/src/mozilla-central/gfx/cairo/cairo/src/cairo-ft-font.c:443: unscaled->face == NULL\nAssertion failed at /home/geoff/src/mozilla-central/gfx/cairo/cairo/src/cairo-ft-font.c:443: unscaled->face == NULL\nAssertion failed at /home/geoff/src/mozilla-central/gfx/cairo/cairo/src/cairo-ft-font.c:443: unscaled->face == NULL\nAssertion failed at /home/geoff/src/mozilla-central/gfx/cairo/cairo/src/cairo-ft-font.c:443: unscaled->face == NULL\nWARNING: OOPDeinit() without successful OOPInit(): file /home/geoff/src/mozilla-central/toolkit/crashreporter/nsExceptionHandler.cpp, line 1830\nnsStringStats\n => mAllocCount:           1668\n => mReallocCount:           94\n => mFreeCount:            1578  --  LEAKED 90 !!!\n => mShareCount:           7294\n => mAdoptCount:             57\n => mAdoptFreeCount:         57\nWARNING: XPCOM objects created/destroyed from static ctor/dtor: file /home/geoff/src/mozilla-central/xpcom/base/nsTraceRefcntImpl.cpp, line 172\n<<<<<<<\nINFO | Result summary:\nINFO | Passed: 0\nINFO | Failed: 0\nINFO | Todo: 1\nmake: Leaving directory `/home/geoff/src/mozilla-central/objdir-droid/modules/libpr0n/test'\ngeoff@geoff-MacBookPro:~/src/mozilla-central/objdir-droid$", "author": "gbrown@mozilla.com", "id": 5643291, "bug_id": 676968, "attachment_id": null, "tags": [], "creator": "gbrown@mozilla.com", "creation_time": "2011-08-09T20:46:11Z", "is_private": false}, {"tags": [], "attachment_id": null, "is_private": false, "creation_time": "2012-04-27T21:49:18Z", "creator": "gbrown@mozilla.com", "raw_text": "It seems modules/libpr0n no longer exists!", "time": "2012-04-27T21:49:18Z", "id": 6261703, "bug_id": 676968, "text": "It seems modules/libpr0n no longer exists!", "count": 3, "author": "gbrown@mozilla.com"}, {"creator": "gbrown@mozilla.com", "author": "gbrown@mozilla.com", "count": 4, "text": "Sorry - I see the test now in image/test...and it still fails.", "bug_id": 676968, "id": 6261720, "is_private": false, "creation_time": "2012-04-27T21:56:32Z", "time": "2012-04-27T21:56:32Z", "attachment_id": null, "raw_text": "Sorry - I see the test now in image/test...and it still fails.", "tags": []}, {"raw_text": "When I test this on my Nexus 5 the first failure is on test #5. This test takes 'container', which is image2.jpg decoded to an imgIContainer, then it encodes this imgIContainer to a PNG and compares it to image2jpg16x16.png. The thing is that the imgIContainer has the format SurfaceFormat::R5G6B5. Almost certainly what's happening here is that the use of SurfaceFormat::R5G6B5 results in a loss of precision which causing this failure.\n\nThe imgIContainer has format SurfaceFormat::R5G6B5 because when image2.jpg is decoded, RasterImage::DecodingComplete() calls RasterImage::Optimize() which has an |ifdef ANDROID| section that optimizes to SurfaceFormat::R5G6B5.\n\nCC'ing :mwu since he added the |ifdef ANDROID| section in bug 980035, and :seth because he reviewed that change.", "time": "2014-06-25T22:47:44Z", "count": 5, "text": "When I test this on my Nexus 5 the first failure is on test #5. This test takes 'container', which is image2.jpg decoded to an imgIContainer, then it encodes this imgIContainer to a PNG and compares it to image2jpg16x16.png. The thing is that the imgIContainer has the format SurfaceFormat::R5G6B5. Almost certainly what's happening here is that the use of SurfaceFormat::R5G6B5 results in a loss of precision which causing this failure.\n\nThe imgIContainer has format SurfaceFormat::R5G6B5 because when image2.jpg is decoded, RasterImage::DecodingComplete() calls RasterImage::Optimize() which has an |ifdef ANDROID| section that optimizes to SurfaceFormat::R5G6B5.\n\nCC'ing :mwu since he added the |ifdef ANDROID| section in bug 980035, and :seth because he reviewed that change.", "author": "jwatt@jwatt.org", "id": 8978593, "bug_id": 676968, "attachment_id": null, "tags": [], "creator": "jwatt@jwatt.org", "creation_time": "2014-06-25T22:47:44Z", "is_private": false}, {"time": "2014-06-25T22:57:56Z", "raw_text": "The 16 bit optimization was there long before bug 980035 though - it just took a more roundabout path.\n\nNot all devices optimize to 16 bits though. What device are we running the tests on? ICS and newer devices are likely to use 32bit formats, so the test should pass there.", "count": 6, "text": "The 16 bit optimization was there long before bug 980035 though - it just took a more roundabout path.\n\nNot all devices optimize to 16 bits though. What device are we running the tests on? ICS and newer devices are likely to use 32bit formats, so the test should pass there.", "author": "mwu.code@gmail.com", "bug_id": 676968, "id": 8978647, "attachment_id": null, "tags": [], "creator": "mwu.code@gmail.com", "is_private": false, "creation_time": "2014-06-25T22:57:56Z"}, {"author": "gbrown@mozilla.com", "count": 7, "text": "(In reply to Michael Wu [:mwu] from comment #6)\n> What device are we running the\n> tests on? ICS and newer devices are likely to use 32bit formats, so the test\n> should pass there.\n\nWhen I first reported this, I probably tested on Android 2.2.\n\ntbpl runs xpcshell tests on Android 2.3, Android 4.0, and Android 4.2 (x86), and Android 2.2 for just a little longer.", "creator": "gbrown@mozilla.com", "is_private": false, "creation_time": "2014-06-25T23:06:55Z", "id": 8978691, "bug_id": 676968, "attachment_id": null, "raw_text": "(In reply to Michael Wu [:mwu] from comment #6)\n> What device are we running the\n> tests on? ICS and newer devices are likely to use 32bit formats, so the test\n> should pass there.\n\nWhen I first reported this, I probably tested on Android 2.2.\n\ntbpl runs xpcshell tests on Android 2.3, Android 4.0, and Android 4.2 (x86), and Android 2.2 for just a little longer.", "time": "2014-06-25T23:06:55Z", "tags": []}, {"creation_time": "2014-06-26T01:33:30Z", "is_private": false, "creator": "mwu.code@gmail.com", "tags": [], "attachment_id": null, "id": 8979304, "bug_id": 676968, "author": "mwu.code@gmail.com", "text": "Jonathan was testing on a Nexus 5, which really shouldn't be using the 16bit optimization path. I'm not sure why Optimal2DFormatForContent(gfxContentType::COLOR) is returning SurfaceFormat::R5G6B5 there - that's clearly a bug.\n\nBrian, looks like you touched the depth detection code last. Any ideas?", "count": 8, "raw_text": "Jonathan was testing on a Nexus 5, which really shouldn't be using the 16bit optimization path. I'm not sure why Optimal2DFormatForContent(gfxContentType::COLOR) is returning SurfaceFormat::R5G6B5 there - that's clearly a bug.\n\nBrian, looks like you touched the depth detection code last. Any ideas?", "time": "2014-06-26T01:33:30Z"}, {"bug_id": 676968, "id": 9028440, "author": "thebnich+bmo@gmail.com", "count": 9, "text": "Sorry, but I'm probably not the best person to ask. My only experience with this code is bug 894087, which was a relatively trivial change. Chris worked on bug 803299, so forwarding NEEDINFO to him.", "time": "2014-07-08T18:51:05Z", "raw_text": "Sorry, but I'm probably not the best person to ask. My only experience with this code is bug 894087, which was a relatively trivial change. Chris worked on bug 803299, so forwarding NEEDINFO to him.", "is_private": false, "creation_time": "2014-07-08T18:51:05Z", "creator": "thebnich+bmo@gmail.com", "tags": [], "attachment_id": null}, {"attachment_id": null, "raw_text": "(In reply to Michael Wu [:mwu] from comment #8)\n> Jonathan was testing on a Nexus 5, which really shouldn't be using the 16bit\n> optimization path. I'm not sure why\n> Optimal2DFormatForContent(gfxContentType::COLOR) is returning\n> SurfaceFormat::R5G6B5 there - that's clearly a bug.\n\nHas anyone debugged to see why 565 is being returned on a Nexus 5? It certainly isn't for content rendering, is this some other path that was missed?", "time": "2014-07-08T22:16:46Z", "tags": [], "author": "chrislord.net@gmail.com", "count": 10, "text": "(In reply to Michael Wu [:mwu] from comment #8)\n> Jonathan was testing on a Nexus 5, which really shouldn't be using the 16bit\n> optimization path. I'm not sure why\n> Optimal2DFormatForContent(gfxContentType::COLOR) is returning\n> SurfaceFormat::R5G6B5 there - that's clearly a bug.\n\nHas anyone debugged to see why 565 is being returned on a Nexus 5? It certainly isn't for content rendering, is this some other path that was missed?", "creator": "chrislord.net@gmail.com", "is_private": false, "creation_time": "2014-07-08T22:16:46Z", "id": 9029526, "bug_id": 676968}]}}, "comments": {}}