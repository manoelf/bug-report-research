{"bugs": {"631949": {"comments": [{"is_private": false, "tags": [], "bug_id": 631949, "creation_time": "2011-02-07T00:08:52Z", "raw_text": "See test case.\n\nI think this is what I was grasping at in bug 593174 comment 46, but I was having difficulty fleshing it out there.", "id": 5259228, "time": "2011-02-07T00:08:52Z", "attachment_id": 510182, "creator": "justin.lebar+bug@gmail.com", "author": "justin.lebar+bug@gmail.com", "text": "Created attachment 510182\nTestcase\n\nSee test case.\n\nI think this is what I was grasping at in bug 593174 comment 46, but I was having difficulty fleshing it out there.", "count": 0}, {"id": 5259229, "time": "2011-02-07T00:09:06Z", "author": "justin.lebar+bug@gmail.com", "count": 1, "text": "Created attachment 510183\nInner frame for testcase", "is_private": false, "attachment_id": 510183, "tags": [], "creator": "justin.lebar+bug@gmail.com", "creation_time": "2011-02-07T00:09:06Z", "bug_id": 631949, "raw_text": ""}, {"creator": "justin.lebar+bug@gmail.com", "tags": [], "raw_text": "A working copy of these two files is at\n\n  http://people.mozilla.org/~jlebar/test/bug631949/test1.html\n\nNotice that no matter how many times you click the button, the referrer is always test1.html, even though the URL of the page changes every time you click.", "bug_id": 631949, "creation_time": "2011-02-07T00:16:21Z", "attachment_id": null, "is_private": false, "text": "A working copy of these two files is at\n\n  http://people.mozilla.org/~jlebar/test/bug631949/test1.html\n\nNotice that no matter how many times you click the button, the referrer is always test1.html, even though the URL of the page changes every time you click.", "count": 2, "id": 5259230, "author": "justin.lebar+bug@gmail.com", "time": "2011-02-07T00:16:21Z"}, {"bug_id": 631949, "creation_time": "2011-02-07T00:21:03Z", "raw_text": "I think this is the same problem as in bug 622088 comment 67: When the data URI document modifies the other iframe's location, our referrer code does the following:\n\n* Does the document's original URI match the principal's URI?  No. The original URI is a data URI, and the principal document is the outermost document.\n\n* Therefore, let the referrer be the principal's URI.  Actually, the referrer should be the current URI of the principal document.", "tags": [], "is_private": false, "time": "2011-02-07T00:21:03Z", "id": 5259232, "creator": "justin.lebar+bug@gmail.com", "attachment_id": null, "count": 3, "text": "I think this is the same problem as in bug 622088 comment 67: When the data URI document modifies the other iframe's location, our referrer code does the following:\n\n* Does the document's original URI match the principal's URI?  No. The original URI is a data URI, and the principal document is the outermost document.\n\n* Therefore, let the referrer be the principal's URI.  Actually, the referrer should be the current URI of the principal document.", "author": "justin.lebar+bug@gmail.com"}, {"id": 5259391, "time": "2011-02-07T04:01:09Z", "is_private": false, "tags": [], "bug_id": 631949, "creation_time": "2011-02-07T04:01:09Z", "raw_text": "This was a purposeful compromise when we initially did this stuff for window.location, right?\n\nMaybe we should step back and think about how to do this right?  What state do we need to store that we aren't storing right now, if any, to do the right thing here?", "author": "bzbarsky@mit.edu", "text": "This was a purposeful compromise when we initially did this stuff for window.location, right?\n\nMaybe we should step back and think about how to do this right?  What state do we need to store that we aren't storing right now, if any, to do the right thing here?", "count": 4, "attachment_id": null, "creator": "bzbarsky@mit.edu"}, {"id": 5259395, "time": "2011-02-07T04:03:56Z", "tags": [], "bug_id": 631949, "creation_time": "2011-02-07T04:03:56Z", "raw_text": "(In reply to comment #4)\n> This was a purposeful compromise when we initially did this stuff for\n> window.location, right?\n\nIt might have been, but I didn't do it on purpose!  :)\n\nIt seems to me that, in a lot of ways, the current URI belongs in the principal.  But that's probably conflating its purpose.", "is_private": false, "count": 5, "text": "(In reply to comment #4)\n> This was a purposeful compromise when we initially did this stuff for\n> window.location, right?\n\nIt might have been, but I didn't do it on purpose!  :)\n\nIt seems to me that, in a lot of ways, the current URI belongs in the principal.  But that's probably conflating its purpose.", "author": "justin.lebar+bug@gmail.com", "creator": "justin.lebar+bug@gmail.com", "attachment_id": null}, {"count": 6, "text": "Yeah, the current URI has nothing to do with the principal; the same principal object can be shared across multiple documents which have quite different current URIs, for example.\n\nShould we just be unconditionally using the current URI if it's not equal to the document URI, and if _those_ are equal using the principal?  Or would that regress something?", "id": 5259437, "author": "bzbarsky@mit.edu", "time": "2011-02-07T04:54:03Z", "creator": "bzbarsky@mit.edu", "tags": [], "raw_text": "Yeah, the current URI has nothing to do with the principal; the same principal object can be shared across multiple documents which have quite different current URIs, for example.\n\nShould we just be unconditionally using the current URI if it's not equal to the document URI, and if _those_ are equal using the principal?  Or would that regress something?", "bug_id": 631949, "creation_time": "2011-02-07T04:54:03Z", "is_private": false, "attachment_id": null}, {"attachment_id": null, "creator": "justin.lebar+bug@gmail.com", "author": "justin.lebar+bug@gmail.com", "text": "(In reply to comment #6)\n> Yeah, the current URI has nothing to do with the principal; the same principal\n> object can be shared across multiple documents which have quite different\n> current URIs, for example.\n\nAs I had it in my mind, one document is the primary owner of the principal.  Presumably the owner's URI is the one reflected in the principal's URI?  It's the owner's current URI that we'd want to be able to access through the principal.  (It seems like our \"does the document's original URI match the principal's URI?\" check is really a check for \"does the document own this principal?\")\n\nOf course, if you could just get to the owning document through the principal, that would work too.  But maybe principals can outlive documents...\n\n> Should we just be unconditionally using the current URI if it's not equal to\n> the document URI, and if _those_ are equal using the principal?\n\nWhat does it mean for two URIs to be equal \"using the principal\"?  And by \"document URI\", do you mean \"document's current URI\"?", "count": 7, "is_private": false, "raw_text": "(In reply to comment #6)\n> Yeah, the current URI has nothing to do with the principal; the same principal\n> object can be shared across multiple documents which have quite different\n> current URIs, for example.\n\nAs I had it in my mind, one document is the primary owner of the principal.  Presumably the owner's URI is the one reflected in the principal's URI?  It's the owner's current URI that we'd want to be able to access through the principal.  (It seems like our \"does the document's original URI match the principal's URI?\" check is really a check for \"does the document own this principal?\")\n\nOf course, if you could just get to the owning document through the principal, that would work too.  But maybe principals can outlive documents...\n\n> Should we just be unconditionally using the current URI if it's not equal to\n> the document URI, and if _those_ are equal using the principal?\n\nWhat does it mean for two URIs to be equal \"using the principal\"?  And by \"document URI\", do you mean \"document's current URI\"?", "bug_id": 631949, "creation_time": "2011-02-07T05:09:46Z", "tags": [], "time": "2011-02-07T05:09:46Z", "id": 5259457}, {"text": "> But maybe principals can outlive documents...\n\nOf course.  Just window.open a data: url, then close the original window.  ;)\n\n> What does it mean for two URIs to be equal \"using the principal\"?\n\nIt means you misparsed my sentence.  Let me try again:\n\nPerhaps if the document's current URI is not equal to the document's original URI we should use the document's current URI.  If they are equal, however, we should use the principal.\n\nIs that clearer?  Will it give us the right behavior, though?", "count": 8, "author": "bzbarsky@mit.edu", "creator": "bzbarsky@mit.edu", "attachment_id": null, "time": "2011-02-07T05:12:06Z", "id": 5259462, "creation_time": "2011-02-07T05:12:06Z", "bug_id": 631949, "raw_text": "> But maybe principals can outlive documents...\n\nOf course.  Just window.open a data: url, then close the original window.  ;)\n\n> What does it mean for two URIs to be equal \"using the principal\"?\n\nIt means you misparsed my sentence.  Let me try again:\n\nPerhaps if the document's current URI is not equal to the document's original URI we should use the document's current URI.  If they are equal, however, we should use the principal.\n\nIs that clearer?  Will it give us the right behavior, though?", "tags": [], "is_private": false}, {"attachment_id": null, "creator": "justin.lebar+bug@gmail.com", "author": "justin.lebar+bug@gmail.com", "text": "There's still something here about a principal logically having an owner, right?\n\nSuppose you open a data: url, change the main window's URI via replaceState, then close the main window.  If we don't store the main window's URI somewhere other than in its document, how can we get the data: URI's referrer to reflect the main window's last current URI?\n\n> Is that clearer?  Will it give us the right behavior, though?\n\nYes, much.  Thanks.\n\nBut no, I don't think that fixes this problem.  You have document A with principal URI P.  It loads a data: URI into iframe F, whose principal is P.  Then you call replaceState on A, changing its URI to P'.  Now when F does a load, we'd detect that its current URI equals its original URI and send P as the referrer, but we should send P'.", "count": 9, "is_private": false, "tags": [], "raw_text": "There's still something here about a principal logically having an owner, right?\n\nSuppose you open a data: url, change the main window's URI via replaceState, then close the main window.  If we don't store the main window's URI somewhere other than in its document, how can we get the data: URI's referrer to reflect the main window's last current URI?\n\n> Is that clearer?  Will it give us the right behavior, though?\n\nYes, much.  Thanks.\n\nBut no, I don't think that fixes this problem.  You have document A with principal URI P.  It loads a data: URI into iframe F, whose principal is P.  Then you call replaceState on A, changing its URI to P'.  Now when F does a load, we'd detect that its current URI equals its original URI and send P as the referrer, but we should send P'.", "bug_id": 631949, "creation_time": "2011-02-07T05:43:06Z", "id": 5259477, "time": "2011-02-07T05:43:06Z"}, {"creator": "bzbarsky@mit.edu", "attachment_id": null, "text": "> There's still something here about a principal logically having an owner,\n> right?\n\nNo, imo.\n\n> how can we get the data: URI's referrer to reflect the main window's last\n> current URI?\n\nI don't think it should reflect it.\n\n> and send P as the referrer, but we should send P'.\n\nWhy?", "count": 10, "author": "bzbarsky@mit.edu", "raw_text": "> There's still something here about a principal logically having an owner,\n> right?\n\nNo, imo.\n\n> how can we get the data: URI's referrer to reflect the main window's last\n> current URI?\n\nI don't think it should reflect it.\n\n> and send P as the referrer, but we should send P'.\n\nWhy?", "creation_time": "2011-02-07T12:55:22Z", "bug_id": 631949, "tags": [], "is_private": false, "time": "2011-02-07T12:55:22Z", "id": 5259844}, {"text": "(In reply to comment #10)\n> > and send P as the referrer, but we should send P'.\n> \n> Why?\n\nIf the main document makes a request, we'll send P' as the referrer.  So why should we send a stale URI when the document's data: URI makes a request?\n\nMaybe you'd argue that the data: document was created before the URI changed.  But that's of course not necessary; even if it's created after the URI changes, we'll still send the original URI.\n\nI've thought that the referrer corresponding to a data: document should be equal to the referrer corresponding to its owning document.\n\nThat seems to be what the HTML(5) spec suggests.  At least, step 2 in section 2.7 says that we start out with the document which initialized the load, then walk up its parent chain until we arrive at a document which isn't an iframe srcdoc document.  Being an iframe srcdoc document seems similar to having a data: URI, though they're obviously not the same thing.\n\nMaybe this bug isn't important -- I'd be happy to have one less thing to worry about!  But I don't see how the current behavior is more correct.", "count": 11, "author": "justin.lebar+bug@gmail.com", "time": "2011-02-07T17:06:32Z", "id": 5260288, "raw_text": "(In reply to comment #10)\n> > and send P as the referrer, but we should send P'.\n> \n> Why?\n\nIf the main document makes a request, we'll send P' as the referrer.  So why should we send a stale URI when the document's data: URI makes a request?\n\nMaybe you'd argue that the data: document was created before the URI changed.  But that's of course not necessary; even if it's created after the URI changes, we'll still send the original URI.\n\nI've thought that the referrer corresponding to a data: document should be equal to the referrer corresponding to its owning document.\n\nThat seems to be what the HTML(5) spec suggests.  At least, step 2 in section 2.7 says that we start out with the document which initialized the load, then walk up its parent chain until we arrive at a document which isn't an iframe srcdoc document.  Being an iframe srcdoc document seems similar to having a data: URI, though they're obviously not the same thing.\n\nMaybe this bug isn't important -- I'd be happy to have one less thing to worry about!  But I don't see how the current behavior is more correct.", "bug_id": 631949, "creation_time": "2011-02-07T17:06:32Z", "creator": "justin.lebar+bug@gmail.com", "tags": [], "attachment_id": null, "is_private": false}, {"creator": "bzbarsky@mit.edu", "attachment_id": null, "text": "> So why should we send a stale URI when the document's data: URI makes a request?\n\nWell, this comes down to the question of what referrer a data: URI should send.  Should it be the referrer the document that created it has now, or the one it had when the data: URI was loaded/created?  Or something else?\n\nWithout pushState this is not an issue.  With pushState, looks like it is, and the spec needs to define it if it doesn't already.\n\n> Being an iframe srcdoc document seems similar to having a data: URI, though\n> they're obviously not the same thing.\n\nVery much not the same!\n\nI'm not saying the current behavior is correct.  I'm saying we need to figure out what correct behavior is, get it specced, and implement it.  It sure doesn't sound like anything we've seen in this bug so far is correct behavior.", "count": 12, "author": "bzbarsky@mit.edu", "tags": [], "creation_time": "2011-02-07T17:11:27Z", "bug_id": 631949, "raw_text": "> So why should we send a stale URI when the document's data: URI makes a request?\n\nWell, this comes down to the question of what referrer a data: URI should send.  Should it be the referrer the document that created it has now, or the one it had when the data: URI was loaded/created?  Or something else?\n\nWithout pushState this is not an issue.  With pushState, looks like it is, and the spec needs to define it if it doesn't already.\n\n> Being an iframe srcdoc document seems similar to having a data: URI, though\n> they're obviously not the same thing.\n\nVery much not the same!\n\nI'm not saying the current behavior is correct.  I'm saying we need to figure out what correct behavior is, get it specced, and implement it.  It sure doesn't sound like anything we've seen in this bug so far is correct behavior.", "is_private": false, "id": 5260307, "time": "2011-02-07T17:11:27Z"}, {"attachment_id": null, "is_private": false, "raw_text": "Interestingly, it looks like our behavior with data: URIs even without pushState isn't spec'ed.\n\n> Well, this comes down to the question of what referrer a data: URI should send.\n> Should it be the referrer the document that created it has now, or the one it\n> had when the data: URI was loaded/created?  Or something else?\n\nI guess it depends on whether the \"responsible party\" is logically a URI or a document.  Binding to a document (and so sending its current URI as the referrer) seems most similar to what's currently spec'ed wrt srcdoc iframes.  But binding to the current URI at time of creation seems pretty reasonable to me.\n\nWhat do you think?", "creation_time": "2011-02-07T19:40:35Z", "bug_id": 631949, "creator": "justin.lebar+bug@gmail.com", "tags": [], "author": "justin.lebar+bug@gmail.com", "time": "2011-02-07T19:40:35Z", "id": 5260840, "text": "Interestingly, it looks like our behavior with data: URIs even without pushState isn't spec'ed.\n\n> Well, this comes down to the question of what referrer a data: URI should send.\n> Should it be the referrer the document that created it has now, or the one it\n> had when the data: URI was loaded/created?  Or something else?\n\nI guess it depends on whether the \"responsible party\" is logically a URI or a document.  Binding to a document (and so sending its current URI as the referrer) seems most similar to what's currently spec'ed wrt srcdoc iframes.  But binding to the current URI at time of creation seems pretty reasonable to me.\n\nWhat do you think?", "count": 13}, {"attachment_id": null, "is_private": false, "creator": "bzbarsky@mit.edu", "tags": [], "raw_text": "I have no idea; the only way the two can differ is pushState, and I don't have a good grasp of the semantic meaning pushState is supposed to have.... assuming there is any at all.", "creation_time": "2011-02-07T19:50:35Z", "bug_id": 631949, "id": 5260874, "author": "bzbarsky@mit.edu", "time": "2011-02-07T19:50:35Z", "count": 14, "text": "I have no idea; the only way the two can differ is pushState, and I don't have a good grasp of the semantic meaning pushState is supposed to have.... assuming there is any at all."}, {"count": 15, "text": "Jonas, do you have an opinion?", "author": "justin.lebar+bug@gmail.com", "creator": "justin.lebar+bug@gmail.com", "attachment_id": null, "id": 5260884, "time": "2011-02-07T19:54:10Z", "tags": [], "bug_id": 631949, "creation_time": "2011-02-07T19:54:10Z", "raw_text": "Jonas, do you have an opinion?", "is_private": false}, {"tags": [], "creator": "jonas@sicking.cc", "creation_time": "2011-02-08T02:44:03Z", "bug_id": 631949, "raw_text": "First off, the HTML5 spec intentionally stays away from a lot of data: behavior. Implementations vary wildly on how they are treated as far as principals and I think the current sentiment is that at some point someone needs to sit down and create a comprehensive proposal for how they should be treated. So far no one has taken the time to do this.\n\nIn the meantime I think we should just do whatever we feel makes the most sense for our behavior. This will likely help compare the various behaviors once a spec is actually written.\n\n\nSo it seems like one of the fundamental questions here is: Is the referrer for a data:-iframe inherited from the parent document by reference or by value. I.e. should we copy what the parent document uses as referrer at the time when the contained iframe-document is created, or should we constantly use the same referrer as the parent document uses.\n\nThe more I think about it, the less I think there is a better solution. Either works for me. If someone can think of reasons for one or the other please do state them.\n\n\nSo with that in mind, maybe we should pick whatever we can implement the best.\n\n\nIf we do by-reference, I.e. if then maybe sticking the \"who is the current referrer\" info in the principal is the way to go.\n\nIf we do copy-when-created (which is what we currently do, right?), then adding API to nsIDocument which calculates the proper API seems useful. Possibly even backing that with a member if needed.", "is_private": false, "attachment_id": null, "text": "First off, the HTML5 spec intentionally stays away from a lot of data: behavior. Implementations vary wildly on how they are treated as far as principals and I think the current sentiment is that at some point someone needs to sit down and create a comprehensive proposal for how they should be treated. So far no one has taken the time to do this.\n\nIn the meantime I think we should just do whatever we feel makes the most sense for our behavior. This will likely help compare the various behaviors once a spec is actually written.\n\n\nSo it seems like one of the fundamental questions here is: Is the referrer for a data:-iframe inherited from the parent document by reference or by value. I.e. should we copy what the parent document uses as referrer at the time when the contained iframe-document is created, or should we constantly use the same referrer as the parent document uses.\n\nThe more I think about it, the less I think there is a better solution. Either works for me. If someone can think of reasons for one or the other please do state them.\n\n\nSo with that in mind, maybe we should pick whatever we can implement the best.\n\n\nIf we do by-reference, I.e. if then maybe sticking the \"who is the current referrer\" info in the principal is the way to go.\n\nIf we do copy-when-created (which is what we currently do, right?), then adding API to nsIDocument which calculates the proper API seems useful. Possibly even backing that with a member if needed.", "count": 16, "id": 5262132, "time": "2011-02-08T02:44:03Z", "author": "jonas@sicking.cc"}, {"creator": "bzbarsky@mit.edu", "attachment_id": null, "text": "We share principals between pages in cases other than data:.  I really don't think we want to be sticking referrers into the principal....", "count": 17, "author": "bzbarsky@mit.edu", "tags": [], "creation_time": "2011-02-08T02:51:49Z", "bug_id": 631949, "raw_text": "We share principals between pages in cases other than data:.  I really don't think we want to be sticking referrers into the principal....", "is_private": false, "id": 5262145, "time": "2011-02-08T02:51:49Z"}]}}, "comments": {}}