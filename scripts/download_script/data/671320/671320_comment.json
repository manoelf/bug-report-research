{"comments": {}, "bugs": {"671320": {"comments": [{"id": 5589246, "count": 0, "is_private": false, "creation_time": "2011-07-13T17:02:07Z", "time": "2011-07-13T17:02:07Z", "creator": "axelg@gofree.indigo.ie", "author": "axelg@gofree.indigo.ie", "attachment_id": 545685, "raw_text": "User Agent: Mozilla/5.0 (Windows NT 5.1; rv:5.0) Gecko/20100101 Firefox/5.0\nBuild ID: 20110615151330\n\nSteps to reproduce:\n\nI used to answer donation emails by pasting a complete text + formatting from a template mail. Since the upgrade to TB5 the <styles> section is completely ignored. \n\n1. click reply on the email from the sender (donation)\n2. open my Reply template (thank you email) in a separate tab\n3. I am highlighting the complete contents of the (thank you template) content (CTRL+A), then press CTRL+C;\n4. I paste this on top of the Reply in the Compose Window (CTRL+V)\n\n\n\n\nActual results:\n\nThe text pastes without any formatting. When I check the HTML source of my new message the <style> tag is completely missing.\n\n\nExpected results:\n\nthe style should have been copied with the text (<style> either pasted in line or into the <head> section of the composed Email.\n\nOnly workaround is to use the Stationery extension and copy the <style> section from the original email into the <head> section of the Email Reply. Then all styles work like in the template (fonts, background-images with gradients and -mox-border=radius)\n\nI have tried both with stationery extension enabled and disabled. The Reply Email is stored in the Templates Folder.", "bug_id": 671320, "text": "Created attachment 545685\nReply email - place into TB templates folder to test\n\nUser Agent: Mozilla/5.0 (Windows NT 5.1; rv:5.0) Gecko/20100101 Firefox/5.0\nBuild ID: 20110615151330\n\nSteps to reproduce:\n\nI used to answer donation emails by pasting a complete text + formatting from a template mail. Since the upgrade to TB5 the <styles> section is completely ignored. \n\n1. click reply on the email from the sender (donation)\n2. open my Reply template (thank you email) in a separate tab\n3. I am highlighting the complete contents of the (thank you template) content (CTRL+A), then press CTRL+C;\n4. I paste this on top of the Reply in the Compose Window (CTRL+V)\n\n\n\n\nActual results:\n\nThe text pastes without any formatting. When I check the HTML source of my new message the <style> tag is completely missing.\n\n\nExpected results:\n\nthe style should have been copied with the text (<style> either pasted in line or into the <head> section of the composed Email.\n\nOnly workaround is to use the Stationery extension and copy the <style> section from the original email into the <head> section of the Email Reply. Then all styles work like in the template (fonts, background-images with gradients and -mox-border=radius)\n\nI have tried both with stationery extension enabled and disabled. The Reply Email is stored in the Templates Folder.", "tags": []}, {"raw_text": "This is what the template email looks like in the preview window, from which I am copying.", "id": 5589259, "count": 1, "attachment_id": 545688, "is_private": false, "text": "Created attachment 545688\nPreview of Template email\n\nThis is what the template email looks like in the preview window, from which I am copying.", "bug_id": 671320, "tags": [], "author": "axelg@gofree.indigo.ie", "creation_time": "2011-07-13T17:06:49Z", "time": "2011-07-13T17:06:49Z", "creator": "axelg@gofree.indigo.ie"}, {"count": 2, "id": 5589260, "is_private": false, "time": "2011-07-13T17:07:50Z", "creation_time": "2011-07-13T17:07:50Z", "creator": "axelg@gofree.indigo.ie", "author": "axelg@gofree.indigo.ie", "attachment_id": 545689, "raw_text": "These are the contents of a new Email (In Composer) after pasting the complete contents of the template", "tags": [], "bug_id": 671320, "text": "Created attachment 545689\nPasted Contents\n\nThese are the contents of a new Email (In Composer) after pasting the complete contents of the template"}, {"is_private": false, "count": 3, "id": 5589283, "author": "axelg@gofree.indigo.ie", "creator": "axelg@gofree.indigo.ie", "time": "2011-07-13T17:13:45Z", "creation_time": "2011-07-13T17:13:45Z", "raw_text": "The same behavior is reproducable when I click on the Edit button on the template email. It displays as normal but I cannot copy it to the answer email without loosing the styles.\n\nAlso note that the notification emails I reply to are usually html or rich text (donation notifications from paypal). Before sending off the reply I always manually delete the linked images that are included as baggage with these.", "attachment_id": null, "tags": [], "bug_id": 671320, "text": "The same behavior is reproducable when I click on the Edit button on the template email. It displays as normal but I cannot copy it to the answer email without loosing the styles.\n\nAlso note that the notification emails I reply to are usually html or rich text (donation notifications from paypal). Before sending off the reply I always manually delete the linked images that are included as baggage with these."}, {"creator": "jsabash@bellatlantic.net", "time": "2011-07-14T23:23:59Z", "creation_time": "2011-07-14T23:23:59Z", "author": "jsabash@bellatlantic.net", "is_private": false, "id": 5592557, "count": 4, "bug_id": 671320, "text": "(In reply to comment #0)\n> Created attachment 545685 [details]\n> Reply email - place into TB templates folder to test\n> \n\n> \n> Steps to reproduce:\n> \n> I used to answer donation emails by pasting a complete text + formatting\n> from a template mail. Since the upgrade to TB5 the <styles> section is\n> completely ignored.\n\nI'm not sure if Stylesheets in the head section were ever copied using c/p\nWith what version of Thunderbird did that seem to work for you.\nI seem to recall inline styles being copy/pastable but not stylesheets.\n<style> blah blah <style>\n \n\n\n> Actual results:\n> \n> The text pastes without any formatting. When I check the HTML source of my\n> new message the <style> tag is completely missing.\n\nI can confirm this, but I'm still not sure it is new behavior or a regression. \n> \n> Expected results:\n> \n> the style should have been copied with the text (<style> either pasted in\n> line or into the <head> section of the composed Email.\n> \n> Only workaround is to use the Stationery extension and copy the <style>\n> section from the original email into the <head> section of the Email Reply.\n> Then all styles work like in the template (fonts, background-images with\n> gradients and -mox-border=radius)\n\nThere is no reason that the stylesheet must be placed in the head section to work it's magic. It can be placed in the body section as well. So one alternative is to keep it as a text file and use insert>html in the reply (after the paste) to insert it. That would work as long as the \"class\" statements are retained after the paste.\n\nVery nice template BTW", "tags": [], "attachment_id": null, "raw_text": "(In reply to comment #0)\n> Created attachment 545685 [details]\n> Reply email - place into TB templates folder to test\n> \n\n> \n> Steps to reproduce:\n> \n> I used to answer donation emails by pasting a complete text + formatting\n> from a template mail. Since the upgrade to TB5 the <styles> section is\n> completely ignored.\n\nI'm not sure if Stylesheets in the head section were ever copied using c/p\nWith what version of Thunderbird did that seem to work for you.\nI seem to recall inline styles being copy/pastable but not stylesheets.\n<style> blah blah <style>\n \n\n\n> Actual results:\n> \n> The text pastes without any formatting. When I check the HTML source of my\n> new message the <style> tag is completely missing.\n\nI can confirm this, but I'm still not sure it is new behavior or a regression. \n> \n> Expected results:\n> \n> the style should have been copied with the text (<style> either pasted in\n> line or into the <head> section of the composed Email.\n> \n> Only workaround is to use the Stationery extension and copy the <style>\n> section from the original email into the <head> section of the Email Reply.\n> Then all styles work like in the template (fonts, background-images with\n> gradients and -mox-border=radius)\n\nThere is no reason that the stylesheet must be placed in the head section to work it's magic. It can be placed in the body section as well. So one alternative is to keep it as a text file and use insert>html in the reply (after the paste) to insert it. That would work as long as the \"class\" statements are retained after the paste.\n\nVery nice template BTW"}, {"tags": [], "text": "(In reply to comment #4)\n> (In reply to comment #0)\n> > Created attachment 545685 [details]\n> > Reply email - place into TB templates folder to test\n> > \n> \n> > \n> > Steps to reproduce:\n> > \n> > I used to answer donation emails by pasting a complete text + formatting\n> > from a template mail. Since the upgrade to TB5 the <styles> section is\n> > completely ignored.\n> \n> I'm not sure if Stylesheets in the head section were ever copied using c/p\n> With what version of Thunderbird did that seem to work for you.\n\nIt worked with the latest Thunderbird 3.* versions. Not sure if it worked with TB 4.* as I believe I skipped that one and upgraded straight to 5. (can't remember)\n\n> I seem to recall inline styles being copy/pastable but not stylesheets.\n> <style> blah blah <style>\n>  \n\nthe example is not a style sheet; just a style moved to the head section. But I also tested it with the style copied into the <body> of the email and it is also stripped right out.\n\n\n> \n> \n> > Actual results:\n> > \n> > The text pastes without any formatting. When I check the HTML source of my\n> > new message the <style> tag is completely missing.\n> \n> I can confirm this, but I'm still not sure it is new behavior or a\n> regression. \n\nWell, I used to be able to highlight the whole mail and paste it into the new mail, without any loss of formatting, so it is a regression in my view.\n\n\n> > \n> > Expected results:\n> > \n> > the style should have been copied with the text (<style> either pasted in\n> > line or into the <head> section of the composed Email.\n> > \n> > Only workaround is to use the Stationery extension and copy the <style>\n> > section from the original email into the <head> section of the Email Reply.\n> > Then all styles work like in the template (fonts, background-images with\n> > gradients and -mox-border=radius)\n> \n> There is no reason that the stylesheet must be placed in the head section to\n> work it's magic. It can be placed in the body section as well. \n\nTested and doesn't work either :(\n\n> So one\n> alternative is to keep it as a text file and use insert>html in the reply\n> (after the paste) to insert it. That would work as long as the \"class\"\n> statements are retained after the paste.\n\nI will try this as its a few less steps, but I would like the bug to be fixed as it is still more steps and there already quite a few steps for each donation reply (such as stripping out paypal images, the link \"You can view the transaction details online.\", adding Recipient name etc.\n\n> \n> Very nice template BTW\n\nOh thanks very much. Fruitful work trying to motivate users to give something back ;)\n\nFeel free to copy/reuse :)", "bug_id": 671320, "attachment_id": null, "raw_text": "(In reply to comment #4)\n> (In reply to comment #0)\n> > Created attachment 545685 [details]\n> > Reply email - place into TB templates folder to test\n> > \n> \n> > \n> > Steps to reproduce:\n> > \n> > I used to answer donation emails by pasting a complete text + formatting\n> > from a template mail. Since the upgrade to TB5 the <styles> section is\n> > completely ignored.\n> \n> I'm not sure if Stylesheets in the head section were ever copied using c/p\n> With what version of Thunderbird did that seem to work for you.\n\nIt worked with the latest Thunderbird 3.* versions. Not sure if it worked with TB 4.* as I believe I skipped that one and upgraded straight to 5. (can't remember)\n\n> I seem to recall inline styles being copy/pastable but not stylesheets.\n> <style> blah blah <style>\n>  \n\nthe example is not a style sheet; just a style moved to the head section. But I also tested it with the style copied into the <body> of the email and it is also stripped right out.\n\n\n> \n> \n> > Actual results:\n> > \n> > The text pastes without any formatting. When I check the HTML source of my\n> > new message the <style> tag is completely missing.\n> \n> I can confirm this, but I'm still not sure it is new behavior or a\n> regression. \n\nWell, I used to be able to highlight the whole mail and paste it into the new mail, without any loss of formatting, so it is a regression in my view.\n\n\n> > \n> > Expected results:\n> > \n> > the style should have been copied with the text (<style> either pasted in\n> > line or into the <head> section of the composed Email.\n> > \n> > Only workaround is to use the Stationery extension and copy the <style>\n> > section from the original email into the <head> section of the Email Reply.\n> > Then all styles work like in the template (fonts, background-images with\n> > gradients and -mox-border=radius)\n> \n> There is no reason that the stylesheet must be placed in the head section to\n> work it's magic. It can be placed in the body section as well. \n\nTested and doesn't work either :(\n\n> So one\n> alternative is to keep it as a text file and use insert>html in the reply\n> (after the paste) to insert it. That would work as long as the \"class\"\n> statements are retained after the paste.\n\nI will try this as its a few less steps, but I would like the bug to be fixed as it is still more steps and there already quite a few steps for each donation reply (such as stripping out paypal images, the link \"You can view the transaction details online.\", adding Recipient name etc.\n\n> \n> Very nice template BTW\n\nOh thanks very much. Fruitful work trying to motivate users to give something back ;)\n\nFeel free to copy/reuse :)", "creator": "axelg@gofree.indigo.ie", "time": "2011-07-15T06:15:50Z", "creation_time": "2011-07-15T06:15:50Z", "author": "axelg@gofree.indigo.ie", "is_private": false, "count": 5, "id": 5593028}, {"tags": [], "bug_id": 671320, "text": "Ok, I did some more tests, and it actually turns out the Paste command strips out all <style type=\"text/css\">...</style> pairs, but leaves the rest of the html intact. Looks to me like somebody added some \"cleaning\" method and introduced a regression.", "raw_text": "Ok, I did some more tests, and it actually turns out the Paste command strips out all <style type=\"text/css\">...</style> pairs, but leaves the rest of the html intact. Looks to me like somebody added some \"cleaning\" method and introduced a regression.", "attachment_id": null, "author": "axelg@gofree.indigo.ie", "creator": "axelg@gofree.indigo.ie", "time": "2011-07-15T07:15:59Z", "creation_time": "2011-07-15T07:15:59Z", "is_private": false, "count": 6, "id": 5593052}, {"count": 7, "id": 5600341, "is_private": false, "time": "2011-07-19T22:18:34Z", "creation_time": "2011-07-19T22:18:34Z", "creator": "jsabash@bellatlantic.net", "author": "jsabash@bellatlantic.net", "attachment_id": null, "raw_text": "Sorry for the delay Axel, I've been away for a few days\nSo, with TB3.1.12pre which is based on Gecko1.9.2 pasting the <style tags works fine. (even if they are in the head section)So this is definitely a regression.\nEhsan would know if this functionality can be restored to Thunderbird while retaining the original \"core\" purpose of the sanitization.\nEhsan, could you please take a look.", "bug_id": 671320, "text": "Sorry for the delay Axel, I've been away for a few days\nSo, with TB3.1.12pre which is based on Gecko1.9.2 pasting the <style tags works fine. (even if they are in the head section)So this is definitely a regression.\nEhsan would know if this functionality can be restored to Thunderbird while retaining the original \"core\" purpose of the sanitization.\nEhsan, could you please take a look.", "tags": []}, {"attachment_id": null, "raw_text": "So, I've fixed stuff related to this tons of time, and I do believe that this should be fixed.  That is, unless I've screwed something up!  :-)\n\nIrving, would you mind running Thunderbird under the debugger, try to repro this bug, and see if this code <http://mxr.mozilla.org/mozilla-central/source/editor/libeditor/html/nsHTMLDataTransfer.cpp#2710> is being hit or not (and if it's not, why?)\n\nIf that code is hit, I believe that the style element should be there (only with sanitized content, of course).", "tags": [], "bug_id": 671320, "text": "So, I've fixed stuff related to this tons of time, and I do believe that this should be fixed.  That is, unless I've screwed something up!  :-)\n\nIrving, would you mind running Thunderbird under the debugger, try to repro this bug, and see if this code <http://mxr.mozilla.org/mozilla-central/source/editor/libeditor/html/nsHTMLDataTransfer.cpp#2710> is being hit or not (and if it's not, why?)\n\nIf that code is hit, I believe that the style element should be there (only with sanitized content, of course).", "is_private": false, "id": 5605552, "count": 8, "creator": "ehsan.akhgari@gmail.com", "creation_time": "2011-07-21T21:40:28Z", "time": "2011-07-21T21:40:28Z", "author": "ehsan.akhgari@gmail.com"}, {"creation_time": "2011-07-26T09:23:10Z", "time": "2011-07-26T09:23:10Z", "creator": "axelg@gofree.indigo.ie", "author": "axelg@gofree.indigo.ie", "count": 9, "id": 5613348, "is_private": false, "text": "Created attachment 548399\nhtml snippet: style tag for testing\n\nthis snippet contains style tag that gets removed, it has some Gecko specific styles (such as -moz-border-radius) and some standard ones. Paste it into html of your test mail.", "bug_id": 671320, "tags": [], "attachment_id": 548399, "raw_text": "this snippet contains style tag that gets removed, it has some Gecko specific styles (such as -moz-border-radius) and some standard ones. Paste it into html of your test mail."}, {"is_private": false, "id": 5630584, "count": 10, "creator": "ehsan.akhgari@gmail.com", "time": "2011-08-03T16:00:19Z", "creation_time": "2011-08-03T16:00:19Z", "author": "ehsan.akhgari@gmail.com", "attachment_id": null, "raw_text": "So Irving helped debug this.  In nsHTMLEditor::InsertFromTransferable, isSafe is being set to true, because Thunderbird for some reason thinks that it's an APP_TYPE_EDITOR.  Bienvenu, is that how things are supposed to work?\n\nThis behavior change is coming from Neil's patch here: <http://hg.mozilla.org/mozilla-central/rev/7893933cf5d0>\n\nNow the thing is that Thunderbird thinks that it's Composer, so it doesn't sanitize anything.  But the original message has the style tag inside the head tag, and when we're copying, we only copy stuff inside the body tag, so this issue doesn't really have anything to do with pasting, it's just that we don't copy the style tag to the clipboard in the first place (you can confirm this by copying the email and pasting it in Safari for example).  I'm not sure even if this is a bug per se, but copying the mail contents from Mail.app seems to copy the style tag too.  Boris, do you think this is something that we need to fix?\n\nBut in any case, Thunderbird masquerading as APP_TYPE_EDITOR seems like a different bug that we need to fix.", "tags": [], "text": "So Irving helped debug this.  In nsHTMLEditor::InsertFromTransferable, isSafe is being set to true, because Thunderbird for some reason thinks that it's an APP_TYPE_EDITOR.  Bienvenu, is that how things are supposed to work?\n\nThis behavior change is coming from Neil's patch here: <http://hg.mozilla.org/mozilla-central/rev/7893933cf5d0>\n\nNow the thing is that Thunderbird thinks that it's Composer, so it doesn't sanitize anything.  But the original message has the style tag inside the head tag, and when we're copying, we only copy stuff inside the body tag, so this issue doesn't really have anything to do with pasting, it's just that we don't copy the style tag to the clipboard in the first place (you can confirm this by copying the email and pasting it in Safari for example).  I'm not sure even if this is a bug per se, but copying the mail contents from Mail.app seems to copy the style tag too.  Boris, do you think this is something that we need to fix?\n\nBut in any case, Thunderbird masquerading as APP_TYPE_EDITOR seems like a different bug that we need to fix.", "bug_id": 671320}, {"author": "neil@httl.net", "time": "2011-08-03T16:04:15Z", "creation_time": "2011-08-03T16:04:15Z", "creator": "neil@httl.net", "count": 11, "id": 5630598, "is_private": false, "text": "Well, I'm sure people want to be able to paste in local images and other Composery-type of stuff in a message too.", "bug_id": 671320, "tags": [], "raw_text": "Well, I'm sure people want to be able to paste in local images and other Composery-type of stuff in a message too.", "attachment_id": null}, {"count": 12, "id": 5630659, "is_private": false, "creation_time": "2011-08-03T16:27:33Z", "time": "2011-08-03T16:27:33Z", "creator": "bzbarsky@mit.edu", "author": "bzbarsky@mit.edu", "attachment_id": null, "raw_text": "> Boris, do you think this is something that we need to fix?\n\nI don't really know.  I don't have much experience with HTML mail....", "bug_id": 671320, "text": "> Boris, do you think this is something that we need to fix?\n\nI don't really know.  I don't have much experience with HTML mail....", "tags": []}, {"attachment_id": null, "raw_text": "(In reply to comment #10)\n> So Irving helped debug this.  In nsHTMLEditor::InsertFromTransferable,\n> isSafe is being set to true, because Thunderbird for some reason thinks that\n> it's an APP_TYPE_EDITOR.  Bienvenu, is that how things are supposed to work?\n> \nYes, it's deliberate, and has been this way for a long time. As Neil says, we want to be able to do things like paste images.", "tags": [], "text": "(In reply to comment #10)\n> So Irving helped debug this.  In nsHTMLEditor::InsertFromTransferable,\n> isSafe is being set to true, because Thunderbird for some reason thinks that\n> it's an APP_TYPE_EDITOR.  Bienvenu, is that how things are supposed to work?\n> \nYes, it's deliberate, and has been this way for a long time. As Neil says, we want to be able to do things like paste images.", "bug_id": 671320, "count": 13, "id": 5630909, "is_private": false, "time": "2011-08-03T18:12:18Z", "creation_time": "2011-08-03T18:12:18Z", "creator": "mozilla@davidbienvenu.org", "author": "mozilla@davidbienvenu.org"}, {"is_private": false, "id": 5634853, "count": 14, "author": "axelg@gofree.indigo.ie", "creator": "axelg@gofree.indigo.ie", "time": "2011-08-05T00:43:33Z", "creation_time": "2011-08-05T00:43:33Z", "raw_text": "(In reply to comment #10)\n> Now the thing is that Thunderbird thinks that it's Composer, so it doesn't\n> sanitize anything.  But the original message has the style tag inside the\n> head tag, and when we're copying, we only copy stuff inside the body tag, so\n> this issue doesn't really have anything to do with pasting, \n\nnot quite. the style tags are ignored no matter whether they are in the head tag or in the body. When I investigated the bug first I thought the position of the style tag had any influence on the bug, it turns out this is not the case. I wouldn't mind if the Composer window would only accept styles within the head (or merged them into the head section) but completely dropping them is a substantial regression.", "attachment_id": null, "bug_id": 671320, "text": "(In reply to comment #10)\n> Now the thing is that Thunderbird thinks that it's Composer, so it doesn't\n> sanitize anything.  But the original message has the style tag inside the\n> head tag, and when we're copying, we only copy stuff inside the body tag, so\n> this issue doesn't really have anything to do with pasting, \n\nnot quite. the style tags are ignored no matter whether they are in the head tag or in the body. When I investigated the bug first I thought the position of the style tag had any influence on the bug, it turns out this is not the case. I wouldn't mind if the Composer window would only accept styles within the head (or merged them into the head section) but completely dropping them is a substantial regression.", "tags": []}, {"raw_text": "Local images should be converted to data: URI images when pasting, and isSafe is not needed to be set to true for that to work.", "attachment_id": null, "tags": [], "bug_id": 671320, "text": "Local images should be converted to data: URI images when pasting, and isSafe is not needed to be set to true for that to work.", "id": 5715876, "count": 15, "is_private": false, "author": "ehsan.akhgari@gmail.com", "creation_time": "2011-09-13T19:58:58Z", "time": "2011-09-13T19:58:58Z", "creator": "ehsan.akhgari@gmail.com"}, {"text": "Created attachment 646973\nsimplified html snippet\n\nhere is a somwhat simplified test case. open this html file in a new email then copy and paste to a new html email. Looks to me like only the \"Simple-html\" version of the clipboard is being recognized. Not sure whether this happens during the copy or the paste operation. Fact is that if you copy and paste _within the same email_ the style tag also gets lost. The <div> and <br> are being preserved. We should first try to get some clipboard viewer application to see what kind of data is actually copied into the cliboard.", "bug_id": 671320, "tags": [], "attachment_id": 646973, "raw_text": "here is a somwhat simplified test case. open this html file in a new email then copy and paste to a new html email. Looks to me like only the \"Simple-html\" version of the clipboard is being recognized. Not sure whether this happens during the copy or the paste operation. Fact is that if you copy and paste _within the same email_ the style tag also gets lost. The <div> and <br> are being preserved. We should first try to get some clipboard viewer application to see what kind of data is actually copied into the cliboard.", "creation_time": "2012-07-29T15:41:23Z", "time": "2012-07-29T15:41:23Z", "creator": "axelg@gofree.indigo.ie", "author": "axelg@gofree.indigo.ie", "count": 16, "id": 6515306, "is_private": false}, {"bug_id": 671320, "text": "So the bug  happens during copy, not during paste - 3 clipboards formats are being created:\n\n-Text\n-Unicode Text\n-HTML\n\nthe contents of the HTML clip are:\n\n<html><body>\n<!--StartFragment-->[[ Copy from here\n\n<div id=\"linkBox\">\nThis text should be in a box<br></div>to here]]<!--EndFragment-->\n</body>\n</html>\n\n... so the <style> tags are simply removed, and the html is wrapped in a html-body pair. So we need to investigate the details of the low level CPP code that does the copying.", "tags": [], "raw_text": "So the bug  happens during copy, not during paste - 3 clipboards formats are being created:\n\n-Text\n-Unicode Text\n-HTML\n\nthe contents of the HTML clip are:\n\n<html><body>\n<!--StartFragment-->[[ Copy from here\n\n<div id=\"linkBox\">\nThis text should be in a box<br></div>to here]]<!--EndFragment-->\n</body>\n</html>\n\n... so the <style> tags are simply removed, and the html is wrapped in a html-body pair. So we need to investigate the details of the low level CPP code that does the copying.", "attachment_id": null, "author": "axelg@gofree.indigo.ie", "creator": "axelg@gofree.indigo.ie", "time": "2012-07-30T09:24:59Z", "creation_time": "2012-07-30T09:24:59Z", "is_private": false, "count": 17, "id": 6516167}, {"is_private": false, "id": 6517358, "count": 18, "author": "axelg@gofree.indigo.ie", "creator": "axelg@gofree.indigo.ie", "time": "2012-07-30T17:59:27Z", "creation_time": "2012-07-30T17:59:27Z", "raw_text": "\n\nwhen the <STYLE> node is analysed from \n\nwhen the html nodes are serialized at:\n\nnsDocumentEncoder.cpp#871\n  rv = SerializeToStringRecursive(childAsNode, aString, false);\n  \nthe <style> tag is omitted because of IsVisibleNode returning false (line 465)\n\nhttp://mxr.mozilla.org/comm-central/source/mozilla/content/base/src/nsDocumentEncoder.cpp#465\n\nif  I skip the return in the debugger (and thus pretent <style> tags are visible), then the style information is being copied to clipboard and can be pasted back. I think I could write a patch based on this.", "attachment_id": null, "bug_id": 671320, "text": "\n\nwhen the <STYLE> node is analysed from \n\nwhen the html nodes are serialized at:\n\nnsDocumentEncoder.cpp#871\n  rv = SerializeToStringRecursive(childAsNode, aString, false);\n  \nthe <style> tag is omitted because of IsVisibleNode returning false (line 465)\n\nhttp://mxr.mozilla.org/comm-central/source/mozilla/content/base/src/nsDocumentEncoder.cpp#465\n\nif  I skip the return in the debugger (and thus pretent <style> tags are visible), then the style information is being copied to clipboard and can be pasted back. I think I could write a patch based on this.", "tags": []}, {"bug_id": 671320, "text": "Note that you probably want to special case style elements there.  You shouldn't include all non-visible elements.", "tags": [], "attachment_id": null, "raw_text": "Note that you probably want to special case style elements there.  You shouldn't include all non-visible elements.", "creator": "ehsan.akhgari@gmail.com", "creation_time": "2012-07-30T18:05:03Z", "time": "2012-07-30T18:05:03Z", "author": "ehsan.akhgari@gmail.com", "is_private": false, "count": 19, "id": 6517380}, {"attachment_id": null, "raw_text": "(In reply to Ehsan Akhgari [:ehsan] from comment #19)\n> Note that you probably want to special case style elements there.  You\n> shouldn't include all non-visible elements.\n\nSure this would purely a special case for <style> tags, and even then I am worried as the serialize code is not only called by the clipboard; hard to tell what undesired side-effects even such a special-cased code could cause.", "text": "(In reply to Ehsan Akhgari [:ehsan] from comment #19)\n> Note that you probably want to special case style elements there.  You\n> shouldn't include all non-visible elements.\n\nSure this would purely a special case for <style> tags, and even then I am worried as the serialize code is not only called by the clipboard; hard to tell what undesired side-effects even such a special-cased code could cause.", "bug_id": 671320, "tags": [], "is_private": false, "count": 20, "id": 6517862, "creator": "axelg@gofree.indigo.ie", "creation_time": "2012-07-30T20:06:50Z", "time": "2012-07-30T20:06:50Z", "author": "axelg@gofree.indigo.ie"}, {"author": "ehsan.akhgari@gmail.com", "creator": "ehsan.akhgari@gmail.com", "creation_time": "2012-07-30T20:28:17Z", "time": "2012-07-30T20:28:17Z", "is_private": false, "id": 6517977, "count": 21, "tags": [], "text": "(In reply to comment #20)\n> (In reply to Ehsan Akhgari [:ehsan] from comment #19)\n> > Note that you probably want to special case style elements there.  You\n> > shouldn't include all non-visible elements.\n> \n> Sure this would purely a special case for <style> tags, and even then I am\n> worried as the serialize code is not only called by the clipboard; hard to tell\n> what undesired side-effects even such a special-cased code could cause.\n\nHmm, good point.  Currently SkipInvisibleContent is only used for HTML copy and selection.toString().  I'm not entirely sure if this special casing will be OK for selection.toString().  Aryeh, do you know?", "bug_id": 671320, "raw_text": "(In reply to comment #20)\n> (In reply to Ehsan Akhgari [:ehsan] from comment #19)\n> > Note that you probably want to special case style elements there.  You\n> > shouldn't include all non-visible elements.\n> \n> Sure this would purely a special case for <style> tags, and even then I am\n> worried as the serialize code is not only called by the clipboard; hard to tell\n> what undesired side-effects even such a special-cased code could cause.\n\nHmm, good point.  Currently SkipInvisibleContent is only used for HTML copy and selection.toString().  I'm not entirely sure if this special casing will be OK for selection.toString().  Aryeh, do you know?", "attachment_id": null}, {"tags": [], "text": "(In reply to Axel Grude from comment #18)\n> nsDocumentEncoder.cpp#871\n>   rv = SerializeToStringRecursive(childAsNode, aString, false);\n>   \n> the <style> tag is omitted because of IsVisibleNode returning false (line\n> 465)\n...\n> I think I could write a patch based on this.\n\nIt should probably be behind yet another document encoder flag to avoid changing the behavior of other callers.\n\n(In reply to Ehsan Akhgari [:ehsan] from comment #10)\n> Now the thing is that Thunderbird thinks that it's Composer, so it doesn't\n> sanitize anything.\n\nScary.\n\nBTW, last I checked, nsTreeSanitizer failed to reconstruct the text content of <style> correctly when it removed -moz-binding, but I forgot to file that bug. I should go file it now.", "bug_id": 671320, "attachment_id": null, "raw_text": "(In reply to Axel Grude from comment #18)\n> nsDocumentEncoder.cpp#871\n>   rv = SerializeToStringRecursive(childAsNode, aString, false);\n>   \n> the <style> tag is omitted because of IsVisibleNode returning false (line\n> 465)\n...\n> I think I could write a patch based on this.\n\nIt should probably be behind yet another document encoder flag to avoid changing the behavior of other callers.\n\n(In reply to Ehsan Akhgari [:ehsan] from comment #10)\n> Now the thing is that Thunderbird thinks that it's Composer, so it doesn't\n> sanitize anything.\n\nScary.\n\nBTW, last I checked, nsTreeSanitizer failed to reconstruct the text content of <style> correctly when it removed -moz-binding, but I forgot to file that bug. I should go file it now.", "creator": "hsivonen@mozilla.com", "time": "2012-07-31T06:23:12Z", "creation_time": "2012-07-31T06:23:12Z", "author": "hsivonen@mozilla.com", "is_private": false, "count": 22, "id": 6519428}, {"author": "hsivonen@mozilla.com", "creator": "hsivonen@mozilla.com", "time": "2012-07-31T07:12:21Z", "creation_time": "2012-07-31T07:12:21Z", "is_private": false, "count": 23, "id": 6519468, "text": "(In reply to Henri Sivonen (:hsivonen) from comment #22)\n> BTW, last I checked, nsTreeSanitizer failed to reconstruct the text content\n> of <style> correctly when it removed -moz-binding, but I forgot to file that\n> bug. I should go file it now.\n\nFiled as bug 779058.", "bug_id": 671320, "tags": [], "raw_text": "(In reply to Henri Sivonen (:hsivonen) from comment #22)\n> BTW, last I checked, nsTreeSanitizer failed to reconstruct the text content\n> of <style> correctly when it removed -moz-binding, but I forgot to file that\n> bug. I should go file it now.\n\nFiled as bug 779058.", "attachment_id": null}, {"author": "axelg@gofree.indigo.ie", "creator": "axelg@gofree.indigo.ie", "creation_time": "2012-07-31T08:55:57Z", "time": "2012-07-31T08:55:57Z", "is_private": false, "id": 6519577, "count": 24, "bug_id": 671320, "text": "(In reply to Henri Sivonen (:hsivonen) from comment #22)\n> (In reply to Axel Grude from comment #18)\n> > nsDocumentEncoder.cpp#871\n> >   rv = SerializeToStringRecursive(childAsNode, aString, false);\n> >   \n> > the <style> tag is omitted because of IsVisibleNode returning false (line\n> > 465)\n> ...\n> > I think I could write a patch based on this.\n> \n> It should probably be behind yet another document encoder flag to avoid\n> changing the behavior of other callers.\n> \n> (In reply to Ehsan Akhgari [:ehsan] from comment #10)\n> > Now the thing is that Thunderbird thinks that it's Composer, so it doesn't\n> > sanitize anything.\n> \n> Scary.\n\nThunderbird has one advantage in that it does not support Javascript out of the box; but do Emails support iFrames?\n\none might argue that CSS can be used to manipulate the user as well, but at the moment I just view it as its biggest advantage over commercial email clients like outlook, and I would like to make it easier for users to harness that power in the future by writing more UI; but first we need to relax the restricted way it is being handled in the editor.\n\n> \n> BTW, last I checked, nsTreeSanitizer failed to reconstruct the text content\n> of <style> correctly when it removed -moz-binding, but I forgot to file that\n> bug. I should go file it now.\n\nWhen I searched through the code I thought my CSS bug was caused by sanitization but I am not sure after debugging it. I think if we can focus on the semantics of\n\nIsVisibleNode \n\nisn't this designed to filter out anonymous nodes (such as CRLF, #text etc)? My thinking (at least in the context of clipboard support) would be that anything that has a visible effect on the way the Gecko engine renders the markup should be treated as \"visible\", especially <style>, but also 'style' attributes.\n\nMy long term goal for composer would be to create more readable / light-weight markup, that would make it easier to create mail templates and consistent layouts.\n\nI will look into the document encoder flags for now and see if there is space for a \"composer\" flag.", "tags": [], "raw_text": "(In reply to Henri Sivonen (:hsivonen) from comment #22)\n> (In reply to Axel Grude from comment #18)\n> > nsDocumentEncoder.cpp#871\n> >   rv = SerializeToStringRecursive(childAsNode, aString, false);\n> >   \n> > the <style> tag is omitted because of IsVisibleNode returning false (line\n> > 465)\n> ...\n> > I think I could write a patch based on this.\n> \n> It should probably be behind yet another document encoder flag to avoid\n> changing the behavior of other callers.\n> \n> (In reply to Ehsan Akhgari [:ehsan] from comment #10)\n> > Now the thing is that Thunderbird thinks that it's Composer, so it doesn't\n> > sanitize anything.\n> \n> Scary.\n\nThunderbird has one advantage in that it does not support Javascript out of the box; but do Emails support iFrames?\n\none might argue that CSS can be used to manipulate the user as well, but at the moment I just view it as its biggest advantage over commercial email clients like outlook, and I would like to make it easier for users to harness that power in the future by writing more UI; but first we need to relax the restricted way it is being handled in the editor.\n\n> \n> BTW, last I checked, nsTreeSanitizer failed to reconstruct the text content\n> of <style> correctly when it removed -moz-binding, but I forgot to file that\n> bug. I should go file it now.\n\nWhen I searched through the code I thought my CSS bug was caused by sanitization but I am not sure after debugging it. I think if we can focus on the semantics of\n\nIsVisibleNode \n\nisn't this designed to filter out anonymous nodes (such as CRLF, #text etc)? My thinking (at least in the context of clipboard support) would be that anything that has a visible effect on the way the Gecko engine renders the markup should be treated as \"visible\", especially <style>, but also 'style' attributes.\n\nMy long term goal for composer would be to create more readable / light-weight markup, that would make it easier to create mail templates and consistent layouts.\n\nI will look into the document encoder flags for now and see if there is space for a \"composer\" flag.", "attachment_id": null}, {"raw_text": "(In reply to Ehsan Akhgari [:ehsan] from comment #21)\n> Hmm, good point.  Currently SkipInvisibleContent is only used for HTML copy\n> and selection.toString().  I'm not entirely sure if this special casing will\n> be OK for selection.toString().  Aryeh, do you know?\n\nSelection.toString() is unspecified, but the idea is to convert to equivalent plaintext, so yes, all display: none should be removed.  It's more or less a concatenation of all selected text nodes with some mangling done; if we didn't skip invisible nodes, their text node contents would get included, which isn't what we want.\n\nFor context on all this, see bug 39098.  I think that we probably don't want to copy these elements' contents for plaintext, but do for HTML.", "attachment_id": null, "tags": [], "bug_id": 671320, "text": "(In reply to Ehsan Akhgari [:ehsan] from comment #21)\n> Hmm, good point.  Currently SkipInvisibleContent is only used for HTML copy\n> and selection.toString().  I'm not entirely sure if this special casing will\n> be OK for selection.toString().  Aryeh, do you know?\n\nSelection.toString() is unspecified, but the idea is to convert to equivalent plaintext, so yes, all display: none should be removed.  It's more or less a concatenation of all selected text nodes with some mangling done; if we didn't skip invisible nodes, their text node contents would get included, which isn't what we want.\n\nFor context on all this, see bug 39098.  I think that we probably don't want to copy these elements' contents for plaintext, but do for HTML.", "is_private": false, "id": 6519694, "count": 25, "author": "ayg@aryeh.name", "creator": "ayg@aryeh.name", "time": "2012-07-31T10:15:17Z", "creation_time": "2012-07-31T10:15:17Z"}, {"is_private": false, "id": 6520439, "count": 26, "creator": "ehsan.akhgari@gmail.com", "creation_time": "2012-07-31T15:48:21Z", "time": "2012-07-31T15:48:21Z", "author": "ehsan.akhgari@gmail.com", "attachment_id": null, "raw_text": "(In reply to comment #24)\n> (In reply to Henri Sivonen (:hsivonen) from comment #22)\n> > (In reply to Axel Grude from comment #18)\n> > > nsDocumentEncoder.cpp#871\n> > >   rv = SerializeToStringRecursive(childAsNode, aString, false);\n> > >   \n> > > the <style> tag is omitted because of IsVisibleNode returning false (line\n> > > 465)\n> > ...\n> > > I think I could write a patch based on this.\n> > \n> > It should probably be behind yet another document encoder flag to avoid\n> > changing the behavior of other callers.\n> > \n> > (In reply to Ehsan Akhgari [:ehsan] from comment #10)\n> > > Now the thing is that Thunderbird thinks that it's Composer, so it doesn't\n> > > sanitize anything.\n> > \n> > Scary.\n> \n> Thunderbird has one advantage in that it does not support Javascript out of the\n> box; but do Emails support iFrames?\n> \n> one might argue that CSS can be used to manipulate the user as well, but at the\n> moment I just view it as its biggest advantage over commercial email clients\n> like outlook, and I would like to make it easier for users to harness that\n> power in the future by writing more UI; but first we need to relax the\n> restricted way it is being handled in the editor.\n\nYou could inject js code into a document by using the -moz-binding CSS property.  I don't know if such js code is subject to the blocking mechanism which is already in place in Thunderbird though.", "text": "(In reply to comment #24)\n> (In reply to Henri Sivonen (:hsivonen) from comment #22)\n> > (In reply to Axel Grude from comment #18)\n> > > nsDocumentEncoder.cpp#871\n> > >   rv = SerializeToStringRecursive(childAsNode, aString, false);\n> > >   \n> > > the <style> tag is omitted because of IsVisibleNode returning false (line\n> > > 465)\n> > ...\n> > > I think I could write a patch based on this.\n> > \n> > It should probably be behind yet another document encoder flag to avoid\n> > changing the behavior of other callers.\n> > \n> > (In reply to Ehsan Akhgari [:ehsan] from comment #10)\n> > > Now the thing is that Thunderbird thinks that it's Composer, so it doesn't\n> > > sanitize anything.\n> > \n> > Scary.\n> \n> Thunderbird has one advantage in that it does not support Javascript out of the\n> box; but do Emails support iFrames?\n> \n> one might argue that CSS can be used to manipulate the user as well, but at the\n> moment I just view it as its biggest advantage over commercial email clients\n> like outlook, and I would like to make it easier for users to harness that\n> power in the future by writing more UI; but first we need to relax the\n> restricted way it is being handled in the editor.\n\nYou could inject js code into a document by using the -moz-binding CSS property.  I don't know if such js code is subject to the blocking mechanism which is already in place in Thunderbird though.", "bug_id": 671320, "tags": []}, {"is_private": false, "id": 6520450, "count": 27, "creator": "neil@httl.net", "time": "2012-07-31T15:50:57Z", "creation_time": "2012-07-31T15:50:57Z", "author": "neil@httl.net", "attachment_id": null, "raw_text": "JS is supposed to be disabled in Composer and message compose documents, but I don't know how you would test that.", "tags": [], "text": "JS is supposed to be disabled in Composer and message compose documents, but I don't know how you would test that.", "bug_id": 671320}]}}}