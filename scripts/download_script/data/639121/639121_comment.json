{"comments": {}, "bugs": {"639121": {"comments": [{"id": 5323742, "raw_text": "View/Page Source shows in windows-1252, even when Shift_JIS is detected by auto-detect and page is shown in Shift_JIS as expected.\nTo obtain Shift_JIS display by View/Page Source, one of next is required.\n- At page display window,\n    Change View/Character Encoding to other than Shift_JIS,\n    then change back to Shift_JIS\n    => Disk Cache, charset: is changed to Shift_JIS from windows-1252\n- At View/Page Source window,\n    Change View/Character Encoding to Shift_JIS\n    => Disk Cache, charset: is changed to Shift_JIS from windows-1252\n\n[Build ID]\n> Build identifier: Mozilla/5.0 (Windows NT 5.1; rv:2.0b12pre) Gecko/20110220 Firefox/4.0b12pre\n[Test Web page]\n> http://bugzilla-attachments.mozilla.gr.jp/attachment.cgi?id=3762\n  Written in Shift_JIS.\n  Meta tag is intentionally commented out for test of auto-detect. \n  <!-- <meta http-equiv=\"Content-Type\" content=\"...; charset=Shift_JIS\"> -->\n[NSPR log(all:5) for load of above Web page]\n> http://bugzilla-attachments.mozilla.gr.jp/attachment.cgi?id=4122\n[Extracted NSPR log lines to show test procedure]\n> http://bugzilla-attachments.mozilla.gr.jp/attachment.cgi?id=4123\n [0] Auto-Detect = Japanese (Japanese is not mandatory. Same with others)\n [1] Cache clear, initial load\n     Page is shown in Shift_JIS.\n     View/Character Encoding : Shift_JIS is shown.\n     At this step, Disk Cache, charset: window-1252 is set.\n     => View/Page Source shows in windows-1252\n [2] Change auto-detect language choice of View/Character Encoding/Auto-Detect\n     Change from Japanese to Chinese etc.\n     Page is still shown in Shift_JIS.\n     View/Character Encoding : Shift_JIS is still shown.\n     At this step, Disk Cache, charset: window-1252 is still set.\n     => View/Page Source shows in windows-1252\n [3] Change charset choice of View/Character Encoding to UTF-8\n     Page is shown in UTF-8\n     View/Character Encoding : UTF-8 is shown.\n     At this step, Disk Cache, charset: UTF-8 is set.\n     => View/Page Source shows in UTF-8\n\nIf this web page is loaded by Fx3, phenomenon of \"double HTTP GET\" is always observed.\n  First HTTP GET for initial load.\n  Second HTTP GET by charset change by auto-detect.\nSame problem as bug 597820?\n\nIn this bug's case, additional resource to which HTTP GET is requested is \"fav icon\" only. Is \"fav iocon\" subresource of this page?\nI don't think \"to hit the network again for the loads we started before finding the <meta>\" is required in this bug's case.\nI think \"save detected charset in Disk Cache by auto-detect\" is sufficient.", "is_private": false, "creation_time": "2011-03-05T07:59:00Z", "text": "View/Page Source shows in windows-1252, even when Shift_JIS is detected by auto-detect and page is shown in Shift_JIS as expected.\nTo obtain Shift_JIS display by View/Page Source, one of next is required.\n- At page display window,\n    Change View/Character Encoding to other than Shift_JIS,\n    then change back to Shift_JIS\n    => Disk Cache, charset: is changed to Shift_JIS from windows-1252\n- At View/Page Source window,\n    Change View/Character Encoding to Shift_JIS\n    => Disk Cache, charset: is changed to Shift_JIS from windows-1252\n\n[Build ID]\n> Build identifier: Mozilla/5.0 (Windows NT 5.1; rv:2.0b12pre) Gecko/20110220 Firefox/4.0b12pre\n[Test Web page]\n> http://bugzilla-attachments.mozilla.gr.jp/attachment.cgi?id=3762\n  Written in Shift_JIS.\n  Meta tag is intentionally commented out for test of auto-detect. \n  <!-- <meta http-equiv=\"Content-Type\" content=\"...; charset=Shift_JIS\"> -->\n[NSPR log(all:5) for load of above Web page]\n> http://bugzilla-attachments.mozilla.gr.jp/attachment.cgi?id=4122\n[Extracted NSPR log lines to show test procedure]\n> http://bugzilla-attachments.mozilla.gr.jp/attachment.cgi?id=4123\n [0] Auto-Detect = Japanese (Japanese is not mandatory. Same with others)\n [1] Cache clear, initial load\n     Page is shown in Shift_JIS.\n     View/Character Encoding : Shift_JIS is shown.\n     At this step, Disk Cache, charset: window-1252 is set.\n     => View/Page Source shows in windows-1252\n [2] Change auto-detect language choice of View/Character Encoding/Auto-Detect\n     Change from Japanese to Chinese etc.\n     Page is still shown in Shift_JIS.\n     View/Character Encoding : Shift_JIS is still shown.\n     At this step, Disk Cache, charset: window-1252 is still set.\n     => View/Page Source shows in windows-1252\n [3] Change charset choice of View/Character Encoding to UTF-8\n     Page is shown in UTF-8\n     View/Character Encoding : UTF-8 is shown.\n     At this step, Disk Cache, charset: UTF-8 is set.\n     => View/Page Source shows in UTF-8\n\nIf this web page is loaded by Fx3, phenomenon of \"double HTTP GET\" is always observed.\n  First HTTP GET for initial load.\n  Second HTTP GET by charset change by auto-detect.\nSame problem as bug 597820?\n\nIn this bug's case, additional resource to which HTTP GET is requested is \"fav icon\" only. Is \"fav iocon\" subresource of this page?\nI don't think \"to hit the network again for the loads we started before finding the <meta>\" is required in this bug's case.\nI think \"save detected charset in Disk Cache by auto-detect\" is sufficient.", "creator": "m-wada@usa.com", "time": "2011-03-05T07:59:00Z", "count": 0, "tags": [], "bug_id": 639121, "attachment_id": null, "author": "m-wada@usa.com"}, {"time": "2011-03-05T08:06:17Z", "tags": [], "count": 1, "creator": "m-wada@usa.com", "bug_id": 639121, "is_private": false, "creation_time": "2011-03-05T08:06:17Z", "text": "Note:\nmozilla.gr.jp sends the test page with next header, as bugzillla.mozilla.org does do for attachment of a bug with no charset specification in mime-type.\n> Content-Type: text/html; charset=; name=\"testcase.html\"", "id": 5323744, "raw_text": "Note:\nmozilla.gr.jp sends the test page with next header, as bugzillla.mozilla.org does do for attachment of a bug with no charset specification in mime-type.\n> Content-Type: text/html; charset=; name=\"testcase.html\"", "attachment_id": null, "author": "m-wada@usa.com"}, {"author": "bzbarsky@mit.edu", "attachment_id": null, "bug_id": 639121, "creator": "bzbarsky@mit.edu", "tags": [], "time": "2011-03-07T18:00:20Z", "count": 2, "text": "Hmm.  We almost certainly don't run the charset sniffer for the view-source load, right?\n\nArguably, we should store the sniffed charset in the shentry....\n\n> Same problem as bug 597820?\n\nThe double-get thing?  No.", "is_private": false, "creation_time": "2011-03-07T18:00:20Z", "raw_text": "Hmm.  We almost certainly don't run the charset sniffer for the view-source load, right?\n\nArguably, we should store the sniffed charset in the shentry....\n\n> Same problem as bug 597820?\n\nThe double-get thing?  No.", "id": 5327539}, {"author": "hsivonen@mozilla.com", "count": 3, "creator": "hsivonen@mozilla.com", "tags": [], "bug_id": 639121, "id": 5330373, "raw_text": "(In reply to comment #2)\n> Hmm.  We almost certainly don't run the charset sniffer for the view-source\n> load, right?\n\nI don't know what the current code does. For the new code, I was planning on treating view-source: GETs like http: POSTs: Sniffing only the first 1024 bytes and not allowing reloads. Does that make sense as the plan going forward?\n\n> Arguably, we should store the sniffed charset in the shentry....\n\nI had expected the charset to go into the history entry already, but I hadn't tested. :-(", "creation_time": "2011-03-08T17:09:21Z", "text": "(In reply to comment #2)\n> Hmm.  We almost certainly don't run the charset sniffer for the view-source\n> load, right?\n\nI don't know what the current code does. For the new code, I was planning on treating view-source: GETs like http: POSTs: Sniffing only the first 1024 bytes and not allowing reloads. Does that make sense as the plan going forward?\n\n> Arguably, we should store the sniffed charset in the shentry....\n\nI had expected the charset to go into the history entry already, but I hadn't tested. :-(", "attachment_id": null, "time": "2011-03-08T17:09:21Z", "is_private": false}, {"raw_text": "> Does that make sense as the plan going forward?\n\nYes, but imo we should be propagating the charset that was used to view the page to view-source, which will look like a channel charset to the parser...\n\n> I had expected the charset to go into the history entry already\n\nDoesn't seem to.\n\nI think the right fix to this bug is to store the charset in the shentry and propagate it to the view-source load.", "id": 5330503, "text": "> Does that make sense as the plan going forward?\n\nYes, but imo we should be propagating the charset that was used to view the page to view-source, which will look like a channel charset to the parser...\n\n> I had expected the charset to go into the history entry already\n\nDoesn't seem to.\n\nI think the right fix to this bug is to store the charset in the shentry and propagate it to the view-source load.", "creation_time": "2011-03-08T17:42:23Z", "bug_id": 639121, "count": 4, "tags": [], "creator": "bzbarsky@mit.edu", "author": "bzbarsky@mit.edu", "is_private": false, "time": "2011-03-08T17:42:23Z", "attachment_id": null}]}}}