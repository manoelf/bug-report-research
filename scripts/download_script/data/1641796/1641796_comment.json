{"bugs": {"1641796": {"comments": [{"bug_id": 1641796, "count": 0, "tags": [], "time": "2020-05-29T09:23:47Z", "attachment_id": null, "text": "Follow up to Bug 1621337.\n\nThis was initially spotted while reviewing Bug 1621338. If you have a debugger opened on a page with service workers, reloading the page will make the service worker sources disappear.\n\n### STRs\nWe now support service workers in the target list for content toolboxes. But we don't handle top level target navigation correctly.\n\nImagine you have 2 service workers, sw-a.js for domain-a.com, sw-b.js for domain-b.com.\nAnd imagine both workers (and registrations) are already available when the toolbox starts.\nIf you start listening for service worker targets while the toolbox debugs a tab on domain-a.com, the target list will filter out `sw-b.js` and make call the onTargetAvailable callback for `sw-a.js`. But if you navigate to domain-b.com, then `sw-a.js` is no longer relevant but `sw-b.js` becomes relevant! However in terms of real \"targets\" no target has been created or destroyed. \n\n### Potential solutions\n\nIt's not completely clear to me how much of this should be handled by the target list and how much should be handled by the consumers. \n\n#### Navigation (target-list)\n\nFor the navigation scenario above, it's pretty clear that target list should handle this complexity. Which means that when we navigate, we should call onTargetDestroyed for all the service worker targets that no longer match the current target's domain, and call onTargetAvailable for the ones which now match the domain.\n\n#### Reload (target-list or consumer?)\n\nBut what about a regular reload scenario? In the case of the debugger, the whole source tree is cleared when navigating. Regular sources that are linked to the window lifecycle will be recreated and will populate the debugger. But the service worker is not created or destroyed here. Here I see two options:\n- target list could go a step further and call onTargetDestroyed for all service worker targets on will-navigate, and then call onTargetAvailable on navigate\n- or the panel could preserve the service worker targets, and trust that onTargetDestroyed/Available will be called in case there was a real navigation and the list of targets corresponding to the top target actually changed", "raw_text": "Follow up to Bug 1621337.\n\nThis was initially spotted while reviewing Bug 1621338. If you have a debugger opened on a page with service workers, reloading the page will make the service worker sources disappear.\n\n### STRs\nWe now support service workers in the target list for content toolboxes. But we don't handle top level target navigation correctly.\n\nImagine you have 2 service workers, sw-a.js for domain-a.com, sw-b.js for domain-b.com.\nAnd imagine both workers (and registrations) are already available when the toolbox starts.\nIf you start listening for service worker targets while the toolbox debugs a tab on domain-a.com, the target list will filter out `sw-b.js` and make call the onTargetAvailable callback for `sw-a.js`. But if you navigate to domain-b.com, then `sw-a.js` is no longer relevant but `sw-b.js` becomes relevant! However in terms of real \"targets\" no target has been created or destroyed. \n\n### Potential solutions\n\nIt's not completely clear to me how much of this should be handled by the target list and how much should be handled by the consumers. \n\n#### Navigation (target-list)\n\nFor the navigation scenario above, it's pretty clear that target list should handle this complexity. Which means that when we navigate, we should call onTargetDestroyed for all the service worker targets that no longer match the current target's domain, and call onTargetAvailable for the ones which now match the domain.\n\n#### Reload (target-list or consumer?)\n\nBut what about a regular reload scenario? In the case of the debugger, the whole source tree is cleared when navigating. Regular sources that are linked to the window lifecycle will be recreated and will populate the debugger. But the service worker is not created or destroyed here. Here I see two options:\n- target list could go a step further and call onTargetDestroyed for all service worker targets on will-navigate, and then call onTargetAvailable on navigate\n- or the panel could preserve the service worker targets, and trust that onTargetDestroyed/Available will be called in case there was a real navigation and the list of targets corresponding to the top target actually changed", "is_private": false, "creator": "jdescottes@mozilla.com", "id": 14851181, "creation_time": "2020-05-29T09:23:47Z", "author": "jdescottes@mozilla.com"}, {"text": "Created attachment 9152650\nBug 1641796 - Emit onTargetDestroyed/Available for serviceworker targets when navigating with localTab toolbox", "raw_text": "", "is_private": false, "author": "jdescottes@mozilla.com", "id": 14851184, "bug_id": 1641796, "attachment_id": 9152650, "creator": "jdescottes@mozilla.com", "creation_time": "2020-05-29T09:27:01Z", "count": 1, "tags": [], "time": "2020-05-29T09:27:01Z"}, {"creation_time": "2020-05-29T10:17:44Z", "creator": "release-mgmt-account-bot@mozilla.tld", "tags": [], "count": 2, "time": "2020-05-29T10:17:44Z", "is_private": false, "text": "[Bugbug](https://github.com/mozilla/bugbug/) thinks this bug should belong to this component, but please revert this change in case of error.", "raw_text": "[Bugbug](https://github.com/mozilla/bugbug/) thinks this bug should belong to this component, but please revert this change in case of error.", "author": "release-mgmt-account-bot@mozilla.tld", "id": 14851310, "bug_id": 1641796, "attachment_id": null}, {"attachment_id": 9153451, "bug_id": 1641796, "id": 14858190, "author": "jdescottes@mozilla.com", "text": "Created attachment 9153451\nBug 1641796 - (other approach) Emit onTargetDestroyed/Available for serviceworker targets when navigating with localTab toolbox", "raw_text": "", "is_private": false, "time": "2020-06-02T15:50:28Z", "count": 3, "tags": [], "creator": "jdescottes@mozilla.com", "creation_time": "2020-06-02T15:50:28Z"}, {"creator": "jdescottes@mozilla.com", "creation_time": "2020-06-10T08:47:29Z", "count": 4, "tags": [], "time": "2020-06-10T08:47:29Z", "text": "Created attachment 9155546\nBug 1641796 - Add tests for serviceworker navigation in target list\n\nDepends on D77425", "raw_text": "Depends on D77425", "is_private": false, "author": "jdescottes@mozilla.com", "id": 14873596, "bug_id": 1641796, "attachment_id": 9155546}, {"text": "Created attachment 9155554\nBug 1641796 - Add a debugger test for service worker sources on page reload\n\nDepends on D79053", "raw_text": "Depends on D79053", "is_private": false, "creator": "jdescottes@mozilla.com", "id": 14873622, "creation_time": "2020-06-10T09:05:15Z", "author": "jdescottes@mozilla.com", "count": 5, "bug_id": 1641796, "tags": [], "time": "2020-06-10T09:05:15Z", "attachment_id": 9155554}, {"creator": "jdescottes@mozilla.com", "creation_time": "2020-06-10T09:05:33Z", "count": 6, "tags": [], "time": "2020-06-10T09:05:33Z", "text": "Created attachment 9155555\nBug 1641796 - Fix parent-intercept skip-if for browser_dbg-windowless-service-workers\n\nDepends on D79059", "raw_text": "Depends on D79059", "is_private": false, "id": 14873623, "author": "jdescottes@mozilla.com", "bug_id": 1641796, "attachment_id": 9155555}, {"tags": [], "count": 7, "bug_id": 1641796, "attachment_id": 9155612, "time": "2020-06-10T11:53:12Z", "is_private": false, "text": "Created attachment 9155612\nBug 1641796 - Swallow listRegistration errors occurring after target destroy\n\nDepends on D79060\nWill fold that with earlier patches when we settle on a solution.\nAdding an additional call to list registrations on navigate triggers a permafailure on \nbrowser_toolbox_window_title_changes.js\nI could fix the test but in theory this can happen with any test involving debugger + reload/navigation.", "raw_text": "Depends on D79060\nWill fold that with earlier patches when we settle on a solution.\nAdding an additional call to list registrations on navigate triggers a permafailure on \nbrowser_toolbox_window_title_changes.js\nI could fix the test but in theory this can happen with any test involving debugger + reload/navigation.", "id": 14873861, "creation_time": "2020-06-10T11:53:12Z", "author": "jdescottes@mozilla.com", "creator": "jdescottes@mozilla.com"}, {"creator": "cpeterson@mozilla.com", "creation_time": "2020-06-11T06:22:49Z", "time": "2020-06-11T06:22:49Z", "count": 8, "tags": [], "author": "cpeterson@mozilla.com", "id": 14875637, "raw_text": "Tracking dt-fission-m2 bugs for Fission Nightly (M6c)", "text": "Tracking dt-fission-m2 bugs for Fission Nightly (M6c)", "is_private": false, "attachment_id": null, "bug_id": 1641796}, {"bug_id": 1641796, "count": 9, "tags": [], "attachment_id": null, "time": "2020-06-11T08:09:22Z", "raw_text": "", "text": "*** Bug 1644746 has been marked as a duplicate of this bug. ***", "is_private": false, "creator": "jdescottes@mozilla.com", "id": 14875729, "creation_time": "2020-06-11T08:09:22Z", "author": "jdescottes@mozilla.com"}, {"id": 14878623, "author": "jdescottes@mozilla.com", "text": "Created attachment 9156271\nBug 1641796 - Add a flag to disable service worker target destruction on navigation\n\nDepends on D77425", "raw_text": "Depends on D77425", "is_private": false, "attachment_id": 9156271, "bug_id": 1641796, "creator": "jdescottes@mozilla.com", "creation_time": "2020-06-12T13:51:48Z", "time": "2020-06-12T13:51:48Z", "count": 10, "tags": []}, {"count": 11, "tags": [], "time": "2020-06-16T08:52:30Z", "creator": "pulsebot@bots.tld", "creation_time": "2020-06-16T08:52:30Z", "bug_id": 1641796, "attachment_id": null, "raw_text": "Pushed by jdescottes@mozilla.com:\nhttps://hg.mozilla.org/integration/autoland/rev/b50762e5da7d\nEmit onTargetDestroyed/Available for serviceworker targets when navigating with localTab toolbox r=ochameau\nhttps://hg.mozilla.org/integration/autoland/rev/c48704eb4d3a\nAdd a flag to disable service worker target destruction on navigation r=ochameau\nhttps://hg.mozilla.org/integration/autoland/rev/37ea8e324248\nAdd tests for serviceworker navigation in target list r=ochameau\nhttps://hg.mozilla.org/integration/autoland/rev/9c56dfb36661\nAdd a debugger test for service worker sources on page reload r=jlast\nhttps://hg.mozilla.org/integration/autoland/rev/82c01676f8d5\nFix parent-intercept skip-if for browser_dbg-windowless-service-workers r=jlast", "text": "Pushed by jdescottes@mozilla.com:\nhttps://hg.mozilla.org/integration/autoland/rev/b50762e5da7d\nEmit onTargetDestroyed/Available for serviceworker targets when navigating with localTab toolbox r=ochameau\nhttps://hg.mozilla.org/integration/autoland/rev/c48704eb4d3a\nAdd a flag to disable service worker target destruction on navigation r=ochameau\nhttps://hg.mozilla.org/integration/autoland/rev/37ea8e324248\nAdd tests for serviceworker navigation in target list r=ochameau\nhttps://hg.mozilla.org/integration/autoland/rev/9c56dfb36661\nAdd a debugger test for service worker sources on page reload r=jlast\nhttps://hg.mozilla.org/integration/autoland/rev/82c01676f8d5\nFix parent-intercept skip-if for browser_dbg-windowless-service-workers r=jlast", "is_private": false, "author": "pulsebot@bots.tld", "id": 14884342}, {"attachment_id": null, "time": "2020-06-16T10:14:06Z", "tags": [], "count": 12, "bug_id": 1641796, "id": 14884463, "creation_time": "2020-06-16T10:14:06Z", "author": "abutkovits@mozilla.com", "creator": "abutkovits@mozilla.com", "is_private": false, "raw_text": "Backed out for causing failure at browser_target_list_service_workers_navigation.js.\n\nBackout link: https://hg.mozilla.org/integration/autoland/rev/6041f73baafa0c6078d40da1b04849fafa996091\n\nPush with failures: https://treeherder.mozilla.org/#/jobs?repo=autoland&selectedTaskRun=eKQs7lg4QBqfCL-Vg5q0ag.0&resultStatus=testfailed%2Cbusted%2Cexception&revision=82c01676f8d5d3882db6652c708016a40762783d\n\nFailure log: https://treeherder.mozilla.org/logviewer.html#/jobs?job_id=306464270&repo=autoland&lineNumber=2759", "text": "Backed out for causing failure at browser_target_list_service_workers_navigation.js.\n\nBackout link: https://hg.mozilla.org/integration/autoland/rev/6041f73baafa0c6078d40da1b04849fafa996091\n\nPush with failures: https://treeherder.mozilla.org/#/jobs?repo=autoland&selectedTaskRun=eKQs7lg4QBqfCL-Vg5q0ag.0&resultStatus=testfailed%2Cbusted%2Cexception&revision=82c01676f8d5d3882db6652c708016a40762783d\n\nFailure log: https://treeherder.mozilla.org/logviewer.html#/jobs?job_id=306464270&repo=autoland&lineNumber=2759"}, {"bug_id": 1641796, "attachment_id": null, "is_private": false, "raw_text": "Sorry about that. Look like it's a TV-only failure, will take a look.", "text": "Sorry about that. Look like it's a TV-only failure, will take a look.", "author": "jdescottes@mozilla.com", "id": 14884489, "tags": [], "count": 13, "time": "2020-06-16T10:29:56Z", "creation_time": "2020-06-16T10:29:56Z", "creator": "jdescottes@mozilla.com"}, {"creation_time": "2020-06-16T14:33:07Z", "creator": "pulsebot@bots.tld", "time": "2020-06-16T14:33:07Z", "tags": [], "count": 14, "author": "pulsebot@bots.tld", "id": 14884924, "is_private": false, "raw_text": "Pushed by jdescottes@mozilla.com:\nhttps://hg.mozilla.org/integration/autoland/rev/bb44988cea52\nEmit onTargetDestroyed/Available for serviceworker targets when navigating with localTab toolbox r=ochameau\nhttps://hg.mozilla.org/integration/autoland/rev/e71faa85ea30\nAdd a flag to disable service worker target destruction on navigation r=ochameau\nhttps://hg.mozilla.org/integration/autoland/rev/ae31f01f2658\nAdd tests for serviceworker navigation in target list r=ochameau\nhttps://hg.mozilla.org/integration/autoland/rev/94c5fe1a7033\nAdd a debugger test for service worker sources on page reload r=jlast\nhttps://hg.mozilla.org/integration/autoland/rev/640d29fc8590\nFix parent-intercept skip-if for browser_dbg-windowless-service-workers r=jlast", "text": "Pushed by jdescottes@mozilla.com:\nhttps://hg.mozilla.org/integration/autoland/rev/bb44988cea52\nEmit onTargetDestroyed/Available for serviceworker targets when navigating with localTab toolbox r=ochameau\nhttps://hg.mozilla.org/integration/autoland/rev/e71faa85ea30\nAdd a flag to disable service worker target destruction on navigation r=ochameau\nhttps://hg.mozilla.org/integration/autoland/rev/ae31f01f2658\nAdd tests for serviceworker navigation in target list r=ochameau\nhttps://hg.mozilla.org/integration/autoland/rev/94c5fe1a7033\nAdd a debugger test for service worker sources on page reload r=jlast\nhttps://hg.mozilla.org/integration/autoland/rev/640d29fc8590\nFix parent-intercept skip-if for browser_dbg-windowless-service-workers r=jlast", "attachment_id": null, "bug_id": 1641796}, {"bug_id": 1641796, "attachment_id": null, "text": "https://hg.mozilla.org/mozilla-central/rev/bb44988cea52\nhttps://hg.mozilla.org/mozilla-central/rev/e71faa85ea30\nhttps://hg.mozilla.org/mozilla-central/rev/ae31f01f2658\nhttps://hg.mozilla.org/mozilla-central/rev/94c5fe1a7033\nhttps://hg.mozilla.org/mozilla-central/rev/640d29fc8590", "raw_text": "https://hg.mozilla.org/mozilla-central/rev/bb44988cea52\nhttps://hg.mozilla.org/mozilla-central/rev/e71faa85ea30\nhttps://hg.mozilla.org/mozilla-central/rev/ae31f01f2658\nhttps://hg.mozilla.org/mozilla-central/rev/94c5fe1a7033\nhttps://hg.mozilla.org/mozilla-central/rev/640d29fc8590", "is_private": false, "author": "nbeleuzu@mozilla.com", "id": 14885959, "count": 15, "tags": ["bugherder"], "time": "2020-06-16T21:52:26Z", "creator": "nbeleuzu@mozilla.com", "creation_time": "2020-06-16T21:52:26Z"}]}}, "comments": {}}