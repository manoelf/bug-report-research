{"bugs": {"654046": {"comments": [{"time": "2011-05-02T05:41:31Z", "id": 5442387, "is_private": false, "raw_text": "STEPS TO REPRODUCE:\n 1. Open two tabs. In one, load a long bug page, e.g.:\n   https://bugzilla.mozilla.org/show_bug.cgi?id=129941\n 2. In View Menu, Page Style submenu, choose \"No Style\"\n 3. Close the tab.\n 4. Ctrl+Shift+T to restore the tab.\n\nEXPECTED RESULTS: Page restored with no style. (As it was just before step 3)\n\nACTUAL RESULTS: While the page is being restored, it's briefly displayed with its styles applied, before the final no-style rendering is settled upon.\n\nMozilla/5.0 (X11; Linux i686; rv:6.0a1) Gecko/20110501 Firefox/6.0a1", "creation_time": "2011-05-02T05:41:31Z", "bug_id": 654046, "tags": [], "author": "dholbert@mozilla.com", "count": 0, "text": "STEPS TO REPRODUCE:\n 1. Open two tabs. In one, load a long bug page, e.g.:\n   https://bugzilla.mozilla.org/show_bug.cgi?id=129941\n 2. In View Menu, Page Style submenu, choose \"No Style\"\n 3. Close the tab.\n 4. Ctrl+Shift+T to restore the tab.\n\nEXPECTED RESULTS: Page restored with no style. (As it was just before step 3)\n\nACTUAL RESULTS: While the page is being restored, it's briefly displayed with its styles applied, before the final no-style rendering is settled upon.\n\nMozilla/5.0 (X11; Linux i686; rv:6.0a1) Gecko/20110501 Firefox/6.0a1", "attachment_id": null, "creator": "dholbert@mozilla.com"}, {"attachment_id": null, "is_private": false, "bug_id": 654046, "creation_time": "2011-05-05T16:54:58Z", "raw_text": "Not a style system bug.  Session restore restores the document and then in the onload handler calls sss_restoreDocument which calls restoreTextDataAndScrolling which does:\n\n  3138     let selectedPageStyle = aBrowser.__SS_restore_pageStyle;\n  3154       Array.forEach(aContent.document.styleSheets, function(aSS) {\n  3155         aSS.disabled = aSS.title && aSS.title != selectedPageStyle;\n  3156       });\n\nwhich is just broken.  This code should just set the selectedStyleSheetSet on the document as soon as it can, and then things will Just Work.", "tags": [], "creator": "bzbarsky@mit.edu", "time": "2011-05-05T16:54:58Z", "author": "bzbarsky@mit.edu", "id": 5451270, "text": "Not a style system bug.  Session restore restores the document and then in the onload handler calls sss_restoreDocument which calls restoreTextDataAndScrolling which does:\n\n  3138     let selectedPageStyle = aBrowser.__SS_restore_pageStyle;\n  3154       Array.forEach(aContent.document.styleSheets, function(aSS) {\n  3155         aSS.disabled = aSS.title && aSS.title != selectedPageStyle;\n  3156       });\n\nwhich is just broken.  This code should just set the selectedStyleSheetSet on the document as soon as it can, and then things will Just Work.", "count": 1}, {"tags": [], "creator": "paul@oshannessy.com", "creation_time": "2011-05-18T00:49:24Z", "bug_id": 654046, "raw_text": "/me didn't write that code\n\nCurrently we loop over document.styleSheets to get the enabled one for media=screen|all. Then we look at frames and do the same.\nhttps://mxr.mozilla.org/mozilla-central/source/browser/components/sessionstore/src/nsSessionStore.js#1999\n\nSo you're saying we can instead just store document.selectedStyleSheetSet and then set that at some point after load (not waiting for all the way loaded like we do now)?", "is_private": false, "attachment_id": null, "text": "/me didn't write that code\n\nCurrently we loop over document.styleSheets to get the enabled one for media=screen|all. Then we look at frames and do the same.\nhttps://mxr.mozilla.org/mozilla-central/source/browser/components/sessionstore/src/nsSessionStore.js#1999\n\nSo you're saying we can instead just store document.selectedStyleSheetSet and then set that at some point after load (not waiting for all the way loaded like we do now)?", "count": 2, "id": 5476216, "time": "2011-05-18T00:49:24Z", "author": "paul@oshannessy.com"}, {"tags": [], "raw_text": "That's a good question.\n\nThe current sessionstore _getSelectedPageStyle code will return the title of the first non-disabled stylesheet with a nonempty title that applies to the screen or all medium... if you ignore media queries, etc.  If media queries are present, it'll screw up.\n\ndocument.selectedStyleSheetSet will return a string S which has the following property: if there are sheets with titles that are currently enabled, they all have the title S.  If there are no enabled sheets with titles, it will return the empty string.  If there are sheets that are enabled and have different nonempty titles it will return null.\n\nSo it has behavior that's pretty different from the current sessionstore behavior.  However I think it's the desired behavior here.\n\nSo yes, I think you should just save document.selectedStyleSheetSet (plus whatever you want to do for subframes) and then on restore just assign to selectedStyleSheetSet.  That assignment can happen any time after the document is the document for the page being loaded (as opposed to about:blank); it does not have to wait for load end.  In fact, the earlier the better (because then we will prioritize loading sheets for the \"right\" stylesheet set over other ones).", "creation_time": "2011-05-18T01:05:40Z", "bug_id": 654046, "is_private": false, "id": 5476240, "time": "2011-05-18T01:05:40Z", "creator": "bzbarsky@mit.edu", "attachment_id": null, "count": 3, "text": "That's a good question.\n\nThe current sessionstore _getSelectedPageStyle code will return the title of the first non-disabled stylesheet with a nonempty title that applies to the screen or all medium... if you ignore media queries, etc.  If media queries are present, it'll screw up.\n\ndocument.selectedStyleSheetSet will return a string S which has the following property: if there are sheets with titles that are currently enabled, they all have the title S.  If there are no enabled sheets with titles, it will return the empty string.  If there are sheets that are enabled and have different nonempty titles it will return null.\n\nSo it has behavior that's pretty different from the current sessionstore behavior.  However I think it's the desired behavior here.\n\nSo yes, I think you should just save document.selectedStyleSheetSet (plus whatever you want to do for subframes) and then on restore just assign to selectedStyleSheetSet.  That assignment can happen any time after the document is the document for the page being loaded (as opposed to about:blank); it does not have to wait for load end.  In fact, the earlier the better (because then we will prioritize loading sheets for the \"right\" stylesheet set over other ones).", "author": "bzbarsky@mit.edu"}]}}, "comments": {}}