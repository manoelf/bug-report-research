{"comments": {}, "bugs": {"678698": {"comments": [{"is_private": false, "creation_time": "2011-08-13T08:18:24Z", "id": 5651547, "bug_id": 678698, "author": "ziga.seilnacht@gmail.com", "count": 0, "text": "User Agent: Mozilla/5.0 (Windows NT 6.1; WOW64; rv:6.0) Gecko/20100101 Firefox/6.0\nBuild ID: 20110811165603\n\nSteps to reproduce:\n\nI'm running multiple channel builds of Firefox on a test machine to see when the memory usage will improve enough that I can upgrade Firefox 3.6 on aging laptops. The test machine is headless, Firefox is always started in a remote desktop session.  \n\nI'm checking idle memory usage by opening Firefox and leaving it idle on the default about:home page. Each channel build runs with a separate and basically empty profile by running:\n\n    <specific\\path\\to>firefox.exe -no-remote -P <channelName>\n\nThe test profiles have only Addblock plus add-on and Flash plugin installed, but I can reproduce the behavior with a completely fresh profile, without any add-on. The about:home page is not displaying any demanding content, it happens even with the newsletter signup snippet.\n\n\nActual results:\n\nIn the last few days I've observed that the CPU load on the Beta and Aurora channel doesn't drop after startup, it stays at around 5% CPU load no matter how long I leave the Firefox running. The same thing happens even with a completely fresh profile. The test machine is fairly beefy (Xeon W3565 with 12GB of RAM and a SSD for %ProgramFiles% and %LocalAppData%) so it should not be the cause of the problem.\n\n\nExpected results:\n\nThe CPU load should drop to basically 0% after Firefox startup. The current behavior would be especially problematic on laptops.\n\nPlease let me know if you need any further information.", "creator": "ziga.seilnacht@gmail.com", "tags": [], "attachment_id": null, "raw_text": "User Agent: Mozilla/5.0 (Windows NT 6.1; WOW64; rv:6.0) Gecko/20100101 Firefox/6.0\nBuild ID: 20110811165603\n\nSteps to reproduce:\n\nI'm running multiple channel builds of Firefox on a test machine to see when the memory usage will improve enough that I can upgrade Firefox 3.6 on aging laptops. The test machine is headless, Firefox is always started in a remote desktop session.  \n\nI'm checking idle memory usage by opening Firefox and leaving it idle on the default about:home page. Each channel build runs with a separate and basically empty profile by running:\n\n    <specific\\path\\to>firefox.exe -no-remote -P <channelName>\n\nThe test profiles have only Addblock plus add-on and Flash plugin installed, but I can reproduce the behavior with a completely fresh profile, without any add-on. The about:home page is not displaying any demanding content, it happens even with the newsletter signup snippet.\n\n\nActual results:\n\nIn the last few days I've observed that the CPU load on the Beta and Aurora channel doesn't drop after startup, it stays at around 5% CPU load no matter how long I leave the Firefox running. The same thing happens even with a completely fresh profile. The test machine is fairly beefy (Xeon W3565 with 12GB of RAM and a SSD for %ProgramFiles% and %LocalAppData%) so it should not be the cause of the problem.\n\n\nExpected results:\n\nThe CPU load should drop to basically 0% after Firefox startup. The current behavior would be especially problematic on laptops.\n\nPlease let me know if you need any further information.", "time": "2011-08-13T08:18:24Z"}, {"bug_id": 678698, "id": 5656115, "author": "ziga.seilnacht@gmail.com", "count": 1, "text": "Hm, it looks like this was an issue with the about:home page itself, I could not reproduce the increased load yesterday or today, did the about:home snippet change lately?\n\nI did manage to reproduce it on Sunday on my 32bit Vista laptop, so it wasn't specific to the test machine. The problem was much more noticeable if I started multiple -no-remote Firefox processes, each with its own fresh profile (e.g. the processor load of each Firefox process was around 5% with 3 concurrent processes running and around 10% with 10 concurrent -no-remote processes running).", "time": "2011-08-16T05:31:22Z", "raw_text": "Hm, it looks like this was an issue with the about:home page itself, I could not reproduce the increased load yesterday or today, did the about:home snippet change lately?\n\nI did manage to reproduce it on Sunday on my 32bit Vista laptop, so it wasn't specific to the test machine. The problem was much more noticeable if I started multiple -no-remote Firefox processes, each with its own fresh profile (e.g. the processor load of each Firefox process was around 5% with 3 concurrent processes running and around 10% with 10 concurrent -no-remote processes running).", "is_private": false, "creation_time": "2011-08-16T05:31:22Z", "creator": "ziga.seilnacht@gmail.com", "tags": [], "attachment_id": null}, {"time": "2011-08-20T23:44:07Z", "raw_text": "I experienced this issue running the Firefox 7 beta on a quad-core Mac Pro with Snow Leopard. CPU usage hovers between 75% and 90% when I have an about:home tab active. The CPU usage drops down to about 2% when I switch to a different tab.", "attachment_id": null, "tags": [], "creator": "segphault@arstechnica.com", "text": "I experienced this issue running the Firefox 7 beta on a quad-core Mac Pro with Snow Leopard. CPU usage hovers between 75% and 90% when I have an about:home tab active. The CPU usage drops down to about 2% when I switch to a different tab.", "count": 2, "author": "segphault@arstechnica.com", "id": 5667591, "bug_id": 678698, "is_private": false, "creation_time": "2011-08-20T23:44:07Z"}, {"attachment_id": null, "tags": [], "creator": "fmdevelopertim@gmail.com", "creation_time": "2011-08-21T02:32:23Z", "is_private": false, "raw_text": "Ryan -> Do you have multiple instances running like Ziga was? Can you reproduce the issue with Firefox running in safe mode?", "time": "2011-08-21T02:32:23Z", "author": "fmdevelopertim@gmail.com", "count": 3, "text": "Ryan -> Do you have multiple instances running like Ziga was? Can you reproduce the issue with Firefox running in safe mode?", "id": 5667685, "bug_id": 678698}, {"time": "2011-08-21T02:36:51Z", "raw_text": "Can someone who is seeing the problem on OS X install a shark build (e.g. ftp://ftp.mozilla.org/pub/firefox/nightly/latest-mozilla-aurora/firefox-8.0a2.en-US.mac-shark.dmg ) and then, when displaying about:home, do a Sample Process in Activity Monitor? You can then paste the result of that here (or put it in a text file and then attach that here).", "attachment_id": null, "tags": [], "creator": "joe@drew.ca", "text": "Can someone who is seeing the problem on OS X install a shark build (e.g. ftp://ftp.mozilla.org/pub/firefox/nightly/latest-mozilla-aurora/firefox-8.0a2.en-US.mac-shark.dmg ) and then, when displaying about:home, do a Sample Process in Activity Monitor? You can then paste the result of that here (or put it in a text file and then attach that here).", "count": 4, "author": "joe@drew.ca", "bug_id": 678698, "id": 5667688, "creation_time": "2011-08-21T02:36:51Z", "is_private": false}, {"tags": [], "time": "2011-08-21T03:49:36Z", "attachment_id": 554693, "raw_text": "I've attached the process sample output, generated from the linked Shark build launched with the -safe-mode flag on OS X.", "bug_id": 678698, "id": 5667733, "creation_time": "2011-08-21T03:49:36Z", "is_private": false, "creator": "segphault@arstechnica.com", "author": "segphault@arstechnica.com", "count": 5, "text": "Created attachment 554693\nProcess sample from nightly build\n\nI've attached the process sample output, generated from the linked Shark build launched with the -safe-mode flag on OS X."}, {"bug_id": 678698, "id": 5678416, "author": "bzbarsky@mit.edu", "count": 6, "text": "That sample shows that some time is spent running a setTimeout and a bunch more is spent running script and drawing to a canvas from what looks like a requestAnimationFrame callback.\n\nBut as far as I can tell, neither one of those is used by about:home by default, unless snippets can inject script?", "time": "2011-08-25T18:44:52Z", "raw_text": "That sample shows that some time is spent running a setTimeout and a bunch more is spent running script and drawing to a canvas from what looks like a requestAnimationFrame callback.\n\nBut as far as I can tell, neither one of those is used by about:home by default, unless snippets can inject script?", "creation_time": "2011-08-25T18:44:52Z", "is_private": false, "creator": "bzbarsky@mit.edu", "tags": [], "attachment_id": null}, {"attachment_id": null, "tags": [], "creator": "mak@mozilla.com", "is_private": false, "creation_time": "2011-08-25T18:49:31Z", "time": "2011-08-25T18:49:31Z", "raw_text": "I know recently Runfield demo has been pushed to some users as an experiment, in a snippet.", "author": "mak@mozilla.com", "text": "I know recently Runfield demo has been pushed to some users as an experiment, in a snippet.", "count": 7, "id": 5678431, "bug_id": 678698}, {"time": "2011-08-25T21:14:43Z", "raw_text": "I don't know if it helps, but I observed the originally described problem again over the last weekend. I made sure that Runfield was not the snippet that was displayed on about:home, because it looked like it could be resource heavy. I managed to reproduce the problem without any addons, the easiest way to see it was if I ran multiple -no-remote processes, each with its own fresh profile. I caught a few stack traces of the main thread with Process Explorer when the CPU usage was high, maybe they'll be of some help.", "author": "ziga.seilnacht@gmail.com", "count": 8, "text": "Created attachment 555838\nA few Windows stack traces caught by Process Explorer\n\nI don't know if it helps, but I observed the originally described problem again over the last weekend. I made sure that Runfield was not the snippet that was displayed on about:home, because it looked like it could be resource heavy. I managed to reproduce the problem without any addons, the easiest way to see it was if I ran multiple -no-remote processes, each with its own fresh profile. I caught a few stack traces of the main thread with Process Explorer when the CPU usage was high, maybe they'll be of some help.", "id": 5678855, "bug_id": 678698, "attachment_id": 555838, "tags": [], "creator": "ziga.seilnacht@gmail.com", "creation_time": "2011-08-25T21:14:43Z", "is_private": false}, {"bug_id": 678698, "id": 5679619, "text": "Every single one of those stack traces is under canvas drawImage called from JS, with the JS called from the refresh driver directly.  The only JS the refresh driver should be calling directly is requestAnimationFrame callbacks.", "count": 9, "author": "bzbarsky@mit.edu", "time": "2011-08-26T01:56:36Z", "raw_text": "Every single one of those stack traces is under canvas drawImage called from JS, with the JS called from the refresh driver directly.  The only JS the refresh driver should be calling directly is requestAnimationFrame callbacks.", "is_private": false, "creation_time": "2011-08-26T01:56:36Z", "creator": "bzbarsky@mit.edu", "tags": [], "attachment_id": null}, {"creator": "foss@atlastechnologiesinc.com", "author": "foss@atlastechnologiesinc.com", "text": "Created attachment 556278\nSample taken from aurora nightly\n\nThis is a performance sample taken from a nightly shark build just after opening to about:home. Indeed, runescape was recently pushed but it was not shown this time, instead i see a link to webifyme. Several add-ons are installed, but I get the same result with them disabled.\n\nHope this helps.", "count": 10, "bug_id": 678698, "id": 5682722, "creation_time": "2011-08-27T17:28:36Z", "is_private": false, "time": "2011-08-27T17:28:36Z", "attachment_id": 556278, "raw_text": "This is a performance sample taken from a nightly shark build just after opening to about:home. Indeed, runescape was recently pushed but it was not shown this time, instead i see a link to webifyme. Several add-ons are installed, but I get the same result with them disabled.\n\nHope this helps.", "tags": []}, {"bug_id": 678698, "id": 5682749, "author": "ziga.seilnacht@gmail.com", "text": "Created attachment 556283\nStandalone about:home and possible fix\n\nI saw this issue again yesterday and dug a bit deeper. I noticed this in chrome://browser/content/aboutHome.js::showSnippets():\n\n      // Scripts injected by innerHTML are inactive, so we have to relocate them\n      // through DOM manipulation to activate their contents.\n      Array.forEach(snippetsElt.getElementsByTagName(\"script\"), function(elt) {\n        let relocatedScript = document.createElement(\"script\");\n        relocatedScript.type = \"text/javascript;version=1.8\";\n        relocatedScript.text = elt.text;\n        elt.parentNode.replaceChild(relocatedScript, elt);\n      });\n\nIIUC, it does this to run the following script included in the snippets page:\n\n<script type=\"text/javascript\">\nvar snippet_container = document.getElementById('snippetContainer');\nvar snippets = snippet_container.getElementsByClassName('snippet');\nif (snippets.length > 0) {\n    var show_snippet = snippets[Math.floor(Math.random()*snippets.length)];\n    show_snippet.style.display = 'block';\n    activateSnippetsButtonClick(show_snippet);\n} else {\n    localStorage['snippets'] = '';\n    showSnippets();\n}\n</script>\n\nUnfortunately, showSnippets() consequently also loads the Runfield demo, even if some other snippet is chosen to be shown at the end. So the observed high CPU usage is probably caused by the Runfield demo, sometimes running in the background.\n\nMaybe a better solution for aboutHome.js::showSnippets() would be to randomly select and load a signle snippet by itself, without the help of the script in the snippets page.\n\nSome other observations:\n\n- The Runfield snippet as currently served is broken, one of the script tags\n  is missing a javascript // comment token in front of the the cdata ]]> CDEnd\n  token. I don't understand why it works sometimes in the about:home page, if I\n  inject the unmodified snippets page into a normal page served over http I get\n  syntax errors. I think this is the reason why I couldn't always reproduce\n  this bug.\n\n- Should the SNIPPETS_UPDATE_INTERVAL_MS constant be changed into a about:config\n  preference? The \"browser.aboutHomeSnippets.updateUrl\" preference was useless\n  for experimenting with that interval being hardcoded.\n\n- The Runfield snippet is being served to Beta audience, I don't know if that\n  is intentonal. (The snippet text says \"Play Runfield and experience the\n  latest HTML5 innovations in Aurora.\"). Note that mozRequestAnimationFrame\n  doesn't seem to be throttled in minimized windows on current Beta (7.0),\n  while it is throttled in Aurora.\n\n- The Runfield snippet causes high CPU load when it is loaded in the\n  foreground tab, which is somewhat expected. If I then switch to a\n  different tab (or minimize the browser window on Aurora), the CPU usage\n  drops, which is commendable. However, if I switch to a different maximized\n  window, even on Aurora, the CPU usage remains high. I guess this could be bug\n  646937. Could the mozRequestAnimationFrame also be throttled when the window\n  receives WM_SHOWWINDOW message with SW_OTHERZOOM lParam?\n\n- The Personas snippet loads an iframe over http protocol into what is\n  otherwise a secure https page.\n\nThe aboutHome.html file in the attached zip folder contains a standalone\nversion of about:home with a fixed snippets page (Runfield syntax error). It\nreliably reproduces the problem described in this bug for me.\n\nThe aboutHomeModified.html file contains a modified showSnippets() function\nwhich loads a single snippet, consequently the CPU usage stays low unless\nthe Runfield snippet is chosen to be shown on about:home.", "count": 11, "raw_text": "I saw this issue again yesterday and dug a bit deeper. I noticed this in chrome://browser/content/aboutHome.js::showSnippets():\n\n      // Scripts injected by innerHTML are inactive, so we have to relocate them\n      // through DOM manipulation to activate their contents.\n      Array.forEach(snippetsElt.getElementsByTagName(\"script\"), function(elt) {\n        let relocatedScript = document.createElement(\"script\");\n        relocatedScript.type = \"text/javascript;version=1.8\";\n        relocatedScript.text = elt.text;\n        elt.parentNode.replaceChild(relocatedScript, elt);\n      });\n\nIIUC, it does this to run the following script included in the snippets page:\n\n<script type=\"text/javascript\">\nvar snippet_container = document.getElementById('snippetContainer');\nvar snippets = snippet_container.getElementsByClassName('snippet');\nif (snippets.length > 0) {\n    var show_snippet = snippets[Math.floor(Math.random()*snippets.length)];\n    show_snippet.style.display = 'block';\n    activateSnippetsButtonClick(show_snippet);\n} else {\n    localStorage['snippets'] = '';\n    showSnippets();\n}\n</script>\n\nUnfortunately, showSnippets() consequently also loads the Runfield demo, even if some other snippet is chosen to be shown at the end. So the observed high CPU usage is probably caused by the Runfield demo, sometimes running in the background.\n\nMaybe a better solution for aboutHome.js::showSnippets() would be to randomly select and load a signle snippet by itself, without the help of the script in the snippets page.\n\nSome other observations:\n\n- The Runfield snippet as currently served is broken, one of the script tags\n  is missing a javascript // comment token in front of the the cdata ]]> CDEnd\n  token. I don't understand why it works sometimes in the about:home page, if I\n  inject the unmodified snippets page into a normal page served over http I get\n  syntax errors. I think this is the reason why I couldn't always reproduce\n  this bug.\n\n- Should the SNIPPETS_UPDATE_INTERVAL_MS constant be changed into a about:config\n  preference? The \"browser.aboutHomeSnippets.updateUrl\" preference was useless\n  for experimenting with that interval being hardcoded.\n\n- The Runfield snippet is being served to Beta audience, I don't know if that\n  is intentonal. (The snippet text says \"Play Runfield and experience the\n  latest HTML5 innovations in Aurora.\"). Note that mozRequestAnimationFrame\n  doesn't seem to be throttled in minimized windows on current Beta (7.0),\n  while it is throttled in Aurora.\n\n- The Runfield snippet causes high CPU load when it is loaded in the\n  foreground tab, which is somewhat expected. If I then switch to a\n  different tab (or minimize the browser window on Aurora), the CPU usage\n  drops, which is commendable. However, if I switch to a different maximized\n  window, even on Aurora, the CPU usage remains high. I guess this could be bug\n  646937. Could the mozRequestAnimationFrame also be throttled when the window\n  receives WM_SHOWWINDOW message with SW_OTHERZOOM lParam?\n\n- The Personas snippet loads an iframe over http protocol into what is\n  otherwise a secure https page.\n\nThe aboutHome.html file in the attached zip folder contains a standalone\nversion of about:home with a fixed snippets page (Runfield syntax error). It\nreliably reproduces the problem described in this bug for me.\n\nThe aboutHomeModified.html file contains a modified showSnippets() function\nwhich loads a single snippet, consequently the CPU usage stays low unless\nthe Runfield snippet is chosen to be shown on about:home.", "time": "2011-08-27T17:56:41Z", "creation_time": "2011-08-27T17:56:41Z", "is_private": false, "creator": "ziga.seilnacht@gmail.com", "tags": [], "attachment_id": 556283}, {"tags": [], "attachment_id": 556316, "creation_time": "2011-08-27T22:58:51Z", "is_private": false, "creator": "ziga.seilnacht@gmail.com", "time": "2011-08-27T22:58:51Z", "raw_text": "Here is a possible patch for this issue, it worked in my limited testing with standalone about:home. Note that I haven't actually built it or ran the added tests, I don't know how to do that yet. I'm also unsure if I used the createContextualFragment correctly, the draft specification is not entirely clear how it is supposed to work, but it seems to work in practice and it looks better than the previous script movement hack.", "bug_id": 678698, "id": 5682991, "author": "ziga.seilnacht@gmail.com", "text": "Created attachment 556316\nuntested patch\n\nHere is a possible patch for this issue, it worked in my limited testing with standalone about:home. Note that I haven't actually built it or ran the added tests, I don't know how to do that yet. I'm also unsure if I used the createContextualFragment correctly, the draft specification is not entirely clear how it is supposed to work, but it seems to work in practice and it looks better than the previous script movement hack.", "count": 12}, {"attachment_id": null, "tags": [], "creator": "mcastelluccio@mozilla.com", "creation_time": "2012-08-19T01:12:36Z", "is_private": false, "raw_text": "Ziga, if you think your patch is ready, you should ask for a review.", "time": "2012-08-19T01:12:36Z", "author": "mcastelluccio@mozilla.com", "count": 13, "text": "Ziga, if you think your patch is ready, you should ask for a review.", "id": 6565367, "bug_id": 678698}]}}}