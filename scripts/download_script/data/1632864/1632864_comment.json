{"comments": {}, "bugs": {"1632864": {"comments": [{"count": 0, "tags": [], "time": "2020-04-24T14:54:49Z", "creator": "achronop@gmail.com", "creation_time": "2020-04-24T14:54:49Z", "bug_id": 1632864, "attachment_id": null, "raw_text": "It has happened in a local build. The steps are the following:\n\n1. echo gUM test with external mic and internal speakers.\n2. Unplug the mic.\n\nIn an opt build the crash is not very obvious. It does not create a crash report nor the page changes to the common crash page. However, the tab is not usable after.\n\nThis is an existing problem but it is easier to happen after 1603384. The cubeb device change behavior has modified in Linux and a device unplug event is followed by a cubeb state change to error. That results in [calling the Fallback driver](https://searchfox.org/mozilla-central/rev/41c3ea3ee8eab9ce7b82932257cb80b703cbba67/dom/media/GraphDriver.cpp#1043) which attempts to restart an already started AudioCallback driver and that is not allowed.\n\n```\n0x00007fffea8db40e in mozilla::AudioCallbackDriver::Start (this=0x7ffff78645c0) at /home/achronop/repos/mozilla/firefox/dom/media/GraphDriver.cpp:733\n733\t  MOZ_ASSERT(!IsStarted());\nMissing separate debuginfos, use: dnf debuginfo-install at-spi2-atk-2.34.2-1.fc31.x86_64 glib2-2.62.5-1.fc31.x86_64 pcre-8.43-3.fc31.x86_64 pcre2-10.34-7.fc31.x86_64\n(gdb) bt\n#0  0x00007fffea8db40e in mozilla::AudioCallbackDriver::Start() (this=0x7ffff78645c0) at /home/achronop/repos/mozilla/firefox/dom/media/GraphDriver.cpp:733\n#1  0x00007fffea8dda05 in mozilla::AudioCallbackDriver::MaybeStartAudioStream() (this=0x7ffff78645c0) at /home/achronop/repos/mozilla/firefox/dom/media/GraphDriver.cpp:1262\n#2  0x00007fffea8f83d7 in mozilla::AudioCallbackDriver::FallbackWrapper::OneIteration(long, long, mozilla::AudioMixer*)\n    (this=0x7fffcbf16d80, aStateComputedEnd=13184, aIterationEnd=11776, aMixer=0x0) at /home/achronop/repos/mozilla/firefox/dom/media/GraphDriver.cpp:428\n#3  0x00007fffea8d8542 in mozilla::ThreadedDriver::RunThread() (this=0x7fffcbf02350) at /home/achronop/repos/mozilla/firefox/dom/media/GraphDriver.cpp:208\n#4  0x00007fffea8f8fee in mozilla::MediaTrackGraphInitThreadRunnable::Run() (this=0x7fffce977850) at /home/achronop/repos/mozilla/firefox/dom/media/GraphDriver.cpp:122\n#5  0x00007fffe5c537fa in nsThread::ProcessNextEvent(bool, bool*) (this=0x7fffcbf02ac0, aMayWait=true, aResult=0x7fffcb6fea67)\n    at /home/achronop/repos/mozilla/firefox/xpcom/threads/nsThread.cpp:1200\n#6  0x00007fffe5c59547 in NS_ProcessNextEvent(nsIThread*, bool) (aThread=0x7fffcbf02ac0, aMayWait=true) at /home/achronop/repos/mozilla/firefox/xpcom/threads/nsThreadUtils.cpp:481\n#7  0x00007fffe6a0dd79 in mozilla::ipc::MessagePumpForNonMainThreads::Run(base::MessagePump::Delegate*) (this=0x7fffcbf43a00, aDelegate=0x7fffcb6fec78)\n    at /home/achronop/repos/mozilla/firefox/ipc/glue/MessagePump.cpp:332\n#8  0x00007fffe6909567 in MessageLoop::RunInternal() (this=0x7fffcb6fec78) at /home/achronop/repos/mozilla/firefox/ipc/chromium/src/base/message_loop.cc:315\n#9  0x00007fffe69094e5 in MessageLoop::RunHandler() (this=0x7fffcb6fec78) at /home/achronop/repos/mozilla/firefox/ipc/chromium/src/base/message_loop.cc:308\n#10 0x00007fffe69094a3 in MessageLoop::Run() (this=0x7fffcb6fec78) at /home/achronop/repos/mozilla/firefox/ipc/chromium/src/base/message_loop.cc:290\n#11 0x00007fffe5c4fe19 in nsThread::ThreadFunc(void*) (aArg=0x7fffc86f89a0) at /home/achronop/repos/mozilla/firefox/xpcom/threads/nsThread.cpp:444\n#12 0x00007ffff7a523ee in _pt_root (arg=0x7fffcbf363a0) at /home/achronop/repos/mozilla/firefox/nsprpub/pr/src/pthreads/ptthread.c:201\n#13 0x00007ffff7f914e2 in start_thread (arg=<optimized out>) at pthread_create.c:479\n#14 0x00007ffff7b5f6d3 in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:95", "text": "It has happened in a local build. The steps are the following:\n\n1. echo gUM test with external mic and internal speakers.\n2. Unplug the mic.\n\nIn an opt build the crash is not very obvious. It does not create a crash report nor the page changes to the common crash page. However, the tab is not usable after.\n\nThis is an existing problem but it is easier to happen after 1603384. The cubeb device change behavior has modified in Linux and a device unplug event is followed by a cubeb state change to error. That results in [calling the Fallback driver](https://searchfox.org/mozilla-central/rev/41c3ea3ee8eab9ce7b82932257cb80b703cbba67/dom/media/GraphDriver.cpp#1043) which attempts to restart an already started AudioCallback driver and that is not allowed.\n\n```\n0x00007fffea8db40e in mozilla::AudioCallbackDriver::Start (this=0x7ffff78645c0) at /home/achronop/repos/mozilla/firefox/dom/media/GraphDriver.cpp:733\n733\t  MOZ_ASSERT(!IsStarted());\nMissing separate debuginfos, use: dnf debuginfo-install at-spi2-atk-2.34.2-1.fc31.x86_64 glib2-2.62.5-1.fc31.x86_64 pcre-8.43-3.fc31.x86_64 pcre2-10.34-7.fc31.x86_64\n(gdb) bt\n#0  0x00007fffea8db40e in mozilla::AudioCallbackDriver::Start() (this=0x7ffff78645c0) at /home/achronop/repos/mozilla/firefox/dom/media/GraphDriver.cpp:733\n#1  0x00007fffea8dda05 in mozilla::AudioCallbackDriver::MaybeStartAudioStream() (this=0x7ffff78645c0) at /home/achronop/repos/mozilla/firefox/dom/media/GraphDriver.cpp:1262\n#2  0x00007fffea8f83d7 in mozilla::AudioCallbackDriver::FallbackWrapper::OneIteration(long, long, mozilla::AudioMixer*)\n    (this=0x7fffcbf16d80, aStateComputedEnd=13184, aIterationEnd=11776, aMixer=0x0) at /home/achronop/repos/mozilla/firefox/dom/media/GraphDriver.cpp:428\n#3  0x00007fffea8d8542 in mozilla::ThreadedDriver::RunThread() (this=0x7fffcbf02350) at /home/achronop/repos/mozilla/firefox/dom/media/GraphDriver.cpp:208\n#4  0x00007fffea8f8fee in mozilla::MediaTrackGraphInitThreadRunnable::Run() (this=0x7fffce977850) at /home/achronop/repos/mozilla/firefox/dom/media/GraphDriver.cpp:122\n#5  0x00007fffe5c537fa in nsThread::ProcessNextEvent(bool, bool*) (this=0x7fffcbf02ac0, aMayWait=true, aResult=0x7fffcb6fea67)\n    at /home/achronop/repos/mozilla/firefox/xpcom/threads/nsThread.cpp:1200\n#6  0x00007fffe5c59547 in NS_ProcessNextEvent(nsIThread*, bool) (aThread=0x7fffcbf02ac0, aMayWait=true) at /home/achronop/repos/mozilla/firefox/xpcom/threads/nsThreadUtils.cpp:481\n#7  0x00007fffe6a0dd79 in mozilla::ipc::MessagePumpForNonMainThreads::Run(base::MessagePump::Delegate*) (this=0x7fffcbf43a00, aDelegate=0x7fffcb6fec78)\n    at /home/achronop/repos/mozilla/firefox/ipc/glue/MessagePump.cpp:332\n#8  0x00007fffe6909567 in MessageLoop::RunInternal() (this=0x7fffcb6fec78) at /home/achronop/repos/mozilla/firefox/ipc/chromium/src/base/message_loop.cc:315\n#9  0x00007fffe69094e5 in MessageLoop::RunHandler() (this=0x7fffcb6fec78) at /home/achronop/repos/mozilla/firefox/ipc/chromium/src/base/message_loop.cc:308\n#10 0x00007fffe69094a3 in MessageLoop::Run() (this=0x7fffcb6fec78) at /home/achronop/repos/mozilla/firefox/ipc/chromium/src/base/message_loop.cc:290\n#11 0x00007fffe5c4fe19 in nsThread::ThreadFunc(void*) (aArg=0x7fffc86f89a0) at /home/achronop/repos/mozilla/firefox/xpcom/threads/nsThread.cpp:444\n#12 0x00007ffff7a523ee in _pt_root (arg=0x7fffcbf363a0) at /home/achronop/repos/mozilla/firefox/nsprpub/pr/src/pthreads/ptthread.c:201\n#13 0x00007ffff7f914e2 in start_thread (arg=<optimized out>) at pthread_create.c:479\n#14 0x00007ffff7b5f6d3 in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:95", "is_private": false, "author": "achronop@gmail.com", "id": 14776490}, {"is_private": false, "raw_text": "\nThe MockCubeb has been reformated to save the latest MockCubebStream. Then a flag is exposed that if true the audio callback will fire a cubeb state change callback with error state and will abort. On top of that, a new unit test has been implemented that triggers the error callback. This results in a crash that is being fixed in the following patch.", "text": "Created attachment 9144401\nBug 1632864 - Simulate cubeb error state callback in MockCubeb. r?padenot\n\n\nThe MockCubeb has been reformated to save the latest MockCubebStream. Then a flag is exposed that if true the audio callback will fire a cubeb state change callback with error state and will abort. On top of that, a new unit test has been implemented that triggers the error callback. This results in a crash that is being fixed in the following patch.", "id": 14786732, "author": "achronop@gmail.com", "bug_id": 1632864, "attachment_id": 9144401, "creation_time": "2020-04-29T17:39:00Z", "creator": "achronop@gmail.com", "tags": [], "count": 1, "time": "2020-04-29T17:39:00Z"}, {"count": 2, "bug_id": 1632864, "tags": [], "time": "2020-04-29T17:39:24Z", "attachment_id": 9144402, "raw_text": "\nTill now an AudioCallbackDriver, on error state callback, creates a FallbackDriver, which attempts to start the existing AudioCallbackDriver. If the driver has already started this creates a cr\nash because restart is not allowed.\n\nThis patch continues using the FallbackDriver, on cubeb state error but the driver has been enhanced with an error state that will not attempt to restart the driver. The fallback driver will continue advancing the graph similar to a ThreadedDriver until a driver switch takes place.\n\nDepends on D73102", "text": "Created attachment 9144402\nBug 1632864 - Handle error state callback in GraphDriver. r?padenot\n\n\nTill now an AudioCallbackDriver, on error state callback, creates a FallbackDriver, which attempts to start the existing AudioCallbackDriver. If the driver has already started this creates a cr\nash because restart is not allowed.\n\nThis patch continues using the FallbackDriver, on cubeb state error but the driver has been enhanced with an error state that will not attempt to restart the driver. The fallback driver will continue advancing the graph similar to a ThreadedDriver until a driver switch takes place.\n\nDepends on D73102", "is_private": false, "creator": "achronop@gmail.com", "author": "achronop@gmail.com", "creation_time": "2020-04-29T17:39:24Z", "id": 14786733}, {"bug_id": 1632864, "attachment_id": null, "is_private": false, "text": "Pushed by achronopoulos@mozilla.com:\nhttps://hg.mozilla.org/integration/autoland/rev/9b2b8a51ca6b\nSimulate cubeb error state callback in MockCubeb. r=padenot\nhttps://hg.mozilla.org/integration/autoland/rev/3220c6749601\nHandle error state callback in GraphDriver. r=padenot", "raw_text": "Pushed by achronopoulos@mozilla.com:\nhttps://hg.mozilla.org/integration/autoland/rev/9b2b8a51ca6b\nSimulate cubeb error state callback in MockCubeb. r=padenot\nhttps://hg.mozilla.org/integration/autoland/rev/3220c6749601\nHandle error state callback in GraphDriver. r=padenot", "author": "pulsebot@bots.tld", "id": 14787063, "tags": [], "count": 3, "time": "2020-04-29T20:14:36Z", "creation_time": "2020-04-29T20:14:36Z", "creator": "pulsebot@bots.tld"}, {"creator": "malexandru@mozilla.com", "creation_time": "2020-04-30T04:01:50Z", "count": 4, "tags": ["bugherder"], "time": "2020-04-30T04:01:50Z", "raw_text": "https://hg.mozilla.org/mozilla-central/rev/9b2b8a51ca6b\nhttps://hg.mozilla.org/mozilla-central/rev/3220c6749601", "text": "https://hg.mozilla.org/mozilla-central/rev/9b2b8a51ca6b\nhttps://hg.mozilla.org/mozilla-central/rev/3220c6749601", "is_private": false, "author": "malexandru@mozilla.com", "id": 14787692, "bug_id": 1632864, "attachment_id": null}]}}}