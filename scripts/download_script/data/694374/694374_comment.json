{"comments": {}, "bugs": {"694374": {"comments": [{"attachment_id": null, "raw_text": "There is a special case in RasterImage::AdvanceFrame (introduced in bug 666446) that looks like the following:\n\n  if (nextFrameIndex == 0 && currentFrameIndex == 0) {\n    frameToUse = nextFrame;\n    aDirtyRect = &(mAnim->firstFrameRefreshArea);\n  } else {\n    imgFrame *curFrame = mFrames[currentFrameIndex];\n    if (!curFrame) {\n      return false;\n    }\n\n    // Change frame\n    if (NS_FAILED(DoComposite(aDirtyRect, curFrame,\n                              nextFrame, nextFrameIndex))) {\n      // something went wrong, move on to next\n      NS_WARNING(\"RasterImage::AdvanceFrame(): Compositing of frame failed\");\n      nextFrame->SetCompositingFailed(PR_TRUE);\n      mAnim->currentAnimationFrameIndex = nextFrameIndex;\n      mAnim->currentAnimationFrameTime = aTime;\n      return false;\n    }\n\n    nextFrame->SetCompositingFailed(PR_FALSE);\n  }\n\nThis requires special handling for the very first frame of an animation. It could probably be simplified to something like:\n\n    imgFrame *curFrame = mFrames[currentFrameIndex];\n\n    if (!curFrame) {\n      return false;\n    }\n\n    if (!nextFrame) {\n      nextFrame = curFrame;\n    }\n\n    // Change frame\n    if (NS_FAILED(DoComposite(aDirtyRect, curFrame,\n                              nextFrame, nextFrameIndex))) {\n      // something went wrong, move on to next\n      NS_WARNING(\"RasterImage::AdvanceFrame(): Compositing of frame failed\");\n      nextFrame->SetCompositingFailed(PR_TRUE);\n      mAnim->currentAnimationFrameIndex = nextFrameIndex;\n      mAnim->currentAnimationFrameTime = aTime;\n      return false;\n    }\n\n    nextFrame->SetCompositingFailed(PR_FALSE);\n\nThis calls DoComposite() with curFrame == nextFrame, which could be problematic. We need to investigate if this can be simplified, and if so, perform this simplification.", "id": 5780795, "creator": "jaywir3@gmail.com", "is_private": false, "count": 0, "author": "jaywir3@gmail.com", "creation_time": "2011-10-13T18:47:15Z", "time": "2011-10-13T18:47:15Z", "tags": [], "bug_id": 694374, "text": "There is a special case in RasterImage::AdvanceFrame (introduced in bug 666446) that looks like the following:\n\n  if (nextFrameIndex == 0 && currentFrameIndex == 0) {\n    frameToUse = nextFrame;\n    aDirtyRect = &(mAnim->firstFrameRefreshArea);\n  } else {\n    imgFrame *curFrame = mFrames[currentFrameIndex];\n    if (!curFrame) {\n      return false;\n    }\n\n    // Change frame\n    if (NS_FAILED(DoComposite(aDirtyRect, curFrame,\n                              nextFrame, nextFrameIndex))) {\n      // something went wrong, move on to next\n      NS_WARNING(\"RasterImage::AdvanceFrame(): Compositing of frame failed\");\n      nextFrame->SetCompositingFailed(PR_TRUE);\n      mAnim->currentAnimationFrameIndex = nextFrameIndex;\n      mAnim->currentAnimationFrameTime = aTime;\n      return false;\n    }\n\n    nextFrame->SetCompositingFailed(PR_FALSE);\n  }\n\nThis requires special handling for the very first frame of an animation. It could probably be simplified to something like:\n\n    imgFrame *curFrame = mFrames[currentFrameIndex];\n\n    if (!curFrame) {\n      return false;\n    }\n\n    if (!nextFrame) {\n      nextFrame = curFrame;\n    }\n\n    // Change frame\n    if (NS_FAILED(DoComposite(aDirtyRect, curFrame,\n                              nextFrame, nextFrameIndex))) {\n      // something went wrong, move on to next\n      NS_WARNING(\"RasterImage::AdvanceFrame(): Compositing of frame failed\");\n      nextFrame->SetCompositingFailed(PR_TRUE);\n      mAnim->currentAnimationFrameIndex = nextFrameIndex;\n      mAnim->currentAnimationFrameTime = aTime;\n      return false;\n    }\n\n    nextFrame->SetCompositingFailed(PR_FALSE);\n\nThis calls DoComposite() with curFrame == nextFrame, which could be problematic. We need to investigate if this can be simplified, and if so, perform this simplification."}]}}}