{"comments": {}, "bugs": {"1642671": {"comments": [{"attachment_id": null, "id": 14858219, "author": "rob@robwu.nl", "text": "This doesn't look right: https://hg.mozilla.org/mozilla-central/rev/ca3057f6cdc5#l3.50\n\nA consequence of the `value &&` value check is that falsey return values are ignored, and the caller will receive `undefined` due to the ultimate fallback.\n\nI'll fix this and add some tests.", "is_private": false, "bug_id": 1642671, "raw_text": "This doesn't look right: https://hg.mozilla.org/mozilla-central/rev/ca3057f6cdc5#l3.50\n\nA consequence of the `value &&` value check is that falsey return values are ignored, and the caller will receive `undefined` due to the ultimate fallback.\n\nI'll fix this and add some tests.", "creation_time": "2020-06-02T16:06:36Z", "count": 0, "tags": [], "time": "2020-06-02T16:06:36Z", "creator": "rob@robwu.nl"}, {"tags": [], "bug_id": 1642671, "is_private": false, "time": "2020-06-02T17:29:24Z", "creator": "rob@robwu.nl", "raw_text": "I was mistaken about the meaning of that line.\n\nzombie clarified: that's not a bug, that listener returns an array of response values, or undefined if there are no listeners.\n\nThis bug is only about writing tests then, if we don't have them already.", "attachment_id": null, "author": "rob@robwu.nl", "id": 14858655, "creation_time": "2020-06-02T17:29:24Z", "count": 1, "text": "I was mistaken about the meaning of that line.\n\nzombie clarified: that's not a bug, that listener returns an array of response values, or undefined if there are no listeners.\n\nThis bug is only about writing tests then, if we don't have them already."}, {"time": "2020-06-02T19:18:52Z", "creator": "rob@robwu.nl", "tags": [], "count": 2, "creation_time": "2020-06-02T19:18:52Z", "raw_text": "", "is_private": false, "bug_id": 1642671, "text": "Created attachment 9153552\nBug 1642671 - Add tests for falsey result from runtime.onMessage", "id": 14858888, "author": "rob@robwu.nl", "attachment_id": 9153552}, {"tags": [], "time": "2020-06-02T19:26:01Z", "creator": "rob@robwu.nl", "raw_text": "I patched [MessageEvent.emit](https://searchfox.org/mozilla-central/rev/559b25eb41c1cbffcb90a34e008b8288312fcd25/toolkit/components/extensions/ExtensionChild.jsm#183) by triggering a failure when `runtime.onMessage`'s callback returns a falsey value other than `undefined`. Surprisingly out of all extension tests, only one test failed, because [its `onMessage` handler coincidentally received a `null` value](https://searchfox.org/mozilla-central/rev/559b25eb41c1cbffcb90a34e008b8288312fcd25/toolkit/components/extensions/test/xpcshell/test_ext_storage_tab.js#75). The caller didn't check the returned result though. So I have added a test to make sure that we have sufficient coverage for the scenario of receiving a falsey result in `onMessage`.\n\nThis is the patch that I used to run the check:\n\n```\ndiff --git a/toolkit/components/extensions/ExtensionChild.jsm b/toolkit/components/extensions/ExtensionChild.jsm\nindex a9e8a2c576576..14a1b2462f579 100644\n--- a/toolkit/components/extensions/ExtensionChild.jsm\n+++ b/toolkit/components/extensions/ExtensionChild.jsm\n@@ -181,6 +181,17 @@ class MessageEvent extends SimpleEventAPI {\n       .map(fire => this.wrapResponse(fire, message, sender))\n       .filter(x => x !== undefined);\n \n+    const abort = (msg) => {\n+      (this.context.chromeObj || this.context.cloneScope.wrappedJSObject.browser).test.fail(msg);\n+    };\n+    all.forEach(x => {\n+      if (x && x instanceof Promise) {\n+        x.then(v => {\n+          v || v === undefined || abort(\"FALSEY??? \" + v);\n+        }, () => {});\n+      }\n+    });\n+\n     return all.length ? Promise.race(all).then(v => [v]) : [];\n   }\n \n\n```", "count": 3, "creation_time": "2020-06-02T19:26:01Z", "is_private": false, "bug_id": 1642671, "author": "rob@robwu.nl", "id": 14858899, "attachment_id": null, "text": "I patched [MessageEvent.emit](https://searchfox.org/mozilla-central/rev/559b25eb41c1cbffcb90a34e008b8288312fcd25/toolkit/components/extensions/ExtensionChild.jsm#183) by triggering a failure when `runtime.onMessage`'s callback returns a falsey value other than `undefined`. Surprisingly out of all extension tests, only one test failed, because [its `onMessage` handler coincidentally received a `null` value](https://searchfox.org/mozilla-central/rev/559b25eb41c1cbffcb90a34e008b8288312fcd25/toolkit/components/extensions/test/xpcshell/test_ext_storage_tab.js#75). The caller didn't check the returned result though. So I have added a test to make sure that we have sufficient coverage for the scenario of receiving a falsey result in `onMessage`.\n\nThis is the patch that I used to run the check:\n\n```\ndiff --git a/toolkit/components/extensions/ExtensionChild.jsm b/toolkit/components/extensions/ExtensionChild.jsm\nindex a9e8a2c576576..14a1b2462f579 100644\n--- a/toolkit/components/extensions/ExtensionChild.jsm\n+++ b/toolkit/components/extensions/ExtensionChild.jsm\n@@ -181,6 +181,17 @@ class MessageEvent extends SimpleEventAPI {\n       .map(fire => this.wrapResponse(fire, message, sender))\n       .filter(x => x !== undefined);\n \n+    const abort = (msg) => {\n+      (this.context.chromeObj || this.context.cloneScope.wrappedJSObject.browser).test.fail(msg);\n+    };\n+    all.forEach(x => {\n+      if (x && x instanceof Promise) {\n+        x.then(v => {\n+          v || v === undefined || abort(\"FALSEY??? \" + v);\n+        }, () => {});\n+      }\n+    });\n+\n     return all.length ? Promise.race(all).then(v => [v]) : [];\n   }\n \n\n```"}, {"bug_id": 1642671, "is_private": false, "tags": [], "time": "2020-06-03T17:31:06Z", "creator": "pulsebot@bots.tld", "author": "pulsebot@bots.tld", "id": 14861053, "raw_text": "Pushed by rob@robwu.nl:\nhttps://hg.mozilla.org/integration/autoland/rev/36f295b440e6\nAdd tests for falsey result from runtime.onMessage r=zombie,geckoview-reviewers,agi", "attachment_id": null, "count": 4, "text": "Pushed by rob@robwu.nl:\nhttps://hg.mozilla.org/integration/autoland/rev/36f295b440e6\nAdd tests for falsey result from runtime.onMessage r=zombie,geckoview-reviewers,agi", "creation_time": "2020-06-03T17:31:06Z"}, {"is_private": false, "bug_id": 1642671, "tags": ["bugherder"], "time": "2020-06-04T04:21:19Z", "creator": "dluca@mozilla.com", "id": 14862087, "author": "dluca@mozilla.com", "raw_text": "https://hg.mozilla.org/mozilla-central/rev/36f295b440e6", "attachment_id": null, "count": 5, "text": "https://hg.mozilla.org/mozilla-central/rev/36f295b440e6", "creation_time": "2020-06-04T04:21:19Z"}]}}}