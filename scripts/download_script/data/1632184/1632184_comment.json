{"comments": {}, "bugs": {"1632184": {"comments": [{"time": "2020-04-22T14:42:08Z", "creator": "alessio.placitelli@gmail.com", "tags": [], "count": 0, "creation_time": "2020-04-22T14:42:08Z", "raw_text": "While investigating writing additional tests, Chris Hartjes found that the baseline ping test is currently [broken in Fenix](https://searchfox.org/mozilla-mobile/rev/18091005a2afb10de421ee01dbcb1cdae8118b93/fenix/app/src/androidTest/java/org/mozilla/fenix/glean/BaselinePingTest.kt#92).\n\nThe fix is trivial, requires changing the linked line to:\n\n> assertEquals(\"background\", baselinePing.getJSONObject(\"ping_info\")[\"reason\"])\n\nHowever this leads us to a question: are tests even running in Fenix?", "bug_id": 1632184, "is_private": false, "text": "While investigating writing additional tests, Chris Hartjes found that the baseline ping test is currently [broken in Fenix](https://searchfox.org/mozilla-mobile/rev/18091005a2afb10de421ee01dbcb1cdae8118b93/fenix/app/src/androidTest/java/org/mozilla/fenix/glean/BaselinePingTest.kt#92).\n\nThe fix is trivial, requires changing the linked line to:\n\n> assertEquals(\"background\", baselinePing.getJSONObject(\"ping_info\")[\"reason\"])\n\nHowever this leads us to a question: are tests even running in Fenix?", "id": 14771786, "author": "alessio.placitelli@gmail.com", "attachment_id": null}, {"is_private": false, "bug_id": 1632184, "text": "Richard, in [this PR](https://github.com/mozilla-mobile/fenix/pull/7639) we added a test to Fenix. The test is broken, and should have been failing and getting people angry at us :-) However, the test is still broken and nobody complained. I suspect this is not running on CI. Do you know anything about that?", "id": 14771888, "author": "alessio.placitelli@gmail.com", "attachment_id": null, "creator": "alessio.placitelli@gmail.com", "time": "2020-04-22T15:16:56Z", "tags": [], "count": 1, "creation_time": "2020-04-22T15:16:56Z", "raw_text": "Richard, in [this PR](https://github.com/mozilla-mobile/fenix/pull/7639) we added a test to Fenix. The test is broken, and should have been failing and getting people angry at us :-) However, the test is still broken and nobody complained. I suspect this is not running on CI. Do you know anything about that?"}, {"raw_text": "(In reply to Alessio Placitelli [:Dexter] from comment #1)\n> Richard, in [this PR](https://github.com/mozilla-mobile/fenix/pull/7639) we added a test to Fenix. The test is broken, and should have been failing and getting people angry at us :-) However, the test is still broken and nobody complained. I suspect this is not running on CI. Do you know anything about that?\n\nForwarding to Isabel... can you take a look?", "count": 2, "creation_time": "2020-04-22T17:08:55Z", "tags": [], "time": "2020-04-22T17:08:55Z", "creator": "rpappalardo@mozilla.com", "id": 14772213, "author": "rpappalardo@mozilla.com", "attachment_id": null, "text": "(In reply to Alessio Placitelli [:Dexter] from comment #1)\n> Richard, in [this PR](https://github.com/mozilla-mobile/fenix/pull/7639) we added a test to Fenix. The test is broken, and should have been failing and getting people angry at us :-) However, the test is still broken and nobody complained. I suspect this is not running on CI. Do you know anything about that?\n\nForwarding to Isabel... can you take a look?", "is_private": false, "bug_id": 1632184}, {"is_private": false, "bug_id": 1632184, "text": "(In reply to Alessio Placitelli [:Dexter] from comment #1)\n> Richard, in [this PR](https://github.com/mozilla-mobile/fenix/pull/7639) we added a test to Fenix. The test is broken, and should have been failing and getting people angry at us :-) However, the test is still broken and nobody complained. I suspect this is not running on CI. Do you know anything about that?\n\nHey Alessio, I think I know whats happening...the UI tests that run on CI are the ones under ui package: https://github.com/mozilla-mobile/fenix/blob/master/automation/taskcluster/androidTest/flank-x86.yml#L41. So, I'm afraid that this test has not run on CI ever :( sorry about that...that's why no one has noticed about it failing now.\n\nThere are at least two options to add it to CI:\n-Add it to UI tests\n-Create a new task to run it, which may be the best option if you expect to have more tests for glean...\n\nHope that helps :)  and please ping me if you want to talk more about the options/your preferences to have it running on CI.", "attachment_id": null, "id": 14772397, "author": "irios.mozilla@gmail.com", "creator": "irios.mozilla@gmail.com", "time": "2020-04-22T18:38:06Z", "tags": [], "creation_time": "2020-04-22T18:38:06Z", "count": 3, "raw_text": "(In reply to Alessio Placitelli [:Dexter] from comment #1)\n> Richard, in [this PR](https://github.com/mozilla-mobile/fenix/pull/7639) we added a test to Fenix. The test is broken, and should have been failing and getting people angry at us :-) However, the test is still broken and nobody complained. I suspect this is not running on CI. Do you know anything about that?\n\nHey Alessio, I think I know whats happening...the UI tests that run on CI are the ones under ui package: https://github.com/mozilla-mobile/fenix/blob/master/automation/taskcluster/androidTest/flank-x86.yml#L41. So, I'm afraid that this test has not run on CI ever :( sorry about that...that's why no one has noticed about it failing now.\n\nThere are at least two options to add it to CI:\n-Add it to UI tests\n-Create a new task to run it, which may be the best option if you expect to have more tests for glean...\n\nHope that helps :)  and please ping me if you want to talk more about the options/your preferences to have it running on CI."}, {"raw_text": "(In reply to Isabel Rios[:isabel_rios] from comment #3)\n> Hey Alessio, I think I know whats happening...the UI tests that run on CI are the ones under ui package: https://github.com/mozilla-mobile/fenix/blob/master/automation/taskcluster/androidTest/flank-x86.yml#L41. So, I'm afraid that this test has not run on CI ever :( sorry about that...that's why no one has noticed about it failing now.\n\nOuch, that's bad, but it explains what we're seeing :)\n\n> There are at least two options to add it to CI:\n> -Add it to UI tests\n> -Create a new task to run it, which may be the best option if you expect to have more tests for glean...\n> \n> Hope that helps :)  and please ping me if you want to talk more about the options/your preferences to have it running on CI.\n\nWhat does it take to create a new task? \nWould it be possible to \"simply\" add a new entry, i.e. `- package org.mozilla.fenix.glean` [here](https://github.com/mozilla-mobile/fenix/blob/b703e1b1d10ee460587522b172c50c982c1d2fc4/automation/taskcluster/androidTest/flank-x86.yml#L41), below the `- package org.mozilla.fenix.ui`, under `test-targets`?", "creation_time": "2020-04-23T10:44:19Z", "count": 4, "tags": [], "time": "2020-04-23T10:44:19Z", "creator": "alessio.placitelli@gmail.com", "attachment_id": null, "id": 14773586, "author": "alessio.placitelli@gmail.com", "text": "(In reply to Isabel Rios[:isabel_rios] from comment #3)\n> Hey Alessio, I think I know whats happening...the UI tests that run on CI are the ones under ui package: https://github.com/mozilla-mobile/fenix/blob/master/automation/taskcluster/androidTest/flank-x86.yml#L41. So, I'm afraid that this test has not run on CI ever :( sorry about that...that's why no one has noticed about it failing now.\n\nOuch, that's bad, but it explains what we're seeing :)\n\n> There are at least two options to add it to CI:\n> -Add it to UI tests\n> -Create a new task to run it, which may be the best option if you expect to have more tests for glean...\n> \n> Hope that helps :)  and please ping me if you want to talk more about the options/your preferences to have it running on CI.\n\nWhat does it take to create a new task? \nWould it be possible to \"simply\" add a new entry, i.e. `- package org.mozilla.fenix.glean` [here](https://github.com/mozilla-mobile/fenix/blob/b703e1b1d10ee460587522b172c50c982c1d2fc4/automation/taskcluster/androidTest/flank-x86.yml#L41), below the `- package org.mozilla.fenix.ui`, under `test-targets`?", "is_private": false, "bug_id": 1632184}, {"creation_time": "2020-04-23T11:13:38Z", "count": 5, "text": "\n> What does it take to create a new task? \n> Would it be possible to \"simply\" add a new entry, i.e. `- package org.mozilla.fenix.glean` [here](https://github.com/mozilla-mobile/fenix/blob/b703e1b1d10ee460587522b172c50c982c1d2fc4/automation/taskcluster/androidTest/flank-x86.yml#L41), below the `- package org.mozilla.fenix.ui`, under `test-targets`?\n\nI think so, that's the option I would like to try first. Let me check and I will come back to you :)", "raw_text": "\n> What does it take to create a new task? \n> Would it be possible to \"simply\" add a new entry, i.e. `- package org.mozilla.fenix.glean` [here](https://github.com/mozilla-mobile/fenix/blob/b703e1b1d10ee460587522b172c50c982c1d2fc4/automation/taskcluster/androidTest/flank-x86.yml#L41), below the `- package org.mozilla.fenix.ui`, under `test-targets`?\n\nI think so, that's the option I would like to try first. Let me check and I will come back to you :)", "attachment_id": null, "id": 14773623, "author": "irios.mozilla@gmail.com", "creator": "irios.mozilla@gmail.com", "time": "2020-04-23T11:13:38Z", "tags": [], "is_private": false, "bug_id": 1632184}, {"creation_time": "2020-04-23T14:47:49Z", "count": 6, "raw_text": "Hey Alessio,\n\nLooks like that solution works. I created this PR: https://github.com/mozilla-mobile/fenix/pull/10146 and the test runs there.\n\nSince test failures block PRs merge on Fenix, we would need to wait until the test is fixed to land this. Does that sound good?\n\nFYi, This is the tests result report: https://console.firebase.google.com/project/moz-fenix/testlab/histories/bh.66b7091e15d53d45/matrices/8548420857237243210", "creator": "irios.mozilla@gmail.com", "time": "2020-04-23T14:47:49Z", "tags": [], "text": "Hey Alessio,\n\nLooks like that solution works. I created this PR: https://github.com/mozilla-mobile/fenix/pull/10146 and the test runs there.\n\nSince test failures block PRs merge on Fenix, we would need to wait until the test is fixed to land this. Does that sound good?\n\nFYi, This is the tests result report: https://console.firebase.google.com/project/moz-fenix/testlab/histories/bh.66b7091e15d53d45/matrices/8548420857237243210", "attachment_id": null, "id": 14774008, "author": "irios.mozilla@gmail.com", "bug_id": 1632184, "is_private": false}, {"raw_text": "(In reply to Isabel Rios[:isabel_rios] from comment #6)\n> Hey Alessio,\n> \n> Looks like that solution works. I created this PR: https://github.com/mozilla-mobile/fenix/pull/10146 and the test runs there.\n> \n> Since test failures block PRs merge on Fenix, we would need to wait until the test is fixed to land this. Does that sound good?\n> \n> FYi, This is the tests result report: https://console.firebase.google.com/project/moz-fenix/testlab/histories/bh.66b7091e15d53d45/matrices/8548420857237243210\n\nGreat, thanks! Let me quickly create a PR for fixing the test. You will be able to rebase once that's merged. Thank you so much for looking into this, much appreciated.\n\nI will ping you again once that's merged.", "count": 7, "creation_time": "2020-04-23T15:11:36Z", "tags": [], "time": "2020-04-23T15:11:36Z", "creator": "alessio.placitelli@gmail.com", "id": 14774069, "author": "alessio.placitelli@gmail.com", "attachment_id": null, "text": "(In reply to Isabel Rios[:isabel_rios] from comment #6)\n> Hey Alessio,\n> \n> Looks like that solution works. I created this PR: https://github.com/mozilla-mobile/fenix/pull/10146 and the test runs there.\n> \n> Since test failures block PRs merge on Fenix, we would need to wait until the test is fixed to land this. Does that sound good?\n> \n> FYi, This is the tests result report: https://console.firebase.google.com/project/moz-fenix/testlab/histories/bh.66b7091e15d53d45/matrices/8548420857237243210\n\nGreat, thanks! Let me quickly create a PR for fixing the test. You will be able to rebase once that's merged. Thank you so much for looking into this, much appreciated.\n\nI will ping you again once that's merged.", "is_private": false, "bug_id": 1632184}, {"tags": [], "bug_id": 1632184, "is_private": false, "creator": "alessio.placitelli@gmail.com", "time": "2020-04-23T17:21:11Z", "raw_text": "(In reply to Isabel Rios[:isabel_rios] from comment #6)\n> Hey Alessio,\n> \n> Looks like that solution works. I created this PR: https://github.com/mozilla-mobile/fenix/pull/10146 and the test runs there.\n> \n> Since test failures block PRs merge on Fenix, we would need to wait until the test is fixed to land this. Does that sound good?\n> \n> FYi, This is the tests result report: https://console.firebase.google.com/project/moz-fenix/testlab/histories/bh.66b7091e15d53d45/matrices/8548420857237243210\n\nThanks Isabel! I think I fixed it in https://github.com/mozilla-mobile/fenix/pull/10152 (to be reviewed and merged). Any chance you could kindly check if that fixes the problem on CI?", "attachment_id": null, "author": "alessio.placitelli@gmail.com", "id": 14774395, "creation_time": "2020-04-23T17:21:11Z", "count": 8, "text": "(In reply to Isabel Rios[:isabel_rios] from comment #6)\n> Hey Alessio,\n> \n> Looks like that solution works. I created this PR: https://github.com/mozilla-mobile/fenix/pull/10146 and the test runs there.\n> \n> Since test failures block PRs merge on Fenix, we would need to wait until the test is fixed to land this. Does that sound good?\n> \n> FYi, This is the tests result report: https://console.firebase.google.com/project/moz-fenix/testlab/histories/bh.66b7091e15d53d45/matrices/8548420857237243210\n\nThanks Isabel! I think I fixed it in https://github.com/mozilla-mobile/fenix/pull/10152 (to be reviewed and merged). Any chance you could kindly check if that fixes the problem on CI?"}, {"creation_time": "2020-04-23T18:50:46Z", "count": 9, "raw_text": "The test works for me locally but not on CI ... \nThese are the logs.. https://console.firebase.google.com/project/moz-fenix/testlab/histories/bh.66b7091e15d53d45/matrices/4775591608566573438/executions/bs.2b918418d317918/testcases/1/errors\n\nDo you have access? If not I will paste them here...", "time": "2020-04-23T18:50:46Z", "creator": "irios.mozilla@gmail.com", "tags": [], "text": "The test works for me locally but not on CI ... \nThese are the logs.. https://console.firebase.google.com/project/moz-fenix/testlab/histories/bh.66b7091e15d53d45/matrices/4775591608566573438/executions/bs.2b918418d317918/testcases/1/errors\n\nDo you have access? If not I will paste them here...", "attachment_id": null, "id": 14774623, "author": "irios.mozilla@gmail.com", "bug_id": 1632184, "is_private": false}, {"id": 14775791, "author": "alessio.placitelli@gmail.com", "attachment_id": null, "text": "(In reply to Isabel Rios[:isabel_rios] from comment #9)\n> The test works for me locally but not on CI ... \n> These are the logs.. https://console.firebase.google.com/project/moz-fenix/testlab/histories/bh.66b7091e15d53d45/matrices/4775591608566573438/executions/bs.2b918418d317918/testcases/1/errors\n> \n> Do you have access? If not I will paste them here...\n\nThanks Isabel, that was really helpful (yes, I do have access).\n\nBy looking at the logs, it seems that, on CI, the recently introduced `startup-timeline` ping is correctly getting triggered before the `baseline` ping in this test.\n\n> ...\n> 04-23 15:52:43.087: I/libglean_ffi(7789): glean_core::ping: Collecting startup-timeline\n> 04-23 15:52:43.130: D/libglean_ffi(7789): glean_core::ping: Storing ping '6fcd14c0-e157-4fb3-b833-aace130b2129' at '/data/user/0/org.mozilla.fenix.debug/glean_data/pending_pings/6fcd14c0-e157-4fb3-b833-aace130b2129'\n> 04-23 15:52:43.130: I/libglean_ffi(7789): glean_core: The ping 'startup-timeline' was submitted and will be sent as soon as possible\n> ...\n> 04-23 15:52:43.545: I/libglean_ffi(7789): glean_core::ping: Collecting baseline\n> 04-23 15:52:43.547: D/libglean_ffi(7789): glean_core::ping: Storing ping 'a6dce3b4-f7fa-43f2-be58-fd847314b0c8' at '/data/user/0/org.mozilla.fenix.debug/glean_data/pending_pings/a6dce3b4-f7fa-43f2-be58-fd847314b0c8'\n> 04-23 15:52:43.547: I/libglean_ffi(7789): glean_core: The ping 'baseline' was submitted and will be sent as soon as possible\n> ...\n> 04-23 15:52:43.605: I/MockWebServer(7789): MockWebServer[59188] received request: POST /submit/org-mozilla-fenix-debug/startup-timeline/1/6fcd14c0-e157-4fb3-b833-aace130b2129 HTTP/1.1 and responded: HTTP/1.1 200 OK\n> 04-23 15:52:43.702: D/glean/ConceptFetchHttpUploader(7789): Ping successfully sent (200)\n> 04-23 15:52:43.705: D/glean/PingUploadWorker(7789): 6fcd14c0-e157-4fb3-b833-aace130b2129 was deleted: true\n> 04-23 15:52:43.716: I/WM-WorkerWrapper(7789): Worker result SUCCESS for Work [ id=4a385ef8-ea41-47b2-917b-f85b4351bc2c, tags={ mozilla.telemetry.glean.scheduler.PingUploadWorker, mozac_service_glean_ping_upload_worker } ]\n\nAfter that, the `MockWebServer` times out waiting for the `baseline` ping which, for some reason, never arrives. I'm investigating why.", "is_private": false, "bug_id": 1632184, "raw_text": "(In reply to Isabel Rios[:isabel_rios] from comment #9)\n> The test works for me locally but not on CI ... \n> These are the logs.. https://console.firebase.google.com/project/moz-fenix/testlab/histories/bh.66b7091e15d53d45/matrices/4775591608566573438/executions/bs.2b918418d317918/testcases/1/errors\n> \n> Do you have access? If not I will paste them here...\n\nThanks Isabel, that was really helpful (yes, I do have access).\n\nBy looking at the logs, it seems that, on CI, the recently introduced `startup-timeline` ping is correctly getting triggered before the `baseline` ping in this test.\n\n> ...\n> 04-23 15:52:43.087: I/libglean_ffi(7789): glean_core::ping: Collecting startup-timeline\n> 04-23 15:52:43.130: D/libglean_ffi(7789): glean_core::ping: Storing ping '6fcd14c0-e157-4fb3-b833-aace130b2129' at '/data/user/0/org.mozilla.fenix.debug/glean_data/pending_pings/6fcd14c0-e157-4fb3-b833-aace130b2129'\n> 04-23 15:52:43.130: I/libglean_ffi(7789): glean_core: The ping 'startup-timeline' was submitted and will be sent as soon as possible\n> ...\n> 04-23 15:52:43.545: I/libglean_ffi(7789): glean_core::ping: Collecting baseline\n> 04-23 15:52:43.547: D/libglean_ffi(7789): glean_core::ping: Storing ping 'a6dce3b4-f7fa-43f2-be58-fd847314b0c8' at '/data/user/0/org.mozilla.fenix.debug/glean_data/pending_pings/a6dce3b4-f7fa-43f2-be58-fd847314b0c8'\n> 04-23 15:52:43.547: I/libglean_ffi(7789): glean_core: The ping 'baseline' was submitted and will be sent as soon as possible\n> ...\n> 04-23 15:52:43.605: I/MockWebServer(7789): MockWebServer[59188] received request: POST /submit/org-mozilla-fenix-debug/startup-timeline/1/6fcd14c0-e157-4fb3-b833-aace130b2129 HTTP/1.1 and responded: HTTP/1.1 200 OK\n> 04-23 15:52:43.702: D/glean/ConceptFetchHttpUploader(7789): Ping successfully sent (200)\n> 04-23 15:52:43.705: D/glean/PingUploadWorker(7789): 6fcd14c0-e157-4fb3-b833-aace130b2129 was deleted: true\n> 04-23 15:52:43.716: I/WM-WorkerWrapper(7789): Worker result SUCCESS for Work [ id=4a385ef8-ea41-47b2-917b-f85b4351bc2c, tags={ mozilla.telemetry.glean.scheduler.PingUploadWorker, mozac_service_glean_ping_upload_worker } ]\n\nAfter that, the `MockWebServer` times out waiting for the `baseline` ping which, for some reason, never arrives. I'm investigating why.", "count": 10, "creation_time": "2020-04-24T08:52:03Z", "tags": [], "time": "2020-04-24T08:52:03Z", "creator": "alessio.placitelli@gmail.com"}, {"text": "Isabel, sorry to bother you again. I updated [my PR](https://github.com/mozilla-mobile/fenix/pull/10152) with something that should fix the failure on CI as well.\n\nI'm not able to consistently reproduce the problem locally, but after this fix I was never able to reproduce it again.\n\nAny chance you could test this again on CI, maybe letting it run a few times?", "attachment_id": null, "author": "alessio.placitelli@gmail.com", "id": 14776141, "bug_id": 1632184, "is_private": false, "creation_time": "2020-04-24T12:52:05Z", "count": 11, "raw_text": "Isabel, sorry to bother you again. I updated [my PR](https://github.com/mozilla-mobile/fenix/pull/10152) with something that should fix the failure on CI as well.\n\nI'm not able to consistently reproduce the problem locally, but after this fix I was never able to reproduce it again.\n\nAny chance you could test this again on CI, maybe letting it run a few times?", "creator": "alessio.placitelli@gmail.com", "time": "2020-04-24T12:52:05Z", "tags": []}, {"tags": [], "creator": "irios.mozilla@gmail.com", "time": "2020-04-24T13:30:29Z", "raw_text": "Sure! let me try that and let you know the results", "count": 12, "creation_time": "2020-04-24T13:30:29Z", "bug_id": 1632184, "is_private": false, "author": "irios.mozilla@gmail.com", "id": 14776307, "attachment_id": null, "text": "Sure! let me try that and let you know the results"}, {"raw_text": "Unfortunately, the test is still failing on CI.. see logs: \nhttps://console.firebase.google.com/project/moz-fenix/testlab/histories/bh.66b7091e15d53d45/matrices/9222329471283168538/executions/bs.8a6fc5353b0cefea/testcases/1/test-cases\n\nYou can also try to add the line in my PR (https://github.com/mozilla-mobile/fenix/pull/10146/files#diff-2505cc9c0e1fbaa0bc3575cd3373d042R42) to your PR so you can see the results when you add new changes to your tests and no need to wait for me testing (it can take sometime depending on the day/time :S)", "count": 13, "creation_time": "2020-04-24T14:05:24Z", "tags": [], "time": "2020-04-24T14:05:24Z", "creator": "irios.mozilla@gmail.com", "id": 14776364, "author": "irios.mozilla@gmail.com", "attachment_id": null, "text": "Unfortunately, the test is still failing on CI.. see logs: \nhttps://console.firebase.google.com/project/moz-fenix/testlab/histories/bh.66b7091e15d53d45/matrices/9222329471283168538/executions/bs.8a6fc5353b0cefea/testcases/1/test-cases\n\nYou can also try to add the line in my PR (https://github.com/mozilla-mobile/fenix/pull/10146/files#diff-2505cc9c0e1fbaa0bc3575cd3373d042R42) to your PR so you can see the results when you add new changes to your tests and no need to wait for me testing (it can take sometime depending on the day/time :S)", "is_private": false, "bug_id": 1632184}, {"text": "Ok, here's some notes about what I was able to see. The notes in comment 10 are correct: the test is failing because the `startup-timeline` ping is generated and submitted before the other pings. Here's what I think is happening:\n\n1. Glean is initialized by the test [here](https://searchfox.org/mozilla-mobile/rev/0f569464dc94c5e16823ab6a8fb53a20ad36ac60/fenix/app/src/androidTest/java/org/mozilla/fenix/glean/BaselinePingTest.kt#49). [Using the testrule](https://searchfox.org/mozilla-mobile/rev/0f569464dc94c5e16823ab6a8fb53a20ad36ac60/fenix/app/src/androidTest/java/org/mozilla/fenix/glean/BaselinePingTest.kt#40) makes sure that Glean is in `test mode`.\n2.  The test [moves the app to background after 1s](https://searchfox.org/mozilla-mobile/rev/0f569464dc94c5e16823ab6a8fb53a20ad36ac60/fenix/app/src/androidTest/java/org/mozilla/fenix/glean/BaselinePingTest.kt#88).\n3. When going to background, both glean and fenix generate some pings. Glean is supposed to send a `baseline` with reason `background`, while Fenix [generates a `startup-timeline`](https://searchfox.org/mozilla-mobile/rev/0f569464dc94c5e16823ab6a8fb53a20ad36ac60/fenix/app/src/main/java/org/mozilla/fenix/perf/StartupTimeline.kt#94).\n4. The order with which the pings are generated is non deterministic and depends by the OS.\n5.  Both pings end up calling [submitPingByName](https://searchfox.org/glean/rev/5e36bbfd7025804743c31cfa5122dbbec09cb21f/glean-core/android/src/main/java/mozilla/telemetry/glean/Glean.kt#535) down the line, which is async in general, but sync when in test mode.\n6. Both pings are successfully collected (see the logs). However, the first one [dispatches the worker for upload](https://searchfox.org/glean/rev/5e36bbfd7025804743c31cfa5122dbbec09cb21f/glean-core/android/src/main/java/mozilla/telemetry/glean/Glean.kt#573), that scans the upload directory. The second one attempts to dispatch the worker, but since we use a [`KEEP` policy it basically does nothing](https://searchfox.org/glean/rev/5e36bbfd7025804743c31cfa5122dbbec09cb21f/glean-core/android/src/main/java/mozilla/telemetry/glean/scheduler/PingUploadWorker.kt#150). If the job dispatched from the first ping finishes [iterating the directory](https://searchfox.org/glean/rev/5e36bbfd7025804743c31cfa5122dbbec09cb21f/glean-core/android/src/main/java/mozilla/telemetry/glean/scheduler/PingUploadWorker.kt#107) while the second ping is still being written to disk, then we don't upload it. **No data is lost**: next time some upload is triggered we will upload that one too.\n\nJan-Erik, I suspect (6) will be dealt with using the new upload mechanism. Thoughts?", "attachment_id": null, "author": "alessio.placitelli@gmail.com", "id": 14788246, "is_private": false, "bug_id": 1632184, "creation_time": "2020-04-30T10:40:27Z", "count": 14, "raw_text": "Ok, here's some notes about what I was able to see. The notes in comment 10 are correct: the test is failing because the `startup-timeline` ping is generated and submitted before the other pings. Here's what I think is happening:\n\n1. Glean is initialized by the test [here](https://searchfox.org/mozilla-mobile/rev/0f569464dc94c5e16823ab6a8fb53a20ad36ac60/fenix/app/src/androidTest/java/org/mozilla/fenix/glean/BaselinePingTest.kt#49). [Using the testrule](https://searchfox.org/mozilla-mobile/rev/0f569464dc94c5e16823ab6a8fb53a20ad36ac60/fenix/app/src/androidTest/java/org/mozilla/fenix/glean/BaselinePingTest.kt#40) makes sure that Glean is in `test mode`.\n2.  The test [moves the app to background after 1s](https://searchfox.org/mozilla-mobile/rev/0f569464dc94c5e16823ab6a8fb53a20ad36ac60/fenix/app/src/androidTest/java/org/mozilla/fenix/glean/BaselinePingTest.kt#88).\n3. When going to background, both glean and fenix generate some pings. Glean is supposed to send a `baseline` with reason `background`, while Fenix [generates a `startup-timeline`](https://searchfox.org/mozilla-mobile/rev/0f569464dc94c5e16823ab6a8fb53a20ad36ac60/fenix/app/src/main/java/org/mozilla/fenix/perf/StartupTimeline.kt#94).\n4. The order with which the pings are generated is non deterministic and depends by the OS.\n5.  Both pings end up calling [submitPingByName](https://searchfox.org/glean/rev/5e36bbfd7025804743c31cfa5122dbbec09cb21f/glean-core/android/src/main/java/mozilla/telemetry/glean/Glean.kt#535) down the line, which is async in general, but sync when in test mode.\n6. Both pings are successfully collected (see the logs). However, the first one [dispatches the worker for upload](https://searchfox.org/glean/rev/5e36bbfd7025804743c31cfa5122dbbec09cb21f/glean-core/android/src/main/java/mozilla/telemetry/glean/Glean.kt#573), that scans the upload directory. The second one attempts to dispatch the worker, but since we use a [`KEEP` policy it basically does nothing](https://searchfox.org/glean/rev/5e36bbfd7025804743c31cfa5122dbbec09cb21f/glean-core/android/src/main/java/mozilla/telemetry/glean/scheduler/PingUploadWorker.kt#150). If the job dispatched from the first ping finishes [iterating the directory](https://searchfox.org/glean/rev/5e36bbfd7025804743c31cfa5122dbbec09cb21f/glean-core/android/src/main/java/mozilla/telemetry/glean/scheduler/PingUploadWorker.kt#107) while the second ping is still being written to disk, then we don't upload it. **No data is lost**: next time some upload is triggered we will upload that one too.\n\nJan-Erik, I suspect (6) will be dealt with using the new upload mechanism. Thoughts?", "creator": "alessio.placitelli@gmail.com", "time": "2020-04-30T10:40:27Z", "tags": []}, {"raw_text": "Yup, the new mechanism should deal with it, but we should probably add a test for this exact case just to be sure. I'll file a bug.", "creation_time": "2020-04-30T11:59:18Z", "count": 15, "tags": [], "time": "2020-04-30T11:59:18Z", "creator": "jrediger@mozilla.com", "attachment_id": null, "author": "jrediger@mozilla.com", "id": 14788413, "text": "Yup, the new mechanism should deal with it, but we should probably add a test for this exact case just to be sure. I'll file a bug.", "bug_id": 1632184, "is_private": false}, {"time": "2020-04-30T14:32:28Z", "creator": "alessio.placitelli@gmail.com", "tags": [], "creation_time": "2020-04-30T14:32:28Z", "count": 16, "raw_text": "", "bug_id": 1632184, "is_private": false, "text": "Created attachment 9144702\nGitHub Pull Request", "attachment_id": 9144702, "author": "alessio.placitelli@gmail.com", "id": 14788832}]}}}