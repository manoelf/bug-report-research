{"comments": {}, "bugs": {"667865": {"comments": [{"id": 5561250, "raw_text": "User Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_6_8) AppleWebKit/534.30 (KHTML, like Gecko) Chrome/12.0.742.100 Safari/534.30\n\nSteps to reproduce:\n\nClick a link for a non-http protocol URL lastfm://artist/Radiohead\n\n\nActual results:\n\nwindow.onbeforeunload handler is triggered, whether the protocol is recognised or not.\n\n\nExpected results:\n\nNothing, the window is not being unloaded. You'll either get a modal dialog asking which app should handle the protocol; a warning saying no app could be found to handle the protocol; or an app launching on the client side. The page state remains unaffected.", "attachment_id": null, "time": "2011-06-28T10:53:22Z", "tags": [], "bug_id": 667865, "text": "User Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_6_8) AppleWebKit/534.30 (KHTML, like Gecko) Chrome/12.0.742.100 Safari/534.30\n\nSteps to reproduce:\n\nClick a link for a non-http protocol URL lastfm://artist/Radiohead\n\n\nActual results:\n\nwindow.onbeforeunload handler is triggered, whether the protocol is recognised or not.\n\n\nExpected results:\n\nNothing, the window is not being unloaded. You'll either get a modal dialog asking which app should handle the protocol; a warning saying no app could be found to handle the protocol; or an app launching on the client side. The page state remains unaffected.", "author": "james@wheare.org", "creation_time": "2011-06-28T10:53:22Z", "count": 0, "creator": "james@wheare.org", "is_private": false}, {"is_private": false, "creator": "james@wheare.org", "creation_time": "2011-06-28T10:55:01Z", "author": "james@wheare.org", "text": "This behaviour results in the need to target all non-http protocol urls to a hidden iframe, which can lead to mixed-content warnings in Chrome. See http://code.google.com/p/chromium/issues/detail?id=87737", "tags": [], "time": "2011-06-28T10:55:01Z", "attachment_id": null, "raw_text": "This behaviour results in the need to target all non-http protocol urls to a hidden iframe, which can lead to mixed-content warnings in Chrome. See http://code.google.com/p/chromium/issues/detail?id=87737", "id": 5561252, "count": 1, "bug_id": 667865}, {"author": "bzbarsky@mit.edu", "creation_time": "2011-06-28T20:30:53Z", "tags": [], "time": "2011-06-28T20:30:53Z", "bug_id": 667865, "text": "> Nothing, the window is not being unloaded.\n\nThat's not known yet at the point at which beforeunload is fired....", "creator": "bzbarsky@mit.edu", "is_private": false, "count": 2, "id": 5562650, "attachment_id": null, "raw_text": "> Nothing, the window is not being unloaded.\n\nThat's not known yet at the point at which beforeunload is fired...."}, {"bug_id": 667865, "time": "2011-06-28T20:31:50Z", "tags": [], "text": "If it's not known, it shouldn't assume that it will though. Wait till it's known and then fire it, no?", "author": "james@wheare.org", "creation_time": "2011-06-28T20:31:50Z", "count": 3, "creator": "james@wheare.org", "is_private": false, "id": 5562657, "raw_text": "If it's not known, it shouldn't assume that it will though. Wait till it's known and then fire it, no?", "attachment_id": null}, {"id": 5562720, "attachment_id": null, "raw_text": "Unfortunately, beforeunload is supposed to fire before the attempt to get any data from the URI is made.  So no, you can't wait until it's known.  See <http://www.whatwg.org/specs/web-apps/current-work/multipage/history.html#navigating-across-documents>.  Beforeunload is fired at step 10.  You start actually doing something with the URI being navigated to in step 13.", "creation_time": "2011-06-28T20:45:49Z", "author": "bzbarsky@mit.edu", "text": "Unfortunately, beforeunload is supposed to fire before the attempt to get any data from the URI is made.  So no, you can't wait until it's known.  See <http://www.whatwg.org/specs/web-apps/current-work/multipage/history.html#navigating-across-documents>.  Beforeunload is fired at step 10.  You start actually doing something with the URI being navigated to in step 13.", "time": "2011-06-28T20:45:49Z", "tags": [], "is_private": false, "creator": "bzbarsky@mit.edu", "bug_id": 667865, "count": 4}, {"bug_id": 667865, "count": 5, "time": "2011-06-28T21:11:24Z", "tags": [], "text": "What about step 9?\n\n\"If the new resource is to be handled using a mechanism that does not affect the browsing context, e.g. ignoring the navigation request altogether because the specified scheme is not one of the supported protocols, then abort these steps and proceed with that mechanism instead.\"\n\nAlthough step 12 again talks about those \"unsupported protocols\" so that document seems pretty confused. Makes my brain hurt at the least.\n\nAnyway, I'm just reporting what appears to be broken behaviour from an end user's perspective. If this is due to the enforcement of a spec, then perhaps the spec is at fault, or at least subject to discussion. As far as I'm aware, that document is partially a description of how browsers work currently, warts on all, so may be advocating undesired behaviour?\n\nIf firing the onbeforeunload event is the agreed upon way for a user agent to \"prompt to unload\" the page, it's unclear how a user or scripted website can make a clear to decision on whether to allow the unload or not. Does the event contain any information on why the unloading is taking place?", "author": "james@wheare.org", "creation_time": "2011-06-28T21:11:24Z", "creator": "james@wheare.org", "is_private": false, "id": 5562821, "raw_text": "What about step 9?\n\n\"If the new resource is to be handled using a mechanism that does not affect the browsing context, e.g. ignoring the navigation request altogether because the specified scheme is not one of the supported protocols, then abort these steps and proceed with that mechanism instead.\"\n\nAlthough step 12 again talks about those \"unsupported protocols\" so that document seems pretty confused. Makes my brain hurt at the least.\n\nAnyway, I'm just reporting what appears to be broken behaviour from an end user's perspective. If this is due to the enforcement of a spec, then perhaps the spec is at fault, or at least subject to discussion. As far as I'm aware, that document is partially a description of how browsers work currently, warts on all, so may be advocating undesired behaviour?\n\nIf firing the onbeforeunload event is the agreed upon way for a user agent to \"prompt to unload\" the page, it's unclear how a user or scripted website can make a clear to decision on whether to allow the unload or not. Does the event contain any information on why the unloading is taking place?", "attachment_id": null}, {"id": 5562884, "raw_text": "At step 9 we don't know yet whether this protocol is supported; it could be mapped to a webapp.\n\n> Does the event contain any information on why the unloading is taking place?\n\nNo.\n\nNote, by the way that you could have a link to an HTTP URI that still doesn't unload the page (e.g. it has content-disposition:attachment)...", "attachment_id": null, "text": "At step 9 we don't know yet whether this protocol is supported; it could be mapped to a webapp.\n\n> Does the event contain any information on why the unloading is taking place?\n\nNo.\n\nNote, by the way that you could have a link to an HTTP URI that still doesn't unload the page (e.g. it has content-disposition:attachment)...", "bug_id": 667865, "time": "2011-06-28T21:25:41Z", "tags": [], "creation_time": "2011-06-28T21:25:41Z", "author": "bzbarsky@mit.edu", "count": 6, "is_private": false, "creator": "bzbarsky@mit.edu"}, {"attachment_id": null, "raw_text": "(In reply to Boris Zbarsky (:bz) from comment #6)\n> At step 9 we don't know yet whether this protocol is supported; it could be\n> mapped to a webapp.\n\nSo check the list of webapp mappings first.\n\n> Note, by the way that you could have a link to an HTTP URI that still\n> doesn't unload the page (e.g. it has content-disposition:attachment)...\n\nAnd in that case, I would say that onbeforeunload shouldn't fire until the response headers are read.", "id": 5972426, "is_private": false, "creator": "james@wheare.org", "creation_time": "2012-01-11T17:30:06Z", "author": "james@wheare.org", "text": "(In reply to Boris Zbarsky (:bz) from comment #6)\n> At step 9 we don't know yet whether this protocol is supported; it could be\n> mapped to a webapp.\n\nSo check the list of webapp mappings first.\n\n> Note, by the way that you could have a link to an HTTP URI that still\n> doesn't unload the page (e.g. it has content-disposition:attachment)...\n\nAnd in that case, I would say that onbeforeunload shouldn't fire until the response headers are read.", "time": "2012-01-11T17:30:06Z", "tags": [], "count": 7, "bug_id": 667865}, {"is_private": false, "creator": "bzbarsky@mit.edu", "count": 8, "creation_time": "2012-01-11T17:41:08Z", "author": "bzbarsky@mit.edu", "text": "> So check the list of webapp mappings first.\n\nWe can't; we don't know what the final URI will be yet.  This could be an HTTP load that does a 3xx redirect to a URI that a webapp can handle.\n\n> And in that case, I would say that onbeforeunload shouldn't fire until the response\n> headers are read.\n\nSee comment 4.  The web depends on beforeunload firing before a request is actually made to the server.  Changing that breaks websites.", "bug_id": 667865, "tags": [], "time": "2012-01-11T17:41:08Z", "attachment_id": null, "raw_text": "> So check the list of webapp mappings first.\n\nWe can't; we don't know what the final URI will be yet.  This could be an HTTP load that does a 3xx redirect to a URI that a webapp can handle.\n\n> And in that case, I would say that onbeforeunload shouldn't fire until the response\n> headers are read.\n\nSee comment 4.  The web depends on beforeunload firing before a request is actually made to the server.  Changing that breaks websites.", "id": 5972469}, {"tags": [], "time": "2012-01-11T18:12:11Z", "bug_id": 667865, "text": "(In reply to Boris Zbarsky (:bz) from comment #8)\n> We can't; we don't know what the final URI will be yet.  This could be an\n> HTTP load that does a 3xx redirect to a URI that a webapp can handle.\n\nOK, but could you not check the mappings for the case where you do know the protocol though. Sure it wouldn't catch all cases (and fair point about content-disposition, it couldn't catch that either) but it would at least be an improvement.", "author": "james@wheare.org", "creation_time": "2012-01-11T18:12:11Z", "count": 9, "creator": "james@wheare.org", "is_private": false, "id": 5972552, "raw_text": "(In reply to Boris Zbarsky (:bz) from comment #8)\n> We can't; we don't know what the final URI will be yet.  This could be an\n> HTTP load that does a 3xx redirect to a URI that a webapp can handle.\n\nOK, but could you not check the mappings for the case where you do know the protocol though. Sure it wouldn't catch all cases (and fair point about content-disposition, it couldn't catch that either) but it would at least be an improvement.", "attachment_id": null}, {"author": "bzbarsky@mit.edu", "creation_time": "2012-01-11T18:19:15Z", "tags": [], "time": "2012-01-11T18:19:15Z", "bug_id": 667865, "text": "We could try... that's why the bug is still open!", "creator": "bzbarsky@mit.edu", "is_private": false, "count": 10, "id": 5972619, "attachment_id": null, "raw_text": "We could try... that's why the bug is still open!"}, {"id": 6738382, "attachment_id": null, "raw_text": "I can confirm the bug mentioned by Boris in comment #6. \n\nThere are other open bugs (where it gets fired twice), this all makes onbeforeunload   unreliable for a web app. I hope there's a easy/quick answer.", "creation_time": "2012-10-17T17:29:24Z", "author": "sunil@armor5.com", "text": "I can confirm the bug mentioned by Boris in comment #6. \n\nThere are other open bugs (where it gets fired twice), this all makes onbeforeunload   unreliable for a web app. I hope there's a easy/quick answer.", "tags": [], "time": "2012-10-17T17:29:24Z", "is_private": false, "creator": "sunil@armor5.com", "bug_id": 667865, "count": 11}, {"is_private": false, "creator": "duanyao.ustc@gmail.com", "text": "I note that mailto: protocol doesn't trigger beforeunload event in Firefox 40", "time": "2015-09-06T10:31:15Z", "tags": [], "creation_time": "2015-09-06T10:31:15Z", "author": "duanyao.ustc@gmail.com", "raw_text": "I note that mailto: protocol doesn't trigger beforeunload event in Firefox 40", "attachment_id": null, "id": 10700682, "count": 12, "bug_id": 667865}]}}}