{"bugs": {"667412": {"comments": [{"text": "Created attachment 542116\nTestcase\n\nI encountered this when trying to assess performance with the patch for bug 664087, and also whether recent bidi performance work has fixed bug 376359, but this is not a bidi issue -- this version of the testcase is LTR text only and still shows the problem.\n\nIn a profile of loading the testcase, 77.4% is spent in nsLineBox::RFindLineContaining, called from nsBlockFrame::AddFrames. Apparently we are hitting the \"less common\" case referred to in the comment there:\n\n    // XXX_perf This is technically O(N^2) in some cases, but by using\n    // RFind instead of Find, we make it O(N) in the most common case,\n    // which is appending content.", "count": 0, "author": "smontagu@smontagu.org", "id": 5558296, "bug_id": 667412, "time": "2011-06-27T10:05:41Z", "raw_text": "I encountered this when trying to assess performance with the patch for bug 664087, and also whether recent bidi performance work has fixed bug 376359, but this is not a bidi issue -- this version of the testcase is LTR text only and still shows the problem.\n\nIn a profile of loading the testcase, 77.4% is spent in nsLineBox::RFindLineContaining, called from nsBlockFrame::AddFrames. Apparently we are hitting the \"less common\" case referred to in the comment there:\n\n    // XXX_perf This is technically O(N^2) in some cases, but by using\n    // RFind instead of Find, we make it O(N) in the most common case,\n    // which is appending content.", "creator": "smontagu@smontagu.org", "is_private": false, "creation_time": "2011-06-27T10:05:41Z", "attachment_id": 542116, "tags": []}, {"id": 5559617, "bug_id": 667412, "is_private": false, "creation_time": "2011-06-27T20:26:18Z", "creator": "bzbarsky@mit.edu", "count": 1, "text": "Ah, this is an interesting case.  So the point here is that the textarea has tons of lines and that some of them are longer than the textarea width.  Each such line causes us to wrap and create a continuation, and then we have to find the right line to put that continuation in.  And we do the search in reverse, but the continuations are inserted all over, so it ends up being O(N^2).  Messing with the search order would not help here, of course.\n\nfantasai, do you think we can try to do better here after the split?  If so, we should add a dep.", "author": "bzbarsky@mit.edu", "tags": [], "time": "2011-06-27T20:26:18Z", "raw_text": "Ah, this is an interesting case.  So the point here is that the textarea has tons of lines and that some of them are longer than the textarea width.  Each such line causes us to wrap and create a continuation, and then we have to find the right line to put that continuation in.  And we do the search in reverse, but the continuations are inserted all over, so it ends up being O(N^2).  Messing with the search order would not help here, of course.\n\nfantasai, do you think we can try to do better here after the split?  If so, we should add a dep.", "attachment_id": null}, {"tags": [], "raw_text": "What I was thinking was that when we call InsertFrames from nsTextFrame::SetLength we already know the line (at least some of the time), so maybe we could pass it in and avoid the search?", "attachment_id": null, "time": "2011-06-27T20:34:21Z", "creation_time": "2011-06-27T20:34:21Z", "is_private": false, "id": 5559649, "bug_id": 667412, "text": "What I was thinking was that when we call InsertFrames from nsTextFrame::SetLength we already know the line (at least some of the time), so maybe we could pass it in and avoid the search?", "count": 2, "author": "smontagu@smontagu.org", "creator": "smontagu@smontagu.org"}, {"text": "We could try...\n\nThis seems like a situation that would be helped by something like a line cursor, actually: during reflow, search forward from the line currently being reflowed.", "count": 3, "author": "bzbarsky@mit.edu", "id": 5559751, "bug_id": 667412, "raw_text": "We could try...\n\nThis seems like a situation that would be helped by something like a line cursor, actually: during reflow, search forward from the line currently being reflowed.", "time": "2011-06-27T21:15:11Z", "creator": "bzbarsky@mit.edu", "creation_time": "2011-06-27T21:15:11Z", "is_private": false, "attachment_id": null, "tags": []}, {"count": 4, "text": "Passing in the line helps some, but it leaves us spending 44% of the time in nsLineBox::IndexOf, called from BuildTextRuns via the nsBlockInFlowLineIterator ctor.", "author": "smontagu@smontagu.org", "creator": "smontagu@smontagu.org", "is_private": false, "creation_time": "2011-06-28T18:04:53Z", "id": 5562216, "bug_id": 667412, "raw_text": "Passing in the line helps some, but it leaves us spending 44% of the time in nsLineBox::IndexOf, called from BuildTextRuns via the nsBlockInFlowLineIterator ctor.", "attachment_id": null, "time": "2011-06-28T18:04:53Z", "tags": []}, {"tags": [], "attachment_id": null, "is_private": false, "creation_time": "2011-06-28T18:45:51Z", "creator": "fantasai.bugs@inkedblade.net", "time": "2011-06-28T18:45:51Z", "raw_text": "I doubt the split would make a difference in what we can do here.", "bug_id": 667412, "id": 5562329, "text": "I doubt the split would make a difference in what we can do here.", "count": 5, "author": "fantasai.bugs@inkedblade.net"}, {"raw_text": "OK.  Do we have existing bugs on making it possible to add kids to a block without finding the right line?  I seem to recall some proposals about that...", "time": "2011-06-28T19:35:46Z", "count": 6, "text": "OK.  Do we have existing bugs on making it possible to add kids to a block without finding the right line?  I seem to recall some proposals about that...", "author": "bzbarsky@mit.edu", "id": 5562491, "bug_id": 667412, "attachment_id": null, "tags": [], "creator": "bzbarsky@mit.edu", "is_private": false, "creation_time": "2011-06-28T19:35:46Z"}, {"author": "bzbarsky@mit.edu", "text": "This might be the same issue as bug 561578.", "count": 7, "creator": "bzbarsky@mit.edu", "creation_time": "2011-08-25T19:06:35Z", "is_private": false, "bug_id": 667412, "id": 5678486, "attachment_id": null, "raw_text": "This might be the same issue as bug 561578.", "time": "2011-08-25T19:06:35Z", "tags": []}, {"creator": "bzbarsky@mit.edu", "is_private": false, "creation_time": "2011-08-25T19:09:53Z", "attachment_id": null, "tags": [], "author": "bzbarsky@mit.edu", "text": "Or more precisely, the underlying problem is the same: bug 190147.", "count": 8, "id": 5678492, "bug_id": 667412, "raw_text": "Or more precisely, the underlying problem is the same: bug 190147.", "time": "2011-08-25T19:09:53Z"}, {"creator": "cedricv@neonux.com", "creation_time": "2011-09-07T20:16:01Z", "is_private": false, "attachment_id": null, "tags": [], "text": "A much shorter yet reproducible testcase on any textarea (not specially narrow) seems to be Github's stylesheet ( https://a248.e.akamai.net/assets.github.com/stylesheets/bundle_github.css - 'only' 300kB with very long lines).", "count": 9, "author": "cedricv@neonux.com", "bug_id": 667412, "id": 5705792, "raw_text": "A much shorter yet reproducible testcase on any textarea (not specially narrow) seems to be Github's stylesheet ( https://a248.e.akamai.net/assets.github.com/stylesheets/bundle_github.css - 'only' 300kB with very long lines).", "time": "2011-09-07T20:16:01Z"}, {"bug_id": 667412, "id": 5705833, "is_private": false, "creation_time": "2011-09-07T20:28:13Z", "creator": "bzbarsky@mit.edu", "author": "bzbarsky@mit.edu", "count": 10, "text": "The key part for this bug is that the textarea be narrow compared to the width of a typical line so there are lots of continuations being created.", "tags": [], "time": "2011-09-07T20:28:13Z", "attachment_id": null, "raw_text": "The key part for this bug is that the textarea be narrow compared to the width of a typical line so there are lots of continuations being created."}, {"author": "ehsan.akhgari@gmail.com", "count": 11, "text": "As far as I can tell, fixing bug 682052 is the only way that this will ever be fixed, right?", "creator": "ehsan.akhgari@gmail.com", "creation_time": "2011-09-07T23:15:29Z", "is_private": false, "id": 5706320, "bug_id": 667412, "attachment_id": null, "raw_text": "As far as I can tell, fixing bug 682052 is the only way that this will ever be fixed, right?", "time": "2011-09-07T23:15:29Z", "tags": []}, {"time": "2011-09-08T00:27:44Z", "raw_text": "That's the only way this will get _closer_ to being fixed.  Once we fix that, we might find another hotspot.  :(", "bug_id": 667412, "id": 5706490, "author": "bzbarsky@mit.edu", "text": "That's the only way this will get _closer_ to being fixed.  Once we fix that, we might find another hotspot.  :(", "count": 12, "tags": [], "attachment_id": null, "is_private": false, "creation_time": "2011-09-08T00:27:44Z", "creator": "bzbarsky@mit.edu"}, {"attachment_id": null, "tags": [], "creator": "rjesup@jesup.org", "is_private": false, "creation_time": "2017-09-20T17:09:35Z", "time": "2017-09-20T17:09:35Z", "raw_text": "Current Gecko Profiler trace says 76% in nsLineBox::RFindLineContaining() (no surprise), and 17% in nsTextFrame::LastInFlow(), and 2% in BuildTextRuns()", "author": "rjesup@jesup.org", "count": 13, "text": "Current Gecko Profiler trace says 76% in nsLineBox::RFindLineContaining() (no surprise), and 17% in nsTextFrame::LastInFlow(), and 2% in BuildTextRuns()", "bug_id": 667412, "id": 12686529}]}}, "comments": {}}