{"bugs": {"1633747": {"comments": [{"creation_time": "2020-04-28T14:17:54Z", "attachment_id": null, "creator": "padenot@mozilla.com", "id": 14783930, "text": "It's problematic to pass buffers containing `NaN` to the OS. Sheppy reports that it kills his system audio and he needed to reboot, and in my case, it kills the audio of the machine until the page that were outputing the audio is closed. We are both on OSX.\n\nSince it's fairly easy to make a mistake in an `AudioWorkletProcessor` and output `NaN`, we need to do something about it.\n\nI have some vector code that change `NaN` to 0.0f running in about 30ns for a block of 128 frames  (compared to 250+ns with naive scalar code) on x86 (I haven't tested ARM yet), so the performance impact is too small to matter.\n\nI don't know if we want to do this per `AudioWorkletProcessor` instance, and potentially log a message to the developer console. For now the patch is going to be in `GraphDriver.cpp`.", "raw_text": "It's problematic to pass buffers containing `NaN` to the OS. Sheppy reports that it kills his system audio and he needed to reboot, and in my case, it kills the audio of the machine until the page that were outputing the audio is closed. We are both on OSX.\n\nSince it's fairly easy to make a mistake in an `AudioWorkletProcessor` and output `NaN`, we need to do something about it.\n\nI have some vector code that change `NaN` to 0.0f running in about 30ns for a block of 128 frames  (compared to 250+ns with naive scalar code) on x86 (I haven't tested ARM yet), so the performance impact is too small to matter.\n\nI don't know if we want to do this per `AudioWorkletProcessor` instance, and potentially log a message to the developer console. For now the patch is going to be in `GraphDriver.cpp`.", "time": "2020-04-28T14:17:54Z", "author": "padenot@mozilla.com", "tags": [], "bug_id": 1633747, "is_private": false, "count": 0}, {"attachment_id": 9144099, "creator": "padenot@mozilla.com", "time": "2020-04-28T18:44:45Z", "creation_time": "2020-04-28T18:44:45Z", "raw_text": "", "is_private": false, "count": 1, "bug_id": 1633747, "tags": [], "text": "Created attachment 9144099\nBug 1633747 - Flush NaNs to zeros before handing back the audio output buffer to the OS.  r?karlt", "id": 14784746, "author": "padenot@mozilla.com"}, {"author": "padenot@mozilla.com", "is_private": false, "count": 2, "bug_id": 1633747, "tags": [], "raw_text": "A micro-benchmark for this vector code, between scalar, normal SSE, unrolled SSE.\n\nTypical output on my machine (Macbook 2018 core i9, unclear which exact CPU model):\n\n```\nprep:\t       1808298ns\nscalar code:\t145492ns\nsingle sse:\t 55848ns\nvector sse:\t 40060ns\n```\n\n`_mm_cmpord_ps` is the only new instruction we use here  (compared to the other functions), and is in SSE, so it's fine.\n\nI'll note that even with this, Sheppy's page doesn't stop affecting the rest of the audio of the computer, because apparently, computing with NaN makes SpiderMonkey deoptimizes heavily, and the page is around 1.5x to 2x the real-time budget, and the thread is shared: I'm on a mac, that doesn't have audioipc preffed on, so it's using a thread from CoreAudio, macOS audio API. So there is audio, but it's under-runing constantly.\n\nBut at least NaN aren't fed into the OS's mixer, so _some_ audio comes out, and it won't confuse audio hardware.", "time": "2020-04-28T19:21:02Z", "id": 14784797, "text": "Created attachment 9144114\nmicrobenchmark.cpp\n\nA micro-benchmark for this vector code, between scalar, normal SSE, unrolled SSE.\n\nTypical output on my machine (Macbook 2018 core i9, unclear which exact CPU model):\n\n```\nprep:\t       1808298ns\nscalar code:\t145492ns\nsingle sse:\t 55848ns\nvector sse:\t 40060ns\n```\n\n`_mm_cmpord_ps` is the only new instruction we use here  (compared to the other functions), and is in SSE, so it's fine.\n\nI'll note that even with this, Sheppy's page doesn't stop affecting the rest of the audio of the computer, because apparently, computing with NaN makes SpiderMonkey deoptimizes heavily, and the page is around 1.5x to 2x the real-time budget, and the thread is shared: I'm on a mac, that doesn't have audioipc preffed on, so it's using a thread from CoreAudio, macOS audio API. So there is audio, but it's under-runing constantly.\n\nBut at least NaN aren't fed into the OS's mixer, so _some_ audio comes out, and it won't confuse audio hardware.", "creation_time": "2020-04-28T19:21:02Z", "attachment_id": 9144114, "creator": "padenot@mozilla.com"}, {"time": "2020-05-04T09:50:12Z", "raw_text": "Pushed by padenot@mozilla.com:\nhttps://hg.mozilla.org/integration/autoland/rev/4c436ccdc5a2\nFlush NaNs to zeros before handing back the audio output buffer to the OS.  r=karlt", "bug_id": 1633747, "tags": [], "is_private": false, "count": 3, "author": "pulsebot@bots.tld", "attachment_id": null, "creator": "pulsebot@bots.tld", "creation_time": "2020-05-04T09:50:12Z", "id": 14795308, "text": "Pushed by padenot@mozilla.com:\nhttps://hg.mozilla.org/integration/autoland/rev/4c436ccdc5a2\nFlush NaNs to zeros before handing back the audio output buffer to the OS.  r=karlt"}, {"author": "padenot@mozilla.com", "tags": [], "bug_id": 1633747, "count": 4, "is_private": false, "raw_text": "", "time": "2020-05-04T10:12:53Z", "text": "Created attachment 9145397\nBug 1633747 - Don't call NaN fixing code on platforms where samples are in i16.", "id": 14795349, "creation_time": "2020-05-04T10:12:53Z", "attachment_id": 9145397, "creator": "padenot@mozilla.com"}, {"raw_text": "Pushed by padenot@mozilla.com:\nhttps://hg.mozilla.org/integration/autoland/rev/0449241c55ca\nDon't call NaN fixing code on platforms where samples are in i16.", "time": "2020-05-04T10:19:40Z", "author": "pulsebot@bots.tld", "tags": [], "bug_id": 1633747, "count": 5, "is_private": false, "creation_time": "2020-05-04T10:19:40Z", "attachment_id": null, "creator": "pulsebot@bots.tld", "id": 14795364, "text": "Pushed by padenot@mozilla.com:\nhttps://hg.mozilla.org/integration/autoland/rev/0449241c55ca\nDon't call NaN fixing code on platforms where samples are in i16."}, {"raw_text": "https://hg.mozilla.org/mozilla-central/rev/4c436ccdc5a2\nhttps://hg.mozilla.org/mozilla-central/rev/0449241c55ca", "time": "2020-05-04T15:54:38Z", "author": "malexandru@mozilla.com", "count": 6, "is_private": false, "bug_id": 1633747, "tags": ["bugherder"], "creation_time": "2020-05-04T15:54:38Z", "attachment_id": null, "creator": "malexandru@mozilla.com", "text": "https://hg.mozilla.org/mozilla-central/rev/4c436ccdc5a2\nhttps://hg.mozilla.org/mozilla-central/rev/0449241c55ca", "id": 14796032}]}}, "comments": {}}