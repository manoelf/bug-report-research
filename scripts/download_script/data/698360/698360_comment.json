{"bugs": {"698360": {"comments": [{"text": "Please use Fx8.0b5 to repro. The problem exists on trunk, but it's not as clear that the dom is cached because the image I am inserting onload does not show (maybe something is wrong with my error console code, what?).\n\n1. start with new profile, one window, one tab\n2. open the error console, show only errors\n3. eval the following code:\n___________________________________________________\nvar tb = Components.classes[\"@mozilla.org/appshell/window-mediator;1\"].getService(Components.interfaces.nsIWindowMediator).getMostRecentWindow('navigator:browser').gBrowser; tb.addEventListener('DOMContentLoaded', function(e) {var url = e.target.location.href; if (url !== 'http://www.google.com/search?q=whatever') return; Components.utils.reportError(e.type);}, true); tb.addEventListener('load', function(e) {var url = e.target.location.href; if (url !== 'http://www.google.com/search?q=whatever') return; Components.utils.reportError(e.type); var doc = e.target; document.body.insertBefore(document.createElement('IMG'), document.body.firstChild).src = 'http://www.google.com/images/nav_logo91.png';}, true); tb.addEventListener('pageshow', function(e) {var url = e.target.location.href; if (url !== 'http://www.google.com/search?q=whatever') return; Components.utils.reportError(e.type + (e.persisted ? ' : cached' : ' : uncached'));}, true);\n___________________________________________________\n\n4. load http://www.google.com/search?q=whatever\n5. click on maps\n6. go back, the first time you go back, just \"pageshow\" fires\n7. go forward and quickly back again.  When the maps page loads, the progress spinner stops, then briefly restarts again as something on the page updates.  To repro this, it's essential to go back immediately after the maps page appears, don't wait till the spinner restart.\n8. now when you go back, both \"load\" and \"pageshow\" fire, and persisted is false, however the DOM is bfcached, you can see another image added and DOMContentLoaded does not fire, so load should not fire and persisted should be true", "attachment_id": null, "time": "2011-10-31T10:02:33Z", "creation_time": "2011-10-31T10:02:33Z", "raw_text": "Please use Fx8.0b5 to repro. The problem exists on trunk, but it's not as clear that the dom is cached because the image I am inserting onload does not show (maybe something is wrong with my error console code, what?).\n\n1. start with new profile, one window, one tab\n2. open the error console, show only errors\n3. eval the following code:\n___________________________________________________\nvar tb = Components.classes[\"@mozilla.org/appshell/window-mediator;1\"].getService(Components.interfaces.nsIWindowMediator).getMostRecentWindow('navigator:browser').gBrowser; tb.addEventListener('DOMContentLoaded', function(e) {var url = e.target.location.href; if (url !== 'http://www.google.com/search?q=whatever') return; Components.utils.reportError(e.type);}, true); tb.addEventListener('load', function(e) {var url = e.target.location.href; if (url !== 'http://www.google.com/search?q=whatever') return; Components.utils.reportError(e.type); var doc = e.target; document.body.insertBefore(document.createElement('IMG'), document.body.firstChild).src = 'http://www.google.com/images/nav_logo91.png';}, true); tb.addEventListener('pageshow', function(e) {var url = e.target.location.href; if (url !== 'http://www.google.com/search?q=whatever') return; Components.utils.reportError(e.type + (e.persisted ? ' : cached' : ' : uncached'));}, true);\n___________________________________________________\n\n4. load http://www.google.com/search?q=whatever\n5. click on maps\n6. go back, the first time you go back, just \"pageshow\" fires\n7. go forward and quickly back again.  When the maps page loads, the progress spinner stops, then briefly restarts again as something on the page updates.  To repro this, it's essential to go back immediately after the maps page appears, don't wait till the spinner restart.\n8. now when you go back, both \"load\" and \"pageshow\" fire, and persisted is false, however the DOM is bfcached, you can see another image added and DOMContentLoaded does not fire, so load should not fire and persisted should be true", "bug_id": 698360, "is_private": false, "count": 0, "tags": [], "id": 5814751, "creator": "al_9x@yahoo.com", "author": "al_9x@yahoo.com"}, {"creation_time": "2011-11-01T03:34:25Z", "raw_text": "There is a mistake in my load handler, I declare a doc var (var doc = e.target) but insert the img via \"document.\"  With this corrected, it highlights the problem as intended (Fx8 and trunk).  I think I used correct code with Fx8, but somehow introduced the problem and pasted it here with the error.  Here is the corrected code, please try it:\n\n___________________________________________________\nvar tb = Components.classes[\"@mozilla.org/appshell/window-mediator;1\"].getService(Components.interfaces.nsIWindowMediator).getMostRecentWindow('navigator:browser').gBrowser; tb.addEventListener('DOMContentLoaded', function(e) {var url = e.target.location.href; if (url !== 'http://www.google.com/search?q=whatever') return; Components.utils.reportError(e.type);}, true); tb.addEventListener('load', function(e) {var url = e.target.location.href; if (url !== 'http://www.google.com/search?q=whatever') return; Components.utils.reportError(e.type); var doc = e.target; doc.body.insertBefore(doc.createElement('IMG'), doc.body.firstChild).src = 'http://www.google.com/images/nav_logo91.png';}, true); tb.addEventListener('pageshow', function(e) {var url = e.target.location.href; if (url !== 'http://www.google.com/search?q=whatever') return; Components.utils.reportError(e.type + (e.persisted ? ' : cached' : ' : uncached'));}, true);\n___________________________________________________", "attachment_id": null, "time": "2011-11-01T03:34:25Z", "text": "There is a mistake in my load handler, I declare a doc var (var doc = e.target) but insert the img via \"document.\"  With this corrected, it highlights the problem as intended (Fx8 and trunk).  I think I used correct code with Fx8, but somehow introduced the problem and pasted it here with the error.  Here is the corrected code, please try it:\n\n___________________________________________________\nvar tb = Components.classes[\"@mozilla.org/appshell/window-mediator;1\"].getService(Components.interfaces.nsIWindowMediator).getMostRecentWindow('navigator:browser').gBrowser; tb.addEventListener('DOMContentLoaded', function(e) {var url = e.target.location.href; if (url !== 'http://www.google.com/search?q=whatever') return; Components.utils.reportError(e.type);}, true); tb.addEventListener('load', function(e) {var url = e.target.location.href; if (url !== 'http://www.google.com/search?q=whatever') return; Components.utils.reportError(e.type); var doc = e.target; doc.body.insertBefore(doc.createElement('IMG'), doc.body.firstChild).src = 'http://www.google.com/images/nav_logo91.png';}, true); tb.addEventListener('pageshow', function(e) {var url = e.target.location.href; if (url !== 'http://www.google.com/search?q=whatever') return; Components.utils.reportError(e.type + (e.persisted ? ' : cached' : ' : uncached'));}, true);\n___________________________________________________", "id": 5817145, "count": 1, "is_private": false, "tags": [], "bug_id": 698360, "author": "al_9x@yahoo.com", "creator": "al_9x@yahoo.com"}, {"id": 5818778, "tags": [], "is_private": false, "count": 2, "bug_id": 698360, "raw_text": "Boris, Olli,\n\nAre you able to repro this with code from comment 1?", "creation_time": "2011-11-01T19:40:56Z", "time": "2011-11-01T19:40:56Z", "attachment_id": null, "text": "Boris, Olli,\n\nAre you able to repro this with code from comment 1?", "author": "al_9x@yahoo.com", "creator": "al_9x@yahoo.com"}, {"bug_id": 698360, "is_private": false, "count": 3, "tags": [], "id": 5818791, "text": "I can reproduce the log entries, but I haven't had a chance to look into what the long script there is doing and hence what the expected behavior is.", "creator": "bzbarsky@mit.edu", "attachment_id": null, "time": "2011-11-01T19:44:49Z", "author": "bzbarsky@mit.edu", "creation_time": "2011-11-01T19:44:49Z", "raw_text": "I can reproduce the log entries, but I haven't had a chance to look into what the long script there is doing and hence what the expected behavior is."}, {"raw_text": " (In reply to Boris Zbarsky (:bz) from comment #3)\n> I can reproduce the log entries\n\nTo clarify, reproducing the bug would mean seeing 2 things when going back (quickly) from the maps page:\n\n1. two events logged:\nload\npageshow : uncached\n\n2. two inserted images, which demonstrates that the DOM was bfcached when the second image was added\n\nAre you seeing that?", "creation_time": "2011-11-01T20:02:30Z", "text": " (In reply to Boris Zbarsky (:bz) from comment #3)\n> I can reproduce the log entries\n\nTo clarify, reproducing the bug would mean seeing 2 things when going back (quickly) from the maps page:\n\n1. two events logged:\nload\npageshow : uncached\n\n2. two inserted images, which demonstrates that the DOM was bfcached when the second image was added\n\nAre you seeing that?", "creator": "al_9x@yahoo.com", "time": "2011-11-01T20:02:30Z", "attachment_id": null, "author": "al_9x@yahoo.com", "is_private": false, "count": 4, "tags": [], "id": 5818840, "bug_id": 698360}, {"author": "bzbarsky@mit.edu", "creator": "bzbarsky@mit.edu", "id": 5818941, "count": 5, "is_private": false, "tags": [], "bug_id": 698360, "raw_text": "Yep.", "creation_time": "2011-11-01T20:36:42Z", "attachment_id": null, "time": "2011-11-01T20:36:42Z", "text": "Yep."}, {"creator": "al_9x@yahoo.com", "text": "(In reply to Boris Zbarsky (:bz) from comment #5)\n> Yep.\n\nWhat is you assessment, is it a bug?  The page is bfcached, so load shouldn't fire and persisted should be true in pageshow?", "author": "al_9x@yahoo.com", "attachment_id": null, "time": "2011-11-04T01:28:13Z", "creation_time": "2011-11-04T01:28:13Z", "raw_text": "(In reply to Boris Zbarsky (:bz) from comment #5)\n> Yep.\n\nWhat is you assessment, is it a bug?  The page is bfcached, so load shouldn't fire and persisted should be true in pageshow?", "bug_id": 698360, "tags": [], "count": 6, "is_private": false, "id": 5825479}, {"author": "bzbarsky@mit.edu", "creator": "bzbarsky@mit.edu", "id": 5825629, "tags": [], "count": 7, "is_private": false, "bug_id": 698360, "raw_text": "At first glance, something is wrong, yes.  The big question is whether it's web-visible.", "creation_time": "2011-11-04T03:25:43Z", "time": "2011-11-04T03:25:43Z", "attachment_id": null, "text": "At first glance, something is wrong, yes.  The big question is whether it's web-visible."}, {"author": "al_9x@yahoo.com", "attachment_id": null, "time": "2011-11-04T04:11:17Z", "text": "(In reply to Boris Zbarsky (:bz) from comment #7)\n> At first glance, something is wrong, yes.  The big question is whether it's\n> web-visible.\n\nIf you're asking what happens when the load and pageshow listeners are attached to the content window (as opposed to chrome), the answer is, the same thing.  I first noticed this problem with a NoScript surrogate script, which did just that.  Here's a modified error console script which attaches load and pageshow to the content window in DOMContentLoaded:\n\nComponents.classes[\"@mozilla.org/appshell/window-mediator;1\"].getService(Components.interfaces.nsIWindowMediator).getMostRecentWindow('navigator:browser').gBrowser.addEventListener('DOMContentLoaded', function(e) {var win = e.target.defaultView; win.addEventListener('load', function(e) {var url = e.target.location.href; if (url !== 'http://www.google.com/search?q=whatever') return; Components.utils.reportError(e.type); var doc = e.target; doc.body.insertBefore(doc.createElement('IMG'), doc.body.firstChild).src = 'http://www.google.com/images/nav_logo91.png';}, false); win.addEventListener('pageshow', function(e) {var url = e.target.location.href; if (url !== 'http://www.google.com/search?q=whatever') return; Components.utils.reportError(e.type + (e.persisted ? ' : cached' : ' : uncached'));}, false); var url = e.target.location.href; if (url !== 'http://www.google.com/search?q=whatever') return; Components.utils.reportError(e.type);}, true);", "creator": "al_9x@yahoo.com", "creation_time": "2011-11-04T04:11:17Z", "raw_text": "(In reply to Boris Zbarsky (:bz) from comment #7)\n> At first glance, something is wrong, yes.  The big question is whether it's\n> web-visible.\n\nIf you're asking what happens when the load and pageshow listeners are attached to the content window (as opposed to chrome), the answer is, the same thing.  I first noticed this problem with a NoScript surrogate script, which did just that.  Here's a modified error console script which attaches load and pageshow to the content window in DOMContentLoaded:\n\nComponents.classes[\"@mozilla.org/appshell/window-mediator;1\"].getService(Components.interfaces.nsIWindowMediator).getMostRecentWindow('navigator:browser').gBrowser.addEventListener('DOMContentLoaded', function(e) {var win = e.target.defaultView; win.addEventListener('load', function(e) {var url = e.target.location.href; if (url !== 'http://www.google.com/search?q=whatever') return; Components.utils.reportError(e.type); var doc = e.target; doc.body.insertBefore(doc.createElement('IMG'), doc.body.firstChild).src = 'http://www.google.com/images/nav_logo91.png';}, false); win.addEventListener('pageshow', function(e) {var url = e.target.location.href; if (url !== 'http://www.google.com/search?q=whatever') return; Components.utils.reportError(e.type + (e.persisted ? ' : cached' : ' : uncached'));}, false); var url = e.target.location.href; if (url !== 'http://www.google.com/search?q=whatever') return; Components.utils.reportError(e.type);}, true);", "bug_id": 698360, "id": 5825675, "tags": [], "count": 8, "is_private": false}, {"attachment_id": null, "time": "2011-11-04T04:14:49Z", "text": "I'm asking what happens if that script runs in the page itself, not from chrome.", "raw_text": "I'm asking what happens if that script runs in the page itself, not from chrome.", "creation_time": "2011-11-04T04:14:49Z", "bug_id": 698360, "id": 5825676, "is_private": false, "count": 9, "tags": [], "author": "bzbarsky@mit.edu", "creator": "bzbarsky@mit.edu"}, {"bug_id": 698360, "id": 5825685, "tags": [], "is_private": false, "count": 10, "attachment_id": null, "time": "2011-11-04T04:18:23Z", "text": "a bit simplified:\n\nComponents.classes[\"@mozilla.org/appshell/window-mediator;1\"].getService(Components.interfaces.nsIWindowMediator).getMostRecentWindow('navigator:browser').gBrowser.addEventListener('DOMContentLoaded', function(e) {var url = e.target.location.href; if (url !== 'http://www.google.com/search?q=whatever') return; Components.utils.reportError(e.type); var win = e.target.defaultView; win.addEventListener('load', function(e) {Components.utils.reportError(e.type); var doc = e.target; doc.body.insertBefore(doc.createElement('IMG'), doc.body.firstChild).src = 'http://www.google.com/images/nav_logo91.png';}, false); win.addEventListener('pageshow', function(e) {Components.utils.reportError(e.type + (e.persisted ? ' : cached' : ' : uncached'));}, false); }, true);", "raw_text": "a bit simplified:\n\nComponents.classes[\"@mozilla.org/appshell/window-mediator;1\"].getService(Components.interfaces.nsIWindowMediator).getMostRecentWindow('navigator:browser').gBrowser.addEventListener('DOMContentLoaded', function(e) {var url = e.target.location.href; if (url !== 'http://www.google.com/search?q=whatever') return; Components.utils.reportError(e.type); var win = e.target.defaultView; win.addEventListener('load', function(e) {Components.utils.reportError(e.type); var doc = e.target; doc.body.insertBefore(doc.createElement('IMG'), doc.body.firstChild).src = 'http://www.google.com/images/nav_logo91.png';}, false); win.addEventListener('pageshow', function(e) {Components.utils.reportError(e.type + (e.persisted ? ' : cached' : ' : uncached'));}, false); }, true);", "creation_time": "2011-11-04T04:18:23Z", "author": "al_9x@yahoo.com", "creator": "al_9x@yahoo.com"}, {"bug_id": 698360, "id": 5825724, "tags": [], "count": 11, "is_private": false, "attachment_id": null, "time": "2011-11-04T04:55:20Z", "text": "(In reply to Boris Zbarsky (:bz) from comment #9)\n> I'm asking what happens if that script runs in the page itself, not from\n> chrome.\n\nNoScript has a pref to force surrogate script execution via dom based <script> element with text insertion, if it isn't that already.  So that is the page itself.\n\nHowever, if you want more evidence, I've used Fiddler (proxy) to add load and pageshow handlers to the google page.  Same results.\n\nDoes that answer your question?", "raw_text": "(In reply to Boris Zbarsky (:bz) from comment #9)\n> I'm asking what happens if that script runs in the page itself, not from\n> chrome.\n\nNoScript has a pref to force surrogate script execution via dom based <script> element with text insertion, if it isn't that already.  So that is the page itself.\n\nHowever, if you want more evidence, I've used Fiddler (proxy) to add load and pageshow handlers to the google page.  Same results.\n\nDoes that answer your question?", "creation_time": "2011-11-04T04:55:20Z", "author": "al_9x@yahoo.com", "creator": "al_9x@yahoo.com"}, {"text": "Yep, thanks.", "attachment_id": null, "time": "2011-11-04T05:00:42Z", "creation_time": "2011-11-04T05:00:42Z", "raw_text": "Yep, thanks.", "bug_id": 698360, "tags": [], "count": 12, "is_private": false, "id": 5825734, "creator": "bzbarsky@mit.edu", "author": "bzbarsky@mit.edu"}, {"count": 13, "is_private": false, "tags": [], "id": 5827936, "bug_id": 698360, "creation_time": "2011-11-05T00:25:12Z", "raw_text": "So this happens only within ***.google.com ?", "text": "So this happens only within ***.google.com ?", "creator": "torisugari@gmail.com", "time": "2011-11-05T00:25:12Z", "attachment_id": null, "author": "torisugari@gmail.com"}, {"author": "al_9x@yahoo.com", "creator": "al_9x@yahoo.com", "creation_time": "2011-11-05T01:00:50Z", "raw_text": "The key here is the page from which you go back (maps) and the timing of the back navigation, from the description:  \n\n\"When the maps page loads, the progress spinner stops, then briefly restarts again as something on the page updates.  To repro this, it's essential to go back immediately after the maps page appears, don't wait till the spinner restart.\"\n\nThe following local page also repros:\n__________________________\n<script>\naddEventListener('load', function(e) {\n\tconsole.log(e.type + ' : ' + e.target.location);\n\tdocument.body.insertBefore(document.createElement('IMG'), document.body.firstChild).src = 'http://www.google.com/images/nav_logo91.png'\n}, false);\naddEventListener('pageshow', function(e) console.log(e.type + (e.persisted ? ' : cached : ' : ' : uncached : ') + e.target.location), false);\n</script>\n\n<a href=\"http://maps.google.com/maps?q=Mozilla\">maps</a>\n______________________________________________________________\n\nI have not investigate what exactly the maps page is doing that helps reveal this bug, regardless, the initial page is bfcached, the timing of back should not matter.", "attachment_id": null, "time": "2011-11-05T01:00:50Z", "text": "The key here is the page from which you go back (maps) and the timing of the back navigation, from the description:  \n\n\"When the maps page loads, the progress spinner stops, then briefly restarts again as something on the page updates.  To repro this, it's essential to go back immediately after the maps page appears, don't wait till the spinner restart.\"\n\nThe following local page also repros:\n__________________________\n<script>\naddEventListener('load', function(e) {\n\tconsole.log(e.type + ' : ' + e.target.location);\n\tdocument.body.insertBefore(document.createElement('IMG'), document.body.firstChild).src = 'http://www.google.com/images/nav_logo91.png'\n}, false);\naddEventListener('pageshow', function(e) console.log(e.type + (e.persisted ? ' : cached : ' : ' : uncached : ') + e.target.location), false);\n</script>\n\n<a href=\"http://maps.google.com/maps?q=Mozilla\">maps</a>\n______________________________________________________________\n\nI have not investigate what exactly the maps page is doing that helps reveal this bug, regardless, the initial page is bfcached, the timing of back should not matter.", "id": 5827985, "is_private": false, "count": 14, "tags": [], "bug_id": 698360}, {"author": "al_9x@yahoo.com", "attachment_id": null, "time": "2011-11-12T07:18:14Z", "creator": "al_9x@yahoo.com", "text": "this has been confirmed, please NEW it", "creation_time": "2011-11-12T07:18:14Z", "raw_text": "this has been confirmed, please NEW it", "bug_id": 698360, "id": 5844430, "tags": [], "count": 15, "is_private": false}]}}, "comments": {}}