{"comments": {}, "bugs": {"1630681": {"comments": [{"raw_text": "As part of rendering the autocomplete popup in the Password Manager on username or password fields, the width of the popup is set based on the width of the corresponding input field in the page or a specified minimum width.\n\nCurrently, the desired width is obtained by [calling `getBoundingClientRect` on an ancestor node and then setting the `style.width` on the target node](https://searchfox.org/mozilla-central/rev/a707541ff423ade0d81cef6488e6ecfa09273886/toolkit/content/widgets/autocomplete-richlistitem.js#656-660). This forces [a synchronous layout flush taking on the order of 10ms](https://perfht.ml/3eokTAr) that can likely be avoided, since we already have at least the input field's width from the content process stored in an attribute on another ancestor node.\n\nThere may be some display issues to resolve with reading the attribute instead in certain situations like when the input field on the page is using a default width, but hopefully those can be addressed, as this would reduce the time it takes to display the autocomplete popup  (Bug 1619498) by a little more than 20% (at least on my machine).", "count": 0, "creation_time": "2020-04-16T16:43:54Z", "tags": [], "time": "2020-04-16T16:43:54Z", "creator": "bdanforth@mozilla.com", "author": "bdanforth@mozilla.com", "id": 14759495, "attachment_id": null, "text": "As part of rendering the autocomplete popup in the Password Manager on username or password fields, the width of the popup is set based on the width of the corresponding input field in the page or a specified minimum width.\n\nCurrently, the desired width is obtained by [calling `getBoundingClientRect` on an ancestor node and then setting the `style.width` on the target node](https://searchfox.org/mozilla-central/rev/a707541ff423ade0d81cef6488e6ecfa09273886/toolkit/content/widgets/autocomplete-richlistitem.js#656-660). This forces [a synchronous layout flush taking on the order of 10ms](https://perfht.ml/3eokTAr) that can likely be avoided, since we already have at least the input field's width from the content process stored in an attribute on another ancestor node.\n\nThere may be some display issues to resolve with reading the attribute instead in certain situations like when the input field on the page is using a default width, but hopefully those can be addressed, as this would reduce the time it takes to display the autocomplete popup  (Bug 1619498) by a little more than 20% (at least on my machine).", "is_private": false, "bug_id": 1630681}, {"is_private": false, "bug_id": 1630681, "text": "Created attachment 9141144\nBug 1630681 - Avoid a sync layout flush in the main thread of the parent process when rendering the Password Manager autocomplete popup r=MattN\n\n\nInstead of forcing a sync layout flush every time the autocomplete popup is opened, this forces a style flush only the first time (see [diff profile](https://perfht.ml/3es0Scf)). This results in a 31% performance improvement in the time it takes to show the autocomplete popup on my machine (Bug 1619498; average time across 5 measurements for the _first time_ the popup is shown went from 45 ms down to 31 ms).\n\nOther approaches that were considered to avoid any flushing:\n* `windowUtils.getBoundsWithoutFlushing`: Unfortunately, `getBoundingClientRect` couldn't be replaced with `windowUtils.getBoundsWithoutFlushing`, because the previously computed width of the popup is `0` when it is first shown, due to it starting out hidden (i.e. `display: none`).\n* `promiseDocumentFlushed`: This method is async while all of the surrounding autocomplete UI code is sync, so while it's not impossible, it would be difficult to implement a simple fix.", "author": "bdanforth@mozilla.com", "id": 14760679, "attachment_id": 9141144, "time": "2020-04-17T02:50:07Z", "creator": "bdanforth@mozilla.com", "tags": [], "count": 1, "creation_time": "2020-04-17T02:50:07Z", "raw_text": "\nInstead of forcing a sync layout flush every time the autocomplete popup is opened, this forces a style flush only the first time (see [diff profile](https://perfht.ml/3es0Scf)). This results in a 31% performance improvement in the time it takes to show the autocomplete popup on my machine (Bug 1619498; average time across 5 measurements for the _first time_ the popup is shown went from 45 ms down to 31 ms).\n\nOther approaches that were considered to avoid any flushing:\n* `windowUtils.getBoundsWithoutFlushing`: Unfortunately, `getBoundingClientRect` couldn't be replaced with `windowUtils.getBoundsWithoutFlushing`, because the previously computed width of the popup is `0` when it is first shown, due to it starting out hidden (i.e. `display: none`).\n* `promiseDocumentFlushed`: This method is async while all of the surrounding autocomplete UI code is sync, so while it's not impossible, it would be difficult to implement a simple fix."}, {"text": "Pushed by nerli@mozilla.com:\nhttps://hg.mozilla.org/integration/autoland/rev/cf04c0d8cc00\nAvoid a sync layout flush in the main thread of the parent process when rendering the Password Manager autocomplete popup r=MattN", "id": 14768018, "author": "pulsebot@bots.tld", "attachment_id": null, "is_private": false, "bug_id": 1630681, "count": 2, "creation_time": "2020-04-21T00:24:02Z", "raw_text": "Pushed by nerli@mozilla.com:\nhttps://hg.mozilla.org/integration/autoland/rev/cf04c0d8cc00\nAvoid a sync layout flush in the main thread of the parent process when rendering the Password Manager autocomplete popup r=MattN", "time": "2020-04-21T00:24:02Z", "creator": "pulsebot@bots.tld", "tags": []}, {"author": "cbrindusan@mozilla.com", "id": 14768599, "raw_text": "https://hg.mozilla.org/mozilla-central/rev/cf04c0d8cc00", "attachment_id": null, "text": "https://hg.mozilla.org/mozilla-central/rev/cf04c0d8cc00", "count": 3, "creation_time": "2020-04-21T09:45:04Z", "is_private": false, "bug_id": 1630681, "tags": ["bugherder"], "time": "2020-04-21T09:45:04Z", "creator": "cbrindusan@mozilla.com"}, {"creation_time": "2020-04-21T20:20:04Z", "count": 4, "raw_text": "### Beta/Release Uplift Approval Request\n* **User impact if declined**: If declined, the time it takes to show the autocomplete popup on login fields will be 20-30% slower for users.\n* **Is this code covered by automated tests?**: Yes\n* **Has the fix been verified in Nightly?**: No\n* **Needs manual test from QE?**: No\n* **If yes, steps to reproduce**: \n* **List of other uplifts needed**: None\n* **Risk to taking this patch**: Low\n* **Why is the change risky/not risky? (and alternatives if risky)**: This change modifies which web API is used to set the width of the autocomplete popup (instead of `element.getBoundingClientRect`, we use `window.getComputedStyle`), but the final width value is the same as before and is set in the same place in the code as before. In general, the autocomplete popup in the Password Manager has extensive test coverage, and all existing tests are passing.\n* **String changes made/needed**:", "time": "2020-04-21T20:20:04Z", "creator": "bdanforth@mozilla.com", "tags": [], "text": "Comment on attachment 9141144\nBug 1630681 - Avoid a sync layout flush in the main thread of the parent process when rendering the Password Manager autocomplete popup r=MattN\n\n### Beta/Release Uplift Approval Request\n* **User impact if declined**: If declined, the time it takes to show the autocomplete popup on login fields will be 20-30% slower for users.\n* **Is this code covered by automated tests?**: Yes\n* **Has the fix been verified in Nightly?**: No\n* **Needs manual test from QE?**: No\n* **If yes, steps to reproduce**: \n* **List of other uplifts needed**: None\n* **Risk to taking this patch**: Low\n* **Why is the change risky/not risky? (and alternatives if risky)**: This change modifies which web API is used to set the width of the autocomplete popup (instead of `element.getBoundingClientRect`, we use `window.getComputedStyle`), but the final width value is the same as before and is set in the same place in the code as before. In general, the autocomplete popup in the Password Manager has extensive test coverage, and all existing tests are passing.\n* **String changes made/needed**:", "attachment_id": 9141144, "author": "bdanforth@mozilla.com", "id": 14770153, "bug_id": 1630681, "is_private": false}, {"author": "ryanvm@gmail.com", "id": 14770469, "attachment_id": 9141144, "raw_text": "Approved for 76.0b7.", "text": "Comment on attachment 9141144\nBug 1630681 - Avoid a sync layout flush in the main thread of the parent process when rendering the Password Manager autocomplete popup r=MattN\n\nApproved for 76.0b7.", "count": 5, "creation_time": "2020-04-21T22:45:34Z", "is_private": false, "bug_id": 1630681, "tags": [], "time": "2020-04-21T22:45:34Z", "creator": "ryanvm@gmail.com"}, {"creation_time": "2020-04-21T22:47:26Z", "count": 6, "raw_text": "https://hg.mozilla.org/releases/mozilla-beta/rev/fec0c5441dff", "time": "2020-04-21T22:47:26Z", "creator": "ryanvm@gmail.com", "tags": ["bugherder", "uplift"], "text": "https://hg.mozilla.org/releases/mozilla-beta/rev/fec0c5441dff", "attachment_id": null, "author": "ryanvm@gmail.com", "id": 14770475, "is_private": false, "bug_id": 1630681}]}}}