{"bugs": {"688193": {"comments": [{"creation_time": "2011-09-21T16:39:11Z", "raw_text": "We are currently in the process of hunting down the last few remaining fsync that appear at startup. According to bug 611837, on the Macintosh, there are only two such occurrences of fsync, and one of them is DisableFontActivation.\n\nDiscussing with jfkthame, it seems that this operation could be moved away from the critical path.\n\nPretty please?", "text": "We are currently in the process of hunting down the last few remaining fsync that appear at startup. According to bug 611837, on the Macintosh, there are only two such occurrences of fsync, and one of them is DisableFontActivation.\n\nDiscussing with jfkthame, it seems that this operation could be moved away from the critical path.\n\nPretty please?", "time": "2011-09-21T16:39:11Z", "attachment_id": null, "tags": [], "count": 0, "is_private": false, "id": 5728480, "bug_id": 688193, "creator": "D.O.Teller+bugspam@gmail.com", "author": "D.O.Teller+bugspam@gmail.com"}, {"creation_time": "2011-09-21T17:20:20Z", "raw_text": "AFAICS from bug 567552, the use of DisableFontActivation relates only to the use of @font-face with src:local(...), as that's the only situation where we query the OS for a font name (as opposed to looking up fonts using our own font list).\n\nThus, we don't actually need to tweak the setting during platform startup; we can defer it until the first time gfxMacPlatformFontList::LookupLocalFont() gets called.", "creator": "jfkthame@gmail.com", "text": "Created attachment 561509\npatch, remove DisableFontActivation from startup path and do it on-demand instead\n\nAFAICS from bug 567552, the use of DisableFontActivation relates only to the use of @font-face with src:local(...), as that's the only situation where we query the OS for a font name (as opposed to looking up fonts using our own font list).\n\nThus, we don't actually need to tweak the setting during platform startup; we can defer it until the first time gfxMacPlatformFontList::LookupLocalFont() gets called.", "attachment_id": 561509, "time": "2011-09-21T17:20:20Z", "author": "jfkthame@gmail.com", "count": 1, "is_private": false, "tags": [], "id": 5728594, "bug_id": 688193}, {"is_private": false, "count": 2, "tags": [], "id": 5729825, "bug_id": 688193, "creation_time": "2011-09-22T00:53:33Z", "raw_text": "> AFAICS from bug 567552, the use of DisableFontActivation relates only to the\n> use of @font-face with src:local(...), as that's the only situation where we\n> query the OS for a font name (as opposed to looking up fonts using our own\n> font list).\n\nNot sure what made you think that but that's *not* the case.  The bug\noccurs on startup on 10.6 machines with external hard drives that\ncontain folders with fonts when the font list is built.  My guess is\nthat the underlying bug is some form of Spotlight bug.  So delaying\nthis will bring back the original *very* problematic behavior of bug\n567552.\n\nAnother approach would be to switch to using the CTFontManager\nenumeration calls instead of NSFontManager.  My guess is that the\nCoreText API's don't have this problem, otherwise the same problem\nwould occur with Safari.  This API is 10.6 and beyond, so we'd need to\nkeep the old code for 10.5 support.", "text": "Comment on attachment 561509\npatch, remove DisableFontActivation from startup path and do it on-demand instead\n\n> AFAICS from bug 567552, the use of DisableFontActivation relates only to the\n> use of @font-face with src:local(...), as that's the only situation where we\n> query the OS for a font name (as opposed to looking up fonts using our own\n> font list).\n\nNot sure what made you think that but that's *not* the case.  The bug\noccurs on startup on 10.6 machines with external hard drives that\ncontain folders with fonts when the font list is built.  My guess is\nthat the underlying bug is some form of Spotlight bug.  So delaying\nthis will bring back the original *very* problematic behavior of bug\n567552.\n\nAnother approach would be to switch to using the CTFontManager\nenumeration calls instead of NSFontManager.  My guess is that the\nCoreText API's don't have this problem, otherwise the same problem\nwould occur with Safari.  This API is 10.6 and beyond, so we'd need to\nkeep the old code for 10.5 support.", "time": "2011-09-22T00:53:33Z", "attachment_id": 561509, "creator": "jd.bugzilla@gmail.com", "author": "jd.bugzilla@gmail.com"}, {"time": "2011-09-22T19:51:46Z", "attachment_id": null, "text": "Are you sure it's known to occur when the font list is built? I'd find that very surprising, given that we get the font list from Cocoa's NSFontManager, which is the preferred, Apple-sanctioned way to manage fonts. If this can be triggered by calling\n    sFontManager = [NSFontManager sharedFontManager];\nto get the font manager, and then\n    NSEnumerator *families =\n        [[sFontManager availableFontFamilies] objectEnumerator];\nto get an enumerator and iterate over the list, which is what we do, then MANY Cocoa applications should be exhibiting the same issue, as this is The Cocoa Way to find the available fonts. Surely this cannot cause the OS to suddenly look for specific named, non-installed fonts.\n\nI suspect that when people have seen this \"at startup\", it's because they have tabs in their saved session that happen to include @font-face { src:local(...) } rules. AFAICS, this is the only scenario where we call font-querying APIs (either ATS or CG-based, depending on OS version) that could trigger the OS to wish to \"activate\" a currently-uninstalled font by name.", "raw_text": "Are you sure it's known to occur when the font list is built? I'd find that very surprising, given that we get the font list from Cocoa's NSFontManager, which is the preferred, Apple-sanctioned way to manage fonts. If this can be triggered by calling\n    sFontManager = [NSFontManager sharedFontManager];\nto get the font manager, and then\n    NSEnumerator *families =\n        [[sFontManager availableFontFamilies] objectEnumerator];\nto get an enumerator and iterate over the list, which is what we do, then MANY Cocoa applications should be exhibiting the same issue, as this is The Cocoa Way to find the available fonts. Surely this cannot cause the OS to suddenly look for specific named, non-installed fonts.\n\nI suspect that when people have seen this \"at startup\", it's because they have tabs in their saved session that happen to include @font-face { src:local(...) } rules. AFAICS, this is the only scenario where we call font-querying APIs (either ATS or CG-based, depending on OS version) that could trigger the OS to wish to \"activate\" a currently-uninstalled font by name.", "creation_time": "2011-09-22T19:51:46Z", "bug_id": 688193, "id": 5731753, "tags": [], "is_private": false, "count": 3, "author": "jfkthame@gmail.com", "creator": "jfkthame@gmail.com"}, {"creator": "D.O.Teller+bugspam@gmail.com", "author": "D.O.Teller+bugspam@gmail.com", "raw_text": "This is what I get with about:blank as a startup page. This is on a nightly a few days old.", "creation_time": "2011-09-23T08:36:21Z", "text": "Created attachment 561993\nStack leading to DisableFontActivation\n\nThis is what I get with about:blank as a startup page. This is on a nightly a few days old.", "time": "2011-09-23T08:36:21Z", "attachment_id": 561993, "is_private": false, "count": 4, "tags": [], "id": 5733153, "bug_id": 688193}, {"text": "(In reply to David Rajchenbach Teller [:Yoric] from comment #4)\n> Created attachment 561993 [details]\n> Stack leading to DisableFontActivation\n> \n> This is what I get with about:blank as a startup page. This is on a nightly\n> a few days old.\n\nYes - we currently call DisableFontActivation to change the OS setting during startup, because of bug 567552. What I meant in comment 3 is that I don't see how bug 567552 could really be happening at startup, but must be triggered by @font-face in a page that's being loaded (which could be part of session restore, so the user would see it as \"at startup\") - and therefore, we could defer DisableFontActivation until we encounter such a rule, moving it out of the actual startup path.", "attachment_id": null, "time": "2011-09-23T09:13:29Z", "raw_text": "(In reply to David Rajchenbach Teller [:Yoric] from comment #4)\n> Created attachment 561993 [details]\n> Stack leading to DisableFontActivation\n> \n> This is what I get with about:blank as a startup page. This is on a nightly\n> a few days old.\n\nYes - we currently call DisableFontActivation to change the OS setting during startup, because of bug 567552. What I meant in comment 3 is that I don't see how bug 567552 could really be happening at startup, but must be triggered by @font-face in a page that's being loaded (which could be part of session restore, so the user would see it as \"at startup\") - and therefore, we could defer DisableFontActivation until we encounter such a rule, moving it out of the actual startup path.", "creation_time": "2011-09-23T09:13:29Z", "bug_id": 688193, "tags": [], "is_private": false, "count": 5, "id": 5733176, "creator": "jfkthame@gmail.com", "author": "jfkthame@gmail.com"}]}}, "comments": {}}