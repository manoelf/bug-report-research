{"bugs": {"697167": {"comments": [{"is_private": false, "creation_time": "2011-10-25T17:30:07Z", "creator": "intendentedelleacque@libero.it", "tags": [], "attachment_id": null, "bug_id": 697167, "id": 5803625, "author": "intendentedelleacque@libero.it", "count": 0, "text": "User Agent: Mozilla/5.0 (X11; U; Linux i686; it; rv:1.9.2.23) Gecko/20110920 Firefox/3.6.23\nBuild ID: 20110920075126\n\nSteps to reproduce:\n\nWhile developing an extension, I've found out a bug ofnsIMsgFolder.copyFileMessage, present just on Windows.\nThis is my initial code\n\n---- BEGIN -----\n\nvar tempFile = Components.classes[\"@mozilla.org/file/directory_service;1\"].  \n\tgetService(Components.interfaces.nsIProperties).  \n\tget(\"TmpD\", Components.interfaces.nsIFile);  \ntempFile.append(\"HT.eml\");\ntempFile.createUnique(0,0664);\nvar foStream = Components.classes[\"@mozilla.org/network/file-output-stream;1\"]\n\t.createInstance(Components.interfaces.nsIFileOutputStream);\nfoStream.init(tempFile, 2, 0x200, false); // open as \"write only\"\nfoStream.write(data,data.length); // \"data\" cointains a message source\nfoStream.close();\nmsgFolder.copyFileMessage(tempFile, null, false, flags, keys, null, copyListener);\t\t\n\n----- END -----\n\nThis code works properly on Linux, but on Windows copyFileMessage fails, copying just a blank line in folder file and showing a empty fake message in messages panel.\nAfter many efforts, I've found out this workaround\n\n---- BEGIN -----\n\nvar tempFile = Components.classes[\"@mozilla.org/file/directory_service;1\"].  \n\tgetService(Components.interfaces.nsIProperties).  \n\tget(\"TmpD\", Components.interfaces.nsIFile);  \ntempFile.append(\"HT.eml\");\ntempFile.createUnique(0,0664);\nvar foStream = Components.classes[\"@mozilla.org/network/file-output-stream;1\"]\n\t.createInstance(Components.interfaces.nsIFileOutputStream);\nfoStream.init(tempFile, 2, 0x200, false); // open as \"write only\"\nfoStream.write(data,data.length); // \"data\" cointains a message source\nfoStream.close();\nvar fileSpec = Components.classes[\"@mozilla.org/file/local;1\"]\n\t.createInstance(Components.interfaces.nsILocalFile);\nfileSpec.initWithPath(tempFile.path);\nmsgFolder.copyFileMessage(fileSpec, null, false, flags, keys, null, copyListener);\t\t\n\n----- END -----\n\nIt seems that copyFileMessage needs a different object to work on Windows, even if the new object fileSpec points to the same file of tempFile.\nI wonder if this depends from the fact that Windows locks the file created by applications (Linux don't), but I can't understand why this should make fail copyFileMessage.\n\nAnyway this is not a problem in writing extensions, because a workaround exists.\nBut I want to report this bug, because it could perhaps be the reason of some folder corruption cases.\n\nTested on Thunderbird 3.1 and 7.0.1", "raw_text": "User Agent: Mozilla/5.0 (X11; U; Linux i686; it; rv:1.9.2.23) Gecko/20110920 Firefox/3.6.23\nBuild ID: 20110920075126\n\nSteps to reproduce:\n\nWhile developing an extension, I've found out a bug ofnsIMsgFolder.copyFileMessage, present just on Windows.\nThis is my initial code\n\n---- BEGIN -----\n\nvar tempFile = Components.classes[\"@mozilla.org/file/directory_service;1\"].  \n\tgetService(Components.interfaces.nsIProperties).  \n\tget(\"TmpD\", Components.interfaces.nsIFile);  \ntempFile.append(\"HT.eml\");\ntempFile.createUnique(0,0664);\nvar foStream = Components.classes[\"@mozilla.org/network/file-output-stream;1\"]\n\t.createInstance(Components.interfaces.nsIFileOutputStream);\nfoStream.init(tempFile, 2, 0x200, false); // open as \"write only\"\nfoStream.write(data,data.length); // \"data\" cointains a message source\nfoStream.close();\nmsgFolder.copyFileMessage(tempFile, null, false, flags, keys, null, copyListener);\t\t\n\n----- END -----\n\nThis code works properly on Linux, but on Windows copyFileMessage fails, copying just a blank line in folder file and showing a empty fake message in messages panel.\nAfter many efforts, I've found out this workaround\n\n---- BEGIN -----\n\nvar tempFile = Components.classes[\"@mozilla.org/file/directory_service;1\"].  \n\tgetService(Components.interfaces.nsIProperties).  \n\tget(\"TmpD\", Components.interfaces.nsIFile);  \ntempFile.append(\"HT.eml\");\ntempFile.createUnique(0,0664);\nvar foStream = Components.classes[\"@mozilla.org/network/file-output-stream;1\"]\n\t.createInstance(Components.interfaces.nsIFileOutputStream);\nfoStream.init(tempFile, 2, 0x200, false); // open as \"write only\"\nfoStream.write(data,data.length); // \"data\" cointains a message source\nfoStream.close();\nvar fileSpec = Components.classes[\"@mozilla.org/file/local;1\"]\n\t.createInstance(Components.interfaces.nsILocalFile);\nfileSpec.initWithPath(tempFile.path);\nmsgFolder.copyFileMessage(fileSpec, null, false, flags, keys, null, copyListener);\t\t\n\n----- END -----\n\nIt seems that copyFileMessage needs a different object to work on Windows, even if the new object fileSpec points to the same file of tempFile.\nI wonder if this depends from the fact that Windows locks the file created by applications (Linux don't), but I can't understand why this should make fail copyFileMessage.\n\nAnyway this is not a problem in writing extensions, because a workaround exists.\nBut I want to report this bug, because it could perhaps be the reason of some folder corruption cases.\n\nTested on Thunderbird 3.1 and 7.0.1", "time": "2011-10-25T17:30:07Z"}, {"time": "2011-11-02T13:40:25Z", "raw_text": "Can you propose this in the form of a proper patch ?", "text": "Can you propose this in the form of a proper patch ?", "count": 1, "author": "ludovic@hirlimann.net", "bug_id": 697167, "id": 5820525, "attachment_id": null, "tags": [], "creator": "ludovic@hirlimann.net", "creation_time": "2011-11-02T13:40:25Z", "is_private": false}, {"tags": [], "time": "2011-11-02T15:41:39Z", "raw_text": "I think that workaround is made in the extension. It is not the solution to be applied to TB core code.\n\nReporter, is this needed for the ImportExportTools extension?", "attachment_id": null, "bug_id": 697167, "id": 5820816, "creation_time": "2011-11-02T15:41:39Z", "is_private": false, "creator": "acelists@atlas.sk", "text": "I think that workaround is made in the extension. It is not the solution to be applied to TB core code.\n\nReporter, is this needed for the ImportExportTools extension?", "count": 2, "author": "acelists@atlas.sk"}, {"count": 3, "text": "Yes, this is just a workaround that I used for a new extension (HeaderToolsLite) and that I think it's been used also in \"TB_Header_Tools\" by Frank DiLecce.\n\nI noticed the same behaviour also with nsIMsgCopyService.CopyFileMessage.\n\nI repeat: this is not a problem for developing extensions (when you know it!!!), but in my opinion here there is probably a bug in core code.\n\nI don't know if this bug is harmless or can cause dataloss in some circumstances, I don't know deeply enough the Thunderbird code to give an opinion about this.", "author": "intendentedelleacque@libero.it", "id": 5821111, "bug_id": 697167, "raw_text": "Yes, this is just a workaround that I used for a new extension (HeaderToolsLite) and that I think it's been used also in \"TB_Header_Tools\" by Frank DiLecce.\n\nI noticed the same behaviour also with nsIMsgCopyService.CopyFileMessage.\n\nI repeat: this is not a problem for developing extensions (when you know it!!!), but in my opinion here there is probably a bug in core code.\n\nI don't know if this bug is harmless or can cause dataloss in some circumstances, I don't know deeply enough the Thunderbird code to give an opinion about this.", "time": "2011-11-02T16:58:20Z", "creator": "intendentedelleacque@libero.it", "is_private": false, "creation_time": "2011-11-02T16:58:20Z", "attachment_id": null, "tags": []}, {"id": 7273321, "bug_id": 697167, "creation_time": "2013-04-03T19:13:19Z", "is_private": false, "creator": "vseerror@lehigh.edu", "count": 4, "text": "do we have a notation, whiteboard or otherwise, for features needed by addons?\n\nis there a more appropriate component for this bug?", "author": "vseerror@lehigh.edu", "tags": [], "time": "2013-04-03T19:13:19Z", "raw_text": "do we have a notation, whiteboard or otherwise, for features needed by addons?\n\nis there a more appropriate component for this bug?", "attachment_id": null}, {"bug_id": 697167, "id": 7273507, "count": 5, "text": "I'm sure we should find the cause for this for Core reasons too.\nBut I do not remember any such notation.", "author": "acelists@atlas.sk", "time": "2013-04-03T19:50:45Z", "raw_text": "I'm sure we should find the cause for this for Core reasons too.\nBut I do not remember any such notation.", "is_private": false, "creation_time": "2013-04-03T19:50:45Z", "creator": "acelists@atlas.sk", "tags": [], "attachment_id": null}, {"tags": [], "raw_text": "comment 0 suggests this may corrupt folders or otherwise cause dataloss.\nDo you agree?", "attachment_id": null, "time": "2015-05-21T19:49:43Z", "creation_time": "2015-05-21T19:49:43Z", "is_private": false, "bug_id": 697167, "id": 10297405, "count": 6, "text": "comment 0 suggests this may corrupt folders or otherwise cause dataloss.\nDo you agree?", "author": "vseerror@lehigh.edu", "creator": "vseerror@lehigh.edu"}, {"time": "2015-05-21T21:15:11Z", "raw_text": "It is common practice to clone nsIFile objects in Windows due to Windows caching issues. Yes these can be tricky to catch, and I don't know all the cases that require it.", "attachment_id": null, "tags": [], "creator": "rkent@caspia.com", "count": 7, "text": "It is common practice to clone nsIFile objects in Windows due to Windows caching issues. Yes these can be tricky to catch, and I don't know all the cases that require it.", "author": "rkent@caspia.com", "id": 10297877, "bug_id": 697167, "creation_time": "2015-05-21T21:15:11Z", "is_private": false}]}}, "comments": {}}