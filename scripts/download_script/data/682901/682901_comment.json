{"comments": {}, "bugs": {"682901": {"comments": [{"creator": "malini@malinidas.com", "author": "malini@malinidas.com", "bug_id": 682901, "is_private": false, "count": 0, "tags": [], "id": 5685446, "text": "Enforce that waitForExplicitFinish() gets called before an explicit SimpleTest.finish() call, otherwise we will lose test data. We've seen this before in instances where waitForExplicitFinish gets called in some callback, but .finish() gets called shortly after loading the page.", "attachment_id": null, "time": "2011-08-29T18:02:44Z", "creation_time": "2011-08-29T18:02:44Z", "raw_text": "Enforce that waitForExplicitFinish() gets called before an explicit SimpleTest.finish() call, otherwise we will lose test data. We've seen this before in instances where waitForExplicitFinish gets called in some callback, but .finish() gets called shortly after loading the page."}, {"creator": "josh@joshmatthews.net", "author": "josh@joshmatthews.net", "tags": [], "count": 1, "is_private": false, "id": 8022498, "bug_id": 682901, "raw_text": "Relevant code: http://mxr.mozilla.org/mozilla-central/source/testing/mochitest/tests/SimpleTest/SimpleTest.js\nRelevant methods: finish and waitForExplicitFinish", "creation_time": "2013-10-30T19:35:40Z", "text": "Relevant code: http://mxr.mozilla.org/mozilla-central/source/testing/mochitest/tests/SimpleTest/SimpleTest.js\nRelevant methods: finish and waitForExplicitFinish", "time": "2013-10-30T19:35:40Z", "attachment_id": null}, {"author": "jaspreetsingh112@gmail.com", "creator": "jaspreetsingh112@gmail.com", "id": 8502843, "is_private": false, "count": 2, "tags": [], "bug_id": 682901, "raw_text": "Tests performed locally-\nRan local test(having both methods) with no change......passed\nRan local test(having both methods with mistake of finish() called before waitForExplicitFinish()...............failed\nRan local test(having none of the two methods - ./mach mochitest-plain content/base/test/test_bug420700.html) with no change........passed\nRan local test(having none of the two methods - content/base/test/test_bug420700.html) with the above mistake  .....1 pass 1 fail\nRan local test(having none of the two methods - content/base/test/test_bug420700.html) with the mistake of having only finish().....1 pass 2 fails\n\nFails in the last case are-\n\n[SimpleTest.finish()] waitForExplicitFinish() has not been invoked\n[SimpleTest.finish()] this test already called finish!", "creation_time": "2014-03-06T23:32:24Z", "time": "2014-03-06T23:32:24Z", "attachment_id": 8387166, "text": "Created attachment 8387166\n2.patch\n\nTests performed locally-\nRan local test(having both methods) with no change......passed\nRan local test(having both methods with mistake of finish() called before waitForExplicitFinish()...............failed\nRan local test(having none of the two methods - ./mach mochitest-plain content/base/test/test_bug420700.html) with no change........passed\nRan local test(having none of the two methods - content/base/test/test_bug420700.html) with the above mistake  .....1 pass 1 fail\nRan local test(having none of the two methods - content/base/test/test_bug420700.html) with the mistake of having only finish().....1 pass 2 fails\n\nFails in the last case are-\n\n[SimpleTest.finish()] waitForExplicitFinish() has not been invoked\n[SimpleTest.finish()] this test already called finish!"}, {"author": "josh@joshmatthews.net", "time": "2014-03-10T15:24:11Z", "attachment_id": 8387166, "text": "Comment on attachment 8387166\n2.patch\n\nReview of attachment 8387166:\n-----------------------------------------------------------------\n\nGood work! Please replace the [PATCH] in the commit message with \"Bug 682901 - \", and get rid of the blank line before the commit message as well. Make sure to run the tests you've been using after making the changes I've requested!\n\n::: testing/mochitest/tests/SimpleTest/SimpleTest.js\n@@ +766,4 @@\n>      SimpleTest._cleanupFunctions.push(aFunc);\n>  };\n>  \n> +SimpleTest._automatic = false;   // set when finish() is called automatically and not when called explicitly\n\nI believe we don't actually need a separate variable for this. _stopOnLoad seems to give us what we need already.\n\n@@ +773,5 @@\n>  **/\n>  SimpleTest.finish = function () {\n> +    /* don't allow tests to call explicit finish before |SimpletestwaitForExplicitFinish()|\n> +       or leave explicit call after |SimpleTest.waitForEFinish()|\n> +    */\n\nI don't really understand this comment right now; I think it might be better phrased as \"disallow calling finish before waitForExplicitFinish\".\n\n@@ +774,5 @@\n>  SimpleTest.finish = function () {\n> +    /* don't allow tests to call explicit finish before |SimpletestwaitForExplicitFinish()|\n> +       or leave explicit call after |SimpleTest.waitForEFinish()|\n> +    */\n> +    if((SimpleTest._stopOnLoad && !SimpleTest._automatic) || (SimpleTest._automatic && !SimpleTest._stopOnLoad))    \n\nI think we can just check for _stopOnLoad, since calling waitForExplicitFinish makes it false.", "creator": "josh@joshmatthews.net", "creation_time": "2014-03-10T15:24:11Z", "raw_text": "Review of attachment 8387166:\n-----------------------------------------------------------------\n\nGood work! Please replace the [PATCH] in the commit message with \"Bug 682901 - \", and get rid of the blank line before the commit message as well. Make sure to run the tests you've been using after making the changes I've requested!\n\n::: testing/mochitest/tests/SimpleTest/SimpleTest.js\n@@ +766,4 @@\n>      SimpleTest._cleanupFunctions.push(aFunc);\n>  };\n>  \n> +SimpleTest._automatic = false;   // set when finish() is called automatically and not when called explicitly\n\nI believe we don't actually need a separate variable for this. _stopOnLoad seems to give us what we need already.\n\n@@ +773,5 @@\n>  **/\n>  SimpleTest.finish = function () {\n> +    /* don't allow tests to call explicit finish before |SimpletestwaitForExplicitFinish()|\n> +       or leave explicit call after |SimpleTest.waitForEFinish()|\n> +    */\n\nI don't really understand this comment right now; I think it might be better phrased as \"disallow calling finish before waitForExplicitFinish\".\n\n@@ +774,5 @@\n>  SimpleTest.finish = function () {\n> +    /* don't allow tests to call explicit finish before |SimpletestwaitForExplicitFinish()|\n> +       or leave explicit call after |SimpleTest.waitForEFinish()|\n> +    */\n> +    if((SimpleTest._stopOnLoad && !SimpleTest._automatic) || (SimpleTest._automatic && !SimpleTest._stopOnLoad))    \n\nI think we can just check for _stopOnLoad, since calling waitForExplicitFinish makes it false.", "bug_id": 682901, "id": 8513055, "tags": [], "is_private": false, "count": 3}, {"bug_id": 682901, "id": 8517022, "is_private": false, "count": 4, "tags": [], "attachment_id": 8389025, "time": "2014-03-11T07:26:50Z", "author": "jaspreetsingh112@gmail.com", "text": "Created attachment 8389025\nsecond.patch\n\nI ran all the tests mentioned in comment 2. They gave same results.\nHope this one is fine.", "creator": "jaspreetsingh112@gmail.com", "creation_time": "2014-03-11T07:26:50Z", "raw_text": "I ran all the tests mentioned in comment 2. They gave same results.\nHope this one is fine."}, {"creator": "josh@joshmatthews.net", "author": "josh@joshmatthews.net", "bug_id": 682901, "count": 5, "is_private": false, "tags": [], "id": 8517924, "text": "Comment on attachment 8389025\nsecond.patch\n\nGood stuff!", "time": "2014-03-11T13:02:56Z", "attachment_id": 8389025, "creation_time": "2014-03-11T13:02:56Z", "raw_text": "Good stuff!"}, {"creator": "josh@joshmatthews.net", "author": "josh@joshmatthews.net", "tags": [], "is_private": false, "count": 6, "id": 8517930, "bug_id": 682901, "raw_text": "This deserves a try run before landing; I'll push it for now, and I recommend you apply for an account as well: http://www.mozilla.org/hacking/committer/", "creation_time": "2014-03-11T13:04:02Z", "text": "This deserves a try run before landing; I'll push it for now, and I recommend you apply for an account as well: http://www.mozilla.org/hacking/committer/", "time": "2014-03-11T13:04:02Z", "attachment_id": null}, {"time": "2014-03-12T15:50:59Z", "attachment_id": null, "text": "pushed to try\nhttps://tbpl.mozilla.org/?tree=Try&rev=d5ec55eb40c9", "raw_text": "pushed to try\nhttps://tbpl.mozilla.org/?tree=Try&rev=d5ec55eb40c9", "creation_time": "2014-03-12T15:50:59Z", "bug_id": 682901, "id": 8524098, "count": 7, "is_private": false, "tags": [], "author": "jaspreetsingh112@gmail.com", "creator": "jaspreetsingh112@gmail.com"}, {"text": "mochitest other resolved\nhttps://tbpl.mozilla.org/?tree=Try&rev=70819331050a", "attachment_id": null, "time": "2014-03-27T14:32:07Z", "creation_time": "2014-03-27T14:32:07Z", "raw_text": "mochitest other resolved\nhttps://tbpl.mozilla.org/?tree=Try&rev=70819331050a", "bug_id": 682901, "tags": [], "is_private": false, "count": 8, "id": 8586763, "creator": "jaspreetsingh112@gmail.com", "author": "jaspreetsingh112@gmail.com"}, {"creator": "josh@joshmatthews.net", "author": "josh@joshmatthews.net", "tags": [], "count": 9, "is_private": false, "id": 8960051, "bug_id": 682901, "creation_time": "2014-06-20T22:29:17Z", "raw_text": "Jaspreet, do you remember what the status was here? If the patch worked and tests pass, we should really merge it :)", "text": "Jaspreet, do you remember what the status was here? If the patch worked and tests pass, we should really merge it :)", "attachment_id": null, "time": "2014-06-20T22:29:17Z"}, {"bug_id": 682901, "tags": [], "count": 10, "is_private": false, "id": 9231243, "creator": "abhirav.kariya@students.iiit.ac.in", "text": "hi! I'm new here , Please assign this bug to me!", "author": "abhirav.kariya@students.iiit.ac.in", "attachment_id": null, "time": "2014-08-26T17:29:27Z", "creation_time": "2014-08-26T17:29:27Z", "raw_text": "hi! I'm new here , Please assign this bug to me!"}, {"text": "Please help me get started as this is my first time!Thank you for assigning this bug to me.", "time": "2014-08-26T17:37:28Z", "attachment_id": null, "raw_text": "Please help me get started as this is my first time!Thank you for assigning this bug to me.", "creation_time": "2014-08-26T17:37:28Z", "bug_id": 682901, "tags": [], "is_private": false, "count": 11, "id": 9231298, "creator": "abhirav.kariya@students.iiit.ac.in", "author": "abhirav.kariya@students.iiit.ac.in"}, {"time": "2014-08-26T17:47:00Z", "attachment_id": null, "text": "Well, it seems like the second.patch is alrady enough to fix this bug.\nI don't know what the result of the try server was, but probably wise to pull it through try server once again.\nAbhirav, you could write a mochitest that would trigger this case. It would have to be skipped for now, because bug 1048446 is not fixed, but it would still be good to have a mochitest.", "raw_text": "Well, it seems like the second.patch is alrady enough to fix this bug.\nI don't know what the result of the try server was, but probably wise to pull it through try server once again.\nAbhirav, you could write a mochitest that would trigger this case. It would have to be skipped for now, because bug 1048446 is not fixed, but it would still be good to have a mochitest.", "creation_time": "2014-08-26T17:47:00Z", "bug_id": 682901, "id": 9231365, "is_private": false, "count": 12, "tags": [], "author": "martijn.martijn@gmail.com", "creator": "martijn.martijn@gmail.com"}, {"is_private": false, "count": 13, "tags": [], "id": 9605337, "bug_id": 682901, "raw_text": "jdm, can we get this patch landed and merged?", "creation_time": "2014-11-18T15:44:37Z", "text": "jdm, can we get this patch landed and merged?", "time": "2014-11-18T15:44:37Z", "attachment_id": null, "creator": "jmaher@mozilla.com", "author": "jmaher@mozilla.com"}, {"author": "jmaher@mozilla.com", "creator": "jmaher@mozilla.com", "time": "2015-01-27T17:35:26Z", "attachment_id": null, "text": "it seems we lost this a bit, I believe this is probably outdated functionality.  Do we need test cases?  Can we validate if this is still useful?", "creation_time": "2015-01-27T17:35:26Z", "raw_text": "it seems we lost this a bit, I believe this is probably outdated functionality.  Do we need test cases?  Can we validate if this is still useful?", "bug_id": 682901, "id": 9848381, "tags": [], "count": 14, "is_private": false}, {"time": "2015-01-27T17:55:32Z", "attachment_id": null, "text": "Outdated in what way? I would be surprised if anything has changed from Malini's original description.", "creation_time": "2015-01-27T17:55:32Z", "raw_text": "Outdated in what way? I would be surprised if anything has changed from Malini's original description.", "bug_id": 682901, "id": 9848506, "is_private": false, "count": 15, "tags": [], "author": "josh@joshmatthews.net", "creator": "josh@joshmatthews.net"}, {"creator": "jmaher@mozilla.com", "author": "jmaher@mozilla.com", "creation_time": "2015-01-27T18:29:54Z", "raw_text": "the simpletest code has changed a lot, we have different code paths for handling multiple finish() calls which didn't exist back in 2011.  \n\nWe have a patch on here, with r+, but it never landed, so if there is anything we can do to either land it, or document what else is required it would be helpful.", "text": "the simpletest code has changed a lot, we have different code paths for handling multiple finish() calls which didn't exist back in 2011.  \n\nWe have a patch on here, with r+, but it never landed, so if there is anything we can do to either land it, or document what else is required it would be helpful.", "time": "2015-01-27T18:29:54Z", "attachment_id": null, "tags": [], "is_private": false, "count": 16, "id": 9848714, "bug_id": 682901}, {"raw_text": "https://treeherder.mozilla.org/#/jobs?repo=try&revision=bde104c2f64e", "creation_time": "2015-01-27T23:22:48Z", "time": "2015-01-27T23:22:48Z", "attachment_id": null, "text": "https://treeherder.mozilla.org/#/jobs?repo=try&revision=bde104c2f64e", "id": 9850273, "count": 17, "is_private": false, "tags": [], "bug_id": 682901, "author": "josh@joshmatthews.net", "creator": "josh@joshmatthews.net"}, {"author": "josh@joshmatthews.net", "creator": "josh@joshmatthews.net", "bug_id": 682901, "id": 11350353, "tags": [], "count": 18, "is_private": false, "time": "2016-04-23T13:27:07Z", "attachment_id": null, "text": "https://treeherder.mozilla.org/#/jobs?repo=try&revision=74d00cbeb2ee", "raw_text": "https://treeherder.mozilla.org/#/jobs?repo=try&revision=74d00cbeb2ee", "creation_time": "2016-04-23T13:27:07Z"}, {"tags": [], "count": 19, "is_private": false, "id": 11350496, "bug_id": 682901, "creation_time": "2016-04-23T17:02:45Z", "raw_text": "This patch requires an automated test demonstrating that it works as expected. Maybe a new test added to testing/mochitest/Harness_sanity/ that calls SimpleTest.expectUncaughtException() and then SimpleTest.finish() would do the trick; I'm not sure. The try job didn't show any unexpected failures, but I'm no longer confident that this patch works as expected.", "text": "This patch requires an automated test demonstrating that it works as expected. Maybe a new test added to testing/mochitest/Harness_sanity/ that calls SimpleTest.expectUncaughtException() and then SimpleTest.finish() would do the trick; I'm not sure. The try job didn't show any unexpected failures, but I'm no longer confident that this patch works as expected.", "time": "2016-04-23T17:02:45Z", "attachment_id": null, "creator": "josh@joshmatthews.net", "author": "josh@joshmatthews.net"}, {"text": "Hi Josh! I would like to take this up if not already fixed. :) Please assign it to me if anything needs to be done in this.", "attachment_id": null, "time": "2017-01-07T17:30:28Z", "raw_text": "Hi Josh! I would like to take this up if not already fixed. :) Please assign it to me if anything needs to be done in this.", "creation_time": "2017-01-07T17:30:28Z", "bug_id": 682901, "tags": [], "is_private": false, "count": 20, "id": 11964728, "creator": "dwivedi.aman96@gmail.com", "author": "dwivedi.aman96@gmail.com"}, {"creator": "josh@joshmatthews.net", "author": "josh@joshmatthews.net", "raw_text": "It's yours! My last comment still stands - a test demonstrating that the change works as expected is important. Please ask questions if anything is unclear!", "creation_time": "2017-01-07T19:52:36Z", "text": "It's yours! My last comment still stands - a test demonstrating that the change works as expected is important. Please ask questions if anything is unclear!", "attachment_id": null, "time": "2017-01-07T19:52:36Z", "count": 21, "is_private": false, "tags": [], "id": 11964858, "bug_id": 682901}, {"author": "dwivedi.aman96@gmail.com", "creator": "dwivedi.aman96@gmail.com", "raw_text": "I applied the patch and then ran this test. The test passed. Please see and comment if something's wrong. :)", "creation_time": "2017-01-08T13:10:26Z", "time": "2017-01-08T13:10:26Z", "attachment_id": 8824773, "text": "Created attachment 8824773\ntest_bug682901.html\n\nI applied the patch and then ran this test. The test passed. Please see and comment if something's wrong. :)", "id": 11965258, "tags": [], "count": 22, "is_private": false, "bug_id": 682901}, {"is_private": false, "count": 23, "tags": [], "id": 11965260, "bug_id": 682901, "raw_text": "Applying that patch also produced this .rej file. If I m not wrong, the patch needs some change too.", "creation_time": "2017-01-08T13:22:52Z", "text": "Created attachment 8824774\nSimpleTest.js.rej\n\nApplying that patch also produced this .rej file. If I m not wrong, the patch needs some change too.", "time": "2017-01-08T13:22:52Z", "attachment_id": 8824774, "creator": "dwivedi.aman96@gmail.com", "author": "dwivedi.aman96@gmail.com"}, {"author": "martijn.martijn@gmail.com", "creator": "martijn.martijn@gmail.com", "attachment_id": null, "time": "2017-01-08T14:00:05Z", "text": "(In reply to Aman Dwivedi from comment #22)\n> Created attachment 8824773\n> test_bug682901.html\n> \n> I applied the patch and then ran this test. The test passed. Please see and\n> comment if something's wrong. :)\n\nThis test doesn't test the error path the patch would be checking for.\nIn this case, I think a test would be needed that would give an error that would be checked by Python mochitest code. But I guess something from js would be fine as well (although I think from outside of the mochitest js code is more correct), because it is done with expectUncaughtException and https://bug1237363.bmoattachments.org/attachment.cgi?id=8717624 .", "creation_time": "2017-01-08T14:00:05Z", "raw_text": "(In reply to Aman Dwivedi from comment #22)\n> Created attachment 8824773\n> test_bug682901.html\n> \n> I applied the patch and then ran this test. The test passed. Please see and\n> comment if something's wrong. :)\n\nThis test doesn't test the error path the patch would be checking for.\nIn this case, I think a test would be needed that would give an error that would be checked by Python mochitest code. But I guess something from js would be fine as well (although I think from outside of the mochitest js code is more correct), because it is done with expectUncaughtException and https://bug1237363.bmoattachments.org/attachment.cgi?id=8717624 .", "bug_id": 682901, "id": 11965277, "count": 24, "is_private": false, "tags": []}, {"bug_id": 682901, "id": 11965346, "tags": [], "is_private": false, "count": 25, "time": "2017-01-08T16:02:33Z", "attachment_id": 8824773, "text": "Comment on attachment 8824773\ntest_bug682901.html\n\nAs pointed out, this is not checking the condition that we care about, since SimpleTest.waitForExplicitFinish() is never called.", "raw_text": "As pointed out, this is not checking the condition that we care about, since SimpleTest.waitForExplicitFinish() is never called.", "creation_time": "2017-01-08T16:02:33Z", "author": "josh@joshmatthews.net", "creator": "josh@joshmatthews.net"}, {"tags": [], "is_private": false, "count": 26, "id": 11965350, "bug_id": 682901, "raw_text": "Yes. A .rej file means that there were conflicts merging the changes that need to be addressed. If you look at the contents of the file, you can try to apply the same changes to the original files by hand and generate a new patch that applies cleanly.", "creation_time": "2017-01-08T16:03:54Z", "text": "Comment on attachment 8824774\nSimpleTest.js.rej\n\nYes. A .rej file means that there were conflicts merging the changes that need to be addressed. If you look at the contents of the file, you can try to apply the same changes to the original files by hand and generate a new patch that applies cleanly.", "attachment_id": 8824774, "time": "2017-01-08T16:03:54Z", "creator": "josh@joshmatthews.net", "author": "josh@joshmatthews.net"}, {"raw_text": "Thanks for help. I was not clear about it. Please review this patch.", "creation_time": "2017-01-08T21:13:56Z", "attachment_id": 8824809, "time": "2017-01-08T21:13:56Z", "text": "Created attachment 8824809\nBugFix682901.patch\n\nThanks for help. I was not clear about it. Please review this patch.", "id": 11965483, "tags": [], "count": 27, "is_private": false, "bug_id": 682901, "author": "dwivedi.aman96@gmail.com", "creator": "dwivedi.aman96@gmail.com"}, {"author": "josh@joshmatthews.net", "creator": "josh@joshmatthews.net", "bug_id": 682901, "id": 11985845, "tags": [], "is_private": false, "count": 28, "attachment_id": 8824809, "time": "2017-01-16T21:55:39Z", "text": "Comment on attachment 8824809\nBugFix682901.patch\n\nReview of attachment 8824809:\n-----------------------------------------------------------------\n\nWe should rename the new test so it describes what it's testing: test_finish_called_before_waitForExplicitFinish.html.\n\nSorry for the delay in reviewing this change!\n\n::: testing/mochitest/tests/Harness_sanity/test_bug682901.html\n@@ +20,5 @@\n> +/** Test for Bug 682901 **/\n> +SimpleTest.expectUncaughtException();\n> +throw \"an uncaught exception\";\n> +SimpleTest.waitForExplicitFinish();\n> +SimpleTest.finish();\n\nThere are a couple problems here:\n* throwing an exception causes us to stop executing the rest of the test\n* the point of this bug is to identify cases where a test calls `SimpleTest.finish()` before `SimpleTest.waitForExplicitFinish()`. This test is currently doing the opposite, so it should not cause an exception to be thrown.", "creation_time": "2017-01-16T21:55:39Z", "raw_text": "Review of attachment 8824809:\n-----------------------------------------------------------------\n\nWe should rename the new test so it describes what it's testing: test_finish_called_before_waitForExplicitFinish.html.\n\nSorry for the delay in reviewing this change!\n\n::: testing/mochitest/tests/Harness_sanity/test_bug682901.html\n@@ +20,5 @@\n> +/** Test for Bug 682901 **/\n> +SimpleTest.expectUncaughtException();\n> +throw \"an uncaught exception\";\n> +SimpleTest.waitForExplicitFinish();\n> +SimpleTest.finish();\n\nThere are a couple problems here:\n* throwing an exception causes us to stop executing the rest of the test\n* the point of this bug is to identify cases where a test calls `SimpleTest.finish()` before `SimpleTest.waitForExplicitFinish()`. This test is currently doing the opposite, so it should not cause an exception to be thrown."}, {"id": 11991451, "count": 29, "is_private": false, "tags": [], "bug_id": 682901, "raw_text": "Should it be like this? The test doesn't pass using this patch. Maybe I'm going wrong somewhere. :(", "creation_time": "2017-01-18T17:14:39Z", "time": "2017-01-18T17:14:39Z", "attachment_id": 8828002, "text": "Created attachment 8828002\nBugFix682901.patch\n\nShould it be like this? The test doesn't pass using this patch. Maybe I'm going wrong somewhere. :(", "author": "dwivedi.aman96@gmail.com", "creator": "dwivedi.aman96@gmail.com"}, {"creator": "josh@joshmatthews.net", "author": "josh@joshmatthews.net", "tags": [], "is_private": false, "count": 30, "id": 11991645, "bug_id": 682901, "creation_time": "2017-01-18T18:06:50Z", "raw_text": "For the record, there's no need to use \"Need for information from\" every time you request a patch. I get an email notification every time you add the review flag, so needinfo is redundant (and generates an extra email for me to read).", "text": "For the record, there's no need to use \"Need for information from\" every time you request a patch. I get an email notification every time you add the review flag, so needinfo is redundant (and generates an extra email for me to read).", "attachment_id": null, "time": "2017-01-18T18:06:50Z"}, {"tags": [], "is_private": false, "count": 31, "id": 11991670, "bug_id": 682901, "raw_text": "Review of attachment 8828002:\n-----------------------------------------------------------------\n\nGetting closer! Let me know if any of my comments are unclear!\n\n::: testing/mochitest/tests/Harness_sanity/test_finish_called_before_waitForExplicitFinish.html\n@@ +18,5 @@\n> +<pre id=\"test\">\n> +<script class=\"testbody\" type=\"text/javascript\">\n> +/** Test for Bug 682901 **/\n> +SimpleTest.finish();\n> +SimpleTest.waitForExplicitFinish();\n\nThe fact that this test now fails is good! Now we need to add a new API to SimpleTest (like expectUncaughtExceptions and expectRegisteredServiceWorker) that allows the test harness to treat that failing case as a success, so we can make this test pass.\n\n::: testing/mochitest/tests/SimpleTest/SimpleTest.js\n@@ +1065,5 @@\n>  SimpleTest.finish = function() {\n> +    /* disallow calling finish before waitForExplicitFinish\n> +    */\n> +    if (SimpleTest._stopOnLoad) {\n> +        SimpleTest.ok(false, \"[SimpleTest.finish()] waitForExplicitFinish() has not been invoked\");\n\nThis is where we will want to check whether our special API was called, so we can do SimpleTest.ok(true, ...) instead if it was.", "creation_time": "2017-01-18T18:13:13Z", "text": "Comment on attachment 8828002\nBugFix682901.patch\n\nReview of attachment 8828002:\n-----------------------------------------------------------------\n\nGetting closer! Let me know if any of my comments are unclear!\n\n::: testing/mochitest/tests/Harness_sanity/test_finish_called_before_waitForExplicitFinish.html\n@@ +18,5 @@\n> +<pre id=\"test\">\n> +<script class=\"testbody\" type=\"text/javascript\">\n> +/** Test for Bug 682901 **/\n> +SimpleTest.finish();\n> +SimpleTest.waitForExplicitFinish();\n\nThe fact that this test now fails is good! Now we need to add a new API to SimpleTest (like expectUncaughtExceptions and expectRegisteredServiceWorker) that allows the test harness to treat that failing case as a success, so we can make this test pass.\n\n::: testing/mochitest/tests/SimpleTest/SimpleTest.js\n@@ +1065,5 @@\n>  SimpleTest.finish = function() {\n> +    /* disallow calling finish before waitForExplicitFinish\n> +    */\n> +    if (SimpleTest._stopOnLoad) {\n> +        SimpleTest.ok(false, \"[SimpleTest.finish()] waitForExplicitFinish() has not been invoked\");\n\nThis is where we will want to check whether our special API was called, so we can do SimpleTest.ok(true, ...) instead if it was.", "time": "2017-01-18T18:13:13Z", "attachment_id": 8828002, "creator": "josh@joshmatthews.net", "author": "josh@joshmatthews.net"}, {"id": 11999859, "is_private": false, "count": 32, "tags": [], "bug_id": 682901, "creation_time": "2017-01-21T10:43:10Z", "raw_text": "Thanks Josh! Please review this patch.", "time": "2017-01-21T10:43:10Z", "attachment_id": 8829094, "author": "dwivedi.aman96@gmail.com", "creator": "dwivedi.aman96@gmail.com", "text": "Created attachment 8829094\nBugFix682901.patch\n\nThanks Josh! Please review this patch."}, {"creator": "josh@joshmatthews.net", "author": "josh@joshmatthews.net", "bug_id": 682901, "count": 33, "is_private": false, "tags": [], "id": 12003109, "text": "Comment on attachment 8829094\nBugFix682901.patch\n\nReview of attachment 8829094:\n-----------------------------------------------------------------\n\n::: testing/mochitest/tests/SimpleTest/SimpleTest.js\n@@ +1065,5 @@\n>  SimpleTest.finish = function() {\n> +    /* disallow calling finish before waitForExplicitFinish\n> +    */\n> +    if (SimpleTest._stopOnLoad) {\n> +        SimpleTest.ok(true, \"[SimpleTest.finish()] waitForExplicitFinish() has not been invoked\");\n\nThis invalidates the purpose of this patch - the goal is to execute SimpleTest.ok(false) here when regular tests (ie. every test except test_finish_called_before_waitForExplicitFinish.html) do the wrong thing.\n\nWe need to add a separate API to SimpleTest (like the ones I mentioned in my previous review) which controls whether to use SimpleTest.ok(true) or SimpleTest.ok(false) here, so we can call that new API from test_finish_called_before_waitForExplicitFinish.html. Does that make sense?", "attachment_id": 8829094, "time": "2017-01-23T18:19:11Z", "raw_text": "Review of attachment 8829094:\n-----------------------------------------------------------------\n\n::: testing/mochitest/tests/SimpleTest/SimpleTest.js\n@@ +1065,5 @@\n>  SimpleTest.finish = function() {\n> +    /* disallow calling finish before waitForExplicitFinish\n> +    */\n> +    if (SimpleTest._stopOnLoad) {\n> +        SimpleTest.ok(true, \"[SimpleTest.finish()] waitForExplicitFinish() has not been invoked\");\n\nThis invalidates the purpose of this patch - the goal is to execute SimpleTest.ok(false) here when regular tests (ie. every test except test_finish_called_before_waitForExplicitFinish.html) do the wrong thing.\n\nWe need to add a separate API to SimpleTest (like the ones I mentioned in my previous review) which controls whether to use SimpleTest.ok(true) or SimpleTest.ok(false) here, so we can call that new API from test_finish_called_before_waitForExplicitFinish.html. Does that make sense?", "creation_time": "2017-01-23T18:19:11Z"}, {"attachment_id": 8830650, "time": "2017-01-26T09:25:39Z", "text": "Created attachment 8830650\nBugFix682901.patch\n\nHi Josh! Please review this patch.", "creation_time": "2017-01-26T09:25:39Z", "raw_text": "Hi Josh! Please review this patch.", "bug_id": 682901, "id": 12012310, "tags": [], "is_private": false, "count": 34, "author": "dwivedi.aman96@gmail.com", "creator": "dwivedi.aman96@gmail.com"}, {"text": "Comment on attachment 8830650\nBugFix682901.patch\n\nReview of attachment 8830650:\n-----------------------------------------------------------------\n\nAlmost there!\n\n::: testing/mochitest/tests/Harness_sanity/test_finish_called_before_waitForExplicitFinish.html\n@@ +19,5 @@\n> +<script class=\"testbody\" type=\"text/javascript\">\n> +/** Test for Bug 682901 **/\n> +SimpleTest.expectExplicitFinish();\n> +SimpleTest.finish();\n> +SimpleTest.waitForExplicitFinish();\n\nWe can remove this waitForExplicitFinish call; it's not important for this test.\n\n::: testing/mochitest/tests/SimpleTest/SimpleTest.js\n@@ +1069,5 @@\n> +        if (SimpleTest._expectingExplicitFinish) {\n> +            SimpleTest.ok(true, \"[SimpleTest.finish()] waitForExplicitFinish() has been invoked\");\n> +        }\n> +        else {\n> +            SimpleTest.ok(false, \"[SimpleTest.finish()] waitForExplicitFinish() has not been invoked\");\n\nWe can simplify this to:\nSimpleTest.ok(SimpleTest._expectingExplicitFinish, \"[SimpleTest.finish()] waitForExplicitFinish() has not been invoked\");", "attachment_id": 8830650, "time": "2017-01-26T21:52:58Z", "raw_text": "Review of attachment 8830650:\n-----------------------------------------------------------------\n\nAlmost there!\n\n::: testing/mochitest/tests/Harness_sanity/test_finish_called_before_waitForExplicitFinish.html\n@@ +19,5 @@\n> +<script class=\"testbody\" type=\"text/javascript\">\n> +/** Test for Bug 682901 **/\n> +SimpleTest.expectExplicitFinish();\n> +SimpleTest.finish();\n> +SimpleTest.waitForExplicitFinish();\n\nWe can remove this waitForExplicitFinish call; it's not important for this test.\n\n::: testing/mochitest/tests/SimpleTest/SimpleTest.js\n@@ +1069,5 @@\n> +        if (SimpleTest._expectingExplicitFinish) {\n> +            SimpleTest.ok(true, \"[SimpleTest.finish()] waitForExplicitFinish() has been invoked\");\n> +        }\n> +        else {\n> +            SimpleTest.ok(false, \"[SimpleTest.finish()] waitForExplicitFinish() has not been invoked\");\n\nWe can simplify this to:\nSimpleTest.ok(SimpleTest._expectingExplicitFinish, \"[SimpleTest.finish()] waitForExplicitFinish() has not been invoked\");", "creation_time": "2017-01-26T21:52:58Z", "bug_id": 682901, "count": 35, "is_private": false, "tags": [], "id": 12014366, "creator": "josh@joshmatthews.net", "author": "josh@joshmatthews.net"}, {"author": "dwivedi.aman96@gmail.com", "creator": "dwivedi.aman96@gmail.com", "raw_text": "Thanks Josh! Hope this works. :)", "creation_time": "2017-01-27T06:51:41Z", "time": "2017-01-27T06:51:41Z", "attachment_id": 8831042, "text": "Created attachment 8831042\nBugFix682901.patch\n\nThanks Josh! Hope this works. :)", "id": 12015439, "count": 36, "is_private": false, "tags": [], "bug_id": 682901}, {"creator": "josh@joshmatthews.net", "author": "josh@joshmatthews.net", "bug_id": 682901, "is_private": false, "count": 37, "tags": [], "id": 12016362, "text": "Comment on attachment 8831042\nBugFix682901.patch\n\nReview of attachment 8831042:\n-----------------------------------------------------------------\n\nThis looks good! Do you have access to the tryserver yet? If not, you should apply for it by following https://www.mozilla.org/hacking/committer/ so you can submit this patch and see if any tests report failures.", "attachment_id": 8831042, "time": "2017-01-27T15:22:45Z", "raw_text": "Review of attachment 8831042:\n-----------------------------------------------------------------\n\nThis looks good! Do you have access to the tryserver yet? If not, you should apply for it by following https://www.mozilla.org/hacking/committer/ so you can submit this patch and see if any tests report failures.", "creation_time": "2017-01-27T15:22:45Z"}, {"raw_text": "Hi Josh! I'm unable to push to try. I'm getting some authentication error due to public keys.", "creation_time": "2017-02-08T15:40:45Z", "creator": "dwivedi.aman96@gmail.com", "text": "Hi Josh! I'm unable to push to try. I'm getting some authentication error due to public keys.", "attachment_id": null, "time": "2017-02-08T15:40:45Z", "author": "dwivedi.aman96@gmail.com", "is_private": false, "count": 38, "tags": [], "id": 12049367, "bug_id": 682901}, {"creation_time": "2017-02-08T19:02:11Z", "raw_text": "Have you created a `~/.ssh/config` file that contains\nHost hg.mozilla.org\nUser dwivedi.aman96@gmail.com", "author": "josh@joshmatthews.net", "time": "2017-02-08T19:02:11Z", "attachment_id": null, "creator": "josh@joshmatthews.net", "text": "Have you created a `~/.ssh/config` file that contains\nHost hg.mozilla.org\nUser dwivedi.aman96@gmail.com", "id": 12050180, "tags": [], "is_private": false, "count": 39, "bug_id": 682901}, {"raw_text": "https://treeherder.mozilla.org/#/jobs?repo=try&revision=3554fbebb664f1b80d5a3a40c96059c11ac1a64e\n\nI pushed to try. Do I need to add any new jobs on the Treeherder?", "creation_time": "2017-02-08T19:59:49Z", "text": "https://treeherder.mozilla.org/#/jobs?repo=try&revision=3554fbebb664f1b80d5a3a40c96059c11ac1a64e\n\nI pushed to try. Do I need to add any new jobs on the Treeherder?", "creator": "dwivedi.aman96@gmail.com", "time": "2017-02-08T19:59:49Z", "attachment_id": null, "author": "dwivedi.aman96@gmail.com", "count": 40, "is_private": false, "tags": [], "id": 12050414, "bug_id": 682901}, {"bug_id": 682901, "id": 12051912, "tags": [], "count": 41, "is_private": false, "attachment_id": null, "time": "2017-02-09T04:31:09Z", "text": "Yes, adding jobs for mochitests would be valuable. M, M-e10s, tc-M, and tc-M-e10s should be what you're looking for.", "creation_time": "2017-02-09T04:31:09Z", "raw_text": "Yes, adding jobs for mochitests would be valuable. M, M-e10s, tc-M, and tc-M-e10s should be what you're looking for.", "author": "josh@joshmatthews.net", "creator": "josh@joshmatthews.net"}, {"author": "dwivedi.aman96@gmail.com", "creator": "dwivedi.aman96@gmail.com", "attachment_id": null, "time": "2017-02-09T17:08:11Z", "text": "Seems the tests have failed. What to do next?", "creation_time": "2017-02-09T17:08:11Z", "raw_text": "Seems the tests have failed. What to do next?", "bug_id": 682901, "id": 12053744, "is_private": false, "count": 42, "tags": []}, {"creator": "josh@joshmatthews.net", "author": "josh@joshmatthews.net", "text": "The tests that failed will need to be modified. Either they are calling SimpleTest.finish() in a test that does not need asynchronous behaviour (in which case we need to remove the call to SimpleTest.finish), or they are executing SimpleTest.finish() before they have called SimpleTest.waitForExplicitFinish(), so they need to be modified to call it sooner.", "attachment_id": null, "time": "2017-02-09T18:59:38Z", "creation_time": "2017-02-09T18:59:38Z", "raw_text": "The tests that failed will need to be modified. Either they are calling SimpleTest.finish() in a test that does not need asynchronous behaviour (in which case we need to remove the call to SimpleTest.finish), or they are executing SimpleTest.finish() before they have called SimpleTest.waitForExplicitFinish(), so they need to be modified to call it sooner.", "bug_id": 682901, "count": 43, "is_private": false, "tags": [], "id": 12054217}, {"creator": "josh@joshmatthews.net", "author": "josh@joshmatthews.net", "text": "You should be able to replicate the problem (and verify that it's fixed) by running ./mach mochitest path/to/test.html", "time": "2017-02-09T19:00:54Z", "attachment_id": null, "raw_text": "You should be able to replicate the problem (and verify that it's fixed) by running ./mach mochitest path/to/test.html", "creation_time": "2017-02-09T19:00:54Z", "bug_id": 682901, "tags": [], "is_private": false, "count": 44, "id": 12054220}, {"raw_text": "Hi Josh! I ran all the tests in Harness_sanity separately and all did pass. I have done a full mochitest of Harness_sanity using './mach mochitest testing/mochitest/tests/Harness_sanity'. Here attaching the log. Some tests have failed. How to fix these as they do not show any failures when they are run separately?", "creation_time": "2017-02-12T20:00:21Z", "text": "Created attachment 8836505\ntest_result.txt\n\nHi Josh! I ran all the tests in Harness_sanity separately and all did pass. I have done a full mochitest of Harness_sanity using './mach mochitest testing/mochitest/tests/Harness_sanity'. Here attaching the log. Some tests have failed. How to fix these as they do not show any failures when they are run separately?", "time": "2017-02-12T20:00:21Z", "attachment_id": 8836505, "tags": [], "count": 45, "is_private": false, "id": 12060161, "bug_id": 682901, "creator": "dwivedi.aman96@gmail.com", "author": "dwivedi.aman96@gmail.com"}, {"author": "josh@joshmatthews.net", "creator": "josh@joshmatthews.net", "time": "2017-02-13T14:57:25Z", "attachment_id": null, "text": "Ah, looks like the failing test is test_finish_called_before_waitForExplicitFinish.html because it ends up trying to call SimpleTest.finish() twice (due to the window's load event handler that calls it). We should be able to fix that by making the test look this like:\nSimpleTest.expectExplicitFinish();\nSimpleTest.finish();\nSimpleTest.waitForExplicitFinish();", "raw_text": "Ah, looks like the failing test is test_finish_called_before_waitForExplicitFinish.html because it ends up trying to call SimpleTest.finish() twice (due to the window's load event handler that calls it). We should be able to fix that by making the test look this like:\nSimpleTest.expectExplicitFinish();\nSimpleTest.finish();\nSimpleTest.waitForExplicitFinish();", "creation_time": "2017-02-13T14:57:25Z", "bug_id": 682901, "id": 12061957, "is_private": false, "count": 46, "tags": []}, {"author": "dwivedi.aman96@gmail.com", "creator": "dwivedi.aman96@gmail.com", "creation_time": "2017-02-13T16:31:19Z", "raw_text": "Thanks! This should work now. https://treeherder.mozilla.org/#/jobs?repo=try&revision=c5ec36b839948c86e5b034d805c1554c64dca5f5", "attachment_id": null, "time": "2017-02-13T16:31:19Z", "text": "Thanks! This should work now. https://treeherder.mozilla.org/#/jobs?repo=try&revision=c5ec36b839948c86e5b034d805c1554c64dca5f5", "id": 12062393, "count": 47, "is_private": false, "tags": [], "bug_id": 682901}, {"id": 12062434, "tags": [], "is_private": false, "count": 48, "bug_id": 682901, "raw_text": "By the way, you can use http://trychooser.pub.build.mozilla.org/ to choose a list of jobs to run on a try push without having to add them through the treeherder interface manually.", "creation_time": "2017-02-13T16:37:54Z", "attachment_id": null, "time": "2017-02-13T16:37:54Z", "text": "By the way, you can use http://trychooser.pub.build.mozilla.org/ to choose a list of jobs to run on a try push without having to add them through the treeherder interface manually.", "author": "josh@joshmatthews.net", "creator": "josh@joshmatthews.net"}, {"bug_id": 682901, "is_private": false, "count": 49, "tags": [], "id": 12062475, "text": "Thanks Again. :)\nI have pushed to try again.\nhttps://treeherder.mozilla.org/#/jobs?repo=try&revision=4b5800ff36a3925b0ea3a7de50d636c9415aca52", "time": "2017-02-13T16:48:09Z", "attachment_id": null, "creation_time": "2017-02-13T16:48:09Z", "raw_text": "Thanks Again. :)\nI have pushed to try again.\nhttps://treeherder.mozilla.org/#/jobs?repo=try&revision=4b5800ff36a3925b0ea3a7de50d636c9415aca52", "creator": "dwivedi.aman96@gmail.com", "author": "dwivedi.aman96@gmail.com"}, {"author": "dwivedi.aman96@gmail.com", "creator": "dwivedi.aman96@gmail.com", "bug_id": 682901, "id": 12063179, "count": 50, "is_private": false, "tags": [], "attachment_id": null, "time": "2017-02-13T19:55:07Z", "text": "Hi Josh! Tests have failed again. Most of them show \n\n'TEST UNEXPECTED FAIL'- [SimpleTest.finish()] waitForExplicitFinish() has not been invoked.", "creation_time": "2017-02-13T19:55:07Z", "raw_text": "Hi Josh! Tests have failed again. Most of them show \n\n'TEST UNEXPECTED FAIL'- [SimpleTest.finish()] waitForExplicitFinish() has not been invoked."}, {"text": "I explained what to do about that in comment 43.", "attachment_id": null, "time": "2017-02-13T23:25:37Z", "raw_text": "I explained what to do about that in comment 43.", "creation_time": "2017-02-13T23:25:37Z", "bug_id": 682901, "tags": [], "count": 51, "is_private": false, "id": 12063796, "creator": "josh@joshmatthews.net", "author": "josh@joshmatthews.net"}, {"text": "Created attachment 8837930\nbugfix.patch\n\nhttps://treeherder.mozilla.org/#/jobs?repo=try&revision=281ee95eaee0f6068b4ab6c6b9c80c948e89175b", "creator": "dwivedi.aman96@gmail.com", "time": "2017-02-16T04:49:01Z", "attachment_id": 8837930, "author": "dwivedi.aman96@gmail.com", "raw_text": "https://treeherder.mozilla.org/#/jobs?repo=try&revision=281ee95eaee0f6068b4ab6c6b9c80c948e89175b", "creation_time": "2017-02-16T04:49:01Z", "bug_id": 682901, "is_private": false, "count": 52, "tags": [], "id": 12072044}, {"id": 12114606, "count": 53, "is_private": false, "tags": [], "bug_id": 682901, "creation_time": "2017-03-03T19:26:09Z", "raw_text": "I apologize for the delay; the past couple weeks were exceedingly busy for me, and I'm now traveling with unreliable internet. The try push shows that at least some changes appear to be incorrect, such as dom/media/tests/mochitest/test_dataChannel_basicVideo.html and a number of other tests in dom/media. Any results that have \"Result logged after SimpleTest.finish()\" mean that the test is continuing to execute after SimpleTest.finish() was called, and that means that SimpleTest.finish() needs to execute later than it does.", "attachment_id": null, "time": "2017-03-03T19:26:09Z", "text": "I apologize for the delay; the past couple weeks were exceedingly busy for me, and I'm now traveling with unreliable internet. The try push shows that at least some changes appear to be incorrect, such as dom/media/tests/mochitest/test_dataChannel_basicVideo.html and a number of other tests in dom/media. Any results that have \"Result logged after SimpleTest.finish()\" mean that the test is continuing to execute after SimpleTest.finish() was called, and that means that SimpleTest.finish() needs to execute later than it does.", "author": "josh@joshmatthews.net", "creator": "josh@joshmatthews.net"}, {"is_private": false, "count": 54, "tags": [], "id": 12114631, "bug_id": 682901, "creation_time": "2017-03-03T19:31:02Z", "raw_text": "I will attempt to review these changes over the next few days.", "text": "I will attempt to review these changes over the next few days.", "time": "2017-03-03T19:31:02Z", "attachment_id": null, "creator": "josh@joshmatthews.net", "author": "josh@joshmatthews.net"}, {"text": "Comment on attachment 8837930\nbugfix.patch\n\nReview of attachment 8837930:\n-----------------------------------------------------------------\n\nMost of these changes look good! We can reduce the number of test files that need changing by a lot if we make a few specific changes to files that they import, instead. I would like to see what the patch looks like after making those changes and reverting the unnecessary changes. Please do another try push after making the requested changes, too!\n\n::: devtools/client/shared/components/reps/test/mochitest/test_reps_array.html\n@@ +17,4 @@\n>  <script src=\"head.js\" type=\"application/javascript;version=1.8\"></script>\n>  <script type=\"application/javascript;version=1.8\">\n>  \"use strict\";\n> +SimpleTest.waitForExplicitFinish();\n\nInstead of adding this to each test file in devtools/client/shared/components/reps/test/mochitest/, let's add it to head.js. This should let us revert the changes to all the test files.\n\n::: dom/console/tests/test_bug978522.html\n@@ +25,4 @@\n>    });\n>  \n>    SimpleTest.waitForExplicitFinish();\n> +  SimpleTest.finish();\n\nThis change is not correct. Instead, we should call waitForExplicitFinish before console.log.\n\n::: dom/events/test/test_bug667919-1.html\n@@ +33,4 @@\n>  event.initDeviceOrientationEvent('deviceorientation', true, true, 1.5, 2.25, 3.667, true);\n>  window.dispatchEvent(event);\n>  SimpleTest.waitForExplicitFinish();\n> +SimpleTest.finish();\n\nWe should call waitForExplicitFinish sooner, rather than moving SimpleTest.finish.\n\n::: dom/indexedDB/test/test_bug937006.html\n@@ +21,4 @@\n>      setTimeout(indexedDB.deleteDatabase.bind(indexedDB), 0, 'x');\n>      setTimeout(function() {\n>        ok(true, \"Still alive\");\n> +      SimpleTest.waitForExplicitFinish();\n\nWe should be calling this before runTest instead.\n\n::: dom/media/tests/mochitest/identity/identityPcTest.js\n@@ +1,2 @@\n>  function identityPcTest(remoteOptions) {\n> +  SimpleTest.waitForExplicitFinish();\n\nThis should not be necessary if we modify dom/media/tests/mochitest/head.js.\n\n::: dom/media/tests/mochitest/identity/test_getIdentityAssertion.html\n@@ +28,4 @@\n>  \n>  var test;\n>  function theTest() {\n> +  SimpleTest.waitForExplicitFinish();\n\nInstead, what if we add this to dom/media/tests/mochitest/head.js inside setupEnvironment?\n\n::: dom/media/tests/mochitest/identity/test_loginNeeded.html\n@@ +41,4 @@\n>  }\n>  \n>  function theTest() {\n> +  SimpleTest.waitForExplicitFinish();\n\nThis (and other changes to tests in dom/media/tests/mochitest) should not be necessary if we change head.js.\n\n::: dom/tests/mochitest/bugs/test_DOMWindowCreated_chromeonly.html\n@@ +7,4 @@\n>    <p id=\"display\"></p>\n>  \n>    <script type=\"application/javascript\">\n> +  \n\nThis change should not be necessary. We should investigate what happens if we revert the changes to this file.\n\n::: layout/mathml/tests/test_opentype-fraction.html\n@@ +97,4 @@\n>  \n>          ok(almostEqual(getBox(\"d9\").bottom - getBox(\"dref\").bottom, ref*3),\n>             \"Bad FractionDenominatorDisplayStyleShiftDown\");\n> +        SimpleTest.waitForExplicitFinish();\n\nEven though the effect is the same, this should be called earlier (up near `var epsilon = 5;`).\n\n::: netwerk/test/mochitests/test_viewsource_unlinkable.html\n@@ +12,4 @@\n>    SimpleTest.doesThrow(function() {\n>      window.open('view-source:' + location.href, \"_blank\");\n>    }, \"Trying to access view-source URL from unprivileged code should throw.\");\n> +  SimpleTest.waitForExplicitFinish();\n\nLet's call this outside of runTest for clarity.\n\n::: security/manager/ssl/tests/mochitest/mixedcontent/test_cssBefore1.html\n@@ +19,4 @@\n>    <script class=\"testbody\" type=\"text/javascript\">\n>    /* import-globals-from mixedContentTest.js */\n>    \"use strict\";\n> +  SimpleTest.waitForExplicitFinish();\n\nRather than adding SimpleTest.waitForExplicitFinish to each of the tests in security/manager/ssl/tests/mochitest/mixedcontent/, let's add it to mixedContentTest.js instead. This should allow us to revert the change to each of the mixedcontent/ test files.\n\n::: testing/mochitest/tests/Harness_sanity/test_finish_called_before_waitForExplicitFinish.html\n@@ +19,5 @@\n> +<script class=\"testbody\" type=\"text/javascript\">\n> +/** Test for Bug 682901 **/\n> +SimpleTest.expectExplicitFinish();\n> +SimpleTest.finish();\n> +SimpleTest.waitForExplicitFinish();\n\nNo need for this waitForExplicitFinish.", "time": "2017-03-05T04:57:26Z", "attachment_id": 8837930, "raw_text": "Review of attachment 8837930:\n-----------------------------------------------------------------\n\nMost of these changes look good! We can reduce the number of test files that need changing by a lot if we make a few specific changes to files that they import, instead. I would like to see what the patch looks like after making those changes and reverting the unnecessary changes. Please do another try push after making the requested changes, too!\n\n::: devtools/client/shared/components/reps/test/mochitest/test_reps_array.html\n@@ +17,4 @@\n>  <script src=\"head.js\" type=\"application/javascript;version=1.8\"></script>\n>  <script type=\"application/javascript;version=1.8\">\n>  \"use strict\";\n> +SimpleTest.waitForExplicitFinish();\n\nInstead of adding this to each test file in devtools/client/shared/components/reps/test/mochitest/, let's add it to head.js. This should let us revert the changes to all the test files.\n\n::: dom/console/tests/test_bug978522.html\n@@ +25,4 @@\n>    });\n>  \n>    SimpleTest.waitForExplicitFinish();\n> +  SimpleTest.finish();\n\nThis change is not correct. Instead, we should call waitForExplicitFinish before console.log.\n\n::: dom/events/test/test_bug667919-1.html\n@@ +33,4 @@\n>  event.initDeviceOrientationEvent('deviceorientation', true, true, 1.5, 2.25, 3.667, true);\n>  window.dispatchEvent(event);\n>  SimpleTest.waitForExplicitFinish();\n> +SimpleTest.finish();\n\nWe should call waitForExplicitFinish sooner, rather than moving SimpleTest.finish.\n\n::: dom/indexedDB/test/test_bug937006.html\n@@ +21,4 @@\n>      setTimeout(indexedDB.deleteDatabase.bind(indexedDB), 0, 'x');\n>      setTimeout(function() {\n>        ok(true, \"Still alive\");\n> +      SimpleTest.waitForExplicitFinish();\n\nWe should be calling this before runTest instead.\n\n::: dom/media/tests/mochitest/identity/identityPcTest.js\n@@ +1,2 @@\n>  function identityPcTest(remoteOptions) {\n> +  SimpleTest.waitForExplicitFinish();\n\nThis should not be necessary if we modify dom/media/tests/mochitest/head.js.\n\n::: dom/media/tests/mochitest/identity/test_getIdentityAssertion.html\n@@ +28,4 @@\n>  \n>  var test;\n>  function theTest() {\n> +  SimpleTest.waitForExplicitFinish();\n\nInstead, what if we add this to dom/media/tests/mochitest/head.js inside setupEnvironment?\n\n::: dom/media/tests/mochitest/identity/test_loginNeeded.html\n@@ +41,4 @@\n>  }\n>  \n>  function theTest() {\n> +  SimpleTest.waitForExplicitFinish();\n\nThis (and other changes to tests in dom/media/tests/mochitest) should not be necessary if we change head.js.\n\n::: dom/tests/mochitest/bugs/test_DOMWindowCreated_chromeonly.html\n@@ +7,4 @@\n>    <p id=\"display\"></p>\n>  \n>    <script type=\"application/javascript\">\n> +  \n\nThis change should not be necessary. We should investigate what happens if we revert the changes to this file.\n\n::: layout/mathml/tests/test_opentype-fraction.html\n@@ +97,4 @@\n>  \n>          ok(almostEqual(getBox(\"d9\").bottom - getBox(\"dref\").bottom, ref*3),\n>             \"Bad FractionDenominatorDisplayStyleShiftDown\");\n> +        SimpleTest.waitForExplicitFinish();\n\nEven though the effect is the same, this should be called earlier (up near `var epsilon = 5;`).\n\n::: netwerk/test/mochitests/test_viewsource_unlinkable.html\n@@ +12,4 @@\n>    SimpleTest.doesThrow(function() {\n>      window.open('view-source:' + location.href, \"_blank\");\n>    }, \"Trying to access view-source URL from unprivileged code should throw.\");\n> +  SimpleTest.waitForExplicitFinish();\n\nLet's call this outside of runTest for clarity.\n\n::: security/manager/ssl/tests/mochitest/mixedcontent/test_cssBefore1.html\n@@ +19,4 @@\n>    <script class=\"testbody\" type=\"text/javascript\">\n>    /* import-globals-from mixedContentTest.js */\n>    \"use strict\";\n> +  SimpleTest.waitForExplicitFinish();\n\nRather than adding SimpleTest.waitForExplicitFinish to each of the tests in security/manager/ssl/tests/mochitest/mixedcontent/, let's add it to mixedContentTest.js instead. This should allow us to revert the change to each of the mixedcontent/ test files.\n\n::: testing/mochitest/tests/Harness_sanity/test_finish_called_before_waitForExplicitFinish.html\n@@ +19,5 @@\n> +<script class=\"testbody\" type=\"text/javascript\">\n> +/** Test for Bug 682901 **/\n> +SimpleTest.expectExplicitFinish();\n> +SimpleTest.finish();\n> +SimpleTest.waitForExplicitFinish();\n\nNo need for this waitForExplicitFinish.", "creation_time": "2017-03-05T04:57:26Z", "bug_id": 682901, "tags": [], "is_private": false, "count": 55, "id": 12116321, "creator": "josh@joshmatthews.net", "author": "josh@joshmatthews.net"}, {"bug_id": 682901, "is_private": false, "count": 56, "tags": [], "id": 12150742, "text": "Created attachment 8848053\nbugfix.patch\n\nThanks Josh! Sorry for the delay. I had to revert many of the changes as suggested by you. \nhttps://treeherder.mozilla.org/#/jobs?repo=try&revision=13416ebe3602c3f6d23087c7658ec71451105476", "attachment_id": 8848053, "time": "2017-03-16T12:27:09Z", "creation_time": "2017-03-16T12:27:09Z", "raw_text": "Thanks Josh! Sorry for the delay. I had to revert many of the changes as suggested by you. \nhttps://treeherder.mozilla.org/#/jobs?repo=try&revision=13416ebe3602c3f6d23087c7658ec71451105476", "creator": "dwivedi.aman96@gmail.com", "author": "dwivedi.aman96@gmail.com"}, {"creator": "josh@joshmatthews.net", "author": "josh@joshmatthews.net", "tags": [], "is_private": false, "count": 57, "id": 12151630, "bug_id": 682901, "raw_text": "Review of attachment 8848053:\n-----------------------------------------------------------------\n\nThis is looking better! The try run still shows a bunch of test failures which you will need to investigate; please run them locally (./mach mochitest path/to/test.html) to ensure that they're passing after making changes to them. Additionally, there are a lot of files included in this patch which used to have meaningful changes, and now only contain leftover indentation on blank lines. This makes the patch harder to review; please look at the diff locally and edit the files to remove the changes that only affect whitespace. I stopped commenting on those files about halfway through. Thanks for following up on my previous review!\n\n::: dom/console/tests/test_bug978522.html\n@@ +24,5 @@\n>        });\n>      }\n>    });\n>  \n> +  SimpleTest.finish();\n\nWe should leave the SimpleTest.finish() call where it was originally.\n\n::: dom/events/test/test_bug667919-1.html\n@@ +33,4 @@\n>  event = document.createEvent(\"DeviceOrientationEvent\");\n>  event.initDeviceOrientationEvent('deviceorientation', true, true, 1.5, 2.25, 3.667, true);\n>  window.dispatchEvent(event);\n> +SimpleTest.finish();\n\nWe should leave the SimpleTest.finish() call where it was originally.\n\n::: dom/media/tests/mochitest/head.js\n@@ +4,4 @@\n>  \n>  \"use strict\";\n>  \n> +SimpleTest.waitForExplicitFinish();\n\nThis is redundant with the call in setupEnvironment. Let's remove this one.\n\n@@ +307,4 @@\n>  var testConfigured = new Promise(r => setTestOptions = r);\n>  \n>  function setupEnvironment() {\n> +  SimpleTest.waitForExplicitFinish();\n\nWe should move this after the check for window.SimpleTest on the next line.\n\n::: dom/media/tests/mochitest/identity/test_fingerprints.html\n@@ -102,4 @@\n>      });\n>  }\n>  \n> -SimpleTest.waitForExplicitFinish();\n\nThis test doesn't load head.js, so we need to leave this here.\n\n::: dom/media/tests/mochitest/identity/test_idpproxy.html\n@@ -169,4 @@\n>      .then(() => SimpleTest.finish());\n>  }\n>  \n> -SimpleTest.waitForExplicitFinish();\n\nThis test doesn't load head.js, so we need to leave this alone.\n\n::: dom/media/tests/mochitest/test_dataChannel_noOffer.html\n@@ +20,4 @@\n>      pc.createOffer(options).then(offer => {\n>        ok(!offer.sdp.includes(\"m=application\"),\n>          \"m=application is not contained in the SDP\");\n> +      \n\nLet's undo this whitespace change.\n\n::: dom/media/tests/mochitest/test_getUserMedia_bug1223696.html\n@@ +18,4 @@\n>    runTest(() => Promise.resolve()\n>      .then(() => getUserMedia({audio:true, video: true})).then(stream => {\n>        info(\"Test addTrack()ing a video track to an audio-only gUM stream\");\n> +      \n\nUndo this whitespace change.\n\n::: dom/media/tests/mochitest/test_ondevicechange.html\n@@ -42,4 @@\n>  var videoTracks;\n>  \n>  SimpleTest.requestCompleteLog();\n> -SimpleTest.waitForExplicitFinish();\n\nThis test doesn't use head.js, so we need to leave this here.\n\n::: dom/media/tests/mochitest/test_peerConnection_bug825703.html\n@@ +40,4 @@\n>  \n>  // This is a test of the iceServers parsing code + readable errors\n>  runNetworkTest(() => {\n> +  SimpleTest.waitForExplicitFinish();\n\nIsn't this unnecessary with the change to head.js?\n\n::: dom/tests/mochitest/bugs/test_DOMWindowCreated_chromeonly.html\n@@ +7,4 @@\n>    <p id=\"display\"></p>\n>  \n>    <script type=\"application/javascript\">\n> +  SimpleTest.waitForExplicitFinish();  \n\nnit: remove the trailing whitespace on this line.\n\n::: security/manager/ssl/tests/mochitest/mixedcontent/test_bug329869.html\n@@ +9,4 @@\n>    <script class=\"testbody\" type=\"text/javascript\">\n>    /* import-globals-from mixedContentTest.js */\n>    \"use strict\";\n> +  \n\nnit: remove this trailing whitespace.\n\n::: security/manager/ssl/tests/mochitest/mixedcontent/test_bug383369.html\n@@ +11,4 @@\n>    /* global sendAsyncMessage */\n>    /* import-globals-from mixedContentTest.js */\n>    \"use strict\";\n> +  \n\nnit: remove this trailing whitespace.\n\n::: security/manager/ssl/tests/mochitest/mixedcontent/test_bug455367.html\n@@ +13,4 @@\n>    <script class=\"testbody\" type=\"text/javascript\">\n>    /* import-globals-from mixedContentTest.js */\n>    \"use strict\";\n> +  \n\nnit: remove this trailing whitespace.\n\n::: security/manager/ssl/tests/mochitest/mixedcontent/test_bug472986.html\n@@ +13,4 @@\n>    <script class=\"testbody\" type=\"text/javascript\">\n>    /* import-globals-from mixedContentTest.js */\n>    \"use strict\";\n> +  \n\nnit: remove this trailing whitespace.\n\n::: security/manager/ssl/tests/mochitest/mixedcontent/test_bug477118.html\n@@ +13,4 @@\n>    <script class=\"testbody\" type=\"text/javascript\">\n>    /* import-globals-from mixedContentTest.js */\n>    \"use strict\";\n> +  \n\nnit: remove this trailing whitespace.\n\n::: security/manager/ssl/tests/mochitest/mixedcontent/test_bug521461.html\n@@ +13,4 @@\n>    <script class=\"testbody\" type=\"text/javascript\">\n>    /* import-globals-from mixedContentTest.js */\n>    \"use strict\";\n> +  \n\nnit: remove this trailing whitespace.\n\n::: security/manager/ssl/tests/mochitest/mixedcontent/test_cssBefore1.html\n@@ +19,4 @@\n>    <script class=\"testbody\" type=\"text/javascript\">\n>    /* import-globals-from mixedContentTest.js */\n>    \"use strict\";\n> +  \n\nnit: remove this trailing whitespace.\n\n::: security/manager/ssl/tests/mochitest/mixedcontent/test_cssContent1.html\n@@ +20,4 @@\n>    <script class=\"testbody\" type=\"text/javascript\">\n>    /* import-globals-from mixedContentTest.js */\n>    \"use strict\";\n> +  \n\nnit: remove this trailing whitespace.\n\n::: security/manager/ssl/tests/mochitest/mixedcontent/test_cssContent2.html\n@@ +13,4 @@\n>    <script class=\"testbody\" type=\"text/javascript\">\n>    /* import-globals-from mixedContentTest.js */\n>    \"use strict\";\n> +  \n\nnit: remove this trailing whitespace.\n\n::: toolkit/components/passwordmgr/test/mochitest/test_xhr_2.html\n@@ +22,4 @@\n>   * 2. connect authenticate.sjs that this time expects differentuser2:pass2 password\n>   *    we must use the creds that are provided to the xhr witch are different and expected\n>   */\n> + \n\nnit: remove this trailing whitespace.", "creation_time": "2017-03-16T17:05:22Z", "text": "Comment on attachment 8848053\nbugfix.patch\n\nReview of attachment 8848053:\n-----------------------------------------------------------------\n\nThis is looking better! The try run still shows a bunch of test failures which you will need to investigate; please run them locally (./mach mochitest path/to/test.html) to ensure that they're passing after making changes to them. Additionally, there are a lot of files included in this patch which used to have meaningful changes, and now only contain leftover indentation on blank lines. This makes the patch harder to review; please look at the diff locally and edit the files to remove the changes that only affect whitespace. I stopped commenting on those files about halfway through. Thanks for following up on my previous review!\n\n::: dom/console/tests/test_bug978522.html\n@@ +24,5 @@\n>        });\n>      }\n>    });\n>  \n> +  SimpleTest.finish();\n\nWe should leave the SimpleTest.finish() call where it was originally.\n\n::: dom/events/test/test_bug667919-1.html\n@@ +33,4 @@\n>  event = document.createEvent(\"DeviceOrientationEvent\");\n>  event.initDeviceOrientationEvent('deviceorientation', true, true, 1.5, 2.25, 3.667, true);\n>  window.dispatchEvent(event);\n> +SimpleTest.finish();\n\nWe should leave the SimpleTest.finish() call where it was originally.\n\n::: dom/media/tests/mochitest/head.js\n@@ +4,4 @@\n>  \n>  \"use strict\";\n>  \n> +SimpleTest.waitForExplicitFinish();\n\nThis is redundant with the call in setupEnvironment. Let's remove this one.\n\n@@ +307,4 @@\n>  var testConfigured = new Promise(r => setTestOptions = r);\n>  \n>  function setupEnvironment() {\n> +  SimpleTest.waitForExplicitFinish();\n\nWe should move this after the check for window.SimpleTest on the next line.\n\n::: dom/media/tests/mochitest/identity/test_fingerprints.html\n@@ -102,4 @@\n>      });\n>  }\n>  \n> -SimpleTest.waitForExplicitFinish();\n\nThis test doesn't load head.js, so we need to leave this here.\n\n::: dom/media/tests/mochitest/identity/test_idpproxy.html\n@@ -169,4 @@\n>      .then(() => SimpleTest.finish());\n>  }\n>  \n> -SimpleTest.waitForExplicitFinish();\n\nThis test doesn't load head.js, so we need to leave this alone.\n\n::: dom/media/tests/mochitest/test_dataChannel_noOffer.html\n@@ +20,4 @@\n>      pc.createOffer(options).then(offer => {\n>        ok(!offer.sdp.includes(\"m=application\"),\n>          \"m=application is not contained in the SDP\");\n> +      \n\nLet's undo this whitespace change.\n\n::: dom/media/tests/mochitest/test_getUserMedia_bug1223696.html\n@@ +18,4 @@\n>    runTest(() => Promise.resolve()\n>      .then(() => getUserMedia({audio:true, video: true})).then(stream => {\n>        info(\"Test addTrack()ing a video track to an audio-only gUM stream\");\n> +      \n\nUndo this whitespace change.\n\n::: dom/media/tests/mochitest/test_ondevicechange.html\n@@ -42,4 @@\n>  var videoTracks;\n>  \n>  SimpleTest.requestCompleteLog();\n> -SimpleTest.waitForExplicitFinish();\n\nThis test doesn't use head.js, so we need to leave this here.\n\n::: dom/media/tests/mochitest/test_peerConnection_bug825703.html\n@@ +40,4 @@\n>  \n>  // This is a test of the iceServers parsing code + readable errors\n>  runNetworkTest(() => {\n> +  SimpleTest.waitForExplicitFinish();\n\nIsn't this unnecessary with the change to head.js?\n\n::: dom/tests/mochitest/bugs/test_DOMWindowCreated_chromeonly.html\n@@ +7,4 @@\n>    <p id=\"display\"></p>\n>  \n>    <script type=\"application/javascript\">\n> +  SimpleTest.waitForExplicitFinish();  \n\nnit: remove the trailing whitespace on this line.\n\n::: security/manager/ssl/tests/mochitest/mixedcontent/test_bug329869.html\n@@ +9,4 @@\n>    <script class=\"testbody\" type=\"text/javascript\">\n>    /* import-globals-from mixedContentTest.js */\n>    \"use strict\";\n> +  \n\nnit: remove this trailing whitespace.\n\n::: security/manager/ssl/tests/mochitest/mixedcontent/test_bug383369.html\n@@ +11,4 @@\n>    /* global sendAsyncMessage */\n>    /* import-globals-from mixedContentTest.js */\n>    \"use strict\";\n> +  \n\nnit: remove this trailing whitespace.\n\n::: security/manager/ssl/tests/mochitest/mixedcontent/test_bug455367.html\n@@ +13,4 @@\n>    <script class=\"testbody\" type=\"text/javascript\">\n>    /* import-globals-from mixedContentTest.js */\n>    \"use strict\";\n> +  \n\nnit: remove this trailing whitespace.\n\n::: security/manager/ssl/tests/mochitest/mixedcontent/test_bug472986.html\n@@ +13,4 @@\n>    <script class=\"testbody\" type=\"text/javascript\">\n>    /* import-globals-from mixedContentTest.js */\n>    \"use strict\";\n> +  \n\nnit: remove this trailing whitespace.\n\n::: security/manager/ssl/tests/mochitest/mixedcontent/test_bug477118.html\n@@ +13,4 @@\n>    <script class=\"testbody\" type=\"text/javascript\">\n>    /* import-globals-from mixedContentTest.js */\n>    \"use strict\";\n> +  \n\nnit: remove this trailing whitespace.\n\n::: security/manager/ssl/tests/mochitest/mixedcontent/test_bug521461.html\n@@ +13,4 @@\n>    <script class=\"testbody\" type=\"text/javascript\">\n>    /* import-globals-from mixedContentTest.js */\n>    \"use strict\";\n> +  \n\nnit: remove this trailing whitespace.\n\n::: security/manager/ssl/tests/mochitest/mixedcontent/test_cssBefore1.html\n@@ +19,4 @@\n>    <script class=\"testbody\" type=\"text/javascript\">\n>    /* import-globals-from mixedContentTest.js */\n>    \"use strict\";\n> +  \n\nnit: remove this trailing whitespace.\n\n::: security/manager/ssl/tests/mochitest/mixedcontent/test_cssContent1.html\n@@ +20,4 @@\n>    <script class=\"testbody\" type=\"text/javascript\">\n>    /* import-globals-from mixedContentTest.js */\n>    \"use strict\";\n> +  \n\nnit: remove this trailing whitespace.\n\n::: security/manager/ssl/tests/mochitest/mixedcontent/test_cssContent2.html\n@@ +13,4 @@\n>    <script class=\"testbody\" type=\"text/javascript\">\n>    /* import-globals-from mixedContentTest.js */\n>    \"use strict\";\n> +  \n\nnit: remove this trailing whitespace.\n\n::: toolkit/components/passwordmgr/test/mochitest/test_xhr_2.html\n@@ +22,4 @@\n>   * 2. connect authenticate.sjs that this time expects differentuser2:pass2 password\n>   *    we must use the creds that are provided to the xhr witch are different and expected\n>   */\n> + \n\nnit: remove this trailing whitespace.", "attachment_id": 8848053, "time": "2017-03-16T17:05:22Z"}, {"creator": "release-mgmt-account-bot@mozilla.tld", "author": "release-mgmt-account-bot@mozilla.tld", "is_private": false, "count": 58, "tags": [], "id": 15228176, "bug_id": 682901, "raw_text": "This good-first-bug hasn't had any activity for 6 months, it is automatically unassigned.\nFor more information, please visit [auto_nag documentation](https://wiki.mozilla.org/Release_Management/autonag#good_first_bug_unassign_inactive.py).", "creation_time": "2021-01-22T12:40:59Z", "text": "This good-first-bug hasn't had any activity for 6 months, it is automatically unassigned.\nFor more information, please visit [auto_nag documentation](https://wiki.mozilla.org/Release_Management/autonag#good_first_bug_unassign_inactive.py).", "time": "2021-01-22T12:40:59Z", "attachment_id": null}]}}}