{"comments": {}, "bugs": {"1631137": {"comments": [{"creator": "agi@sferro.dev", "id": 14762957, "bug_id": 1631137, "count": 0, "is_private": false, "time": "2020-04-17T23:10:48Z", "raw_text": "This bug is for crash report bp-5ce7a02f-f02b-45a2-b4d5-597a70200417.\n\n```\nJava stack trace:\n\n[INFO] mozilla.components.feature.addons.AddonManagerException\n\tat mozilla.components.feature.addons.AddonManager.getAddons(AddonManager.kt:57)\n\tat mozilla.components.feature.addons.AddonManager$getAddons$1.invokeSuspend(Unknown Source:12)\n\tat kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:2)\n\tat kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:18)\n\tat kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:1)\n\tat kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:14)", "tags": [], "author": "agi@sferro.dev", "attachment_id": null, "text": "This bug is for crash report bp-5ce7a02f-f02b-45a2-b4d5-597a70200417.\n\n```\nJava stack trace:\n\n[INFO] mozilla.components.feature.addons.AddonManagerException\n\tat mozilla.components.feature.addons.AddonManager.getAddons(AddonManager.kt:57)\n\tat mozilla.components.feature.addons.AddonManager$getAddons$1.invokeSuspend(Unknown Source:12)\n\tat kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:2)\n\tat kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:18)\n\tat kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:1)\n\tat kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:14)", "creation_time": "2020-04-17T23:10:48Z"}, {"count": 1, "text": "Message: \n\n```\n[INFO] mozilla.components.feature.addons.AddonManagerException: java.lang.Exception: Unexpected error: TypeError: can't access property \"choices\", ns.get(...) is undefined\n```\n\nLooks like a regression from Bug 1622917. Shane do you have an idea of could be going on here?", "creation_time": "2020-04-17T23:11:53Z", "time": "2020-04-17T23:11:53Z", "raw_text": "Message: \n\n```\n[INFO] mozilla.components.feature.addons.AddonManagerException: java.lang.Exception: Unexpected error: TypeError: can't access property \"choices\", ns.get(...) is undefined\n```\n\nLooks like a regression from Bug 1622917. Shane do you have an idea of could be going on here?", "is_private": false, "attachment_id": null, "creator": "agi@sferro.dev", "tags": [], "author": "agi@sferro.dev", "bug_id": 1631137, "id": 14762958}, {"count": 2, "is_private": false, "raw_text": "You're probably accessing schema before it is loaded.  I had the same issue in a test i just wrote.  See the comment in the setup function.\n\nhttps://phabricator.services.mozilla.com/D71231", "creation_time": "2020-04-17T23:35:11Z", "text": "You're probably accessing schema before it is loaded.  I had the same issue in a test i just wrote.  See the comment in the setup function.\n\nhttps://phabricator.services.mozilla.com/D71231", "time": "2020-04-17T23:35:11Z", "author": "mixedpuppy@gmail.com", "tags": [], "creator": "mixedpuppy@gmail.com", "attachment_id": null, "id": 14762975, "bug_id": 1631137}, {"id": 14762978, "bug_id": 1631137, "author": "mixedpuppy@gmail.com", "tags": [], "creator": "mixedpuppy@gmail.com", "attachment_id": null, "is_private": false, "raw_text": "Essentially, schemas are lazy loaded to avoid a startup penalty.  \n\nhttps://searchfox.org/mozilla-central/rev/aec63591821712236a522f7f55116f582ed7c920/toolkit/components/extensions/Extension.jsm#847", "creation_time": "2020-04-17T23:38:55Z", "time": "2020-04-17T23:38:55Z", "text": "Essentially, schemas are lazy loaded to avoid a startup penalty.  \n\nhttps://searchfox.org/mozilla-central/rev/aec63591821712236a522f7f55116f582ed7c920/toolkit/components/extensions/Extension.jsm#847", "count": 3}, {"attachment_id": null, "author": "amejiamarmol@mozilla.com", "tags": [], "creation_time": "2020-04-17T23:49:39Z", "text": "Below the logcat after simulating the issue.\nWe are seeing this after disabling an add-on with `webExtensionController.disable` with `EnableSource#APP` and then restarting the app and trying to call  `runtime.webExtensionController.list()`. We tested using dark reader. Also Christian mentioned: the issue could be related to the schema migration. You migrate the schema the first time you need to, this may or may not finish before we call  `list `, when it doesn't finish in time `list` fails, but then the next startup is fine again because the schema was migrated.\n\n```\n2020-04-17 19:17:18.754 26973-26973/? E/lla.fenix.debu: Unknown bits set in runtime_flags: 0x8000\n2020-04-17 19:17:20.325 26973-27033/org.mozilla.fenix.debug E/GeckoLibLoad: Load sqlite start\n2020-04-17 19:17:20.328 26973-27033/org.mozilla.fenix.debug E/GeckoLibLoad: Load sqlite done\n2020-04-17 19:17:20.328 26973-27033/org.mozilla.fenix.debug E/GeckoLibLoad: Load nss start\n2020-04-17 19:17:20.328 26973-27033/org.mozilla.fenix.debug E/GeckoLibLoad: Load nss done\n2020-04-17 19:17:20.354 26973-27033/org.mozilla.fenix.debug E/GeckoLibLoad: Loaded libs in 25.111201ms total, 6ms(46ms) user, 13ms(13ms) system, 1(1) faults\n2020-04-17 19:17:21.134 26973-27061/org.mozilla.fenix.debug E/libc: Access denied finding property \"vendor.gralloc.disable_ahardware_buffer\"\n2020-04-17 19:17:21.230 26973-27033/org.mozilla.fenix.debug E/GeckoConsole: [JavaScript Error: \"Schema loaded after root schema populated\" {file: \"resource://gre/modules/Schemas.jsm\" line: 3497}]\n    addSchema@resource://gre/modules/Schemas.jsm:3497:13\n    load@resource://gre/modules/Schemas.jsm:3528:12\n2020-04-17 19:17:21.231 26973-27033/org.mozilla.fenix.debug E/GeckoConsole: [JavaScript Error: \"Schema loaded after root schema populated\" {file: \"resource://gre/modules/Schemas.jsm\" line: 3497}]\n    addSchema@resource://gre/modules/Schemas.jsm:3497:13\n    load@resource://gre/modules/Schemas.jsm:3528:12\n2020-04-17 19:17:21.231 26973-27033/org.mozilla.fenix.debug E/GeckoConsole: [JavaScript Error: \"Schema loaded after root schema populated\" {file: \"resource://gre/modules/Schemas.jsm\" line: 3497}]\n    addSchema@resource://gre/modules/Schemas.jsm:3497:13\n    load@resource://gre/modules/Schemas.jsm:3528:12\n2020-04-17 19:17:21.264 26973-26973/org.mozilla.fenix.debug E/mozac-webextensions: Failed to query installed extension\n    java.lang.Exception: Unexpected error: TypeError: can't access property \"choices\", ns.get(...) is undefined\n        at org.mozilla.geckoview.CallbackResult.sendError(CallbackResult.java:14)\n        at org.mozilla.gecko.EventDispatcher$JavaCallbackDelegate$1.run(EventDispatcher.java:454)\n        at android.os.Handler.handleCallback(Handler.java:883)\n        at android.os.Handler.dispatchMessage(Handler.java:100)\n        at android.os.Looper.loop(Looper.java:214)\n        at android.app.ActivityThread.main(ActivityThread.java:7356)\n        at java.lang.reflect.Method.invoke(Native Method)\n        at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:492)\n        at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:930)\n2020-04-17 19:17:21.265 26973-26973/org.mozilla.fenix.debug E/mozac-webcompat: Failed to install WebCompat webextension: webcompat@mozilla.com\n    java.lang.Exception: An error occurred while registering the WebExtension resource://android/assets/extensions/webcompat/: Error: Schema loaded after root schema populated.\n        at org.mozilla.geckoview.CallbackResult.sendError(CallbackResult.java:14)\n        at org.mozilla.gecko.EventDispatcher$JavaCallbackDelegate$1.run(EventDispatcher.java:454)\n        at android.os.Handler.handleCallback(Handler.java:883)\n        at android.os.Handler.dispatchMessage(Handler.java:100)\n        at android.os.Looper.loop(Looper.java:214)\n        at android.app.ActivityThread.main(ActivityThread.java:7356)\n        at java.lang.reflect.Method.invoke(Native Method)\n        at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:492)\n        at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:930)\n2020-04-17 19:17:21.266 26973-26973/org.mozilla.fenix.debug E/App: Could not install browser-icons extension\n    java.lang.Exception: An error occurred while registering the WebExtension resource://android/assets/extensions/browser-icons/: Error: Schema loaded after root schema populated.\n        at org.mozilla.geckoview.CallbackResult.sendError(CallbackResult.java:14)\n        at org.mozilla.gecko.EventDispatcher$JavaCallbackDelegate$1.run(EventDispatcher.java:454)\n        at android.os.Handler.handleCallback(Handler.java:883)\n        at android.os.Handler.dispatchMessage(Handler.java:100)\n        at android.os.Looper.loop(Looper.java:214)\n        at android.app.ActivityThread.main(ActivityThread.java:7356)\n        at java.lang.reflect.Method.invoke(Native Method)\n        at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:492)\n        at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:930)\n```", "bug_id": 1631137, "id": 14762988, "creator": "amejiamarmol@mozilla.com", "raw_text": "Below the logcat after simulating the issue.\nWe are seeing this after disabling an add-on with `webExtensionController.disable` with `EnableSource#APP` and then restarting the app and trying to call  `runtime.webExtensionController.list()`. We tested using dark reader. Also Christian mentioned: the issue could be related to the schema migration. You migrate the schema the first time you need to, this may or may not finish before we call  `list `, when it doesn't finish in time `list` fails, but then the next startup is fine again because the schema was migrated.\n\n```\n2020-04-17 19:17:18.754 26973-26973/? E/lla.fenix.debu: Unknown bits set in runtime_flags: 0x8000\n2020-04-17 19:17:20.325 26973-27033/org.mozilla.fenix.debug E/GeckoLibLoad: Load sqlite start\n2020-04-17 19:17:20.328 26973-27033/org.mozilla.fenix.debug E/GeckoLibLoad: Load sqlite done\n2020-04-17 19:17:20.328 26973-27033/org.mozilla.fenix.debug E/GeckoLibLoad: Load nss start\n2020-04-17 19:17:20.328 26973-27033/org.mozilla.fenix.debug E/GeckoLibLoad: Load nss done\n2020-04-17 19:17:20.354 26973-27033/org.mozilla.fenix.debug E/GeckoLibLoad: Loaded libs in 25.111201ms total, 6ms(46ms) user, 13ms(13ms) system, 1(1) faults\n2020-04-17 19:17:21.134 26973-27061/org.mozilla.fenix.debug E/libc: Access denied finding property \"vendor.gralloc.disable_ahardware_buffer\"\n2020-04-17 19:17:21.230 26973-27033/org.mozilla.fenix.debug E/GeckoConsole: [JavaScript Error: \"Schema loaded after root schema populated\" {file: \"resource://gre/modules/Schemas.jsm\" line: 3497}]\n    addSchema@resource://gre/modules/Schemas.jsm:3497:13\n    load@resource://gre/modules/Schemas.jsm:3528:12\n2020-04-17 19:17:21.231 26973-27033/org.mozilla.fenix.debug E/GeckoConsole: [JavaScript Error: \"Schema loaded after root schema populated\" {file: \"resource://gre/modules/Schemas.jsm\" line: 3497}]\n    addSchema@resource://gre/modules/Schemas.jsm:3497:13\n    load@resource://gre/modules/Schemas.jsm:3528:12\n2020-04-17 19:17:21.231 26973-27033/org.mozilla.fenix.debug E/GeckoConsole: [JavaScript Error: \"Schema loaded after root schema populated\" {file: \"resource://gre/modules/Schemas.jsm\" line: 3497}]\n    addSchema@resource://gre/modules/Schemas.jsm:3497:13\n    load@resource://gre/modules/Schemas.jsm:3528:12\n2020-04-17 19:17:21.264 26973-26973/org.mozilla.fenix.debug E/mozac-webextensions: Failed to query installed extension\n    java.lang.Exception: Unexpected error: TypeError: can't access property \"choices\", ns.get(...) is undefined\n        at org.mozilla.geckoview.CallbackResult.sendError(CallbackResult.java:14)\n        at org.mozilla.gecko.EventDispatcher$JavaCallbackDelegate$1.run(EventDispatcher.java:454)\n        at android.os.Handler.handleCallback(Handler.java:883)\n        at android.os.Handler.dispatchMessage(Handler.java:100)\n        at android.os.Looper.loop(Looper.java:214)\n        at android.app.ActivityThread.main(ActivityThread.java:7356)\n        at java.lang.reflect.Method.invoke(Native Method)\n        at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:492)\n        at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:930)\n2020-04-17 19:17:21.265 26973-26973/org.mozilla.fenix.debug E/mozac-webcompat: Failed to install WebCompat webextension: webcompat@mozilla.com\n    java.lang.Exception: An error occurred while registering the WebExtension resource://android/assets/extensions/webcompat/: Error: Schema loaded after root schema populated.\n        at org.mozilla.geckoview.CallbackResult.sendError(CallbackResult.java:14)\n        at org.mozilla.gecko.EventDispatcher$JavaCallbackDelegate$1.run(EventDispatcher.java:454)\n        at android.os.Handler.handleCallback(Handler.java:883)\n        at android.os.Handler.dispatchMessage(Handler.java:100)\n        at android.os.Looper.loop(Looper.java:214)\n        at android.app.ActivityThread.main(ActivityThread.java:7356)\n        at java.lang.reflect.Method.invoke(Native Method)\n        at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:492)\n        at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:930)\n2020-04-17 19:17:21.266 26973-26973/org.mozilla.fenix.debug E/App: Could not install browser-icons extension\n    java.lang.Exception: An error occurred while registering the WebExtension resource://android/assets/extensions/browser-icons/: Error: Schema loaded after root schema populated.\n        at org.mozilla.geckoview.CallbackResult.sendError(CallbackResult.java:14)\n        at org.mozilla.gecko.EventDispatcher$JavaCallbackDelegate$1.run(EventDispatcher.java:454)\n        at android.os.Handler.handleCallback(Handler.java:883)\n        at android.os.Handler.dispatchMessage(Handler.java:100)\n        at android.os.Looper.loop(Looper.java:214)\n        at android.app.ActivityThread.main(ActivityThread.java:7356)\n        at java.lang.reflect.Method.invoke(Native Method)\n        at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:492)\n        at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:930)\n```", "time": "2020-04-17T23:49:39Z", "is_private": false, "count": 4}, {"bug_id": 1631137, "id": 14766595, "creator": "agi@sferro.dev", "raw_text": "", "time": "2020-04-20T14:49:25Z", "is_private": false, "count": 5, "attachment_id": 9141715, "author": "agi@sferro.dev", "tags": [], "text": "Created attachment 9141715\nBug 1631137 - Wait for Schema to be initialized in shouldPromptFor.", "creation_time": "2020-04-20T14:49:25Z"}, {"tags": [], "author": "agi@sferro.dev", "attachment_id": 9141889, "creator": "agi@sferro.dev", "id": 14767922, "bug_id": 1631137, "count": 6, "is_private": false, "time": "2020-04-20T23:12:49Z", "creation_time": "2020-04-20T23:12:49Z", "text": "Created attachment 9141889\nBug 1631137 - Add APP to EnableSources.", "raw_text": ""}, {"count": 7, "is_private": false, "time": "2020-04-21T03:32:44Z", "text": "This is really bad on nightly, I pretty much cannot use extensions now that I reproduced it.\n\nTo reproduce on Fenix\n\n* Have at least an extension installed\n* Disable all extensions (*NOT* uninstall)\n* restart the  browser\n* open addon manager\n\nafter a while you'll see an error going to the addon manager and all your addons cannot run anymore.", "creation_time": "2020-04-21T03:32:44Z", "raw_text": "This is really bad on nightly, I pretty much cannot use extensions now that I reproduced it.\n\nTo reproduce on Fenix\n\n* Have at least an extension installed\n* Disable all extensions (*NOT* uninstall)\n* restart the  browser\n* open addon manager\n\nafter a while you'll see an error going to the addon manager and all your addons cannot run anymore.", "tags": [], "author": "agi@sferro.dev", "attachment_id": null, "creator": "agi@sferro.dev", "id": 14768237, "bug_id": 1631137}, {"creator": "pulsebot@bots.tld", "id": 14769466, "bug_id": 1631137, "count": 8, "is_private": false, "time": "2020-04-21T16:18:40Z", "raw_text": "Pushed by asferro@mozilla.com:\nhttps://hg.mozilla.org/integration/autoland/rev/ae2354fc485e\nWait for Schema to be initialized in shouldPromptFor. r=esawin,mixedpuppy\nhttps://hg.mozilla.org/integration/autoland/rev/004dc47cf853\nAdd APP to EnableSources. r=esawin", "tags": [], "author": "pulsebot@bots.tld", "attachment_id": null, "creation_time": "2020-04-21T16:18:40Z", "text": "Pushed by asferro@mozilla.com:\nhttps://hg.mozilla.org/integration/autoland/rev/ae2354fc485e\nWait for Schema to be initialized in shouldPromptFor. r=esawin,mixedpuppy\nhttps://hg.mozilla.org/integration/autoland/rev/004dc47cf853\nAdd APP to EnableSources. r=esawin"}, {"is_private": false, "time": "2020-04-22T04:17:59Z", "creation_time": "2020-04-22T04:17:59Z", "text": "https://hg.mozilla.org/mozilla-central/rev/ae2354fc485e\nhttps://hg.mozilla.org/mozilla-central/rev/004dc47cf853", "raw_text": "https://hg.mozilla.org/mozilla-central/rev/ae2354fc485e\nhttps://hg.mozilla.org/mozilla-central/rev/004dc47cf853", "count": 9, "id": 14770888, "bug_id": 1631137, "tags": ["bugherder"], "author": "aiakab@mozilla.com", "attachment_id": null, "creator": "aiakab@mozilla.com"}]}}}