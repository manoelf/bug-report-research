{"bugs": {"644201": {"comments": [{"id": 5362808, "attachment_id": null, "creator": "kaie@kuix.de", "text": "I try this:\n- open cert manager\n- authorities tab\n- click any CA, e.g. I tried \"AddTrust External CA\"\n- click \"edit trust\"\n- disable all checkboxes\n- click OK\n\nactual behaviour:\n- nothing happens\n- dialog remains open\n- trust is not stored\n\nThis happens only with one cert9.db file.\nThis cert9.db file is quite old, but I use it daily.\nIt belongs to my primary Firefox profile for work purposes.\nIt has been migrated from old profiles long ago.\nI have been using it in a shared configuration with Thunderbird.\n\nI traced through NSS in order to find the point of failure.\n\n\n#0  import_object (tok=0xa5618018, sessionOpt=0x0, objectTemplate=0xbfff782c, otsize=11) at devtoken.c:246\n#1  0x0396dc38 in nssToken_ImportTrust (tok=0xa5618018, sessionOpt=0x0, certEncoding=0xa2b660a8, certIssuer=0xa2b660b0, certSerial=0xa2b660c0, serverAuth=nssTrustLevel_ValidDelegator, clientAuth=nssTrustLevel_ValidDelegator, codeSigning=\n    nssTrustLevel_ValidDelegator, emailProtection=nssTrustLevel_ValidDelegator, stepUpApproved=0, asTokenObject=1) at devtoken.c:1143\n#2  0x0396aed6 in STAN_ChangeCertTrust (cc=0xa26bc010, trust=0xbfff79f8) at pki3hack.c:1165\n#3  0x0395b50d in CERT_ChangeCertTrust (handle=0xa5614018, cert=0xa26bc010, trust=0xbfff79f8) at stanpcertdb.c:261\n#4  0x01f16589 in nsNSSCertificateDB::SetCertTrust (this=0xa2ea7710, cert=0xa28f7580, type=1, trusted=0) at /plaindata/moz/mocent/mozilla/security/manager/ssl/src/nsNSSCertificateDB.cpp:1028\n\n\n241         if (session == NULL) {\n242             nss_SetError(NSS_ERROR_INVALID_ARGUMENT);\n243             return NULL;\n244         }\n245         nssSession_EnterMonitor(session);\n246         ckrv = CKAPI(epv)->C_CreateObject(session->handle, \n247                                           objectTemplate, otsize,\n248                                           &handle);\n249         nssSession_ExitMonitor(session);\n250         if (ckrv == CKR_OK) {\n\n\nafter line 246\n\n(gdb) print ckrv\n$25 = 257\n\n=> return null, failure\n\n\ncert9.db and key4.db have both read/write permissions.\n\nFWIW, I am able to make other changes to the database, e.g. removing certificates.\n\n\nIn preparation to give you my cert9.db file for testing purposes,\nI've removed all non-CA certs from the database using cert manager.", "author": "kaie@kuix.de", "creation_time": "2011-03-23T16:47:19Z", "time": "2011-03-23T16:47:19Z", "is_private": false, "tags": [], "raw_text": "I try this:\n- open cert manager\n- authorities tab\n- click any CA, e.g. I tried \"AddTrust External CA\"\n- click \"edit trust\"\n- disable all checkboxes\n- click OK\n\nactual behaviour:\n- nothing happens\n- dialog remains open\n- trust is not stored\n\nThis happens only with one cert9.db file.\nThis cert9.db file is quite old, but I use it daily.\nIt belongs to my primary Firefox profile for work purposes.\nIt has been migrated from old profiles long ago.\nI have been using it in a shared configuration with Thunderbird.\n\nI traced through NSS in order to find the point of failure.\n\n\n#0  import_object (tok=0xa5618018, sessionOpt=0x0, objectTemplate=0xbfff782c, otsize=11) at devtoken.c:246\n#1  0x0396dc38 in nssToken_ImportTrust (tok=0xa5618018, sessionOpt=0x0, certEncoding=0xa2b660a8, certIssuer=0xa2b660b0, certSerial=0xa2b660c0, serverAuth=nssTrustLevel_ValidDelegator, clientAuth=nssTrustLevel_ValidDelegator, codeSigning=\n    nssTrustLevel_ValidDelegator, emailProtection=nssTrustLevel_ValidDelegator, stepUpApproved=0, asTokenObject=1) at devtoken.c:1143\n#2  0x0396aed6 in STAN_ChangeCertTrust (cc=0xa26bc010, trust=0xbfff79f8) at pki3hack.c:1165\n#3  0x0395b50d in CERT_ChangeCertTrust (handle=0xa5614018, cert=0xa26bc010, trust=0xbfff79f8) at stanpcertdb.c:261\n#4  0x01f16589 in nsNSSCertificateDB::SetCertTrust (this=0xa2ea7710, cert=0xa28f7580, type=1, trusted=0) at /plaindata/moz/mocent/mozilla/security/manager/ssl/src/nsNSSCertificateDB.cpp:1028\n\n\n241         if (session == NULL) {\n242             nss_SetError(NSS_ERROR_INVALID_ARGUMENT);\n243             return NULL;\n244         }\n245         nssSession_EnterMonitor(session);\n246         ckrv = CKAPI(epv)->C_CreateObject(session->handle, \n247                                           objectTemplate, otsize,\n248                                           &handle);\n249         nssSession_ExitMonitor(session);\n250         if (ckrv == CKR_OK) {\n\n\nafter line 246\n\n(gdb) print ckrv\n$25 = 257\n\n=> return null, failure\n\n\ncert9.db and key4.db have both read/write permissions.\n\nFWIW, I am able to make other changes to the database, e.g. removing certificates.\n\n\nIn preparation to give you my cert9.db file for testing purposes,\nI've removed all non-CA certs from the database using cert manager.", "bug_id": 644201, "count": 0}, {"count": 1, "bug_id": 644201, "raw_text": "$25 = 257 = 0x101 = User not logged in.\n\nIn the new database you can't change the trust if you aren't logged in. Did PSM get a 'not logged in' failure? certutil now prompts for a password if it get's this error when dealing with the certdb.\n\nbob", "tags": [], "is_private": false, "time": "2011-03-23T18:48:45Z", "creation_time": "2011-03-23T18:48:45Z", "author": "rrelyea@redhat.com", "creator": "rrelyea@redhat.com", "text": "$25 = 257 = 0x101 = User not logged in.\n\nIn the new database you can't change the trust if you aren't logged in. Did PSM get a 'not logged in' failure? certutil now prompts for a password if it get's this error when dealing with the certdb.\n\nbob", "id": 5363307, "attachment_id": null}, {"author": "kaie@kuix.de", "text": "(In reply to comment #1)\n> $25 = 257 = 0x101 = User not logged in.\n> \n> In the new database you can't change the trust if you aren't logged in.\n\nI didn't know about this new requirement!\n\nI confirm that Master password set + logged in => works\n\nHowever: Database without master password => does not work.\n\n\n> Did PSM get a 'not logged in' failure?\n\nI haven't seen anything.\nHow would you expect this to be reported from NSS to PSM?\n\nIf NSS requires that we're logged in,\nshouldn't NSS trigger the \"authentication callback\"\nthat would bring up the prompt to login ?", "creator": "kaie@kuix.de", "attachment_id": null, "id": 5370388, "creation_time": "2011-03-25T20:10:23Z", "tags": [], "is_private": false, "time": "2011-03-25T20:10:23Z", "count": 2, "bug_id": 644201, "raw_text": "(In reply to comment #1)\n> $25 = 257 = 0x101 = User not logged in.\n> \n> In the new database you can't change the trust if you aren't logged in.\n\nI didn't know about this new requirement!\n\nI confirm that Master password set + logged in => works\n\nHowever: Database without master password => does not work.\n\n\n> Did PSM get a 'not logged in' failure?\n\nI haven't seen anything.\nHow would you expect this to be reported from NSS to PSM?\n\nIf NSS requires that we're logged in,\nshouldn't NSS trigger the \"authentication callback\"\nthat would bring up the prompt to login ?"}, {"creator": "kaie@kuix.de", "author": "kaie@kuix.de", "time": "2011-03-27T12:49:50Z", "bug_id": 644201, "count": 3, "attachment_id": 522191, "id": 5372704, "text": "Created attachment 522191\npsm test patch\n\nBob, I made this quick patch for PSM with the following change:\n\nPrior to calling CERT_ChangeCertTrust, \ncheck if login is needed.\nIf needed, call PK11_Authenticate.\n\nFor \"check if login is needed\", I copied existing code from another PSM function.\n\n\nHowever, the patch does not help to fix this bug.", "creation_time": "2011-03-27T12:49:50Z", "is_private": false, "tags": [], "raw_text": "Bob, I made this quick patch for PSM with the following change:\n\nPrior to calling CERT_ChangeCertTrust, \ncheck if login is needed.\nIf needed, call PK11_Authenticate.\n\nFor \"check if login is needed\", I copied existing code from another PSM function.\n\n\nHowever, the patch does not help to fix this bug."}]}}, "comments": {}}