{"comments": {}, "bugs": {"649029": {"comments": [{"attachment_id": null, "time": "2011-04-11T16:41:08Z", "is_private": false, "author": "mh+mozilla@glandium.org", "bug_id": 649029, "count": 0, "creator": "mh+mozilla@glandium.org", "tags": [], "text": "I've modified the about:startup extension to use a jsm module and register a resource:// url so that some things can be shared between the bootstrap code and the about:startup page itself. It turns out when upgrading the extension between revisions having a jsm module, the old version is always used, because it is kept in startup cache. The only way to make it get the new version is to stop Firefox, remove the startup cache and start Firefox again.", "creation_time": "2011-04-11T16:41:08Z", "raw_text": "I've modified the about:startup extension to use a jsm module and register a resource:// url so that some things can be shared between the bootstrap code and the about:startup page itself. It turns out when upgrading the extension between revisions having a jsm module, the old version is always used, because it is kept in startup cache. The only way to make it get the new version is to stop Firefox, remove the startup cache and start Firefox again.", "id": 5400580}, {"creation_time": "2011-04-11T16:52:33Z", "is_private": false, "text": "Since we don't implement per-resource validation (and don't want to), it sounds like we should remove the startup cache when an extension is installed or removed. Mossop, does this sound reasonable?", "id": 5400627, "raw_text": "Since we don't implement per-resource validation (and don't want to), it sounds like we should remove the startup cache when an extension is installed or removed. Mossop, does this sound reasonable?", "count": 1, "time": "2011-04-11T16:52:33Z", "tags": [], "creator": "benjamin@smedbergs.us", "bug_id": 649029, "attachment_id": null, "author": "benjamin@smedbergs.us"}, {"creation_time": "2011-04-11T17:01:46Z", "is_private": false, "text": "We should already be doing this in the extension manager (by dispatching the observer notification \"startupcache-invalidate\"), so if that isn't happening then it's a bug.", "id": 5400666, "raw_text": "We should already be doing this in the extension manager (by dispatching the observer notification \"startupcache-invalidate\"), so if that isn't happening then it's a bug.", "creator": "dtownsend@mozilla.com", "tags": [], "count": 2, "time": "2011-04-11T17:01:46Z", "bug_id": 649029, "attachment_id": null, "author": "dtownsend@mozilla.com"}, {"is_private": false, "time": "2011-04-11T17:07:32Z", "attachment_id": null, "text": "Note that currently, the path used in startup cache for that extension is jsloader/resource/aboutstartup/startupdata.jsm.bin.\nWith bug 620931, it would use the resolved path to construct the startup cache path, e.g. jsloader/home/mh/.mozilla/firefox/g7i9o0v9.4.0/extensions/aboutstartup@glandium.org.xpi/startupdata.jsm.bin, which makes it easier to filter if we want to remove only them.", "creation_time": "2011-04-11T17:07:32Z", "raw_text": "Note that currently, the path used in startup cache for that extension is jsloader/resource/aboutstartup/startupdata.jsm.bin.\nWith bug 620931, it would use the resolved path to construct the startup cache path, e.g. jsloader/home/mh/.mozilla/firefox/g7i9o0v9.4.0/extensions/aboutstartup@glandium.org.xpi/startupdata.jsm.bin, which makes it easier to filter if we want to remove only them.", "id": 5400686, "bug_id": 649029, "creator": "mh+mozilla@glandium.org", "tags": [], "count": 3, "author": "mh+mozilla@glandium.org"}, {"text": "(In reply to comment #2)\n> We should already be doing this in the extension manager (by dispatching the\n> observer notification \"startupcache-invalidate\"), so if that isn't happening\n> then it's a bug.\n\nFWIW, it is a restart-less extension, maybe that's why it doesn't happen?", "is_private": false, "creation_time": "2011-04-11T17:08:06Z", "raw_text": "(In reply to comment #2)\n> We should already be doing this in the extension manager (by dispatching the\n> observer notification \"startupcache-invalidate\"), so if that isn't happening\n> then it's a bug.\n\nFWIW, it is a restart-less extension, maybe that's why it doesn't happen?", "id": 5400689, "bug_id": 649029, "creator": "mh+mozilla@glandium.org", "count": 4, "time": "2011-04-11T17:08:06Z", "tags": [], "author": "mh+mozilla@glandium.org", "attachment_id": null}, {"attachment_id": null, "is_private": false, "time": "2011-04-11T17:19:58Z", "author": "dtownsend@mozilla.com", "id": 5400747, "raw_text": "Oh, I don't think this is anything to do with the startup cache them, the scopes loaded from JS modules are cached in mozJSComponentLoader and at the moment can only be unloaded on shutdown. Any attempt to retrieve a module with the same URL will give you back the same scope. A potential solution is in bug 481603", "creation_time": "2011-04-11T17:19:58Z", "text": "Oh, I don't think this is anything to do with the startup cache them, the scopes loaded from JS modules are cached in mozJSComponentLoader and at the moment can only be unloaded on shutdown. Any attempt to retrieve a module with the same URL will give you back the same scope. A potential solution is in bug 481603", "count": 5, "tags": [], "creator": "dtownsend@mozilla.com", "bug_id": 649029}, {"bug_id": 649029, "creator": "dtownsend@mozilla.com", "tags": [], "count": 6, "raw_text": "Though I guess it looks like we don't invalidate the startup cache for restartless extensions either, so looks like we have two problems!", "id": 5400752, "text": "Though I guess it looks like we don't invalidate the startup cache for restartless extensions either, so looks like we have two problems!", "creation_time": "2011-04-11T17:20:56Z", "author": "dtownsend@mozilla.com", "time": "2011-04-11T17:20:56Z", "is_private": false, "attachment_id": null}, {"author": "ben.bucksch@beonex.com", "bug_id": 649029, "count": 7, "tags": [], "creator": "ben.bucksch@beonex.com", "raw_text": "mossop, was your comment 5 resolved by the fix in bug 481603?\nIf so, can you change the summary of this bug to \"...never invalidates restart-less extensions\", please?", "id": 5879470, "text": "mossop, was your comment 5 resolved by the fix in bug 481603?\nIf so, can you change the summary of this bug to \"...never invalidates restart-less extensions\", please?", "creation_time": "2011-11-29T19:17:09Z", "attachment_id": null, "time": "2011-11-29T19:17:09Z", "is_private": false}, {"attachment_id": null, "is_private": false, "time": "2011-11-29T19:28:10Z", "author": "dtownsend@mozilla.com", "creation_time": "2011-11-29T19:28:10Z", "text": "(In reply to Ben Bucksch (:BenB) from comment #7)\n> mossop, was your comment 5 resolved by the fix in bug 481603?\n> If so, can you change the summary of this bug to \"...never invalidates\n> restart-less extensions\", please?\n\nCurrently the restartless extension still has to manually call Components.utils.unload for all their JS modules, nothing automatic has changed here.", "id": 5879505, "raw_text": "(In reply to Ben Bucksch (:BenB) from comment #7)\n> mossop, was your comment 5 resolved by the fix in bug 481603?\n> If so, can you change the summary of this bug to \"...never invalidates\n> restart-less extensions\", please?\n\nCurrently the restartless extension still has to manually call Components.utils.unload for all their JS modules, nothing automatic has changed here.", "tags": [], "count": 8, "creator": "dtownsend@mozilla.com", "bug_id": 649029}, {"author": "dtownsend@mozilla.com", "bug_id": 649029, "tags": [], "creator": "dtownsend@mozilla.com", "count": 9, "text": "Really we are talking about JS modules, not about the startup cache here. We could in theory know which resource URIs an add-on registered and so automatically unload any JS modules that way, I'm not sure this is something worth spending time on though.", "creation_time": "2011-11-29T19:43:48Z", "raw_text": "Really we are talking about JS modules, not about the startup cache here. We could in theory know which resource URIs an add-on registered and so automatically unload any JS modules that way, I'm not sure this is something worth spending time on though.", "id": 5879560, "attachment_id": null, "time": "2011-11-29T19:43:48Z", "is_private": false}, {"attachment_id": null, "is_private": false, "time": "2011-11-29T19:58:06Z", "author": "ben.bucksch@beonex.com", "raw_text": "(In reply to Dave Townsend (:Mossop) from comment #6)\n> Though I guess it looks like we don't invalidate the startup cache for\n> restartless extensions either, so looks like we have two problems!\n\nI guess this should be a different bug, then?\n\n> I'm not sure this is something worth spending time on though.\n\nI think it's better to solve this once in the platform then to let each ext dev run into this (many of them the hard way), and each of them having to work around it with custom code.", "id": 5879614, "text": "(In reply to Dave Townsend (:Mossop) from comment #6)\n> Though I guess it looks like we don't invalidate the startup cache for\n> restartless extensions either, so looks like we have two problems!\n\nI guess this should be a different bug, then?\n\n> I'm not sure this is something worth spending time on though.\n\nI think it's better to solve this once in the platform then to let each ext dev run into this (many of them the hard way), and each of them having to work around it with custom code.", "creation_time": "2011-11-29T19:58:06Z", "bug_id": 649029, "creator": "ben.bucksch@beonex.com", "tags": [], "count": 10}, {"attachment_id": null, "author": "dtownsend@mozilla.com", "creator": "dtownsend@mozilla.com", "time": "2011-11-29T20:08:06Z", "count": 11, "tags": [], "bug_id": 649029, "creation_time": "2011-11-29T20:08:06Z", "is_private": false, "text": "(In reply to Ben Bucksch (:BenB) from comment #10)\n> (In reply to Dave Townsend (:Mossop) from comment #6)\n> > Though I guess it looks like we don't invalidate the startup cache for\n> > restartless extensions either, so looks like we have two problems!\n> \n> I guess this should be a different bug, then?\n\nThis bug was always about JS modules not getting unloaded, it was just mis-diagnosed as being a startupcache problem.\n\n> > I'm not sure this is something worth spending time on though.\n> \n> I think it's better to solve this once in the platform then to let each ext\n> dev run into this (many of them the hard way), and each of them having to\n> work around it with custom code.\n\nIf it was straightforward to do then I agree, but it isn't.", "id": 5879643, "raw_text": "(In reply to Ben Bucksch (:BenB) from comment #10)\n> (In reply to Dave Townsend (:Mossop) from comment #6)\n> > Though I guess it looks like we don't invalidate the startup cache for\n> > restartless extensions either, so looks like we have two problems!\n> \n> I guess this should be a different bug, then?\n\nThis bug was always about JS modules not getting unloaded, it was just mis-diagnosed as being a startupcache problem.\n\n> > I'm not sure this is something worth spending time on though.\n> \n> I think it's better to solve this once in the platform then to let each ext\n> dev run into this (many of them the hard way), and each of them having to\n> work around it with custom code.\n\nIf it was straightforward to do then I agree, but it isn't."}]}}}