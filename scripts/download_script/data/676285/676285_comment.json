{"comments": {}, "bugs": {"676285": {"comments": [{"tags": [], "raw_text": "Right now if we suspend a worker whose close handler has started it may live until shutdown. I think this is only possible when dom.max_script_run_time is set to 0, but unfortunately that's what the mochitest harness does. This means that closeOnGC_worker.js lives until the test harness shuts down.\n\nThe attached patch simply prevents workers whose close handlers have started from being suspended.", "attachment_id": 550411, "time": "2011-08-03T16:47:38Z", "is_private": false, "creation_time": "2011-08-03T16:47:38Z", "bug_id": 676285, "id": 5630694, "count": 0, "text": "Created attachment 550411\nPatch, v1\n\nRight now if we suspend a worker whose close handler has started it may live until shutdown. I think this is only possible when dom.max_script_run_time is set to 0, but unfortunately that's what the mochitest harness does. This means that closeOnGC_worker.js lives until the test harness shuts down.\n\nThe attached patch simply prevents workers whose close handlers have started from being suspended.", "author": "bent.mozilla@gmail.com", "creator": "bent.mozilla@gmail.com"}, {"raw_text": "Oops, this is the right patch.", "attachment_id": 550412, "time": "2011-08-03T16:50:28Z", "tags": [], "text": "Created attachment 550412\nPatch, v1\n\nOops, this is the right patch.", "count": 1, "author": "bent.mozilla@gmail.com", "creator": "bent.mozilla@gmail.com", "creation_time": "2011-08-03T16:50:28Z", "is_private": false, "id": 5630701, "bug_id": 676285}, {"creator": "jonas@sicking.cc", "author": "jonas@sicking.cc", "count": 2, "text": "I don't understand this.\n\nSuspend happens when a page is going into bfcache, right?\n\nWith this patch, what happens if the following events occur:\n\n1. Worker is started\n2. Worker calls .close() from the inside which means that it's free to run\n   as long as it wants.\n3. User navigates to a different site.\n\nWon't this mean that the script in the close handler continues to run even though the user has left the page? That seems bad, no?", "bug_id": 676285, "id": 5632282, "is_private": false, "creation_time": "2011-08-04T03:35:07Z", "time": "2011-08-04T03:35:07Z", "attachment_id": null, "raw_text": "I don't understand this.\n\nSuspend happens when a page is going into bfcache, right?\n\nWith this patch, what happens if the following events occur:\n\n1. Worker is started\n2. Worker calls .close() from the inside which means that it's free to run\n   as long as it wants.\n3. User navigates to a different site.\n\nWon't this mean that the script in the close handler continues to run even though the user has left the page? That seems bad, no?", "tags": []}, {"attachment_id": 550412, "raw_text": "Based on discussions with Ben, my understanding is that we don't want to do anything for this bug.\n\nThe way it should work (if I recall correctly) is:\n\nIf the close handler has started when a page enters BF cache, suspend the worker and the running close handler.\n\nWhen a page is kicked out of bf-cache, if the closer handler has started already, let it keep running for another X seconds. If the close handler has not started, throw an uncatchable exception and then run the close handler for a max of X seconds.", "time": "2011-09-19T21:24:13Z", "tags": [], "author": "jonas@sicking.cc", "text": "Comment on attachment 550412\nPatch, v1\n\nBased on discussions with Ben, my understanding is that we don't want to do anything for this bug.\n\nThe way it should work (if I recall correctly) is:\n\nIf the close handler has started when a page enters BF cache, suspend the worker and the running close handler.\n\nWhen a page is kicked out of bf-cache, if the closer handler has started already, let it keep running for another X seconds. If the close handler has not started, throw an uncatchable exception and then run the close handler for a max of X seconds.", "count": 3, "creator": "jonas@sicking.cc", "creation_time": "2011-09-19T21:24:13Z", "is_private": false, "bug_id": 676285, "id": 5724026}]}}}