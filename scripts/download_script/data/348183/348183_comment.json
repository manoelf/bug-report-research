{"comments": {}, "bugs": {"348183": {"comments": [{"is_private": false, "raw_text": "scenario where clicking cancel in the \"closing window with <n> tabs open\" prompt closes the window, instead of keeing it open\n\nthis may be related to bug #331457 or bug #327139\n\nsteps to reproduce aren't perfect, but I am able to reproduce this.\n\n1)  quickly open many tabs at once, using ctrl t\n2)  hit the close [x] on the window\n3)  get the confirm to close window with open tabs prompt\n4)  hit cancel\n\nexpected results:  window does not close\nactual results:    window closes\n\nin my console I see:\n\nJavaScript error: , line 0: uncaught exception: [Exception... \"Component returne\nd failure code: 0x80004005 (NS_ERROR_FAILURE) [nsIDOMWindowInternal.focus]\"  nsr\nesult: \"0x80004005 (NS_ERROR_FAILURE)\"  location: \"JS frame :: chrome://global/c\nontent/bindings/tabbrowser.xml :: setFocus :: line 773\"  data: no]\n\nit is coming from the elemet.focus() call in setFocus() in browser.xml\n\n  function setFocus(element) {\n    document.commandDispatcher.suppressFocusScroll = true;\n\n    if (element instanceof Window ||\n        element instanceof NSHTMLElement ||\n        element instanceof XULElement) {\n        element.focus();\n    }\n    document.commandDispatcher.suppressFocusScroll = false;\n  }\n\ngavin, perhaps we should wrap that call to focus with a try / catch in addition to figuring out why it is failing?", "creator": "moco@sspitzer.org", "attachment_id": null, "creation_time": "2006-08-10T09:26:38Z", "time": "2006-08-10T09:26:38Z", "author": "moco@sspitzer.org", "text": "scenario where clicking cancel in the \"closing window with <n> tabs open\" prompt closes the window, instead of keeing it open\n\nthis may be related to bug #331457 or bug #327139\n\nsteps to reproduce aren't perfect, but I am able to reproduce this.\n\n1)  quickly open many tabs at once, using ctrl t\n2)  hit the close [x] on the window\n3)  get the confirm to close window with open tabs prompt\n4)  hit cancel\n\nexpected results:  window does not close\nactual results:    window closes\n\nin my console I see:\n\nJavaScript error: , line 0: uncaught exception: [Exception... \"Component returne\nd failure code: 0x80004005 (NS_ERROR_FAILURE) [nsIDOMWindowInternal.focus]\"  nsr\nesult: \"0x80004005 (NS_ERROR_FAILURE)\"  location: \"JS frame :: chrome://global/c\nontent/bindings/tabbrowser.xml :: setFocus :: line 773\"  data: no]\n\nit is coming from the elemet.focus() call in setFocus() in browser.xml\n\n  function setFocus(element) {\n    document.commandDispatcher.suppressFocusScroll = true;\n\n    if (element instanceof Window ||\n        element instanceof NSHTMLElement ||\n        element instanceof XULElement) {\n        element.focus();\n    }\n    document.commandDispatcher.suppressFocusScroll = false;\n  }\n\ngavin, perhaps we should wrap that call to focus with a try / catch in addition to figuring out why it is failing?", "tags": [], "bug_id": 348183, "count": 0, "id": 2940477}, {"bug_id": 348183, "tags": [], "text": "> it is coming from the elemet.focus() call in setFocus() in browser.xml\n\nI meant tabbrowser.xml, not browser.xml", "author": "moco@sspitzer.org", "id": 2940478, "count": 1, "is_private": false, "creation_time": "2006-08-10T09:27:46Z", "time": "2006-08-10T09:27:46Z", "creator": "moco@sspitzer.org", "attachment_id": null, "raw_text": "> it is coming from the elemet.focus() call in setFocus() in browser.xml\n\nI meant tabbrowser.xml, not browser.xml"}, {"raw_text": "WARNING: Should not try to set the focus on a disabled window, file c:/builds/bo\nnecho/mozilla/dom/src/base/nsGlobalWindow.cpp, line 3539\n\nfrom http://lxr.mozilla.org/mozilla1.8/source/dom/src/base/nsGlobalWindow.cpp#3539\n\n3534   nsCOMPtr<nsIBaseWindow> treeOwnerAsWin;\n3535   GetTreeOwner(getter_AddRefs(treeOwnerAsWin));\n3536   if (treeOwnerAsWin && (canFocus || isActive)) {\n3537     PRBool isEnabled = PR_TRUE;\n3538     if (NS_SUCCEEDED(treeOwnerAsWin->GetEnabled(&isEnabled)) && !isEnabled) {\n3539       NS_WARNING( \"Should not try to set the focus on a disabled window\" );\n3540       return NS_ERROR_FAILURE;\n3541     }\n\nI think that error is bubbling up, throwing an exception, and is causing this (and possible other problems).\n\nnote, this code comes from jfd's fix for bug #109081 (back in 2002).\n\nI'm not sure if this really is a regression, but I'm going to call it one.\n\nI think that for starters, we should wrap the call to .focus with a try / catch, and then work backwards to figure out why the element disabled (and if that is OK or not.)\n", "creator": "moco@sspitzer.org", "attachment_id": null, "creation_time": "2006-08-10T09:41:02Z", "time": "2006-08-10T09:41:02Z", "is_private": false, "count": 2, "id": 2940484, "author": "moco@sspitzer.org", "text": "WARNING: Should not try to set the focus on a disabled window, file c:/builds/bo\nnecho/mozilla/dom/src/base/nsGlobalWindow.cpp, line 3539\n\nfrom http://lxr.mozilla.org/mozilla1.8/source/dom/src/base/nsGlobalWindow.cpp#3539\n\n3534   nsCOMPtr<nsIBaseWindow> treeOwnerAsWin;\n3535   GetTreeOwner(getter_AddRefs(treeOwnerAsWin));\n3536   if (treeOwnerAsWin && (canFocus || isActive)) {\n3537     PRBool isEnabled = PR_TRUE;\n3538     if (NS_SUCCEEDED(treeOwnerAsWin->GetEnabled(&isEnabled)) && !isEnabled) {\n3539       NS_WARNING( \"Should not try to set the focus on a disabled window\" );\n3540       return NS_ERROR_FAILURE;\n3541     }\n\nI think that error is bubbling up, throwing an exception, and is causing this (and possible other problems).\n\nnote, this code comes from jfd's fix for bug #109081 (back in 2002).\n\nI'm not sure if this really is a regression, but I'm going to call it one.\n\nI think that for starters, we should wrap the call to .focus with a try / catch, and then work backwards to figure out why the element disabled (and if that is OK or not.)\n", "tags": [], "bug_id": 348183}, {"id": 2940513, "count": 3, "bug_id": 348183, "tags": [], "text": "Created attachment 233066\npatch?\n\nWhat Seth mentioned in comment 2 is indeed the cause of the bug.\nFor some reason, I can't reproduce this on trunk.\nIt seems to me that could should just return NS_OK to silently fail, not?\nThat's also what is happening somewhere up in the code.\nhttp://lxr.mozilla.org/seamonkey/source/dom/src/base/nsGlobalWindow.cpp#3495", "author": "martijn.martijn@gmail.com", "time": "2006-08-10T10:32:28Z", "creation_time": "2006-08-10T10:32:28Z", "attachment_id": 233066, "creator": "martijn.martijn@gmail.com", "raw_text": "What Seth mentioned in comment 2 is indeed the cause of the bug.\nFor some reason, I can't reproduce this on trunk.\nIt seems to me that could should just return NS_OK to silently fail, not?\nThat's also what is happening somewhere up in the code.\nhttp://lxr.mozilla.org/seamonkey/source/dom/src/base/nsGlobalWindow.cpp#3495", "is_private": false}, {"creator": "moco@sspitzer.org", "attachment_id": null, "raw_text": "> For some reason, I can't reproduce this on trunk.\n\nI am on \"Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.1b1) Gecko/20060809 BonEcho/2.0b1\", my own debug build.\n\n> It seems to me that could should just return NS_OK to silently fail, not?\n\nthat seems reasonable, but it makes me a little nervous until we check what all the callers (firefox, tbird and seamonkey) are expecting.\n\nI think we should also figure out which disabled element(s) we are trying to focus.\n\nI think we should do something for ff2 here, so asking for blocking.", "id": 2940728, "creation_time": "2006-08-10T16:23:05Z", "time": "2006-08-10T16:23:05Z", "count": 4, "text": "> For some reason, I can't reproduce this on trunk.\n\nI am on \"Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.1b1) Gecko/20060809 BonEcho/2.0b1\", my own debug build.\n\n> It seems to me that could should just return NS_OK to silently fail, not?\n\nthat seems reasonable, but it makes me a little nervous until we check what all the callers (firefox, tbird and seamonkey) are expecting.\n\nI think we should also figure out which disabled element(s) we are trying to focus.\n\nI think we should do something for ff2 here, so asking for blocking.", "author": "moco@sspitzer.org", "bug_id": 348183, "tags": [], "is_private": false}, {"is_private": false, "time": "2006-08-10T17:34:32Z", "creation_time": "2006-08-10T17:34:32Z", "raw_text": "", "attachment_id": 233097, "creator": "moco@sspitzer.org", "tags": [], "bug_id": 348183, "author": "moco@sspitzer.org", "text": "Created attachment 233097\nalternative, low-risk patch for the branch until everything is sorted out", "count": 5, "id": 2940797}, {"count": 6, "id": 2940805, "creation_time": "2006-08-10T17:38:48Z", "time": "2006-08-10T17:38:48Z", "raw_text": "Blocking due to the dataloss issue.", "creator": "mbeltzner@gmail.com", "attachment_id": null, "is_private": false, "tags": [], "bug_id": 348183, "author": "mbeltzner@gmail.com", "text": "Blocking due to the dataloss issue."}, {"text": "Comment on attachment 233066\npatch?\n\nMoving request over to someone who's not on vacation :)", "author": "mbeltzner@gmail.com", "bug_id": 348183, "tags": [], "id": 2940807, "count": 7, "is_private": false, "attachment_id": 233066, "creator": "mbeltzner@gmail.com", "raw_text": "Moving request over to someone who's not on vacation :)", "time": "2006-08-10T17:39:58Z", "creation_time": "2006-08-10T17:39:58Z"}, {"author": "moco@sspitzer.org", "text": "Comment on attachment 233097\nalternative, low-risk patch for the branch until everything is sorted out\n\nI'm still nervous about changing nsGlobalWindow.cpp until we audit the callers.\n\nmconnor / bryner, what do you think of my alernative patch?", "is_private": false, "tags": [], "bug_id": 348183, "raw_text": "I'm still nervous about changing nsGlobalWindow.cpp until we audit the callers.\n\nmconnor / bryner, what do you think of my alernative patch?", "attachment_id": 233097, "creator": "moco@sspitzer.org", "count": 8, "time": "2006-08-10T17:52:54Z", "id": 2940832, "creation_time": "2006-08-10T17:52:54Z"}, {"id": 2940883, "count": 9, "text": "(In reply to comment #8)\n> (From update of attachment 233097 [edit])\n> I'm still nervous about changing nsGlobalWindow.cpp until we audit the callers.\n> \n> mconnor / bryner, what do you think of my alernative patch?\n> \n\nI agree, especially at this stage of FF2 development.  It sounds like what's happening here is that the window is disabled, which happens when a modal dialog is shown, when the setFocus timeout runs.  Catching the exception seems reasonable, though it's unfortunate that focus won't actually end up in the right place (well, you could poke at the commandDispatcher, maybe...)\n", "author": "bryner@gmail.com", "bug_id": 348183, "tags": [], "attachment_id": null, "creator": "bryner@gmail.com", "raw_text": "(In reply to comment #8)\n> (From update of attachment 233097 [edit])\n> I'm still nervous about changing nsGlobalWindow.cpp until we audit the callers.\n> \n> mconnor / bryner, what do you think of my alernative patch?\n> \n\nI agree, especially at this stage of FF2 development.  It sounds like what's happening here is that the window is disabled, which happens when a modal dialog is shown, when the setFocus timeout runs.  Catching the exception seems reasonable, though it's unfortunate that focus won't actually end up in the right place (well, you could poke at the commandDispatcher, maybe...)\n", "time": "2006-08-10T18:32:32Z", "creation_time": "2006-08-10T18:32:32Z", "is_private": false}, {"bug_id": 348183, "tags": [], "text": "> For some reason, I can't reproduce this on trunk.\n\nme neither, but I'd still like to land my patch on trunk and branch, until we decide to make focus() not return failure.\n\n> I agree, especially at this stage of FF2 development.\n\nthanks brian (and thanks for the review.)  I'll land on trunk (and then seek approval for the branch.)\n\nI'll log a new bug about removing my try / catch, and/or fixing the nsGlobalWindow.cpp code, per martijn's patch.", "author": "moco@sspitzer.org", "id": 2941368, "count": 10, "is_private": false, "time": "2006-08-11T00:30:43Z", "creation_time": "2006-08-11T00:30:43Z", "attachment_id": null, "creator": "moco@sspitzer.org", "raw_text": "> For some reason, I can't reproduce this on trunk.\n\nme neither, but I'd still like to land my patch on trunk and branch, until we decide to make focus() not return failure.\n\n> I agree, especially at this stage of FF2 development.\n\nthanks brian (and thanks for the review.)  I'll land on trunk (and then seek approval for the branch.)\n\nI'll log a new bug about removing my try / catch, and/or fixing the nsGlobalWindow.cpp code, per martijn's patch."}, {"count": 11, "id": 2941379, "author": "moco@sspitzer.org", "text": "Created attachment 233188\ntrunk version", "tags": [], "bug_id": 348183, "raw_text": "", "attachment_id": 233188, "creator": "moco@sspitzer.org", "time": "2006-08-11T00:43:11Z", "creation_time": "2006-08-11T00:43:11Z", "is_private": false}, {"raw_text": "obsoleting.  I'll move this patch from martijn to the spin off bug.", "attachment_id": 233066, "creator": "moco@sspitzer.org", "time": "2006-08-11T00:48:21Z", "creation_time": "2006-08-11T00:48:21Z", "is_private": false, "count": 12, "id": 2941383, "author": "moco@sspitzer.org", "text": "Comment on attachment 233066\npatch?\n\nobsoleting.  I'll move this patch from martijn to the spin off bug.", "tags": [], "bug_id": 348183}, {"id": 2941385, "count": 13, "text": "fixed on trunk. will seek a= for the branch.", "author": "moco@sspitzer.org", "bug_id": 348183, "tags": [], "attachment_id": null, "creator": "moco@sspitzer.org", "raw_text": "fixed on trunk. will seek a= for the branch.", "time": "2006-08-11T00:49:04Z", "creation_time": "2006-08-11T00:49:04Z", "is_private": false}, {"author": "moco@sspitzer.org", "text": "> I'll log a new bug about removing my try / catch, and/or fixing the\n> nsGlobalWindow.cpp code, per martijn's patch.\n\nsee bug #348357 for martijn's patch and the rest of the issues", "is_private": false, "tags": [], "bug_id": 348183, "raw_text": "> I'll log a new bug about removing my try / catch, and/or fixing the\n> nsGlobalWindow.cpp code, per martijn's patch.\n\nsee bug #348357 for martijn's patch and the rest of the issues", "creator": "moco@sspitzer.org", "attachment_id": null, "count": 14, "id": 2941958, "creation_time": "2006-08-11T17:05:31Z", "time": "2006-08-11T17:05:31Z"}, {"id": 2942233, "creation_time": "2006-08-11T20:57:29Z", "time": "2006-08-11T20:57:29Z", "count": 15, "creator": "mbeltzner@gmail.com", "attachment_id": 233097, "raw_text": "a=drivers, please land on MOZILLA_1_8_BRANCH", "bug_id": 348183, "tags": [], "is_private": false, "text": "Comment on attachment 233097\nalternative, low-risk patch for the branch until everything is sorted out\n\na=drivers, please land on MOZILLA_1_8_BRANCH", "author": "mbeltzner@gmail.com"}, {"text": "fix landed on the branch.", "author": "moco@sspitzer.org", "bug_id": 348183, "tags": [], "id": 2942312, "count": 16, "is_private": false, "attachment_id": null, "creator": "moco@sspitzer.org", "raw_text": "fix landed on the branch.", "time": "2006-08-11T22:06:29Z", "creation_time": "2006-08-11T22:06:29Z"}, {"is_private": false, "creator": "moco@sspitzer.org", "attachment_id": 233097, "raw_text": "I think this fix is worth taking for 1.8.0.7.  see bug #331457 for another issue that it fixes.", "creation_time": "2006-08-11T22:17:31Z", "time": "2006-08-11T22:17:31Z", "text": "Comment on attachment 233097\nalternative, low-risk patch for the branch until everything is sorted out\n\nI think this fix is worth taking for 1.8.0.7.  see bug #331457 for another issue that it fixes.", "author": "moco@sspitzer.org", "bug_id": 348183, "tags": [], "id": 2942331, "count": 17}, {"is_private": false, "tags": [], "bug_id": 348183, "author": "dveditz@mozilla.com", "text": "Comment on attachment 233097\nalternative, low-risk patch for the branch until everything is sorted out\n\napproved for 1.8.0 branch, a=dveditz for drivers", "count": 18, "creation_time": "2006-08-15T22:51:17Z", "id": 2946129, "time": "2006-08-15T22:51:17Z", "raw_text": "approved for 1.8.0 branch, a=dveditz for drivers", "creator": "dveditz@mozilla.com", "attachment_id": 233097}, {"text": "landed on the 1.8.0 branch", "author": "moco@sspitzer.org", "bug_id": 348183, "tags": [], "is_private": false, "creator": "moco@sspitzer.org", "attachment_id": null, "raw_text": "landed on the 1.8.0 branch", "creation_time": "2006-08-21T17:26:07Z", "id": 2952054, "time": "2006-08-21T17:26:07Z", "count": 19}]}}}