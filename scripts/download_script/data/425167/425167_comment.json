{"comments": {}, "bugs": {"425167": {"comments": [{"tags": [], "raw_text": "User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.1.13) Gecko/20080311 Firefox/2.0.0.13\nBuild Identifier: Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.1.13) Gecko/20080311 Firefox/2.0.0.13\n\nThe error message said \"Installer corrupted: invalid opcode\"\nFireFox has been running slow and locking up recently, so I was/am optimistic that this update (install of new version) will correct my problems, but I am uncertain that it even installed correctly, given the error message.  What should I do to make sure I have an uncorrupted version, try the download and reinstall it again... and see if I get the same error message?  Please advise. Thank you guys for all your great work!!!  I love FireFox and have been using it for years. This error message happened the last time I tried to update. Greg 404-831-0951 (cell phone)\n\nReproducible: Always\n\nSteps to Reproduce:\n1.download new version\n2. run install\n3. error message appears\n4. install completes as if everything is OK, but the error message appears next time I try update I get the same error message\nActual Results:  \nDuring normal use I got this: \"Fail to get XMLDocument from http:..dl.ask.com/toolbar/moz/tbintalled.jsp?v=2.0 yatta...yatta...yatta...  [Exception...\"Component returned failure code: 0x80004005 (NS_ERROR_FAIURE) [nxIXMLHttpRequest.suend]\"  nsresult: 0x80004005 (NS_ERROR_FAIURE)\"  location: \"JS frame : : chronme://snipit/content/snipit.js :: ReportToWhatzup :: line 1571\" data: no]\n\nExpected Results:  \nExpect to hear from you.\n\nThat's it folks.  Thank you.\nGreg", "bug_id": 425167, "id": 3546391, "time": "2008-03-26T12:15:03Z", "is_private": false, "creation_time": "2008-03-26T12:15:03Z", "author": "GregKagiraWatson@gmail.com", "attachment_id": null, "count": 0, "text": "User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.1.13) Gecko/20080311 Firefox/2.0.0.13\nBuild Identifier: Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.1.13) Gecko/20080311 Firefox/2.0.0.13\n\nThe error message said \"Installer corrupted: invalid opcode\"\nFireFox has been running slow and locking up recently, so I was/am optimistic that this update (install of new version) will correct my problems, but I am uncertain that it even installed correctly, given the error message.  What should I do to make sure I have an uncorrupted version, try the download and reinstall it again... and see if I get the same error message?  Please advise. Thank you guys for all your great work!!!  I love FireFox and have been using it for years. This error message happened the last time I tried to update. Greg 404-831-0951 (cell phone)\n\nReproducible: Always\n\nSteps to Reproduce:\n1.download new version\n2. run install\n3. error message appears\n4. install completes as if everything is OK, but the error message appears next time I try update I get the same error message\nActual Results:  \nDuring normal use I got this: \"Fail to get XMLDocument from http:..dl.ask.com/toolbar/moz/tbintalled.jsp?v=2.0 yatta...yatta...yatta...  [Exception...\"Component returned failure code: 0x80004005 (NS_ERROR_FAIURE) [nxIXMLHttpRequest.suend]\"  nsresult: 0x80004005 (NS_ERROR_FAIURE)\"  location: \"JS frame : : chronme://snipit/content/snipit.js :: ReportToWhatzup :: line 1571\" data: no]\n\nExpected Results:  \nExpect to hear from you.\n\nThat's it folks.  Thank you.\nGreg", "creator": "GregKagiraWatson@gmail.com"}, {"creation_time": "2008-05-18T16:06:17Z", "author": "bugzillamozillaorg_serge_20140323@gautherie.fr", "text": "Can you reproduce with Firefox v2.0.0.14 ?", "count": 1, "attachment_id": null, "creator": "bugzillamozillaorg_serge_20140323@gautherie.fr", "tags": [], "bug_id": 425167, "raw_text": "Can you reproduce with Firefox v2.0.0.14 ?", "is_private": false, "id": 3626610, "time": "2008-05-18T16:06:17Z"}, {"tags": [], "bug_id": 425167, "raw_text": "xref: Bug 442702 New: install of TB20014 fails with \"invalid opcode\" error message.  I note in this bug, that I get \"Same \"invalid opcode\" error attempting to install FF 2.0.0.14 on same machine.\"\n\nGreg appears to be gone.", "id": 3703073, "time": "2008-07-14T15:06:14Z", "is_private": false, "creation_time": "2008-07-14T15:06:14Z", "author": "vseerror@lehigh.edu", "text": "xref: Bug 442702 New: install of TB20014 fails with \"invalid opcode\" error message.  I note in this bug, that I get \"Same \"invalid opcode\" error attempting to install FF 2.0.0.14 on same machine.\"\n\nGreg appears to be gone.", "attachment_id": null, "count": 2, "creator": "vseerror@lehigh.edu"}, {"time": "2008-08-17T21:56:15Z", "id": 3743566, "is_private": false, "bug_id": 425167, "creator": "GregKagiraWatson@gmail.com", "raw_text": "I am not gone, but I don't know what you expect me to do?\nI think I eventually reinstalled FireFox (after several tries -- had to go back to a couple of MS Windows \"system restore\" points), which seems to be working OK now.  What did you guys do? Do you know what caused this and what I can do to avoid in future?\nGreg", "count": 3, "text": "I am not gone, but I don't know what you expect me to do?\nI think I eventually reinstalled FireFox (after several tries -- had to go back to a couple of MS Windows \"system restore\" points), which seems to be working OK now.  What did you guys do? Do you know what caused this and what I can do to avoid in future?\nGreg", "attachment_id": null, "author": "GregKagiraWatson@gmail.com", "tags": [], "creation_time": "2008-08-17T21:56:15Z"}, {"id": 3743725, "time": "2008-08-18T01:52:17Z", "is_private": false, "raw_text": "We didn't change anything. Chances are this was either a corruption in the download or an extremely rare setting on your system. Are you still able to reproduce?", "bug_id": 425167, "tags": [], "creator": "robert.strong.bugs@gmail.com", "author": "robert.strong.bugs@gmail.com", "count": 4, "attachment_id": null, "text": "We didn't change anything. Chances are this was either a corruption in the download or an extremely rare setting on your system. Are you still able to reproduce?", "creation_time": "2008-08-18T01:52:17Z"}, {"creator": "robert.strong.bugs@gmail.com", "creation_time": "2009-01-27T03:14:56Z", "author": "robert.strong.bugs@gmail.com", "count": 5, "text": "No response to comment #4. Resolving -> WFM", "attachment_id": null, "bug_id": 425167, "raw_text": "No response to comment #4. Resolving -> WFM", "is_private": false, "id": 3946926, "time": "2009-01-27T03:14:56Z", "tags": []}, {"raw_text": "Here we are 9 years later, and I can repro :) \n\nI'm on Nightly and the symptoms are that after an update installs, just as Firefox itself starts this dialog will appear. It appears to be from \"helper.exe\", which stays alive while it is being shown. It's happened for the last 4 or 5 updates and note that the updates *do* get installed.\n\nIt's also worth mentioning that a google search for \"installer corrupted invalid opcode firefox\" gets lots of hits, including this bug and a sumo article which talks about this specific issue, so it is probably happening at a rate which we should take seriously, especially given the resolution is likely beyond many of our users.  OTOH, as the updates appear to work, I guess we could argue it's simply an annoyance.\n\nFrom reading those articles I suspect that if I cleaned my %USERPROFILE%\\AppData\\Local\\Mozilla\\updates folder it would go away, but I'm not doing that yet in the hope that data is useful. It has the following structure:\n\n.\n\u251c\u2500\u2500\u25002D9E75C658F35BC6\n\u251c\u2500\u2500\u2500EECF4B263795E958\n\u2514\u2500\u2500\u2500F0D1AB6A2E32A696\n    \u2502   updates.xml\n    \u2502\n    \u2514\u2500\u2500\u2500updates\n        \u2502   backup-update.log\n        \u2502   last-update.log\n        \u2502\n        \u2514\u2500\u2500\u25000\n\n(ie, a number of empty dirs and only 3 files in total) - so maybe nuking it will not work? I'm attaching last-update.log.\n\nRob, are you still interested in digging in here, or do you know who might be?", "creator": "markh@mozilla.com", "bug_id": 425167, "is_private": false, "id": 13531708, "time": "2018-08-09T03:58:50Z", "creation_time": "2018-08-09T03:58:50Z", "tags": [], "author": "markh@mozilla.com", "text": "Created attachment 8998708\nlast-update.log\n\nHere we are 9 years later, and I can repro :) \n\nI'm on Nightly and the symptoms are that after an update installs, just as Firefox itself starts this dialog will appear. It appears to be from \"helper.exe\", which stays alive while it is being shown. It's happened for the last 4 or 5 updates and note that the updates *do* get installed.\n\nIt's also worth mentioning that a google search for \"installer corrupted invalid opcode firefox\" gets lots of hits, including this bug and a sumo article which talks about this specific issue, so it is probably happening at a rate which we should take seriously, especially given the resolution is likely beyond many of our users.  OTOH, as the updates appear to work, I guess we could argue it's simply an annoyance.\n\nFrom reading those articles I suspect that if I cleaned my %USERPROFILE%\\AppData\\Local\\Mozilla\\updates folder it would go away, but I'm not doing that yet in the hope that data is useful. It has the following structure:\n\n.\n\u251c\u2500\u2500\u25002D9E75C658F35BC6\n\u251c\u2500\u2500\u2500EECF4B263795E958\n\u2514\u2500\u2500\u2500F0D1AB6A2E32A696\n    \u2502   updates.xml\n    \u2502\n    \u2514\u2500\u2500\u2500updates\n        \u2502   backup-update.log\n        \u2502   last-update.log\n        \u2502\n        \u2514\u2500\u2500\u25000\n\n(ie, a number of empty dirs and only 3 files in total) - so maybe nuking it will not work? I'm attaching last-update.log.\n\nRob, are you still interested in digging in here, or do you know who might be?", "attachment_id": 8998708, "count": 6}, {"text": "+mhowell", "count": 7, "attachment_id": null, "author": "robert.strong.bugs@gmail.com", "tags": [], "creation_time": "2018-08-09T04:10:58Z", "time": "2018-08-09T04:10:58Z", "id": 13531710, "is_private": false, "bug_id": 425167, "raw_text": "+mhowell", "creator": "robert.strong.bugs@gmail.com"}, {"is_private": false, "id": 13535647, "time": "2018-08-10T15:26:56Z", "raw_text": "Thanks for the info. There should not be anything in \"%USERPROFILE%\\AppData\\Local\\Mozilla\\updates\" that's relevant to this error in any case, and I don't see anything in your directory tree that looks out of the ordinary. The contents of your last-update.log don't provide any hints either.\n\nWould you mind attaching the file \"C:\\Firefox\\Nightly\\uninstall\\helper.exe\" after you've seen this error? I'm curious whether the file is corrupt or broken, or if the file data itself is fine but something is causing it to not load properly.\n\nTo provide some background here, helper.exe is responsible for running the code at [0] during each update after the files (including helper.exe) have been patched by updater.exe. Most of the time this code doesn't end up doing a whole lot; it updates the version information in the Windows registry uninstall key to indicate the new version number, and on most updates that's all it does. Most of the rest of the code is cleanup or migrations for updating from much older versions. That's why the updated version of Nightly runs fine despite this error.\n\n[0] https://searchfox.org/mozilla-central/source/browser/installer/windows/nsis/shared.nsh#5", "bug_id": 425167, "creator": "mhowell@mozilla.com", "tags": [], "author": "mhowell@mozilla.com", "attachment_id": null, "text": "Thanks for the info. There should not be anything in \"%USERPROFILE%\\AppData\\Local\\Mozilla\\updates\" that's relevant to this error in any case, and I don't see anything in your directory tree that looks out of the ordinary. The contents of your last-update.log don't provide any hints either.\n\nWould you mind attaching the file \"C:\\Firefox\\Nightly\\uninstall\\helper.exe\" after you've seen this error? I'm curious whether the file is corrupt or broken, or if the file data itself is fine but something is causing it to not load properly.\n\nTo provide some background here, helper.exe is responsible for running the code at [0] during each update after the files (including helper.exe) have been patched by updater.exe. Most of the time this code doesn't end up doing a whole lot; it updates the version information in the Windows registry uninstall key to indicate the new version number, and on most updates that's all it does. Most of the rest of the code is cleanup or migrations for updating from much older versions. That's why the updated version of Nightly runs fine despite this error.\n\n[0] https://searchfox.org/mozilla-central/source/browser/installer/windows/nsis/shared.nsh#5", "count": 8, "creation_time": "2018-08-10T15:26:56Z"}, {"tags": [], "bug_id": 425167, "raw_text": "Here's helper.exe, captured while it is showing that dialog.\n\nFWIW, process explorer tells me it was executed with a command-line of \"argv0ignored /PostUpdate\", it's parent is the (now closed) updater.exe, and it has one thread with a stack of:\n\nwow64cpu.dll!TurboDispatchJumpAddressEnd+0x544\nwow64cpu.dll!TurboDispatchJumpAddressEnd+0x503\nwow64cpu.dll!BTCpuSimulate+0x9\nwow64.dll!Wow64LdrpInitialize+0x236\nwow64.dll!Wow64LdrpInitialize+0x120\nntdll.dll!LdrInitShimEngineDynamic+0x308f\nntdll.dll!memset+0x1ecbf\nntdll.dll!LdrInitializeThunk+0x5b\nntdll.dll!LdrInitializeThunk+0xe\n\n(which seems a little odd, but that's what it says :)", "time": "2018-08-20T01:42:59Z", "id": 13555620, "is_private": false, "creation_time": "2018-08-20T01:42:59Z", "attachment_id": 9002341, "text": "Created attachment 9002341\nhelper.exe.zip\n\nHere's helper.exe, captured while it is showing that dialog.\n\nFWIW, process explorer tells me it was executed with a command-line of \"argv0ignored /PostUpdate\", it's parent is the (now closed) updater.exe, and it has one thread with a stack of:\n\nwow64cpu.dll!TurboDispatchJumpAddressEnd+0x544\nwow64cpu.dll!TurboDispatchJumpAddressEnd+0x503\nwow64cpu.dll!BTCpuSimulate+0x9\nwow64.dll!Wow64LdrpInitialize+0x236\nwow64.dll!Wow64LdrpInitialize+0x120\nntdll.dll!LdrInitShimEngineDynamic+0x308f\nntdll.dll!memset+0x1ecbf\nntdll.dll!LdrInitializeThunk+0x5b\nntdll.dll!LdrInitializeThunk+0xe\n\n(which seems a little odd, but that's what it says :)", "count": 9, "author": "markh@mozilla.com", "creator": "markh@mozilla.com"}, {"tags": [], "raw_text": "Okay, thanks for the file and the info. That's a perfectly good copy of helper.exe, so at least we know that the updater is writing it correctly.\n\nThat leaves two possibilities: either something is messing with how the file is loaded/read (but presumably not messing with other files the same way or your computer would probably not be usable), or the error is being triggered by a bug in our code that only manifests under pretty rare conditions (otherwise this issue would be more frequently reported). I suspect the latter of course, but it's going to be very difficult to debug. We don't have logging in this code, and there's no way to get a less generic error message, so the only diagnostic I can really think of is to build a copy of helper.exe that's littered with progress messages and see how far it gets. That's kind of more work than I can ask you to do though, I think.\n\nI think the stack you're seeing is a Process Explorer bug; I seem to get the same cut-off stack for any 32-bit process (which helper.exe always is). Process Hacker [https://processhacker.sourceforge.io/] would probably show you the rest of the stack, but I don't expect it to be very informative; it's an NSIS binary so it's just interpreting bytecode (the opcode that the error message refers to is a bytecode instruction), so there probably won't be a useful native code stack. I also don't think I've ever noticed the \"argv0ignored\" thing, but that's... probably okay.", "bug_id": 425167, "time": "2018-08-20T17:19:29Z", "id": 13558359, "is_private": false, "creation_time": "2018-08-20T17:19:29Z", "count": 10, "text": "Okay, thanks for the file and the info. That's a perfectly good copy of helper.exe, so at least we know that the updater is writing it correctly.\n\nThat leaves two possibilities: either something is messing with how the file is loaded/read (but presumably not messing with other files the same way or your computer would probably not be usable), or the error is being triggered by a bug in our code that only manifests under pretty rare conditions (otherwise this issue would be more frequently reported). I suspect the latter of course, but it's going to be very difficult to debug. We don't have logging in this code, and there's no way to get a less generic error message, so the only diagnostic I can really think of is to build a copy of helper.exe that's littered with progress messages and see how far it gets. That's kind of more work than I can ask you to do though, I think.\n\nI think the stack you're seeing is a Process Explorer bug; I seem to get the same cut-off stack for any 32-bit process (which helper.exe always is). Process Hacker [https://processhacker.sourceforge.io/] would probably show you the rest of the stack, but I don't expect it to be very informative; it's an NSIS binary so it's just interpreting bytecode (the opcode that the error message refers to is a bytecode instruction), so there probably won't be a useful native code stack. I also don't think I've ever noticed the \"argv0ignored\" thing, but that's... probably okay.", "attachment_id": null, "author": "mhowell@mozilla.com", "creator": "mhowell@mozilla.com"}, {"creation_time": "2018-08-21T01:05:40Z", "author": "markh@mozilla.com", "text": "(In reply to Matt Howell [:mhowell] from comment #10)\n> have logging in this code, and there's no way to get a less generic error\n> message, so the only diagnostic I can really think of is to build a copy of\n> helper.exe that's littered with progress messages and see how far it gets.\n> That's kind of more work than I can ask you to do though, I think.\n\nI can certainly build firefox from source if that helps. To experiment, I added:\n\n>   MessageBox MB_OK \"POSTUPDATE\"\n\nto https://searchfox.org/mozilla-central/rev/71ef4447db179639be9eff4471f32a95423962d7/browser/installer/windows/nsis/shared.nsh#6\n\nthen built a debug version of Firefox and copied update.exe from the obj-dir to the installed directory, but saw no messagebox. VS2017 also doesn't think that executable has debug info, so I'm sure there's something about how nsis is used that I don't understand.\n\nIf you can give me some clues here I'd be happy to experiment.\n\n> I think the stack you're seeing is a Process Explorer bug; I seem to get the\n> same cut-off stack for any 32-bit process (which helper.exe always is).\n> Process Hacker [https://processhacker.sourceforge.io/] would probably show\n> you the rest of the stack, but I don't expect it to be very informative;\n> it's an NSIS binary so it's just interpreting bytecode (the opcode that the\n> error message refers to is a bytecode instruction), so there probably won't\n> be a useful native code stack. I also don't think I've ever noticed the\n> \"argv0ignored\" thing, but that's... probably okay.\n\nYeah - Visual Studio gives a fairly useless stack (both using the original helper.exe and one I built using a debug mozconfig), so I suspect you are correct.\n\nWhat are the next steps here?", "attachment_id": null, "count": 11, "tags": [], "creator": "markh@mozilla.com", "raw_text": "(In reply to Matt Howell [:mhowell] from comment #10)\n> have logging in this code, and there's no way to get a less generic error\n> message, so the only diagnostic I can really think of is to build a copy of\n> helper.exe that's littered with progress messages and see how far it gets.\n> That's kind of more work than I can ask you to do though, I think.\n\nI can certainly build firefox from source if that helps. To experiment, I added:\n\n>   MessageBox MB_OK \"POSTUPDATE\"\n\nto https://searchfox.org/mozilla-central/rev/71ef4447db179639be9eff4471f32a95423962d7/browser/installer/windows/nsis/shared.nsh#6\n\nthen built a debug version of Firefox and copied update.exe from the obj-dir to the installed directory, but saw no messagebox. VS2017 also doesn't think that executable has debug info, so I'm sure there's something about how nsis is used that I don't understand.\n\nIf you can give me some clues here I'd be happy to experiment.\n\n> I think the stack you're seeing is a Process Explorer bug; I seem to get the\n> same cut-off stack for any 32-bit process (which helper.exe always is).\n> Process Hacker [https://processhacker.sourceforge.io/] would probably show\n> you the rest of the stack, but I don't expect it to be very informative;\n> it's an NSIS binary so it's just interpreting bytecode (the opcode that the\n> error message refers to is a bytecode instruction), so there probably won't\n> be a useful native code stack. I also don't think I've ever noticed the\n> \"argv0ignored\" thing, but that's... probably okay.\n\nYeah - Visual Studio gives a fairly useless stack (both using the original helper.exe and one I built using a debug mozconfig), so I suspect you are correct.\n\nWhat are the next steps here?", "bug_id": 425167, "id": 13559338, "time": "2018-08-21T01:05:40Z", "is_private": false}, {"is_private": false, "time": "2018-08-21T01:16:07Z", "id": 13559348, "raw_text": "I should also note that executing \"helper.exe /PostUpdate\" from the cmdline gives the same message.", "bug_id": 425167, "tags": [], "creator": "markh@mozilla.com", "attachment_id": null, "count": 12, "text": "I should also note that executing \"helper.exe /PostUpdate\" from the cmdline gives the same message.", "author": "markh@mozilla.com", "creation_time": "2018-08-21T01:16:07Z"}, {"time": "2018-08-21T15:41:07Z", "id": 13560691, "is_private": false, "raw_text": "Yeah, you're doing pretty much what I had in mind, adding in MessageBox calls and invoking \"helper.exe /PostUpdate\" from the command line. I can give you a few more pointers. The actual entry point is:\nhttps://searchfox.org/mozilla-central/rev/71ef4447db179639be9eff4471f32a95423962d7/browser/installer/windows/nsis/uninstaller.nsi#616\n\nwhich is calling:\nhttps://searchfox.org/mozilla-central/rev/71ef4447db179639be9eff4471f32a95423962d7/toolkit/mozapps/installer/windows/nsis/common.nsh#5257\n\nwhich invokes the PostUpdate code you already found, after a bit of initialization and checking the command line. I'd work my way down that whole path sprinkling MessageBox's around. If it's not even getting into the PostUpdate macro that's certainly surprising; as you can see there's not too much substantial code prior to that.\n\nThere seems to be a bug in the build system where helper.exe doesn't get recompiled on incremental builds, so I think you have to have a fresh build every time you change it. Fortunately it does get compiled during artifact builds, so I'd certainly recommend using those.\n\nAbout the debug info thing, the NSIS compiler works by taking a prebuilt executable stub (the bytecode interpreter) and just appending the bytecode that it's compiled from our scripts. So debug vs. release builds don't have any effect on it. :(\n\nBy the way, thanks for doing this! It's always really awesome to have someone who's reproducing a rare bug be willing to put in the effort to help diagnose it.", "bug_id": 425167, "creator": "mhowell@mozilla.com", "attachment_id": null, "count": 13, "text": "Yeah, you're doing pretty much what I had in mind, adding in MessageBox calls and invoking \"helper.exe /PostUpdate\" from the command line. I can give you a few more pointers. The actual entry point is:\nhttps://searchfox.org/mozilla-central/rev/71ef4447db179639be9eff4471f32a95423962d7/browser/installer/windows/nsis/uninstaller.nsi#616\n\nwhich is calling:\nhttps://searchfox.org/mozilla-central/rev/71ef4447db179639be9eff4471f32a95423962d7/toolkit/mozapps/installer/windows/nsis/common.nsh#5257\n\nwhich invokes the PostUpdate code you already found, after a bit of initialization and checking the command line. I'd work my way down that whole path sprinkling MessageBox's around. If it's not even getting into the PostUpdate macro that's certainly surprising; as you can see there's not too much substantial code prior to that.\n\nThere seems to be a bug in the build system where helper.exe doesn't get recompiled on incremental builds, so I think you have to have a fresh build every time you change it. Fortunately it does get compiled during artifact builds, so I'd certainly recommend using those.\n\nAbout the debug info thing, the NSIS compiler works by taking a prebuilt executable stub (the bytecode interpreter) and just appending the bytecode that it's compiled from our scripts. So debug vs. release builds don't have any effect on it. :(\n\nBy the way, thanks for doing this! It's always really awesome to have someone who's reproducing a rare bug be willing to put in the effort to help diagnose it.", "author": "mhowell@mozilla.com", "tags": [], "creation_time": "2018-08-21T15:41:07Z"}, {"is_private": false, "id": 13562307, "time": "2018-08-22T04:04:00Z", "creator": "mhowell@mozilla.com", "raw_text": "Okay, thanks to some pretty heroic debugging from :markh (thanks again, Mark) I think we've actually finally tracked this bug down.\n\nThe root cause is the use of the ApplicationID::Set plugin function, specifically inside our function UpdateShortcutAppModelIDs at [1]. At [2], ApplicationID::Set pops its two required parameters off the NSIS stack, but then it also proceeds to pop a third optional parameter. We never pass the third parameter, because the documentation doesn't mention it and we don't need it, so every call we make to ApplicationID::Set pops one too many items off the stack.\n\nLuckily, we can handle that happening a few times just fine, because a) there are several items already on the stack at that point and we don't end up doing much with those, so we can tolerate losing them, and b) the NSIS Pop instruction does not fatally fail if the stack is empty, it just sets the error flag (which is not generally checked after a Pop instruction) and leaves the destination alone. But, the Exch instruction, which is used in UpdateShortcutAppModelIDs a couple of times, cannot continue if it does not find the number of items it needs on the stack, so it throws the invalid opcode error and aborts the script. Meaning we only crash if we lose a number of items (that is, if we make a number of ApplicationID::Set calls) which is greater than the number of items that were previously on the stack when UpdateShortcutAppModelIDs was invoked (minus 2, because our use of Exch there needs two items).\n\nAll of which means this only breaks things if you have an unusually high number of shortcuts to one installation of Firefox. And in fact that's what led us here; Mark noticed nine accidentally created copies of his taskbar shortcut.\n\nI'm going to go ahead and put a patch for this together; this bug has certainly sat here long enough. I think the way to go is just to add in the third parameter everywhere we call ApplicationID::Set, so I'm planning on doing that.\n\n[1] https://searchfox.org/mozilla-central/rev/3fa761ade83ed0b8ab463acb057c2cf0b104689e/toolkit/mozapps/installer/windows/nsis/common.nsh#6990\n[2] https://searchfox.org/mozilla-central/rev/3fa761ade83ed0b8ab463acb057c2cf0b104689e/other-licenses/nsis/Contrib/ApplicationID/Set.cpp#64", "bug_id": 425167, "tags": [], "author": "mhowell@mozilla.com", "text": "Okay, thanks to some pretty heroic debugging from :markh (thanks again, Mark) I think we've actually finally tracked this bug down.\n\nThe root cause is the use of the ApplicationID::Set plugin function, specifically inside our function UpdateShortcutAppModelIDs at [1]. At [2], ApplicationID::Set pops its two required parameters off the NSIS stack, but then it also proceeds to pop a third optional parameter. We never pass the third parameter, because the documentation doesn't mention it and we don't need it, so every call we make to ApplicationID::Set pops one too many items off the stack.\n\nLuckily, we can handle that happening a few times just fine, because a) there are several items already on the stack at that point and we don't end up doing much with those, so we can tolerate losing them, and b) the NSIS Pop instruction does not fatally fail if the stack is empty, it just sets the error flag (which is not generally checked after a Pop instruction) and leaves the destination alone. But, the Exch instruction, which is used in UpdateShortcutAppModelIDs a couple of times, cannot continue if it does not find the number of items it needs on the stack, so it throws the invalid opcode error and aborts the script. Meaning we only crash if we lose a number of items (that is, if we make a number of ApplicationID::Set calls) which is greater than the number of items that were previously on the stack when UpdateShortcutAppModelIDs was invoked (minus 2, because our use of Exch there needs two items).\n\nAll of which means this only breaks things if you have an unusually high number of shortcuts to one installation of Firefox. And in fact that's what led us here; Mark noticed nine accidentally created copies of his taskbar shortcut.\n\nI'm going to go ahead and put a patch for this together; this bug has certainly sat here long enough. I think the way to go is just to add in the third parameter everywhere we call ApplicationID::Set, so I'm planning on doing that.\n\n[1] https://searchfox.org/mozilla-central/rev/3fa761ade83ed0b8ab463acb057c2cf0b104689e/toolkit/mozapps/installer/windows/nsis/common.nsh#6990\n[2] https://searchfox.org/mozilla-central/rev/3fa761ade83ed0b8ab463acb057c2cf0b104689e/other-licenses/nsis/Contrib/ApplicationID/Set.cpp#64", "attachment_id": null, "count": 14, "creation_time": "2018-08-22T04:04:00Z"}, {"attachment_id": 9003179, "text": "Created attachment 9003179\nBug 425167 - Always fill in the optional third parameter to ApplicationID::Set. r=agashlin\n\nIn theory, the third parameter (dualMode) to the NSIS ApplicationID plugin's\nSet function is optional, but the plugin assumes that either it's there or\nthere's nothing else on the NSIS stack, so it pops three items from the stack\nunconditionally. This means that supplying only two parameters results in\none item silently being dropped from the NSIS stack. Fortunately this one\nfunction is the only place where we were doing that, so it only became a\nproblem if there were an awful lot of shortcuts (around 7) to the same\ninstallation.", "count": 15, "author": "mhowell@mozilla.com", "tags": [], "creation_time": "2018-08-22T15:53:04Z", "time": "2018-08-22T15:53:04Z", "id": 13563714, "is_private": false, "creator": "mhowell@mozilla.com", "raw_text": "In theory, the third parameter (dualMode) to the NSIS ApplicationID plugin's\nSet function is optional, but the plugin assumes that either it's there or\nthere's nothing else on the NSIS stack, so it pops three items from the stack\nunconditionally. This means that supplying only two parameters results in\none item silently being dropped from the NSIS stack. Fortunately this one\nfunction is the only place where we were doing that, so it only became a\nproblem if there were an awful lot of shortcuts (around 7) to the same\ninstallation.", "bug_id": 425167}, {"tags": [], "raw_text": "Cool! I have no issues with the patch, but it seems like this should probably be a different bug: The initial report here was before the introduction of that optional parameter in bug 740694.", "bug_id": 425167, "id": 13564073, "time": "2018-08-22T18:09:23Z", "is_private": false, "creation_time": "2018-08-22T18:09:23Z", "author": "agashlin+bz@gmail.com", "attachment_id": null, "text": "Cool! I have no issues with the patch, but it seems like this should probably be a different bug: The initial report here was before the introduction of that optional parameter in bug 740694.", "count": 16, "creator": "agashlin+bz@gmail.com"}, {"bug_id": 425167, "raw_text": "Okay, I'll move this to a new bug.", "creator": "mhowell@mozilla.com", "is_private": false, "id": 13564430, "time": "2018-08-22T20:11:30Z", "creation_time": "2018-08-22T20:11:30Z", "tags": [], "author": "mhowell@mozilla.com", "attachment_id": null, "text": "Okay, I'll move this to a new bug.", "count": 17}]}}}