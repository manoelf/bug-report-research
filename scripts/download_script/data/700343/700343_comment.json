{"bugs": {"700343": {"comments": [{"bug_id": 700343, "count": 0, "tags": [], "time": "2011-11-07T17:44:27Z", "text": "We MADV_FREE GC pages when we \"decommit\" them on Mac.  But MADV_FREE'd pages are still counted against our process's RSS.  We need to explicitly purge them in order to correctly compute our memory usage.\n\nBug 670596, comment 52:\n\nThe problem is that on Mac, when you madvise(MADV_FREE), you're hinting to the OS, \"I don't need these pages, so you can take them back whenever.\"  The OS is lazy about this, and only takes back the pages when there's memory pressure on the machine.  Until then, they count against your RSS.\n\nThis means that whatever memory gains you're getting from MADV_FREE, you can't measure with RSS.  You could say that your \"true RSS\" is RSS minus the number of pages you've MADV_FREE'd, but then when you have memory pressure and the OS frees those pages, you're under-counting your RSS!\n\nThe hack we did in jemalloc is to add a function which explicitly purges all MADV_FREE'd pages, by decommitting and recommitting them (with mmap(PROT_NONE) and mmap(PROT_READ | PROT_WRITE)).  We then call this function before we read RSS on Mac [1].\n\nThis way, when you open about:memory, you'll see the correct RSS (in about:memory and in the Mac task manager).  Telemetry also calls this function, so it'll report the correct result.", "author": "justin.lebar+bug@gmail.com", "creation_time": "2011-11-07T17:44:27Z", "creator": "justin.lebar+bug@gmail.com", "is_private": false, "id": 5831288, "raw_text": "We MADV_FREE GC pages when we \"decommit\" them on Mac.  But MADV_FREE'd pages are still counted against our process's RSS.  We need to explicitly purge them in order to correctly compute our memory usage.\n\nBug 670596, comment 52:\n\nThe problem is that on Mac, when you madvise(MADV_FREE), you're hinting to the OS, \"I don't need these pages, so you can take them back whenever.\"  The OS is lazy about this, and only takes back the pages when there's memory pressure on the machine.  Until then, they count against your RSS.\n\nThis means that whatever memory gains you're getting from MADV_FREE, you can't measure with RSS.  You could say that your \"true RSS\" is RSS minus the number of pages you've MADV_FREE'd, but then when you have memory pressure and the OS frees those pages, you're under-counting your RSS!\n\nThe hack we did in jemalloc is to add a function which explicitly purges all MADV_FREE'd pages, by decommitting and recommitting them (with mmap(PROT_NONE) and mmap(PROT_READ | PROT_WRITE)).  We then call this function before we read RSS on Mac [1].\n\nThis way, when you open about:memory, you'll see the correct RSS (in about:memory and in the Mac task manager).  Telemetry also calls this function, so it'll report the correct result.", "attachment_id": null}]}}, "comments": {}}