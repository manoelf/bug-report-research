{"bugs": {"1641720": {"comments": [{"bug_id": 1641720, "tags": [], "count": 0, "is_private": false, "author": "kaie@kuix.de", "time": "2020-05-28T23:12:09Z", "raw_text": "The RNP library supports a wide set of ciphersuites.\n\nWe should decide which ciphers we consider sufficiently secure, and maintain an allowlist of ciphers considered good.\n\nWhen seeing encrypted data or a signature using a mechanism that isn't on the allowlist, we might want to omit security indicators.", "text": "The RNP library supports a wide set of ciphersuites.\n\nWe should decide which ciphers we consider sufficiently secure, and maintain an allowlist of ciphers considered good.\n\nWhen seeing encrypted data or a signature using a mechanism that isn't on the allowlist, we might want to omit security indicators.", "id": 14850665, "attachment_id": null, "creator": "kaie@kuix.de", "creation_time": "2020-05-28T23:12:09Z"}, {"raw_text": "", "time": "2020-08-26T18:06:57Z", "author": "kaie@kuix.de", "bug_id": 1641720, "tags": [], "count": 1, "is_private": false, "creation_time": "2020-08-26T18:06:57Z", "creator": "kaie@kuix.de", "attachment_id": 9172217, "text": "Created attachment 9172217\n1641720-v1.patch", "id": 15007297}, {"raw_text": "", "time": "2020-08-26T18:08:02Z", "author": "kaie@kuix.de", "tags": [], "bug_id": 1641720, "is_private": false, "count": 2, "creation_time": "2020-08-26T18:08:02Z", "creator": "kaie@kuix.de", "attachment_id": 9172219, "id": 15007300, "text": "Created attachment 9172219\n1641720-v2.patch"}, {"creation_time": "2020-08-26T18:11:58Z", "attachment_id": 9172219, "creator": "kaie@kuix.de", "id": 15007303, "text": "Comment on attachment 9172219\n1641720-v2.patch\n\nNickolay, I couldn't work on this earlier.\n\nBecause we don't yet have APIs in RNP that allow us to define a policy for allowed ciphers/hashes, I consider to apply this local patch as an initial solution for signatures, to block some ciphers and hashes which I think shouldn't be allowed.\n\nDoes this patch look technically correct?\n\nFor testing purposes, I've added SHA1 temporarily to the \"false\" section, and used a signed message that used a SHA1 hash. It was rejected as expected.\n\n(Note I'm not suggesting to block SHA1 at this time, I just used it for testing, because that was the easiest for me.)", "raw_text": "Nickolay, I couldn't work on this earlier.\n\nBecause we don't yet have APIs in RNP that allow us to define a policy for allowed ciphers/hashes, I consider to apply this local patch as an initial solution for signatures, to block some ciphers and hashes which I think shouldn't be allowed.\n\nDoes this patch look technically correct?\n\nFor testing purposes, I've added SHA1 temporarily to the \"false\" section, and used a signed message that used a SHA1 hash. It was rejected as expected.\n\n(Note I'm not suggesting to block SHA1 at this time, I just used it for testing, because that was the easiest for me.)", "time": "2020-08-26T18:11:58Z", "author": "kaie@kuix.de", "count": 3, "is_private": false, "bug_id": 1641720, "tags": []}, {"count": 4, "is_private": false, "bug_id": 1641720, "tags": [], "author": "kaie@kuix.de", "time": "2020-08-26T18:15:34Z", "raw_text": "Of course this isn't complete. A separate follow-up step could be to check the size of the key material used with public key algorithms, and also reject signatures for small sizes, based on algorithm.", "id": 15007310, "text": "Of course this isn't complete. A separate follow-up step could be to check the size of the key material used with public key algorithms, and also reject signatures for small sizes, based on algorithm.", "creator": "kaie@kuix.de", "attachment_id": null, "creation_time": "2020-08-26T18:15:34Z"}, {"creation_time": "2020-08-26T19:46:04Z", "creator": "kaie@kuix.de", "attachment_id": 9172240, "text": "Created attachment 9172240\n1641720-disable-using-SM2.patch\n\nThunderbird and RNP currently support the import of keys that use the non-standard SM2 public key algorithm.\n\nThis patch should stop Thunderbird from using such keys for signing or encryption.", "id": 15007454, "raw_text": "Thunderbird and RNP currently support the import of keys that use the non-standard SM2 public key algorithm.\n\nThis patch should stop Thunderbird from using such keys for signing or encryption.", "time": "2020-08-26T19:46:04Z", "author": "kaie@kuix.de", "is_private": false, "count": 5, "tags": [], "bug_id": 1641720}, {"id": 15008166, "text": "Comment on attachment 9172219\n1641720-v2.patch\n\nReview of attachment 9172219:\n-----------------------------------------------------------------\n\n::: third_party/rnp/src/lib/crypto/signatures.cpp\n@@ +248,5 @@\n>      rnp_result_t ret = RNP_ERROR_GENERIC;\n>  \n>      const pgp_hash_alg_t hash_alg = pgp_hash_alg_type(hash);\n> +    if (!is_hash_alg_allowed_in_sig(hash_alg)) {\n> +        return RNP_ERROR_SIGNATURE_INVALID;\n\nWould probably make sense to have a specific error code for cases like this...", "author": "mkmelin+mozilla@iki.fi", "tags": [], "bug_id": 1641720, "is_private": false, "count": 6, "creation_time": "2020-08-27T08:39:06Z", "raw_text": "Review of attachment 9172219:\n-----------------------------------------------------------------\n\n::: third_party/rnp/src/lib/crypto/signatures.cpp\n@@ +248,5 @@\n>      rnp_result_t ret = RNP_ERROR_GENERIC;\n>  \n>      const pgp_hash_alg_t hash_alg = pgp_hash_alg_type(hash);\n> +    if (!is_hash_alg_allowed_in_sig(hash_alg)) {\n> +        return RNP_ERROR_SIGNATURE_INVALID;\n\nWould probably make sense to have a specific error code for cases like this...", "time": "2020-08-27T08:39:06Z", "attachment_id": 9172219, "creator": "mkmelin+mozilla@iki.fi"}, {"raw_text": "While this code looks ok for now and could be used as quick-fix, I think that it should be done in more general way, to be able to distinguish wrong signature from weak signature, mark keys as weak, and so on.\nFor instance, signature with MD5/RSA768 made back in 1990s should not be rejected.\nThis requires some thinking. I will create an issue in the rnp repository (if we don't have it yet) to discuss the way it could be implemented.", "creation_time": "2020-08-27T08:51:28Z", "creator": "o.nickolay@gmail.com", "attachment_id": null, "time": "2020-08-27T08:51:28Z", "text": "While this code looks ok for now and could be used as quick-fix, I think that it should be done in more general way, to be able to distinguish wrong signature from weak signature, mark keys as weak, and so on.\nFor instance, signature with MD5/RSA768 made back in 1990s should not be rejected.\nThis requires some thinking. I will create an issue in the rnp repository (if we don't have it yet) to discuss the way it could be implemented.", "id": 15008173, "author": "o.nickolay@gmail.com", "is_private": false, "count": 7, "tags": [], "bug_id": 1641720}, {"bug_id": 1641720, "tags": [], "count": 8, "is_private": false, "author": "kaie@kuix.de", "time": "2020-08-27T11:43:51Z", "raw_text": "(In reply to Magnus Melin [:mkmelin] from comment #6)\n> Would probably make sense to have a specific error code for cases like\n> this...\n\nYes, but this is internal RNP code, so it's RNP's decision if that makes sense. And that's deep inside many call levels, and only affects parts of the verifications that will be done, so likely this error code from here isn't directly reported back to the application.", "text": "(In reply to Magnus Melin [:mkmelin] from comment #6)\n> Would probably make sense to have a specific error code for cases like\n> this...\n\nYes, but this is internal RNP code, so it's RNP's decision if that makes sense. And that's deep inside many call levels, and only affects parts of the verifications that will be done, so likely this error code from here isn't directly reported back to the application.", "id": 15008544, "creator": "kaie@kuix.de", "attachment_id": null, "creation_time": "2020-08-27T11:43:51Z"}, {"creation_time": "2020-08-27T13:04:00Z", "raw_text": "Pushed by kaie@kuix.de:\nhttps://hg.mozilla.org/comm-central/rev/9dd9372128b6\nPatch RNP to disable several nonstandard or obsolete ciphers. r=mkmelin\nhttps://hg.mozilla.org/comm-central/rev/1872902a18f1\nDisable the use of keys with the SM2 public key algorithm. r=mkmelin", "creator": "pulsebot@bots.tld", "attachment_id": null, "time": "2020-08-27T13:04:00Z", "author": "pulsebot@bots.tld", "text": "Pushed by kaie@kuix.de:\nhttps://hg.mozilla.org/comm-central/rev/9dd9372128b6\nPatch RNP to disable several nonstandard or obsolete ciphers. r=mkmelin\nhttps://hg.mozilla.org/comm-central/rev/1872902a18f1\nDisable the use of keys with the SM2 public key algorithm. r=mkmelin", "id": 15008686, "count": 9, "is_private": false, "bug_id": 1641720, "tags": []}, {"is_private": false, "count": 10, "tags": [], "bug_id": 1641720, "author": "kaie@kuix.de", "time": "2020-08-27T14:09:45Z", "raw_text": "Nickolay, thanks for the feedback. I agree we should improve it further. It will also be inconvenient to carry a patch to RNP permanently, so a better solution will be much appreciated. Happy to talk on github about API specifics. What could potentially work: Allow Thunderbird to perform a one time configuration (either global, or if necessary, bound to an FFI). When verifying a signature inside that FFI, RNP should then ignore/skip any signatures that are outside of the policy allowance. I don't yet have a clear opinion what should happen to keys with an out-of-police signature, if the primary attributes of the key are allowed by the policy. Allow using the fine attributes of the key, or reject the key in general?", "text": "Nickolay, thanks for the feedback. I agree we should improve it further. It will also be inconvenient to carry a patch to RNP permanently, so a better solution will be much appreciated. Happy to talk on github about API specifics. What could potentially work: Allow Thunderbird to perform a one time configuration (either global, or if necessary, bound to an FFI). When verifying a signature inside that FFI, RNP should then ignore/skip any signatures that are outside of the policy allowance. I don't yet have a clear opinion what should happen to keys with an out-of-police signature, if the primary attributes of the key are allowed by the policy. Allow using the fine attributes of the key, or reject the key in general?", "id": 15008808, "attachment_id": null, "creator": "kaie@kuix.de", "creation_time": "2020-08-27T14:09:45Z"}, {"raw_text": "To verify the patch to RNP, I've executed the RNP tests. The patch causes the following tests to fail.\n\t110 - rnp_tests.rnpkeys_generatekey_testSignature (Failed)\n\t131 - rnp_tests.test_key_validate (Failed)\n\t168 - rnp_tests.test_stream_key_signatures (Failed)\n\t169 - rnp_tests.test_stream_key_signature_validate (Failed)\n\nI've looked at the related data. And all of them involve the use of either SM3 or MD5.\n\nWith this patch applied (to RNP tests, not required for Thunderbird), which disables the testing of SM3, and negates the expectation for keys involving MD5, the RNP test suite passes.", "time": "2020-08-27T15:50:43Z", "author": "kaie@kuix.de", "tags": [], "bug_id": 1641720, "count": 11, "is_private": false, "creation_time": "2020-08-27T15:50:43Z", "creator": "kaie@kuix.de", "attachment_id": 9172437, "text": "Created attachment 9172437\ndisable-tests.patch\n\nTo verify the patch to RNP, I've executed the RNP tests. The patch causes the following tests to fail.\n\t110 - rnp_tests.rnpkeys_generatekey_testSignature (Failed)\n\t131 - rnp_tests.test_key_validate (Failed)\n\t168 - rnp_tests.test_stream_key_signatures (Failed)\n\t169 - rnp_tests.test_stream_key_signature_validate (Failed)\n\nI've looked at the related data. And all of them involve the use of either SM3 or MD5.\n\nWith this patch applied (to RNP tests, not required for Thunderbird), which disables the testing of SM3, and negates the expectation for keys involving MD5, the RNP test suite passes.", "id": 15008997}, {"raw_text": "Updated patch - only change is the proper commit header. Has r=mkmelin", "time": "2020-08-27T16:31:49Z", "author": "kaie@kuix.de", "is_private": false, "count": 12, "tags": [], "bug_id": 1641720, "creation_time": "2020-08-27T16:31:49Z", "attachment_id": 9172452, "creator": "kaie@kuix.de", "id": 15009090, "text": "Created attachment 9172452\n1641720-v2-with-header.patch\n\nUpdated patch - only change is the proper commit header. Has r=mkmelin"}, {"text": "Created attachment 9172453\n1641720-disable-using-SM2-with-header.patch\n\nUpdated patch - only change is the proper commit header. Has r=mkmelin", "id": 15009092, "creator": "kaie@kuix.de", "attachment_id": 9172453, "creation_time": "2020-08-27T16:32:48Z", "tags": [], "bug_id": 1641720, "is_private": false, "count": 13, "author": "kaie@kuix.de", "time": "2020-08-27T16:32:48Z", "raw_text": "Updated patch - only change is the proper commit header. Has r=mkmelin"}, {"author": "kaie@kuix.de", "is_private": false, "count": 14, "tags": [], "bug_id": 1641720, "raw_text": "OpenPGP correctness, disable certain nonstandard or outdated algorithms, don't give users a false sense of security when using data that involves these algorithms.", "time": "2020-08-27T16:35:48Z", "text": "Comment on attachment 9172452\n1641720-v2-with-header.patch\n\nOpenPGP correctness, disable certain nonstandard or outdated algorithms, don't give users a false sense of security when using data that involves these algorithms.", "id": 15009098, "creation_time": "2020-08-27T16:35:48Z", "attachment_id": 9172452, "creator": "kaie@kuix.de"}, {"id": 15009102, "text": "Comment on attachment 9172453\n1641720-disable-using-SM2-with-header.patch\n\nOpenPGP correctness, don't allow users to actively use keys that are based on nonstandard algorithms.", "attachment_id": 9172453, "creator": "kaie@kuix.de", "creation_time": "2020-08-27T16:36:53Z", "bug_id": 1641720, "tags": [], "count": 15, "is_private": false, "author": "kaie@kuix.de", "time": "2020-08-27T16:36:53Z", "raw_text": "OpenPGP correctness, don't allow users to actively use keys that are based on nonstandard algorithms."}, {"attachment_id": 9172452, "creator": "kaie@kuix.de", "time": "2020-08-27T16:37:26Z", "creation_time": "2020-08-27T16:37:26Z", "raw_text": "Rob, for this patch, can you suggest how we can remember to re-apply this patch locally, whenever updating RNP to newer snapshots?", "count": 16, "is_private": false, "tags": [], "bug_id": 1641720, "author": "kaie@kuix.de", "id": 15009104, "text": "Comment on attachment 9172452\n1641720-v2-with-header.patch\n\nRob, for this patch, can you suggest how we can remember to re-apply this patch locally, whenever updating RNP to newer snapshots?"}, {"tags": [], "bug_id": 1641720, "count": 17, "is_private": false, "author": "kaie@kuix.de", "time": "2020-08-27T17:16:18Z", "raw_text": "81.0b2\n\nhttps://hg.mozilla.org/releases/comm-beta/rev/2cab33d64909409be0ca9b008631fb9dd6dbfa2d\nhttps://hg.mozilla.org/releases/comm-beta/rev/f4512264f8de7d4e9be82f5e542a578ed523db31", "id": 15009173, "text": "81.0b2\n\nhttps://hg.mozilla.org/releases/comm-beta/rev/2cab33d64909409be0ca9b008631fb9dd6dbfa2d\nhttps://hg.mozilla.org/releases/comm-beta/rev/f4512264f8de7d4e9be82f5e542a578ed523db31", "attachment_id": null, "creator": "kaie@kuix.de", "creation_time": "2020-08-27T17:16:18Z"}, {"creator": "rob@thunderbird.net", "attachment_id": null, "creation_time": "2020-08-27T18:16:05Z", "id": 15009311, "text": "(In reply to Kai Engert (:KaiE:) from comment #16)\n> Comment on attachment 9172452\n> 1641720-v2-with-header.patch\n> \n> Rob, for this patch, can you suggest how we can remember to re-apply this patch locally, whenever updating RNP to newer snapshots?\n\nHow about creating a patches directory under third_party and then make changes to the update script to apply the patch after updating from git. I can take care of it if that sounds good.", "time": "2020-08-27T18:16:05Z", "raw_text": "(In reply to Kai Engert (:KaiE:) from comment #16)\n> Comment on attachment 9172452\n> 1641720-v2-with-header.patch\n> \n> Rob, for this patch, can you suggest how we can remember to re-apply this patch locally, whenever updating RNP to newer snapshots?\n\nHow about creating a patches directory under third_party and then make changes to the update script to apply the patch after updating from git. I can take care of it if that sounds good.", "is_private": false, "count": 18, "tags": [], "bug_id": 1641720, "author": "rob@thunderbird.net"}, {"creation_time": "2020-08-27T18:18:51Z", "creator": "rob@thunderbird.net", "attachment_id": 9172452, "id": 15009319, "text": "Comment on attachment 9172452\n1641720-v2-with-header.patch\n\n[Triage Comment]\nApproved by wsmwk via Matrix on 2020-08-27 for 81.0b2.", "raw_text": "[Triage Comment]\nApproved by wsmwk via Matrix on 2020-08-27 for 81.0b2.", "time": "2020-08-27T18:18:51Z", "author": "rob@thunderbird.net", "tags": [], "bug_id": 1641720, "is_private": false, "count": 19}, {"is_private": false, "count": 20, "tags": [], "bug_id": 1641720, "id": 15009321, "text": "Comment on attachment 9172453\n1641720-disable-using-SM2-with-header.patch\n\n[Triage Comment]\nApproved by wsmwk via Matrix on 2020-08-27 for 81.0b2.", "author": "rob@thunderbird.net", "attachment_id": 9172453, "creator": "rob@thunderbird.net", "time": "2020-08-27T18:19:10Z", "creation_time": "2020-08-27T18:19:10Z", "raw_text": "[Triage Comment]\nApproved by wsmwk via Matrix on 2020-08-27 for 81.0b2."}, {"creation_time": "2020-08-27T18:22:25Z", "attachment_id": null, "creator": "kaie@kuix.de", "text": "(In reply to Rob Lemley [:rjl] from comment #18)\n> How about creating a patches directory under third_party and then make changes to the update script to apply the patch after updating from git. I can take care of it if that sounds good.\n\nSounds great, thanks for your help!", "id": 15009328, "raw_text": "(In reply to Rob Lemley [:rjl] from comment #18)\n> How about creating a patches directory under third_party and then make changes to the update script to apply the patch after updating from git. I can take care of it if that sounds good.\n\nSounds great, thanks for your help!", "time": "2020-08-27T18:22:25Z", "author": "kaie@kuix.de", "bug_id": 1641720, "tags": [], "count": 21, "is_private": false}, {"count": 22, "is_private": false, "bug_id": 1641720, "tags": [], "author": "kaie@kuix.de", "time": "2020-08-27T18:23:14Z", "raw_text": "I'm also fine with a need to manually update, because patches might fail to apply. Printing a big reminder at the end of the script would be sufficient for me, if you want to simplify.", "id": 15009330, "text": "I'm also fine with a need to manually update, because patches might fail to apply. Printing a big reminder at the end of the script would be sufficient for me, if you want to simplify.", "attachment_id": null, "creator": "kaie@kuix.de", "creation_time": "2020-08-27T18:23:14Z"}, {"tags": [], "bug_id": 1641720, "is_private": false, "count": 23, "author": "o.nickolay@gmail.com", "time": "2020-08-28T09:57:57Z", "raw_text": "Kai, I created an issue here: https://github.com/rnpgp/rnp/issues/1281\nYou and all others who interested in this discussion are welcome to join!", "text": "Kai, I created an issue here: https://github.com/rnpgp/rnp/issues/1281\nYou and all others who interested in this discussion are welcome to join!", "id": 15010415, "creator": "o.nickolay@gmail.com", "attachment_id": null, "creation_time": "2020-08-28T09:57:57Z"}, {"id": 15010846, "text": "Comment on attachment 9172453\n1641720-disable-using-SM2-with-header.patch\n\n[Triage Comment]\nApproved for esr78", "attachment_id": 9172453, "creator": "vseerror@lehigh.edu", "creation_time": "2020-08-28T14:55:06Z", "bug_id": 1641720, "tags": [], "is_private": false, "count": 24, "author": "vseerror@lehigh.edu", "time": "2020-08-28T14:55:06Z", "raw_text": "[Triage Comment]\nApproved for esr78"}, {"raw_text": "[Triage Comment]\nApproved for esr78", "time": "2020-08-28T14:55:15Z", "author": "vseerror@lehigh.edu", "bug_id": 1641720, "tags": [], "is_private": false, "count": 25, "creation_time": "2020-08-28T14:55:15Z", "creator": "vseerror@lehigh.edu", "attachment_id": 9172452, "text": "Comment on attachment 9172452\n1641720-v2-with-header.patch\n\n[Triage Comment]\nApproved for esr78", "id": 15010848}, {"creation_time": "2020-08-28T15:10:25Z", "attachment_id": null, "creator": "kaie@kuix.de", "id": 15010894, "text": "https://hg.mozilla.org/releases/comm-esr78/rev/fe45272cca54f1b02a7ae543571687347c54ef78\nhttps://hg.mozilla.org/releases/comm-esr78/rev/b547a9c68f9ecae19f4c1bf114498eef15955160\n78.2.1\n\nThis fix is only a part of the intended work. We will a follow-up bug for more actions.\n\nEdit: fixed commit URLs", "raw_text": "https://hg.mozilla.org/releases/comm-esr78/rev/fe45272cca54f1b02a7ae543571687347c54ef78\nhttps://hg.mozilla.org/releases/comm-esr78/rev/b547a9c68f9ecae19f4c1bf114498eef15955160\n78.2.1\n\nThis fix is only a part of the intended work. We will a follow-up bug for more actions.\n\nEdit: fixed commit URLs", "time": "2020-08-28T15:10:25Z", "author": "kaie@kuix.de", "bug_id": 1641720, "tags": [], "is_private": false, "count": 26}]}}, "comments": {}}