{"bugs": {"669120": {"comments": [{"is_private": false, "count": 0, "id": 5572178, "creator": "justin.lebar+bug@gmail.com", "time": "2011-07-04T05:15:40Z", "creation_time": "2011-07-04T05:15:40Z", "author": "justin.lebar+bug@gmail.com", "attachment_id": null, "raw_text": "I'm beginning to think that we should fire a heap-minimize notification when the browser is minimized, and possibly when the browser loses focus (potentially on a timeout -- fire heap-minimize if the browser is minimized or unfocused for more than X seconds).\n\nWe can watch RSS / available memory (as in bug 664291) and minimize our usage only when we believe that memory is tight.  But even if we did a perfect job and always fired a memory-pressure notification when the system was running low on memory, we could still end up holding onto memory when the user isn't actively using FF, if the system isn't out of RAM.\n\nGiving back memory even when we're not actively running low is good for a number of reasons:\n\n * The system gets memory back immediately, instead of after it needs it.  If we wait until memory is low to give up our memory, we may be too late.\n\n * The OS can use the extra memory we give back for buffer caches, potentially speeding up the user's machine.\n\n * A user checking task manager sees that we're using less memory than she would otherwise, and doesn't tell all her friends not to use FF because it's a hog.  (This is not entirely a joke.)\n\nmemory-pressure currently triggers a gc/cc, clears bfcache, and drops all decoded images in inactive tabs, among other things.", "text": "I'm beginning to think that we should fire a heap-minimize notification when the browser is minimized, and possibly when the browser loses focus (potentially on a timeout -- fire heap-minimize if the browser is minimized or unfocused for more than X seconds).\n\nWe can watch RSS / available memory (as in bug 664291) and minimize our usage only when we believe that memory is tight.  But even if we did a perfect job and always fired a memory-pressure notification when the system was running low on memory, we could still end up holding onto memory when the user isn't actively using FF, if the system isn't out of RAM.\n\nGiving back memory even when we're not actively running low is good for a number of reasons:\n\n * The system gets memory back immediately, instead of after it needs it.  If we wait until memory is low to give up our memory, we may be too late.\n\n * The OS can use the extra memory we give back for buffer caches, potentially speeding up the user's machine.\n\n * A user checking task manager sees that we're using less memory than she would otherwise, and doesn't tell all her friends not to use FF because it's a hog.  (This is not entirely a joke.)\n\nmemory-pressure currently triggers a gc/cc, clears bfcache, and drops all decoded images in inactive tabs, among other things.", "bug_id": 669120, "tags": []}, {"attachment_id": null, "raw_text": "For what it's worth, I believe back in the day we used to do this on Windows (in particular, told the OS to minimize our heap).\n\nThat made the OS aggressively swap us out to disk, so restoring from minimized state took a lot longer (order of tens of seconds) than just restarting the browser.\n\nYou may want to look up some of those old bug reports so we can avoid repeating the same mistakes....\n\nNow just firing memory-pressure might be ok, as long as we stay away from the OS-level heap-minimize stuff.", "tags": [], "text": "For what it's worth, I believe back in the day we used to do this on Windows (in particular, told the OS to minimize our heap).\n\nThat made the OS aggressively swap us out to disk, so restoring from minimized state took a lot longer (order of tens of seconds) than just restarting the browser.\n\nYou may want to look up some of those old bug reports so we can avoid repeating the same mistakes....\n\nNow just firing memory-pressure might be ok, as long as we stay away from the OS-level heap-minimize stuff.", "bug_id": 669120, "count": 1, "id": 5572492, "is_private": false, "creation_time": "2011-07-04T12:30:29Z", "time": "2011-07-04T12:30:29Z", "creator": "bzbarsky@mit.edu", "author": "bzbarsky@mit.edu"}, {"author": "n.nethercote@gmail.com", "time": "2011-07-05T01:16:57Z", "creation_time": "2011-07-05T01:16:57Z", "creator": "n.nethercote@gmail.com", "count": 2, "id": 5573246, "is_private": false, "text": "I also wonder if we should have two levels of heap-minimization notifications, and we could fire a weaker one when FF is minimized, and a stronger one when we're close to OOM or paging or whatever.", "bug_id": 669120, "tags": [], "raw_text": "I also wonder if we should have two levels of heap-minimization notifications, and we could fire a weaker one when FF is minimized, and a stronger one when we're close to OOM or paging or whatever.", "attachment_id": null}, {"time": "2011-07-05T15:39:46Z", "creation_time": "2011-07-05T15:39:46Z", "creator": "justin.lebar+bug@gmail.com", "author": "justin.lebar+bug@gmail.com", "id": 5573989, "count": 3, "is_private": false, "bug_id": 669120, "text": "What would one get rid of on the stronger memory-pressure notification that we wouldn't get rid of on the weaker one?\n\nI guess we could unload some tabs when memory is really tight, although I'm not sure we want to go there.", "tags": [], "attachment_id": null, "raw_text": "What would one get rid of on the stronger memory-pressure notification that we wouldn't get rid of on the weaker one?\n\nI guess we could unload some tabs when memory is really tight, although I'm not sure we want to go there."}, {"tags": [], "bug_id": 669120, "text": "(In reply to comment #1)\n> Now just firing memory-pressure might be ok, as long as we stay away from\n> the OS-level heap-minimize stuff.\n\nYeah, I don't think we want to give the OS an excuse to swap us out more than it otherwise would.\n\nI could imagine madvising areas of memory we think are less-important if we notice we're already being swapped out, but that's probably more trouble than it's worth.", "attachment_id": null, "raw_text": "(In reply to comment #1)\n> Now just firing memory-pressure might be ok, as long as we stay away from\n> the OS-level heap-minimize stuff.\n\nYeah, I don't think we want to give the OS an excuse to swap us out more than it otherwise would.\n\nI could imagine madvising areas of memory we think are less-important if we notice we're already being swapped out, but that's probably more trouble than it's worth.", "creation_time": "2011-07-05T15:44:39Z", "time": "2011-07-05T15:44:39Z", "creator": "justin.lebar+bug@gmail.com", "author": "justin.lebar+bug@gmail.com", "id": 5574009, "count": 4, "is_private": false}, {"author": "continuation@gmail.com", "time": "2011-07-05T16:05:16Z", "creation_time": "2011-07-05T16:05:16Z", "creator": "continuation@gmail.com", "id": 5574058, "count": 5, "is_private": false, "text": "Doing a GC/CC while the user is not using the browser has the nice property that pause times are irrelevant.", "bug_id": 669120, "tags": [], "raw_text": "Doing a GC/CC while the user is not using the browser has the nice property that pause times are irrelevant.", "attachment_id": null}, {"raw_text": "I think a fair middle ground is to just do a GC/CC and not drop anything like the image cache/BF cache/etc.", "attachment_id": null, "text": "I think a fair middle ground is to just do a GC/CC and not drop anything like the image cache/BF cache/etc.", "bug_id": 669120, "tags": [], "id": 5587538, "count": 6, "is_private": false, "author": "ehsan.akhgari@gmail.com", "creation_time": "2011-07-12T20:46:38Z", "time": "2011-07-12T20:46:38Z", "creator": "ehsan.akhgari@gmail.com"}, {"bug_id": 669120, "text": "Just to throw out one option: I bet if we cleared bfcache for everything except the current tab, few people would notice.\n\nI think before we can decide whether we want to throw away bfcache, we should figure out how much memory it actually accounts for.", "tags": [], "raw_text": "Just to throw out one option: I bet if we cleared bfcache for everything except the current tab, few people would notice.\n\nI think before we can decide whether we want to throw away bfcache, we should figure out how much memory it actually accounts for.", "attachment_id": null, "author": "justin.lebar+bug@gmail.com", "creator": "justin.lebar+bug@gmail.com", "time": "2011-07-12T20:48:41Z", "creation_time": "2011-07-12T20:48:41Z", "is_private": false, "id": 5587545, "count": 7}, {"is_private": false, "id": 5971554, "count": 8, "author": "n.nethercote@gmail.com", "creator": "n.nethercote@gmail.com", "creation_time": "2012-01-11T10:43:24Z", "time": "2012-01-11T10:43:24Z", "raw_text": "> I think before we can decide whether we want to throw away bfcache, we\n> should figure out how much memory it actually accounts for.\n\nPer-tab memory reporting (bug 687724) will tell us that.", "attachment_id": null, "tags": [], "text": "> I think before we can decide whether we want to throw away bfcache, we\n> should figure out how much memory it actually accounts for.\n\nPer-tab memory reporting (bug 687724) will tell us that.", "bug_id": 669120}]}}, "comments": {}}