{"comments": {}, "bugs": {"696707": {"comments": [{"author": "hsivonen@mozilla.com", "creator": "hsivonen@mozilla.com", "raw_text": "Steps to reproduce:\n 1) Accumulate history for several months.\n 2) Set up Firefox Sync.\n 3) Wait until all your history has been uploaded to the cloud.\n 4) Fill the disk so that the Places database can't be written and gets corrupt.\n 5) Quit Firefox\n 6) Make room on the disk.\n 7) Restart Firefox.\n\nActual results:\nFirefox moves aside the corrupt Places database and starts a new one. New history items are pushed to the cloud but old ones aren't restored. You have to manually use the Reset Sync option with the setting to replace everything on this device to restore history.\n\nExpected results:\nWhen Places database corruption is detected and the old database file is abandoned, expected the new database to be automatically filled with Sync data from the cloud.", "creation_time": "2011-10-24T07:33:34Z", "time": "2011-10-24T07:33:34Z", "attachment_id": null, "text": "Steps to reproduce:\n 1) Accumulate history for several months.\n 2) Set up Firefox Sync.\n 3) Wait until all your history has been uploaded to the cloud.\n 4) Fill the disk so that the Places database can't be written and gets corrupt.\n 5) Quit Firefox\n 6) Make room on the disk.\n 7) Restart Firefox.\n\nActual results:\nFirefox moves aside the corrupt Places database and starts a new one. New history items are pushed to the cloud but old ones aren't restored. You have to manually use the Reset Sync option with the setting to replace everything on this device to restore history.\n\nExpected results:\nWhen Places database corruption is detected and the old database file is abandoned, expected the new database to be automatically filled with Sync data from the cloud.", "id": 5799876, "count": 0, "is_private": false, "tags": [], "bug_id": 696707}, {"author": "mak@mozilla.com", "creator": "mak@mozilla.com", "bug_id": 696707, "id": 5800437, "tags": [], "is_private": false, "count": 1, "attachment_id": null, "time": "2011-10-24T15:22:56Z", "text": "(In reply to Henri Sivonen (:hsivonen) from comment #0)\n> Steps to reproduce:\n>  1) Accumulate history for several months.\n>  2) Set up Firefox Sync.\n>  3) Wait until all your history has been uploaded to the cloud.\n>  4) Fill the disk so that the Places database can't be written and gets\n> corrupt.\n\ncorrupt? or just history bailing out? I'm thinking there may be a bug here, if on startup the database is moved to a .corrupt file, it's likely it thinks it's corrupt, but it's not. May you run PRAGMA integrity_check; on the corrupt file? This bug should be filed apart though.\n\n> Expected results:\n> When Places database corruption is detected and the old database file is\n> abandoned, expected the new database to be automatically filled with Sync\n> data from the cloud.\n\nI'm not sure if we want to restore automatically from Sync (regarding that, I'm moving the bug to Sync, Places is not aware of Sync, but Sync can absolutely restore stuff if it wants), but I'm working on a history backup that will handle this case in bug 431274.", "creation_time": "2011-10-24T15:22:56Z", "raw_text": "(In reply to Henri Sivonen (:hsivonen) from comment #0)\n> Steps to reproduce:\n>  1) Accumulate history for several months.\n>  2) Set up Firefox Sync.\n>  3) Wait until all your history has been uploaded to the cloud.\n>  4) Fill the disk so that the Places database can't be written and gets\n> corrupt.\n\ncorrupt? or just history bailing out? I'm thinking there may be a bug here, if on startup the database is moved to a .corrupt file, it's likely it thinks it's corrupt, but it's not. May you run PRAGMA integrity_check; on the corrupt file? This bug should be filed apart though.\n\n> Expected results:\n> When Places database corruption is detected and the old database file is\n> abandoned, expected the new database to be automatically filled with Sync\n> data from the cloud.\n\nI'm not sure if we want to restore automatically from Sync (regarding that, I'm moving the bug to Sync, Places is not aware of Sync, but Sync can absolutely restore stuff if it wants), but I'm working on a history backup that will handle this case in bug 431274."}, {"id": 5800596, "tags": [], "is_private": false, "count": 2, "bug_id": 696707, "raw_text": "This is expected.\n\nThe timestamps that Sync uses to track records won't be adjusted just because Places can no longer store new data.\n\nIn order to handle this correctly, Places would need to notify us that it's encountered some situation in which records have been lost. (This would have to be different from a bulk delete notification, of course.)\n\nThis isn't a straightforward bug, though: what if malformed Sync data is (indirectly) what's causing the database corruption? Etc. etc.\n\nMarking this as P5 (\"Not critical, but not WONTFIX\") until product has a say.", "creation_time": "2011-10-24T16:20:16Z", "time": "2011-10-24T16:20:16Z", "attachment_id": null, "text": "This is expected.\n\nThe timestamps that Sync uses to track records won't be adjusted just because Places can no longer store new data.\n\nIn order to handle this correctly, Places would need to notify us that it's encountered some situation in which records have been lost. (This would have to be different from a bulk delete notification, of course.)\n\nThis isn't a straightforward bug, though: what if malformed Sync data is (indirectly) what's causing the database corruption? Etc. etc.\n\nMarking this as P5 (\"Not critical, but not WONTFIX\") until product has a say.", "author": "bugzilla@twinql.com", "creator": "bugzilla@twinql.com"}, {"time": "2011-10-24T16:26:41Z", "attachment_id": null, "text": "(In reply to Richard Newman [:rnewman] from comment #2)\n> In order to handle this correctly, Places would need to notify us that it's\n> encountered some situation in which records have been lost. (This would have\n> to be different from a bulk delete notification, of course.)\n\nYou may check history.databaseStatus to check if it's reporting corrupt. If it is, the database has been replaced.", "creation_time": "2011-10-24T16:26:41Z", "raw_text": "(In reply to Richard Newman [:rnewman] from comment #2)\n> In order to handle this correctly, Places would need to notify us that it's\n> encountered some situation in which records have been lost. (This would have\n> to be different from a bulk delete notification, of course.)\n\nYou may check history.databaseStatus to check if it's reporting corrupt. If it is, the database has been replaced.", "bug_id": 696707, "id": 5800615, "is_private": false, "count": 3, "tags": [], "author": "mak@mozilla.com", "creator": "mak@mozilla.com"}, {"bug_id": 696707, "id": 5803034, "is_private": false, "count": 4, "tags": [], "time": "2011-10-25T14:00:59Z", "attachment_id": null, "text": "(In reply to Marco Bonardo [:mak] from comment #1)\n> corrupt?\n\nThere's places.sqlite.corrupt in my profile dir.\n\n> May you run PRAGMA integrity_check; on the corrupt file?\n\nHow do I do that?", "creation_time": "2011-10-25T14:00:59Z", "raw_text": "(In reply to Marco Bonardo [:mak] from comment #1)\n> corrupt?\n\nThere's places.sqlite.corrupt in my profile dir.\n\n> May you run PRAGMA integrity_check; on the corrupt file?\n\nHow do I do that?", "author": "hsivonen@mozilla.com", "creator": "hsivonen@mozilla.com"}, {"creator": "mak@mozilla.com", "text": "(In reply to Henri Sivonen (:hsivonen) from comment #4)\n> > May you run PRAGMA integrity_check; on the corrupt file?\n> \n> How do I do that?\n\nopen the .corrupt file with sqlite shell (downloadable from here http://www.sqlite.org/download.html) or SQLite manager add-on and execute it like a query.", "author": "mak@mozilla.com", "attachment_id": null, "time": "2011-10-25T14:04:47Z", "raw_text": "(In reply to Henri Sivonen (:hsivonen) from comment #4)\n> > May you run PRAGMA integrity_check; on the corrupt file?\n> \n> How do I do that?\n\nopen the .corrupt file with sqlite shell (downloadable from here http://www.sqlite.org/download.html) or SQLite manager add-on and execute it like a query.", "creation_time": "2011-10-25T14:04:47Z", "bug_id": 696707, "tags": [], "is_private": false, "count": 5, "id": 5803042}, {"author": "hsivonen@mozilla.com", "creator": "hsivonen@mozilla.com", "bug_id": 696707, "id": 5803104, "tags": [], "is_private": false, "count": 6, "time": "2011-10-25T14:34:18Z", "attachment_id": null, "text": "$ sqlite places.sqlite.corrupt \nUnable to open database \"places.sqlite.corrupt\": file is encrypted or is not a database\n\nless shows that the file starts with \"SQLite format 3\".", "creation_time": "2011-10-25T14:34:18Z", "raw_text": "$ sqlite places.sqlite.corrupt \nUnable to open database \"places.sqlite.corrupt\": file is encrypted or is not a database\n\nless shows that the file starts with \"SQLite format 3\"."}, {"text": "ugh, that sounds badly corrupt.", "time": "2011-10-25T14:40:30Z", "attachment_id": null, "creation_time": "2011-10-25T14:40:30Z", "raw_text": "ugh, that sounds badly corrupt.", "bug_id": 696707, "is_private": false, "count": 7, "tags": [], "id": 5803123, "creator": "mak@mozilla.com", "author": "mak@mozilla.com"}]}}}