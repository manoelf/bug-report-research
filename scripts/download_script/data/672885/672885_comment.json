{"bugs": {"672885": {"comments": [{"is_private": false, "count": 0, "id": 5602377, "creator": "jmathies@mozilla.com", "time": "2011-07-20T18:44:11Z", "creation_time": "2011-07-20T18:44:11Z", "author": "jmathies@mozilla.com", "attachment_id": 547183, "raw_text": "", "bug_id": 672885, "text": "Created attachment 547183\ntest app", "tags": []}, {"is_private": false, "id": 5602382, "count": 1, "author": "jmathies@mozilla.com", "creator": "jmathies@mozilla.com", "creation_time": "2011-07-20T18:45:35Z", "time": "2011-07-20T18:45:35Z", "raw_text": "A little background \u2013 this shows up with the patches in bug Bug 590945 applied to trunk. Originally I figured the problem I\u2019m seeing was the result of a bug in my patches, but after a great deal of testing I\u2019ve come to the conclusion this is either :\n\n1) a bug in Windows\n2) a bug in the order / way we render using D3D9 and 10\n\nAt a basic level the patches in bug 590945 handle the WM_NCCALCSIZE event and set the desired client area equal to the window area which allows us to render to the entire window surface. The simplest way to accomplish this is to not do any processing in calc size:\n\ncalc size params:\n\n// before:\n// rgrc[0]: the proposed new window coordinates\n// rgrc[1]: the current window cordinates\n// rgrc[2]: the source client area coordinates\n// pncsp->lppos: move/size data\n// after:\n// rgrc[0]: the new client coordinates\n// rgrc[1]: the client destination coordinates\n// rgrc[2]: the client source coordinates\n\nIf rgrc[0] remains unchanged, and we return 0 as the result, Windows will remove all the non-client areas and send us a paint message with an hdc equal to the surface of the window.\n\nAttached is sample, stand alone app that has a \u201cripped out\u201d version of DeviceManagerD3D9 and SwapChainD3D9. The code doesn\u2019t render anything, it simply clears the surface and swaps the back buffer. I\u2019ve kept as much of the initialization and setup code as I can. The same problem I found with my patches shows up in the sample app.\n\nI\u2019m tempted to submit a support request with MS on this, since I think cause #1 is the most likely. But I figured I better run this past Gfx folks first, maybe you all can spot something obvious I can\u2019t. At the very least please compile the sample and see if you can reproduce. STR:\n\n1) run the app\n2) grab an edge and resize the window out as large as possible\n3) keep resizing in and out\n\nYou should see the flickering where the background (non-painted to surface w/glass) shows through.", "attachment_id": null, "tags": [], "text": "A little background \u2013 this shows up with the patches in bug Bug 590945 applied to trunk. Originally I figured the problem I\u2019m seeing was the result of a bug in my patches, but after a great deal of testing I\u2019ve come to the conclusion this is either :\n\n1) a bug in Windows\n2) a bug in the order / way we render using D3D9 and 10\n\nAt a basic level the patches in bug 590945 handle the WM_NCCALCSIZE event and set the desired client area equal to the window area which allows us to render to the entire window surface. The simplest way to accomplish this is to not do any processing in calc size:\n\ncalc size params:\n\n// before:\n// rgrc[0]: the proposed new window coordinates\n// rgrc[1]: the current window cordinates\n// rgrc[2]: the source client area coordinates\n// pncsp->lppos: move/size data\n// after:\n// rgrc[0]: the new client coordinates\n// rgrc[1]: the client destination coordinates\n// rgrc[2]: the client source coordinates\n\nIf rgrc[0] remains unchanged, and we return 0 as the result, Windows will remove all the non-client areas and send us a paint message with an hdc equal to the surface of the window.\n\nAttached is sample, stand alone app that has a \u201cripped out\u201d version of DeviceManagerD3D9 and SwapChainD3D9. The code doesn\u2019t render anything, it simply clears the surface and swaps the back buffer. I\u2019ve kept as much of the initialization and setup code as I can. The same problem I found with my patches shows up in the sample app.\n\nI\u2019m tempted to submit a support request with MS on this, since I think cause #1 is the most likely. But I figured I better run this past Gfx folks first, maybe you all can spot something obvious I can\u2019t. At the very least please compile the sample and see if you can reproduce. STR:\n\n1) run the app\n2) grab an edge and resize the window out as large as possible\n3) keep resizing in and out\n\nYou should see the flickering where the background (non-painted to surface w/glass) shows through.", "bug_id": 672885}, {"creator": "jmathies@mozilla.com", "creation_time": "2011-07-20T20:21:25Z", "time": "2011-07-20T20:21:25Z", "author": "jmathies@mozilla.com", "is_private": false, "count": 2, "id": 5602644, "tags": [], "bug_id": 672885, "text": "Created attachment 547217\ntest app\n\ncleaned sample app.", "attachment_id": 547217, "raw_text": "cleaned sample app."}, {"bug_id": 672885, "text": "Kai suggested on IRC we could try disabling acceleration during resize operations. I'm interested in pursuing that as a possible fix, assuming no one sees any major issues with doing so..", "tags": [], "attachment_id": null, "raw_text": "Kai suggested on IRC we could try disabling acceleration during resize operations. I'm interested in pursuing that as a possible fix, assuming no one sees any major issues with doing so..", "creation_time": "2011-08-03T17:50:38Z", "time": "2011-08-03T17:50:38Z", "creator": "jmathies@mozilla.com", "author": "jmathies@mozilla.com", "id": 5630863, "count": 3, "is_private": false}, {"time": "2011-08-04T01:08:47Z", "creation_time": "2011-08-04T01:08:47Z", "creator": "roc@ocallahan.org", "author": "roc@ocallahan.org", "count": 4, "id": 5632086, "is_private": false, "bug_id": 672885, "text": "It should work. You'll want to check carefully how performance is affected, especially when we're doing stuff with canvas and HTML video which may start requiring readback from the GPU.", "tags": [], "attachment_id": null, "raw_text": "It should work. You'll want to check carefully how performance is affected, especially when we're doing stuff with canvas and HTML video which may start requiring readback from the GPU."}, {"attachment_id": 552491, "raw_text": "This worked out pretty well. Our resize performance was never very good with d2d/d3d which is improved by these changes, and of course the flicker problem is fixed. The big trick was detecting start and end of the resize which is hit or miss on windows, but the combination wm_sizing events, a timer, and a check of the mouse state seems to do the trick. \n\nI took this for a spin on some of the ie9 demos, it behaves as expected. Performance drops during the resize then ticks back up as soon as you release the mouse.\n\nI'll have try builds in a bit.", "bug_id": 672885, "text": "Created attachment 552491\nsizing patch v.1\n\nThis worked out pretty well. Our resize performance was never very good with d2d/d3d which is improved by these changes, and of course the flicker problem is fixed. The big trick was detecting start and end of the resize which is hit or miss on windows, but the combination wm_sizing events, a timer, and a check of the mouse state seems to do the trick. \n\nI took this for a spin on some of the ie9 demos, it behaves as expected. Performance drops during the resize then ticks back up as soon as you release the mouse.\n\nI'll have try builds in a bit.", "tags": [], "count": 5, "id": 5648504, "is_private": false, "time": "2011-08-11T20:38:29Z", "creation_time": "2011-08-11T20:38:29Z", "creator": "jmathies@mozilla.com", "author": "jmathies@mozilla.com"}, {"bug_id": 672885, "text": "try builds:\nhttp://ftp.mozilla.org/pub/mozilla.org/firefox/try-builds/jmathies@mozilla.com-007935287928\n\nI need to update this slightly to address a case where users resize the window prior to the toolkit delayed accel timer firing, and cases where callers request a persistent layer backend.", "tags": [], "attachment_id": null, "raw_text": "try builds:\nhttp://ftp.mozilla.org/pub/mozilla.org/firefox/try-builds/jmathies@mozilla.com-007935287928\n\nI need to update this slightly to address a case where users resize the window prior to the toolkit delayed accel timer firing, and cases where callers request a persistent layer backend.", "time": "2011-08-12T09:56:53Z", "creation_time": "2011-08-12T09:56:53Z", "creator": "jmathies@mozilla.com", "author": "jmathies@mozilla.com", "count": 6, "id": 5649610, "is_private": false}, {"raw_text": "updates:\n- deal with early resize prior to sAllowD3D9 being flipped\n- ignore layers created with LAYER_MANAGER_PERSISTENT\n- always flush layer manager after the resize completes", "attachment_id": 552627, "bug_id": 672885, "text": "Created attachment 552627\nsizing patch v.2\n\nupdates:\n- deal with early resize prior to sAllowD3D9 being flipped\n- ignore layers created with LAYER_MANAGER_PERSISTENT\n- always flush layer manager after the resize completes", "tags": [], "count": 7, "id": 5649627, "is_private": false, "author": "jmathies@mozilla.com", "creation_time": "2011-08-12T10:24:16Z", "time": "2011-08-12T10:24:16Z", "creator": "jmathies@mozilla.com"}, {"id": 5649651, "count": 8, "is_private": false, "time": "2011-08-12T10:54:11Z", "creation_time": "2011-08-12T10:54:11Z", "creator": "bas@basschouten.com", "author": "bas@basschouten.com", "attachment_id": null, "raw_text": "Does this work at all when there's a canvas being used? At the very least it'll make it very slow. It should work I guess, with readback.\n\nIE9 demo's actually slow down while resizing on normal builds, so that doesn't mean much. Note that the canvas should remain accelerated in this situation so any additional slowdown should only be due to read back.\n\nWhat happens with the font cache since this would essentially make us switch from DirectWrite, to GDI, and back to DirectWrite, presumably font rendering would go through all kinds of nasty fallback paths?\n\nAdditional concerns would be the recreation of the D3D10 device upon finishing the resize, an operation which takes in the order of milliseconds, and create a device that may be incompatible with any allocated canvases. (although they should probably hit some readback scheme that should still work)\n\nNote that persistent layer manager usage doesn't 'really' work here, as the layer manager is still recreated, and users of that API don't -actually- get a persistent layer manager at all, since they'll end up with a new one now after resize.\n\nA quick investigation with the try-server build also indicates the window is never actually returned to D3D10 layers (just by using about:support). Indeed if I try and use it on FishIE tank at 1000 fish. The canvas simply goes white at resize and remains that way.\n\nOn the upside there does seem to be a little perf increase in resizing though (as expected), or at least what happens to the new area when upsizing looks a little prettier in GDI than with D3D10.\n\nI'm pretty sure my list of concerns is much longer than this\n\nAlso what did MS have to say on this? I've only got my laptop here but your sample app runs super-smooth for me (that is, if it's meant to show a smooth, resizing, purple rectangle with a wide glass margin). Resizing is so smooth actually, I feel I should profile what makes firefox slow. I'll try and address the bug if hardware at home reproduces the problem as this hack would make me extremely unhappy (sorry for not speaking up earlier, I seem to have lost track of this bug). If we do need to implement this hack, let's figure out on which hardware this bug occurs and strictly implement it there.", "tags": [], "text": "Does this work at all when there's a canvas being used? At the very least it'll make it very slow. It should work I guess, with readback.\n\nIE9 demo's actually slow down while resizing on normal builds, so that doesn't mean much. Note that the canvas should remain accelerated in this situation so any additional slowdown should only be due to read back.\n\nWhat happens with the font cache since this would essentially make us switch from DirectWrite, to GDI, and back to DirectWrite, presumably font rendering would go through all kinds of nasty fallback paths?\n\nAdditional concerns would be the recreation of the D3D10 device upon finishing the resize, an operation which takes in the order of milliseconds, and create a device that may be incompatible with any allocated canvases. (although they should probably hit some readback scheme that should still work)\n\nNote that persistent layer manager usage doesn't 'really' work here, as the layer manager is still recreated, and users of that API don't -actually- get a persistent layer manager at all, since they'll end up with a new one now after resize.\n\nA quick investigation with the try-server build also indicates the window is never actually returned to D3D10 layers (just by using about:support). Indeed if I try and use it on FishIE tank at 1000 fish. The canvas simply goes white at resize and remains that way.\n\nOn the upside there does seem to be a little perf increase in resizing though (as expected), or at least what happens to the new area when upsizing looks a little prettier in GDI than with D3D10.\n\nI'm pretty sure my list of concerns is much longer than this\n\nAlso what did MS have to say on this? I've only got my laptop here but your sample app runs super-smooth for me (that is, if it's meant to show a smooth, resizing, purple rectangle with a wide glass margin). Resizing is so smooth actually, I feel I should profile what makes firefox slow. I'll try and address the bug if hardware at home reproduces the problem as this hack would make me extremely unhappy (sorry for not speaking up earlier, I seem to have lost track of this bug). If we do need to implement this hack, let's figure out on which hardware this bug occurs and strictly implement it there.", "bug_id": 672885}, {"raw_text": "(In reply to Bas Schouten (:bas) from comment #8)\n> Does this work at all when there's a canvas being used? At the very least\n> it'll make it very slow. It should work I guess, with readback.\n> \n\nIsn't this why we have LAYER_MANAGER_PERSISTENT? This is set on layers created for Canvas via nsContentUtils's PersistentLayerManagerForDocument, AFAICT.\n\n> What happens with the font cache since this would essentially make us switch\n> from DirectWrite, to GDI, and back to DirectWrite, presumably font rendering\n> would go through all kinds of nasty fallback paths?\n\nNot sure but I'll see if I can track down an answer.\n\n> Additional concerns would be the recreation of the D3D10 device upon\n> finishing the resize, an operation which takes in the order of milliseconds,\n> and create a device that may be incompatible with any allocated canvases.\n> (although they should probably hit some readback scheme that should still\n> work)\n\nSeems this is unavoidable. I might be able to cache the layer manager in use temporarily. This is a little tricky with our existing startup delay. Overall though a millisecond restart after a resize shouldn't be a major issue, it's unlikely they'll do much else with the window immediately after resizing, which offers enough time for the device to reset unnoticeably.\n \n> \n> Note that persistent layer manager usage doesn't 'really' work here, as the\n> layer manager is still recreated, and users of that API don't -actually- get\n> a persistent layer manager at all, since they'll end up with a new one now\n> after resize.\n\nI need to fix that, OnWindowSizing() should check the persistent state of the layer first.\n\n> \n> A quick investigation with the try-server build also indicates the window is\n> never actually returned to D3D10 layers (just by using about:support).\n> Indeed if I try and use it on FishIE tank at 1000 fish. The canvas simply\n> goes white at resize and remains that way.\n\nThat's fixed in v.2 patch, I'll have a new try server build here in a few hours.\n\n> Also what did MS have to say on this? I've only got my laptop here but your\n> sample app runs super-smooth for me (that is, if it's meant to show a\n> smooth, resizing, purple rectangle with a wide glass margin). Resizing is so\n> smooth actually, I feel I should profile what makes firefox slow. I'll try\n> and address the bug if hardware at home reproduces the problem as this hack\n> would make me extremely unhappy (sorry for not speaking up earlier, I seem\n> to have lost track of this bug). If we do need to implement this hack, let's\n> figure out on which hardware this bug occurs and strictly implement it there.\n\nAs far as MS goes, I haven't taken this to them (yet). Do you feel we should or just try to deal with this internally?\n\nIn your testing, did you resize the window out to a very large size and waver back and forth? You should see a flickering. If not, you're one of the few people who hasn't reproduced this yet. :) I've tested on vmware with a forced accel, my laptop, and my desktop, and I see it every time. It's most noticeable \nwith large windows.", "attachment_id": null, "text": "(In reply to Bas Schouten (:bas) from comment #8)\n> Does this work at all when there's a canvas being used? At the very least\n> it'll make it very slow. It should work I guess, with readback.\n> \n\nIsn't this why we have LAYER_MANAGER_PERSISTENT? This is set on layers created for Canvas via nsContentUtils's PersistentLayerManagerForDocument, AFAICT.\n\n> What happens with the font cache since this would essentially make us switch\n> from DirectWrite, to GDI, and back to DirectWrite, presumably font rendering\n> would go through all kinds of nasty fallback paths?\n\nNot sure but I'll see if I can track down an answer.\n\n> Additional concerns would be the recreation of the D3D10 device upon\n> finishing the resize, an operation which takes in the order of milliseconds,\n> and create a device that may be incompatible with any allocated canvases.\n> (although they should probably hit some readback scheme that should still\n> work)\n\nSeems this is unavoidable. I might be able to cache the layer manager in use temporarily. This is a little tricky with our existing startup delay. Overall though a millisecond restart after a resize shouldn't be a major issue, it's unlikely they'll do much else with the window immediately after resizing, which offers enough time for the device to reset unnoticeably.\n \n> \n> Note that persistent layer manager usage doesn't 'really' work here, as the\n> layer manager is still recreated, and users of that API don't -actually- get\n> a persistent layer manager at all, since they'll end up with a new one now\n> after resize.\n\nI need to fix that, OnWindowSizing() should check the persistent state of the layer first.\n\n> \n> A quick investigation with the try-server build also indicates the window is\n> never actually returned to D3D10 layers (just by using about:support).\n> Indeed if I try and use it on FishIE tank at 1000 fish. The canvas simply\n> goes white at resize and remains that way.\n\nThat's fixed in v.2 patch, I'll have a new try server build here in a few hours.\n\n> Also what did MS have to say on this? I've only got my laptop here but your\n> sample app runs super-smooth for me (that is, if it's meant to show a\n> smooth, resizing, purple rectangle with a wide glass margin). Resizing is so\n> smooth actually, I feel I should profile what makes firefox slow. I'll try\n> and address the bug if hardware at home reproduces the problem as this hack\n> would make me extremely unhappy (sorry for not speaking up earlier, I seem\n> to have lost track of this bug). If we do need to implement this hack, let's\n> figure out on which hardware this bug occurs and strictly implement it there.\n\nAs far as MS goes, I haven't taken this to them (yet). Do you feel we should or just try to deal with this internally?\n\nIn your testing, did you resize the window out to a very large size and waver back and forth? You should see a flickering. If not, you're one of the few people who hasn't reproduced this yet. :) I've tested on vmware with a forced accel, my laptop, and my desktop, and I see it every time. It's most noticeable \nwith large windows.", "bug_id": 672885, "tags": [], "is_private": false, "count": 9, "id": 5649727, "author": "jmathies@mozilla.com", "creator": "jmathies@mozilla.com", "creation_time": "2011-08-12T12:26:35Z", "time": "2011-08-12T12:26:35Z"}, {"attachment_id": null, "raw_text": "Actually it looks like BaseWidget already support the idea of flipping to a basic layer manager on the fly via AutoUseBasicLayerManager. So maybe I can make use of that in flipping back and forth.", "text": "Actually it looks like BaseWidget already support the idea of flipping to a basic layer manager on the fly via AutoUseBasicLayerManager. So maybe I can make use of that in flipping back and forth.", "bug_id": 672885, "tags": [], "is_private": false, "id": 5649732, "count": 10, "creator": "jmathies@mozilla.com", "time": "2011-08-12T12:35:24Z", "creation_time": "2011-08-12T12:35:24Z", "author": "jmathies@mozilla.com"}, {"attachment_id": null, "raw_text": "Another try build should be up in a few hours:\n\nhttps://ftp.mozilla.org/pub/mozilla.org/firefox/try-builds/jmathies@mozilla.com-cf20166887da/\n\nFor testing purposes this build has a pref that turns the resize feature on and off @ \"gfx.enableresizequirk\". This defaults to true (enabled). There's no observer so you have to restart for changes to take effect.\n\nI find resize performance improves quite a bit with this feature on. Something about GDI on my system that handles resizing the rendering surface better.\n\nThis should also make it easy to reproduce the paint bug which shows up clearly in fx proper with the patches in bug 590945 applied.", "tags": [], "bug_id": 672885, "text": "Another try build should be up in a few hours:\n\nhttps://ftp.mozilla.org/pub/mozilla.org/firefox/try-builds/jmathies@mozilla.com-cf20166887da/\n\nFor testing purposes this build has a pref that turns the resize feature on and off @ \"gfx.enableresizequirk\". This defaults to true (enabled). There's no observer so you have to restart for changes to take effect.\n\nI find resize performance improves quite a bit with this feature on. Something about GDI on my system that handles resizing the rendering surface better.\n\nThis should also make it easy to reproduce the paint bug which shows up clearly in fx proper with the patches in bug 590945 applied.", "is_private": false, "count": 11, "id": 5650619, "creator": "jmathies@mozilla.com", "time": "2011-08-12T19:07:28Z", "creation_time": "2011-08-12T19:07:28Z", "author": "jmathies@mozilla.com"}, {"id": 5654107, "count": 12, "attachment_id": 553175, "is_private": false, "raw_text": "", "time": "2011-08-15T14:53:27Z", "creation_time": "2011-08-15T14:53:27Z", "creator": "jmathies@mozilla.com", "text": "Created attachment 553175\ncurrent patch", "bug_id": 672885, "tags": [], "author": "jmathies@mozilla.com"}, {"creation_time": "2011-08-15T15:43:28Z", "time": "2011-08-15T15:43:28Z", "creator": "jmathies@mozilla.com", "author": "jmathies@mozilla.com", "id": 5654220, "count": 13, "is_private": false, "text": "I'm doing some testing with nsHTMLMediaElement's today and noticed some odd behavior. One thing I've noticed is we request LAYER_MANAGER_PERSISTENT after the initial layer is setup, which my current fix will ignore. Also independent of the fix I've posted here, displaying webm video in a tab generates a lot of these asserts:\n\n###!!! ASSERTION: Nv3DVStreaming Nv3DVControl failed: 'rv', file f:/Mozilla/firefox/mc/gfx/layers/d3d9/Nv3DVUtils.cpp, line 150\n\n###!!! ASSERTION: mFramesWithLayers out of sync: '!props.Get(DisplayItemDataProperty())', file f:/Mozilla/firefox/mc/layout/base/FrameLayerBuilder.cpp, line 677\n\nwhich doesn't seem good.\n\nThis is the test case I'm working with:\n\nhttp://www.mozilla.com/en-US/firefox/video/\n\nWill keep investigating..", "bug_id": 672885, "tags": [], "attachment_id": null, "raw_text": "I'm doing some testing with nsHTMLMediaElement's today and noticed some odd behavior. One thing I've noticed is we request LAYER_MANAGER_PERSISTENT after the initial layer is setup, which my current fix will ignore. Also independent of the fix I've posted here, displaying webm video in a tab generates a lot of these asserts:\n\n###!!! ASSERTION: Nv3DVStreaming Nv3DVControl failed: 'rv', file f:/Mozilla/firefox/mc/gfx/layers/d3d9/Nv3DVUtils.cpp, line 150\n\n###!!! ASSERTION: mFramesWithLayers out of sync: '!props.Get(DisplayItemDataProperty())', file f:/Mozilla/firefox/mc/layout/base/FrameLayerBuilder.cpp, line 677\n\nwhich doesn't seem good.\n\nThis is the test case I'm working with:\n\nhttp://www.mozilla.com/en-US/firefox/video/\n\nWill keep investigating.."}, {"raw_text": "(In reply to Jim Mathies [:jimm] from comment #9)\n> (In reply to Bas Schouten (:bas) from comment #8)\n> > Also what did MS have to say on this? I've only got my laptop here but your\n> > sample app runs super-smooth for me (that is, if it's meant to show a\n> > smooth, resizing, purple rectangle with a wide glass margin). Resizing is so\n> > smooth actually, I feel I should profile what makes firefox slow. I'll try\n> > and address the bug if hardware at home reproduces the problem as this hack\n> > would make me extremely unhappy (sorry for not speaking up earlier, I seem\n> > to have lost track of this bug). If we do need to implement this hack, let's\n> > figure out on which hardware this bug occurs and strictly implement it there.\n> \n> As far as MS goes, I haven't taken this to them (yet). Do you feel we should\n> or just try to deal with this internally?\n\nYes we should! This patch (if needed) is absolutely terrible!\n\n> \n> In your testing, did you resize the window out to a very large size and\n> waver back and forth? You should see a flickering. If not, you're one of the\n> few people who hasn't reproduced this yet. :) I've tested on vmware with a\n> forced accel, my laptop, and my desktop, and I see it every time. It's most\n> noticeable \n> with large windows.\n\nI tried my different machines, I see a very occasional black flicker on one of my NVidia machines (GT230M). Nothing on my ATI cards.", "attachment_id": null, "tags": [], "bug_id": 672885, "text": "(In reply to Jim Mathies [:jimm] from comment #9)\n> (In reply to Bas Schouten (:bas) from comment #8)\n> > Also what did MS have to say on this? I've only got my laptop here but your\n> > sample app runs super-smooth for me (that is, if it's meant to show a\n> > smooth, resizing, purple rectangle with a wide glass margin). Resizing is so\n> > smooth actually, I feel I should profile what makes firefox slow. I'll try\n> > and address the bug if hardware at home reproduces the problem as this hack\n> > would make me extremely unhappy (sorry for not speaking up earlier, I seem\n> > to have lost track of this bug). If we do need to implement this hack, let's\n> > figure out on which hardware this bug occurs and strictly implement it there.\n> \n> As far as MS goes, I haven't taken this to them (yet). Do you feel we should\n> or just try to deal with this internally?\n\nYes we should! This patch (if needed) is absolutely terrible!\n\n> \n> In your testing, did you resize the window out to a very large size and\n> waver back and forth? You should see a flickering. If not, you're one of the\n> few people who hasn't reproduced this yet. :) I've tested on vmware with a\n> forced accel, my laptop, and my desktop, and I see it every time. It's most\n> noticeable \n> with large windows.\n\nI tried my different machines, I see a very occasional black flicker on one of my NVidia machines (GT230M). Nothing on my ATI cards.", "id": 5654242, "count": 14, "is_private": false, "author": "bas@basschouten.com", "creation_time": "2011-08-15T15:50:40Z", "time": "2011-08-15T15:50:40Z", "creator": "bas@basschouten.com"}, {"is_private": false, "id": 5654271, "count": 15, "creator": "jmathies@mozilla.com", "creation_time": "2011-08-15T16:02:38Z", "time": "2011-08-15T16:02:38Z", "author": "jmathies@mozilla.com", "attachment_id": null, "raw_text": "(In reply to Bas Schouten (:bas) from comment #14)\n> > As far as MS goes, I haven't taken this to them (yet). Do you feel we should\n> > or just try to deal with this internally?\n> \n> Yes we should! This patch (if needed) is absolutely terrible!\n\nWhat is terrible about it? We have support in base widget for doing this, we just aren't using it on windows. Clearly we've had a need for it at some point. The fix also improves resize redraw performance on my system. That seems like a pretty big win to me.\n\n> \n> > \n> > In your testing, did you resize the window out to a very large size and\n> > waver back and forth? You should see a flickering. If not, you're one of the\n> > few people who hasn't reproduced this yet. :) I've tested on vmware with a\n> > forced accel, my laptop, and my desktop, and I see it every time. It's most\n> > noticeable \n> > with large windows.\n> \n> I tried my different machines, I see a very occasional black flicker on one\n> of my NVidia machines (GT230M). Nothing on my ATI cards.\n\nThat sounds like what I'm seeing. Although it's not occasional for me, it's pretty much constant. I have a cinema display and it's most noticeable at window widths > 2000. Unfortunately I haven't had any luck making a recording of it. Screen capture software seems to fix the problem.", "tags": [], "bug_id": 672885, "text": "(In reply to Bas Schouten (:bas) from comment #14)\n> > As far as MS goes, I haven't taken this to them (yet). Do you feel we should\n> > or just try to deal with this internally?\n> \n> Yes we should! This patch (if needed) is absolutely terrible!\n\nWhat is terrible about it? We have support in base widget for doing this, we just aren't using it on windows. Clearly we've had a need for it at some point. The fix also improves resize redraw performance on my system. That seems like a pretty big win to me.\n\n> \n> > \n> > In your testing, did you resize the window out to a very large size and\n> > waver back and forth? You should see a flickering. If not, you're one of the\n> > few people who hasn't reproduced this yet. :) I've tested on vmware with a\n> > forced accel, my laptop, and my desktop, and I see it every time. It's most\n> > noticeable \n> > with large windows.\n> \n> I tried my different machines, I see a very occasional black flicker on one\n> of my NVidia machines (GT230M). Nothing on my ATI cards.\n\nThat sounds like what I'm seeing. Although it's not occasional for me, it's pretty much constant. I have a cinema display and it's most noticeable at window widths > 2000. Unfortunately I haven't had any luck making a recording of it. Screen capture software seems to fix the problem."}, {"tags": [], "bug_id": 672885, "text": "With your test app I see the purple background flicker every 2-3 seconds as I am resizing back and forth.\n\nI do not see any flicker at all in the glass though.\n\nI'm using a MacBook Pro NVIDIA GeForce GT 330M W/ DirecTX 11\nResolution: 1920x1200", "raw_text": "With your test app I see the purple background flicker every 2-3 seconds as I am resizing back and forth.\n\nI do not see any flicker at all in the glass though.\n\nI'm using a MacBook Pro NVIDIA GeForce GT 330M W/ DirecTX 11\nResolution: 1920x1200", "attachment_id": null, "author": "netzen@gmail.com", "creator": "netzen@gmail.com", "time": "2011-08-15T16:17:53Z", "creation_time": "2011-08-15T16:17:53Z", "is_private": false, "id": 5654315, "count": 16}, {"text": "Chatted with bsmedberg about this today, we're going to file off a support request to see if we can get a definitive answer from ms on the cause.", "bug_id": 672885, "tags": [], "raw_text": "Chatted with bsmedberg about this today, we're going to file off a support request to see if we can get a definitive answer from ms on the cause.", "attachment_id": null, "author": "jmathies@mozilla.com", "time": "2011-08-15T19:02:09Z", "creation_time": "2011-08-15T19:02:09Z", "creator": "jmathies@mozilla.com", "id": 5654821, "count": 17, "is_private": false}, {"author": "jmathies@mozilla.com", "creation_time": "2011-08-15T20:47:07Z", "time": "2011-08-15T20:47:07Z", "creator": "jmathies@mozilla.com", "count": 18, "id": 5655098, "is_private": false, "tags": [], "text": "Created attachment 553256\ntest app plus release exe", "bug_id": 672885, "raw_text": "", "attachment_id": 553256}, {"is_private": false, "count": 19, "id": 5655685, "creator": "bas@basschouten.com", "creation_time": "2011-08-16T00:01:53Z", "time": "2011-08-16T00:01:53Z", "author": "bas@basschouten.com", "attachment_id": null, "raw_text": "(In reply to Jim Mathies [:jimm] from comment #15)\n> (In reply to Bas Schouten (:bas) from comment #14)\n> > > As far as MS goes, I haven't taken this to them (yet). Do you feel we should\n> > > or just try to deal with this internally?\n> > \n> > Yes we should! This patch (if needed) is absolutely terrible!\n> \n> What is terrible about it? We have support in base widget for doing this, we\n> just aren't using it on windows. Clearly we've had a need for it at some\n> point. The fix also improves resize redraw performance on my system. That\n> seems like a pretty big win to me.\n\nThe fact we recreate layer managers and associated resources. The whole point is of drawing to be consistent. Not switching back between different modes, as we move forward and we want layer managers to do things like off main-thread composition and persistent, layers driven animation through user-interaction, etc. Switching them on resizes will make everything harder in the future. At the very least it should only be a temporary solution.\n\nFwiw, the fact that resize redraw performance becomes better on your system is bad, we should profile where the time is spent in the D3D case and try to fix it :( (I'm worried it might be texture recreation, in which case there might not be much we can do - except reuse textures in a smarter manner). We shouldn't need to spend so much time there as your test app resizes quite smooth even on my slower machines.\n\n> \n> > \n> > > \n> > > In your testing, did you resize the window out to a very large size and\n> > > waver back and forth? You should see a flickering. If not, you're one of the\n> > > few people who hasn't reproduced this yet. :) I've tested on vmware with a\n> > > forced accel, my laptop, and my desktop, and I see it every time. It's most\n> > > noticeable \n> > > with large windows.\n> > \n> > I tried my different machines, I see a very occasional black flicker on one\n> > of my NVidia machines (GT230M). Nothing on my ATI cards.\n> \n> That sounds like what I'm seeing. Although it's not occasional for me, it's\n> pretty much constant. I have a cinema display and it's most noticeable at\n> window widths > 2000. Unfortunately I haven't had any luck making a\n> recording of it. Screen capture software seems to fix the problem.\n\nI should note for me only the content flickers, not the glass, just in case that wasn't clear.", "tags": [], "bug_id": 672885, "text": "(In reply to Jim Mathies [:jimm] from comment #15)\n> (In reply to Bas Schouten (:bas) from comment #14)\n> > > As far as MS goes, I haven't taken this to them (yet). Do you feel we should\n> > > or just try to deal with this internally?\n> > \n> > Yes we should! This patch (if needed) is absolutely terrible!\n> \n> What is terrible about it? We have support in base widget for doing this, we\n> just aren't using it on windows. Clearly we've had a need for it at some\n> point. The fix also improves resize redraw performance on my system. That\n> seems like a pretty big win to me.\n\nThe fact we recreate layer managers and associated resources. The whole point is of drawing to be consistent. Not switching back between different modes, as we move forward and we want layer managers to do things like off main-thread composition and persistent, layers driven animation through user-interaction, etc. Switching them on resizes will make everything harder in the future. At the very least it should only be a temporary solution.\n\nFwiw, the fact that resize redraw performance becomes better on your system is bad, we should profile where the time is spent in the D3D case and try to fix it :( (I'm worried it might be texture recreation, in which case there might not be much we can do - except reuse textures in a smarter manner). We shouldn't need to spend so much time there as your test app resizes quite smooth even on my slower machines.\n\n> \n> > \n> > > \n> > > In your testing, did you resize the window out to a very large size and\n> > > waver back and forth? You should see a flickering. If not, you're one of the\n> > > few people who hasn't reproduced this yet. :) I've tested on vmware with a\n> > > forced accel, my laptop, and my desktop, and I see it every time. It's most\n> > > noticeable \n> > > with large windows.\n> > \n> > I tried my different machines, I see a very occasional black flicker on one\n> > of my NVidia machines (GT230M). Nothing on my ATI cards.\n> \n> That sounds like what I'm seeing. Although it's not occasional for me, it's\n> pretty much constant. I have a cinema display and it's most noticeable at\n> window widths > 2000. Unfortunately I haven't had any luck making a\n> recording of it. Screen capture software seems to fix the problem.\n\nI should note for me only the content flickers, not the glass, just in case that wasn't clear."}, {"raw_text": "Nightly is Firefox 9 now , Bug 590945 is blocked majorly by this one, will it make it to fx9?", "attachment_id": null, "text": "Nightly is Firefox 9 now , Bug 590945 is blocked majorly by this one, will it make it to fx9?", "bug_id": 672885, "tags": [], "is_private": false, "count": 20, "id": 5665592, "author": "divjot94@gmail.com", "creator": "divjot94@gmail.com", "time": "2011-08-19T16:18:33Z", "creation_time": "2011-08-19T16:18:33Z"}, {"author": "jmathies@mozilla.com", "time": "2011-08-19T16:20:44Z", "creation_time": "2011-08-19T16:20:44Z", "creator": "jmathies@mozilla.com", "id": 5665595, "count": 21, "is_private": false, "text": "(In reply to bogas04 from comment #20)\n> Nightly is Firefox 9 now , Bug 590945 is blocked majorly by this one, will\n> it make it to fx9?\n\nHard to say at this point, we're still trying to figure out if this is a problem on our end or in Windows. We are working on it though.", "bug_id": 672885, "tags": [], "raw_text": "(In reply to bogas04 from comment #20)\n> Nightly is Firefox 9 now , Bug 590945 is blocked majorly by this one, will\n> it make it to fx9?\n\nHard to say at this point, we're still trying to figure out if this is a problem on our end or in Windows. We are working on it though.", "attachment_id": null}, {"raw_text": "Thanks :)", "attachment_id": null, "tags": [], "text": "Thanks :)", "bug_id": 672885, "count": 22, "id": 5666941, "is_private": false, "author": "divjot94@gmail.com", "time": "2011-08-20T02:41:14Z", "creation_time": "2011-08-20T02:41:14Z", "creator": "divjot94@gmail.com"}, {"raw_text": "(In reply to Jim Mathies [:jimm] from comment #9)\n> > What happens with the font cache since this would essentially make us switch\n> > from DirectWrite, to GDI, and back to DirectWrite, presumably font rendering\n> > would go through all kinds of nasty fallback paths?\n> \n> Not sure but I'll see if I can track down an answer.\n\nWhat about simply toggling gfx.font_rendering.directwrite.enabled? It controls whether DW rendering is used when D2D is off (of course only where DW is supported).", "attachment_id": null, "text": "(In reply to Jim Mathies [:jimm] from comment #9)\n> > What happens with the font cache since this would essentially make us switch\n> > from DirectWrite, to GDI, and back to DirectWrite, presumably font rendering\n> > would go through all kinds of nasty fallback paths?\n> \n> Not sure but I'll see if I can track down an answer.\n\nWhat about simply toggling gfx.font_rendering.directwrite.enabled? It controls whether DW rendering is used when D2D is off (of course only where DW is supported).", "bug_id": 672885, "tags": [], "id": 5667388, "count": 23, "is_private": false, "author": "bugzilla.x.0x@xoxy.net", "creation_time": "2011-08-20T18:03:11Z", "time": "2011-08-20T18:03:11Z", "creator": "bugzilla.x.0x@xoxy.net"}, {"raw_text": "(In reply to [Baboo] from comment #23)\n> (In reply to Jim Mathies [:jimm] from comment #9)\n> > > What happens with the font cache since this would essentially make us switch\n> > > from DirectWrite, to GDI, and back to DirectWrite, presumably font rendering\n> > > would go through all kinds of nasty fallback paths?\n> > \n> > Not sure but I'll see if I can track down an answer.\n> \n> What about simply toggling gfx.font_rendering.directwrite.enabled? It\n> controls whether DW rendering is used when D2D is off (of course only where\n> DW is supported).\n\nReloading all the fonts in a different API is bad and probably IO intensive. More importantly this pref isn't actually live and doesn't clear the font cache at this point I believe.", "attachment_id": null, "text": "(In reply to [Baboo] from comment #23)\n> (In reply to Jim Mathies [:jimm] from comment #9)\n> > > What happens with the font cache since this would essentially make us switch\n> > > from DirectWrite, to GDI, and back to DirectWrite, presumably font rendering\n> > > would go through all kinds of nasty fallback paths?\n> > \n> > Not sure but I'll see if I can track down an answer.\n> \n> What about simply toggling gfx.font_rendering.directwrite.enabled? It\n> controls whether DW rendering is used when D2D is off (of course only where\n> DW is supported).\n\nReloading all the fonts in a different API is bad and probably IO intensive. More importantly this pref isn't actually live and doesn't clear the font cache at this point I believe.", "bug_id": 672885, "tags": [], "is_private": false, "count": 24, "id": 5670912, "author": "bas@basschouten.com", "creator": "bas@basschouten.com", "time": "2011-08-23T00:59:20Z", "creation_time": "2011-08-23T00:59:20Z"}, {"creator": "seahorse.pip@live.nl", "time": "2011-08-29T15:13:34Z", "creation_time": "2011-08-29T15:13:34Z", "author": "seahorse.pip@live.nl", "is_private": false, "id": 5684921, "count": 25, "tags": [], "bug_id": 672885, "text": "Also keep in mind windows explorer has the same problem on my 64bit system with a nvidia gt220 and also a gt440 it's just less noticeable since it's not so flickering that much as on firefox.", "attachment_id": null, "raw_text": "Also keep in mind windows explorer has the same problem on my 64bit system with a nvidia gt220 and also a gt440 it's just less noticeable since it's not so flickering that much as on firefox."}, {"is_private": false, "count": 26, "id": 5735614, "author": "fefavale_93@hotmail.com", "creator": "fefavale_93@hotmail.com", "time": "2011-09-24T20:07:17Z", "creation_time": "2011-09-24T20:07:17Z", "raw_text": "I don't want to bother you, I'm just asking.\nWhat's the status of this bug?\nWill be fixed soon?\nagain I'm just asking", "attachment_id": null, "tags": [], "bug_id": 672885, "text": "I don't want to bother you, I'm just asking.\nWhat's the status of this bug?\nWill be fixed soon?\nagain I'm just asking"}, {"attachment_id": null, "raw_text": "(In reply to Fede from comment #26)\n> I don't want to bother you, I'm just asking.\n> What's the status of this bug?\n> Will be fixed soon?\n> again I'm just asking\n\nWe are still working with ms on this, but generally, it seems there is no fix, it's a problem in Windows and our most likely solution will be to implement a work around such as the resize patch I've already posted. I'm currently waiting on clarification on what we need to avoid doing to avoid experiencing the bug. It seems they may not have a solid answer to that.\n\nOne thing they did note was that there are some video cards / drivers that do not exhibit the problem. Although again I have little information on why that is as I still have not received a definitive answer as to the root cause of the problem.", "text": "(In reply to Fede from comment #26)\n> I don't want to bother you, I'm just asking.\n> What's the status of this bug?\n> Will be fixed soon?\n> again I'm just asking\n\nWe are still working with ms on this, but generally, it seems there is no fix, it's a problem in Windows and our most likely solution will be to implement a work around such as the resize patch I've already posted. I'm currently waiting on clarification on what we need to avoid doing to avoid experiencing the bug. It seems they may not have a solid answer to that.\n\nOne thing they did note was that there are some video cards / drivers that do not exhibit the problem. Although again I have little information on why that is as I still have not received a definitive answer as to the root cause of the problem.", "bug_id": 672885, "tags": [], "count": 27, "id": 5743374, "is_private": false, "time": "2011-09-28T16:16:48Z", "creation_time": "2011-09-28T16:16:48Z", "creator": "jmathies@mozilla.com", "author": "jmathies@mozilla.com"}, {"author": "jmathies@mozilla.com", "creator": "jmathies@mozilla.com", "time": "2011-10-03T17:43:09Z", "creation_time": "2011-10-03T17:43:09Z", "is_private": false, "count": 28, "id": 5754540, "bug_id": 672885, "text": "I'm looking for drivers/cards that do or don't exhibit the flicker problem. Thus far I know it's reproducible on\n\nNVIDIA GeForce GT 330M W/ DirecTX 11\nNVIDIA Quadro NVS 295\nNVIDIA GT230M\n\nBas, you mentioned your ATI card didn't have the problem. Can you post the detail on your card?\n\nAnyone else tuned in who has a D3D card we support, please take the test app for spin:\n\nhttps://bugzilla.mozilla.org/attachment.cgi?id=553256\n\nand report back if you see the flicker while resizing.", "tags": [], "raw_text": "I'm looking for drivers/cards that do or don't exhibit the flicker problem. Thus far I know it's reproducible on\n\nNVIDIA GeForce GT 330M W/ DirecTX 11\nNVIDIA Quadro NVS 295\nNVIDIA GT230M\n\nBas, you mentioned your ATI card didn't have the problem. Can you post the detail on your card?\n\nAnyone else tuned in who has a D3D card we support, please take the test app for spin:\n\nhttps://bugzilla.mozilla.org/attachment.cgi?id=553256\n\nand report back if you see the flicker while resizing.", "attachment_id": null}, {"text": "Created attachment 564245\nNVIDIA Quadro NVS 295", "bug_id": 672885, "tags": [], "author": "jmathies@mozilla.com", "creation_time": "2011-10-03T17:46:27Z", "time": "2011-10-03T17:46:27Z", "creator": "jmathies@mozilla.com", "raw_text": "", "count": 29, "id": 5754556, "is_private": false, "attachment_id": 564245}, {"creation_time": "2011-10-03T17:47:24Z", "time": "2011-10-03T17:47:24Z", "creator": "jmathies@mozilla.com", "author": "jmathies@mozilla.com", "count": 30, "id": 5754561, "is_private": false, "text": "Also, if you have the dxdiag tool available, please post the \"Save all information\" report here as an attachment.", "bug_id": 672885, "tags": [], "attachment_id": null, "raw_text": "Also, if you have the dxdiag tool available, please post the \"Save all information\" report here as an attachment."}, {"attachment_id": 564275, "raw_text": "The background color of the window flickers when I resize the window of the test app.", "tags": [], "bug_id": 672885, "text": "Created attachment 564275\nNVIDIA GeForce GTX 560 Ti\n\nThe background color of the window flickers when I resize the window of the test app.", "is_private": false, "count": 31, "id": 5754752, "creator": "d-kalck@ngamexp.com", "time": "2011-10-03T18:40:38Z", "creation_time": "2011-10-03T18:40:38Z", "author": "d-kalck@ngamexp.com"}, {"tags": [], "text": "Created attachment 564336\nNVIDIA GeFore 9600M GT\n\nNVIDIA GeFore 9600M GT\n\nSporadic flickering.", "bug_id": 672885, "raw_text": "NVIDIA GeFore 9600M GT\n\nSporadic flickering.", "attachment_id": 564336, "author": "bugzilla.x.0x@xoxy.net", "creation_time": "2011-10-03T21:28:50Z", "time": "2011-10-03T21:28:50Z", "creator": "bugzilla.x.0x@xoxy.net", "id": 5755390, "count": 32, "is_private": false}, {"attachment_id": null, "raw_text": "NVIDIA GeForce GTX 580, Windows 7 x64 w/ SP1 and latest DirectX redist, driver version 285.38 beta. I see occasional flickering to a dark color (probably black), which appears to get much less frequent when the window is close to the full size of my desktop.", "bug_id": 672885, "text": "NVIDIA GeForce GTX 580, Windows 7 x64 w/ SP1 and latest DirectX redist, driver version 285.38 beta. I see occasional flickering to a dark color (probably black), which appears to get much less frequent when the window is close to the full size of my desktop.", "tags": [], "id": 5755645, "count": 33, "is_private": false, "time": "2011-10-03T22:36:23Z", "creation_time": "2011-10-03T22:36:23Z", "creator": "emanuel.hoogeveen@protonmail.com", "author": "emanuel.hoogeveen@protonmail.com"}, {"raw_text": "Oh, and here's my dxdiag output (sorry about bugspam).", "attachment_id": 564360, "bug_id": 672885, "text": "Created attachment 564360\nNVIDIA GeForce GTX 580\n\nOh, and here's my dxdiag output (sorry about bugspam).", "tags": [], "id": 5755666, "count": 34, "is_private": false, "author": "emanuel.hoogeveen@protonmail.com", "time": "2011-10-03T22:41:34Z", "creation_time": "2011-10-03T22:41:34Z", "creator": "emanuel.hoogeveen@protonmail.com"}, {"creation_time": "2011-10-04T22:19:52Z", "time": "2011-10-04T22:19:52Z", "creator": "jbecerra@mozilla.com", "author": "jbecerra@mozilla.com", "id": 5758845, "count": 35, "is_private": false, "tags": [], "text": "Created attachment 564684\nNVIDIA GeForce GT 335M\n\nI can see flickering in this configuration on the nightly.\n\nNVIDIA GeForce GT 335M", "bug_id": 672885, "attachment_id": 564684, "raw_text": "I can see flickering in this configuration on the nightly.\n\nNVIDIA GeForce GT 335M"}, {"author": "jbecerra@mozilla.com", "creator": "jbecerra@mozilla.com", "time": "2011-10-04T22:56:17Z", "creation_time": "2011-10-04T22:56:17Z", "is_private": false, "count": 36, "id": 5758966, "bug_id": 672885, "text": "I tried a couple more machines in the lab, but none of them met the hardware requirements.", "tags": [], "raw_text": "I tried a couple more machines in the lab, but none of them met the hardware requirements.", "attachment_id": null}, {"attachment_id": 564883, "is_private": false, "count": 37, "id": 5760543, "raw_text": "", "creator": "jmathies@mozilla.com", "time": "2011-10-05T16:30:09Z", "creation_time": "2011-10-05T16:30:09Z", "author": "jmathies@mozilla.com", "tags": [], "bug_id": 672885, "text": "Created attachment 564883\nsimple d3d9 demo"}, {"creation_time": "2011-10-14T14:48:07Z", "time": "2011-10-14T14:48:07Z", "creator": "jmathies@mozilla.com", "author": "jmathies@mozilla.com", "id": 5782688, "count": 38, "is_private": false, "text": "Posting notes here based on discussions with ms:\n\n1) Generally the flicker problem is related to discarding swap chains (D3D9) or resizing swap chain buffers (D3D10).\n\n2) There is no simple work around, the problem relates to issues with card drivers which do not support this well.\n\n3) While removing all of the non-client chrome tends to make the problem worse / more noticeable, the same side effect has been reproduced with client chrome. Which tends to back up the idea that this is not a problem specific to removing non-client chrome. I've experienced resize performance problems with our current setup on a couple cards (one blacklisted, one not), so I think there is merit to this.\n\nWe have a possible fix posted here which turns off acceleration off when we resize. Bas mentioned we might be able to use this for D3D9 but not 10. I don't think we want two different personas rendering behaviors based on hidden settings, so I'm inclined to say implementing the work around based on the D3D version probably isn't a very good idea.\n\nMs suggested finding other ways to handle resizing that don't involve discarding or resizing buffers on the fly. I've reached my limit of understanding of D3D to go at this beyond what I've already done. If anyone else would care to take this up and experiment, please do. \n\nAlso, Dao has asked that since this work appears to be stalled, we work on fixing a related bug (bug 618353) to improve the experience independent of full skinning. I think that's a good idea so I'll start in on that soon.", "bug_id": 672885, "tags": [], "attachment_id": null, "raw_text": "Posting notes here based on discussions with ms:\n\n1) Generally the flicker problem is related to discarding swap chains (D3D9) or resizing swap chain buffers (D3D10).\n\n2) There is no simple work around, the problem relates to issues with card drivers which do not support this well.\n\n3) While removing all of the non-client chrome tends to make the problem worse / more noticeable, the same side effect has been reproduced with client chrome. Which tends to back up the idea that this is not a problem specific to removing non-client chrome. I've experienced resize performance problems with our current setup on a couple cards (one blacklisted, one not), so I think there is merit to this.\n\nWe have a possible fix posted here which turns off acceleration off when we resize. Bas mentioned we might be able to use this for D3D9 but not 10. I don't think we want two different personas rendering behaviors based on hidden settings, so I'm inclined to say implementing the work around based on the D3D version probably isn't a very good idea.\n\nMs suggested finding other ways to handle resizing that don't involve discarding or resizing buffers on the fly. I've reached my limit of understanding of D3D to go at this beyond what I've already done. If anyone else would care to take this up and experiment, please do. \n\nAlso, Dao has asked that since this work appears to be stalled, we work on fixing a related bug (bug 618353) to improve the experience independent of full skinning. I think that's a good idea so I'll start in on that soon."}, {"count": 39, "id": 5783293, "is_private": false, "time": "2011-10-14T18:29:35Z", "creation_time": "2011-10-14T18:29:35Z", "creator": "franciscoadriansanchez@gmail.com", "author": "franciscoadriansanchez@gmail.com", "attachment_id": null, "raw_text": "Jim:\n\nThere's something I still can't understand. Does this bug occurs just in W7 (as it's said on top) or it's present in XP and Mac, Linux, etc?", "tags": [], "bug_id": 672885, "text": "Jim:\n\nThere's something I still can't understand. Does this bug occurs just in W7 (as it's said on top) or it's present in XP and Mac, Linux, etc?"}, {"attachment_id": null, "raw_text": "(In reply to Francisco from comment #39)\n> Jim:\n> \n> There's something I still can't understand. Does this bug occurs just in W7\n> (as it's said on top) or it's present in XP and Mac, Linux, etc?\n\nI haven't tested the test app on XP, if someone would like to do that it would help add another data point. Generally this is windows only, specifically windows 7 with dwm enabled.", "tags": [], "text": "(In reply to Francisco from comment #39)\n> Jim:\n> \n> There's something I still can't understand. Does this bug occurs just in W7\n> (as it's said on top) or it's present in XP and Mac, Linux, etc?\n\nI haven't tested the test app on XP, if someone would like to do that it would help add another data point. Generally this is windows only, specifically windows 7 with dwm enabled.", "bug_id": 672885, "is_private": false, "count": 40, "id": 5783406, "creator": "jmathies@mozilla.com", "creation_time": "2011-10-14T19:13:28Z", "time": "2011-10-14T19:13:28Z", "author": "jmathies@mozilla.com"}, {"author": "franciscoadriansanchez@gmail.com", "creator": "franciscoadriansanchez@gmail.com", "time": "2011-10-14T19:20:01Z", "creation_time": "2011-10-14T19:20:01Z", "is_private": false, "id": 5783420, "count": 41, "tags": [], "text": "Thank you Jim for your answer. I have a machine with XP loaded. Maybe I could check (if I don't have to compile..)", "bug_id": 672885, "raw_text": "Thank you Jim for your answer. I have a machine with XP loaded. Maybe I could check (if I don't have to compile..)", "attachment_id": null}, {"is_private": false, "id": 5783433, "count": 42, "creator": "jmathies@mozilla.com", "creation_time": "2011-10-14T19:25:46Z", "time": "2011-10-14T19:25:46Z", "author": "jmathies@mozilla.com", "attachment_id": null, "raw_text": "(In reply to Francisco from comment #41)\n> Thank you Jim for your answer. I have a machine with XP loaded. Maybe I\n> could check (if I don't have to compile..)\n\nActually you would have to build it locally, and remove the dwm lib hard links. The existing exe won't load with it's current configuration. I'll see if I can work up an xp compat build.", "text": "(In reply to Francisco from comment #41)\n> Thank you Jim for your answer. I have a machine with XP loaded. Maybe I\n> could check (if I don't have to compile..)\n\nActually you would have to build it locally, and remove the dwm lib hard links. The existing exe won't load with it's current configuration. I'll see if I can work up an xp compat build.", "bug_id": 672885, "tags": []}, {"id": 5860517, "count": 43, "is_private": false, "creation_time": "2011-11-19T16:31:39Z", "time": "2011-11-19T16:31:39Z", "creator": "fefavale_93@hotmail.com", "author": "fefavale_93@hotmail.com", "attachment_id": null, "raw_text": "Again I'm just asking, becouse the last comment is from a month ago.\nSo the question is, is there a solution, or a way to fix it?\nOr will you post builds to test? I really want to see this bug fixed, I think that with this we will have a lots of ways to customize Firefox.\nSo please don't give up with it.", "tags": [], "bug_id": 672885, "text": "Again I'm just asking, becouse the last comment is from a month ago.\nSo the question is, is there a solution, or a way to fix it?\nOr will you post builds to test? I really want to see this bug fixed, I think that with this we will have a lots of ways to customize Firefox.\nSo please don't give up with it."}, {"attachment_id": null, "raw_text": "Sorry bugspam, can this be fixed so 590945 can proceed and redo the themeing on windows?  Firefox looks horrible on Windows XP with the button on compared to the smooth integration of window bar and chrome in Chromium.", "bug_id": 672885, "text": "Sorry bugspam, can this be fixed so 590945 can proceed and redo the themeing on windows?  Firefox looks horrible on Windows XP with the button on compared to the smooth integration of window bar and chrome in Chromium.", "tags": [], "count": 44, "id": 5939104, "is_private": false, "creation_time": "2011-12-25T06:48:55Z", "time": "2011-12-25T06:48:55Z", "creator": "henry.fai.hang.chan@gmail.com", "author": "henry.fai.hang.chan@gmail.com"}, {"tags": [], "bug_id": 672885, "text": "(In reply to Jim Mathies [:jimm] from comment #17)\n> Chatted with bsmedberg about this today, we're going to file off a support\n> request to see if we can get a definitive answer from ms on the cause.\n\nJust curious, has Ms followed up on this?", "raw_text": "(In reply to Jim Mathies [:jimm] from comment #17)\n> Chatted with bsmedberg about this today, we're going to file off a support\n> request to see if we can get a definitive answer from ms on the cause.\n\nJust curious, has Ms followed up on this?", "attachment_id": null, "author": "mozbugz@outlook.com", "creation_time": "2012-01-29T00:35:53Z", "time": "2012-01-29T00:35:53Z", "creator": "mozbugz@outlook.com", "count": 45, "id": 6017303, "is_private": false}, {"is_private": false, "count": 46, "id": 6019519, "author": "jmathies@mozilla.com", "creator": "jmathies@mozilla.com", "time": "2012-01-30T16:58:17Z", "creation_time": "2012-01-30T16:58:17Z", "raw_text": "(In reply to Dennis \"Dale\" Y. [:cuz84d] from comment #45)\n> (In reply to Jim Mathies [:jimm] from comment #17)\n> > Chatted with bsmedberg about this today, we're going to file off a support\n> > request to see if we can get a definitive answer from ms on the cause.\n> \n> Just curious, has Ms followed up on this?\n\nYes they basically said the way we handle back buffers during resize is unreliable, and that we should look for a better way of handling it.", "attachment_id": null, "bug_id": 672885, "text": "(In reply to Dennis \"Dale\" Y. [:cuz84d] from comment #45)\n> (In reply to Jim Mathies [:jimm] from comment #17)\n> > Chatted with bsmedberg about this today, we're going to file off a support\n> > request to see if we can get a definitive answer from ms on the cause.\n> \n> Just curious, has Ms followed up on this?\n\nYes they basically said the way we handle back buffers during resize is unreliable, and that we should look for a better way of handling it.", "tags": []}, {"is_private": false, "id": 6022741, "count": 47, "author": "bas@basschouten.com", "creator": "bas@basschouten.com", "time": "2012-01-31T16:09:19Z", "creation_time": "2012-01-31T16:09:19Z", "raw_text": "Just as a note on my ATI card, I'd need to retest, but I think it was just really really rare on my ATI, not completely absent.", "attachment_id": null, "tags": [], "text": "Just as a note on my ATI card, I'd need to retest, but I think it was just really really rare on my ATI, not completely absent.", "bug_id": 672885}, {"attachment_id": null, "raw_text": "(In reply to Jim Mathies [:jimm] from comment #38)\n> Posting notes here based on discussions with ms:\n> Ms suggested finding other ways to handle resizing that don't involve\n> discarding or resizing buffers on the fly. I've reached my limit of\n> understanding of D3D to go at this beyond what I've already done. If anyone\n> else would care to take this up and experiment, please do. \n\nI can't experiment right now, and I don't have a lot of ideas on D3D9 (I mean - this -is- their API for resizing buffers, they're saying it's not the right way to resize buffers? Maybe it shouldn't be called ResizeBuffers then?)\n\nOn D3D10 one idea I'd have is try creating the new SwapChain first, presenting the new one and only then releasing the old one. I have no idea if that actually helps though! But it might be worth a shot, that way there shouldn't be any time without an active swap chain presented.", "tags": [], "text": "(In reply to Jim Mathies [:jimm] from comment #38)\n> Posting notes here based on discussions with ms:\n> Ms suggested finding other ways to handle resizing that don't involve\n> discarding or resizing buffers on the fly. I've reached my limit of\n> understanding of D3D to go at this beyond what I've already done. If anyone\n> else would care to take this up and experiment, please do. \n\nI can't experiment right now, and I don't have a lot of ideas on D3D9 (I mean - this -is- their API for resizing buffers, they're saying it's not the right way to resize buffers? Maybe it shouldn't be called ResizeBuffers then?)\n\nOn D3D10 one idea I'd have is try creating the new SwapChain first, presenting the new one and only then releasing the old one. I have no idea if that actually helps though! But it might be worth a shot, that way there shouldn't be any time without an active swap chain presented.", "bug_id": 672885, "is_private": false, "id": 6022752, "count": 48, "creator": "bas@basschouten.com", "creation_time": "2012-01-31T16:12:29Z", "time": "2012-01-31T16:12:29Z", "author": "bas@basschouten.com"}, {"creator": "jmathies@mozilla.com", "creation_time": "2012-01-31T16:33:27Z", "time": "2012-01-31T16:33:27Z", "author": "jmathies@mozilla.com", "is_private": false, "id": 6022836, "count": 49, "tags": [], "bug_id": 672885, "text": "Is there a way we can instrument the D3D10 calls in IE to see how they solved this internally? The sup[port guy I worked with was not very helpful. His only solution was to stretch that last frame out during a resize - clearly not an option.", "attachment_id": null, "raw_text": "Is there a way we can instrument the D3D10 calls in IE to see how they solved this internally? The sup[port guy I worked with was not very helpful. His only solution was to stretch that last frame out during a resize - clearly not an option."}, {"attachment_id": null, "raw_text": "(In reply to Jim Mathies [:jimm] from comment #49)\n> Is there a way we can instrument the D3D10 calls in IE to see how they\n> solved this internally? The sup[port guy I worked with was not very helpful.\n> His only solution was to stretch that last frame out during a resize -\n> clearly not an option.\n\nThere's a tool called PIXWin in the DirectX SDK you can use to generate a D3D call trace from IE.", "bug_id": 672885, "text": "(In reply to Jim Mathies [:jimm] from comment #49)\n> Is there a way we can instrument the D3D10 calls in IE to see how they\n> solved this internally? The sup[port guy I worked with was not very helpful.\n> His only solution was to stretch that last frame out during a resize -\n> clearly not an option.\n\nThere's a tool called PIXWin in the DirectX SDK you can use to generate a D3D call trace from IE.", "tags": [], "id": 6023036, "count": 50, "is_private": false, "creation_time": "2012-01-31T17:34:53Z", "time": "2012-01-31T17:34:53Z", "creator": "bas@basschouten.com", "author": "bas@basschouten.com"}, {"attachment_id": null, "raw_text": "(In reply to Bas Schouten (:bas) from comment #50)\n> (In reply to Jim Mathies [:jimm] from comment #49)\n> > Is there a way we can instrument the D3D10 calls in IE to see how they\n> > solved this internally? The sup[port guy I worked with was not very helpful.\n> > His only solution was to stretch that last frame out during a resize -\n> > clearly not an option.\n> \n> There's a tool called PIXWin in the DirectX SDK you can use to generate a\n> D3D call trace from IE.\n\nTook a shot at this, but it seems the tool only monitors the first process it creates, and with IE, secondary processes appear to be handling rendering of content. Tried disabling protected mode as well, but this didn't disable ie's multi-process features.", "bug_id": 672885, "text": "(In reply to Bas Schouten (:bas) from comment #50)\n> (In reply to Jim Mathies [:jimm] from comment #49)\n> > Is there a way we can instrument the D3D10 calls in IE to see how they\n> > solved this internally? The sup[port guy I worked with was not very helpful.\n> > His only solution was to stretch that last frame out during a resize -\n> > clearly not an option.\n> \n> There's a tool called PIXWin in the DirectX SDK you can use to generate a\n> D3D call trace from IE.\n\nTook a shot at this, but it seems the tool only monitors the first process it creates, and with IE, secondary processes appear to be handling rendering of content. Tried disabling protected mode as well, but this didn't disable ie's multi-process features.", "tags": [], "is_private": false, "id": 6023708, "count": 51, "creator": "jmathies@mozilla.com", "creation_time": "2012-01-31T21:06:30Z", "time": "2012-01-31T21:06:30Z", "author": "jmathies@mozilla.com"}, {"is_private": false, "id": 6023791, "count": 52, "author": "robert.strong.bugs@gmail.com", "creator": "robert.strong.bugs@gmail.com", "creation_time": "2012-01-31T21:39:25Z", "time": "2012-01-31T21:39:25Z", "raw_text": "Sent to jimm on irc in case it helps (putting in this bug for reference)\nhttp://blog.smartbear.com/post/10-06-01/web-testing---disabling-multiple-processes-of-internet-explorer-8/", "attachment_id": null, "text": "Sent to jimm on irc in case it helps (putting in this bug for reference)\nhttp://blog.smartbear.com/post/10-06-01/web-testing---disabling-multiple-processes-of-internet-explorer-8/", "bug_id": 672885, "tags": []}, {"raw_text": "Here's a log for about:blank being resized in and out. First resize starts in frame 2. It appears that they do call ResizeBuffers in each frame.", "attachment_id": 593214, "tags": [], "text": "Created attachment 593214\nD3D10 IE PIXlog\n\nHere's a log for about:blank being resized in and out. First resize starts in frame 2. It appears that they do call ResizeBuffers in each frame.", "bug_id": 672885, "is_private": false, "count": 53, "id": 6023905, "author": "jmathies@mozilla.com", "creator": "jmathies@mozilla.com", "creation_time": "2012-01-31T22:16:31Z", "time": "2012-01-31T22:16:31Z"}, {"raw_text": "I'm not seeing much of an ordering difference here but there are certainly finer differences in the way the two browsers do things. The other obvious difference is that we are accelerating the entire window, including glass, where as ie is working with a child window.\n\nBas, if you have the time I'd appreciate any feedback you can give on that log data.", "attachment_id": null, "tags": [], "bug_id": 672885, "text": "I'm not seeing much of an ordering difference here but there are certainly finer differences in the way the two browsers do things. The other obvious difference is that we are accelerating the entire window, including glass, where as ie is working with a child window.\n\nBas, if you have the time I'd appreciate any feedback you can give on that log data.", "id": 6023963, "count": 54, "is_private": false, "author": "jmathies@mozilla.com", "time": "2012-01-31T22:32:45Z", "creation_time": "2012-01-31T22:32:45Z", "creator": "jmathies@mozilla.com"}, {"raw_text": "Thanks Jim for diving into this. Could you also attach the PIXWin log for Firefox when it exhibits this bug (assumes it would be for about:blank being resized in and out) to compare the IE log with?\n\nFor those following along, the new theme work has started back up and this bug blocks bug 590945 which is needed for the new theme work.\n\nhttps://wiki.mozilla.org/Firefox/Features/Theme_Refinement_and_Evolution_%28Australis%29\n\nJim, assuming we aren't doing anything drastically different than IE do you think it would be worthwhile to get MS to look at a Firefox and IE PXWin log to get their input on what we should be doing differently since their own apps appear to use ResizeBuffers?", "attachment_id": null, "bug_id": 672885, "text": "Thanks Jim for diving into this. Could you also attach the PIXWin log for Firefox when it exhibits this bug (assumes it would be for about:blank being resized in and out) to compare the IE log with?\n\nFor those following along, the new theme work has started back up and this bug blocks bug 590945 which is needed for the new theme work.\n\nhttps://wiki.mozilla.org/Firefox/Features/Theme_Refinement_and_Evolution_%28Australis%29\n\nJim, assuming we aren't doing anything drastically different than IE do you think it would be worthwhile to get MS to look at a Firefox and IE PXWin log to get their input on what we should be doing differently since their own apps appear to use ResizeBuffers?", "tags": [], "count": 55, "id": 6027152, "is_private": false, "author": "robert.strong.bugs@gmail.com", "time": "2012-02-01T22:51:24Z", "creation_time": "2012-02-01T22:51:24Z", "creator": "robert.strong.bugs@gmail.com"}, {"is_private": false, "count": 56, "id": 6028239, "author": "mozbugz@outlook.com", "creator": "mozbugz@outlook.com", "creation_time": "2012-02-02T08:51:19Z", "time": "2012-02-02T08:51:19Z", "raw_text": "I do see flicker when resize in the purple to black on my ATI 5450 but not in the glass.  \n\nMaybe you've seen this already, but here an interesting read non the less on using D3D Swap chains and ResizeBuffers here:\nhttp://msdn.microsoft.com/en-us/library/windows/desktop/bb206356%28v=vs.85%29.aspx\n\nhttp://msdn.microsoft.com/en-us/library/windows/desktop/bb205075%28v=vs.85%29.aspx#Handling_Window_Resizing", "attachment_id": null, "tags": [], "text": "I do see flicker when resize in the purple to black on my ATI 5450 but not in the glass.  \n\nMaybe you've seen this already, but here an interesting read non the less on using D3D Swap chains and ResizeBuffers here:\nhttp://msdn.microsoft.com/en-us/library/windows/desktop/bb206356%28v=vs.85%29.aspx\n\nhttp://msdn.microsoft.com/en-us/library/windows/desktop/bb205075%28v=vs.85%29.aspx#Handling_Window_Resizing", "bug_id": 672885}, {"tags": [], "text": "(In reply to Robert Strong [:rstrong] (do not email) from comment #55)\n> Thanks Jim for diving into this. Could you also attach the PIXWin log for\n> Firefox when it exhibits this bug (assumes it would be for about:blank being\n> resized in and out) to compare the IE log with?\n\nIt would probably be simpler to write a D3D10 test app similar to the D3D9 test app attached here. The D3D9 test app reproduces the flicker while also baking the entire process we go through down into about fifteen calls. I can try to work something like that up.\n\n> Jim, assuming we aren't doing anything drastically different than IE do you\n> think it would be worthwhile to get MS to look at a Firefox and IE PXWin log\n> to get their input on what we should be doing differently since their own\n> apps appear to use ResizeBuffers?\n\nThe original support request was for D3D9, so we could open one for D3D10. Before doing that though we would need a test app. It would also probably be good to have someone like Bas open the request and carry the conversation, as I was unable to make any headway with the guy I worked with.", "bug_id": 672885, "attachment_id": null, "raw_text": "(In reply to Robert Strong [:rstrong] (do not email) from comment #55)\n> Thanks Jim for diving into this. Could you also attach the PIXWin log for\n> Firefox when it exhibits this bug (assumes it would be for about:blank being\n> resized in and out) to compare the IE log with?\n\nIt would probably be simpler to write a D3D10 test app similar to the D3D9 test app attached here. The D3D9 test app reproduces the flicker while also baking the entire process we go through down into about fifteen calls. I can try to work something like that up.\n\n> Jim, assuming we aren't doing anything drastically different than IE do you\n> think it would be worthwhile to get MS to look at a Firefox and IE PXWin log\n> to get their input on what we should be doing differently since their own\n> apps appear to use ResizeBuffers?\n\nThe original support request was for D3D9, so we could open one for D3D10. Before doing that though we would need a test app. It would also probably be good to have someone like Bas open the request and carry the conversation, as I was unable to make any headway with the guy I worked with.", "creator": "jmathies@mozilla.com", "creation_time": "2012-02-02T11:25:01Z", "time": "2012-02-02T11:25:01Z", "author": "jmathies@mozilla.com", "is_private": false, "id": 6028484, "count": 57}, {"author": "jmathies@mozilla.com", "creation_time": "2012-02-02T11:29:11Z", "time": "2012-02-02T11:29:11Z", "creator": "jmathies@mozilla.com", "id": 6028497, "count": 58, "is_private": false, "tags": [], "text": "Created attachment 593784\nD3D9 testapp PIXlog", "bug_id": 672885, "raw_text": "", "attachment_id": 593784}, {"tags": [], "text": "It looks like changing the SwapEffect to _DISCARD from _COPY, increasing BackBufferCount to 2, and not specifying PresentationInterval, and there doesn't seem to be any flickering anymore.\n\nAfter resizing for a while, I'm getting D3DERR_OUTOFVIDEOMEMORY, even though I seem to be releasing everything fine.", "bug_id": 672885, "attachment_id": null, "raw_text": "It looks like changing the SwapEffect to _DISCARD from _COPY, increasing BackBufferCount to 2, and not specifying PresentationInterval, and there doesn't seem to be any flickering anymore.\n\nAfter resizing for a while, I'm getting D3DERR_OUTOFVIDEOMEMORY, even though I seem to be releasing everything fine.", "time": "2012-02-10T03:20:32Z", "creation_time": "2012-02-10T03:20:32Z", "creator": "jgilbert@mozilla.com", "author": "jgilbert@mozilla.com", "id": 6049196, "count": 59, "is_private": false}, {"is_private": false, "id": 6049372, "count": 60, "creator": "jgilbert@mozilla.com", "time": "2012-02-10T05:58:40Z", "creation_time": "2012-02-10T05:58:40Z", "author": "jgilbert@mozilla.com", "attachment_id": null, "raw_text": "After playing around trying to repro this, it looks like it's clean of flickers if we hold off on releasing the old swap chain until we have the new one. (It's hard to tell though, since it's not easy to repro)\n\n(Guess time:) This could be the driver releasing the old chain, and freeing it, before creating the new chain, but the refresh/paint hits right between freeing and creation. In this case, holding on to the old chain until we have the new one in place may help/fix this.", "bug_id": 672885, "text": "After playing around trying to repro this, it looks like it's clean of flickers if we hold off on releasing the old swap chain until we have the new one. (It's hard to tell though, since it's not easy to repro)\n\n(Guess time:) This could be the driver releasing the old chain, and freeing it, before creating the new chain, but the refresh/paint hits right between freeing and creation. In this case, holding on to the old chain until we have the new one in place may help/fix this.", "tags": []}, {"bug_id": 672885, "text": "Using http://pastebin.mozilla.org/1481439 , if someone can repro with '#define HOLD_OLD_CHAIN\t0', but not '#define HOLD_OLD_CHAIN\t1', then we'll have something.", "tags": [], "attachment_id": null, "raw_text": "Using http://pastebin.mozilla.org/1481439 , if someone can repro with '#define HOLD_OLD_CHAIN\t0', but not '#define HOLD_OLD_CHAIN\t1', then we'll have something.", "creator": "jgilbert@mozilla.com", "creation_time": "2012-02-10T06:05:21Z", "time": "2012-02-10T06:05:21Z", "author": "jgilbert@mozilla.com", "is_private": false, "count": 61, "id": 6049379}, {"raw_text": "Hate to bring bad news, but with \n\n#define HOLD_OLD_CHAIN\t1\n\nI'm still seeing the flicker, primarily when the window is expanded out near the size of the desktop. \n\nAttached is my project w/release exe. Maybe some other people cc'd in here can take this for a spin and help confirm.", "attachment_id": 596042, "text": "Created attachment 596042\nD3DFlickerTest.zip\n\nHate to bring bad news, but with \n\n#define HOLD_OLD_CHAIN\t1\n\nI'm still seeing the flicker, primarily when the window is expanded out near the size of the desktop. \n\nAttached is my project w/release exe. Maybe some other people cc'd in here can take this for a spin and help confirm.", "bug_id": 672885, "tags": [], "id": 6050005, "count": 62, "is_private": false, "author": "jmathies@mozilla.com", "time": "2012-02-10T14:50:54Z", "creation_time": "2012-02-10T14:50:54Z", "creator": "jmathies@mozilla.com"}, {"raw_text": "Looking at the code in the pastebin, those clauses with both always pass, so even if HOLD_OLD_CHAIN is defined it will still release early.\n\nYou need to #if !defined(HOLD_OLD_CHAIN) as #if !HOLD_OLD_CHAIN will always pass if HOLD_OLD_CHAIN is valid I believe. If my C++ isn't too rusty that is.", "attachment_id": null, "tags": [], "bug_id": 672885, "text": "Looking at the code in the pastebin, those clauses with both always pass, so even if HOLD_OLD_CHAIN is defined it will still release early.\n\nYou need to #if !defined(HOLD_OLD_CHAIN) as #if !HOLD_OLD_CHAIN will always pass if HOLD_OLD_CHAIN is valid I believe. If my C++ isn't too rusty that is.", "is_private": false, "count": 63, "id": 6050188, "author": "bas@basschouten.com", "creator": "bas@basschouten.com", "creation_time": "2012-02-10T16:05:05Z", "time": "2012-02-10T16:05:05Z"}, {"tags": [], "text": "(In reply to Bas Schouten (:bas) from comment #63)\n> Looking at the code in the pastebin, those clauses with both always pass, so\n> even if HOLD_OLD_CHAIN is defined it will still release early.\n> \n> You need to #if !defined(HOLD_OLD_CHAIN) as #if !HOLD_OLD_CHAIN will always\n> pass if HOLD_OLD_CHAIN is valid I believe. If my C++ isn't too rusty that is.\n\njgilbert makes the valid point that if you actually define HOLD_OLD_CHAIN to 1. it does work, that's not what I did, but I guess it is what Jimm did, so that's not at fault.", "bug_id": 672885, "raw_text": "(In reply to Bas Schouten (:bas) from comment #63)\n> Looking at the code in the pastebin, those clauses with both always pass, so\n> even if HOLD_OLD_CHAIN is defined it will still release early.\n> \n> You need to #if !defined(HOLD_OLD_CHAIN) as #if !HOLD_OLD_CHAIN will always\n> pass if HOLD_OLD_CHAIN is valid I believe. If my C++ isn't too rusty that is.\n\njgilbert makes the valid point that if you actually define HOLD_OLD_CHAIN to 1. it does work, that's not what I did, but I guess it is what Jimm did, so that's not at fault.", "attachment_id": null, "author": "bas@basschouten.com", "creator": "bas@basschouten.com", "creation_time": "2012-02-10T21:28:28Z", "time": "2012-02-10T21:28:28Z", "is_private": false, "count": 64, "id": 6051680}, {"bug_id": 672885, "text": "(In reply to Jeff Gilbert [:jgilbert] from comment #60)\n> After playing around trying to repro this, it looks like it's clean of\n> flickers if we hold off on releasing the old swap chain until we have the\n> new one. (It's hard to tell though, since it's not easy to repro)\n> \n> (Guess time:) This could be the driver releasing the old chain, and freeing\n> it, before creating the new chain, but the refresh/paint hits right between\n> freeing and creation. In this case, holding on to the old chain until we\n> have the new one in place may help/fix this.\n\nWhat about using FLIP instead of Discard?  Looks like Discard take more video memory.\nhttp://msdn.microsoft.com/en-us/library/windows/desktop/bb172612%28v=vs.85%29.aspx", "tags": [], "raw_text": "(In reply to Jeff Gilbert [:jgilbert] from comment #60)\n> After playing around trying to repro this, it looks like it's clean of\n> flickers if we hold off on releasing the old swap chain until we have the\n> new one. (It's hard to tell though, since it's not easy to repro)\n> \n> (Guess time:) This could be the driver releasing the old chain, and freeing\n> it, before creating the new chain, but the refresh/paint hits right between\n> freeing and creation. In this case, holding on to the old chain until we\n> have the new one in place may help/fix this.\n\nWhat about using FLIP instead of Discard?  Looks like Discard take more video memory.\nhttp://msdn.microsoft.com/en-us/library/windows/desktop/bb172612%28v=vs.85%29.aspx", "attachment_id": null, "author": "mozbugz@outlook.com", "time": "2012-02-14T06:46:03Z", "creation_time": "2012-02-14T06:46:03Z", "creator": "mozbugz@outlook.com", "id": 6058929, "count": 65, "is_private": false}, {"attachment_id": null, "raw_text": "I've investigated this bug, it seems I can make it go away by adding a ::DwmFlush immediately after the present calls. However, timing measurements I did also revealed this call may take up to 20ms to complete (i.e. a full frame).\n\nWe could do this if we do some stuff off the main thread possibly, but it's not going to be too pretty, I'll look into this a little more, but it does provide us with a clear hint of where the problem might roughly be, I'd appreciate it if Jimm or someone else could confirm my findings on other hardware.", "bug_id": 672885, "text": "I've investigated this bug, it seems I can make it go away by adding a ::DwmFlush immediately after the present calls. However, timing measurements I did also revealed this call may take up to 20ms to complete (i.e. a full frame).\n\nWe could do this if we do some stuff off the main thread possibly, but it's not going to be too pretty, I'll look into this a little more, but it does provide us with a clear hint of where the problem might roughly be, I'd appreciate it if Jimm or someone else could confirm my findings on other hardware.", "tags": [], "id": 6085200, "count": 66, "is_private": false, "creation_time": "2012-02-23T02:20:10Z", "time": "2012-02-23T02:20:10Z", "creator": "bas@basschouten.com", "author": "bas@basschouten.com"}, {"id": 6085217, "count": 67, "is_private": false, "creation_time": "2012-02-23T02:23:53Z", "time": "2012-02-23T02:23:53Z", "creator": "bas@basschouten.com", "author": "bas@basschouten.com", "attachment_id": null, "raw_text": "Fwiw, a very short sleep, of for example 3ms also makes the problem disappear on my hardware, which makes this even more interesting.", "bug_id": 672885, "text": "Fwiw, a very short sleep, of for example 3ms also makes the problem disappear on my hardware, which makes this even more interesting.", "tags": []}, {"raw_text": "More interesting information: When I set DWMWA_NCRENDERING_POLICY to DWMNCRP_DISABLED, the bug becomes much easier to reproduce. ::DwmFlush then still prevents it from occurring -most- of the time, but it does still occasionally happen, suggesting that adding any time after 'present' just makes the bug less likely to occur.\n\nThis might mean that a lot of subsequent presents with different sized swap chains trigger this behavior, as adding any blockage will simply reduce the presentation frequency.", "attachment_id": null, "tags": [], "text": "More interesting information: When I set DWMWA_NCRENDERING_POLICY to DWMNCRP_DISABLED, the bug becomes much easier to reproduce. ::DwmFlush then still prevents it from occurring -most- of the time, but it does still occasionally happen, suggesting that adding any time after 'present' just makes the bug less likely to occur.\n\nThis might mean that a lot of subsequent presents with different sized swap chains trigger this behavior, as adding any blockage will simply reduce the presentation frequency.", "bug_id": 672885, "id": 6085242, "count": 68, "is_private": false, "author": "bas@basschouten.com", "creation_time": "2012-02-23T02:35:16Z", "time": "2012-02-23T02:35:16Z", "creator": "bas@basschouten.com"}, {"id": 6085245, "count": 69, "is_private": false, "author": "bas@basschouten.com", "time": "2012-02-23T02:39:43Z", "creation_time": "2012-02-23T02:39:43Z", "creator": "bas@basschouten.com", "raw_text": "Interestingly enough, when enabling v-syncing, making blocking on v-sync occur in the present call, I'm measuring similar timings at when using ::DwmFlush, however this does -not- reduce the occurrence of the bug. Even though in theory there should be a similar reduction in presentation frequency. This suggests that blocking our main thread for sufficiently long after completion of the present call is the reason the bug is reduced in frequency.", "attachment_id": null, "bug_id": 672885, "text": "Interestingly enough, when enabling v-syncing, making blocking on v-sync occur in the present call, I'm measuring similar timings at when using ::DwmFlush, however this does -not- reduce the occurrence of the bug. Even though in theory there should be a similar reduction in presentation frequency. This suggests that blocking our main thread for sufficiently long after completion of the present call is the reason the bug is reduced in frequency.", "tags": []}, {"raw_text": "Hrm, the flickering from DWMNCRP_DISABLED seems to be of significantly different origin than the one we're seeing when on ENABLED or on WINDOWSTYLE. So the two are likely not, or only very vaguely related, ::DwmFlush still appears to prevent the issue from occurring for the flickering we care about though, whereas vsync does not.", "attachment_id": null, "text": "Hrm, the flickering from DWMNCRP_DISABLED seems to be of significantly different origin than the one we're seeing when on ENABLED or on WINDOWSTYLE. So the two are likely not, or only very vaguely related, ::DwmFlush still appears to prevent the issue from occurring for the flickering we care about though, whereas vsync does not.", "bug_id": 672885, "tags": [], "is_private": false, "count": 70, "id": 6085268, "author": "bas@basschouten.com", "creator": "bas@basschouten.com", "time": "2012-02-23T02:51:53Z", "creation_time": "2012-02-23T02:51:53Z"}, {"is_private": false, "attachment_id": null, "count": 71, "id": 6085290, "raw_text": "Bas, is your testing on D3D9 or 10? I tried the DWMFlush call in the D3D9 test app ('test app plus release exe') and didn't see much improvement.", "creator": "jmathies@mozilla.com", "creation_time": "2012-02-23T03:07:26Z", "time": "2012-02-23T03:07:26Z", "author": "jmathies@mozilla.com", "text": "Bas, is your testing on D3D9 or 10? I tried the DWMFlush call in the D3D9 test app ('test app plus release exe') and didn't see much improvement.", "bug_id": 672885, "tags": []}, {"creation_time": "2012-02-23T03:11:21Z", "time": "2012-02-23T03:11:21Z", "creator": "bas@basschouten.com", "author": "bas@basschouten.com", "count": 72, "id": 6085300, "is_private": false, "tags": [], "text": "(In reply to Jim Mathies [:jimm] from comment #71)\n> Bas, is your testing on D3D9 or 10? I tried the DWMFlush call in the D3D9\n> test app ('test app plus release exe') and didn't see much improvement.\n\nI'm testing D3D9, note that this is -after- the Present Call. However I've now found a way to make the bug much easier to reproduce, I run FishIE in the background at maximum fish, making sure my computer is nice and busy (presumably my GPU is the culprit), when doing this I can easily reproduce the bug.\n\nDwmFlush in that case makes things a lot better (as does any blockage after Present it seems, but it doesn't make the problem go away.", "bug_id": 672885, "attachment_id": null, "raw_text": "(In reply to Jim Mathies [:jimm] from comment #71)\n> Bas, is your testing on D3D9 or 10? I tried the DWMFlush call in the D3D9\n> test app ('test app plus release exe') and didn't see much improvement.\n\nI'm testing D3D9, note that this is -after- the Present Call. However I've now found a way to make the bug much easier to reproduce, I run FishIE in the background at maximum fish, making sure my computer is nice and busy (presumably my GPU is the culprit), when doing this I can easily reproduce the bug.\n\nDwmFlush in that case makes things a lot better (as does any blockage after Present it seems, but it doesn't make the problem go away."}, {"bug_id": 672885, "text": "Alright, so I disabled all the DWM stuff and still saw the issue, now I seem to have found the strangest workaround, I changed the NCCALCSIZE code into the following:\n\n          if (wParam) {\n            params->rgrc[1].left = params->rgrc[1].right = params->rgrc[1].bottom = params->rgrc[1].top = 0;\n            params->rgrc[2].left = params->rgrc[2].right = params->rgrc[2].bottom = params->rgrc[2].top = 0;\n            return WVR_VALIDRECTS;\n          } else {\n            params->rgrc[0].left += 1;\n            params->rgrc[0].right -= 1;\n            params->rgrc[0].top += 1;\n            params->rgrc[0].bottom -= 1; /* */\n            params->rgrc[1].left = params->rgrc[1].right = params->rgrc[1].bottom = params->rgrc[1].top = 0;\n            params->rgrc[2].left = params->rgrc[2].right = params->rgrc[2].bottom = params->rgrc[2].top = 0;\n            return 0;\n          }\n\nThe very first frame now obviously has the client area drawn around it, however every subsequent frame is drawn fine, and no flicker, even under high GPU load, I tried switching back and forth several times but it really seems a lot better on my hardware for some mysterious reason. Could you confirm, Jimm?", "tags": [], "raw_text": "Alright, so I disabled all the DWM stuff and still saw the issue, now I seem to have found the strangest workaround, I changed the NCCALCSIZE code into the following:\n\n          if (wParam) {\n            params->rgrc[1].left = params->rgrc[1].right = params->rgrc[1].bottom = params->rgrc[1].top = 0;\n            params->rgrc[2].left = params->rgrc[2].right = params->rgrc[2].bottom = params->rgrc[2].top = 0;\n            return WVR_VALIDRECTS;\n          } else {\n            params->rgrc[0].left += 1;\n            params->rgrc[0].right -= 1;\n            params->rgrc[0].top += 1;\n            params->rgrc[0].bottom -= 1; /* */\n            params->rgrc[1].left = params->rgrc[1].right = params->rgrc[1].bottom = params->rgrc[1].top = 0;\n            params->rgrc[2].left = params->rgrc[2].right = params->rgrc[2].bottom = params->rgrc[2].top = 0;\n            return 0;\n          }\n\nThe very first frame now obviously has the client area drawn around it, however every subsequent frame is drawn fine, and no flicker, even under high GPU load, I tried switching back and forth several times but it really seems a lot better on my hardware for some mysterious reason. Could you confirm, Jimm?", "attachment_id": null, "author": "bas@basschouten.com", "creator": "bas@basschouten.com", "time": "2012-02-23T04:48:23Z", "creation_time": "2012-02-23T04:48:23Z", "is_private": false, "count": 73, "id": 6085433}, {"attachment_id": 599896, "is_private": false, "count": 74, "id": 6085747, "raw_text": "I had to update to a VS2010 project to work on this, so here's the workaround patch that should apply to the D3DFlickerTest on the bug, with it the flicker problem appears to have gone away, I've made it so the initial frame is also shown correctly.", "creator": "bas@basschouten.com", "time": "2012-02-23T07:29:04Z", "creation_time": "2012-02-23T07:29:04Z", "author": "bas@basschouten.com", "tags": [], "text": "Created attachment 599896\nD3D9 Flicker Workaround\n\nI had to update to a VS2010 project to work on this, so here's the workaround patch that should apply to the D3DFlickerTest on the bug, with it the flicker problem appears to have gone away, I've made it so the initial frame is also shown correctly.", "bug_id": 672885}, {"text": "Created attachment 599944\nFullWindowRenderTest.cpp\n\nFix added to the original D3D9 test app.\n\nSo the good news is this reduced the flicker problem on my system *substantially*, although I still occasional experienced it. When I see it is when the window (on a cinema display) encompassed most of the desktop. Smaller windows don't have the issue. For testing purposes I grab the resize corner on the lower right of the window, size out to the lower right corner of the desktop and then hover in a circular or mirrored 'L' pattern slowly.\n\nI can merge the original work in bug 590945 to tip and add this fix to all top level windows if folks want to take a try build for a spin.\n\nThe two problems we had there were the flicker problem and redraw performance on resizing. This change definitely seems to help the flickering problem, not sure about resize perf.\n\nSpeaking of which, we really need a talos test that measures paint performance while resizing the window. I might try to work something like that up.", "bug_id": 672885, "tags": [], "raw_text": "Fix added to the original D3D9 test app.\n\nSo the good news is this reduced the flicker problem on my system *substantially*, although I still occasional experienced it. When I see it is when the window (on a cinema display) encompassed most of the desktop. Smaller windows don't have the issue. For testing purposes I grab the resize corner on the lower right of the window, size out to the lower right corner of the desktop and then hover in a circular or mirrored 'L' pattern slowly.\n\nI can merge the original work in bug 590945 to tip and add this fix to all top level windows if folks want to take a try build for a spin.\n\nThe two problems we had there were the flicker problem and redraw performance on resizing. This change definitely seems to help the flickering problem, not sure about resize perf.\n\nSpeaking of which, we really need a talos test that measures paint performance while resizing the window. I might try to work something like that up.", "attachment_id": 599944, "author": "jmathies@mozilla.com", "creator": "jmathies@mozilla.com", "time": "2012-02-23T11:44:19Z", "creation_time": "2012-02-23T11:44:19Z", "is_private": false, "id": 6086070, "count": 75}, {"attachment_id": null, "raw_text": "(In reply to Jim Mathies [:jimm] from comment #75)\n> Created attachment 599944\n> FullWindowRenderTest.cpp\n> \n> Fix added to the original D3D9 test app.\n> \n> So the good news is this reduced the flicker problem on my system\n> *substantially*, although I still occasional experienced it. When I see it\n> is when the window (on a cinema display) encompassed most of the desktop.\n> Smaller windows don't have the issue. For testing purposes I grab the resize\n> corner on the lower right of the window, size out to the lower right corner\n> of the desktop and then hover in a circular or mirrored 'L' pattern slowly.\n\nI don't own a cinema display (i.e. nothing bigger than 1920x1200), but I cannot do anything to reproduce the problem there. When turning on FishIE with a lot of fish, straining my system I can very easily see it without the workaround. I have decent hopes this will fix it sufficiently to not make it a blocker for the user experience. People will generally not resize their windows near 'full-screen' size I think, and not many people own screens as big as a a cinema display.\n\n> \n> I can merge the original work in bug 590945 to tip and add this fix to all\n> top level windows if folks want to take a try build for a spin.\n> \n> The two problems we had there were the flicker problem and redraw\n> performance on resizing. This change definitely seems to help the flickering\n> problem, not sure about resize perf.\n\nOur resize perf is suboptimal with hardware acceleration in general, I'm not sure there's a lot of regression there. I did a lot of measuring on the test program, and it seems that while normal present calls last ~0.01ms, present calls during resize tend to last 5-15ms or when the GPU is under load even 15-25ms. This is in the testcase we have here that does practically no work, and presumably very hard to avoid. Presumably OMTC when working on windows will help a lot here as that cost will no longer be incurred on the main thread preventing real drawing work from happening.", "tags": [], "bug_id": 672885, "text": "(In reply to Jim Mathies [:jimm] from comment #75)\n> Created attachment 599944\n> FullWindowRenderTest.cpp\n> \n> Fix added to the original D3D9 test app.\n> \n> So the good news is this reduced the flicker problem on my system\n> *substantially*, although I still occasional experienced it. When I see it\n> is when the window (on a cinema display) encompassed most of the desktop.\n> Smaller windows don't have the issue. For testing purposes I grab the resize\n> corner on the lower right of the window, size out to the lower right corner\n> of the desktop and then hover in a circular or mirrored 'L' pattern slowly.\n\nI don't own a cinema display (i.e. nothing bigger than 1920x1200), but I cannot do anything to reproduce the problem there. When turning on FishIE with a lot of fish, straining my system I can very easily see it without the workaround. I have decent hopes this will fix it sufficiently to not make it a blocker for the user experience. People will generally not resize their windows near 'full-screen' size I think, and not many people own screens as big as a a cinema display.\n\n> \n> I can merge the original work in bug 590945 to tip and add this fix to all\n> top level windows if folks want to take a try build for a spin.\n> \n> The two problems we had there were the flicker problem and redraw\n> performance on resizing. This change definitely seems to help the flickering\n> problem, not sure about resize perf.\n\nOur resize perf is suboptimal with hardware acceleration in general, I'm not sure there's a lot of regression there. I did a lot of measuring on the test program, and it seems that while normal present calls last ~0.01ms, present calls during resize tend to last 5-15ms or when the GPU is under load even 15-25ms. This is in the testcase we have here that does practically no work, and presumably very hard to avoid. Presumably OMTC when working on windows will help a lot here as that cost will no longer be incurred on the main thread preventing real drawing work from happening.", "id": 6086677, "count": 76, "is_private": false, "creation_time": "2012-02-23T16:15:56Z", "time": "2012-02-23T16:15:56Z", "creator": "bas@basschouten.com", "author": "bas@basschouten.com"}, {"is_private": false, "id": 6096597, "count": 77, "creator": "jmathies@mozilla.com", "time": "2012-02-27T21:07:30Z", "creation_time": "2012-02-27T21:07:30Z", "author": "jmathies@mozilla.com", "attachment_id": null, "raw_text": "Posted try builds with all the work in 590945 plus the following fix:\n\nhttps://hg.mozilla.org/try/rev/6b343c26d0dc\n\nThere was no need to mess with width/height since we don't show the window until we've set new dimensions, both of which happen way after we call create.\n\nNote, in a local release build I still see modest flickering.\n\nOnce try posts the builds, I'd appreciate any feedback people can give. (It helps to have a persona installed for testing too.)", "text": "Posted try builds with all the work in 590945 plus the following fix:\n\nhttps://hg.mozilla.org/try/rev/6b343c26d0dc\n\nThere was no need to mess with width/height since we don't show the window until we've set new dimensions, both of which happen way after we call create.\n\nNote, in a local release build I still see modest flickering.\n\nOnce try posts the builds, I'd appreciate any feedback people can give. (It helps to have a persona installed for testing too.)", "bug_id": 672885, "tags": []}, {"raw_text": "Try run for 5d01a2f652a1 is complete.\nDetailed breakdown of the results available here:\n    https://tbpl.mozilla.org/?tree=Try&rev=5d01a2f652a1\nResults (out of 17 total builds):\n    exception: 2\n    success: 1\n    warnings: 1\n    failure: 13\nBuilds (or logs if builds failed) available at:\nhttp://ftp.mozilla.org/pub/mozilla.org/firefox/try-builds/jmathies@mozilla.com-5d01a2f652a1", "attachment_id": null, "tags": [], "text": "Try run for 5d01a2f652a1 is complete.\nDetailed breakdown of the results available here:\n    https://tbpl.mozilla.org/?tree=Try&rev=5d01a2f652a1\nResults (out of 17 total builds):\n    exception: 2\n    success: 1\n    warnings: 1\n    failure: 13\nBuilds (or logs if builds failed) available at:\nhttp://ftp.mozilla.org/pub/mozilla.org/firefox/try-builds/jmathies@mozilla.com-5d01a2f652a1", "bug_id": 672885, "count": 78, "id": 6097699, "is_private": false, "author": "release@mozilla.com", "time": "2012-02-28T01:46:17Z", "creation_time": "2012-02-28T01:46:17Z", "creator": "release@mozilla.com"}, {"text": "(In reply to Mozilla RelEng Bot from comment #78)\n> Try run for 5d01a2f652a1 is complete.\n> Detailed breakdown of the results available here:\n>     https://tbpl.mozilla.org/?tree=Try&rev=5d01a2f652a1\n> Results (out of 17 total builds):\n>     exception: 2\n>     success: 1\n>     warnings: 1\n>     failure: 13\n> Builds (or logs if builds failed) available at:\n> http://ftp.mozilla.org/pub/mozilla.org/firefox/try-builds/jmathies@mozilla.\n> com-5d01a2f652a1\n\nThere was a crashing bug in the fix so I've resubmitted - \n\nhttps://tbpl.mozilla.org/?noignore=0&tree=Try&rev=12945a065e6d", "bug_id": 672885, "tags": [], "raw_text": "(In reply to Mozilla RelEng Bot from comment #78)\n> Try run for 5d01a2f652a1 is complete.\n> Detailed breakdown of the results available here:\n>     https://tbpl.mozilla.org/?tree=Try&rev=5d01a2f652a1\n> Results (out of 17 total builds):\n>     exception: 2\n>     success: 1\n>     warnings: 1\n>     failure: 13\n> Builds (or logs if builds failed) available at:\n> http://ftp.mozilla.org/pub/mozilla.org/firefox/try-builds/jmathies@mozilla.\n> com-5d01a2f652a1\n\nThere was a crashing bug in the fix so I've resubmitted - \n\nhttps://tbpl.mozilla.org/?noignore=0&tree=Try&rev=12945a065e6d", "attachment_id": null, "author": "jmathies@mozilla.com", "creator": "jmathies@mozilla.com", "time": "2012-02-28T02:13:55Z", "creation_time": "2012-02-28T02:13:55Z", "is_private": false, "id": 6097733, "count": 79}, {"is_private": false, "count": 80, "id": 6098397, "author": "release@mozilla.com", "creator": "release@mozilla.com", "time": "2012-02-28T10:31:17Z", "creation_time": "2012-02-28T10:31:17Z", "raw_text": "Try run for 12945a065e6d is complete.\nDetailed breakdown of the results available here:\n    https://tbpl.mozilla.org/?tree=Try&rev=12945a065e6d\nResults (out of 64 total builds):\n    success: 49\n    warnings: 11\n    failure: 4\nBuilds (or logs if builds failed) available at:\nhttp://ftp.mozilla.org/pub/mozilla.org/firefox/try-builds/jmathies@mozilla.com-12945a065e6d", "attachment_id": null, "text": "Try run for 12945a065e6d is complete.\nDetailed breakdown of the results available here:\n    https://tbpl.mozilla.org/?tree=Try&rev=12945a065e6d\nResults (out of 64 total builds):\n    success: 49\n    warnings: 11\n    failure: 4\nBuilds (or logs if builds failed) available at:\nhttp://ftp.mozilla.org/pub/mozilla.org/firefox/try-builds/jmathies@mozilla.com-12945a065e6d", "bug_id": 672885, "tags": []}, {"attachment_id": 601220, "raw_text": "Attached is the basis for a new talos that tests paint more accurately than tpaint. It positions a window on the upper right and then resizes it out in 300 steps. This should run ok locally in a nightly as well.\n\nWith the latest opt builds I'm seeing about 15% regression in this test compared to nightly. Not sure where that comes from. I'll have to disable various parts of the new code to see if I can track it down.", "tags": [], "text": "Created attachment 601220\nresize testcase\n\nAttached is the basis for a new talos that tests paint more accurately than tpaint. It positions a window on the upper right and then resizes it out in 300 steps. This should run ok locally in a nightly as well.\n\nWith the latest opt builds I'm seeing about 15% regression in this test compared to nightly. Not sure where that comes from. I'll have to disable various parts of the new code to see if I can track it down.", "bug_id": 672885, "is_private": false, "count": 81, "id": 6098419, "creator": "jmathies@mozilla.com", "time": "2012-02-28T10:42:16Z", "creation_time": "2012-02-28T10:42:16Z", "author": "jmathies@mozilla.com"}, {"attachment_id": null, "raw_text": "rstrong asked me to write up a summary so we can figure out next steps. \n\nWe now have try builds with the patches in bug 590945 plus Bas's fix plus a crash fix for that patch.\n\nhttps://tbpl.mozilla.org/?noignore=0&tree=Try&rev=12945a065e6d\n\nThere are some test failures there but other than that the builds run and the ui works as expected. I also worked up a new resize talos test which is posted in bug 731159 (and here). With everything applied I still see flicker issues and about a 15% regression on the resize test, so these patches can\u2019t land yet. (It would be great if others tuned into this bug can report their results.) \n\nGenerally this appears to be a bug in Windows DWM. IE is accelerating their content as well using similar calls, although they use a child window for content. We are attempting to accelerate the entire window with non-client chrome removed. This is where the problem introduces itself. To get around this we could:\n\n1) find a better fix for our existing set up (obviously)\n2) use the resize trick posted here (comments 14, 15, and 19 explain why we don\u2019t want to use this)\n3) bring back child widgets for content (doubtful)\n4) don\u2019t implement these features\n5) go back to microsoft support\n\nPer #5, we might want to consider this to try and get confirmation of the cause  (full window accel vs. child window, D3D10 issue vs. 9). Someone from Gfx should probably head that effort up if we go that route.", "tags": [], "bug_id": 672885, "text": "rstrong asked me to write up a summary so we can figure out next steps. \n\nWe now have try builds with the patches in bug 590945 plus Bas's fix plus a crash fix for that patch.\n\nhttps://tbpl.mozilla.org/?noignore=0&tree=Try&rev=12945a065e6d\n\nThere are some test failures there but other than that the builds run and the ui works as expected. I also worked up a new resize talos test which is posted in bug 731159 (and here). With everything applied I still see flicker issues and about a 15% regression on the resize test, so these patches can\u2019t land yet. (It would be great if others tuned into this bug can report their results.) \n\nGenerally this appears to be a bug in Windows DWM. IE is accelerating their content as well using similar calls, although they use a child window for content. We are attempting to accelerate the entire window with non-client chrome removed. This is where the problem introduces itself. To get around this we could:\n\n1) find a better fix for our existing set up (obviously)\n2) use the resize trick posted here (comments 14, 15, and 19 explain why we don\u2019t want to use this)\n3) bring back child widgets for content (doubtful)\n4) don\u2019t implement these features\n5) go back to microsoft support\n\nPer #5, we might want to consider this to try and get confirmation of the cause  (full window accel vs. child window, D3D10 issue vs. 9). Someone from Gfx should probably head that effort up if we go that route.", "id": 6121442, "count": 82, "is_private": false, "time": "2012-03-07T16:44:28Z", "creation_time": "2012-03-07T16:44:28Z", "creator": "jmathies@mozilla.com", "author": "jmathies@mozilla.com"}, {"is_private": false, "id": 6122129, "count": 83, "creator": "fefavale_93@hotmail.com", "creation_time": "2012-03-07T19:55:18Z", "time": "2012-03-07T19:55:18Z", "author": "fefavale_93@hotmail.com", "attachment_id": null, "raw_text": "I just going to talk from a consumer and basic developer place.\nI think the builds posted are working well, now instead of a white flicker issue, it shows the aero style on the bottom, and that's ok.\nAlso I started coding a css code for the whole window, and as I said it shows the windows aero style when I resize the window.\nPlese get out of your mind the fourth option (I'm just saying), developers will be really grateful to being allow of manipulate the entire window, as well consumers who use personas.\nThe patchs (again, what I think) are working great.\n\nI hope my opinion helps you guys, thanks and sorry for my English", "text": "I just going to talk from a consumer and basic developer place.\nI think the builds posted are working well, now instead of a white flicker issue, it shows the aero style on the bottom, and that's ok.\nAlso I started coding a css code for the whole window, and as I said it shows the windows aero style when I resize the window.\nPlese get out of your mind the fourth option (I'm just saying), developers will be really grateful to being allow of manipulate the entire window, as well consumers who use personas.\nThe patchs (again, what I think) are working great.\n\nI hope my opinion helps you guys, thanks and sorry for my English", "bug_id": 672885, "tags": []}, {"is_private": false, "id": 6141767, "count": 84, "creator": "mozbugz@outlook.com", "time": "2012-03-15T04:33:49Z", "creation_time": "2012-03-15T04:33:49Z", "author": "mozbugz@outlook.com", "attachment_id": null, "raw_text": "Hi Jim, can you spin another try build? I'd like to take a look to see how it fairs when you get a chance as these ones have expired on ftp. Thanks.", "tags": [], "bug_id": 672885, "text": "Hi Jim, can you spin another try build? I'd like to take a look to see how it fairs when you get a chance as these ones have expired on ftp. Thanks."}, {"author": "release@mozilla.com", "creator": "release@mozilla.com", "creation_time": "2012-03-28T19:32:42Z", "time": "2012-03-28T19:32:42Z", "is_private": false, "id": 6179192, "count": 85, "tags": [], "bug_id": 672885, "text": "Try run for 7bcaa6959dd6 is complete.\nDetailed breakdown of the results available here:\n    https://tbpl.mozilla.org/?tree=Try&rev=7bcaa6959dd6\nResults (out of 2 total builds):\n    success: 2\nBuilds (or logs if builds failed) available at:\nhttp://ftp.mozilla.org/pub/mozilla.org/firefox/try-builds/jmathies@mozilla.com-7bcaa6959dd6", "raw_text": "Try run for 7bcaa6959dd6 is complete.\nDetailed breakdown of the results available here:\n    https://tbpl.mozilla.org/?tree=Try&rev=7bcaa6959dd6\nResults (out of 2 total builds):\n    success: 2\nBuilds (or logs if builds failed) available at:\nhttp://ftp.mozilla.org/pub/mozilla.org/firefox/try-builds/jmathies@mozilla.com-7bcaa6959dd6", "attachment_id": null}, {"attachment_id": null, "is_private": false, "id": 6544989, "count": 86, "raw_text": "Talked with jgilbert, he felt Bas knows more of what to try here. So imma take the liberty of bouncing over.\n\nBas: Is this something you'll be able to pick up? It's an Australis blocker, so we're hoping to get this in a good state in the current cycle, and target an Austrailis landing in the next cycle.", "creator": "jdinbox@gmail.com", "creation_time": "2012-08-09T21:48:53Z", "time": "2012-08-09T21:48:53Z", "author": "jdinbox@gmail.com", "tags": [], "text": "Talked with jgilbert, he felt Bas knows more of what to try here. So imma take the liberty of bouncing over.\n\nBas: Is this something you'll be able to pick up? It's an Australis blocker, so we're hoping to get this in a good state in the current cycle, and target an Austrailis landing in the next cycle.", "bug_id": 672885}, {"creator": "jmathies@mozilla.com", "time": "2012-08-28T19:57:25Z", "creation_time": "2012-08-28T19:57:25Z", "author": "jmathies@mozilla.com", "is_private": false, "count": 87, "id": 6590821, "text": "Try builds:\n\nhttps://tbpl.mozilla.org/?noignore=0&tree=Try&rev=47f8bcb6578f\n\nhttps://ftp.mozilla.org/pub/mozilla.org/firefox/try-builds/jmathies@mozilla.com-47f8bcb6578f/", "bug_id": 672885, "tags": [], "attachment_id": null, "raw_text": "Try builds:\n\nhttps://tbpl.mozilla.org/?noignore=0&tree=Try&rev=47f8bcb6578f\n\nhttps://ftp.mozilla.org/pub/mozilla.org/firefox/try-builds/jmathies@mozilla.com-47f8bcb6578f/"}, {"raw_text": "I see the flickering/flashing on my Windows 7 desktop as well. I compared the Try build and current Nightly, each with and without HW Accel.\n\nI took a video of what I found:\n\n  https://people.mozilla.com/~dolske/tmp/bug-672885-c88.mp4\n\n1) The whole window (glass included) will flash black when resizing. Easy to trigger, but seems inconsistent in exactly when or what frequency.\n\n2) Resizing inwards on the left border makes the content bounce rapidly.\n\n3) Resizing outwards from the upper-left corner makes the glass portions rapidly flicker black.\n\n4) When expanding part of the window, the newly-exposed rect flickers with stale pixels or black.\n\n#1 and #3 are the main problems, and only happen with the Try build when using HW Accel. (Nightly flavors are fine).\n\n#2 is a separate bug. Nightly does it, and so do Chrome and IE. Maybe just a hard case to handle or rare enough it's not a concern.\n\n#4 is also a separate bug, and every browser does it. I know we can't show real content (takes time to render, would make resize laggy), but it would be nice if we could prefill it with a fill color (say, page background). That would help a lot, I suspect.", "attachment_id": null, "tags": [], "bug_id": 672885, "text": "I see the flickering/flashing on my Windows 7 desktop as well. I compared the Try build and current Nightly, each with and without HW Accel.\n\nI took a video of what I found:\n\n  https://people.mozilla.com/~dolske/tmp/bug-672885-c88.mp4\n\n1) The whole window (glass included) will flash black when resizing. Easy to trigger, but seems inconsistent in exactly when or what frequency.\n\n2) Resizing inwards on the left border makes the content bounce rapidly.\n\n3) Resizing outwards from the upper-left corner makes the glass portions rapidly flicker black.\n\n4) When expanding part of the window, the newly-exposed rect flickers with stale pixels or black.\n\n#1 and #3 are the main problems, and only happen with the Try build when using HW Accel. (Nightly flavors are fine).\n\n#2 is a separate bug. Nightly does it, and so do Chrome and IE. Maybe just a hard case to handle or rare enough it's not a concern.\n\n#4 is also a separate bug, and every browser does it. I know we can't show real content (takes time to render, would make resize laggy), but it would be nice if we could prefill it with a fill color (say, page background). That would help a lot, I suspect.", "is_private": false, "count": 88, "id": 6595232, "author": "jdinbox@gmail.com", "creator": "jdinbox@gmail.com", "creation_time": "2012-08-30T00:04:50Z", "time": "2012-08-30T00:04:50Z"}, {"tags": [], "text": "Sorry if this is bugspam, but here's a suggestion:\nIt seems that #4 is unavoidable, so\none of the things that could be done is delay the resize of the window until it is sure that glass for that new area can be drawn (during resize, a thin line white line appears where there is supposed to be glass, content area black), and then resize chrome/content when mouse is released (with animation?).\nThis will have an effect of the window border not following exactly under the mouse cursor on older hardware, but that looks more aesthetically pleasing than flashing colors.\n(btw the older behavior in Windows XP was to either draw the whole window completely before it was shown on the screen.  It lagged, but it didn't mess up.)", "bug_id": 672885, "raw_text": "Sorry if this is bugspam, but here's a suggestion:\nIt seems that #4 is unavoidable, so\none of the things that could be done is delay the resize of the window until it is sure that glass for that new area can be drawn (during resize, a thin line white line appears where there is supposed to be glass, content area black), and then resize chrome/content when mouse is released (with animation?).\nThis will have an effect of the window border not following exactly under the mouse cursor on older hardware, but that looks more aesthetically pleasing than flashing colors.\n(btw the older behavior in Windows XP was to either draw the whole window completely before it was shown on the screen.  It lagged, but it didn't mess up.)", "attachment_id": null, "author": "henry.fai.hang.chan@gmail.com", "creator": "henry.fai.hang.chan@gmail.com", "time": "2012-08-30T04:15:46Z", "creation_time": "2012-08-30T04:15:46Z", "is_private": false, "id": 6595704, "count": 89}, {"count": 90, "id": 6653596, "is_private": false, "time": "2012-09-21T02:04:58Z", "creation_time": "2012-09-21T02:04:58Z", "creator": "jdinbox@gmail.com", "author": "jdinbox@gmail.com", "attachment_id": 663244, "raw_text": "Bas asked me to retest with D3DFlickerTest.zip (attachment 596042), with and without his patch to that (attachment 599896). The goal being to make sure that the full-up browser patch I tested in comment 88 was doing the right thing.\n\nI don't seem to be able to reproduce the whole-window flicker with D3DFlickerTest, alas. After building it, I get a resizable purple window... The only issue I see with it is that sometimes the the normal Windows border/control will flash into view. Not sure if that's relevant or not -- but I certainly don't see the whole window flickering black as I did in comment 88.\n\nThis video demos what I'm seeing.", "tags": [], "bug_id": 672885, "text": "Created attachment 663244\nVideo of working(?) D3DFlickerTest\n\nBas asked me to retest with D3DFlickerTest.zip (attachment 596042), with and without his patch to that (attachment 599896). The goal being to make sure that the full-up browser patch I tested in comment 88 was doing the right thing.\n\nI don't seem to be able to reproduce the whole-window flicker with D3DFlickerTest, alas. After building it, I get a resizable purple window... The only issue I see with it is that sometimes the the normal Windows border/control will flash into view. Not sure if that's relevant or not -- but I certainly don't see the whole window flickering black as I did in comment 88.\n\nThis video demos what I'm seeing."}, {"count": 91, "id": 6654244, "is_private": false, "time": "2012-09-21T10:37:49Z", "creation_time": "2012-09-21T10:37:49Z", "creator": "jmathies@mozilla.com", "author": "jmathies@mozilla.com", "attachment_id": null, "raw_text": "Another try build with border fixes.\n\nhttps://tbpl.mozilla.org/?noignore=0&tree=Try&rev=7457b0420e00\n\nI'll post a roll up. I confirmed the fix is getting hit. It's in nsWindow::WindowProcInit if anyone would care to test.", "bug_id": 672885, "text": "Another try build with border fixes.\n\nhttps://tbpl.mozilla.org/?noignore=0&tree=Try&rev=7457b0420e00\n\nI'll post a roll up. I confirmed the fix is getting hit. It's in nsWindow::WindowProcInit if anyone would care to test.", "tags": []}, {"author": "jmathies@mozilla.com", "creation_time": "2012-09-21T10:40:03Z", "time": "2012-09-21T10:40:03Z", "creator": "jmathies@mozilla.com", "id": 6654246, "count": 92, "is_private": false, "tags": [], "bug_id": 672885, "text": "Created attachment 663345\nroll up", "raw_text": "", "attachment_id": 663345}, {"author": "jmathies@mozilla.com", "creator": "jmathies@mozilla.com", "time": "2012-09-21T10:43:09Z", "creation_time": "2012-09-21T10:43:09Z", "is_private": false, "id": 6654251, "count": 93, "tags": [], "bug_id": 672885, "text": "(In reply to Jim Mathies [:jimm] from comment #92)\n> Created attachment 663345\n> roll up\n\nThe changes here really aren't that serious. The heady stuff is in browser css, which needs to form it's own window border. There's also code in theme that handles drawing window borders and corners. Overall though this is pretty easy code to tweak if anyone cares to try.", "raw_text": "(In reply to Jim Mathies [:jimm] from comment #92)\n> Created attachment 663345\n> roll up\n\nThe changes here really aren't that serious. The heady stuff is in browser css, which needs to form it's own window border. There's also code in theme that handles drawing window borders and corners. Overall though this is pretty easy code to tweak if anyone cares to try.", "attachment_id": null}, {"raw_text": "(Confirmed that I'm still seeing issues 1&3 from comment 88 with the try build from comment 91).", "attachment_id": null, "bug_id": 672885, "text": "(Confirmed that I'm still seeing issues 1&3 from comment 88 with the try build from comment 91).", "tags": [], "count": 94, "id": 6662234, "is_private": false, "author": "jdinbox@gmail.com", "creation_time": "2012-09-24T22:22:39Z", "time": "2012-09-24T22:22:39Z", "creator": "jdinbox@gmail.com"}, {"is_private": false, "count": 95, "id": 7380068, "creator": "stephen@noved.org", "creation_time": "2013-05-02T15:23:51Z", "time": "2013-05-02T15:23:51Z", "author": "stephen@noved.org", "attachment_id": null, "raw_text": "I know this bug has proven difficult (impossible?) to fix. However the issue of not being able to draw the full window border is an ongoing eyesore for anyone using Personas. \n\nWith the upcoming Australis theme changes this will also a problem for everyone on XP. The middle of the window/titlebar will have one texture but it will not be seamless with the window border. The customization background texture on all versions also has visible seems left, right and bottom.\n\nIs there any other work around that would possibly work? Or potentially even a fix just for XP and not for accelerated windows on Vista+?\n\nThank you!", "bug_id": 672885, "text": "I know this bug has proven difficult (impossible?) to fix. However the issue of not being able to draw the full window border is an ongoing eyesore for anyone using Personas. \n\nWith the upcoming Australis theme changes this will also a problem for everyone on XP. The middle of the window/titlebar will have one texture but it will not be seamless with the window border. The customization background texture on all versions also has visible seems left, right and bottom.\n\nIs there any other work around that would possibly work? Or potentially even a fix just for XP and not for accelerated windows on Vista+?\n\nThank you!", "tags": []}, {"is_private": false, "count": 96, "id": 7380785, "creator": "jaws@mozilla.com", "time": "2013-05-02T17:51:11Z", "creation_time": "2013-05-02T17:51:11Z", "author": "jaws@mozilla.com", "attachment_id": null, "raw_text": "Jim, I was talking with Bas and Dolske today about this patch.\n\nCan we land this patch but include a pref to toggle it? This way if we start to see issues we can easily turn it off while working on a fix (and possibly get more people's attention on it?)", "tags": [], "bug_id": 672885, "text": "Jim, I was talking with Bas and Dolske today about this patch.\n\nCan we land this patch but include a pref to toggle it? This way if we start to see issues we can easily turn it off while working on a fix (and possibly get more people's attention on it?)"}, {"text": "(In reply to Jared Wein [:jaws] from comment #96)\n> Jim, I was talking with Bas and Dolske today about this patch.\n> \n> Can we land this patch but include a pref to toggle it? This way if we start\n> to see issues we can easily turn it off while working on a fix (and possibly\n> get more people's attention on it?)\n\nThis work changes the outer layout of the main browser window in browser.xul. I don't know of any way you can pref something like that.", "bug_id": 672885, "tags": [], "raw_text": "(In reply to Jared Wein [:jaws] from comment #96)\n> Jim, I was talking with Bas and Dolske today about this patch.\n> \n> Can we land this patch but include a pref to toggle it? This way if we start\n> to see issues we can easily turn it off while working on a fix (and possibly\n> get more people's attention on it?)\n\nThis work changes the outer layout of the main browser window in browser.xul. I don't know of any way you can pref something like that.", "attachment_id": null, "author": "jmathies@mozilla.com", "time": "2013-05-02T18:55:43Z", "creation_time": "2013-05-02T18:55:43Z", "creator": "jmathies@mozilla.com", "count": 97, "id": 7381179, "is_private": false}, {"creation_time": "2013-05-02T18:58:20Z", "time": "2013-05-02T18:58:20Z", "creator": "jmathies@mozilla.com", "author": "jmathies@mozilla.com", "id": 7381207, "count": 98, "is_private": false, "tags": [], "text": "(In reply to Jim Mathies [:jimm] from comment #97)\n> (In reply to Jared Wein [:jaws] from comment #96)\n> > Jim, I was talking with Bas and Dolske today about this patch.\n> > \n> > Can we land this patch but include a pref to toggle it? This way if we start\n> > to see issues we can easily turn it off while working on a fix (and possibly\n> > get more people's attention on it?)\n> \n> This work changes the outer layout of the main browser window in\n> browser.xul. I don't know of any way you can pref something like that.\n\nActually, were you talking about the full window frame patch or the resizing fix?", "bug_id": 672885, "attachment_id": null, "raw_text": "(In reply to Jim Mathies [:jimm] from comment #97)\n> (In reply to Jared Wein [:jaws] from comment #96)\n> > Jim, I was talking with Bas and Dolske today about this patch.\n> > \n> > Can we land this patch but include a pref to toggle it? This way if we start\n> > to see issues we can easily turn it off while working on a fix (and possibly\n> > get more people's attention on it?)\n> \n> This work changes the outer layout of the main browser window in\n> browser.xul. I don't know of any way you can pref something like that.\n\nActually, were you talking about the full window frame patch or the resizing fix?"}, {"attachment_id": null, "raw_text": "I was talking about the full window frame patch. Is this something that we can land and then backout if we find that the flickering is affecting too many people?", "text": "I was talking about the full window frame patch. Is this something that we can land and then backout if we find that the flickering is affecting too many people?", "bug_id": 672885, "tags": [], "count": 99, "id": 7381335, "is_private": false, "creation_time": "2013-05-02T19:24:22Z", "time": "2013-05-02T19:24:22Z", "creator": "jaws@mozilla.com", "author": "jaws@mozilla.com"}, {"tags": [], "bug_id": 672885, "text": "(In reply to Jared Wein [:jaws] from comment #99)\n> I was talking about the full window frame patch. Is this something that we\n> can land and then backout if we find that the flickering is affecting too\n> many people?\n\nYou could but I think a lot of people are going to see problems. I've been through two nvidia cards that both had the problem since I first started working on this. \n\nWhat we could consider is landing the fall back to GDI during resize patch to see what impact it has. That patch solved the problem completely. Gfx folks would have to sign off on that first though.", "attachment_id": null, "raw_text": "(In reply to Jared Wein [:jaws] from comment #99)\n> I was talking about the full window frame patch. Is this something that we\n> can land and then backout if we find that the flickering is affecting too\n> many people?\n\nYou could but I think a lot of people are going to see problems. I've been through two nvidia cards that both had the problem since I first started working on this. \n\nWhat we could consider is landing the fall back to GDI during resize patch to see what impact it has. That patch solved the problem completely. Gfx folks would have to sign off on that first though.", "creation_time": "2013-05-02T19:48:58Z", "time": "2013-05-02T19:48:58Z", "creator": "jmathies@mozilla.com", "author": "jmathies@mozilla.com", "id": 7381467, "count": 100, "is_private": false}, {"attachment_id": null, "raw_text": "Bas, can you sign off on what comment #100 is proposing?", "tags": [], "text": "Bas, can you sign off on what comment #100 is proposing?", "bug_id": 672885, "is_private": false, "count": 101, "id": 7381501, "creator": "jaws@mozilla.com", "creation_time": "2013-05-02T19:57:00Z", "time": "2013-05-02T19:57:00Z", "author": "jaws@mozilla.com"}, {"count": 102, "id": 7381664, "is_private": false, "author": "bas@basschouten.com", "creation_time": "2013-05-02T20:34:37Z", "time": "2013-05-02T20:34:37Z", "creator": "bas@basschouten.com", "raw_text": "(In reply to Jared Wein [:jaws] from comment #101)\n> Bas, can you sign off on what comment #100 is proposing?\n\nNo, I can not, I think it's too risky.", "attachment_id": null, "tags": [], "text": "(In reply to Jared Wein [:jaws] from comment #101)\n> Bas, can you sign off on what comment #100 is proposing?\n\nNo, I can not, I think it's too risky.", "bug_id": 672885}, {"attachment_id": null, "raw_text": "(In reply to Jared Wein [:jaws] from comment #101)\n> Bas, can you sign off on what comment #100 is proposing?\n\nFwiw, I also think it's too fiddly. I'll have another look at why the resize fix isn't working somewhere next week hopefully. Since everyone I've spoken to has reported it works fine in the stand-alone test app it would be interesting to see why it doesn't seem to work fore firefox.", "tags": [], "bug_id": 672885, "text": "(In reply to Jared Wein [:jaws] from comment #101)\n> Bas, can you sign off on what comment #100 is proposing?\n\nFwiw, I also think it's too fiddly. I'll have another look at why the resize fix isn't working somewhere next week hopefully. Since everyone I've spoken to has reported it works fine in the stand-alone test app it would be interesting to see why it doesn't seem to work fore firefox.", "is_private": false, "count": 103, "id": 7381667, "creator": "bas@basschouten.com", "time": "2013-05-02T20:35:43Z", "creation_time": "2013-05-02T20:35:43Z", "author": "bas@basschouten.com"}, {"bug_id": 672885, "text": "Jimm, could you clarify what parts of bug 590945 cause this flicker? IIUC, it's setting the chromemargin such that the whole window is drawn by us (with no native frame). Is that all or is it related to some of the other changes in that bug? (I'm not familiar enough with the Windows APIs to understand the test app).\n\nDo we know if this still occurs with D3D11(.1)? If not, I think we could consider implementing bug 590945 for Windows 8+. Thoughts?", "tags": [], "attachment_id": null, "raw_text": "Jimm, could you clarify what parts of bug 590945 cause this flicker? IIUC, it's setting the chromemargin such that the whole window is drawn by us (with no native frame). Is that all or is it related to some of the other changes in that bug? (I'm not familiar enough with the Windows APIs to understand the test app).\n\nDo we know if this still occurs with D3D11(.1)? If not, I think we could consider implementing bug 590945 for Windows 8+. Thoughts?", "creator": "mozilla+bmo@noorenberghe.ca", "creation_time": "2014-03-30T00:42:08Z", "time": "2014-03-30T00:42:08Z", "author": "mozilla+bmo@noorenberghe.ca", "is_private": false, "count": 104, "id": 8596489}, {"attachment_id": null, "raw_text": "I have an ATI Radeon HD 5450, on Windows 7.  The test app flickers black and purple, while the  D3DFlickerTest.zip is completely smooth.  Setting chromemargin to any arbitrary number doesn't cause any black flickering on my system as far as I can tell...", "tags": [], "bug_id": 672885, "text": "I have an ATI Radeon HD 5450, on Windows 7.  The test app flickers black and purple, while the  D3DFlickerTest.zip is completely smooth.  Setting chromemargin to any arbitrary number doesn't cause any black flickering on my system as far as I can tell...", "id": 8596551, "count": 105, "is_private": false, "creation_time": "2014-03-30T02:15:42Z", "time": "2014-03-30T02:15:42Z", "creator": "henry.fai.hang.chan@gmail.com", "author": "henry.fai.hang.chan@gmail.com"}, {"time": "2014-04-21T13:29:09Z", "creation_time": "2014-04-21T13:29:09Z", "creator": "jmathies@mozilla.com", "author": "jmathies@mozilla.com", "id": 8687306, "count": 106, "is_private": false, "text": "(In reply to Matthew N. [:MattN] from comment #104)\n> Jimm, could you clarify what parts of bug 590945 cause this flicker? IIUC,\n> it's setting the chromemargin such that the whole window is drawn by us\n> (with no native frame).\n\nThat seemed to be the root cause. The test apps cooked this down so it wasn't anything unique to the mozilla gfx code. I think in general we're trying to do something here that is uncommon that's unexpected/untested by gfx driver vendors.\n\nI'm also sure it's driver specific. For example I currently can't reproduce in the same system I used two years ago having replaced the gfx card last year.\n\n> Is that all or is it related to some of the other\n> changes in that bug? (I'm not familiar enough with the Windows APIs to\n> understand the test app).\n> \n> Do we know if this still occurs with D3D11(.1)? If not, I think we could\n> consider implementing bug 590945 for Windows 8+. Thoughts?\n\nNo idea. Worth testing. I still have the original gfx card that I know reproduces the issue if you want me to ship it someplace for testing.\n\nNew card (can't reproduce):\n\nCard name: NVIDIA GeForce GTX 660 Ti\nManufacturer: NVIDIA\nChip type: GeForce GTX 660 Ti\nDriver Version: 9.18.13.3165\n\nOlder cards that reproduced (based on comments):\n\nNVIDIA GeForce GT 330M W/ DirecTX 11\nNVIDIA Quadro NVS 295\nNVIDIA GT230M\nNVIDIA GeForce GTX 560 Ti\nNVIDIA GeFore 9600M GT\nNVIDIA GeForce GTX 580\nNVIDIA GeForce GT 335M\nATI 5450", "bug_id": 672885, "tags": [], "attachment_id": null, "raw_text": "(In reply to Matthew N. [:MattN] from comment #104)\n> Jimm, could you clarify what parts of bug 590945 cause this flicker? IIUC,\n> it's setting the chromemargin such that the whole window is drawn by us\n> (with no native frame).\n\nThat seemed to be the root cause. The test apps cooked this down so it wasn't anything unique to the mozilla gfx code. I think in general we're trying to do something here that is uncommon that's unexpected/untested by gfx driver vendors.\n\nI'm also sure it's driver specific. For example I currently can't reproduce in the same system I used two years ago having replaced the gfx card last year.\n\n> Is that all or is it related to some of the other\n> changes in that bug? (I'm not familiar enough with the Windows APIs to\n> understand the test app).\n> \n> Do we know if this still occurs with D3D11(.1)? If not, I think we could\n> consider implementing bug 590945 for Windows 8+. Thoughts?\n\nNo idea. Worth testing. I still have the original gfx card that I know reproduces the issue if you want me to ship it someplace for testing.\n\nNew card (can't reproduce):\n\nCard name: NVIDIA GeForce GTX 660 Ti\nManufacturer: NVIDIA\nChip type: GeForce GTX 660 Ti\nDriver Version: 9.18.13.3165\n\nOlder cards that reproduced (based on comments):\n\nNVIDIA GeForce GT 330M W/ DirecTX 11\nNVIDIA Quadro NVS 295\nNVIDIA GT230M\nNVIDIA GeForce GTX 560 Ti\nNVIDIA GeFore 9600M GT\nNVIDIA GeForce GTX 580\nNVIDIA GeForce GT 335M\nATI 5450"}, {"text": "(In reply to Jim Mathies [:jimm] from comment #106)\n> (In reply to Matthew N. [:MattN] from comment #104)\n> New card (can't reproduce):\n> \n> Card name: NVIDIA GeForce GTX 660 Ti\n> Manufacturer: NVIDIA\n> Chip type: GeForce GTX 660 Ti\n> Driver Version: 9.18.13.3165\n> \n> Older cards that reproduced (based on comments):\n> \n> NVIDIA GeForce GT 330M W/ DirecTX 11\n> NVIDIA Quadro NVS 295\n> NVIDIA GT230M\n> NVIDIA GeForce GTX 560 Ti\n> NVIDIA GeFore 9600M GT\n> NVIDIA GeForce GTX 580\n> NVIDIA GeForce GT 335M\n> ATI 5450\n\nLet's not rule out timing here, for me this became a lot easier to reproduce on larger screens, suggesting timing was relevant. Your new card could simply be so much faster it doesn't obviously reproduce anymore.", "bug_id": 672885, "tags": [], "attachment_id": null, "raw_text": "(In reply to Jim Mathies [:jimm] from comment #106)\n> (In reply to Matthew N. [:MattN] from comment #104)\n> New card (can't reproduce):\n> \n> Card name: NVIDIA GeForce GTX 660 Ti\n> Manufacturer: NVIDIA\n> Chip type: GeForce GTX 660 Ti\n> Driver Version: 9.18.13.3165\n> \n> Older cards that reproduced (based on comments):\n> \n> NVIDIA GeForce GT 330M W/ DirecTX 11\n> NVIDIA Quadro NVS 295\n> NVIDIA GT230M\n> NVIDIA GeForce GTX 560 Ti\n> NVIDIA GeFore 9600M GT\n> NVIDIA GeForce GTX 580\n> NVIDIA GeForce GT 335M\n> ATI 5450\n\nLet's not rule out timing here, for me this became a lot easier to reproduce on larger screens, suggesting timing was relevant. Your new card could simply be so much faster it doesn't obviously reproduce anymore.", "creation_time": "2014-04-21T13:58:19Z", "time": "2014-04-21T13:58:19Z", "creator": "bas@basschouten.com", "author": "bas@basschouten.com", "id": 8687390, "count": 107, "is_private": false}, {"bug_id": 672885, "text": "Good point, I've been testing on a cinema display at 2560 x 1600 which makes it easier to reproduce with my old gfx card. It appears to be an issue with the present call failing to flush all bits to the screen in time for display.", "tags": [], "attachment_id": null, "raw_text": "Good point, I've been testing on a cinema display at 2560 x 1600 which makes it easier to reproduce with my old gfx card. It appears to be an issue with the present call failing to flush all bits to the screen in time for display.", "creator": "jmathies@mozilla.com", "creation_time": "2014-04-21T14:07:02Z", "time": "2014-04-21T14:07:02Z", "author": "jmathies@mozilla.com", "is_private": false, "id": 8687425, "count": 108}, {"raw_text": "Unassigning since I'm not currently doing any work on this and leaving it assigned to me will just cause false impressions.", "attachment_id": null, "tags": [], "text": "Unassigning since I'm not currently doing any work on this and leaving it assigned to me will just cause false impressions.", "bug_id": 672885, "is_private": false, "count": 109, "id": 8687557, "author": "bas@basschouten.com", "creator": "bas@basschouten.com", "time": "2014-04-21T14:49:58Z", "creation_time": "2014-04-21T14:49:58Z"}, {"tags": [], "text": "To clarify, on my ATI 5450 Firefox never flickers black and purple once, but the test app does.  Is it sure that the test app is doing exactly what Firefox is doing?", "bug_id": 672885, "attachment_id": null, "raw_text": "To clarify, on my ATI 5450 Firefox never flickers black and purple once, but the test app does.  Is it sure that the test app is doing exactly what Firefox is doing?", "creation_time": "2014-04-30T04:34:31Z", "time": "2014-04-30T04:34:31Z", "creator": "henry.fai.hang.chan@gmail.com", "author": "henry.fai.hang.chan@gmail.com", "count": 110, "id": 8730146, "is_private": false}, {"raw_text": "(In reply to henryfhchan from comment #110)\n> To clarify, on my ATI 5450 Firefox never flickers black and purple once, but\n> the test app does.  Is it sure that the test app is doing exactly what\n> Firefox is doing?\n\nThe test app is doing something we would like to do in firefox but currently don't due to this bug. That's the reason why we worked up the test app in the first place.", "attachment_id": null, "tags": [], "text": "(In reply to henryfhchan from comment #110)\n> To clarify, on my ATI 5450 Firefox never flickers black and purple once, but\n> the test app does.  Is it sure that the test app is doing exactly what\n> Firefox is doing?\n\nThe test app is doing something we would like to do in firefox but currently don't due to this bug. That's the reason why we worked up the test app in the first place.", "bug_id": 672885, "is_private": false, "id": 8730846, "count": 111, "author": "jmathies@mozilla.com", "creator": "jmathies@mozilla.com", "creation_time": "2014-04-30T08:57:47Z", "time": "2014-04-30T08:57:47Z"}, {"creation_time": "2015-01-24T18:03:08Z", "time": "2015-01-24T18:03:08Z", "creator": "johan.charlez@gmail.com", "author": "johan.charlez@gmail.com", "id": 9838342, "count": 112, "is_private": false, "tags": [], "text": "Did you ever look at the way they fixed this problem in Chrome?\nChrome bug: https://code.google.com/p/chromium/issues/detail?id=305432\nCommit: https://chromium.googlesource.com/chromium/src/+/b5e2a733b00cfc62f9f9380087ae9227f93ea0d3\nDiff: https://chromium.googlesource.com/chromium/src/+/b5e2a733b00cfc62f9f9380087ae9227f93ea0d3%5E!/\n\nIt sounds like the same problem, apologies if I'm wrong. :)", "bug_id": 672885, "attachment_id": null, "raw_text": "Did you ever look at the way they fixed this problem in Chrome?\nChrome bug: https://code.google.com/p/chromium/issues/detail?id=305432\nCommit: https://chromium.googlesource.com/chromium/src/+/b5e2a733b00cfc62f9f9380087ae9227f93ea0d3\nDiff: https://chromium.googlesource.com/chromium/src/+/b5e2a733b00cfc62f9f9380087ae9227f93ea0d3%5E!/\n\nIt sounds like the same problem, apologies if I'm wrong. :)"}, {"tags": [], "text": "(In reply to Jim Mathies [:jimm] from comment #62)\n> Created attachment 596042\n> D3DFlickerTest.zip\nThe .exe in this testcase is smooth as butter on a GTX 470, which I believe is an earlier card than some of the cards mentioned above. Could it have been fixed in a recent gpu driver or Windows patch?", "bug_id": 672885, "raw_text": "(In reply to Jim Mathies [:jimm] from comment #62)\n> Created attachment 596042\n> D3DFlickerTest.zip\nThe .exe in this testcase is smooth as butter on a GTX 470, which I believe is an earlier card than some of the cards mentioned above. Could it have been fixed in a recent gpu driver or Windows patch?", "attachment_id": null, "author": "johan.charlez@gmail.com", "creator": "johan.charlez@gmail.com", "creation_time": "2015-01-24T18:31:26Z", "time": "2015-01-24T18:31:26Z", "is_private": false, "count": 113, "id": 9838384}, {"author": "jaws@mozilla.com", "time": "2015-01-26T18:59:43Z", "creation_time": "2015-01-26T18:59:43Z", "creator": "jaws@mozilla.com", "count": 114, "id": 9842866, "is_private": false, "tags": [], "bug_id": 672885, "text": "(In reply to Johan C from comment #112)\n(In reply to Johan C from comment #113)", "raw_text": "(In reply to Johan C from comment #112)\n(In reply to Johan C from comment #113)", "attachment_id": null}, {"creator": "jmathies@mozilla.com", "time": "2015-01-26T19:20:00Z", "creation_time": "2015-01-26T19:20:00Z", "author": "jmathies@mozilla.com", "is_private": false, "count": 115, "id": 9842998, "tags": [], "text": "(In reply to Johan C from comment #113)\n> (In reply to Jim Mathies [:jimm] from comment #62)\n> > Created attachment 596042\n> > D3DFlickerTest.zip\n> The .exe in this testcase is smooth as butter on a GTX 470, which I believe\n> is an earlier card than some of the cards mentioned above. Could it have\n> been fixed in a recent gpu driver or Windows patch?\n\nSeems likely if you can't reproduce it anymore. I'm two cards removed from the original device I was testing on in 2011 so I can't go back and test without installing the old card, updating the diriver and testing. Not something I have the time for currently.", "bug_id": 672885, "attachment_id": null, "raw_text": "(In reply to Johan C from comment #113)\n> (In reply to Jim Mathies [:jimm] from comment #62)\n> > Created attachment 596042\n> > D3DFlickerTest.zip\n> The .exe in this testcase is smooth as butter on a GTX 470, which I believe\n> is an earlier card than some of the cards mentioned above. Could it have\n> been fixed in a recent gpu driver or Windows patch?\n\nSeems likely if you can't reproduce it anymore. I'm two cards removed from the original device I was testing on in 2011 so I can't go back and test without installing the old card, updating the diriver and testing. Not something I have the time for currently."}, {"text": "(In reply to Johan C from comment #112)\n> Did you ever look at the way they fixed this problem in Chrome?\n> Chrome bug: https://code.google.com/p/chromium/issues/detail?id=305432\n> Commit:\n> https://chromium.googlesource.com/chromium/src/+/\n> b5e2a733b00cfc62f9f9380087ae9227f93ea0d3\n> Diff:\n> https://chromium.googlesource.com/chromium/src/+/\n> b5e2a733b00cfc62f9f9380087ae9227f93ea0d3%5E!/\n> \n> It sounds like the same problem, apologies if I'm wrong. :)\n\nThe symptoms would be similar :). But the actual cause for us is different. We're dealing with an as of yet not completely understood windows bug (that might be gone in more recent windows versions). We'd mainly need to find a work-around, but to the best of my knowledge this is not a priority for us at the moment.", "bug_id": 672885, "tags": [], "raw_text": "(In reply to Johan C from comment #112)\n> Did you ever look at the way they fixed this problem in Chrome?\n> Chrome bug: https://code.google.com/p/chromium/issues/detail?id=305432\n> Commit:\n> https://chromium.googlesource.com/chromium/src/+/\n> b5e2a733b00cfc62f9f9380087ae9227f93ea0d3\n> Diff:\n> https://chromium.googlesource.com/chromium/src/+/\n> b5e2a733b00cfc62f9f9380087ae9227f93ea0d3%5E!/\n> \n> It sounds like the same problem, apologies if I'm wrong. :)\n\nThe symptoms would be similar :). But the actual cause for us is different. We're dealing with an as of yet not completely understood windows bug (that might be gone in more recent windows versions). We'd mainly need to find a work-around, but to the best of my knowledge this is not a priority for us at the moment.", "attachment_id": null, "author": "bas@basschouten.com", "creator": "bas@basschouten.com", "creation_time": "2015-02-05T01:54:45Z", "time": "2015-02-05T01:54:45Z", "is_private": false, "id": 9883026, "count": 116}]}}, "comments": {}}