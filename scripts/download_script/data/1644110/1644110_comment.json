{"comments": {}, "bugs": {"1644110": {"comments": [{"is_private": false, "count": 0, "tags": [], "bug_id": 1644110, "id": 14869164, "text": "There are some tasks which produce artifacts containing resource usage samples. We're hoping to expand this, and have a new artifact that records task resource usage, such as CPU and Memory information. \n\nThe exact artifact name and structure are still to be decided, but it'll likely be a json file produced as a task artifact, and notified via pulse.\n\nSince we already process the live log this way - pulse message arrives, artifact is retrieved, processed and data added to BigQuery - it would be good if this new artifact could be processed the same way. \n\nIt would contain samples of the resources used every $time_interval (likely 1 second) so perhaps we want to aggregate that before adding to BigQuery, I'm happy to take opinions on that. \n\nThe questions we'd want to answer with this data are ones such as:\n* Are the worker instances an appropriate size, or have the right concurrency set? \n  * Could more cores be added\n  * Could we use less memory\n  * Could we instead fit 2 tasks per worker if we increased the size slightly, which would decrease our overall bill, etc.\n\n* Is there a difference in resource usage after this date/time (when a commit/infra change was made, for example)", "author": "sfraser@mozilla.com", "attachment_id": null, "creator": "sfraser@mozilla.com", "time": "2020-06-08T11:18:28Z", "creation_time": "2020-06-08T11:18:28Z", "raw_text": "There are some tasks which produce artifacts containing resource usage samples. We're hoping to expand this, and have a new artifact that records task resource usage, such as CPU and Memory information. \n\nThe exact artifact name and structure are still to be decided, but it'll likely be a json file produced as a task artifact, and notified via pulse.\n\nSince we already process the live log this way - pulse message arrives, artifact is retrieved, processed and data added to BigQuery - it would be good if this new artifact could be processed the same way. \n\nIt would contain samples of the resources used every $time_interval (likely 1 second) so perhaps we want to aggregate that before adding to BigQuery, I'm happy to take opinions on that. \n\nThe questions we'd want to answer with this data are ones such as:\n* Are the worker instances an appropriate size, or have the right concurrency set? \n  * Could more cores be added\n  * Could we use less memory\n  * Could we instead fit 2 tasks per worker if we increased the size slightly, which would decrease our overall bill, etc.\n\n* Is there a difference in resource usage after this date/time (when a commit/infra change was made, for example)"}, {"time": "2020-08-05T16:42:35Z", "raw_text": "We've now produced this tool and have settled on an output format, at least for version 1.  The files themselves contain a version number to hopefully make life easier if there are changes later. An example can be found here:\n\nhttps://firefoxci.taskcluster-artifacts.net/CahkYcxZTSq5_kSchXEV5Q/0/public/monitoring/resource-monitor.json\n\nHow should we proceed with getting data through the ETL? At a minimum the summary section would be useful, so we could start with that.", "count": 1, "is_private": false, "bug_id": 1644110, "tags": [], "author": "sfraser@mozilla.com", "attachment_id": null, "creator": "sfraser@mozilla.com", "creation_time": "2020-08-05T16:42:35Z", "text": "We've now produced this tool and have settled on an output format, at least for version 1.  The files themselves contain a version number to hopefully make life easier if there are changes later. An example can be found here:\n\nhttps://firefoxci.taskcluster-artifacts.net/CahkYcxZTSq5_kSchXEV5Q/0/public/monitoring/resource-monitor.json\n\nHow should we proceed with getting data through the ETL? At a minimum the summary section would be useful, so we could start with that.", "id": 14973891}, {"raw_text": "I just have to make a BigQuery schema and update the ETL: If there is a resource-monitor.json in the artifact list it will be fetched, validated and loaded into BigQuery.  The ETL process could summarize the data, but generally the raw data is loaded in as close to its original form as possible.  From there a summarized view can be generated if necessary.  I should be able to start testing this tomorrow.", "time": "2020-08-05T21:47:03Z", "author": "mtrinkala@mozilla.com", "tags": [], "bug_id": 1644110, "is_private": false, "count": 2, "creation_time": "2020-08-05T21:47:03Z", "attachment_id": null, "creator": "mtrinkala@mozilla.com", "id": 14974504, "text": "I just have to make a BigQuery schema and update the ETL: If there is a resource-monitor.json in the artifact list it will be fetched, validated and loaded into BigQuery.  The ETL process could summarize the data, but generally the raw data is loaded in as close to its original form as possible.  From there a summarized view can be generated if necessary.  I should be able to start testing this tomorrow."}, {"creation_time": "2020-08-07T16:29:48Z", "creator": "mtrinkala@mozilla.com", "attachment_id": null, "text": "I am seeing some very large vms numbers 958274947641344 which is throwing some schema errors (since it is defined as an integer). This seems like bad data but I could just change the schema type to 'number' and allow them.\nhttps://firefoxci.taskcluster-artifacts.net/ehSPWe90SsK_3E9L7E87zA/0/public/monitoring/resource-monitor.json\n\nAlso write_bytes 18446744073708775765 in\nhttps://firefox-ci-tc.services.mozilla.com/api/queue/v1/task/ew47lYVPRiWg5fpAtbB6nA/runs/0/artifacts/public/monitoring/resource-monitor.json\n\nAnd write_count 18446744073709550984 in\nhttps://firefox-ci-tc.services.mozilla.com/api/queue/v1/task/JzaV1-ECSIGP4S7sWfc66Q/runs/0/artifacts/public/monitoring/resource-monitor.json", "id": 14978285, "raw_text": "I am seeing some very large vms numbers 958274947641344 which is throwing some schema errors (since it is defined as an integer). This seems like bad data but I could just change the schema type to 'number' and allow them.\nhttps://firefoxci.taskcluster-artifacts.net/ehSPWe90SsK_3E9L7E87zA/0/public/monitoring/resource-monitor.json\n\nAlso write_bytes 18446744073708775765 in\nhttps://firefox-ci-tc.services.mozilla.com/api/queue/v1/task/ew47lYVPRiWg5fpAtbB6nA/runs/0/artifacts/public/monitoring/resource-monitor.json\n\nAnd write_count 18446744073709550984 in\nhttps://firefox-ci-tc.services.mozilla.com/api/queue/v1/task/JzaV1-ECSIGP4S7sWfc66Q/runs/0/artifacts/public/monitoring/resource-monitor.json", "time": "2020-08-07T16:29:48Z", "author": "mtrinkala@mozilla.com", "tags": [], "bug_id": 1644110, "count": 3, "is_private": false}, {"id": 14978328, "text": "(In reply to Mike Trinkala [:trink] from comment #3)\n> I am seeing some very large vms numbers 958274947641344 which is throwing some schema errors (since it is defined as an integer). This seems like bad data but I could just change the schema type to 'number' and allow them.\n> https://firefoxci.taskcluster-artifacts.net/ehSPWe90SsK_3E9L7E87zA/0/public/monitoring/resource-monitor.json\n\nahh, I think I should just turn off collection of that. I suspect it's all expanded VMS without any allocation, and then we're summing it across processes on top of that. The current generation shouldn't have more than 256Gb /  274877906944 bytes. What's your maxint?", "attachment_id": null, "creator": "sfraser@mozilla.com", "creation_time": "2020-08-07T16:43:37Z", "is_private": false, "count": 4, "bug_id": 1644110, "tags": [], "author": "sfraser@mozilla.com", "time": "2020-08-07T16:43:37Z", "raw_text": "(In reply to Mike Trinkala [:trink] from comment #3)\n> I am seeing some very large vms numbers 958274947641344 which is throwing some schema errors (since it is defined as an integer). This seems like bad data but I could just change the schema type to 'number' and allow them.\n> https://firefoxci.taskcluster-artifacts.net/ehSPWe90SsK_3E9L7E87zA/0/public/monitoring/resource-monitor.json\n\nahh, I think I should just turn off collection of that. I suspect it's all expanded VMS without any allocation, and then we're summing it across processes on top of that. The current generation shouldn't have more than 256Gb /  274877906944 bytes. What's your maxint?"}, {"id": 14978384, "text": "jsonschema does not specify a limit/range for the integer type technically the interoperable range should be up to 2^53 - 1 (before losing precision) but it is implementation dependent.", "creator": "mtrinkala@mozilla.com", "attachment_id": null, "creation_time": "2020-08-07T17:11:22Z", "tags": [], "bug_id": 1644110, "count": 5, "is_private": false, "author": "mtrinkala@mozilla.com", "time": "2020-08-07T17:11:22Z", "raw_text": "jsonschema does not specify a limit/range for the integer type technically the interoperable range should be up to 2^53 - 1 (before losing precision) but it is implementation dependent."}, {"raw_text": "I will relax the samples schema to use number instead of integer everywhere to avoid throwing away the entire submission for a few anomalous samples.", "time": "2020-08-07T17:25:45Z", "author": "mtrinkala@mozilla.com", "count": 6, "is_private": false, "bug_id": 1644110, "tags": [], "creation_time": "2020-08-07T17:25:45Z", "attachment_id": null, "creator": "mtrinkala@mozilla.com", "id": 14978405, "text": "I will relax the samples schema to use number instead of integer everywhere to avoid throwing away the entire submission for a few anomalous samples."}, {"raw_text": "I will let it run on dev over the weekend and deploy to production on Monday if everything looks good.", "time": "2020-08-07T17:39:43Z", "author": "mtrinkala@mozilla.com", "count": 7, "is_private": false, "bug_id": 1644110, "tags": [], "creation_time": "2020-08-07T17:39:43Z", "creator": "mtrinkala@mozilla.com", "attachment_id": null, "text": "I will let it run on dev over the weekend and deploy to production on Monday if everything looks good.", "id": 14978436}, {"count": 8, "is_private": false, "tags": [], "bug_id": 1644110, "author": "mtrinkala@mozilla.com", "time": "2020-08-10T17:38:16Z", "raw_text": "Deployed the data is available at:\nhttps://console.cloud.google.com/bigquery?project=moz-fx-data-taskclu-prod-8fbf&p=moz-fx-data-taskclu-prod-8fbf&d=taskclusteretl&t=resource_monitor&page=table", "text": "Deployed the data is available at:\nhttps://console.cloud.google.com/bigquery?project=moz-fx-data-taskclu-prod-8fbf&p=moz-fx-data-taskclu-prod-8fbf&d=taskclusteretl&t=resource_monitor&page=table", "id": 14982638, "attachment_id": null, "creator": "mtrinkala@mozilla.com", "creation_time": "2020-08-10T17:38:16Z"}]}}}