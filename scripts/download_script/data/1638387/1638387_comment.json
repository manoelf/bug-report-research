{"bugs": {"1638387": {"comments": [{"creator": "kershaw@mozilla.com", "creation_time": "2020-05-15T16:24:51Z", "id": 14823170, "author": "kershaw@mozilla.com", "raw_text": "STR:\n1. Manually add some code to use `nsOSXSystemProxySettings` in socket process.\n2. [SCDynamicStoreCreate](https://searchfox.org/mozilla-central/rev/3ce874dc2703831af3e5ef3a1d216ffd08057fa5/toolkit/system/osxproxy/nsOSXSystemProxySettings.mm#94) returns NULL.\n3. Turning off sandbox is able to fix this.", "text": "STR:\n1. Manually add some code to use `nsOSXSystemProxySettings` in socket process.\n2. [SCDynamicStoreCreate](https://searchfox.org/mozilla-central/rev/3ce874dc2703831af3e5ef3a1d216ffd08057fa5/toolkit/system/osxproxy/nsOSXSystemProxySettings.mm#94) returns NULL.\n3. Turning off sandbox is able to fix this.", "is_private": false, "attachment_id": null, "time": "2020-05-15T16:24:51Z", "bug_id": 1638387, "count": 0, "tags": []}, {"time": "2020-05-15T16:27:50Z", "count": 1, "tags": [], "creator": "kershaw@mozilla.com", "creation_time": "2020-05-15T16:27:50Z", "attachment_id": null, "bug_id": 1638387, "author": "kershaw@mozilla.com", "id": 14823181, "text": "Not sure if it's possible to fix this by adjusting sandbox settings.\nHaik, what do you think?", "raw_text": "Not sure if it's possible to fix this by adjusting sandbox settings.\nHaik, what do you think?", "is_private": false}, {"time": "2020-05-15T16:30:13Z", "tags": [], "count": 2, "creation_time": "2020-05-15T16:30:13Z", "creator": "haftandilian@mozilla.com", "attachment_id": null, "bug_id": 1638387, "author": "haftandilian@mozilla.com", "id": 14823187, "is_private": false, "text": "(In reply to Kershaw Chang [:kershaw] from comment #1)\n> Not sure if it's possible to fix this by adjusting sandbox settings.\n> Haik, what do you think?\n\nI'll take a look. Could you post the sample code you're using? Or send it via chat.", "raw_text": "(In reply to Kershaw Chang [:kershaw] from comment #1)\n> Not sure if it's possible to fix this by adjusting sandbox settings.\n> Haik, what do you think?\n\nI'll take a look. Could you post the sample code you're using? Or send it via chat."}, {"bug_id": 1638387, "attachment_id": 9149489, "is_private": false, "raw_text": "This is just a test code that tries to use `nsISystemProxySettings` in socket process.\nTo execute this code path, please go to `about:memory` and than click `measure` button.", "text": "Created attachment 9149489\nInvoke system proxy settings\n\nThis is just a test code that tries to use `nsISystemProxySettings` in socket process.\nTo execute this code path, please go to `about:memory` and than click `measure` button.", "id": 14824494, "author": "kershaw@mozilla.com", "tags": [], "count": 3, "time": "2020-05-15T19:30:59Z", "creation_time": "2020-05-15T19:30:59Z", "creator": "kershaw@mozilla.com"}, {"time": "2020-05-15T20:56:24Z", "count": 4, "tags": [], "creator": "haftandilian@mozilla.com", "creation_time": "2020-05-15T20:56:24Z", "attachment_id": 9149518, "bug_id": 1638387, "id": 14824636, "author": "haftandilian@mozilla.com", "raw_text": "This patch allows the test code to work, but we need to spend some time to understand the security impact of allowing the new service `com.apple.SystemConfiguration.configd`. It is allowed in the profile used for most Mac applications and several other Mac services so I suspect it is low risk. I'll look into this more.", "text": "Created attachment 9149518\nTest patch to allow access to com.apple.SystemConfiguration.configd from the socket process\n\nThis patch allows the test code to work, but we need to spend some time to understand the security impact of allowing the new service `com.apple.SystemConfiguration.configd`. It is allowed in the profile used for most Mac applications and several other Mac services so I suspect it is low risk. I'll look into this more.", "is_private": false}, {"time": "2020-05-22T09:46:17Z", "tags": [], "count": 5, "creation_time": "2020-05-22T09:46:17Z", "creator": "kershaw@mozilla.com", "attachment_id": null, "bug_id": 1638387, "id": 14837247, "author": "kershaw@mozilla.com", "is_private": false, "text": "(In reply to Haik Aftandilian [:haik] from comment #4)\n> Created attachment 9149518\n> Test patch to allow access to com.apple.SystemConfiguration.configd from the socket process\n> \n> This patch allows the test code to work, but we need to spend some time to understand the security impact of allowing the new service `com.apple.SystemConfiguration.configd`. It is allowed in the profile used for most Mac applications and several other Mac services so I suspect it is low risk. I'll look into this more.\n\nThanks for the patch! The socket process is able to read the system configuration now.\nHowever, I also found the [callback](https://searchfox.org/mozilla-central/rev/df4c90d4b8c92c99f76334acfe4813c573c12661/toolkit/system/osxproxy/nsOSXSystemProxySettings.mm#79) registered for monitoring proxy changes is not invoked in socket process at all. I am not sure if this is also related to sandboxing. I'll also try to figure this out.", "raw_text": "(In reply to Haik Aftandilian [:haik] from comment #4)\n> Created attachment 9149518\n> Test patch to allow access to com.apple.SystemConfiguration.configd from the socket process\n> \n> This patch allows the test code to work, but we need to spend some time to understand the security impact of allowing the new service `com.apple.SystemConfiguration.configd`. It is allowed in the profile used for most Mac applications and several other Mac services so I suspect it is low risk. I'll look into this more.\n\nThanks for the patch! The socket process is able to read the system configuration now.\nHowever, I also found the [callback](https://searchfox.org/mozilla-central/rev/df4c90d4b8c92c99f76334acfe4813c573c12661/toolkit/system/osxproxy/nsOSXSystemProxySettings.mm#79) registered for monitoring proxy changes is not invoked in socket process at all. I am not sure if this is also related to sandboxing. I'll also try to figure this out."}, {"attachment_id": null, "bug_id": 1638387, "author": "haftandilian@mozilla.com", "id": 14845105, "is_private": false, "raw_text": "Kershaw, it would be better if we did not allow access to the configuration service and instead had the parent process read the configuration and pass it down to the socket process. Do we just need to read a few configuration properties?\n\nAfter looking into this some more, allowing access to the service would also allow a compromised socket process to modify system configuration. Additionally, the macOS process that implements `com.apple.SystemConfiguration.configd` is provided by the `/usr/libexec/configd` daemon which runs unsandboxed as root.", "text": "Kershaw, it would be better if we did not allow access to the configuration service and instead had the parent process read the configuration and pass it down to the socket process. Do we just need to read a few configuration properties?\n\nAfter looking into this some more, allowing access to the service would also allow a compromised socket process to modify system configuration. Additionally, the macOS process that implements `com.apple.SystemConfiguration.configd` is provided by the `/usr/libexec/configd` daemon which runs unsandboxed as root.", "time": "2020-05-26T21:31:19Z", "tags": [], "count": 6, "creation_time": "2020-05-26T21:31:19Z", "creator": "haftandilian@mozilla.com"}, {"attachment_id": null, "bug_id": 1638387, "id": 14849273, "author": "kershaw@mozilla.com", "is_private": false, "text": "(In reply to Haik Aftandilian [:haik] from comment #6)\n> Kershaw, it would be better if we did not allow access to the configuration service and instead had the parent process read the configuration and pass it down to the socket process. Do we just need to read a few configuration properties?\n> \n> After looking into this some more, allowing access to the service would also allow a compromised socket process to modify system configuration. Additionally, the macOS process that implements `com.apple.SystemConfiguration.configd` is provided by the `/usr/libexec/configd` daemon which runs unsandboxed as root.\n\nThanks for looking into this.\nI'll discuss this with our team members and then decide the next step.", "raw_text": "(In reply to Haik Aftandilian [:haik] from comment #6)\n> Kershaw, it would be better if we did not allow access to the configuration service and instead had the parent process read the configuration and pass it down to the socket process. Do we just need to read a few configuration properties?\n> \n> After looking into this some more, allowing access to the service would also allow a compromised socket process to modify system configuration. Additionally, the macOS process that implements `com.apple.SystemConfiguration.configd` is provided by the `/usr/libexec/configd` daemon which runs unsandboxed as root.\n\nThanks for looking into this.\nI'll discuss this with our team members and then decide the next step.", "time": "2020-05-28T13:08:50Z", "tags": [], "count": 7, "creation_time": "2020-05-28T13:08:50Z", "creator": "kershaw@mozilla.com"}, {"creation_time": "2020-07-20T09:33:29Z", "creator": "kershaw@mozilla.com", "tags": [], "count": 8, "time": "2020-07-20T09:33:29Z", "is_private": false, "text": "We'll keep proxy resolution in parent process, so this bug is WONTFIX.", "raw_text": "We'll keep proxy resolution in parent process, so this bug is WONTFIX.", "author": "kershaw@mozilla.com", "id": 14946185, "bug_id": 1638387, "attachment_id": null}]}}, "comments": {}}